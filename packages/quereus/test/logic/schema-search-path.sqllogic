-- Schema Search Path Tests
-- Tests for WITH SCHEMA clause and PRAGMA schema_path

-- Setup: Create tables in main schema
CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT);
INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob');

CREATE TABLE orders (id INTEGER PRIMARY KEY, user_id INTEGER, amount REAL);
INSERT INTO orders VALUES (1, 1, 100.50), (2, 2, 200.75);

-- Test 1: Default behavior - unqualified names resolve to main
SELECT * FROM users ORDER BY id;
→ [{"id":1,"name":"Alice"},{"id":2,"name":"Bob"}]

-- Test 2: WITH SCHEMA clause with main (should work)
SELECT * FROM users WITH SCHEMA main ORDER BY id;
→ [{"id":1,"name":"Alice"},{"id":2,"name":"Bob"}]

-- Test 3: WITH SCHEMA on JOIN queries
SELECT u.id, u.name, o.id as order_id, o.amount FROM users u JOIN orders o ON u.id = o.user_id WITH SCHEMA main ORDER BY u.id;
→ [{"id":1,"name":"Alice","order_id":1,"amount":100.5},{"id":2,"name":"Bob","order_id":2,"amount":200.75}]

-- Test 4: PRAGMA schema_path - set and query
PRAGMA schema_path = 'main';

PRAGMA schema_path;
→ [{"name":"schema_path","value":"main"}]

-- Test 5: After setting pragma, unqualified names still work
SELECT * FROM users ORDER BY id;
→ [{"id":1,"name":"Alice"},{"id":2,"name":"Bob"}]

-- Test 6: INSERT with WITH SCHEMA
INSERT INTO users (id, name) VALUES (3, 'Charlie') WITH SCHEMA main;

SELECT * FROM users WHERE id = 3;
→ [{"id":3,"name":"Charlie"}]

-- Test 7: UPDATE with WITH SCHEMA
UPDATE users SET name = 'Alice Updated' WHERE id = 1 WITH SCHEMA main;

SELECT name FROM users WHERE id = 1;
→ [{"name":"Alice Updated"}]

-- Test 8: DELETE with WITH SCHEMA
DELETE FROM users WHERE id = 3 WITH SCHEMA main;

SELECT COUNT(*) as count FROM users;
→ [{"count":2}]

-- Test 9: WITH SCHEMA with CTEs
WITH active_users AS (SELECT * FROM users WHERE id <= 2) SELECT * FROM active_users WITH SCHEMA main ORDER BY id;
→ [{"id":1,"name":"Alice Updated"},{"id":2,"name":"Bob"}]

-- Test 10: RETURNING with WITH SCHEMA
INSERT INTO users (id, name) VALUES (4, 'David') WITH SCHEMA main RETURNING id, name;
→ [{"id":4,"name":"David"}]

-- Test 11: Multiple table references with different schemas via WITH SCHEMA
SELECT u.name, o.amount, o.id as oid FROM users u JOIN orders o ON u.id = o.user_id WITH SCHEMA main ORDER BY o.id;
→ [{"name":"Alice Updated","amount":100.5,"oid":1},{"name":"Bob","amount":200.75,"oid":2}]

-- Test 12: Subqueries work with WITH SCHEMA
SELECT * FROM (SELECT * FROM users WHERE id > 0) sub WITH SCHEMA main ORDER BY id;
→ [{"id":1,"name":"Alice Updated"},{"id":2,"name":"Bob"},{"id":4,"name":"David"}]

-- Test 13: WITH SCHEMA and WITH CONTEXT can appear in any order
-- Note: We'd need mutation context tables to fully test this, but we can verify parsing

-- Clean up
DROP TABLE users;
DROP TABLE orders;
