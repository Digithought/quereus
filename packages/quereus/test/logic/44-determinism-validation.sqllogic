-- determinism-validation.sqllogic - Testing determinism validation for constraints and defaults

-- === Test 1: Non-deterministic DEFAULT values should be rejected ===

-- Attempt to create table with random() in DEFAULT - should fail
CREATE TABLE t_random_default (
    id INTEGER PRIMARY KEY,
    value INTEGER DEFAULT random()
);
-- error: Non-deterministic expression not allowed in DEFAULT

-- Attempt to create table with date('now') in DEFAULT - should fail
CREATE TABLE t_date_now_default (
    id INTEGER PRIMARY KEY,
    created_at TEXT DEFAULT date('now')
);
-- error: Non-deterministic expression not allowed in DEFAULT

-- Attempt to create table with datetime('now') in DEFAULT - should fail
CREATE TABLE t_datetime_now_default (
    id INTEGER PRIMARY KEY,
    timestamp TEXT DEFAULT datetime('now')
);
-- error: Non-deterministic expression not allowed in DEFAULT

-- Attempt to create table with time('now') in DEFAULT - should fail
CREATE TABLE t_time_now_default (
    id INTEGER PRIMARY KEY,
    current_time TEXT DEFAULT time('now')
);
-- error: Non-deterministic expression not allowed in DEFAULT

-- Attempt to create table with julianday('now') in DEFAULT - should fail
CREATE TABLE t_julianday_now_default (
    id INTEGER PRIMARY KEY,
    jd REAL DEFAULT julianday('now')
);
-- error: Non-deterministic expression not allowed in DEFAULT

-- === Test 2: Deterministic DEFAULT values should be accepted ===

-- Create table with constant DEFAULT - should succeed
CREATE TABLE t_const_default (
    id INTEGER PRIMARY KEY,
    name TEXT DEFAULT 'unnamed',
    value INTEGER DEFAULT 42,
    computed INTEGER DEFAULT (10 + 20)
);

-- Insert without specifying defaults
INSERT INTO t_const_default (id) VALUES (1);
SELECT * FROM t_const_default WHERE id = 1;
→ [{"id":1,"name":"unnamed","value":42,"computed":30}]

DROP TABLE t_const_default;

-- Create table with date literal DEFAULT - should succeed
CREATE TABLE t_date_literal_default (
    id INTEGER PRIMARY KEY,
    created_date TEXT DEFAULT '2024-01-01'
);

INSERT INTO t_date_literal_default (id) VALUES (1);
SELECT * FROM t_date_literal_default WHERE id = 1;
→ [{"id":1,"created_date":"2024-01-01"}]

DROP TABLE t_date_literal_default;

-- === Test 3: Non-deterministic CHECK constraints should be rejected ===

-- Attempt to create table with random() in CHECK - should fail
CREATE TABLE t_random_check (
    id INTEGER PRIMARY KEY,
    value INTEGER CHECK(value > random())
);
-- error: Non-deterministic expression not allowed in CHECK

-- Attempt to create table with date('now') in CHECK - should fail
CREATE TABLE t_date_now_check (
    id INTEGER PRIMARY KEY,
    created_at TEXT CHECK(created_at < date('now'))
);
-- error: Non-deterministic expression not allowed in CHECK

-- === Test 4: Deterministic CHECK constraints should be accepted ===

-- Create table with deterministic CHECK - should succeed
CREATE TABLE t_deterministic_check (
    id INTEGER PRIMARY KEY,
    value INTEGER CHECK(value > 0),
    name TEXT CHECK(length(name) > 2)
);

-- Insert valid data
INSERT INTO t_deterministic_check VALUES (1, 10, 'test');
SELECT * FROM t_deterministic_check WHERE id = 1;
→ [{"id":1,"value":10,"name":"test"}]

-- Insert invalid data (violates CHECK)
INSERT INTO t_deterministic_check VALUES (2, -5, 'ok');
-- error: CHECK constraint failed

DROP TABLE t_deterministic_check;

-- === Test 5: ALTER TABLE ADD CONSTRAINT with non-deterministic expression ===

CREATE TABLE t_alter (
    id INTEGER PRIMARY KEY,
    value INTEGER
);

-- Add non-deterministic constraint - succeeds at ALTER TABLE time
-- but will fail when first used (at INSERT/UPDATE time)
ALTER TABLE t_alter ADD CONSTRAINT random_check CHECK (value > random());

-- Attempt to insert - should fail due to non-deterministic constraint
INSERT INTO t_alter VALUES (1, 10);
-- error: Non-deterministic expression not allowed in CHECK

DROP TABLE t_alter;

-- Create table for deterministic constraint test
CREATE TABLE t_alter2 (
    id INTEGER PRIMARY KEY,
    value INTEGER
);

-- Add deterministic constraint - should succeed
ALTER TABLE t_alter2 ADD CONSTRAINT positive_check CHECK (value > 0);

-- Verify constraint works
INSERT INTO t_alter2 VALUES (1, 10);
SELECT * FROM t_alter2 WHERE id = 1;
→ [{"id":1,"value":10}]

INSERT INTO t_alter2 VALUES (2, -5);
-- error: CHECK constraint failed: positive_check

DROP TABLE t_alter2;

-- === Test 6: Nested non-deterministic expressions ===

-- Non-deterministic function nested in expression - should fail
CREATE TABLE t_nested_random (
    id INTEGER PRIMARY KEY,
    value INTEGER DEFAULT (random() + 100)
);
-- error: Non-deterministic expression not allowed in DEFAULT

-- Non-deterministic function in complex expression - should fail
CREATE TABLE t_complex_random (
    id INTEGER PRIMARY KEY,
    value INTEGER CHECK(value > (random() * 10))
);
-- error: Non-deterministic expression not allowed in CHECK

-- === Test 7: randomblob() should also be rejected ===

CREATE TABLE t_randomblob_default (
    id INTEGER PRIMARY KEY,
    data BLOB DEFAULT randomblob(16)
);
-- error: Non-deterministic expression not allowed in DEFAULT

