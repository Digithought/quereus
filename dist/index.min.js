(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.DigithoughtSqliter = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var DigithoughtSqliter=(()=>{var _h=Object.create;var Zr=Object.defineProperty;var Vh=Object.getOwnPropertyDescriptor;var Kh=Object.getOwnPropertyNames;var qh=Object.getPrototypeOf,Gh=Object.prototype.hasOwnProperty;var lr=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Mo=(e,t)=>{for(var n in t)Zr(e,n,{get:t[n],enumerable:!0})},bl=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Kh(t))!Gh.call(e,s)&&s!==n&&Zr(e,s,{get:()=>t[s],enumerable:!(r=Vh(t,s))||r.enumerable});return e};var jh=(e,t,n)=>(n=e!=null?_h(qh(e)):{},bl(t||!e||!e.__esModule?Zr(n,"default",{value:e,enumerable:!0}):n,e)),Yh=e=>bl(Zr({},"__esModule",{value:!0}),e);var wu=lr(Tn=>{"use strict";Object.defineProperty(Tn,"__esModule",{value:!0});Tn.BranchNode=Tn.LeafNode=void 0;var Bo=class{entries;constructor(t){this.entries=t}};Tn.LeafNode=Bo;var _o=class{partitions;nodes;constructor(t,n){this.partitions=t,this.nodes=n}};Tn.BranchNode=_o});var Iu=lr(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.BTree=oe.NodeCapacity=void 0;var It=Ko(),bt=wu();oe.NodeCapacity=64;var Vo=class{keyFromEntry;compare;_root;_version=0;constructor(t=r=>r,n=(r,s)=>r<s?-1:r>s?1:0){this.keyFromEntry=t,this.compare=n,this._root=new bt.LeafNode([])}first(){return this.getFirst(this._root)}last(){return this.getLast(this._root)}find(t){return this.getPath(this._root,t)}get(t){return this.at(this.find(t))}at(t){return this.validatePath(t),t.on?t.leafNode.entries[t.leafIndex]:void 0}*range(t){let n=t.first?this.findFirst(t):t.isAscending?this.first():this.last(),r=t.last?this.findLast(t):t.isAscending?this.last():this.first(),s=this.keyFromEntry(r.leafNode.entries[r.leafIndex]),o=t.isAscending?this.internalAscending(n):this.internalDescending(n),a=t.isAscending?1:-1;for(let i of o){if(!i.on||!r.on||this.compareKeys(this.keyFromEntry(i.leafNode.entries[i.leafIndex]),s)*a>0)break;yield i}}isValid(t){return t.version===this._version}insert(t){Object.freeze(t);let n=this.internalInsert(t);return n.on&&(n.version=++this._version),n}updateAt(t,n){this.validatePath(t),t.on&&Object.freeze(n);let r=this.internalUpdate(t,n);return r[0].on&&(r[0].version=++this._version),r}upsert(t){let n=this.find(this.keyFromEntry(t));return Object.freeze(t),n.on?n.leafNode.entries[n.leafIndex]=t:this.internalInsertAt(n,t),n.version=++this._version,n}merge(t,n){let r=this.keyFromEntry(t),s=this.find(r);if(s.on){let o=this.updateAt(s,n(s.leafNode.entries[s.leafIndex]));return o[0].on&&(o[0].version=++this._version),o}else return this.internalInsertAt(s,Object.freeze(t)),s.on=!0,s.version=++this._version,[s,!1]}deleteAt(t){this.validatePath(t);let n=this.internalDelete(t);return n&&++this._version,n}ascending(t){return this.validatePath(t),this.internalAscending(t.clone())}descending(t){return this.validatePath(t),this.internalDescending(t.clone())}getCount(t){let n=0,r=t?t.path.clone():this.first();if(t?.ascending??!0)for(;r.on;)n+=r.leafNode.entries.length-r.leafIndex,r.leafIndex=r.leafNode.entries.length-1,this.internalNext(r);else for(;r.on;)n+=r.leafIndex+1,r.leafIndex=0,this.internalPrior(r);return n}next(t){let n=t.clone();return this.moveNext(n),n}moveNext(t){this.validatePath(t),this.internalNext(t)}prior(t){let n=t.clone();return this.movePrior(n),n}movePrior(t){this.validatePath(t),this.internalPrior(t)}compareKeys(t,n){let r=this.compare(t,n);if(r!==0&&r===this.compare(n,t))throw new Error("Inconsistent comparison function for given values");return r}*internalAscending(t){for(this.validatePath(t);t.on;)yield t,this.moveNext(t)}*internalDescending(t){for(this.validatePath(t);t.on;)yield t,this.movePrior(t)}findFirst(t){let n=this.find(t.first.key);return(!n.on||t.first&&!t.first.inclusive)&&(t.isAscending?this.internalNext(n):this.internalPrior(n)),n}findLast(t){let n=this.find(t.last.key);return(!n.on||t.last&&!t.last.inclusive)&&(t.isAscending?this.internalPrior(n):this.internalNext(n)),n}getPath(t,n){if(t instanceof bt.LeafNode){let r=t,[s,o]=this.indexOfEntry(r.entries,n);return new It.Path([],r,o,s,this._version)}else{let r=t,s=this.indexOfKey(r.partitions,n),o=this.getPath(r.nodes[s],n);return o.branches.unshift(new It.PathBranch(r,s)),o}}indexOfEntry(t,n){let r=0,s=t.length-1,o=0,a=-1;for(;r<=s;){if(o=r+s>>>1,a=this.compareKeys(n,this.keyFromEntry(t[o])),a===0)return[!0,o];a<0?s=o-1:r=o+1}return[!1,r]}indexOfKey(t,n){let r=0,s=t.length-1,o=0,a=-1;for(;r<=s;){if(o=r+s>>>1,a=this.compareKeys(n,t[o]),a===0)return o+1;a<0?s=o-1:r=o+1}return r}internalNext(t){if(t.on)if(t.leafIndex>=t.leafNode.entries.length-1){let n=0,r=!1,s=t.branches.length-1;for(;n<=s&&!r;){let o=t.branches[s-n];o.index===o.node.partitions.length?++n:r=!0}if(!r)t.leafIndex=t.leafNode.entries.length,t.on=!1;else{t.branches.splice(-n,n);let o=t.branches.at(-1);++o.index,this.moveToFirst(o.node.nodes[o.index],t)}}else++t.leafIndex,t.on=!0;else if(t.on=t.branches.every(n=>n.index>=0&&n.index<n.node.nodes.length)&&t.leafIndex>=0&&t.leafIndex<t.leafNode.entries.length,t.on)return}internalPrior(t){if(this.validatePath(t),t.leafIndex<=0){let n=0,r=!1,s=t.branches.length-1;for(;n<=s&&!r;)t.branches[s-n].index===0?++n:r=!0;if(!r)t.leafIndex=0,t.on=!1;else{t.branches.splice(-n,n);let o=t.branches.at(-1);--o.index,this.moveToLast(o.node.nodes[o.index],t)}}else--t.leafIndex,t.on=!0}internalUpdate(t,n){if(t.on){let r=this.keyFromEntry(t.leafNode.entries[t.leafIndex]),s=this.keyFromEntry(n);if(this.compareKeys(r,s)!==0){let o=this.internalInsert(n);return o.on&&(this.internalDelete(this.find(r)),o=this.find(s)),[o,!1]}else t.leafNode.entries[t.leafIndex]=n}return[t,!0]}internalDelete(t){if(t.on){if(t.leafNode.entries.splice(t.leafIndex,1),t.branches.length>0){if(t.leafIndex===0){let r=t.branches.at(-1);this.updatePartition(r.index,t,t.branches.length-1,this.keyFromEntry(t.leafNode.entries[t.leafIndex]))}let n=this.rebalanceLeaf(t,t.branches.length);n&&(this._root=n)}return t.on=!1,!0}else return!1}internalInsert(t){let n=this.find(this.keyFromEntry(t));return n.on?(n.on=!1,n):(this.internalInsertAt(n,t),n.on=!0,n)}internalInsertAt(t,n){let r=this.leafInsert(t,n),s=t.branches.length-1;for(;r&&s>=0;)r=this.branchInsert(t,s,r),--s;if(r){let o=new bt.BranchNode([r.key],[this._root,r.right]);this._root=o,t.branches.unshift(new It.PathBranch(o,r.indexDelta))}}moveToFirst(t,n){if(t instanceof bt.LeafNode){let r=t;n.leafNode=r,n.leafIndex=0,n.on=r.entries.length>0}else n.branches.push(new It.PathBranch(t,0)),this.moveToFirst(t.nodes[0],n)}moveToLast(t,n){if(t instanceof bt.LeafNode){let r=t,s=r.entries.length;n.leafNode=r,n.on=s>0,n.leafIndex=s>0?s-1:0}else{let r=t,s=new It.PathBranch(r,r.partitions.length);n.branches.push(s),this.moveToLast(r.nodes[s.index],n)}}getFirst(t){if(t instanceof bt.LeafNode){let n=t;return new It.Path([],n,0,n.entries.length>0,this._version)}else{let n=t,r=this.getFirst(n.nodes[0]);return r.branches.unshift(new It.PathBranch(n,0)),r}}getLast(t){if(t instanceof bt.LeafNode){let n=t,r=n.entries.length;return new It.Path([],n,r>0?r-1:0,r>0,this._version)}else{let n=t,r=n.nodes.length-1,s=this.getLast(n.nodes[r]);return s.branches.unshift(new It.PathBranch(n,r)),s}}leafInsert(t,n){let{leafNode:r,leafIndex:s}=t;if(r.entries.length<oe.NodeCapacity){r.entries.splice(s,0,n);return}let o=r.entries.length+1>>>1,a=r.entries.splice(o),i=new bt.LeafNode(a);return s<o?r.entries.splice(s,0,n):(t.leafNode=i,t.leafIndex-=r.entries.length,i.entries.splice(t.leafIndex,0,n)),new cs(this.keyFromEntry(a[0]),i,s<o?0:1)}branchInsert(t,n,r){let s=t.branches[n],{index:o,node:a}=s;if(s.index+=r.indexDelta,a.partitions.splice(o,0,r.key),a.nodes.splice(o+1,0,r.right),a.nodes.length<=oe.NodeCapacity)return;let i=a.nodes.length>>>1,c=a.partitions.splice(i),u=a.partitions.pop(),d=a.nodes.splice(i),l=new bt.BranchNode(c,d);return s.index>=i&&(s.index-=i),new cs(u,l,s.index<i?0:1)}rebalanceLeaf(t,n){if(n===0||t.leafNode.entries.length>=oe.NodeCapacity>>>1)return;let r=t.leafNode,s=t.branches.at(n-1),o=s.index,a=s.node,i=o<a.nodes.length?a.nodes[o+1]:void 0;if(i&&i.entries.length>oe.NodeCapacity>>>1){let u=i.entries.shift();r.entries.push(u),this.updatePartition(o+1,t,n-1,this.keyFromEntry(i.entries[0]));return}let c=o>0?a.nodes[o-1]:void 0;if(c&&c.entries.length>oe.NodeCapacity>>>1){let u=c.entries.pop();r.entries.unshift(u),this.updatePartition(o,t,n-1,this.keyFromEntry(u)),t.leafIndex+=1;return}if(i&&i.entries.length+r.entries.length<=oe.NodeCapacity)return r.entries.push(...i.entries),a.partitions.splice(o,1),a.nodes.splice(o+1,1),o===0&&this.updatePartition(o,t,n-1,this.keyFromEntry(r.entries[0])),this.rebalanceBranch(t,n-1);if(c&&c.entries.length+r.entries.length<=oe.NodeCapacity)return c.entries.push(...r.entries),a.partitions.splice(o-1,1),a.nodes.splice(o,1),t.leafNode=c,t.leafIndex+=c.entries.length,this.rebalanceBranch(t,n-1)}rebalanceBranch(t,n){let r=t.branches[n],s=r.node;if(n===0&&s.partitions.length===0)return t.branches[n+1]?.node??t.leafNode;if(n===0||s.nodes.length>=oe.NodeCapacity<<1)return;let o=t.branches.at(n-1),a=o.index,i=o.node,c=a<i.nodes.length?i.nodes[a+1]:void 0;if(c&&c.nodes.length>oe.NodeCapacity>>>1){s.partitions.push(i.partitions[a]);let d=c.nodes.shift();s.nodes.push(d);let l=c.partitions.shift();this.updatePartition(a+1,t,n-1,l);return}let u=a>0?i.nodes[a-1]:void 0;if(u&&u.nodes.length>oe.NodeCapacity>>>1){s.partitions.unshift(i.partitions[a-1]);let d=u.nodes.pop();s.nodes.unshift(d);let l=u.partitions.pop();r.index+=1,this.updatePartition(a,t,n-1,l);return}if(c&&c.nodes.length+s.nodes.length<=oe.NodeCapacity){let d=i.partitions.splice(a,1)[0];return s.partitions.push(d),s.partitions.push(...c.partitions),s.nodes.push(...c.nodes),i.nodes.splice(a+1,1),a===0&&i.partitions.length>0&&this.updatePartition(a,t,n-1,i.partitions[0]),this.rebalanceBranch(t,n-1)}if(u&&u.nodes.length+s.nodes.length<=oe.NodeCapacity){let d=i.partitions.splice(a-1,1)[0];return u.partitions.push(d),u.partitions.push(...s.partitions),u.nodes.push(...s.nodes),i.nodes.splice(a,1),r.node=u,r.index+=u.nodes.length,this.rebalanceBranch(t,n-1)}}updatePartition(t,n,r,s){let o=n.branches[r];t>0?o.node.partitions[t-1]=s:r!==0&&this.updatePartition(n.branches[r-1].index,n,r-1,s)}validatePath(t){if(!this.isValid(t))throw new Error("Path is invalid due to mutation of the tree")}};oe.BTree=Vo;var cs=class{key;right;indexDelta;constructor(t,n,r){this.key=t,this.right=n,this.indexDelta=r}}});var bu=lr(vn=>{"use strict";Object.defineProperty(vn,"__esModule",{value:!0});vn.KeyRange=vn.KeyBound=void 0;var qo=class{key;inclusive;constructor(t,n=!0){this.key=t,this.inclusive=n}};vn.KeyBound=qo;var Go=class{first;last;isAscending;constructor(t,n,r=!0){this.first=t,this.last=n,this.isAscending=r}};vn.KeyRange=Go});var Nu=lr(Ln=>{"use strict";Object.defineProperty(Ln,"__esModule",{value:!0});Ln.Path=Ln.PathBranch=void 0;var jo=class e{node;index;constructor(t,n){this.node=t,this.index=n}clone(){return new e(this.node,this.index)}};Ln.PathBranch=jo;var Yo=class e{branches;leafNode;leafIndex;on;version;constructor(t,n,r,s,o){this.branches=t,this.leafNode=n,this.leafIndex=r,this.on=s,this.version=o}isEqual(t){return this.leafNode===t.leafNode&&this.leafIndex===t.leafIndex&&this.on===t.on&&this.version===t.version}clone(){return new e(this.branches.map(t=>t.clone()),this.leafNode,this.leafIndex,this.on,this.version)}};Ln.Path=Yo});var Ko=lr(Nt=>{"use strict";var Im=Nt&&Nt.__createBinding||(Object.create?function(e,t,n,r){r===void 0&&(r=n);var s=Object.getOwnPropertyDescriptor(t,n);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,s)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]}),Wo=Nt&&Nt.__exportStar||function(e,t){for(var n in e)n!=="default"&&!Object.prototype.hasOwnProperty.call(t,n)&&Im(t,e,n)};Object.defineProperty(Nt,"__esModule",{value:!0});Wo(Iu(),Nt);Wo(bu(),Nt);Wo(Nu(),Nt)});var dy={};Mo(dy,{Compiler:()=>Rn,ConflictResolution:()=>W,ConstraintError:()=>Ze,Database:()=>xo,FunctionContext:()=>yt,Latches:()=>wt,Lexer:()=>Cn,MemoryTableModule:()=>Pt,MisuseError:()=>M,Opcode:()=>f,ParseError:()=>gt,Parser:()=>Be,SchemaManager:()=>Mn,SqlDataType:()=>A,SqliteError:()=>b,Statement:()=>xn,StatusCode:()=>I,TokenType:()=>m,Vdbe:()=>On,VirtualTable:()=>Ve,VirtualTableCursor:()=>Ke,createInstruction:()=>Sn});var I;(function(e){e[e.OK=0]="OK",e[e.ERROR=1]="ERROR",e[e.INTERNAL=2]="INTERNAL",e[e.PERM=3]="PERM",e[e.ABORT=4]="ABORT",e[e.BUSY=5]="BUSY",e[e.LOCKED=6]="LOCKED",e[e.NOMEM=7]="NOMEM",e[e.READONLY=8]="READONLY",e[e.INTERRUPT=9]="INTERRUPT",e[e.IOERR=10]="IOERR",e[e.CORRUPT=11]="CORRUPT",e[e.NOTFOUND=12]="NOTFOUND",e[e.FULL=13]="FULL",e[e.CANTOPEN=14]="CANTOPEN",e[e.PROTOCOL=15]="PROTOCOL",e[e.EMPTY=16]="EMPTY",e[e.SCHEMA=17]="SCHEMA",e[e.TOOBIG=18]="TOOBIG",e[e.CONSTRAINT=19]="CONSTRAINT",e[e.MISMATCH=20]="MISMATCH",e[e.MISUSE=21]="MISUSE",e[e.NOLFS=22]="NOLFS",e[e.AUTH=23]="AUTH",e[e.FORMAT=24]="FORMAT",e[e.RANGE=25]="RANGE",e[e.NOTADB=26]="NOTADB",e[e.NOTICE=27]="NOTICE",e[e.WARNING=28]="WARNING",e[e.ROW=100]="ROW",e[e.DONE=101]="DONE"})(I||(I={}));var A;(function(e){e[e.INTEGER=1]="INTEGER",e[e.REAL=2]="REAL",e[e.TEXT=3]="TEXT",e[e.BLOB=4]="BLOB",e[e.NULL=5]="NULL",e[e.NUMERIC=6]="NUMERIC"})(A||(A={}));var f;(function(e){e[e.Init=1]="Init",e[e.Goto=2]="Goto",e[e.Halt=0]="Halt",e[e.Noop=145]="Noop",e[e.Null=11]="Null",e[e.Integer=6]="Integer",e[e.Int64=118]="Int64",e[e.String8=119]="String8",e[e.Real=117]="Real",e[e.Blob=40]="Blob",e[e.ZeroBlob=146]="ZeroBlob",e[e.SCopy=9]="SCopy",e[e.Move=12]="Move",e[e.Clear=10]="Clear",e[e.IfTrue=15]="IfTrue",e[e.IfFalse=16]="IfFalse",e[e.IfZero=93]="IfZero",e[e.IfNull=17]="IfNull",e[e.IfNotNull=18]="IfNotNull",e[e.IsNull=8]="IsNull",e[e.NotNull=19]="NotNull",e[e.Eq=76]="Eq",e[e.Ne=75]="Ne",e[e.Lt=77]="Lt",e[e.Le=78]="Le",e[e.Gt=79]="Gt",e[e.Ge=80]="Ge",e[e.Once=14]="Once",e[e.IfPos=97]="IfPos",e[e.IfNeg=98]="IfNeg",e[e.Add=67]="Add",e[e.Subtract=68]="Subtract",e[e.Multiply=69]="Multiply",e[e.Divide=70]="Divide",e[e.Remainder=71]="Remainder",e[e.Concat=72]="Concat",e[e.Negative=73]="Negative",e[e.BitAnd=74]="BitAnd",e[e.BitOr=84]="BitOr",e[e.ShiftLeft=85]="ShiftLeft",e[e.ShiftRight=86]="ShiftRight",e[e.BitNot=87]="BitNot",e[e.Not=88]="Not",e[e.Affinity=91]="Affinity",e[e.OpenEphemeral=5]="OpenEphemeral",e[e.Rewind=7]="Rewind",e[e.MakeRecord=83]="MakeRecord",e[e.IdxInsert=123]="IdxInsert",e[e.Function=108]="Function",e[e.OpenRead=58]="OpenRead",e[e.OpenWrite=59]="OpenWrite",e[e.Close=57]="Close",e[e.VFilter=166]="VFilter",e[e.VNext=167]="VNext",e[e.VColumn=192]="VColumn",e[e.VUpdate=168]="VUpdate",e[e.VRowid=169]="VRowid",e[e.VBegin=170]="VBegin",e[e.VCommit=171]="VCommit",e[e.VRollback=172]="VRollback",e[e.VSync=173]="VSync",e[e.VSavepoint=174]="VSavepoint",e[e.VRelease=175]="VRelease",e[e.VRollbackTo=176]="VRollbackTo",e[e.ConstraintViolation=180]="ConstraintViolation",e[e.ResultRow=81]="ResultRow",e[e.Sort=130]="Sort",e[e.Sorted=115]="Sorted",e[e.Subroutine=133]="Subroutine",e[e.Return=134]="Return",e[e.FrameEnter=135]="FrameEnter",e[e.FrameLeave=136]="FrameLeave",e[e.Push=131]="Push",e[e.StackPop=132]="StackPop",e[e.AggStep=109]="AggStep",e[e.AggFinal=110]="AggFinal",e[e.AggIterate=126]="AggIterate",e[e.AggNext=127]="AggNext",e[e.AggKey=128]="AggKey",e[e.AggContext=129]="AggContext",e[e.AggGroupValue=140]="AggGroupValue",e[e.AggReset=147]="AggReset",e[e.CollSeq=120]="CollSeq",e[e.OpenPseudo=121]="OpenPseudo",e[e.Next=124]="Next",e[e.VerifyCookie=107]="VerifyCookie",e[e.Savepoint=141]="Savepoint"})(f||(f={}));var v;(function(e){e[e.UTF8=1]="UTF8",e[e.DETERMINISTIC=2048]="DETERMINISTIC",e[e.DIRECTONLY=524288]="DIRECTONLY",e[e.INNOCUOUS=2097152]="INNOCUOUS"})(v||(v={}));var Nl;(function(e){e[e.CONSTRAINT_SUPPORT=1]="CONSTRAINT_SUPPORT",e[e.INNOCUOUS=2]="INNOCUOUS",e[e.DIRECTONLY=3]="DIRECTONLY",e[e.USES_ALL_SCHEMAS=4]="USES_ALL_SCHEMAS"})(Nl||(Nl={}));var F;(function(e){e[e.EQ=2]="EQ",e[e.GT=4]="GT",e[e.LE=8]="LE",e[e.LT=16]="LT",e[e.GE=32]="GE",e[e.MATCH=64]="MATCH",e[e.LIKE=65]="LIKE",e[e.GLOB=66]="GLOB",e[e.REGEXP=67]="REGEXP",e[e.NE=68]="NE",e[e.ISNOT=69]="ISNOT",e[e.ISNOTNULL=70]="ISNOTNULL",e[e.ISNULL=71]="ISNULL",e[e.IS=72]="IS",e[e.LIMIT=73]="LIMIT",e[e.OFFSET=74]="OFFSET",e[e.FUNCTION=150]="FUNCTION"})(F||(F={}));var W;(function(e){e[e.ROLLBACK=1]="ROLLBACK",e[e.ABORT=4]="ABORT",e[e.FAIL=3]="FAIL",e[e.IGNORE=2]="IGNORE",e[e.REPLACE=5]="REPLACE"})(W||(W={}));var Cl;(function(e){e[e.DELETE=9]="DELETE",e[e.INSERT=18]="INSERT",e[e.UPDATE=23]="UPDATE"})(Cl||(Cl={}));var b=class e extends Error{code;cause;line;column;constructor(t,n=I.ERROR,r,s,o){super(t),this.code=n,this.name="SqliteError",this.cause=r,this.line=s,this.column=o,s!==void 0&&o!==void 0&&(this.message=`${t} (at line ${s}, column ${o})`),Error.captureStackTrace&&Error.captureStackTrace(this,e)}},Xr=class extends b{token;constructor(t,n){super(t,I.ERROR,void 0,n.startLine,n.startColumn),this.token=n,this.name="ParseError"}},Ze=class extends b{constructor(t,n=I.CONSTRAINT){super(t,n),this.name="ConstraintError"}};var M=class e extends b{constructor(t="API misuse"){super(t,I.MISUSE),this.name="MisuseError",Object.setPrototypeOf(this,e.prototype)}};var m;(function(e){e.INTEGER="INTEGER",e.FLOAT="FLOAT",e.STRING="STRING",e.IDENTIFIER="IDENTIFIER",e.BLOB="BLOB",e.SELECT="SELECT",e.FROM="FROM",e.WHERE="WHERE",e.INSERT="INSERT",e.UPDATE="UPDATE",e.DELETE="DELETE",e.CREATE="CREATE",e.DROP="DROP",e.ALTER="ALTER",e.TABLE="TABLE",e.INDEX="INDEX",e.VIEW="VIEW",e.TEMP="TEMP",e.TEMPORARY="TEMPORARY",e.VIRTUAL="VIRTUAL",e.USING="USING",e.INTO="INTO",e.NULL="NULL",e.NOT="NOT",e.AND="AND",e.OR="OR",e.IN="IN",e.LIKE="LIKE",e.BETWEEN="BETWEEN",e.IS="IS",e.AS="AS",e.DISTINCT="DISTINCT",e.GROUP="GROUP",e.BY="BY",e.HAVING="HAVING",e.ORDER="ORDER",e.ASC="ASC",e.DESC="DESC",e.LIMIT="LIMIT",e.OFFSET="OFFSET",e.UNION="UNION",e.ALL="ALL",e.PRIMARY="PRIMARY",e.CONSTRAINT="CONSTRAINT",e.GENERATED="GENERATED",e.COLLATE="COLLATE",e.KEY="KEY",e.UNIQUE="UNIQUE",e.DEFAULT="DEFAULT",e.CHECK="CHECK",e.FOREIGN="FOREIGN",e.REFERENCES="REFERENCES",e.AUTOINCREMENT="AUTOINCREMENT",e.ON="ON",e.CONFLICT="CONFLICT",e.CASCADE="CASCADE",e.RESTRICT="RESTRICT",e.SET="SET",e.NO="NO",e.ACTION="ACTION",e.WITHOUT="WITHOUT",e.ROWID="ROWID",e.RENAME="RENAME",e.COLUMN="COLUMN",e.TO="TO",e.ADD="ADD",e.ALWAYS="ALWAYS",e.ABORT="ABORT",e.FAIL="FAIL",e.IGNORE="IGNORE",e.BEGIN="BEGIN",e.COMMIT="COMMIT",e.ROLLBACK="ROLLBACK",e.TRANSACTION="TRANSACTION",e.DEFERRED="DEFERRED",e.IMMEDIATE="IMMEDIATE",e.EXCLUSIVE="EXCLUSIVE",e.JOIN="JOIN",e.INNER="INNER",e.LEFT="LEFT",e.RIGHT="RIGHT",e.FULL="FULL",e.CROSS="CROSS",e.OUTER="OUTER",e.NATURAL="NATURAL",e.REPLACE="REPLACE",e.VALUES="VALUES",e.EXISTS="EXISTS",e.IF="IF",e.DEFERRABLE="DEFERRABLE",e.INITIALLY="INITIALLY",e.STORED="STORED",e.SAVEPOINT="SAVEPOINT",e.RELEASE="RELEASE",e.PRAGMA="PRAGMA",e.PLUS="PLUS",e.MINUS="MINUS",e.ASTERISK="ASTERISK",e.SLASH="SLASH",e.PERCENT="PERCENT",e.EQUAL="EQUAL",e.EQUAL_EQUAL="EQUAL_EQUAL",e.NOT_EQUAL="NOT_EQUAL",e.LESS="LESS",e.LESS_EQUAL="LESS_EQUAL",e.GREATER="GREATER",e.GREATER_EQUAL="GREATER_EQUAL",e.LPAREN="LPAREN",e.RPAREN="RPAREN",e.COMMA="COMMA",e.DOT="DOT",e.SEMICOLON="SEMICOLON",e.TILDE="TILDE",e.PIPE="PIPE",e.PIPE_PIPE="PIPE_PIPE",e.AMPERSAND="AMPERSAND",e.AMPERSAND_AMPERSAND="AMPERSAND_AMPERSAND",e.QUESTION="QUESTION",e.COLON="COLON",e.DOLLAR="DOLLAR",e.ARROW="ARROW",e.EOF="EOF",e.ERROR="ERROR"})(m||(m={}));var Wh={select:m.SELECT,from:m.FROM,where:m.WHERE,insert:m.INSERT,update:m.UPDATE,delete:m.DELETE,create:m.CREATE,drop:m.DROP,alter:m.ALTER,table:m.TABLE,index:m.INDEX,view:m.VIEW,virtual:m.VIRTUAL,using:m.USING,null:m.NULL,not:m.NOT,and:m.AND,or:m.OR,in:m.IN,like:m.LIKE,between:m.BETWEEN,is:m.IS,as:m.AS,distinct:m.DISTINCT,group:m.GROUP,by:m.BY,having:m.HAVING,order:m.ORDER,asc:m.ASC,desc:m.DESC,limit:m.LIMIT,offset:m.OFFSET,union:m.UNION,all:m.ALL,primary:m.PRIMARY,key:m.KEY,unique:m.UNIQUE,default:m.DEFAULT,check:m.CHECK,foreign:m.FOREIGN,references:m.REFERENCES,on:m.ON,conflict:m.CONFLICT,cascade:m.CASCADE,restrict:m.RESTRICT,set:m.SET,autoincrement:m.AUTOINCREMENT,no:m.NO,action:m.ACTION,without:m.WITHOUT,rowid:m.ROWID,begin:m.BEGIN,commit:m.COMMIT,rollback:m.ROLLBACK,transaction:m.TRANSACTION,deferred:m.DEFERRED,immediate:m.IMMEDIATE,exclusive:m.EXCLUSIVE,deferrable:m.DEFERRABLE,initially:m.INITIALLY,stored:m.STORED,join:m.JOIN,inner:m.INNER,left:m.LEFT,right:m.RIGHT,full:m.FULL,cross:m.CROSS,outer:m.OUTER,natural:m.NATURAL,replace:m.REPLACE,values:m.VALUES,exists:m.EXISTS,if:m.IF,into:m.INTO,temp:m.TEMP,temporary:m.TEMPORARY,rename:m.RENAME,to:m.TO,add:m.ADD,always:m.ALWAYS,abort:m.ABORT,fail:m.FAIL,ignore:m.IGNORE,savepoint:m.SAVEPOINT,release:m.RELEASE,pragma:m.PRAGMA},Cn=class{source;tokens=[];start=0;current=0;line=1;column=1;startLine=1;startColumn=1;constructor(t){this.source=t}scanTokens(){for(;!this.isAtEnd();)this.start=this.current,this.startLine=this.line,this.startColumn=this.column,this.scanToken();return this.tokens.push({type:m.EOF,lexeme:"",startLine:this.line,startColumn:this.column,startOffset:this.source.length,endLine:this.line,endColumn:this.column,endOffset:this.source.length}),this.tokens}isAtEnd(){return this.current>=this.source.length}scanToken(){let t=this.advance();switch(t){case"(":this.addToken(m.LPAREN);break;case")":this.addToken(m.RPAREN);break;case",":this.addToken(m.COMMA);break;case".":this.addToken(m.DOT);break;case";":this.addToken(m.SEMICOLON);break;case"+":this.addToken(m.PLUS);break;case"-":this.match(">")?this.addToken(m.ARROW):this.addToken(m.MINUS);break;case"*":this.addToken(m.ASTERISK);break;case"/":if(this.match("/"))for(;this.peek()!==`
`&&!this.isAtEnd();)this.advance();else this.match("*")?this.multilineComment():this.addToken(m.SLASH);break;case"%":this.addToken(m.PERCENT);break;case"~":this.addToken(m.TILDE);break;case"?":this.addToken(m.QUESTION);break;case":":this.addToken(m.COLON);break;case"$":this.addToken(m.DOLLAR);break;case"=":this.addToken(this.match("=")?m.EQUAL_EQUAL:m.EQUAL);break;case"!":this.addToken(this.match("=")?m.NOT_EQUAL:m.ERROR);break;case"<":this.match("=")?this.addToken(m.LESS_EQUAL):this.match(">")?this.addToken(m.NOT_EQUAL):this.addToken(m.LESS);break;case">":this.addToken(this.match("=")?m.GREATER_EQUAL:m.GREATER);break;case"|":this.addToken(this.match("|")?m.PIPE_PIPE:m.PIPE);break;case"&":this.addToken(this.match("&")?m.AMPERSAND_AMPERSAND:m.AMPERSAND);break;case"'":this.string("'");break;case'"':this.string('"');break;case"`":this.backtickIdentifier();break;case"[":this.bracketIdentifier();break;case"x":case"X":this.match("'")?this.blobLiteral():this.identifier();break;case" ":case"\r":case"	":break;case`
`:this.line++,this.column=1;break;default:this.isDigit(t)?this.number():this.isAlpha(t)?this.identifier():this.addErrorToken(`Unexpected character: ${t}`);break}}advance(){let t=this.source.charAt(this.current);return this.current++,t===`
`?(this.line++,this.column=1):this.column++,t}match(t){return this.isAtEnd()||this.source.charAt(this.current)!==t?!1:(this.current++,this.column++,!0)}peek(){return this.isAtEnd()?"\0":this.source.charAt(this.current)}peekNext(){return this.current+1>=this.source.length?"\0":this.source.charAt(this.current+1)}string(t){let n="",r=!1;for(;!this.isAtEnd()&&this.peek()!==t||r;){if(this.peek()===`
`&&(this.line++,this.column=1),r){let s=this.peek();switch(s){case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"\\":n+="\\";break;case"'":n+="'";break;case'"':n+='"';break;case"0":n+="\0";break;default:n+=s;break}r=!1}else this.peek()==="\\"?r=!0:n+=this.peek();this.advance()}if(this.isAtEnd()){this.addErrorToken("Unterminated string.");return}if(this.advance(),this.peek()===t&&(this.advance(),this.string(t),this.tokens.length>0&&this.tokens[this.tokens.length-1].type===m.STRING)){let s=this.tokens.pop();n+=s.literal}this.addToken(m.STRING,n)}backtickIdentifier(){let t="";for(;!this.isAtEnd()&&this.peek()!=="`";)this.peek()===`
`&&(this.line++,this.column=1),t+=this.advance();if(this.isAtEnd()){this.addErrorToken("Unterminated identifier.");return}this.advance(),this.addToken(m.IDENTIFIER,t)}bracketIdentifier(){let t="";for(;!this.isAtEnd()&&this.peek()!=="]";)this.peek()===`
`&&(this.line++,this.column=1),t+=this.advance();if(this.isAtEnd()){this.addErrorToken("Unterminated identifier.");return}this.advance(),this.addToken(m.IDENTIFIER,t)}blobLiteral(){let t="";for(;!this.isAtEnd()&&this.peek()!=="'";)if(this.isHexDigit(this.peek()))t+=this.advance();else if(this.isWhitespace(this.peek()))this.advance();else{this.addErrorToken("Invalid character in blob literal.");return}if(this.isAtEnd()){this.addErrorToken("Unterminated blob literal.");return}if(this.advance(),t.length%2!==0){this.addErrorToken("Blob literal must have an even number of hex digits.");return}try{let n=new Uint8Array(t.length/2);for(let r=0;r<t.length;r+=2)n[r/2]=parseInt(t.substring(r,r+2),16);this.addToken(m.BLOB,n)}catch{this.addErrorToken("Invalid blob literal.")}}number(){let t=!1,n="";for(;this.isDigit(this.peek());)n+=this.advance();if(this.peek()==="."&&this.isDigit(this.peekNext()))for(t=!0,n+=this.advance();this.isDigit(this.peek());)n+=this.advance();if(this.peek().toLowerCase()==="e"){if(t=!0,n+=this.advance(),(this.peek()==="+"||this.peek()==="-")&&(n+=this.advance()),!this.isDigit(this.peek())){this.addErrorToken("Invalid number literal: expected digits after exponent.");return}for(;this.isDigit(this.peek());)n+=this.advance()}if(t)this.addToken(m.FLOAT,parseFloat(n));else{let r=parseInt(n,10);r>Number.MAX_SAFE_INTEGER||r<Number.MIN_SAFE_INTEGER?this.addToken(m.INTEGER,BigInt(n)):this.addToken(m.INTEGER,r)}}identifier(){for(;this.isAlphaNumeric(this.peek());)this.advance();let t=this.source.substring(this.start,this.current).toLowerCase(),n=Wh[t]||m.IDENTIFIER;this.addToken(n)}multilineComment(){let t=1;for(;t>0&&!this.isAtEnd();)this.peek()==="/"&&this.peekNext()==="*"?(this.advance(),this.advance(),t++):this.peek()==="*"&&this.peekNext()==="/"?(this.advance(),this.advance(),t--):(this.peek()===`
`?(this.line++,this.column=1):this.column++,this.advance());t>0&&this.addErrorToken("Unterminated comment.")}isDigit(t){return t>="0"&&t<="9"}isHexDigit(t){return t>="0"&&t<="9"||t>="a"&&t<="f"||t>="A"&&t<="F"}isAlpha(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t==="_"}isAlphaNumeric(t){return this.isAlpha(t)||this.isDigit(t)}isWhitespace(t){return t===" "||t==="\r"||t===`
`||t==="	"}addToken(t,n){let r=this.source.substring(this.start,this.current);this.tokens.push({type:t,lexeme:r,literal:n,startLine:this.startLine,startColumn:this.startColumn,startOffset:this.start,endLine:this.line,endColumn:this.column-1,endOffset:this.current})}addErrorToken(t){this.tokens.push({type:m.ERROR,lexeme:t,startLine:this.line,startColumn:this.column-1,startOffset:this.current-1,endLine:this.line,endColumn:this.column-1,endOffset:this.current})}};var gt=class extends Error{token;constructor(t,n){super(n),this.token=t,this.name="ParseError"}};function k(e,t){return{start:{line:e.startLine,column:e.startColumn,offset:e.startOffset},end:{line:t.endLine,column:t.endColumn,offset:t.endOffset}}}var Be=class{tokens=[];current=0;parameterPosition=1;initialize(t){let n=new Cn(t);this.tokens=n.scanTokens(),this.current=0,this.parameterPosition=1;let r=this.tokens.find(s=>s.type===m.ERROR);if(r)throw new gt(r,`${r.lexeme} at line ${r.startLine}, column ${r.startColumn}`);return this}parse(t){this.initialize(t);try{let n=this.tryParseWithClause(),r=this.peek(),s=this.statement(r);if(n&&"withClause"in s)s.withClause=n,n.loc&&s.loc&&(s.loc.start=n.loc.start);else if(n)throw this.error(this.previous(),`WITH clause cannot be used with ${s.type} statement.`);if(this.match(m.SEMICOLON),!this.isAtEnd())throw this.error(this.peek(),`Unexpected token after end of statement: ${this.peek().lexeme}`);return s}catch(n){if(n instanceof gt){if(!n.message.includes(`at line ${n.token.startLine}`)){let r=` at line ${n.token.startLine}, column ${n.token.startColumn}`;n.message=n.message+r}throw n}throw console.error("Unhandled parser error:",n),new Error(`Parser error: ${n instanceof Error?n.message:n}`)}}tryParseWithClause(){if(!this.check(m.IDENTIFIER)||this.peek().lexeme.toUpperCase()!=="WITH")return;let t=this.advance(),n=this.matchKeyword("RECURSIVE"),r=[];do r.push(this.commonTableExpression());while(this.match(m.COMMA));let s=this.previous();return{type:"withClause",recursive:n,ctes:r,loc:k(t,s)}}commonTableExpression(){let t=this.peek(),n=this.consumeIdentifier("Expected CTE name."),r=this.previous(),s;if(this.match(m.LPAREN)){if(s=[],!this.check(m.RPAREN))do s.push(this.consumeIdentifier("Expected column name in CTE definition."));while(this.match(m.COMMA));r=this.consume(m.RPAREN,"Expected ')' after CTE column list.")}this.consume(m.AS,"Expected 'AS' after CTE name."),this.consume(m.LPAREN,"Expected '(' before CTE query.");let o=this.peek(),a;if(this.check(m.SELECT))a=this.selectStatement(o);else if(this.check(m.INSERT))a=this.insertStatement(o);else if(this.check(m.UPDATE))a=this.updateStatement(o);else if(this.check(m.DELETE))a=this.deleteStatement(o);else throw this.error(this.peek(),"Expected SELECT, INSERT, UPDATE, or DELETE statement for CTE query.");return r=this.consume(m.RPAREN,"Expected ')' after CTE query."),{type:"commonTableExpr",name:n,columns:s,query:a,loc:k(t,r)}}statement(t){switch(t.lexeme.toUpperCase()){case"SELECT":return this.advance(),this.selectStatement(t);case"INSERT":return this.advance(),this.insertStatement(t);case"UPDATE":return this.advance(),this.updateStatement(t);case"DELETE":return this.advance(),this.deleteStatement(t);case"CREATE":return this.advance(),this.createStatement(t);case"DROP":return this.advance(),this.dropStatement(t);case"ALTER":return this.advance(),this.alterTableStatement(t);case"BEGIN":return this.advance(),this.beginStatement(t);case"COMMIT":return this.advance(),this.commitStatement(t);case"ROLLBACK":return this.advance(),this.rollbackStatement(t);case"SAVEPOINT":return this.advance(),this.savepointStatement(t);case"RELEASE":return this.advance(),this.releaseStatement(t);case"PRAGMA":return this.advance(),this.pragmaStatement(t);default:throw this.error(t,`Expected statement type (SELECT, INSERT, UPDATE, DELETE, CREATE, etc.), got '${t.lexeme}'.`)}}insertStatement(t){this.matchKeyword("INTO");let n=this.tableIdentifier(),r;if(this.match(m.LPAREN)){r=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name.");r.push(this.advance().lexeme)}while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after column list.")}let s,o,a=this.previous();if(this.match(m.VALUES)){s=[];do{this.consume(m.LPAREN,"Expected '(' before values.");let i=[];if(!this.check(m.RPAREN))do i.push(this.expression());while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after values."),s.push(i),a=this.previous()}while(this.match(m.COMMA))}else if(this.check(m.SELECT)){let i=this.peek();o=this.selectStatement(i),a=this.previous()}else throw this.error(this.peek(),"Expected VALUES or SELECT after INSERT.");return{type:"insert",table:n,columns:r,values:s,select:o,loc:k(t,a)}}selectStatement(t){let n=t??this.previous(),r=n,s=this.matchKeyword("DISTINCT");s&&(r=this.previous());let o=!s&&this.matchKeyword("ALL");o&&(r=this.previous());let a=this.columnList();a.length>0&&(r=this.previous());let i;this.match(m.FROM)&&(i=this.tableSourceList(),i.length>0&&(r=this.previous()));let c;this.match(m.WHERE)&&(c=this.expression(),r=this.previous());let u;if(this.match(m.GROUP)&&this.consume(m.BY,"Expected 'BY' after 'GROUP'.")){u=[];do u.push(this.expression());while(this.match(m.COMMA));r=this.previous()}let d;this.match(m.HAVING)&&(d=this.expression(),r=this.previous());let l;if(this.match(m.ORDER)&&this.consume(m.BY,"Expected 'BY' after 'ORDER'.")){l=[];do{let y=this.expression(),w=this.match(m.DESC)?"desc":(this.match(m.ASC),"asc");l.push({expr:y,direction:w})}while(this.match(m.COMMA));r=this.previous()}let h,p;this.match(m.LIMIT)&&(h=this.expression(),r=this.previous(),this.match(m.OFFSET)?(p=this.expression(),r=this.previous()):this.match(m.COMMA)&&(p=h,h=this.expression(),r=this.previous()));let g,E=!1;if(this.match(m.UNION)){E=this.match(m.ALL);let y=this.peek();if(this.match(m.SELECT))g=this.selectStatement(y),r=this.previous();else throw this.error(this.peek(),"Expected 'SELECT' after 'UNION'.")}return{type:"select",columns:a,from:i,where:c,groupBy:u,having:d,orderBy:l,limit:h,offset:p,distinct:s,all:o,union:g,unionAll:E,loc:k(n,r)}}columnList(){let t=[],n=this.peek();do if(n=this.peek(),this.match(m.ASTERISK))t.push({type:"all"});else if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.DOT)&&this.checkNext(2,m.ASTERISK)){let r=this.advance().lexeme;this.advance(),this.advance(),t.push({type:"all",table:r})}else{let r=this.expression(),s,o=this.previous();if(this.match(m.AS))if(this.check(m.IDENTIFIER)||this.check(m.STRING)){let a=this.advance();s=a.lexeme,a.type===m.STRING&&(s=a.literal),o=a}else throw this.error(this.peek(),"Expected identifier or string after 'AS'.");else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.LPAREN)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isEndOfClause()){let a=this.advance();s=a.lexeme,o=a}t.push({type:"column",expr:r,alias:s})}while(this.match(m.COMMA));return t}tableIdentifier(){let t=this.peek(),n,r,s=t;if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.DOT)){if(n=this.advance().lexeme,this.advance(),!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected table name after schema.");r=this.advance().lexeme,s=this.previous()}else if(this.check(m.IDENTIFIER))r=this.advance().lexeme,s=this.previous();else throw this.error(this.peek(),"Expected table name.");return{type:"identifier",name:r,schema:n,loc:k(t,s)}}tableSourceList(){let t=[];do{let n=this.tableSource();for(;this.isJoinToken();)n=this.joinClause(n);t.push(n)}while(this.match(m.COMMA));return t}tableSource(){let t=this.peek();return this.check(m.IDENTIFIER)&&this.checkNext(1,m.LPAREN)?this.functionSource(t):this.standardTableSource(t)}standardTableSource(t){let n=this.tableIdentifier(),r=this.previous(),s;if(this.match(m.AS)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected alias after 'AS'.");let o=this.advance();s=o.lexeme,r=o}else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isJoinToken()&&!this.isEndOfClause()){let o=this.advance();s=o.lexeme,r=o}return{type:"table",table:n,alias:s,loc:k(t,r)}}functionSource(t){let n=this.tableIdentifier(),r=this.previous();this.consume(m.LPAREN,"Expected '(' after table function name.");let s=[],o=this.previous();if(!this.check(m.RPAREN))do s.push(this.expression()),o=this.previous();while(this.match(m.COMMA));r=this.consume(m.RPAREN,"Expected ')' after table function arguments.");let a;if(this.match(m.AS)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected alias after 'AS'.");let i=this.advance();a=i.lexeme,r=i}else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isJoinToken()&&!this.isEndOfClause()){let i=this.advance();a=i.lexeme,r=i}return{type:"functionSource",name:n,args:s,alias:a,loc:k(t,r)}}joinClause(t){let n=this.peek(),r="inner";this.match(m.LEFT)?(this.match(m.OUTER),r="left"):this.match(m.RIGHT)?(this.match(m.OUTER),r="right"):this.match(m.FULL)?(this.match(m.OUTER),r="full"):this.match(m.CROSS)?r="cross":this.match(m.INNER)&&(r="inner"),this.consume(m.JOIN,"Expected 'JOIN'.");let s=this.tableSource(),o,a,i=this.previous();if(this.match(m.ON))o=this.expression(),i=this.previous();else if(this.match(m.USING)){this.consume(m.LPAREN,"Expected '(' after 'USING'."),a=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name.");a.push(this.advance().lexeme)}while(this.match(m.COMMA));i=this.consume(m.RPAREN,"Expected ')' after columns.")}else if(r!=="cross")throw this.error(this.peek(),"Expected 'ON' or 'USING' after JOIN.");return{type:"join",joinType:r,left:t,right:s,condition:o,columns:a,loc:k(n,i)}}expression(){return this.logicalOr()}logicalOr(){let t=this.logicalAnd();for(;this.match(m.OR);){let n="OR",r=this.logicalAnd();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}logicalAnd(){let t=this.equality();for(;this.match(m.AND);){let n="AND",r=this.equality();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}equality(){let t=this.comparison();for(;this.match(m.EQUAL,m.EQUAL_EQUAL,m.NOT_EQUAL);){let n=this.previous().type===m.NOT_EQUAL?"!=":"=",r=this.comparison();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}comparison(){let t=this.term();for(;this.match(m.LESS,m.LESS_EQUAL,m.GREATER,m.GREATER_EQUAL);){let n;switch(this.previous().type){case m.LESS:n="<";break;case m.LESS_EQUAL:n="<=";break;case m.GREATER:n=">";break;case m.GREATER_EQUAL:n=">=";break;default:n="?"}let r=this.term();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}term(){let t=this.factor();for(;this.match(m.PLUS,m.MINUS);){let n=this.previous().type===m.PLUS?"+":"-",r=this.factor();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}factor(){if(this.match(m.MINUS,m.PLUS,m.TILDE)){let r=this.previous().lexeme,s=this.factor();return{type:"unary",operator:r,expr:s,loc:k(this.peek(),this.previous())}}let t=this.collateExpression();for(;this.match(m.ASTERISK,m.SLASH,m.PERCENT);){let r=this.previous().lexeme,s=this.collateExpression();t={type:"binary",operator:r,left:t,right:s,loc:k(this.peek(),this.previous())}}return t}primary(){let t=this.peek();if(this.match(m.INTEGER,m.FLOAT,m.STRING,m.NULL,m.BLOB)){let n=this.previous(),r=n.literal;return n.type===m.NULL&&(r=null),{type:"literal",value:r,loc:k(t,n)}}if(this.match(m.QUESTION)){let n=this.previous();return{type:"parameter",index:this.parameterPosition++,loc:k(t,n)}}if(this.match(m.COLON,m.DOLLAR)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected identifier after parameter prefix.");let n=this.advance();return{type:"parameter",name:n.lexeme,loc:k(t,n)}}if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.LPAREN)){let n=this.advance();this.consume(m.LPAREN,"Expected '(' after function name.");let r=[];if(!this.check(m.RPAREN))do this.match(m.ASTERISK)?r.push({type:"literal",value:"*",loc:k(this.peek(),this.peek())}):r.push(this.expression());while(this.match(m.COMMA));return this.consume(m.RPAREN,"Expected ')' after function arguments."),{type:"function",name:n.lexeme,args:r,isAggregate:!1,loc:k(t,this.previous())}}if(this.check(m.IDENTIFIER))if(this.checkNext(1,m.DOT)&&this.checkNext(2,m.IDENTIFIER)&&this.checkNext(3,m.DOT)&&this.checkNext(4,m.IDENTIFIER)){let n=this.advance().lexeme;this.advance();let r=this.advance().lexeme;this.advance();let s=this.advance();return{type:"column",name:s.lexeme,table:r,schema:n,loc:k(t,s)}}else if(this.checkNext(1,m.DOT)&&this.checkNext(2,m.IDENTIFIER)){let n=this.advance().lexeme;this.advance();let r=this.advance();return{type:"column",name:r.lexeme,table:n,loc:k(t,r)}}else{let n=this.advance();return{type:"column",name:n.lexeme,loc:k(t,n)}}if(this.match(m.LPAREN)){let n=this.expression();return this.consume(m.RPAREN,"Expected ')' after expression."),n}throw this.error(this.peek(),"Expected expression.")}match(...t){for(let n of t)if(this.check(n))return this.advance(),!0;return!1}consume(t,n){if(this.check(t))return this.advance();throw this.error(this.peek(),n)}check(t){return this.isAtEnd()?!1:this.peek().type===t}checkNext(t,n){return this.current+t>=this.tokens.length?!1:this.tokens[this.current+t].type===n}advance(){return this.isAtEnd()||this.current++,this.previous()}isAtEnd(){return this.peek().type===m.EOF}peek(){return this.tokens[this.current]}previous(){return this.tokens[this.current-1]}error(t,n){let r=` at line ${t.startLine}, column ${t.startColumn}`;return new gt(t,n+r)}isJoinToken(){return this.check(m.JOIN)||this.check(m.INNER)||this.check(m.LEFT)||this.check(m.RIGHT)||this.check(m.FULL)||this.check(m.CROSS)}isEndOfClause(){let t=this.peek().type;return t===m.FROM||t===m.WHERE||t===m.GROUP||t===m.HAVING||t===m.ORDER||t===m.LIMIT||t===m.UNION||t===m.SEMICOLON||t===m.EOF}updateStatement(t){let n=this.tableIdentifier();this.consume(m.SET,"Expected 'SET' after table name in UPDATE.");let r=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name in SET clause.");let a=this.advance().lexeme;this.consume(m.EQUAL,"Expected '=' after column name in SET clause.");let i=this.expression();r.push({column:a,value:i})}while(this.match(m.COMMA));let s;this.match(m.WHERE)&&(s=this.expression());let o=this.previous();return{type:"update",table:n,assignments:r,where:s,loc:k(t,o)}}deleteStatement(t){this.matchKeyword("FROM");let n=this.tableIdentifier(),r;this.match(m.WHERE)&&(r=this.expression());let s=this.previous();return{type:"delete",table:n,where:r,loc:k(t,s)}}createStatement(t){if(this.peekKeyword("TABLE"))return this.consumeKeyword("TABLE","Expected 'TABLE' after CREATE."),this.createTableStatement(t);if(this.peekKeyword("INDEX"))return this.consumeKeyword("INDEX","Expected 'INDEX' after CREATE."),this.createIndexStatement(t);if(this.peekKeyword("VIEW"))return this.consumeKeyword("VIEW","Expected 'VIEW' after CREATE."),this.createViewStatement(t);if(this.peekKeyword("UNIQUE"))return this.consumeKeyword("UNIQUE","Expected 'UNIQUE' after CREATE."),this.consumeKeyword("INDEX","Expected 'INDEX' after CREATE UNIQUE."),this.createIndexStatement(t,!0);throw this.error(this.peek(),"Expected TABLE, [UNIQUE] INDEX, VIEW, or VIRTUAL after CREATE.")}createTableStatement(t){let n=!1;(this.peekKeyword("TEMP")||this.peekKeyword("TEMPORARY"))&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier(),o=[],a=[],i=!1;if(this.check(m.LPAREN)){this.consume(m.LPAREN,"Expected '(' to start table definition.");do this.peekKeyword("PRIMARY")||this.peekKeyword("UNIQUE")||this.peekKeyword("CHECK")||this.peekKeyword("FOREIGN")||this.peekKeyword("CONSTRAINT")?a.push(this.tableConstraint()):o.push(this.columnDefinition());while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after table definition."),this.matchKeyword("WITHOUT")&&(this.consumeKeyword("ROWID","Expected 'ROWID' after 'WITHOUT'."),i=!0)}else if(this.matchKeyword("AS")){let c=this.selectStatement();throw new Error("CREATE TABLE AS SELECT is not fully implemented.")}else throw this.error(this.peek(),"Expected '(' or 'AS' after table name.");return{type:"createTable",table:s,ifNotExists:r,columns:o,constraints:a,withoutRowid:i,isTemporary:n,loc:k(t,this.previous())}}createIndexStatement(t,n=!1){!n&&this.peekKeyword("UNIQUE")&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier();this.consumeKeyword("ON","Expected 'ON' after index name.");let o=this.tableIdentifier();this.consume(m.LPAREN,"Expected '(' before indexed columns.");let a=this.indexedColumnList();this.consume(m.RPAREN,"Expected ')' after indexed columns.");let i;return this.matchKeyword("WHERE")&&(i=this.expression()),{type:"createIndex",index:s,table:o,ifNotExists:r,columns:a,where:i,isUnique:n,loc:k(t,this.previous())}}createViewStatement(t){let n=!1;(this.peekKeyword("TEMP")||this.peekKeyword("TEMPORARY"))&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier(),o;if(this.check(m.LPAREN)){if(this.consume(m.LPAREN,"Expected '(' to start view column list."),o=[],!this.check(m.RPAREN))do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name in view column list.");o.push(this.advance().lexeme)}while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after view column list.")}this.consumeKeyword("AS","Expected 'AS' before SELECT statement for CREATE VIEW.");let a=this.selectStatement();return{type:"createView",view:s,ifNotExists:r,columns:o,select:a,isTemporary:n,loc:k(t,this.previous())}}dropStatement(t){let n;if(this.peekKeyword("TABLE"))this.consumeKeyword("TABLE","Expected TABLE after DROP."),n="table";else if(this.peekKeyword("VIEW"))this.consumeKeyword("VIEW","Expected VIEW after DROP."),n="view";else if(this.peekKeyword("INDEX"))this.consumeKeyword("INDEX","Expected INDEX after DROP."),n="index";else throw this.error(this.peek(),"Expected TABLE, VIEW, or INDEX after DROP.");let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF'."),r=!0);let s=this.tableIdentifier();return{type:"drop",objectType:n,name:s,ifExists:r,loc:k(t,this.previous())}}alterTableStatement(t){this.consumeKeyword("TABLE","Expected 'TABLE' after ALTER.");let n=this.tableIdentifier(),r;if(this.peekKeyword("RENAME"))if(this.consumeKeyword("RENAME","Expected RENAME."),this.matchKeyword("COLUMN")){let s=this.consumeIdentifier("Expected old column name after RENAME COLUMN.");this.consumeKeyword("TO","Expected 'TO' after old column name.");let o=this.consumeIdentifier("Expected new column name after TO.");r={type:"renameColumn",oldName:s,newName:o}}else this.consumeKeyword("TO","Expected 'TO' after RENAME."),r={type:"renameTable",newName:this.consumeIdentifier("Expected new table name after RENAME TO.")};else if(this.peekKeyword("ADD"))this.consumeKeyword("ADD","Expected ADD."),this.matchKeyword("COLUMN"),r={type:"addColumn",column:this.columnDefinition()};else if(this.peekKeyword("DROP"))this.consumeKeyword("DROP","Expected DROP."),this.matchKeyword("COLUMN"),r={type:"dropColumn",name:this.consumeIdentifier("Expected column name after DROP COLUMN.")};else throw this.error(this.peek(),"Expected RENAME, ADD, or DROP after table name in ALTER TABLE.");return{type:"alterTable",table:n,action:r,loc:k(t,this.previous())}}beginStatement(t){let n;return this.peekKeyword("DEFERRED")?(this.advance(),n="deferred"):this.peekKeyword("IMMEDIATE")?(this.advance(),n="immediate"):this.peekKeyword("EXCLUSIVE")&&(this.advance(),n="exclusive"),this.matchKeyword("TRANSACTION"),{type:"begin",mode:n,loc:k(t,this.previous())}}commitStatement(t){return this.matchKeyword("TRANSACTION"),{type:"commit",loc:k(t,this.previous())}}rollbackStatement(t){this.matchKeyword("TRANSACTION");let n;if(this.matchKeyword("TO")){if(this.matchKeyword("SAVEPOINT"),!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected savepoint name after ROLLBACK TO.");n=this.advance().lexeme}return{type:"rollback",savepoint:n,loc:k(t,this.previous())}}savepointStatement(t){return{type:"savepoint",name:this.consumeIdentifier("Expected savepoint name after SAVEPOINT."),loc:k(t,this.previous())}}releaseStatement(t){return this.matchKeyword("SAVEPOINT"),{type:"release",savepoint:this.consumeIdentifier("Expected savepoint name after RELEASE [SAVEPOINT]."),loc:k(t,this.previous())}}pragmaStatement(t){let n=this.consumeIdentifier("Expected pragma name."),r;if(this.match(m.EQUAL))if(this.check(m.IDENTIFIER))r={type:"identifier",name:this.advance().lexeme};else if(this.match(m.STRING,m.INTEGER,m.FLOAT,m.NULL)){let s=this.previous();r={type:"literal",value:s.type===m.NULL?null:s.literal}}else if(this.match(m.MINUS))if(this.check(m.INTEGER)||this.check(m.FLOAT))r={type:"literal",value:-this.advance().literal};else throw this.error(this.peek(),"Expected number after '-'.");else throw this.error(this.peek(),"Expected pragma value (identifier, string, number, or NULL).");else throw this.error(this.peek(),"Expected '=' after pragma name.");return{type:"pragma",name:n.toLowerCase(),value:r,loc:k(t,this.previous())}}indexedColumnList(){let t=[];do t.push(this.indexedColumn());while(this.match(m.COMMA));return t}indexedColumn(){let t=this.expression(),n;t.type==="column"&&!t.table&&!t.schema&&(n=t.name);let r;return this.match(m.ASC)?r="asc":this.match(m.DESC)&&(r="desc"),n?{name:n,direction:r}:{expr:t,direction:r}}consumeIdentifier(t){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),t);return this.advance().lexeme}columnDefinition(){let t=this.consumeIdentifier("Expected column name."),n;if(this.check(m.IDENTIFIER)&&(n=this.advance().lexeme,this.match(m.LPAREN))){n+="(";let s=1;for(;s>0&&!this.isAtEnd();){let o=this.peek();o.type===m.LPAREN&&s++,o.type===m.RPAREN&&s--,s>0&&(n+=this.advance().lexeme)}n+=")",this.consume(m.RPAREN,"Expected ')' after type parameters.")}let r=this.columnConstraintList();return{name:t,dataType:n,constraints:r}}columnConstraintList(){let t=[];for(;this.isColumnConstraintStart();)t.push(this.columnConstraint());return t}isColumnConstraintStart(){return this.check(m.CONSTRAINT)||this.check(m.PRIMARY)||this.check(m.NOT)||this.check(m.UNIQUE)||this.check(m.CHECK)||this.check(m.DEFAULT)||this.check(m.COLLATE)||this.check(m.REFERENCES)||this.check(m.GENERATED)}columnConstraint(){let t,n=this.peek(),r=n;if(this.match(m.CONSTRAINT)&&(t=this.consumeIdentifier("Expected constraint name after CONSTRAINT."),r=this.previous()),this.match(m.PRIMARY)){this.consume(m.KEY,"Expected KEY after PRIMARY.");let s=this.match(m.ASC)?"asc":this.match(m.DESC)?"desc":void 0;s&&(r=this.previous());let o=this.parseConflictClause();o&&(r=this.previous());let a=this.match(m.AUTOINCREMENT);return a&&(r=this.previous()),{type:"primaryKey",name:t,onConflict:o,autoincrement:a,direction:s,loc:k(n,r)}}else if(this.match(m.NOT)){this.consume(m.NULL,"Expected NULL after NOT."),r=this.previous();let s=this.parseConflictClause();return s&&(r=this.previous()),{type:"notNull",name:t,onConflict:s,loc:k(n,r)}}else if(this.match(m.UNIQUE)){r=this.previous();let s=this.parseConflictClause();return s&&(r=this.previous()),{type:"unique",name:t,onConflict:s,loc:k(n,r)}}else if(this.match(m.CHECK)){this.consume(m.LPAREN,"Expected '(' after CHECK.");let s=this.expression();return r=this.consume(m.RPAREN,"Expected ')' after CHECK expression."),{type:"check",name:t,expr:s,loc:k(n,r)}}else if(this.match(m.DEFAULT)){let s=this.expression();return r=this.previous(),{type:"default",name:t,expr:s,loc:k(n,r)}}else if(this.match(m.COLLATE)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected collation name after COLLATE.");let s=this.advance().lexeme;return r=this.previous(),{type:"collate",name:t,collation:s,loc:k(n,r)}}else if(this.match(m.REFERENCES)){let s=this.foreignKeyClause();return r=this.previous(),{type:"foreignKey",name:t,foreignKey:s,loc:k(n,r)}}else if(this.match(m.GENERATED)){this.consume(m.ALWAYS,"Expected ALWAYS after GENERATED."),this.consume(m.AS,"Expected AS after GENERATED ALWAYS."),this.consume(m.LPAREN,"Expected '(' after AS.");let s=this.expression();this.consume(m.RPAREN,"Expected ')' after generated expression."),r=this.previous();let o=!1;return this.match(m.STORED)?(o=!0,r=this.previous()):this.match(m.VIRTUAL)&&(r=this.previous()),{type:"generated",name:t,generated:{expr:s,stored:o},loc:k(n,r)}}throw this.error(this.peek(),"Expected column constraint type (PRIMARY KEY, NOT NULL, UNIQUE, CHECK, DEFAULT, COLLATE, REFERENCES, GENERATED).")}tableConstraint(){let t;if(this.match(m.CONSTRAINT)&&(t=this.consumeIdentifier("Expected constraint name after CONSTRAINT.")),this.match(m.PRIMARY)){this.consume(m.KEY,"Expected KEY after PRIMARY."),this.consume(m.LPAREN,"Expected '(' before PRIMARY KEY columns.");let n=this.identifierListWithDirection();this.consume(m.RPAREN,"Expected ')' after PRIMARY KEY columns.");let r=this.parseConflictClause();return{type:"primaryKey",name:t,columns:n,onConflict:r}}else if(this.match(m.UNIQUE)){this.consume(m.LPAREN,"Expected '(' before UNIQUE columns.");let r=this.identifierList().map(o=>({name:o}));this.consume(m.RPAREN,"Expected ')' after UNIQUE columns.");let s=this.parseConflictClause();return{type:"unique",name:t,columns:r,onConflict:s}}else if(this.match(m.CHECK)){this.consume(m.LPAREN,"Expected '(' after CHECK.");let n=this.expression();return this.consume(m.RPAREN,"Expected ')' after CHECK expression."),{type:"check",name:t,expr:n}}else if(this.match(m.FOREIGN)){this.consume(m.KEY,"Expected KEY after FOREIGN."),this.consume(m.LPAREN,"Expected '(' before FOREIGN KEY columns.");let n=this.identifierList().map(s=>({name:s}));this.consume(m.RPAREN,"Expected ')' after FOREIGN KEY columns.");let r=this.foreignKeyClause();return{type:"foreignKey",name:t,columns:n,foreignKey:r}}throw this.error(this.peek(),"Expected table constraint type (PRIMARY KEY, UNIQUE, CHECK, FOREIGN KEY).")}foreignKeyClause(){this.consume(m.REFERENCES,"Expected REFERENCES for foreign key.");let t=this.consumeIdentifier("Expected foreign table name."),n;this.match(m.LPAREN)&&(n=this.identifierList(),this.consume(m.RPAREN,"Expected ')' after foreign columns."));let r,s,o,a;for(;this.check(m.ON)||this.check(m.DEFERRABLE)||this.check(m.NOT);)if(this.match(m.ON))if(this.match(m.DELETE))r=this.parseForeignKeyAction();else if(this.match(m.UPDATE))s=this.parseForeignKeyAction();else throw this.error(this.peek(),"Expected DELETE or UPDATE after ON.");else if(this.match(m.DEFERRABLE)){if(o=!0,this.match(m.INITIALLY))if(this.match(m.DEFERRED))a=!0;else if(this.match(m.IMMEDIATE))a=!1;else throw this.error(this.peek(),"Expected DEFERRED or IMMEDIATE after INITIALLY.")}else if(this.match(m.NOT)){if(this.consume(m.DEFERRABLE,"Expected DEFERRABLE after NOT."),o=!1,this.match(m.INITIALLY))if(this.match(m.DEFERRED))a=!0;else if(this.match(m.IMMEDIATE))a=!1;else throw this.error(this.peek(),"Expected DEFERRED or IMMEDIATE after INITIALLY.")}else break;return{table:t,columns:n,onDelete:r,onUpdate:s,deferrable:o,initiallyDeferred:a}}parseConflictClause(){if(this.match(m.ON)){if(this.consume(m.CONFLICT,"Expected CONFLICT after ON."),this.match(m.ROLLBACK))return W.ROLLBACK;if(this.match(m.ABORT))return W.ABORT;if(this.match(m.FAIL))return W.FAIL;if(this.match(m.IGNORE))return W.IGNORE;if(this.match(m.REPLACE))return W.REPLACE;throw this.error(this.peek(),"Expected conflict resolution algorithm (ROLLBACK, ABORT, FAIL, IGNORE, REPLACE).")}}parseForeignKeyAction(){if(this.match(m.SET)){if(this.match(m.NULL))return"setNull";if(this.match(m.DEFAULT))return"setDefault";throw this.error(this.peek(),"Expected NULL or DEFAULT after SET.")}else{if(this.match(m.CASCADE))return"cascade";if(this.match(m.RESTRICT))return"restrict";if(this.match(m.NO))return this.consume(m.ACTION,"Expected ACTION after NO."),"noAction"}throw this.error(this.peek(),"Expected foreign key action (SET NULL, SET DEFAULT, CASCADE, RESTRICT, NO ACTION).")}identifierList(){let t=[];do t.push(this.consumeIdentifier("Expected identifier in list."));while(this.match(m.COMMA));return t}identifierListWithDirection(){let t=[];do{let n=this.consumeIdentifier("Expected identifier in list."),r=this.match(m.ASC)?"asc":this.match(m.DESC)?"desc":void 0;t.push({name:n,direction:r})}while(this.match(m.COMMA));return t}peekKeyword(t){if(this.isAtEnd())return!1;let n=this.peek();return n.type===m.IDENTIFIER&&n.lexeme.toUpperCase()===t||n.type===m[t.toUpperCase()]}matchKeyword(t){return this.isAtEnd()?!1:this.peekKeyword(t)?(this.advance(),!0):!1}consumeKeyword(t,n){if(this.peekKeyword(t))return this.advance();throw this.error(this.peek(),n)}collateExpression(){let t=this.primary();if(this.match(m.COLLATE)){let n=this.previous(),r=this.consumeIdentifier("Expected collation name after COLLATE.");t={type:"collate",expr:t,collation:r,loc:k(this.peek(),this.previous())}}return t}};function Sn(e,t=0,n=0,r=0,s=null,o=0,a){return{opcode:e,p1:t,p2:n,p3:r,p4:s,p5:o,comment:a}}function Sl(e,t){let r=e.currentFrameLocals<2?2:e.currentFrameLocals+1,s=r+t-1;e.currentFrameLocals=Math.max(e.currentFrameLocals,s),e.maxLocalOffsetInCurrentFrame=Math.max(e.maxLocalOffsetInCurrentFrame,s);let o=e.framePointer+s;return e.numMemCells=Math.max(e.numMemCells,o),r}function Al(e){let t=e.numCursors;return e.numCursors++,t}function Rl(e,t){let n=e.constants.length;return e.constants.push(t),n}function Tl(e,t,n=0,r=0,s=0,o=null,a=0,i){let c=e.subroutineDepth>0?e.subroutineCode:e.instructions,u=Sn(t,n,r,s,o,a,i);return c.push(u),c.length-1}function vl(e){return-((e.subroutineDepth>0?e.subroutineCode:e.instructions).length+1)}function Ll(e,t){if(t>=0){console.warn(`Attempting to resolve a non-placeholder address: ${t}`);return}let n=e.subroutineDepth>0?e.subroutineCode:e.instructions,r=n.length,s=-(t+1);if(s<0||s>=n.length){console.warn(`Placeholder address ${t} corresponds to invalid index ${s} in current code block.`);return}let o=n[s],a={[f.Goto]:"p2",[f.IfTrue]:"p2",[f.IfFalse]:"p2",[f.IfZero]:"p2",[f.IfNull]:"p2",[f.IfNotNull]:"p2",[f.Eq]:"p2",[f.Ne]:"p2",[f.Lt]:"p2",[f.Le]:"p2",[f.Gt]:"p2",[f.Ge]:"p2",[f.Once]:"p2",[f.VFilter]:"p2",[f.VNext]:"p2",[f.Rewind]:"p2",[f.Subroutine]:"p2"},i=o.opcode;if(i in a){let c=a[i];c&&o[c]===t?o[c]=r:console.warn(`Instruction at index ${s} (${f[o.opcode]}) does not match placeholder ${t} for its expected address parameter (${c||"none"}).`)}else console.warn(`Opcode ${f[o.opcode]} not configured for address resolution.`)}function Ol(e){return(e.subroutineDepth>0?e.subroutineCode:e.instructions).length}function _e(e){return{name:e,affinity:A.TEXT,notNull:!1,primaryKey:!1,pkOrder:0,defaultValue:null,collation:"BINARY",hidden:!1,generated:!1}}function fe(e){let t=new Map;return e.forEach((n,r)=>{t.set(n.name.toLowerCase(),r)}),t}function xl(e){let t=e.map((n,r)=>({...n,index:r})).filter(n=>n.primaryKey).sort((n,r)=>n.pkOrder-r.pkOrder);return Object.freeze(t.map(n=>({index:n.index,desc:!1})))}function Ml(e,t,n,r){let s=Array.from({length:n},(i,c)=>_e(`eph_col${c}`)),o=[];r&&(r.keyIndices.forEach((i,c)=>{i>=0&&i<s.length&&r.collations?.[c]&&(s[i].collation=r.collations[c])}),o=Object.freeze(r.keyIndices.map((i,c)=>({index:i,desc:r.directions[c]}))),o.forEach(i=>{i.index>=0&&i.index<s.length&&(s[i.index].primaryKey=!0)}));let a={name:`ephemeral_${t}`,schemaName:"temp",checkConstraints:[],columns:Object.freeze(s),columnIndexMap:Object.freeze(fe(s)),primaryKeyDefinition:o,isVirtual:!0};return e.tableSchemas.set(t,a),e.ephemeralTables.set(t,a),a}function Dl(e,t){t.forEach(n=>{e.emit(f.Close,n,0,0,null,0,`Close inner cursor ${n}`),e.tableSchemas.delete(n),e.ephemeralTables.delete(n),e.cursorPlanningInfo.delete(n);for(let[r,s]of e.tableAliases.entries())if(s===n){e.tableAliases.delete(r);break}})}var Uy=new Set(["ABORT","ACTION","ADD","AFTER","ALL","ALTER","ANALYZE","AND","AS","ASC","ATTACH","AUTOINCREMENT","BEFORE","BEGIN","BETWEEN","BY","CASCADE","CASE","CAST","CHECK","COLLATE","COLUMN","COMMIT","CONFLICT","CONSTRAINT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","DATABASE","DEFAULT","DEFERRABLE","DEFERRED","DELETE","DESC","DETACH","DISTINCT","DROP","EACH","ELSE","END","ESCAPE","EXCEPT","EXCLUSIVE","EXISTS","EXPLAIN","FAIL","FOR","FOREIGN","FROM","FULL","GLOB","GROUP","HAVING","IF","IGNORE","IMMEDIATE","IN","INDEX","INDEXED","INITIALLY","INNER","INSERT","INSTEAD","INTERSECT","INTO","IS","ISNULL","JOIN","KEY","LEFT","LIKE","LIMIT","MATCH","NATURAL","NO","NOT","NOTNULL","NULL","OF","OFFSET","ON","OR","ORDER","OUTER","PLAN","PRAGMA","PRIMARY","QUERY","RAISE","RECURSIVE","REFERENCES","REGEXP","REINDEX","RELEASE","RENAME","REPLACE","RESTRICT","RIGHT","ROLLBACK","ROW","SAVEPOINT","SELECT","SET","TABLE","TEMP","TEMPORARY","THEN","TO","TRANSACTION","TRIGGER","UNION","UNIQUE","UPDATE","USING","VACUUM","VALUES","VIEW","VIRTUAL","WHEN","WHERE","WITH","WITHOUT"].map(e=>e.toUpperCase()));function Pl(e,t){let n=e.db,r=t.table.schema||"main",s=t.table.name,o,a=[],i=!1;if(t.moduleName)o=t.moduleName,a=t.moduleArgs||[],i=!0;else{let h=n.getDefaultVtabModule();o=h.name,a=[...h.args]}let c=n._getVtabModule(o);if(!c)throw new b(`No virtual table module named '${o}'`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let u;try{if(o.toLowerCase()==="memory"){let h,p,g=[];if(i){if(a.length===0||!a[0].trim().toUpperCase().startsWith("CREATE TABLE"))throw new Error("When using 'USING memory(...)', the first argument must be the CREATE TABLE DDL string.");let E=a[0],w=new Be().parse(E);if(w.type!=="createTable")throw new Error("Argument provided to 'USING memory(...)' did not parse as a CREATE TABLE statement.");let N=w;h=N.columns.map(C=>({name:C.name,type:Qr(C.dataType)})),p=Jr(N.columns,N.constraints),N.columns.forEach(C=>{C.constraints?.forEach(S=>{S.type==="check"&&S.expr&&g.push({name:S.name,expr:S.expr})})}),N.constraints?.forEach(C=>{C.type==="check"&&C.expr&&g.push({name:C.name,expr:C.expr})})}else{if(!t.columns||t.columns.length===0)throw new Error("Cannot create implicit memory table without column definitions.");h=t.columns.map(E=>({name:E.name,type:Qr(E.dataType)})),p=Jr(t.columns,t.constraints||[]),t.columns.forEach(E=>{E.constraints?.forEach(y=>{y.type==="check"&&y.expr&&g.push({name:y.name,expr:y.expr})})}),t.constraints?.forEach(E=>{E.type==="check"&&E.expr&&g.push({name:E.name,expr:E.expr})})}u={columns:Object.freeze(h),primaryKey:p,checkConstraints:Object.freeze(g),readOnly:!1}}else if(o.toLowerCase()==="json_each"||o.toLowerCase()==="json_tree"){if(a.length<1||a.length>2)throw new Error(`${o} requires 1 or 2 arguments (jsonSource, [rootPath])`);u={jsonSource:a[0],rootPath:a[1]}}else console.warn(`Compiler creating generic BaseModuleConfig for module '${o}'. Module may need specific argument parsing.`),u={}}catch(h){throw new b(`Failed to parse arguments for module '${o}': ${h.message}`,I.ERROR,h instanceof Error?h:void 0,t.loc?.start.line,t.loc?.start.column)}let d;try{d=c.module.xCreate(n,c.auxData,o,r,s,u)}catch(h){let p=h instanceof Error?h.message:String(h),g=h instanceof b?h.code:I.ERROR;throw new b(`Module '${o}' xCreate failed for table '${s}': ${p}`,g,h instanceof Error?h:void 0,t.loc?.start.line,t.loc?.start.column)}let l=n.schemaManager.getSchema(r);if(!l)throw new b(`Internal error: Schema '${r}' not found during CREATE TABLE.`,I.INTERNAL);if(l.getTable(s))if(t.ifNotExists){console.log(`Skipping CREATE TABLE: Table ${r}.${s} already exists (IF NOT EXISTS).`),e.emit(f.Noop,0,0,0,null,0,`CREATE TABLE ${s} (skipped IF NOT EXISTS)`);return}else throw new b(`Table ${r}.${s} already exists`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!d.tableSchema)throw new b(`Module '${o}' xCreate did not provide a tableSchema for '${s}'.`,I.INTERNAL);d.tableSchema.schemaName.toLowerCase()!==r.toLowerCase()&&(console.warn(`VTab module ${o} created table ${s} in schema ${d.tableSchema.schemaName}, but expected ${r}.`),d.tableSchema.schemaName=r),d.tableSchema.vtabModuleName||(d.tableSchema.vtabModuleName=o),d.tableSchema.vtabArgs||(d.tableSchema.vtabArgs=Object.freeze(a)),l.addTable(d.tableSchema),console.log(`Successfully created table ${r}.${s} using module ${o}`),e.emit(f.Noop,0,0,0,null,0,`CREATE TABLE ${s}`)}function kl(e,t){e.emit(f.Noop,0,0,0,null,0,"CREATE INDEX (no-op in VDBE)")}function Fl(e,t){let n=t.view.schema??e.db.schemaManager.getCurrentSchemaName(),r=t.view.name,s;try{s=e.db.schemaManager.getSchemaOrFail(n)}catch{let c=e.db.schemaManager.getSchema(n);if(!c)throw new b(`Schema '${n}' not found`,I.ERROR);s=c}let o=s.getTable(r)??s.getView(r);if(o)if(t.ifNotExists){e.emit(f.Noop,0,0,0,null,0,`View ${n}.${r} already exists (IF NOT EXISTS)`);return}else{let i="selectAst"in o?"view":"table";throw new b(`cannot create ${i} ${r}: already exists in schema ${s.name}`,I.ERROR)}let a={name:r,schemaName:s.name,sql:e.sql,selectAst:t.select,columns:t.columns?Object.freeze(t.columns):void 0};try{s.addView(a)}catch(i){throw i instanceof b?i:new b(`Error adding view ${r} to schema ${s.name}: ${i.message}`,I.INTERNAL)}e.emit(f.Noop,0,0,0,null,0,`Schema definition for VIEW ${n}.${r}`)}function Ul(e,t){let n=t.name.schema??e.db.schemaManager.getCurrentSchemaName(),r=t.name.name,s=!1,o=t.objectType;try{switch(t.objectType){case"table":s=e.db.schemaManager.dropTable(n,r);break;case"view":s=e.db.schemaManager.dropView(n,r);break;case"index":e.emit(f.Noop,0,0,0,null,0,`DROP INDEX ${n}.${r} (Not fully implemented)`),s=!0,o="index",console.warn("DROP INDEX compilation is a placeholder.");break;default:throw new b(`Unsupported object type for DROP: ${t.objectType}`)}if(!s&&!t.ifExists)throw new b(`no such ${o}: ${r}`,I.ERROR)}catch(i){throw i instanceof b?i:new b(`Error dropping ${o} ${r}: ${i.message}`,I.INTERNAL)}let a=s?`Schema definition drop for ${o.toUpperCase()} ${n}.${r}`:`${o.toUpperCase()} ${n}.${r} did not exist (IF EXISTS)`;e.emit(f.Noop,0,0,0,null,0,a)}function $l(e,t){e.emit(f.Noop,0,0,0,null,0,"ALTER TABLE (no-op in VDBE)")}function Bl(e,t){e.emit(f.VBegin,0,0,0,null,0,`BEGIN ${t.mode||"DEFERRED"}`)}function _l(e,t){e.emit(f.VCommit,0,0,0,null,0,"COMMIT")}function Vl(e,t){let n=e.db,r=t.name,s=t.value,o=a=>a?a.type==="literal"?a.value===null?null:String(a.value):a.type==="identifier"?a.name:null:null;switch(r){case"default_vtab_module":{let a=o(s);if(a===null)throw new b("PRAGMA default_vtab_module requires a string or identifier value.",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);console.log(`Setting default VTab module to: ${a}`),n.setDefaultVtabName(a);break}case"default_vtab_args":{let a=o(s);a===null?(console.log("Clearing default VTab args."),n.setDefaultVtabArgsFromJson("[]")):(console.log(`Setting default VTab args from JSON: ${a}`),n.setDefaultVtabArgsFromJson(a));break}default:console.warn(`Ignoring unrecognized PRAGMA: ${r}`);break}e.emit(f.Noop,0,0,0,null,0,`PRAGMA ${r}`)}function Jr(e,t){let n=new Map;e.forEach((o,a)=>n.set(o.name.toLowerCase(),a));let r=[],s=!1;if(t){for(let o of t)if(o.type==="primaryKey"&&o.columns){if(s)throw new Error("Multiple primary keys defined");s=!0,r=o.columns.map(a=>{let i=n.get(a.name.toLowerCase());if(i===void 0)throw new Error(`PK column ${a.name} not found`);return{index:i,desc:a.direction==="desc"}});break}}return s||e.forEach((o,a)=>{let i=o.constraints.find(c=>c.type==="primaryKey");if(i){if(s)throw new Error("Multiple primary keys defined (column + table/column)");s=!0,r=[{index:a,desc:i.direction==="desc"}]}}),r.length>0?Object.freeze(r):void 0}function Qr(e){let t=e?.toUpperCase()||"";return t.includes("INT")?A.INTEGER:t.includes("REAL")||t.includes("FLOAT")||t.includes("DOUBLE")?A.REAL:t.includes("BLOB")?A.BLOB:t.includes("BOOL")?A.INTEGER:A.TEXT}function Kl(e,t){let n=[];if(!t||t.length===0)return n;let r=(s,o)=>{if(s.type==="table"){let a=s.table.name,i=s.table.schema||"main",c=(s.alias||a).toLowerCase(),u=a.toLowerCase(),d=e.cteMap.get(u);if(d){if(d.type==="materialized"){let p=d.cursorIdx;n.push(p);let g=d.schema;if(e.tableSchemas.set(p,g),e.tableAliases.has(c)||o.has(c))throw new b(`Duplicate table name or alias: ${c}`,I.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);e.tableAliases.set(c,p),o.set(c,p),console.log(`FROM: Using materialized CTE '${u}' with cursor ${p} for alias '${c}'`)}else throw new b(`Unsupported CTE type '${d.type}' found for ${u}`,I.INTERNAL);return}let l=e.allocateCursor();n.push(l);let h=e.db._findTable(a,i);if(!h)throw new b(`Table not found: ${i}.${a}`,I.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column);if(e.tableSchemas.set(l,h),e.tableAliases.has(c)||o.has(c))throw new b(`Duplicate table name or alias: ${c}`,I.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);if(e.tableAliases.set(c,l),o.set(c,l),h.isVirtual&&h.vtabInstance){let p={type:"vtab",tableSchema:h};e.emit(f.OpenRead,l,0,0,p,0,`Open VTab ${s.alias||a}`)}else if(h.isVirtual&&!h.vtabInstance){console.warn(`VTab ${a} found but not connected, attempting connect...`);let p=e.db._getVtabModule(h.vtabModuleName??"");if(!p)throw new b(`Module ${h.vtabModuleName} not found for VTab ${a}`,I.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column);let g=h.vtabModuleName??"",E=h.vtabArgs??[],y={};try{if(g.toLowerCase()==="memory")if(E.length>0&&E[0].trim().toUpperCase().startsWith("CREATE TABLE")){let S=E[0],L=new Be().parse(S);if(L.type==="createTable"){let T=L;y={columns:Object.freeze(T.columns.map(O=>({name:O.name,type:Qr(O.dataType)}))),primaryKey:Jr(T.columns,T.constraints),readOnly:!1}}else console.warn(`Could not parse stored DDL argument for memory table ${a} during connect.`)}else throw console.warn(`Could not reconstruct schema for memory table ${a} during connect: DDL argument missing or invalid.`),new b(`Cannot connect to memory table ${a}: schema information missing from stored arguments.`);else if(g.toLowerCase()==="json_each"||g.toLowerCase()==="json_tree"){if(E.length<1||E.length>2)throw new Error(`${g} requires 1 or 2 stored arguments (jsonSource, [rootPath])`);y={jsonSource:E[0],rootPath:E[1]}}else y={}}catch(S){throw new b(`Failed to parse stored arguments for module '${g}' on connect: ${S.message}`,I.ERROR,S instanceof Error?S:void 0)}let w=p.module.xConnect(e.db,p.auxData,g,i,a,y),N={...h,vtabInstance:w};e.db.schemaManager.getSchema(i)?.addTable(N),e.tableSchemas.set(l,N);let C={type:"vtab",tableSchema:N};e.emit(f.OpenRead,l,0,0,C,0,`Open VTab ${s.alias||a}`)}else throw new b("Regular tables not supported",I.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column)}else if(s.type==="join")r(s.left,o),r(s.right,o);else if(s.type==="functionSource"){let a=s.name.name,i=e.db._getVtabModule(a);if(!i)throw new b(`Table-valued function or virtual table module not found: ${a}`,I.ERROR,void 0,s.name.loc?.start.line,s.name.loc?.start.column);let c=[];for(let w of s.args){let N=e.allocateMemoryCells(1);if(e.compileExpression(w,N),w.type==="literal")if(w.value===null||typeof w.value=="string")c.push(w.value===null?"":w.value);else throw new b(`Table-valued function arguments must be string literals (or NULL) for ${a}.`,I.ERROR,void 0,w.loc?.start.line,w.loc?.start.column);else throw w.type==="parameter"?new b(`Parameters not supported as arguments to table-valued functions like ${a} yet.`,I.ERROR,void 0,w.loc?.start.line,w.loc?.start.column):new b(`Only literals supported as arguments to table-valued functions like ${a} yet.`,I.ERROR,void 0,w.loc?.start.line,w.loc?.start.column)}let u="main",d=s.alias||a,l=a,h={};try{if(l.toLowerCase()==="json_each"||l.toLowerCase()==="json_tree"){if(c.length<1||c.length>2)throw new Error(`${l} requires 1 or 2 arguments (jsonSource, [rootPath])`);h={jsonSource:c[0],rootPath:c[1]}}else console.warn(`Compiler creating generic BaseModuleConfig for TVF module '${l}'. Module may need specific argument parsing.`),h={}}catch(w){throw new b(`Failed to parse arguments for TVF module '${l}': ${w.message}`,I.ERROR,w instanceof Error?w:void 0,s.name.loc?.start.line,s.name.loc?.start.column)}let p=i.module.xConnect(e.db,i.auxData,l,u,d,h);if(!p||!p.tableSchema)throw new b(`Module ${a} xConnect did not return a valid table instance or schema.`,I.INTERNAL);let g=e.allocateCursor();n.push(g),e.tableSchemas.set(g,p.tableSchema);let E=(s.alias||a).toLowerCase();if(e.tableAliases.has(E)||o.has(E))throw new b(`Duplicate table name or alias: ${E}`,I.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);e.tableAliases.set(E,g),o.set(E,g);let y={type:"vtab",tableSchema:p.tableSchema};e.emit(f.OpenRead,g,0,0,y,0,`Open TVF ${E}`)}else throw new b(`Unsupported FROM clause type during cursor opening: ${s.type}`,I.INTERNAL)};for(let s of t)r(s,new Map);return n}function Do(e,t,n){let r=new Map;if(!t)return r;let s=o=>{if(o.type==="column"){let a=o,i=-1;if(a.table)i=e.tableAliases.get(a.table.toLowerCase())??-1;else{let c=!1;for(let u of n)e.tableSchemas.get(u)?.columnIndexMap.has(a.name.toLowerCase())&&(i!==-1&&(c=!0),i=u);if(c)throw new b(`Ambiguous column reference in usage analysis: ${a.name}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}if(n.has(i)){let c=e.tableSchemas.get(i),u=c?.columnIndexMap.get(a.name.toLowerCase());u!==void 0?(r.has(i)||r.set(i,new Set),r.get(i).add(u)):a.name.toLowerCase()==="rowid"&&!c?.isVirtual&&(r.has(i)||r.set(i,new Set),r.get(i).add(-1))}}else o.type==="binary"?(s(o.left),s(o.right)):o.type==="unary"?s(o.expr):o.type==="function"?o.args.forEach(s):o.type==="cast"?s(o.expr):o.type==="subquery"?console.warn("Subquery column usage analysis not implemented for colUsed mask."):o.type==="collate"?s(o.expr):o.type==="identifier"&&s({type:"column",name:o.name,loc:o.loc})};return s(t),r}function Jh(e,t,n,r,s){let o=BigInt(0),a=new Set(e.tableAliases.values()),i=e.tableSchemas.get(t);if(!i)return o;let c=u=>{u>=0&&u<63?o|=BigInt(1)<<BigInt(u):u===-1&&(o|=BigInt(1)<<BigInt(63))};return n.forEach(u=>{if(u.type==="all"){let d=!1;if(!u.table)d=!0;else{let l=u.table.toLowerCase();e.tableAliases.get(l)===t&&(d=!0)}d&&(i.columns.forEach((l,h)=>{l.hidden||c(h)}),i.isVirtual||c(-1))}else u.expr&&Do(e,u.expr,a).get(t)?.forEach(c)}),r&&Do(e,r,a).get(t)?.forEach(c),s&&s.forEach(u=>{Do(e,u.expr,a).get(t)?.forEach(c)}),i.primaryKeyDefinition?.forEach(u=>{u.index>=0&&u.index<i.columns.length&&c(u.index)}),o}function Qh(e,t,n,r,s){let o=[],a=new Map,i=new Set,c=d=>{if(d.type==="literal"||d.type==="parameter")return!0;if(d.type==="column"){let l=d,h=-1;if(l.table)h=e.tableAliases.get(l.table.toLowerCase())??-1;else{let p=!1,g=!1,E=!1;n.columnIndexMap.has(l.name.toLowerCase())&&(p=!0,h=t);for(let y of e.tableAliases.values()){if(y===t)continue;e.tableSchemas.get(y)?.columnIndexMap.has(l.name.toLowerCase())&&((p||g)&&(E=!0),h=y,g=!0)}if(E)throw new b(`Ambiguous column in constraint analysis: ${l.name}`,I.ERROR,void 0,d.loc?.start.line,d.loc?.start.column)}return h!==-1&&h!==t}return d.type==="binary"?c(d.left)&&c(d.right):d.type==="unary"?c(d.expr):d.type==="function"?d.args.every(c):d.type==="subquery"?!1:d.type==="cast"||d.type==="collate"?c(d.expr):!1},u=d=>{if(d&&!i.has(d)){if(d.type==="unary"&&(d.operator.toUpperCase()==="IS NULL"||d.operator.toUpperCase()==="IS NOT NULL")){if(d.expr.type==="column"){let l=d.expr,h=l.name.toLowerCase(),p=-1;if(l.table?p=e.tableAliases.get(l.table.toLowerCase())??-1:n.columnIndexMap.has(h)&&(p=t),p===t){let g=n.columnIndexMap.get(h);if(g!==void 0){let E=d.operator.toUpperCase()==="IS NULL"?F.ISNULL:F.ISNOTNULL,y=o.length;o.push({iColumn:g,op:E,usable:!0}),a.set(y,d),i.add(d)}}}return}if(d.type==="binary"){let l=d;if(l.operator.toUpperCase()==="AND"){u(l.left),u(l.right);return}if(l.operator.toUpperCase()==="OR"){console.debug("Skipping OR constraint for xBestIndex planning.");return}if(l.operator.toUpperCase()==="BETWEEN"){if(l.left.type==="column"&&l.right.type==="binary"&&l.right.operator.toUpperCase()==="AND"){let w=l.left,N=l.right.left,C=l.right.right,S={type:"binary",operator:">=",left:w,right:N,loc:l.loc},R={type:"binary",operator:"<=",left:w,right:C,loc:l.loc};u(S),u(R)}else console.warn("Unsupported BETWEEN structure for planning.");return}if(l.operator.toUpperCase()==="IN"){if(l.left.type==="column"&&l.right.type==="function"&&l.right.name==="_list_"){let w=l.left,N=l.right.args,C=-1,S=w.name.toLowerCase();if(w.table?C=e.tableAliases.get(w.table.toLowerCase())??-1:n.columnIndexMap.has(S)&&(C=t),C===t&&N.every(c)){let R=n.columnIndexMap.get(S);R!==void 0&&(N.forEach(L=>{let T=o.length;o.push({iColumn:R,op:F.EQ,usable:!0}),a.set(T,L)}),i.add(l))}}else l.right.type==="subquery"&&console.warn("IN (subquery) constraint skipped for xBestIndex planning.");return}let h,p,g,E=!1,y=-1;if(l.left.type==="column"?(h=l.left,p=l.right,g=es(l.operator),h.table?y=e.tableAliases.get(h.table.toLowerCase())??-1:n.columnIndexMap.has(h.name.toLowerCase())&&(y=t)):l.right.type==="column"&&(h=l.right,p=l.left,E=!0,g=es(l.operator,!0),h.table?y=e.tableAliases.get(h.table.toLowerCase())??-1:n.columnIndexMap.has(h.name.toLowerCase())&&(y=t)),h&&g&&p&&y===t)if(c(p)){let w=n.columnIndexMap.get(h.name.toLowerCase());if(w!==void 0){let N=o.length;o.push({iColumn:w,op:g,usable:!0}),a.set(N,p),i.add(l)}}else console.debug(`Skipping constraint for xBestIndex (value references target table): ${h.name} ${l.operator} ...`);else if(l.left.type==="column"&&l.right.type==="column"){let w=l.left,N=l.right,C=e.tableAliases.get(w.table?.toLowerCase()??"")??(n.columnIndexMap.has(w.name.toLowerCase())?t:-1),S=e.tableAliases.get(N.table?.toLowerCase()??"")??(n.columnIndexMap.has(N.name.toLowerCase())?t:-1),R,L,T;if(C===t&&S!==-1&&S!==t?(R=w,L=N,T=es(l.operator,!1)):S===t&&C!==-1&&C!==t&&(R=N,L=w,T=es(l.operator,!0)),R&&L&&T){let O=n.columnIndexMap.get(R.name.toLowerCase());if(O!==void 0){let x=o.length;o.push({iColumn:O,op:T,usable:!0}),a.set(x,L),i.add(l)}}}}}};return u(r),{constraints:o,constraintExpressions:a,handledNodes:i}}function ql(e,t,n,r,s){if(!n.isVirtual||!n.vtabModule?.xBestIndex||!n.vtabInstance){e.cursorPlanningInfo.set(t,{idxNum:0,idxStr:null,usage:[],cost:1e10,rows:BigInt(1e6),orderByConsumed:!1,constraints:[],constraintExpressions:new Map,handledWhereNodes:new Set});return}let o=r.type==="select"||r.type==="update"||r.type==="delete"?r.where:void 0,a=r.type==="select"?r.orderBy:void 0,i=r.type==="select"?r.columns:[],{constraints:c,constraintExpressions:u,handledNodes:d}=Qh(e,t,n,o,s),l=[];a&&a.forEach(y=>{if(y.expr.type==="column"){let w=y.expr,N=w.name.toLowerCase(),C=-1;if(w.table)C=e.tableAliases.get(w.table.toLowerCase())??-1;else if(n.columnIndexMap.has(N)){C=t;for(let S of s)if(e.tableSchemas.get(S)?.columnIndexMap.has(N)){C=-1;break}}else for(let S of s)if(e.tableSchemas.get(S)?.columnIndexMap.has(N)){C=S;break}if(C===t){let S=n.columnIndexMap.get(N);S!==void 0?l.push({iColumn:S,desc:y.direction==="desc"}):N==="rowid"&&l.push({iColumn:-1,desc:y.direction==="desc"})}}else console.warn("Skipping non-column ORDER BY term for xBestIndex planning")});let h=Jh(e,t,i,o,a),p={nConstraint:c.length,aConstraint:Object.freeze([...c]),nOrderBy:l.length,aOrderBy:Object.freeze([...l]),colUsed:h,aConstraintUsage:Array.from({length:c.length},()=>({argvIndex:0,omit:!1})),idxNum:0,idxStr:null,orderByConsumed:!1,estimatedCost:1e10,estimatedRows:BigInt(1e6),idxFlags:0},g;try{g=n.vtabModule.xBestIndex(n.vtabInstance,p)}catch(y){console.error(`Error calling xBestIndex for ${n.name}:`,y),g=I.ERROR}if(g!==I.OK)throw new b(`xBestIndex failed for table ${n.name} with code ${g}`,g,void 0,r.loc?.start.line,r.loc?.start.column);let E={idxNum:p.idxNum,idxStr:p.idxStr,usage:p.aConstraintUsage,cost:p.estimatedCost,rows:p.estimatedRows,orderByConsumed:p.orderByConsumed,constraints:[...p.aConstraint],constraintExpressions:u,handledWhereNodes:d};e.cursorPlanningInfo.set(t,E),console.log(`Planning for ${n.name} (cursor ${t}, outer: ${[...s]}): idxNum=${E.idxNum}, cost=${E.cost}, rows=${E.rows}, usage=`,E.usage,`handledNodes=${E.handledWhereNodes.size}`,`colUsed=${h.toString(2)}`)}function es(e,t=!1){switch(e.toUpperCase()){case"=":case"==":return F.EQ;case"<":return t?F.GT:F.LT;case"<=":return t?F.GE:F.LE;case">":return t?F.LT:F.GT;case">=":return t?F.LE:F.GE;case"!=":case"<>":return F.NE;case"IS":return F.IS;case"IS NOT":return F.ISNOT;case"LIKE":return F.LIKE;case"GLOB":return F.GLOB;case"REGEXP":return F.REGEXP;case"MATCH":return F.MATCH;default:return}}function Gl(e,t,n){let r=e.cursorPlanningInfo.get(t);if(!r||r.constraints.length===0||r.usage.every(a=>a.argvIndex===0))return;let s=e.allocateMemoryCells(1),o=e.tableSchemas.get(t);if(!o)throw new Error(`Internal: Schema missing for cursor ${t} during verification`);for(let a=0;a<r.constraints.length;a++){let i=r.constraints[a],c=r.usage[a];if(c.argvIndex>0&&!c.omit){let u=r.constraintExpressions.get(a),d=null,l=u?.loc;if(i.iColumn===-1){console.warn(`Verification of rowid constraint (constraint ${a}) not implemented.`);continue}let h=o.columns[i.iColumn]?.name;if(!h){console.error(`Cannot find column name for index ${i.iColumn} in table ${o.name} during verification.`);continue}let p={type:"column",name:h};if(i.op===F.ISNULL||i.op===F.ISNOTNULL)if(u?.type==="unary")d={...u,expr:p},l=u.loc;else{console.warn(`Cannot reconstruct IS NULL/IS NOT NULL verification expression for constraint ${a}.`);continue}else{if(!u){console.warn(`Could not find original value expression for constraint verification (cursor ${t}, constraint ${a}, op ${i.op})`);continue}let E={[F.EQ]:{op:"="},[F.LT]:{op:"<"},[F.LE]:{op:"<="},[F.GT]:{op:">"},[F.GE]:{op:">="},[F.NE]:{op:"!="},[F.IS]:{op:"IS"},[F.ISNOT]:{op:"IS NOT"},[F.LIKE]:{op:"LIKE"},[F.GLOB]:{op:"GLOB"},[F.REGEXP]:{op:"REGEXP"},[F.MATCH]:{op:"MATCH"}}[i.op];if(!E){console.warn(`Cannot map constraint op ${i.op} back to AST operator for verification.`);continue}d={type:"binary",operator:E.op,left:p,right:u,loc:l}}if(d){e.compileExpression(d,s);let g=d.type==="unary"||d.type==="binary"?d.operator:`op${i.op}`;e.emit(f.IfFalse,s,n,0,null,0,`Verify constraint ${a} (${g})`)}}}}function rn(e,t,n,r){if(!t)return;let s=new Set;n.forEach(a=>{e.cursorPlanningInfo.get(a)?.handledWhereNodes.forEach(i=>{s.add(i)})});let o=a=>{if(!s.has(a))if(a.type==="binary")if(a.operator.toUpperCase()==="AND")o(a.left),o(a.right);else if(a.operator.toUpperCase()==="OR"){let i=e.allocateMemoryCells(1),c=e.allocateAddress();e.compileExpression(a.left,i),e.emit(f.IfTrue,i,c,0,null,0,"OR: check left"),e.compileExpression(a.right,i),e.emit(f.IfFalse,i,r,0,null,0,"OR: check right, jump if false"),e.resolveAddress(c)}else{let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(f.IfFalse,i,r,0,null,0,`Check unhandled: ${a.operator}`)}else if(a.type==="unary"){let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(f.IfFalse,i,r,0,null,0,`Check unhandled: ${a.operator}`)}else{let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(f.IfFalse,i,r,0,null,0,`Check unhandled: ${a.type}`)}};o(t)}function Et(e,t,n){let r={isCorrelated:!1,correlatedColumns:[]},s=new Set,o=(a,i)=>{if(a){if(a.type==="select"){let c=a,u=new Map,d=new Set;c.from?.forEach(h=>{let p=g=>{if(g.type==="table"){let E=(g.alias||g.table.name).toLowerCase(),y=e.tableAliases.get(E);y!==void 0?(u.set(E,y),d.add(y)):console.warn(`Alias/Table ${E} not found in global map during correlation analysis. Scope issue?`)}else if(g.type==="join")p(g.left),p(g.right);else if(g.type==="functionSource"){let E=(g.alias||g.name.name).toLowerCase(),y=e.tableAliases.get(E);y!==void 0?(u.set(E,y),d.add(y)):console.warn(`Alias/TVF ${E} not found in global map during correlation analysis. Scope issue?`)}};p(h)});let l=new Set([...i,...d]);c.columns.forEach(h=>{h.type==="column"&&h.expr&&o(h.expr,l)}),o(c.where,l),c.groupBy?.forEach(h=>o(h,l)),o(c.having,l);return}if(a.type==="column"||a.type==="identifier"){let c,u;a.type==="column"?(c=a.name,u=a.table):(c=a.name,u=void 0);let d=-1,l=!1;if(u){let h=u.toLowerCase(),p=e.tableAliases.get(h);p!==void 0&&i.has(p)&&(d=p,l=!0)}else{let h=-1,p=!1;for(let g of i)e.tableSchemas.get(g)?.columnIndexMap.has(c.toLowerCase())&&(h!==-1&&(p=!0),h=g);if(p)throw new b(`Ambiguous column in subquery correlation check: ${c}`,I.ERROR,void 0,a.loc?.start.line,a.loc?.start.column);h!==-1&&(d=h,l=!0)}if(l&&n.has(d)){let h=d,g=e.tableSchemas.get(h)?.columnIndexMap.get(c.toLowerCase())??-1;if(g!==-1){r.isCorrelated=!0;let E=`${h}.${g}`;s.has(E)||(r.correlatedColumns.push({outerCursor:h,outerColumnIndex:g}),s.add(E))}else console.warn(`Outer column ${c} resolved to cursor ${h} but index not found in schema.`)}}else a.type==="binary"?(o(a.left,i),o(a.right,i)):a.type==="unary"?o(a.expr,i):a.type==="function"?a.args.forEach(c=>o(c,i)):a.type==="cast"?o(a.expr,i):a.type==="subquery"?o(a.query,i):a.type==="collate"&&o(a.expr,i)}};return o(t,n),r}function ur(e,t){return`${e.toLowerCase()}/${t}`}function cr(e){if(!e)return A.BLOB;let t=e.toUpperCase();return t.includes("INT")?A.INTEGER:t.includes("TEXT")||t.includes("CHAR")||t.includes("CLOB")?A.TEXT:t.includes("BLOB")?A.BLOB:t.includes("REAL")||t.includes("FLOA")||t.includes("DOUB")?A.REAL:A.NUMERIC}var An=class{name;tables=new Map;functions=new Map;views=new Map;constructor(t){this.name=t}addTable(t){if(t.schemaName!==this.name)throw new Error(`Table ${t.name} has wrong schema name ${t.schemaName}, expected ${this.name}`);if(this.views.has(t.name.toLowerCase()))throw new b(`Schema '${this.name}': Cannot add table '${t.name}', a view with the same name already exists.`);this.tables.set(t.name.toLowerCase(),t),console.log(`Schema '${this.name}': Added/Updated table '${t.name}'`)}getTable(t){return this.tables.get(t.toLowerCase())}getAllTables(){return this.tables.values()}removeTable(t){let n=t.toLowerCase(),r=this.tables.has(n);return r&&(console.log(`Schema '${this.name}': Removed table '${t}'`),this.tables.delete(n)),r}clearTables(){this.tables.clear()}addView(t){if(t.schemaName!==this.name)throw new Error(`View ${t.name} has wrong schema name ${t.schemaName}, expected ${this.name}`);if(this.tables.has(t.name.toLowerCase()))throw new b(`Schema '${this.name}': Cannot add view '${t.name}', a table with the same name already exists.`);this.views.set(t.name.toLowerCase(),t),console.log(`Schema '${this.name}': Added/Updated view '${t.name}'`)}getView(t){return this.views.get(t.toLowerCase())}getAllViews(){return this.views.values()}removeView(t){let n=t.toLowerCase(),r=this.views.has(n);return r&&(console.log(`Schema '${this.name}': Removed view '${t}'`),this.views.delete(n)),r}clearViews(){this.views.clear()}addFunction(t){let n=ur(t.name,t.numArgs),r=this.functions.get(n);if(r?.xDestroy&&r.userData!==t.userData)try{r.xDestroy(r.userData)}catch(s){console.error(`Destructor failed for function ${n}`,s)}this.functions.set(n,t),console.log(`Schema '${this.name}': Added/Updated function '${t.name}/${t.numArgs}'`)}getFunction(t,n){let r=ur(t,n),s=ur(t,-1);return this.functions.get(r)??this.functions.get(s)}_getAllFunctions(){return this.functions.values()}removeFunction(t,n){let r=ur(t,n),s=this.functions.get(r);if(s){if(s.xDestroy&&s.userData)try{s.xDestroy(s.userData)}catch(o){console.error(`Destructor failed for function ${r}`,o)}return console.log(`Schema '${this.name}': Removed function '${t}/${n}'`),this.functions.delete(r)}return!1}clearFunctions(){this.functions.forEach(t=>{if(t.xDestroy&&t.userData)try{t.xDestroy(t.userData)}catch(n){console.error(`Destructor failed for function ${t.name}/${t.numArgs}`,n)}}),this.functions.clear()}};function sn(e,t,n){switch(t.type){case"literal":let r=t.value;return r===null?A.NULL:typeof r=="number"?A.REAL:typeof r=="bigint"?A.INTEGER:typeof r=="string"?A.TEXT:r instanceof Uint8Array?A.BLOB:A.BLOB;case"column":return jl(e,t,n)?.column?.affinity??A.BLOB;case"cast":return cr(t.targetType);case"function":return e.db._findFunction(t.name,t.args.length)?.affinity??A.BLOB;case"parameter":return A.BLOB;case"unary":switch(t.operator.toUpperCase()){case"-":case"+":return A.NUMERIC;case"~":return A.INTEGER;case"NOT":return A.INTEGER;default:return A.BLOB}case"binary":switch(t.operator.toUpperCase()){case"+":case"-":case"*":case"/":case"%":case"&":case"|":case"<<":case">>":return A.NUMERIC;case"||":return A.TEXT;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":case"IN":case"LIKE":case"GLOB":case"BETWEEN":return A.INTEGER;case"AND":case"OR":let o=sn(e,t.left,n),a=sn(e,t.right,n);return o===A.TEXT||a===A.TEXT?A.TEXT:o===A.BLOB||a===A.BLOB?A.BLOB:A.NUMERIC;default:return A.BLOB}case"subquery":return A.BLOB;case"identifier":return sn(e,{type:"column",name:t.name},n);case"collate":return sn(e,t.expr,n);default:return A.BLOB}}function jl(e,t,n){let r=-1;if(t.table)r=e.tableAliases.get(t.table.toLowerCase())??-1;else for(let[i,c]of e.tableAliases.entries())if(e.tableSchemas.get(c)?.columnIndexMap.has(t.name.toLowerCase())){if(r!==-1)return null;r=c}if(r===-1)return null;let s=e.tableSchemas.get(r);if(!s)return null;let o=s.columnIndexMap.get(t.name.toLowerCase());if(o===void 0)return t.name.toLowerCase()==="rowid"&&s.primaryKeyDefinition?.length===0&&!s.isVirtual,null;let a=s.columns[o];return{table:s,column:a}}function Dt(e,t,n){switch(t.type){case"literal":return"BINARY";case"column":return jl(e,t,n)?.column.collation||"BINARY";case"collate":return t.collation.toUpperCase();case"cast":return Dt(e,t.expr,n);case"function":return"BINARY";case"parameter":return"BINARY";case"unary":return Dt(e,t.expr,n);case"binary":switch(t.operator.toUpperCase()){case"||":case"+":case"-":case"*":case"/":case"%":case"&":case"|":case"<<":case">>":return"BINARY";case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":case"LIKE":case"GLOB":case"BETWEEN":case"IN":{let s=Dt(e,t.left,n),o=Dt(e,t.right,n);return s!=="BINARY"&&o==="BINARY"?s:o!=="BINARY"&&s==="BINARY"?o:"BINARY"}case"AND":case"OR":return"BINARY";default:return"BINARY"}case"subquery":return"BINARY";case"identifier":return Dt(e,{type:"column",name:t.name},n);default:return"BINARY"}}function on(e,t,n){if(t===null)e.emit(f.Null,0,n,0,null,0,"Load NULL literal");else if(typeof t=="number")if(Number.isSafeInteger(t))e.emit(f.Integer,t,n,0,null,0,`Load Integer literal: ${t}`);else if(Number.isInteger(t)){let r=e.addConstant(BigInt(t));e.emit(f.Int64,0,n,0,r,0,`Load Large Integer literal: ${t}`)}else{let r=e.addConstant(t);e.emit(f.Real,0,n,0,r,0,`Load Float literal: ${t}`)}else if(typeof t=="string"){let r=e.addConstant(t);e.emit(f.String8,0,n,0,r,0,"Load String literal")}else if(t instanceof Uint8Array){let r=e.addConstant(t);e.emit(f.Blob,t.length,n,0,r,0,"Load BLOB literal")}else if(typeof t=="bigint"){let r=e.addConstant(t);e.emit(f.Int64,0,n,0,r,0,`Load BigInt literal: ${t}`)}else if(typeof t=="boolean")e.emit(f.Integer,t?1:0,n,0,null,0,`Load Boolean literal: ${t}`);else throw new Error(`Unsupported literal type for VDBE emission: ${typeof t}`)}function fr(e,t,n,r,s,o){if(o){let u=-99,d=-1,l;if(t.table){let h=t.table.toLowerCase(),p=e.tableAliases.get(h);p!==void 0&&(d=p,l=e.tableSchemas.get(d),l&&(u=l.columnIndexMap.get(t.name.toLowerCase())??-99,u===-99&&t.name.toLowerCase()==="rowid"&&(u=-1)))}else{let h=0;for(let[p,g]of e.tableAliases.entries()){let E=e.tableSchemas.get(g);if(E){let y=E.columnIndexMap.get(t.name.toLowerCase());if(y!==void 0){if(h>0){d=-2;break}d=g,u=y,l=E,h++}else if(t.name.toLowerCase()==="rowid"){if(h>0){d=-2;break}d=g,u=-1,l=E,h++}}}d===-2&&(u=-99)}if(u!==-99&&d>=0){let h=`${u}`,p=o.get(h);if(p!==void 0){e.emit(f.SCopy,p,n,0,null,0,`CHECK/SET: Use new val ${t.name} from reg ${p}`);return}}}if(e.subroutineDepth>0&&o){let u=r?.correlatedColumns.find(d=>{let l=e.tableSchemas.get(d.outerCursor),h=l?.columns[d.outerColumnIndex]?.name.toLowerCase();if(!h)return!1;if(t.table){let p=[...e.tableAliases.entries()].find(([y,w])=>w===d.outerCursor)?.[0],g=l?.name.toLowerCase(),E=t.table.toLowerCase();if(p?.toLowerCase()===E||g===E)return h===t.name.toLowerCase()}else return h===t.name.toLowerCase();return!1});if(u){let d=`${u.outerCursor}.${u.outerColumnIndex}`,l=o.get(d);if(l!==void 0){e.emit(f.SCopy,l,n,0,null,0,`Sub: Use outer arg ${t.name} from FP[${l}]`);return}else throw new b(`Internal error: Correlated column ${t.name} not found in argument map.`,I.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column)}}if(s){let u=t.name.toLowerCase(),d=s.finalColumnMap.find(l=>l.expr?.alias?.toLowerCase()===u||l.expr?.type==="column"&&!l.expr?.alias&&l.expr.name.toLowerCase()===u);if(d){e.emit(f.SCopy,d.targetReg,n,0,null,0,`HAVING: Use grouped/aggregated col '${t.name}' from reg ${d.targetReg}`);return}throw new b(`Column "${t.name}" must appear in the GROUP BY clause or be used in an aggregate function`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}let a=-1,i=-1,c;if(t.table){let u=t.table.toLowerCase(),d=e.tableAliases.get(u);if(d===void 0)throw new b(`Table or alias not found: ${t.table}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);if(a=d,c=e.tableSchemas.get(a),!c)throw new b(`Internal error: Schema not found for cursor ${a}`,I.INTERNAL);let l=c.columnIndexMap.get(t.name.toLowerCase());if(l===void 0)if(t.name.toLowerCase()==="rowid"&&c.isVirtual)i=-1;else throw new b(`Column not found in table ${t.table}: ${t.name}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);else i=l}else{let u=0,d=-1,l=-1,h;for(let[p,g]of e.tableAliases.entries()){let E=e.tableSchemas.get(g);if(E){let y=E.columnIndexMap.get(t.name.toLowerCase());if(y!==void 0){if(d!==-1)throw new b(`Ambiguous column name: ${t.name}. Qualify with table name or alias.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);d=g,l=y,h=E,u++}else if(t.name.toLowerCase()==="rowid"&&E.isVirtual){if(d!==-1)throw new b(`Ambiguous column name: ${t.name} (rowid). Qualify with table name or alias.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);d=g,l=-1,h=E,u++}}}if(d===-1)throw new b(`Column not found: ${t.name}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);a=d,i=l,c=h}if(!c)throw new Error("Internal: Schema resolution failed");if(c.isVirtual)e.emit(f.VColumn,a,i,n,0,0,`Get column: ${c.name}.${t.name} (idx ${i})`);else throw new b("Regular tables not implemented",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}function ts(e,t,n,r,s,o){if(t.right.type==="subquery"&&["=","==","!=","<>","<","<=",">",">=","IN"].includes(t.operator.toUpperCase())){let d=t.right.query;switch(t.operator.toUpperCase()){case"IN":e.compileInSubquery(t.left,d,n,!1);return;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":e.compileComparisonSubquery(t.left,t.operator,d,n);return;default:throw new b(`Operator '${t.operator}' cannot be used with a subquery on the right side.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}if(t.left.type==="subquery"&&["=","==","!=","<>","<","<=",">",">="].includes(t.operator.toUpperCase())){let d=t.left.query;switch(t.operator.toUpperCase()){case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":e.compileComparisonSubquery(t.left,t.operator,d,n);return;default:throw new b(`Operator '${t.operator}' cannot be used with a subquery on the left side.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}let a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1);e.compileExpression(t.left,a,r,s,o),e.compileExpression(t.right,i,r,s,o);let c,u=["=","==","!=","<>","<","<=",">",">=","IS","IS NOT","LIKE","GLOB"].includes(t.operator.toUpperCase());if(u)if(t.left.type==="collate")c=t.left.collation.toUpperCase();else if(t.right.type==="collate")c=t.right.collation.toUpperCase();else{let d=Dt(e,t.left,r),l=Dt(e,t.right,r);d!=="BINARY"&&l==="BINARY"?c=d:l!=="BINARY"&&d==="BINARY"?c=l:d!=="BINARY"&&l!=="BINARY"&&d!==l?c="BINARY":c=d}switch(t.operator.toUpperCase()){case"+":e.emit(f.Add,a,i,n,null,0,"Add");break;case"-":e.emit(f.Subtract,a,i,n,null,0,"Subtract");break;case"*":e.emit(f.Multiply,a,i,n,null,0,"Multiply");break;case"/":e.emit(f.Divide,a,i,n,null,0,"Divide");break;case"%":e.emit(f.Remainder,a,i,n,null,0,"Remainder");break;case"||":e.emit(f.Concat,a,i,n,null,0,"Concat");break;case"&":e.emit(f.BitAnd,a,i,n,null,0,"BitAnd");break;case"|":e.emit(f.BitOr,a,i,n,null,0,"BitOr");break;case"<<":e.emit(f.ShiftLeft,i,a,n,null,0,"ShiftLeft");break;case">>":e.emit(f.ShiftRight,i,a,n,null,0,"ShiftRight");break;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":{let d,l=!0,h=null;switch(u&&c&&c!=="BINARY"&&(h={type:"coll",name:c}),t.operator.toUpperCase()){case"=":case"==":d=f.Eq,l=!0;break;case"IS":d=f.Eq,l=!1;break;case"!=":case"<>":d=f.Ne,l=!0;break;case"IS NOT":d=f.Ne,l=!1;break;case"<":d=f.Lt,l=!0;break;case"<=":d=f.Le,l=!0;break;case">":d=f.Gt,l=!0;break;case">=":d=f.Ge,l=!0;break;default:throw new Error("Impossible operator")}let p=sn(e,t.left,r),g=sn(e,t.right,r),E=[A.INTEGER,A.REAL,A.NUMERIC].includes(p),y=[A.INTEGER,A.REAL,A.NUMERIC].includes(g),w=[A.TEXT,A.BLOB].includes(p),N=[A.TEXT,A.BLOB].includes(g);E&&N?e.emit(f.Affinity,i,1,0,"NUMERIC",0,"Apply NUMERIC affinity to RHS"):y&&w&&e.emit(f.Affinity,a,1,0,"NUMERIC",0,"Apply NUMERIC affinity to LHS");let C=e.allocateAddress(),S=e.allocateAddress(),R=e.allocateAddress();l&&(e.emit(f.IfNull,a,S,0,null,0,"Compare: If left NULL"),e.emit(f.IfNull,i,S,0,null,0,"Compare: If right NULL")),e.emit(d,a,C,i,h,0,`Compare ${t.operator}${h?` (${h.name})`:""}`),e.emit(f.Integer,0,n,0,null,0,"Load 0 (false result)"),e.emit(f.Goto,0,R,0,null,0),e.resolveAddress(C),e.emit(f.Integer,1,n,0,null,0,"Load 1 (true result)"),e.emit(f.Goto,0,R,0,null,0),l&&(e.resolveAddress(S),e.emit(f.Null,0,n,0,null,0,"Null comparison result")),e.resolveAddress(R);break}case"LIKE":case"GLOB":throw new b(`Operator ${t.operator} not fully implemented yet with collation support.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);case"AND":{let d=e.allocateAddress(),l=e.allocateAddress();e.emit(f.SCopy,a,n,0,null,0,"AND: Copy left initially"),e.emit(f.IfTrue,a,d,0,null,0,"AND: If left is true, evaluate right"),e.emit(f.Goto,0,l,0,null,0,"AND: Left is false/null, finish"),e.resolveAddress(d),e.emit(f.SCopy,i,n,0,null,0,"AND: Copy right as result"),e.resolveAddress(l);break}case"OR":{let d=e.allocateAddress(),l=e.allocateAddress();e.emit(f.SCopy,a,n,0,null,0,"OR: Copy left initially"),e.emit(f.IfTrue,a,l,0,null,0,"OR: If left is true, finish"),e.resolveAddress(d),e.emit(f.SCopy,i,n,0,null,0,"OR: Copy right as result"),e.resolveAddress(l);break}default:throw new b(`Unsupported binary operator: ${t.operator}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function ns(e,t,n,r,s,o){if(t.operator.toUpperCase()==="NOT"&&t.expr.type==="binary"&&t.expr.operator.toUpperCase()==="IN"&&t.expr.right.type==="subquery"){e.compileInSubquery(t.expr.left,t.expr.right.query,n,!0);return}if(t.operator.toUpperCase()==="NOT"&&t.expr.type==="subquery"){e.compileExistsSubquery(t.expr.query,n);let i=e.allocateAddress(),c=e.allocateAddress();e.emit(f.IfNull,n,c,0,null,0,"NOT EXISTS: Skip if NULL"),e.emit(f.Not,n,n,0,null,0,"NOT EXISTS: Invert boolean"),e.resolveAddress(c);return}if(t.operator.toUpperCase()==="EXISTS"&&t.expr.type==="subquery"){e.compileExistsSubquery(t.expr.query,n);return}if(t.operator.toUpperCase()==="IS NULL"){let i=e.allocateMemoryCells(1);e.compileExpression(t.expr,i,r,s,o),e.emit(f.IsNull,i,n,0,null,0,"Check IS NULL");return}if(t.operator.toUpperCase()==="IS NOT NULL"){let i=e.allocateMemoryCells(1);e.compileExpression(t.expr,i,r,s,o),e.emit(f.NotNull,i,n,0,null,0,"Check IS NOT NULL");return}let a=e.allocateMemoryCells(1);switch(e.compileExpression(t.expr,a,r,s,o),t.operator.toUpperCase()){case"-":e.emit(f.Negative,a,n,0,null,0,"Unary Minus");break;case"+":e.emit(f.SCopy,a,n,0,null,0,"Unary Plus (no-op)");break;case"~":e.emit(f.BitNot,a,n,0,null,0,"Bitwise NOT");break;case"NOT":let i=e.allocateAddress(),c=e.allocateAddress(),u=e.allocateAddress();e.emit(f.IfNull,a,i,0,null,0,"NOT: Check if operand is NULL"),e.emit(f.IfZero,a,c,0,null,0,"NOT: Check if operand is 0 (false)"),e.emit(f.Integer,0,n,0,null,0,"NOT: Set result 0 (operand was true)"),e.emit(f.Goto,0,u,0,null,0),e.resolveAddress(c),e.emit(f.Integer,1,n,0,null,0,"NOT: Set result 1 (operand was false)"),e.emit(f.Goto,0,u,0,null,0),e.resolveAddress(i),e.emit(f.Null,0,n,0,null,0,"NOT: Set result NULL (operand was NULL)"),e.resolveAddress(u);break;default:throw new b(`Unsupported unary operator: ${t.operator}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function rs(e,t,n,r,s,o){e.compileExpression(t.expr,n,r,s,o);let a=t.targetType.toUpperCase(),i=cr(a),c;switch(i){case A.INTEGER:c="INTEGER";break;case A.REAL:c="REAL";break;case A.TEXT:c="TEXT";break;case A.BLOB:c="BLOB";break;case A.NUMERIC:c="NUMERIC";break;default:c="BLOB"}e.emit(f.Affinity,n,1,0,c,0,`CAST to ${a}`)}function ss(e,t,n,r,s,o){if(s){let u=s.finalColumnMap.find(d=>d.expr?.type==="function"&&d.expr.name.toLowerCase()===t.name.toLowerCase()&&JSON.stringify(d.expr.args)===JSON.stringify(t.args));if(u){e.emit(f.SCopy,u.targetReg,n,0,null,0,`HAVING: Use aggregated func '${t.name}' from reg ${u.targetReg}`);return}}let a=e.allocateMemoryCells(t.args.length||1);for(let u=0;u<t.args.length;u++)e.compileExpression(t.args[u],a+u,r,s,o);let i=e.db._findFunction(t.name,t.args.length);if(!i)throw new b(`Function not found: ${t.name}/${t.args.length}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let c=!!(i.xStep&&i.xFinal);if(c&&!s)e.emit(f.Null,0,n,0,null,0,`Aggregate func ${t.name} in scalar context -> NULL`);else if(i.xFunc){let u={type:"funcdef",funcDef:i,nArgs:t.args.length};e.emit(f.Function,a,t.args.length,n,u,0,`Call func: ${t.name}`)}else throw c&&s&&!i.xFunc?new b(`Aggregate function ${i.name} used incorrectly in HAVING clause.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column):c&&!s?new b(`Aggregate function ${i.name} used in a scalar context`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column):new b(`Invalid function call context for ${i.name}`,I.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column)}function os(e,t,n){let r=t.name||t.index;e.parameters.set(r,{memIdx:n}),e.emit(f.Null,0,n,0,null,0,`Parameter placeholder: ${r} -> R[${n}]`)}function as(e,t,n,r,s,o){e.compileExpression(t.expr,n,r,s,o)}function Yl(e,t,n,r,s,o){switch(t.type){case"literal":on(e,t.value,n);break;case"identifier":fr(e,{type:"column",name:t.name,alias:t.name},n,r,s,o);break;case"column":fr(e,t,n,r,s,o);break;case"binary":ts(e,t,n,r,s,o);break;case"unary":ns(e,t,n,r,s,o);break;case"cast":rs(e,t,n,r,s,o);break;case"function":ss(e,t,n,r,s,o);break;case"parameter":os(e,t,n);break;case"subquery":e.compileSubquery(t,n);break;case"collate":as(e,t,n,r,s,o);break;default:throw new b(`Unsupported expression type: ${t.type}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function Wl(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new b(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new b(`Table ${n.name} is not a virtual table supporting INSERT`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=t.columns;if(!r)r=n.columns.filter(d=>!d.hidden).map(d=>d.name);else{let d=new Set(n.columns.map(l=>l.name.toLowerCase()));for(let l of r)if(!d.has(l.toLowerCase()))throw new b(`Column '${l}' not found in table '${n.name}'`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}let s=r.length,o=r.map(d=>n.columnIndexMap.get(d.toLowerCase())),a=e.allocateCursor(),i={type:"vtab",tableSchema:n};e.emit(f.OpenWrite,a,s,0,i,0,`OpenWrite ${n.name}`);let c=e.allocateMemoryCells(1),u=e.allocateMemoryCells(n.columns.length+1);if(t.values)for(let d of t.values){if(d.length!==s)throw new b(`Column count mismatch: table ${n.name} expected ${s} columns, but ${d.length} values were supplied`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);e.emit(f.Null,0,u,0,null,0,"Rowid=NULL for INSERT");for(let p=0;p<n.columns.length;p++)e.emit(f.Null,0,u+1+p);let l=new Map;for(let p=0;p<s;p++){let g=o[p],E=e.allocateMemoryCells(1);e.compileExpression(d[p],E);let y=n.columns[g];if(y.notNull){let w=e.allocateMemoryCells(1),N=e.allocateAddress(),C=e.allocateAddress(),S=`${n.name}.${y.name}`;e.emit(f.IsNull,E,w,0,null,0,`Check NULL ${S}`),e.emit(f.IfTrue,w,N,0,null,0,`Jump if NULL ${S}`),e.emit(f.Goto,0,C,0,null,0,"Skip violation"),e.resolveAddress(N),e.emit(f.ConstraintViolation,0,0,0,`NOT NULL constraint failed: ${S}`,0,`THROW ${S}`),e.resolveAddress(C)}l.set(g,E)}if(n.checkConstraints&&n.checkConstraints.length>0){let p=new Map;l.forEach((g,E)=>{p.set(`${E}`,g)}),n.checkConstraints.forEach((g,E)=>{let y=g.expr,w=g.name??`check_${E}`,N=`CHECK constraint ${w} on ${n.name}`,C=e.allocateMemoryCells(1),S=e.allocateAddress(),R=e.allocateAddress();e.compileExpression(y,C,void 0,void 0,p),e.emit(f.IfTrue,C,R,0,null,0,`If true, skip violation ${w}`);let L=`CHECK constraint failed: ${w}`;e.emit(f.ConstraintViolation,0,0,0,L,0,`THROW ${w}`),e.resolveAddress(R)})}for(let p=0;p<n.columns.length;p++){let g=u+1+p,E=l.get(p),y=n.columns[p];if(E!==void 0)e.emit(f.SCopy,E,g,0,null,0,`Copy provided value for col ${p} (${y.name})`);else if(y.defaultValue!==void 0){let w=e.allocateMemoryCells(1);if(typeof y.defaultValue=="object"&&y.defaultValue!==null&&"type"in y.defaultValue?e.compileExpression(y.defaultValue,w):on(e,y.defaultValue,w),e.emit(f.SCopy,w,g,0,null,0,`Copy DEFAULT value for col ${p} (${y.name})`),y.notNull){let N=e.allocateMemoryCells(1),C=e.allocateAddress(),S=e.allocateAddress(),R=`${n.name}.${y.name} DEFAULT`;e.emit(f.IsNull,w,N,0,null,0,`Check NULL ${R}`),e.emit(f.IfTrue,N,C,0,null,0,`Jump if NULL ${R}`),e.emit(f.Goto,0,S,0,null,0,"Skip violation"),e.resolveAddress(C),e.emit(f.ConstraintViolation,0,0,0,`NOT NULL constraint failed (using DEFAULT): ${R}`,0,`THROW ${R}`),e.resolveAddress(S)}}else if(e.emit(f.Null,0,g,0,null,0,`Set NULL for omitted col ${p} (${y.name})`),y.notNull){let w=e.allocateAddress(),N=`${n.name}.${y.name} (no default)`;e.emit(f.ConstraintViolation,0,0,0,`NOT NULL constraint failed: ${N}`,0,`THROW ${N}`)}}let h={onConflict:t.onConflict||W.ABORT,table:n,type:"update"};e.emit(f.VUpdate,n.columns.length+1,u,c,h,0,`VUpdate INSERT ${n.name}`)}else throw t.select?new b("INSERT ... SELECT compilation not implemented yet.",I.ERROR,void 0,t.select.loc?.start.line,t.select.loc?.start.column):new b("INSERT statement missing VALUES or SELECT clause.",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);e.emit(f.Close,a,0,0,null,0,`Close ${n.name}`)}function zl(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new b(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new b(`Table ${n.name} is not a virtual table supporting UPDATE`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=e.allocateCursor(),s={type:"vtab",tableSchema:n};e.emit(f.OpenRead,r,0,0,s,0,`OpenRead for UPDATE ${n.name}`),e.planTableAccess(r,n,t,new Set);let o=e.cursorPlanningInfo.get(r),a=e.allocateMemoryCells(1),i=e.allocateAddress(),c=e.allocateAddress(),u=e.allocateAddress(),d=0,l={idxNum:0,idxStr:null,nArgs:0};if(o&&o.idxNum!==0){let y=[];o.usage.forEach((N,C)=>{if(N.argvIndex>0){let S=o.constraintExpressions?.get(C);if(!S)throw new b(`Internal error: Missing expression for constraint ${C} used in UPDATE VFilter`,I.INTERNAL);for(;y.length<N.argvIndex;)y.push(null);y[N.argvIndex-1]={constraintIdx:C,expr:S}}});let w=y.filter(N=>N!==null);w.length>0&&(d=e.allocateMemoryCells(w.length),w.forEach((N,C)=>{e.compileExpression(N.expr,d+C)})),l={idxNum:o.idxNum,idxStr:o.idxStr,nArgs:w.length}}e.emit(f.VFilter,r,i,d,l,0,`Filter for UPDATE ${n.name} (Plan: ${o?.idxNum})`),e.resolveAddress(c),rn(e,t.where,[r],u),e.emit(f.VRowid,r,a,0,null,0,"Get Rowid for UPDATE target");let h=new Map;for(let y of t.assignments){let w=y.column.toLowerCase(),N=n.columnIndexMap.get(w);if(N===void 0)throw new b(`Column '${y.column}' not found in table '${n.name}'`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);if(h.has(N))throw new b(`Column '${y.column}' specified more than once in SET clause`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let C=e.allocateMemoryCells(1);e.compileExpression(y.value,C);let S=n.columns[N];if(S.notNull){let R=e.allocateMemoryCells(1),L=e.allocateAddress(),T=e.allocateAddress(),O=`${n.name}.${S.name}`;e.emit(f.IsNull,C,R,0,null,0,`Check NULL ${O}`),e.emit(f.IfTrue,R,L,0,null,0,`Jump if NULL ${O}`),e.emit(f.Goto,0,T,0,null,0,"Skip violation"),e.resolveAddress(L),e.emit(f.ConstraintViolation,0,0,0,`NOT NULL constraint failed: ${O}`,0,`THROW ${O}`),e.resolveAddress(T)}h.set(N,C)}if(n.checkConstraints&&n.checkConstraints.length>0){let y=new Map;for(let N=0;N<n.columns.length;N++)if(h.has(N))y.set(N,h.get(N));else{let C=e.allocateMemoryCells(1);e.emit(f.VColumn,r,N,C,0,0,`Get old value ${n.columns[N].name}`),y.set(N,C)}let w=new Map;y.forEach((N,C)=>{w.set(`${C}`,N)}),n.checkConstraints.forEach((N,C)=>{let S=N.expr,R=N.name??`check_${C}`,L=`CHECK constraint ${R} on ${n.name}`,T=e.allocateMemoryCells(1),O=e.allocateAddress();e.compileExpression(S,T,void 0,void 0,w),e.emit(f.IfTrue,T,O,0,null,0,`If true, skip violation ${R}`);let x=`CHECK constraint failed: ${R}`;e.emit(f.ConstraintViolation,0,0,0,x,0,`THROW ${R}`),e.resolveAddress(O)})}let p={onConflict:t.onConflict||W.ABORT,table:n,type:"update"},g=n.columns.length,E=e.allocateMemoryCells(g+1);e.emit(f.SCopy,a,E,0,null,0,"Copy Rowid for VUpdate");for(let y=0;y<g;y++){let w=E+1+y;if(h.has(y)){let N=h.get(y);e.emit(f.SCopy,N,w,0,null,0,`Copy NEW value for col ${y}`)}else e.emit(f.VColumn,r,y,w,0,0,`Get OLD value for col ${y}`)}e.emit(f.VUpdate,g+1,E,0,p,0,`VUpdate UPDATE ${n.name}`),e.resolveAddress(u),e.emit(f.VNext,r,i,0,null,0,"Advance to next row for UPDATE"),e.emit(f.Goto,0,c,0,null,0,"Loop back for next UPDATE"),e.resolveAddress(i),e.emit(f.Close,r,0,0,null,0,`Close ${n.name}`)}function Hl(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new b(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new b(`Table ${n.name} is not a virtual table supporting DELETE`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=e.allocateCursor(),s={type:"vtab",tableSchema:n};e.emit(f.OpenRead,r,0,0,s,0,`OpenRead for DELETE ${n.name}`),e.planTableAccess(r,n,t,new Set);let o=e.cursorPlanningInfo.get(r),a=e.allocateMemoryCells(1),i=e.allocateAddress(),c=e.allocateAddress(),u=e.allocateAddress(),d=0,l={idxNum:0,idxStr:null,nArgs:0};if(o&&o.idxNum!==0){let p=[];o.usage.forEach((E,y)=>{if(E.argvIndex>0){let w=o.constraintExpressions?.get(y);if(!w)throw new b(`Internal error: Missing expression for constraint ${y} used in DELETE VFilter`,I.INTERNAL);for(;p.length<E.argvIndex;)p.push(null);p[E.argvIndex-1]={constraintIdx:y,expr:w}}});let g=p.filter(E=>E!==null);g.length>0&&(d=e.allocateMemoryCells(g.length),g.forEach((E,y)=>{e.compileExpression(E.expr,d+y)})),l={idxNum:o.idxNum,idxStr:o.idxStr,nArgs:g.length}}e.emit(f.VFilter,r,i,d,l,0,`Filter for DELETE ${n.name} (Plan: ${o?.idxNum})`),e.resolveAddress(c),rn(e,t.where,[r],u),e.emit(f.VRowid,r,a,0,null,0,"Get Rowid for DELETE");let h={onConflict:W.ABORT,table:n,type:"update"};e.emit(f.VUpdate,1,a,0,h,0,`VUpdate DELETE ${n.name}`),e.resolveAddress(u),e.emit(f.VNext,r,i,0,null,0,"Advance to next row for DELETE"),e.emit(f.Goto,0,c,0,null,0,"Loop back for next DELETE"),e.resolveAddress(i),e.emit(f.Close,r,0,0,null,0,`Close ${n.name}`)}function Zl(e,t){if(t.savepoint){let n=e.addConstant(t.savepoint);e.emit(f.Savepoint,0,0,0,n,0,`ROLLBACK TO ${t.savepoint}`),e.emit(f.VRollbackTo,0,0,0,n,0,`VRollbackTo ${t.savepoint}`)}else e.emit(f.VRollback,0,0,0,null,0,"ROLLBACK")}function Xl(e,t){let n=e.addConstant(t.name);e.emit(f.Savepoint,1,0,0,n,0,`SAVEPOINT ${t.name}`),e.emit(f.VSavepoint,0,0,0,n,0,`VSavepoint ${t.name}`)}function Jl(e,t){if(!t.savepoint)throw new b("RELEASE statement requires a savepoint name.",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let n=e.addConstant(t.savepoint);e.emit(f.Savepoint,2,0,0,n,0,`RELEASE ${t.savepoint}`),e.emit(f.VRelease,0,0,0,n,0,`VRelease ${t.savepoint}`)}function om(e){return e.type==="column"&&e.expr?.type==="function"&&e.expr.isAggregate===!0}function eu(e,t){if(!t.from||t.from.length===0){am(e,t);return}let n=!!t.groupBy&&t.groupBy.length>0,r=t.columns.filter(om),s=r.length>0,o=s&&!n,a=s||n,i=0,c=[],u=0,d=e.resultColumns,l=e.columnAliases;e.resultColumns=[],e.columnAliases=[];let h=e.compileFromCore(t.from),p=[...h];p.forEach(D=>{let P=e.tableSchemas.get(D);P&&e.planTableAccess(D,P,t,new Set)});let g=!1,E=null;t.orderBy&&t.orderBy.length>0&&(p.every(P=>e.cursorPlanningInfo.get(P)?.orderByConsumed??!1)||(g=!0));let y=0,w=0,N=[],C=0,S=0,R=[],L=e.compileSelectCore(t,h);if(y=L.resultBaseReg,w=L.numCols,N=L.columnMap,a){let D=(t.groupBy?.length??0)+r.length;o&&!n&&(D=r.length),D===0&&n&&(D=t.groupBy.length),D===0&&(D=1),C=e.allocateMemoryCells(D)}else C=y,S=w,R=N;let T=-1,O;if(g){let D=t.orderBy,P=[],X=[];D.forEach(Q=>{let K=R.findIndex(te=>{let Ie=te.expr?.alias?.toLowerCase(),Ue=Q.expr?.alias?.toLowerCase();return Ue&&Ie===Ue?!0:Q.expr.type==="column"&&te.expr?.type==="column"&&!Ue&&!te.expr?.alias?Q.expr.name.toLowerCase()===te.expr.name.toLowerCase():JSON.stringify(Q.expr)===JSON.stringify(te.expr)});if(K===-1)throw new b(`ORDER BY term "${JSON.stringify(Q.expr)}" not found in result columns`);P.push(K),X.push(Q.direction==="desc")}),E={keyIndices:P,directions:X,type:"sortkey"},console.log(`Memory Sort: ${S} cols, keys: ${P.join(",")}, dirs: ${X.join(",")}`),T=e.allocateCursor(),O=e.createEphemeralSchema(T,S,E),e.emit(f.OpenEphemeral,T,S,0,O,0,"Open Ephemeral Sorter")}a&&e.emit(f.AggReset,0,0,0,null,0,"Reset Aggregation Context");let x=0,$=0;if(t.limit)x=e.allocateMemoryCells(1),e.compileExpression(t.limit,x),t.offset?($=e.allocateMemoryCells(1),e.compileExpression(t.offset,$)):($=e.allocateMemoryCells(1),e.emit(f.Integer,0,$,0,null,0,"Default OFFSET 0"));else if(t.offset)throw new b("OFFSET requires a LIMIT clause",I.ERROR);let z=[],ee=[],H=[],Ee=[],Oe=new Set,ie=0,ce=0;h.forEach((D,P)=>{if(!e.tableSchemas.get(D))throw new b(`Internal error: Schema not found for cursor ${D}`,I.INTERNAL);let Q=e.allocateAddress(),K=e.allocateAddress(),te=e.allocateAddress();z.push(Q),ee.push(K),H.push(te);let Ie=Ql(t.from,P),Ue=Ie==="left"?e.allocateMemoryCells(1):0;Ee.push(Ue),Ue>0&&e.emit(f.Integer,0,Ue,0,null,0,`Init LEFT JOIN Match Flag [${P}] = 0`);let be=e.cursorPlanningInfo.get(D),_={idxNum:0,idxStr:null,nArgs:0},ne=0;if(be&&be.idxNum!==0){let $e=[];be.usage.forEach((Mt,ir)=>{if(Mt.argvIndex>0){let Hr=be.constraintExpressions?.get(ir);if(!Hr)throw new b(`Internal error: Missing expression for constraint ${ir} used in VFilter`,I.INTERNAL);for(;$e.length<Mt.argvIndex;)$e.push(null);$e[Mt.argvIndex-1]={constraintIdx:ir,expr:Hr}}});let pt=$e.filter(Mt=>Mt!==null);pt.length>0&&(ne=e.allocateMemoryCells(pt.length),pt.forEach((Mt,ir)=>{let Hr=Et(e,Mt.expr,Oe);e.compileExpression(Mt.expr,ne+ir,Hr)})),_={idxNum:be.idxNum,idxStr:be.idxStr,nArgs:pt.length}}if(e.emit(f.VFilter,D,K,ne,_,0,`Filter/Scan Cursor ${P}`),e.resolveAddress(Q),e.verifyWhereConstraints(D,te),P>0){let $e=im(t.from,P-1,P,e);$e&&Ie!=="cross"&&lm(e,$e,h.slice(0,P+1),te)}if(P>0){let $e=P-1,pt=Ee[$e];pt>0&&e.emit(f.Integer,1,pt,0,null,0,`Set LEFT JOIN Match Flag [${$e}] = 1`)}Oe.add(D)}),ce=e.getCurrentAddress();let xt=e.allocateAddress();rn(e,t.where,h,xt);let{resultBaseReg:nn,numCols:Bh,columnMap:hy}=e.compileSelectCore(t,h);if(Bh!==w)throw new Error("Internal: Column count mismatch during loop recompilation");if(a){let D=0,P=0,X=0;n?(P=t.groupBy.length,D=e.allocateMemoryCells(P),t.groupBy.forEach((Q,K)=>{e.compileExpression(Q,D+K)}),X=e.allocateMemoryCells(1),e.emit(f.MakeRecord,D,P,X,null,0,"Make GROUP BY Key")):(X=e.allocateMemoryCells(1),e.emit(f.Integer,0,X,0,null,0,"Use constant key 0 for simple aggregate")),r.forEach(Q=>{let K=Q.expr,te=e.db._findFunction(K.name,K.args.length);if(!te)throw new Error("Aggregate function definition disappeared?");let Ie=e.allocateMemoryCells(K.args.length||1);K.args.forEach((be,_)=>{e.compileExpression(be,Ie+_)});let Ue={type:"funcdef",funcDef:te,nArgs:K.args.length};e.emit(f.AggStep,D,Ie,X,Ue,P,`AggStep for ${K.name}`)})}else{let D=e.allocateAddress();if(x>0){let P=e.allocateAddress();e.emit(f.IfZero,$,P,0,null,0,"Check Offset == 0"),e.emit(f.Subtract,1,$,$,null,0,"Decrement Offset"),e.emit(f.Goto,0,D,0,null,0,"Skip Row (Offset)"),e.resolveAddress(P)}if(g){let P=e.allocateMemoryCells(S+1);e.emit(f.Null,0,P,0,null,0,"Sort: NULL Rowid for Eph Insert"),e.emit(f.Move,nn,P+1,S,null,0,"Sort: Copy result to Eph Insert Data"),e.emit(f.VUpdate,S+1,P,T,{table:O},0,"Sort: Insert Row into Ephemeral")}else if(e.emit(f.ResultRow,nn,S,0,null,0,"Output result row"),x>0){let P=e.allocateAddress();e.emit(f.IfZero,x,P,0,null,0,"Skip Limit Check if already 0"),e.emit(f.Subtract,1,x,x,null,0,"Decrement Limit"),e.emit(f.IfZero,x,ee[0],0,null,0,"Check Limit Reached"),e.resolveAddress(P)}e.resolveAddress(D)}ie=e.getCurrentAddress()+2,e.emit(f.Goto,0,ie,0,null,0,"Goto Innermost VNext"),e.resolveAddress(xt),e.emit(f.Goto,0,ie,0,null,0,"WHERE Failed, Goto VNext");for(let D=h.length-1;D>=0;D--){let P=h[D],X=z[D],Q=ee[D],K=H[D],te=Ee[D];e.resolveAddress(K);let Ie=e.getCurrentAddress();if(D===h.length-1&&(e.resolveAddress(ie-2),e.resolveAddress(ie-1),ie=Ie),e.emit(f.VNext,P,Q,0,null,0,`VNext Cursor ${D}`),e.emit(f.Goto,0,X,0,null,0,`Goto LoopStart ${D}`),e.resolveAddress(Q),Ql(t.from,D)==="left"&&te>0){let be=e.allocateAddress();if(e.emit(f.IfTrue,te,be,0,null,0,`LEFT JOIN EOF: Skip NULL pad if match found [${D}]`),N.forEach(_=>{_.sourceCursor===P&&e.emit(f.Null,0,_.targetReg,0,null,0,`LEFT JOIN EOF: NULL Pad Col ${_.sourceColumnIndex} from Cursor ${P}`)}),D>0){let _=Ee[D-1];_>0&&e.emit(f.Integer,1,_,0,null,0,`Set LEFT JOIN Match Flag [${D-1}] = 1 (due to NULL pad EOF)`)}e.emit(f.Goto,0,ce,0,null,0,`LEFT JOIN EOF: Process NULL-padded row [${D}]`),e.resolveAddress(be)}te>0&&e.emit(f.Integer,0,te,0,null,0,`Reset LEFT JOIN Match Flag [${D}] before outer VNext/EOF`),Oe.delete(P)}if(a){let D=e.allocateAddress(),P=e.allocateAddress(),X=e.allocateMemoryCells(1),Q=e.allocateMemoryCells(1),K=e.allocateMemoryCells(1);R=[];let te=C;n&&t.groupBy.forEach((_,ne)=>{R.push({targetReg:te++,sourceCursor:-1,sourceColumnIndex:-1,expr:_})}),r.forEach(_=>{R.push({targetReg:te++,sourceCursor:-1,sourceColumnIndex:-1,expr:_.expr})}),S=R.length,S===0&&!n&&(S=1),e.columnAliases=R.map((_,ne)=>_.expr?.alias??(_.expr?.type==="column"?_.expr.name:`col${ne}`)),e.emit(f.AggIterate,X,0,0,null,0,"Start Aggregate Result Iteration"),e.resolveAddress(D),e.emit(f.AggNext,X,P,0,null,0,"Next Aggregate Group"),e.emit(f.AggKey,X,Q,0,null,0,"Get Group Key"),e.emit(f.AggContext,X,K,0,null,0,"Get Aggregate Context");let Ie=0,Ue=0;R.forEach(_=>{if(_.expr?.type==="function"&&_.expr.isAggregate){let ne=_.expr,pt={type:"funcdef",funcDef:e.db._findFunction(ne.name,ne.args.length),nArgs:ne.args.length};e.emit(f.AggFinal,K,0,_.targetReg,pt,0,`AggFinal for ${ne.name}`),Ue++}else if(n)e.emit(f.AggGroupValue,X,Ie,_.targetReg,null,0,`Output Group Key ${Ie}`),Ie++;else throw new Error("Internal: Unexpected column type in aggregate output loop")});let be=e.allocateAddress();if(t.having){let _=e.allocateMemoryCells(1),ne={finalColumnMap:R};e.compileExpression(t.having,_,void 0,ne),e.emit(f.IfFalse,_,be,0,null,0,"Check HAVING Clause")}if(g){let _=e.allocateMemoryCells(S+1);e.emit(f.Null,0,_,0,null,0,"Agg Sort: NULL Rowid"),e.emit(f.Move,C,_+1,S,null,0,"Agg Sort: Copy group result"),e.emit(f.VUpdate,S+1,_,T,{table:O},0,"Agg Sort: Insert Group Row")}else{let _=e.allocateAddress();if(x>0){let ne=e.allocateAddress();e.emit(f.IfZero,$,ne,0,null,0,"Agg Check Offset == 0"),e.emit(f.Subtract,1,$,$,null,0,"Agg Decrement Offset"),e.emit(f.Goto,0,_,0,null,0,"Agg Skip Row (Offset)"),e.resolveAddress(ne)}if(e.emit(f.ResultRow,C,S,0,null,0,"Output Aggregate Group Row"),x>0){let ne=e.allocateAddress();e.emit(f.IfZero,x,ne,0,null,0,"Agg Skip Limit Check if 0"),e.emit(f.Subtract,1,x,x,null,0,"Agg Decrement Limit"),e.emit(f.IfZero,x,P,0,null,0,"Agg Check Limit Reached"),e.resolveAddress(ne)}e.resolveAddress(_)}e.resolveAddress(be),e.emit(f.Goto,0,D,0,null,0,"Loop Aggregate Results"),e.resolveAddress(P)}if(g){let D=e.allocateAddress(),P=e.allocateAddress(),X=e.allocateMemoryCells(S);e.emit(f.Rewind,T,P,0,null,0,"Rewind Sorter"),e.resolveAddress(D);let Q=e.allocateAddress();if(x>0){let K=e.allocateAddress();e.emit(f.IfZero,$,K,0,null,0,"Sort Check Offset == 0"),e.emit(f.Subtract,1,$,$,null,0,"Sort Decrement Offset"),e.emit(f.Goto,0,Q,0,null,0,"Sort Skip Row (Offset)"),e.resolveAddress(K)}for(let K=0;K<S;K++)e.emit(f.VColumn,T,K,X+K,0,0,`Read Sorted Col ${K}`);if(e.emit(f.ResultRow,X,S,0,null,0,"Output sorted row"),x>0){let K=e.allocateAddress();e.emit(f.IfZero,x,K,0,null,0,"Sort Skip Limit Check if already 0"),e.emit(f.Subtract,1,x,x,null,0,"Sort Decrement Limit"),e.emit(f.IfZero,x,P,0,null,0,"Sort Check Limit Reached"),e.resolveAddress(K)}e.resolveAddress(Q),e.emit(f.VNext,T,P,0,null,0,"VNext Sorter"),e.emit(f.Goto,0,D,0,null,0,"Loop Sorter Results"),e.resolveAddress(P),e.emit(f.Close,T,0,0,null,0,"Close Sorter")}g||e.closeCursorsUsedBySelect(h),e.resultColumns=d,e.columnAliases=l}function am(e,t){let{resultBaseReg:n,numCols:r,columnMap:s}=e.compileSelectCore(t,[]);if(e.columnAliases=s.map((o,a)=>o.expr?.alias??(o.expr?.type==="column"?o.expr.name:`col${a}`)),t.where){let o=e.allocateMemoryCells(1),a=e.allocateAddress();e.compileExpression(t.where,o),e.emit(f.IfFalse,o,a,0,null,0,"Check WHERE for constant SELECT"),e.emit(f.ResultRow,n,r,0,null,0,"Output constant result row"),e.resolveAddress(a)}else e.emit(f.ResultRow,n,r,0,null,0,"Output constant result row")}function tu(e,t,n,r,s){let o=e.resultColumns,a=e.columnAliases;e.resultColumns=[],e.columnAliases=[];let i=new Set;t.from?.forEach(E=>{let y=w=>{if(w.type==="table"){let N=(w.alias||w.table.name).toLowerCase(),C=e.tableAliases.get(N);C!==void 0&&i.add(C)}else w.type==="join"&&(y(w.left),y(w.right))};y(E)});let c=new Set([...n,...i]),u=0;t.columns.some(E=>E.type==="all")&&c.forEach(E=>{let y=e.tableSchemas.get(E),w=[...e.tableAliases.entries()].find(([,C])=>C===E)?.[0],N=t.columns.find(C=>C.type==="all"&&C.table&&(C.table.toLowerCase()===y?.name.toLowerCase()||C.table.toLowerCase()===w?.toLowerCase()));y&&(!N||N.table)&&(u+=y?.columns.filter(C=>!C.hidden).length||0)}),u+=t.columns.filter(E=>E.type==="column").length,u===0&&(u=1);let l=e.allocateMemoryCells(u),h=0,p=[],g=l;for(let E of t.columns)if(E.type==="all")c.forEach(y=>{let w=e.tableSchemas.get(y),N=[...e.tableAliases.entries()].find(([,C])=>C===y)?.[0];w&&(!E.table||E.table.toLowerCase()===N?.toLowerCase()||E.table.toLowerCase()===w.name.toLowerCase())&&w.columns.forEach(C=>{if(!C.hidden){let S=g++,R=w.columnIndexMap.get(C.name.toLowerCase());if(R===void 0&&C.name.toLowerCase()!=="rowid")e.emit(f.Null,0,S,0,null,0,`Expand *: Col ${C.name} Idx Error`),p.push({targetReg:S,sourceCursor:y,sourceColumnIndex:-1});else{e.emit(f.VColumn,y,R??-1,S,0,0,`Expand *: ${N||w.name}.${C.name}`);let T={type:"column",name:C.name,table:N||w.name};p.push({targetReg:S,sourceCursor:y,sourceColumnIndex:R??-1,expr:T})}let L=`${N||w.name}.${C.name}`;e.resultColumns.push({name:L}),e.columnAliases.push(L),h++}})});else if(E.expr){let y=g++;e.compileExpression(E.expr,y,r,void 0,s);let w=-1,N=-1;if(E.expr.type==="column"){let S=E.expr;if(S.table)w=e.tableAliases.get(S.table.toLowerCase())??-1;else for(let R of c)if(e.tableSchemas.get(R)?.columnIndexMap.has(S.name.toLowerCase())){if(w!==-1){w=-1,N=-1;break}w=R}w!==-1&&(N=e.tableSchemas.get(w)?.columnIndexMap.get(S.name.toLowerCase())??-1)}p.push({targetReg:y,sourceCursor:w,sourceColumnIndex:N,expr:E.expr});let C=E.alias||(E.expr.type==="column"?E.expr.name:`col${h+1}`);e.columnAliases.push(C),e.resultColumns.push({name:C,expr:E.expr}),h++}return e.resultColumns=o,e.columnAliases=a,{resultBaseReg:l,numCols:h,columnMap:p}}function im(e,t,n,r){if(!e||e.length!==1||e[0].type!=="join")return;let s=(o,a)=>{if(o.type==="table")return{node:null,nextLevel:a+1};if(o.type==="join"){let i=s(o.left,a);if(i.node)return i;let c=s(o.right,i.nextLevel);return c.node?c:i.nextLevel-1===t&&c.nextLevel-1===n?{node:o,nextLevel:c.nextLevel}:{node:null,nextLevel:c.nextLevel}}else throw new Error("Invalid node type in FROM clause during join node search")};return s(e[0],0).node??void 0}function Ql(e,t){if(t===0||!e||e.length===0)return;let n=(s,o)=>{if(s.type==="table")return{joinNode:null,nextLevel:o+1};if(s.type==="join"){let a=n(s.left,o);if(a.joinNode)return a;let i=n(s.right,a.nextLevel);return i.joinNode?i:i.nextLevel-1===t?{joinNode:s,nextLevel:i.nextLevel}:{joinNode:null,nextLevel:i.nextLevel}}else throw new Error("Invalid node type in FROM clause during join type search")};return e.length>1?"cross":n(e[0],0).joinNode?.joinType}function lm(e,t,n,r){if(n.length<2)throw new Error("Internal: compileJoinCondition called with insufficient active cursors.");let s=n[n.length-2],o=n[n.length-1];if(t.condition){let a=e.allocateMemoryCells(1);e.compileExpression(t.condition,a),e.emit(f.IfFalse,a,r,0,null,0,"JOIN: Check ON Condition")}else if(t.columns){let a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1),c=e.allocateMemoryCells(1),u=e.tableSchemas.get(s),d=e.tableSchemas.get(o);if(!u||!d)throw new Error("Internal: Schema not found for USING clause cursors.");for(let l of t.columns){let h=u.columnIndexMap.get(l.toLowerCase()),p=d.columnIndexMap.get(l.toLowerCase());if(h===void 0||p===void 0)throw new b(`Column '${l}' specified in USING clause not found in both tables.`,I.ERROR);e.emit(f.VColumn,s,h,i,0,0,`USING(${l}) Left`),e.emit(f.VColumn,o,p,c,0,0,`USING(${l}) Right`);let g=e.allocateAddress(),E=e.allocateAddress(),y=e.allocateMemoryCells(1);e.emit(f.IfNull,i,E,0,null,0,"USING: Skip if left NULL"),e.emit(f.IfNull,c,E,0,null,0,"USING: Skip if right NULL"),e.emit(f.Eq,i,g,c,null,0,`USING Compare ${l}`),e.emit(f.Integer,0,y,0,null,0),e.emit(f.Goto,0,E,0,null,0),e.resolveAddress(g),e.emit(f.Integer,1,y,0,null,0),e.resolveAddress(E),e.emit(f.IfFalse,y,r,0,null,0,`USING: Jump if ${l} not equal`)}}}function nu(e,t,n){console.warn("compileSubquery assuming scalar context. EXISTS/IN should be handled by parent expression compiler."),e.compileScalarSubquery(t.query,n)}function ru(e,t,n){let r=new Set(e.tableAliases.values()),s=Et(e,t,r);s.isCorrelated?su(e,t,n,s):cm(e,t,n)}function cm(e,t,n){if(t.columns.length!==1||t.columns[0].type==="all")throw new b("Scalar subquery must return exactly one column (cannot be *)",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let r=e.allocateMemoryCells(1),s=e.allocateAddress(),o=e.allocateAddress(),a=e.allocateAddress(),i=e.allocateAddress(),c=e.allocateAddress();e.emit(f.Integer,0,r,0,null,0,"Init Subquery: hasRow=0");let u=[],{resultBaseReg:d,numCols:l}=e.compileSelectCore(t,u);if(l!==1)throw new Error("Scalar Subquery core compile error: Expected 1 column");let h=u[0];h===void 0?(e.emit(f.Integer,1,r,0,null,0,"Subquery: Set hasRow=1 (literal)"),e.emit(f.SCopy,d,n,0,null,0,"Subquery: Copy literal result"),e.emit(f.Goto,0,i,0,null,0,"Subquery: Finish (literal)")):(e.emit(f.VFilter,h,o,0,{idxNum:0,idxStr:null,nArgs:0},0,"Subquery: Start scan"),e.resolveAddress(s),e.emit(f.IfTrue,r,a,0,null,0,"Subquery: Check if >1 row"),e.emit(f.Integer,1,r,0,null,0,"Subquery: Set hasRow=1"),e.emit(f.SCopy,d,n,0,null,0,"Subquery: Copy row result"),e.emit(f.VNext,h,o,0,null,0,"Subquery: VNext"),e.emit(f.Goto,0,s,0,null,0,"Subquery: Loop"),e.resolveAddress(o)),e.closeCursorsUsedBySelect(u),e.emit(f.IfFalse,r,c,0,null,0,"Subquery: Check if hasRow is false (0 rows)"),e.emit(f.Goto,0,i,0,null,0,"Subquery: Finish (1 row)"),e.resolveAddress(a),e.emit(f.Halt,I.ERROR,0,0,"Scalar subquery returned more than one row",0,"Error: Subquery >1 row"),e.resolveAddress(c),e.emit(f.Null,0,n,0,null,0,"Subquery: Set NULL Result (0 rows)"),e.resolveAddress(i)}function su(e,t,n,r){let s=e.subroutineDefs?.get(t);if(!s){e.startSubroutineCompilation();let p=e.getCurrentAddress(),g=2,E=3,y=4,w=4,N=new Map;r.correlatedColumns.forEach((H,Ee)=>{let Oe=-(Ee+1);N.set(`${H.outerCursor}.${H.outerColumnIndex}`,Oe)});let C=[],{resultBaseReg:S,numCols:R}=e.compileSelectCore(t,C,r,N);if(R!==1)throw new b("Correlated scalar subquery must return one column",I.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column);let L=e.allocateAddress(),T=e.allocateAddress(),O=e.allocateAddress(),x=e.allocateAddress(),$=e.allocateAddress(),z=C[0];e.emit(f.Integer,0,E,0,null,0,"Sub: Init hasRow=0"),e.emit(f.Integer,0,y,0,null,0,"Sub: Init error=0");let ee=e.allocateAddress();z!==void 0?(e.emit(f.VFilter,z,T,0,{idxNum:0,idxStr:null,nArgs:0},0,"Sub: Start scan"),e.resolveAddress(L),e.emit(f.IfTrue,y,ee,0,null,0,"Sub: Skip if error already set"),e.emit(f.IfTrue,E,O,0,null,0,"Sub: Check if >1 row"),e.emit(f.Integer,1,E,0,null,0,"Sub: Set hasRow=1"),e.emit(f.SCopy,S,g,0,null,0,"Sub: Copy first row result"),e.emit(f.Goto,0,ee,0,null,0),e.resolveAddress(O),e.emit(f.Integer,1,y,0,null,0,"Sub: Set error=1 (>1 row)"),e.emit(f.Null,0,g,0,null,0,"Sub: Set NULL on >1 row error"),e.resolveAddress(ee),e.emit(f.VNext,z,T,0,null,0,"Sub: VNext"),e.emit(f.Goto,0,L,0,null,0,"Sub: Loop")):(e.emit(f.Integer,1,E,0,null,0,"Sub: Set hasRow=1 (literal)"),e.emit(f.SCopy,S,g,0,null,0,"Sub: Copy literal result"),e.emit(f.Goto,0,x-1,0,null,0)),e.resolveAddress(T),e.closeCursorsUsedBySelect(C),e.resolveAddress(e.getCurrentAddress()),e.emit(f.IfTrue,y,x,0,null,0,"Sub: Jump if error flag set"),e.emit(f.IfFalse,E,$,0,null,0,"Sub: Check if hasRow is false (0 rows)"),e.emit(f.Goto,0,x,0,null,0,"Sub: Finish (1 row, no error)"),e.resolveAddress($),e.emit(f.Null,0,g,0,null,0,"Sub: Set NULL result (0 rows)"),e.resolveAddress(x),e.emit(f.SCopy,g,-1,0,null,0,"Sub: Store result in Arg FP[-1]"),e.emit(f.SCopy,y,-2,0,null,0,"Sub: Store error in Arg FP[-2]"),e.emit(f.FrameLeave,0,0,0,null,0,"Leave Subroutine Frame"),e.emit(f.Return,0,0,0,null,0,"Return from subquery"),s={startAddress:p,correlation:r},e.subroutineDefs?.set(t,s),e.endSubroutineCompilation()}let o=r.correlatedColumns.length,a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1);r.correlatedColumns.forEach(p=>{let g=e.allocateMemoryCells(1),E=[...e.tableAliases.entries()].find(([C,S])=>S===p.outerCursor)?.[0],y=e.tableSchemas.get(p.outerCursor);if(!y)throw new Error(`Internal: Schema for outer cursor ${p.outerCursor} not found`);let w=y.columns[p.outerColumnIndex]?.name;if(!w)throw new Error(`Internal: Column index ${p.outerColumnIndex} not found for outer cursor ${p.outerCursor}`);let N={type:"column",name:w,table:E};e.compileExpression(N,g),e.emit(f.Push,g,0,0,null,0,`Push outer val ${w}`)}),e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub Error Status"),e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub Result");let c=o+2;e.emit(f.Subroutine,c,s.startAddress,0,null,0,"Call correlated subquery");let u=e.stackPointer-1,d=e.stackPointer-2;e.emit(f.SCopy,u,a,0,null,0,`Copy sub result from stack[${u}]`),e.emit(f.SCopy,d,i,0,null,0,`Copy sub error from stack[${d}]`),e.emit(f.StackPop,c,0,0,null,0,"Pop subquery args/results");let l=e.allocateAddress(),h=e.allocateAddress();e.emit(f.IfZero,i,l,0,null,0,"Check subquery error flag"),e.emit(f.Halt,I.ERROR,0,0,"Correlated scalar subquery returned multiple rows",0,"Error: Subquery >1 row"),e.resolveAddress(l),e.emit(f.SCopy,a,n,0,null,0,"Copy final subquery result"),e.resolveAddress(h)}function ou(e,t,n,r,s){if(n.columns.length!==1||n.columns[0].type==="all")throw new b("Subquery for IN operator must return exactly one column (cannot be *)",I.ERROR,void 0,n.loc?.start.line,n.loc?.start.column);let o=Et(e,n,new Set(e.tableAliases.values()));o.isCorrelated?dm(e,t,n,r,s,o):fm(e,t,n,r,s)}function fm(e,t,n,r,s){let o=e.allocateMemoryCells(1),a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1),c=e.allocateMemoryCells(1),u=e.allocateCursor(),d=e.allocateAddress(),l=e.allocateAddress(),h=e.allocateAddress(),p=e.allocateAddress(),g=e.allocateAddress(),E=e.allocateAddress(),y=e.allocateAddress(),w=e.allocateAddress();e.emit(f.Integer,0,i,0,null,0,"IN: Init hasNull=0"),e.emit(f.Integer,0,c,0,null,0,"IN: Init matchFound=0"),e.compileExpression(t,o),e.emit(f.IfNull,o,E,0,null,0,"IN: Check if Left Expr is NULL (early exit)"),e.emit(f.OpenEphemeral,u,1,0,null,0,"IN: Open Ephemeral Table");let N=e.createEphemeralSchema(u,1),C=[],{resultBaseReg:S,numCols:R}=e.compileSelectCore(n,C);if(R!==1)throw new Error("IN Subquery core compile error");let L=C[0],T=e.allocateAddress(),O=e.allocateAddress(),x=e.allocateMemoryCells(2);L===void 0?(e.emit(f.IfNull,S,y,0,null,0,"IN: Check literal NULL"),e.emit(f.Null,0,x,0,null,0),e.emit(f.SCopy,S,x+1,0,null,0),e.emit(f.VUpdate,2,x,0,{table:N},0,"IN: Insert literal"),e.emit(f.Goto,0,w,0,null,0),e.resolveAddress(y),e.emit(f.Integer,1,i,0,null,0,"IN: Set hasNull=1 (literal)"),e.resolveAddress(w)):(e.emit(f.VFilter,L,O,0,{idxNum:0,idxStr:null,nArgs:0},0,"IN: Subquery Scan Start"),e.resolveAddress(T),e.emit(f.IfNull,S,y,0,null,0,"IN: Check subquery NULL"),e.emit(f.Null,0,x,0,null,0,"IN: Prep Insert Rowid"),e.emit(f.SCopy,S,x+1,0,null,0,"IN: Prep Insert Value"),e.emit(f.VUpdate,2,x,0,{table:N},0,"IN: Insert subquery result"),e.emit(f.Goto,0,w,0,null,0),e.resolveAddress(y),e.emit(f.Integer,1,i,0,null,0,"IN: Set hasNull=1"),e.resolveAddress(w),e.emit(f.VNext,L,O,0,null,0,"IN: Subquery VNext"),e.emit(f.Goto,0,T,0,null,0,"IN: Subquery Loop"),e.resolveAddress(O)),e.closeCursorsUsedBySelect(C),e.emit(f.Rewind,u,p,0,null,0,"IN: Rewind Ephemeral Table"),e.resolveAddress(d),e.emit(f.VColumn,u,0,a,0,0,"IN: Get value from Ephemeral"),e.emit(f.Eq,o,h,a,null,0,"IN: Compare values (jump if EQ)"),e.resolveAddress(l),e.emit(f.VNext,u,p,0,null,0,"IN: VNext Ephemeral"),e.emit(f.Goto,0,d,0,null,0,"IN: Loop Ephemeral Scan"),e.resolveAddress(h),e.emit(f.IfNull,o,E,0,null,0,"IN: If left was NULL, result is NULL"),e.emit(f.IfNull,a,E,0,null,0,"IN: If matching eph val was NULL, result is NULL"),e.emit(f.Integer,1,c,0,null,0,"IN: Set matchFound=1"),e.emit(f.Goto,0,p,0,null,0,"IN: Jump to end (match found)"),e.resolveAddress(p),e.closeCursorsUsedBySelect([u]);let $=s?0:1,z=s?1:0,ee=e.allocateAddress(),H=e.allocateAddress();e.emit(f.IfTrue,c,H,0,null,0),e.emit(f.IfTrue,i,E,0,null,0,"IN: Check if NULL present (no match)"),e.resolveAddress(ee),e.emit(f.Integer,z,r,0,null,0,`IN: Set Final Result (${z})`),e.emit(f.Goto,0,g,0,null,0,"IN: Jump to final"),e.resolveAddress(H),e.emit(f.Integer,$,r,0,null,0,`IN: Set Final Result (${$})`),e.emit(f.Goto,0,g,0,null,0),e.resolveAddress(E),e.emit(f.Null,0,r,0,null,0,"IN: Set NULL Result"),e.resolveAddress(g)}function dm(e,t,n,r,s,o){let a=e.subroutineDefs?.get(n);if(!a){e.startSubroutineCompilation();let h=e.getCurrentAddress(),p=2,g=3,E=4,y=new Map;y.set("_caller_left_expr_",-1),o.correlatedColumns.forEach((ie,ce)=>{y.set(`${ie.outerCursor}.${ie.outerColumnIndex}`,-(ce+2))});let w=[],{resultBaseReg:N,numCols:C}=e.compileSelectCore(n,w,o,y);if(C!==1)throw new b("Correlated IN subquery requires 1 column",I.INTERNAL,void 0,n.loc?.start.line,n.loc?.start.column);let S=e.allocateAddress(),R=e.allocateAddress(),L=e.allocateAddress(),T=e.allocateAddress(),O=e.allocateAddress(),x=e.allocateAddress(),$=w[0];if(e.emit(f.Integer,0,p,0,null,0,"SubIN: Init match=0"),e.emit(f.Integer,0,g,0,null,0,"SubIN: Init hasNull=0"),$!==void 0)e.emit(f.VFilter,$,R,0,{idxNum:0,idxStr:null,nArgs:0},0,"SubIN: Start scan"),e.resolveAddress(S),e.emit(f.SCopy,N,E,0,null,0,"SubIN: Get subquery value"),e.emit(f.IfNull,E,T,0,null,0,"SubIN: Check if subquery value is NULL"),e.emit(f.Eq,-1,L,E,null,0,"SubIN: Compare with Arg (Jump if EQ)"),e.emit(f.Goto,0,O,0,null,0),e.resolveAddress(T),e.emit(f.Integer,1,g,0,null,0,"SubIN: Set hasNull=1"),e.emit(f.Goto,0,O,0,null,0),e.resolveAddress(L),e.emit(f.Integer,1,p,0,null,0,"SubIN: Set match=1"),e.resolveAddress(O),e.emit(f.VNext,$,R,0,null,0,"SubIN: VNext"),e.emit(f.Goto,0,S,0,null,0,"SubIN: Loop");else{e.emit(f.SCopy,N,E,0,null,0,"SubIN: Get literal subquery value");let ie=e.allocateAddress(),ce=e.allocateAddress();e.emit(f.IfNull,E,ie,0,null,0),e.emit(f.Eq,-1,ce,E,null,0),e.emit(f.Goto,0,R,0,null,0),e.resolveAddress(ce),e.emit(f.Integer,1,p,0,null,0),e.emit(f.Goto,0,R,0,null,0),e.resolveAddress(ie),e.emit(f.Integer,1,g,0,null,0)}e.resolveAddress(R),e.closeCursorsUsedBySelect(w);let z=s?0:1,ee=s?1:0,H=e.allocateAddress(),Ee=e.allocateAddress(),Oe=e.allocateAddress();e.emit(f.IfTrue,p,Oe,0,null,0),e.emit(f.IfTrue,g,Ee,0,null,0),e.resolveAddress(H),e.emit(f.Integer,ee,-1,0,null,0,"SubIN: Set Final False/True"),e.emit(f.Goto,0,Ee+1,0,null,0),e.resolveAddress(Oe),e.emit(f.Integer,z,-1,0,null,0,"SubIN: Set Final True/False"),e.emit(f.Goto,0,Ee,0,null,0),e.resolveAddress(Ee),e.emit(f.Null,0,-1,0,null,0,"SubIN: Set Final NULL"),e.resolveAddress(e.getCurrentAddress()),e.emit(f.FrameLeave,0,0,0,null,0,"Leave SubIN Frame"),e.emit(f.Return,0,0,0,null,0,"Return from SubIN"),a={startAddress:h,correlation:o},e.subroutineDefs?.set(n,a),e.endSubroutineCompilation()}let i=e.allocateMemoryCells(1),c=e.allocateAddress(),u=e.allocateAddress();e.compileExpression(t,i),e.emit(f.IfNull,i,c,0,null,0,"IN: Check if Left Expr is NULL");let d=0;o.correlatedColumns.forEach((h,p)=>{let g=e.allocateMemoryCells(1),E=[...e.tableAliases.entries()].find(([N,C])=>C===h.outerCursor)?.[0],y=e.tableSchemas.get(h.outerCursor);if(!y)throw new Error(`Schema ${h.outerCursor} not found`);let w=y.columns[h.outerColumnIndex]?.name;if(!w)throw new Error(`Col ${h.outerColumnIndex} not found`);e.compileExpression({type:"column",name:w,table:E},g),e.emit(f.Push,g,0,0,null,0,`Push outer val ${w}`),d++}),e.emit(f.Push,i,0,0,null,0,"Push Left Value for SubIN"),d++,e.emit(f.Subroutine,d,a.startAddress,0,null,0,"Call SubIN");let l=e.stackPointer-1;e.emit(f.SCopy,l,r,0,null,0,"Copy SubIN result from stack"),e.emit(f.StackPop,d,0,0,null,0,"Pop SubIN args"),e.emit(f.Goto,0,u,0,null,0),e.resolveAddress(c),e.emit(f.Null,0,r,0,null,0,"IN: Set NULL Result"),e.resolveAddress(u)}function au(e,t,n,r,s){let o=Et(e,r,new Set(e.tableAliases.values()));o.isCorrelated?mm(e,t,n,r,s,o):hm(e,t,n,r,s)}function hm(e,t,n,r,s){let o=e.allocateMemoryCells(1),a=e.allocateMemoryCells(1),i=e.allocateAddress(),c=e.allocateAddress(),u=e.allocateAddress(),d;switch(e.compileExpression(t,o),e.emit(f.IfNull,o,i,0,null,0,"Skip compare if left is NULL"),e.compileScalarSubquery(r,a),e.emit(f.IfNull,a,i,0,null,0,"Skip compare if subquery is NULL"),n.toUpperCase()){case"=":case"==":case"IS":d=f.Eq;break;case"!=":case"<>":case"IS NOT":d=f.Ne;break;case"<":d=f.Lt;break;case"<=":d=f.Le;break;case">":d=f.Gt;break;case">=":d=f.Ge;break;default:throw new b(`Unsupported comparison operator with subquery: ${n}`,I.ERROR,void 0,r.loc?.start.line,r.loc?.start.column)}e.emit(d,a,c,o,null,0,"Compare Subquery Result"),e.emit(f.Integer,0,s,0,null,0,"Set comparison FALSE"),e.emit(f.Goto,0,u,0,null,0),e.resolveAddress(c),e.emit(f.Integer,1,s,0,null,0,"Set comparison TRUE"),e.emit(f.Goto,0,u,0,null,0),e.resolveAddress(i),e.emit(f.Null,0,s,0,null,0,"Set comparison NULL"),e.resolveAddress(u)}function mm(e,t,n,r,s,o){let a=e.subroutineDefs?.get(r);if(!a){let w=e.allocateMemoryCells(1);if(su(e,r,w,o),a=e.subroutineDefs?.get(r),!a)throw new Error("Internal: Failed to compile correlated scalar subquery subroutine.")}let i=e.allocateMemoryCells(1),c=e.allocateMemoryCells(1),u=e.allocateMemoryCells(1),d=e.allocateAddress(),l=e.allocateAddress(),h=e.allocateAddress();e.compileExpression(t,i),e.emit(f.IfNull,i,d,0,null,0,"Skip compare if left is NULL");let p=0;o.correlatedColumns.forEach(w=>{let N=e.allocateMemoryCells(1),C=[...e.tableAliases.entries()].find(([L,T])=>T===w.outerCursor)?.[0],S=e.tableSchemas.get(w.outerCursor);if(!S)throw new Error(`Schema ${w.outerCursor} not found`);let R=S.columns[w.outerColumnIndex]?.name;if(!R)throw new Error(`Col ${w.outerColumnIndex} not found`);e.compileExpression({type:"column",name:R,table:C},N),e.emit(f.Push,N,0,0,null,0,`Push outer val ${R}`),p++}),e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub Error Status"),p++,e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub Result"),p++,e.emit(f.Subroutine,p,a.startAddress,0,null,0,"Call correlated subquery for comparison");let g=e.stackPointer-1,E=e.stackPointer-2;e.emit(f.SCopy,g,c,0,null,0,`Copy sub result from stack[${g}]`),e.emit(f.SCopy,E,u,0,null,0,`Copy sub error from stack[${E}]`),e.emit(f.StackPop,p,0,0,null,0,"Pop subquery args/results"),e.emit(f.IfTrue,u,d,0,null,0,"Skip compare if subquery had error (>1 row)"),e.emit(f.IfNull,c,d,0,null,0,"Skip compare if subquery result is NULL (0 rows)");let y;switch(n.toUpperCase()){case"=":case"==":case"IS":y=f.Eq;break;case"!=":case"<>":case"IS NOT":y=f.Ne;break;case"<":y=f.Lt;break;case"<=":y=f.Le;break;case">":y=f.Gt;break;case">=":y=f.Ge;break;default:throw new b(`Unsupported comparison operator with subquery: ${n}`,I.ERROR,void 0,r.loc?.start.line,r.loc?.start.column)}e.emit(y,c,l,i,null,0,"Compare Left Expr with Sub Result"),e.emit(f.Integer,0,s,0,null,0,"Set comparison FALSE"),e.emit(f.Goto,0,h,0,null,0),e.resolveAddress(l),e.emit(f.Integer,1,s,0,null,0,"Set comparison TRUE"),e.emit(f.Goto,0,h,0,null,0),e.resolveAddress(d),e.emit(f.Null,0,s,0,null,0,"Set comparison NULL"),e.resolveAddress(h)}function iu(e,t,n){let r=Et(e,t,new Set(e.tableAliases.values()));r.isCorrelated?gm(e,t,n,r):pm(e,t,n)}function pm(e,t,n){let r=e.allocateAddress(),s=e.allocateAddress(),o=e.allocateAddress(),a=e.allocateAddress(),i=e.allocateAddress(),c=e.compileFromCore(t.from),u=c[0];if(u===void 0){if(t.where){let d=e.allocateMemoryCells(1);e.compileExpression(t.where,d),e.emit(f.IfFalse,d,s,0,null,0,"EXISTS: Check constant WHERE")}e.emit(f.Integer,1,n,0,null,0,"EXISTS: Literal/No-FROM subquery is TRUE"),e.emit(f.Goto,0,o,0,null,0),e.resolveAddress(s),e.emit(f.Integer,0,n,0,null,0,"EXISTS: Set FALSE (constant WHERE failed)"),e.resolveAddress(o);return}if(e.emit(f.VFilter,u,s,0,{idxNum:0,idxStr:null,nArgs:0},0,"EXISTS: Start scan"),e.resolveAddress(a),t.where){let d=e.allocateMemoryCells(1);e.compileExpression(t.where,d),e.emit(f.IfFalse,d,i,0,null,0,"EXISTS: Check WHERE, jump to VNext if false")}e.emit(f.Integer,1,n,0,null,0,"EXISTS: Set TRUE (found row)"),e.emit(f.Goto,0,o,0,null,0,"EXISTS: Finish (found row)"),e.resolveAddress(i),e.emit(f.VNext,u,s,0,null,0,"EXISTS: VNext"),e.emit(f.Goto,0,a,0,null,0,"EXISTS: Loop back"),e.resolveAddress(s),e.emit(f.Integer,0,n,0,null,0,"EXISTS: Set FALSE (no rows found)"),e.resolveAddress(o),e.closeCursorsUsedBySelect(c)}function gm(e,t,n,r){let s=e.subroutineDefs?.get(t);if(!s){e.startSubroutineCompilation();let i=e.getCurrentAddress(),c=2,u=new Map;r.correlatedColumns.forEach((E,y)=>{u.set(`${E.outerCursor}.${E.outerColumnIndex}`,-(y+1))});let d=e.compileFromCore(t.from),l=d[0],h=e.allocateAddress(),p=e.allocateAddress(),g=e.allocateAddress();if(e.emit(f.Integer,0,c,0,null,0,"SubEXISTS: Init result=0"),l===void 0){if(t.where){let E=e.allocateMemoryCells(1);e.compileExpression(t.where,E,r,void 0,u),e.emit(f.IfFalse,E,p,0,null,0,"SubEXISTS: Check const WHERE")}e.emit(f.Integer,1,c,0,null,0,"SubEXISTS: Set result=1 (const)")}else{if(e.emit(f.VFilter,l,p,0,{idxNum:0,idxStr:null,nArgs:0},0,"SubEXISTS: Start scan"),e.resolveAddress(h),t.where){let E=e.allocateMemoryCells(1);e.compileExpression(t.where,E,r,void 0,u),e.emit(f.IfFalse,E,g,0,null,0,"SubEXISTS: Check WHERE")}e.emit(f.Integer,1,c,0,null,0,"SubEXISTS: Set result=1 (row found)"),e.emit(f.Goto,0,p,0,null,0,"SubEXISTS: Exit loop early"),e.resolveAddress(g),e.emit(f.VNext,l,p,0,null,0,"SubEXISTS: VNext"),e.emit(f.Goto,0,h,0,null,0,"SubEXISTS: Loop back")}e.resolveAddress(p),e.closeCursorsUsedBySelect(d),e.emit(f.SCopy,c,-1,0,null,0,"SubEXISTS: Store result in Arg FP[-1]"),e.emit(f.FrameLeave,0,0,0,null,0,"Leave SubEXISTS Frame"),e.emit(f.Return,0,0,0,null,0,"Return from SubEXISTS"),s={startAddress:i,correlation:r},e.subroutineDefs?.set(t,s),e.endSubroutineCompilation()}let o=0;r.correlatedColumns.forEach(i=>{let c=e.allocateMemoryCells(1),u=[...e.tableAliases.entries()].find(([h,p])=>p===i.outerCursor)?.[0],d=e.tableSchemas.get(i.outerCursor);if(!d)throw new Error(`Schema ${i.outerCursor} not found`);let l=d.columns[i.outerColumnIndex]?.name;if(!l)throw new Error(`Col ${i.outerColumnIndex} not found`);e.compileExpression({type:"column",name:l,table:u},c),e.emit(f.Push,c,0,0,null,0,`Push outer val ${l}`),o++}),e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub EXISTS Result (Arg 0)"),o++,e.emit(f.Subroutine,o,s.startAddress,0,null,0,"Call SubEXISTS");let a=e.stackPointer-1;e.emit(f.SCopy,a,n,0,null,0,"Copy SubEXISTS result from stack"),e.emit(f.StackPop,o,0,0,null,0,"Pop SubEXISTS args")}function uu(e,t,n){let r=t.name.toLowerCase();if(console.log(`Compiling CTE: ${r}, Recursive Context: ${n}`),n&&lu(e,t,r)){console.log(`Compiling RECURSIVE CTE: ${r}`),wm(e,t);return}if(!n&&lu(e,t,r))throw new b(`Recursive CTE '${r}' used without 'RECURSIVE' keyword`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);console.log(`Compiling Non-Recursive CTE (Materializing): ${r}`),ym(e,t)}function ym(e,t){let n=t.name.toLowerCase(),r=is(e,["tableAliases","tableSchemas","ephemeralTables","cteMap","cursorPlanningInfo","resultColumns","columnAliases"]),s,o=-1,a;try{if(t.query.type==="select"){let i=Array.from(r.tableAliases?.values()??[]);a=e.compileSelectCore(t.query,i),o=e.allocateCursor();let c=a.columnMap.map((u,d)=>{let l=A.TEXT;u.expr?.type==="literal"&&(typeof u.expr.value=="number"&&(l=A.REAL),typeof u.expr.value=="bigint"&&(l=A.INTEGER),u.expr.value===null&&(l=A.NULL));let h=e.columnAliases[a.resultBaseReg+d]??`cte_col_${d}`;return{..._e(h),affinity:l}});s=e.createEphemeralSchema(o,a.numCols),s.columns=Object.freeze(c),s.columnIndexMap=Object.freeze(fe(c)),console.log(`CTE '${n}': Inferred ${a.numCols} columns for ephemeral table ${o}`)}else throw new b(`CTE query type '${t.query.type}' not yet supported for materialization`,I.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column)}finally{ls(e,r)}e.cteMap.set(n,{type:"materialized",cursorIdx:o,schema:s}),e.tableSchemas.set(o,s),e.ephemeralTables.set(o,s),e.emit(f.OpenWrite,o,s.columns.length,0,s,0,`OpenWrite Ephemeral CTE '${n}'`),Po(e,t.query,o,s),console.log(`Finished compiling materialized CTE: ${n}`)}function wm(e,t){let n=t.name.toLowerCase();if(t.query.type!=="select"||!t.query.union&&!t.query.unionAll)throw new b(`Recursive CTE '${n}' must use UNION or UNION ALL`,I.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column);let r={...t.query,union:void 0,unionAll:void 0},s=t.query.union;if(!s)throw new b(`Recursive CTE '${n}' is missing the recursive part after UNION ALL`,I.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column);let o=t.query.unionAll??!1,a=e.allocateCursor(),i=e.allocateCursor(),c=is(e,["tableAliases","tableSchemas","ephemeralTables","cteMap","cursorPlanningInfo","resultColumns","columnAliases"]),u,d,l;try{l=e.compileSelectCore(r,Array.from(c.tableAliases?.values()??[]));let y=[],w;if(!o){for(let C=0;C<l.numCols;C++)y.push({index:C,desc:!1});w={type:"sortkey",keyIndices:y.map(C=>C.index),directions:y.map(C=>C.desc)},console.log(`Recursive CTE '${n}': Using UNION (distinct), creating PK on all columns for Result table ${a}`)}u=e.createEphemeralSchema(a,l.numCols,w),d=e.createEphemeralSchema(i,l.numCols);let N=l.columnMap.map((C,S)=>{let R=A.TEXT;C.expr?.type==="literal"&&(typeof C.expr.value=="number"&&(R=A.REAL),typeof C.expr.value=="bigint"&&(R=A.INTEGER),C.expr.value===null&&(R=A.NULL));let L=e.columnAliases[l.resultBaseReg+S]??`cte_col_${S}`;return{..._e(L),affinity:R}});u.columns=Object.freeze(N),u.columnIndexMap=Object.freeze(fe(N)),d.columns=Object.freeze(N),d.columnIndexMap=Object.freeze(fe(N))}finally{ls(e,c)}e.cteMap.set(n,{type:"materialized",cursorIdx:a,schema:u}),e.tableSchemas.set(a,u),e.ephemeralTables.set(a,u),e.ephemeralTables.set(i,d),e.emit(f.OpenWrite,a,u.columns.length,0,u,0,`OpenWrite REC CTE Result '${n}'`),e.emit(f.OpenWrite,i,d.columns.length,0,d,0,`OpenWrite REC CTE Queue '${n}'`),console.log(`REC CTE '${n}': Compiling initial term...`),Po(e,r,a,u,!0,i,d,!0),console.log(`REC CTE '${n}': Compiling recursive loop...`);let h=e.getCurrentAddress(),p=e.allocateAddress(),g=e.allocateAddress();e.emit(f.Rewind,i,g,0,null,0,"REC CTE: Rewind Queue"),e.resolveAddress(p),e.emit(f.VNext,i,g,0,null,0,"REC CTE: VNext Queue");let E=is(e,["tableAliases","tableSchemas","cteMap","ephemeralTables","cursorPlanningInfo"]);try{e.cteMap.set(n,{type:"materialized",cursorIdx:i,schema:d}),e.tableAliases.set(n,i),e.tableSchemas.set(i,d),console.log(`REC CTE '${n}': Mapping self-reference to QUEUE cursor ${i}`),Po(e,s,a,u,!0,i,d,o)}finally{console.log(`REC CTE '${n}': Restoring state after recursive step compilation.`),ls(e,E)}e.emit(f.Goto,0,p,0,null,0,"REC CTE: Loop back"),e.resolveAddress(g),e.emit(f.Close,i,0,0,null,0,`Close REC CTE Queue '${n}'`),e.ephemeralTables.delete(i),console.log(`Finished compiling recursive CTE: ${n}`)}function Po(e,t,n,r,s=!1,o,a,i=!0){let c=is(e,["tableAliases","tableSchemas","ephemeralTables","cursorPlanningInfo"]),u=0,d=0,l=[];try{l=e.compileFromCore(t.from);let h=new Set(Array.from(e.tableAliases.values()));l.forEach(T=>{let O=e.tableSchemas.get(T);O&&e.planTableAccess(T,O,t,h)});let p=[],g=[],E=e.allocateAddress(),y=new Set;l.length===0?e.resolveAddress(E):l.forEach((T,O)=>{if(!e.tableSchemas.get(T))throw new Error(`Internal: Schema missing for query cursor ${T}`);let $=e.allocateAddress(),z=e.allocateAddress();p.push($),g.push(z);let ee=e.cursorPlanningInfo.get(T),H={idxNum:0,idxStr:null,nArgs:0},Ee=0;if(ee&&ee.idxNum!==0){let Oe=[];ee.usage.forEach((ce,xt)=>{if(ce.argvIndex>0){let nn=ee.constraintExpressions?.get(xt);if(!nn)throw new b(`Internal error: Missing expression for constraint ${xt} used in CTE pop VFilter`,I.INTERNAL);for(;Oe.length<ce.argvIndex;)Oe.push(null);Oe[ce.argvIndex-1]={constraintIdx:xt,expr:nn}}});let ie=Oe.filter(ce=>ce!==null);ie.length>0&&(Ee=e.allocateMemoryCells(ie.length),ie.forEach((ce,xt)=>{let nn=Et(e,ce.expr,y);e.compileExpression(ce.expr,Ee+xt,nn)})),H={idxNum:ee.idxNum,idxStr:ee.idxStr,nArgs:ie.length}}e.emit(f.VFilter,T,z,Ee,H,0,`Populate Ephemeral: Scan Cursor ${O}`),e.resolveAddress($),e.verifyWhereConstraints(T,z),y.add(T),O===l.length-1&&e.resolveAddress(E)});let w=e.allocateAddress();rn(e,t.where,l,w);let N=e.compileSelectCore(t,Array.from(y));if(u=N.resultBaseReg,d=N.numCols,d!==r.columns.length)throw new b(`CTE column count mismatch during population: expected ${r.columns.length}, got ${d}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let C=e.allocateMemoryCells(d+1);e.emit(f.Null,0,C,0,null,0,"Populate Eph: Rowid=NULL"),e.emit(f.Move,u,C+1,d,null,0,"Populate Eph: Copy Result");let S=i?W.ABORT:W.IGNORE,R={table:r,onConflict:S},L=e.allocateMemoryCells(1);if(e.emit(f.Integer,-1,L,0,null,0,"Populate Eph: Init target rowid check"),e.emit(f.VUpdate,d+1,C,L,R,0,`Populate Eph: Insert Target ${n}`),s&&o!==void 0&&a){let T=e.allocateAddress();i||e.emit(f.IfNull,L,T,0,null,0,"Populate Eph: Skip queue if target insert ignored");let O={table:a,onConflict:W.ABORT};e.emit(f.VUpdate,d+1,C,0,O,0,`Populate Eph: Insert Queue ${o}`),e.resolveAddress(T)}if(e.resolveAddress(w),l.length>0)for(let T=l.length-1;T>=0;T--){let O=l[T],x=p[T],$=g[T];e.emit(f.Goto,0,x-1,0,null,0,`Populate Eph: Goto VNext ${T}`),e.resolveAddress($),y.delete(O)}}finally{e.closeCursorsUsedBySelect(l),ls(e,c)}}function is(e,t){let n={};for(let r of t){let s=e[r];s instanceof Map?n[r]=new Map(s):Array.isArray(s)?n[r]=[...s]:n[r]=s}return n}function ls(e,t){for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}function lu(e,t,n){if(t.query.type!=="select")return!1;let r=t.query;if(r.union){let s=o=>{if(!o)return!1;if(o.type==="table"){if(o.table.name.toLowerCase()===n.toLowerCase())return!0}else if(o.type==="join")return s(o.left)||s(o.right);return!1};return r.union.from?.some(s)??!1}return!1}var Rn=class{db;sql="";constants=[];instructions=[];numMemCells=0;currentFrameLocals=0;numCursors=0;parameters=new Map;columnAliases=[];cteMap=new Map;tableSchemas=new Map;tableAliases=new Map;ephemeralTables=new Map;resultColumns=[];cursorPlanningInfo=new Map;subroutineCode=[];subroutineDefs=new Map;subroutineDepth=0;currentFrameEnterInsn=null;maxLocalOffsetInCurrentFrame=0;stackPointer=0;framePointer=0;outerCursors=[];constructor(t){this.db=t}compile(t,n){try{this.sql=n,this.constants=[],this.instructions=[],this.numMemCells=0,this.numCursors=0,this.parameters=new Map,this.columnAliases=[],this.cteMap=new Map,this.tableSchemas=new Map,this.tableAliases=new Map,this.ephemeralTables=new Map,this.resultColumns=[],this.cursorPlanningInfo=new Map,this.subroutineCode=[],this.subroutineDefs=new Map,this.subroutineDepth=0,this.currentFrameLocals=0,this.currentFrameEnterInsn=null,this.maxLocalOffsetInCurrentFrame=0,this.stackPointer=0,this.framePointer=0,this.outerCursors=[],this.emit(f.Init,0,1,0,null,0,"Start of program");let r;switch("withClause"in t&&t.withClause!==void 0&&(r=t.withClause,this.compileWithClause(r)),t.type){case"select":this.compileSelect(t);break;case"insert":this.compileInsert(t);break;case"update":this.compileUpdate(t);break;case"delete":this.compileDelete(t);break;case"createTable":this.compileCreateTable(t);break;case"createIndex":this.compileCreateIndex(t);break;case"createView":this.compileCreateView(t);break;case"drop":this.compileDrop(t);break;case"alterTable":this.compileAlterTable(t);break;case"begin":this.compileBegin(t);break;case"commit":this.compileCommit(t);break;case"rollback":this.compileRollback(t);break;case"savepoint":this.compileSavepoint(t);break;case"release":this.compileRelease(t);break;case"pragma":this.compilePragma(t);break;default:throw new b(`Unsupported statement type: ${t.type}`,I.ERROR)}return this.subroutineCode.length>0&&(this.instructions.push(...this.subroutineCode),this.subroutineCode=[]),this.emit(f.Halt,I.OK,0,0,null,0,"End of program"),{instructions:this.instructions,constants:this.constants,numMemCells:this.numMemCells+1,numCursors:this.numCursors,parameters:this.parameters,columnNames:this.columnAliases,sql:this.sql}}catch(r){throw r instanceof Xr?new b(r.message,I.ERROR,r,r.line,r.column):r instanceof b?r:new b(`Unexpected compiler error: ${r instanceof Error?r.message:String(r)}`,I.INTERNAL,r instanceof Error?r:void 0)}}startSubroutineCompilation(){this.subroutineDepth++,this.maxLocalOffsetInCurrentFrame=0;let t=Sn(f.FrameEnter,0,0,0,null,0,`Enter Subroutine Frame Depth ${this.subroutineDepth}`);this.subroutineCode.push(t);let n=this.subroutineCode.length-1;return this.currentFrameEnterInsn=t,n}endSubroutineCompilation(){if(this.subroutineDepth>0){if(this.currentFrameEnterInsn){let t=this.maxLocalOffsetInCurrentFrame+1;this.currentFrameEnterInsn.p1=t,this.currentFrameEnterInsn=null}else console.error("Compiler Error: Mismatched start/endSubroutineCompilation or missing FrameEnter tracking.");this.subroutineDepth--}else console.warn("Attempted to end subroutine compilation at depth 0")}allocateMemoryCells(t){return Sl(this,t)}allocateCursor(){return Al(this)}addConstant(t){return Rl(this,t)}emit(t,n,r,s,o,a,i){return Tl(this,t,n,r,s,o,a,i)}allocateAddress(){return vl(this)}resolveAddress(t){Ll(this,t)}getCurrentAddress(){return Ol(this)}createEphemeralSchema(t,n,r){return Ml(this,t,n,r)}closeCursorsUsedBySelect(t){Dl(this,t)}compileFromCore(t){return Kl(this,t)}planTableAccess(t,n,r,s){ql(this,t,n,r,s)}verifyWhereConstraints(t,n){Gl(this,t,n)}compileExpression(t,n,r,s,o){Yl(this,t,n,r,s,o)}compileLiteral(t,n){on(this,t.value,n)}compileColumn(t,n,r,s,o){fr(this,t,n,r,s,o)}compileBinary(t,n,r,s,o){ts(this,t,n,r,s,o)}compileUnary(t,n,r,s,o){ns(this,t,n,r,s,o)}compileCast(t,n,r,s,o){rs(this,t,n,r,s,o)}compileCollate(t,n,r,s,o){as(this,t,n,r,s,o)}compileFunction(t,n,r,s,o){ss(this,t,n,r,s,o)}compileParameter(t,n){os(this,t,n)}compileSubquery(t,n){nu(this,t,n)}compileScalarSubquery(t,n){ru(this,t,n)}compileInSubquery(t,n,r,s){ou(this,t,n,r,s)}compileComparisonSubquery(t,n,r,s){au(this,t,n,r,s)}compileExistsSubquery(t,n){iu(this,t,n)}compileSelect(t){eu(this,t)}compileInsert(t){Wl(this,t)}compileUpdate(t){zl(this,t)}compileDelete(t){Hl(this,t)}compileCreateTable(t){Pl(this,t)}compileCreateIndex(t){kl(this,t)}compileCreateView(t){Fl(this,t)}compileDrop(t){Ul(this,t)}compileAlterTable(t){$l(this,t)}compileBegin(t){Bl(this,t)}compileCommit(t){_l(this,t)}compileRollback(t){Zl(this,t)}compileSavepoint(t){Xl(this,t)}compileRelease(t){Jl(this,t)}compileSelectCore(t,n,r,s){return tu(this,t,n,r,s)}compileWithClause(t){if(t){console.log(`Compiling WITH${t.recursive?" RECURSIVE":""} clause...`);for(let n of t.ctes){let r=n.name.toLowerCase();if(this.cteMap.has(r))throw new b(`Duplicate CTE name: '${n.name}'`,I.ERROR);uu(this,n,t.recursive)}console.log("Finished compiling WITH clause.")}}compilePragma(t){Vl(this,t)}};var us=new Map,ko=(e,t)=>e<t?-1:e>t?1:0,fu=(e,t)=>{let n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:0},du=(e,t)=>{let n=e.length,r=t.length;for(;n>0&&e[n-1]===" ";)n--;for(;r>0&&t[r-1]===" ";)r--;let s=Math.min(n,r);for(let o=0;o<s;o++)if(e[o]!==t[o])return e[o]<t[o]?-1:1;return n-r};function dr(e,t){let n=e.toUpperCase();us.has(n)&&console.warn(`Overwriting existing collation: ${n}`),us.set(n,t)}function hu(e){return us.get(e.toUpperCase())}function Fo(e){if(e==null)return!1;switch(typeof e){case"boolean":return e;case"number":return e!==0;case"bigint":return e!==0n;case"string":return e.length>0;case"object":return e instanceof Uint8Array,!1;default:return!1}}var Ne;(function(e){e[e.NULL=0]="NULL",e[e.NUMERIC=1]="NUMERIC",e[e.TEXT=2]="TEXT",e[e.BLOB=3]="BLOB",e[e.UNKNOWN=99]="UNKNOWN"})(Ne||(Ne={}));function cu(e){if(e==null)return Ne.NULL;let t=typeof e;return t==="number"||t==="bigint"||t==="boolean"?Ne.NUMERIC:t==="string"?Ne.TEXT:t==="object"&&e instanceof Uint8Array?Ne.BLOB:Ne.UNKNOWN}function de(e,t,n="BINARY"){let r=cu(e),s=cu(t);if(r===Ne.NULL&&s===Ne.NULL)return 0;if(r===Ne.NULL)return-1;if(s===Ne.NULL)return 1;if(r!==s)return r-s;let o=typeof e=="boolean"?e?1:0:e,a=typeof t=="boolean"?t?1:0:t;switch(r){case Ne.NUMERIC:return o<a?-1:o>a?1:0;case Ne.TEXT:let i=us.get(n.toUpperCase());return i?i(o,a):(console.warn(`Unknown collation requested: ${n}. Falling back to BINARY.`),ko(o,a));case Ne.BLOB:let c=o,u=a,d=Math.min(c.length,u.length);for(let l=0;l<d;l++)if(c[l]!==u[l])return c[l]<u[l]?-1:1;return c.length<u.length?-1:c.length>u.length?1:0;default:return 0}}function mu(e){if(e=e.trim(),!e)return null;let t=e.startsWith("-")?-1:(e.startsWith("+"),1);t!==1&&(e=e.substring(1));let n="";for(let r=0;r<e.length&&(e[r]>="0"&&e[r]<="9");r++)n+=e[r];if(!n)return null;try{let r=BigInt(n)*BigInt(t);return r>=Number.MIN_SAFE_INTEGER&&r<=Number.MAX_SAFE_INTEGER?Number(r):r}catch{return null}}function Uo(e){if(e=e.trim(),!e)return null;let t=parseFloat(e);return isNaN(t)?null:t}function $o(e){if(e===null||typeof e=="bigint")return e;if(typeof e=="number"){let t=Math.trunc(e);if(t>=Number.MIN_SAFE_INTEGER&&t<=Number.MAX_SAFE_INTEGER)return t;try{return BigInt(t)}catch{return e}}if(typeof e=="string"){let t=mu(e);if(t!==null)return t;let n=Uo(e);return n!==null?$o(n):null}return e instanceof Uint8Array?null:e}function pu(e){return e===null?null:typeof e=="number"||typeof e=="bigint"?Number(e):typeof e=="string"?Uo(e):e instanceof Uint8Array?null:e}function gu(e){if(e===null||typeof e=="number"||typeof e=="bigint")return e;if(typeof e=="string"){let t=mu(e);if(t!==null)return t;let n=Uo(e);return n!==null?n:e}return e instanceof Uint8Array,e}function Eu(e){return e===null||typeof e=="string"?e:typeof e=="number"||typeof e=="bigint"?String(e):e instanceof Uint8Array?e:String(e)}function yu(e){return e}var yt=class{_result=void 0;_result_set=!1;_error=null;_subtype=0;userData;db;auxData=new Map;_aggregateContext=void 0;constructor(t,n){this.db=t,this.userData=n}_getResult(){if(this._error)throw this._error;return this._result_set?this._result:null}_getError(){return this._error}_getSubtype(){return this._subtype}_clear(){this._result=void 0,this._result_set=!1,this._error=null,this._subtype=0}_setAggregateContextRef(t){this._aggregateContext=t}_getAggregateContextRef(){return this._aggregateContext}setResult(t){this._result_set||this._error||(this._result=t,this._result_set=!0)}resultBlob(t){this.setResult(t)}resultDouble(t){this.setResult(t)}resultError(t,n=I.ERROR){this._result_set||this._error||(this._error=new b(t,n))}resultInt(t){this.setResult(Math.trunc(t))}resultInt64(t){this.setResult(t)}resultNull(){this.setResult(null)}resultText(t){this.setResult(t)}resultValue(t){this.setResult(t)}resultZeroblob(t){this.setResult(new Uint8Array(t))}resultSubtype(t){this._subtype=t>>>0}getUserData(){return this.userData}getDbConnection(){return this.db}getAuxData(t){return this.auxData.get(t)?.data}setAuxData(t,n,r){if(this._error)return;let s=this.auxData.get(t);if(s?.destructor&&s.data!==n)try{s.destructor(s.data)}catch(o){console.error("Internal: AuxData destructor failed",o)}n===void 0&&r===void 0?this.auxData.delete(t):this.auxData.set(t,{data:n,destructor:r})}getAggregateContext(t=!1){return this._aggregateContext===void 0&&t?{}:this._aggregateContext}setAggregateContext(t){this._aggregateContext=t}_cleanupAuxData(){this.auxData.forEach(t=>{if(t.destructor)try{t.destructor(t.data)}catch(n){console.error("Internal: AuxData destructor failed",n)}}),this.auxData.clear()}};var Ve=class{module;db;tableName;schemaName;errorMessage;tableSchema;constructor(t,n,r,s){this.db=t,this.module=n,this.schemaName=r,this.tableName=s}setErrorMessage(t){this.errorMessage=t}};var Ke=class{table;constructor(t){this.table=t}};var wt=class{static lockQueues=new Map;static async acquire(t){let n=this.lockQueues.get(t)??Promise.resolve(),r,s=new Promise(a=>{r=a});return this.lockQueues.set(t,s),await n,()=>{r(),this.lockQueues.get(t)===s&&this.lockQueues.delete(t)}}};var hr=jh(Ko(),1);var zo=class extends Ke{mergedResults=[];currentIndex=-1;isEof=!0;constructor(t){super(t)}reset(){this.mergedResults=[],this.currentIndex=-1,this.isEof=!0}getCurrentRow(){return this.isEof||this.currentIndex<0||this.currentIndex>=this.mergedResults.length?null:this.mergedResults[this.currentIndex]}getCurrentRowId(){return this.getCurrentRow()?._rowid_??null}setResults(t){this.mergedResults=t,this.currentIndex=-1,this.isEof=this.mergedResults.length===0,this.isEof||this.advance()}advance(){this.currentIndex>=this.mergedResults.length-1?(this.isEof=!0,this.currentIndex=this.mergedResults.length):(this.currentIndex++,this.isEof=!1)}eof(){return this.isEof}},mr=class extends Ve{columns=[];primaryKeyColumnIndices=[];keyFromEntry=t=>t._rowid_;compareKeys=de;data=null;nextRowid=BigInt(1);readOnly;rowidToKeyMap=null;isSorter=!1;tableSchema=void 0;inTransaction=!1;pendingInserts=null;pendingUpdates=null;pendingDeletes=null;savepoints=[];constructor(t,n,r,s,o=!1){super(t,n,r,s),this.readOnly=o}setColumns(t,n){if(this.columns=[...t],n.length===0)console.log(`MemoryTable '${this.tableName}': Using rowid as BTree key.`),this.keyFromEntry=r=>r._rowid_,this.compareKeys=(r,s)=>de(r,s),this.rowidToKeyMap=null;else if(n.length===1){let{index:r,desc:s}=n[0],o=this.columns[r]?.name,a=this.columns[r]?.collation||"BINARY";o?(console.log(`MemoryTable '${this.tableName}': Using PRIMARY KEY column '${o}' (index ${r}, ${s?"DESC":"ASC"}) as BTree key.`),this.primaryKeyColumnIndices=Object.freeze([r]),this.keyFromEntry=i=>i[o],this.compareKeys=(i,c)=>{let u=de(i,c,a);return s?-u:u},this.rowidToKeyMap=new Map):(console.error(`MemoryTable '${this.tableName}': Invalid primary key index ${r}. Falling back to rowid key.`),this.keyFromEntry=i=>i._rowid_,this.compareKeys=(i,c)=>de(i,c),this.rowidToKeyMap=null)}else{let r=n.map(s=>({name:this.columns[s.index]?.name,desc:s.desc,collation:this.columns[s.index]?.collation||"BINARY"}));if(r.some(s=>!s.name))console.error(`MemoryTable '${this.tableName}': Invalid composite primary key indices. Falling back to rowid key.`),this.keyFromEntry=s=>s._rowid_,this.compareKeys=(s,o)=>de(s,o),this.rowidToKeyMap=null;else{let s=r.map(o=>o.name);console.log(`MemoryTable '${this.tableName}': Using Composite PRIMARY KEY (${r.map(o=>`${o.name} ${o.desc?"DESC":"ASC"}`).join(", ")}) as BTree key.`),this.keyFromEntry=o=>s.map(a=>o[a]),this.compareKeys=(o,a)=>this.compareCompositeKeysWithOrder(o,a,r.map(i=>i.desc),r.map(i=>i.collation)),this.rowidToKeyMap=new Map}}this.data=new hr.BTree(this.keyFromEntry,this.compareKeys)}compareCompositeKeysWithOrder(t,n,r,s=[]){let o=t,a=n,i=Math.min(o.length,a.length);for(let c=0;c<i;c++){let u=r[c]?-1:1,d=s[c]||"BINARY",l=de(o[c],a[c],d)*u;if(l!==0)return l}return o.length-a.length}getRowByBTreeKey(t){if(!this.data)return null;let n=this.data.find(t);return n.on?this.data.at(n)??null:null}findPathByRowid(t){if(!this.data)return null;if(!this.rowidToKeyMap&&this.columns.length>0)return console.error(`MemoryTable ${this.tableName}: Attempt to find by rowid without rowidToKeyMap on a keyed table.`),null;if(this.rowidToKeyMap){let n=this.rowidToKeyMap.get(t);if(n===void 0)return null;let r=this.data.find(n);return r.on&&this.data.at(r)?._rowid_===t?r:null}else{let n=this.data.find(t);return n.on?n:null}}addRow(t){if(!this.data)throw new Error("MemoryTable BTree not initialized.");let n=this.nextRowid,r={...t,_rowid_:n},s=this.keyFromEntry(r),o=!1;if(this.data.get(s)!==void 0&&(o=!0),!o&&this.inTransaction){if(this.pendingInserts?.has(s))o=!0;else if(this.pendingUpdates){for(let a of this.pendingUpdates.values())if(this.compareKeys(a.newKey,s)===0){o=!0;break}}}if(o)return{};this.nextRowid++;try{if(this.inTransaction){if(this.pendingInserts||(this.pendingInserts=new Map),this.pendingDeletes){for(let[a,i]of this.pendingDeletes.entries())if(this.compareKeys(i.oldKey,s)===0){this.pendingDeletes.delete(a);break}}this.pendingInserts.set(s,r)}else this.data.insert(r),this.rowidToKeyMap&&this.rowidToKeyMap.set(n,s);return{rowid:n}}catch(a){throw this.nextRowid=n,new b(`Internal BTree error during insert: ${a.message}`,I.INTERNAL)}}updateRow(t,n){if(!this.data)throw new Error("MemoryTable BTree not initialized.");let r,s,o=null,a=!1;if(this.inTransaction){let d=this.pendingUpdates?.get(t);if(d)r=d.newRow,s=d.newKey;else for(let[l,h]of this.pendingInserts?.entries()??[])if(h._rowid_===t){r=h,s=l,a=!0;break}if(this.pendingDeletes?.has(t))return!1}if(!r){if(o=this.findPathByRowid(t),!o||(r=this.data.at(o),!r))return!1;s=this.keyFromEntry(r)}if(!s)throw new Error("Old key not found during update");let i={...r,...n,_rowid_:t},c=this.keyFromEntry(i),u=this.compareKeys(c,s)!==0;if(u){let d=!1;if(this.data.get(c)!==void 0&&(d=!0),!d&&this.inTransaction){if(this.pendingInserts?.has(c))d=!0;else if(this.pendingUpdates){for(let l of this.pendingUpdates.values())if(l.newRow._rowid_!==t&&this.compareKeys(l.newKey,c)===0){d=!0;break}}}if(d){let l=this.getPkColNames()??"rowid";throw new Ze(`UNIQUE constraint failed: ${this.tableName}.${l}`)}}try{if(this.inTransaction){if(this.pendingUpdates||(this.pendingUpdates=new Map),a)this.pendingInserts?.set(c,i),u&&this.pendingInserts?.delete(s);else{let d=this.pendingUpdates.has(t)?this.pendingUpdates.get(t).oldRow:r;this.pendingUpdates.set(t,{oldRow:d,newRow:i,oldKey:s,newKey:c})}return!0}else if(u){if(o||(o=this.data.find(s)),!o||!o.on)throw new Error("Cannot find original row path for key change update");return this.data.deleteAt(o),this.rowidToKeyMap&&this.rowidToKeyMap.delete(t),this.data.insert(i),this.rowidToKeyMap&&this.rowidToKeyMap.set(t,c),!0}else{if(o||(o=this.data.find(s)),!o||!o.on)throw new Error("Cannot find original row path for same key update");return this.data.updateAt(o,i),!0}}catch(d){if(d instanceof Ze)throw d;if(console.error("Failed to update row:",d),!this.inTransaction&&u)try{o&&this.data.deleteAt(o),this.data.insert(r),this.rowidToKeyMap&&this.rowidToKeyMap.set(t,s)}catch{}throw new b(`Internal BTree error during update: ${d instanceof Error?d.message:String(d)}`,I.INTERNAL)}}deleteRow(t){if(!this.data)throw new Error("MemoryTable BTree not initialized.");if(this.inTransaction){let n=!1;if(this.pendingInserts){for(let[i,c]of this.pendingInserts.entries())if(c._rowid_===t){this.pendingInserts.delete(i),n=!0;break}}if(n)return!0;let r=this.pendingUpdates?.get(t);if(r)return this.pendingDeletes||(this.pendingDeletes=new Map),this.pendingDeletes.set(t,{oldRow:r.oldRow,oldKey:r.oldKey}),this.pendingUpdates?.delete(t),!0;let s=this.findPathByRowid(t);if(!s)return!1;let o=this.data.at(s);if(!o)return!1;let a=this.keyFromEntry(o);return this.pendingDeletes||(this.pendingDeletes=new Map),this.pendingDeletes.set(t,{oldRow:o,oldKey:a}),!0}else{let n=this.findPathByRowid(t);if(!n)return!1;try{return this.data.deleteAt(n),this.rowidToKeyMap&&this.rowidToKeyMap.delete(t),!0}catch(r){return console.error("BTree deleteAt failed:",r),!1}}}clear(){this.data&&(this.data=new hr.BTree(this.keyFromEntry,this.compareKeys)),this.rowidToKeyMap&&this.rowidToKeyMap.clear(),this.nextRowid=BigInt(1)}get size(){return this.data?.getCount()??0}getRowIds(){if(!this.data)return[];let t=[];for(let n of this.data.ascending(this.data.first())){let r=this.data.at(n);r&&t.push(r._rowid_)}return t}getAllRows(){if(!this.data)return[];let t=[];for(let n of this.data.ascending(this.data.first())){let r=this.data.at(n);r&&t.push(r)}return t}isReadOnly(){return this.readOnly}getPkColNames(){return this.primaryKeyColumnIndices.length===0?null:this.primaryKeyColumnIndices.map(t=>this.columns[t]?.name??"?").join(", ")}createSavepoint(t){if(this.inTransaction){for(;this.savepoints.length<t;){console.warn(`MemoryTable ${this.tableName}: Filling missing savepoint index ${this.savepoints.length}`);let n=this.savepoints.length>0?this.savepoints[this.savepoints.length-1]:this.createBufferSnapshot();this.savepoints.push(n)}this.savepoints[t]=this.createBufferSnapshot(),console.log(`MemoryTable ${this.tableName}: Created savepoint at index ${t}`)}}releaseSavepoint(t){this.inTransaction&&t>=0&&t<this.savepoints.length&&(this.savepoints.length=t,console.log(`MemoryTable ${this.tableName}: Released savepoints from index ${t}`))}rollbackToSavepoint(t){if(!this.inTransaction)return;if(t<0||t>=this.savepoints.length){console.error(`MemoryTable ${this.tableName}: Invalid savepoint index ${t} for rollback.`);return}let n=this.savepoints[t];this.pendingInserts=new Map(n.inserts),this.pendingUpdates=new Map(n.updates),this.pendingDeletes=new Map(n.deletes),this.savepoints.length=t+1,console.log(`MemoryTable ${this.tableName}: Rolled back to savepoint index ${t}`)}createBufferSnapshot(){return{inserts:new Map(this.pendingInserts??[]),updates:new Map(this.pendingUpdates??[]),deletes:new Map(this.pendingDeletes??[])}}_configureAsSorter(t){if(this.isSorter){console.warn(`MemoryTable ${this.tableName}: Already configured as sorter.`);return}console.log(`MemoryTable ${this.tableName}: Configuring BTree for sorting with keys:`,t.keyIndices,"directions:",t.directions);let n=this.columns.map(o=>o.name),r=o=>{let a=t.keyIndices.map(i=>{let c=n[i];return c?o[c]:null});return a.push(o._rowid_),a},s=(o,a)=>{let i=o,c=a,u=Math.min(i.length,c.length)-1;for(let h=0;h<u;h++){let p=t.directions[h]?-1:1,g=t.collations?.[h]||"BINARY",E=de(i[h],c[h],g)*p;if(E!==0)return E}let d=i[u],l=c[u];return de(d,l)};this.keyFromEntry=r,this.compareKeys=s,this.isSorter=!0,this.data=new hr.BTree(r,s),this.rowidToKeyMap=null}},Pt=class{static SCHEMA_VERSION=1;tables=new Map;constructor(){}xCreate(t,n,r,s,o,a){console.log(`MemoryTableModule xCreate: Creating table ${s}.${o}`);let i=new mr(t,this,s,o,a.readOnly??!1);i.setColumns(a.columns,a.primaryKey??[]);let c={name:o,schemaName:s,columns:i.columns.map((u,d)=>({name:u.name,affinity:u.type,notNull:!1,primaryKey:a.primaryKey?.some(l=>l.index===d)??!1,pkOrder:(a.primaryKey?.findIndex(l=>l.index===d)??-1)+1,defaultValue:null,collation:u.collation??"BINARY",hidden:!1,generated:!1})),columnIndexMap:fe(i.columns.map(u=>u)),primaryKeyDefinition:a.primaryKey??[],checkConstraints:a.checkConstraints??[],isVirtual:!0,vtabModule:this,vtabInstance:i,vtabAuxData:n,vtabArgs:[],vtabModuleName:r};return i.tableSchema=Object.freeze(c),i}xConnect(t,n,r,s,o,a){console.log(`MemoryTableModule xConnect: Connecting to table ${s}.${o}`);let i=this.tables.get(`${s}.${o}`.toLowerCase());if(i)return i;throw new b(`Internal error: Attempted to connect to non-existent memory table ${s}.${o}`,I.INTERNAL)}async xDisconnect(t){console.log(`Memory table '${t.tableName}' disconnected`)}async xDestroy(t){t.clear();let n=`${t.schemaName.toLowerCase()}.${t.tableName.toLowerCase()}`;this.tables.delete(n),console.log(`Memory table '${t.tableName}' destroyed`)}async xOpen(t){return t.data||(t.data=new hr.BTree(t.keyFromEntry,t.compareKeys)),new zo(t)}async xClose(t){t.reset()}xBestIndex(t,n){if(t.isSorter)return n.idxNum=0,n.estimatedCost=1,n.estimatedRows=BigInt(t.size||1),n.orderByConsumed=!0,n.idxFlags=0,n.aConstraintUsage=Array.from({length:n.nConstraint},()=>({argvIndex:0,omit:!1})),n.idxStr="sortplan",I.OK;let r=Array.from({length:n.nConstraint},()=>({argvIndex:0,omit:!1})),s=t.primaryKeyColumnIndices,o=s.length===0,a=1,i=t.size||1,c={FULL_ASC:0,KEY_EQ:1,KEY_RANGE_ASC:2,FULL_DESC:3,KEY_RANGE_DESC:4},u={idxNum:c.FULL_ASC,cost:i*10,rows:BigInt(i),usedConstraintIndices:new Set,boundConstraintIndices:{lower:-1,upper:-1},orderByConsumed:!1,isDesc:!1,lowerBoundOp:null,upperBoundOp:null},d=new Map,l=s.length>0;for(let N=0;N<n.nConstraint;N++){let C=n.aConstraint[N];if(C.op===F.EQ&&C.usable)if(o&&C.iColumn===-1){d.set(-1,N);break}else s.includes(C.iColumn)&&d.set(C.iColumn,N)}if(s.length>0){for(let N of s)if(!d.has(N)){l=!1;break}}else l=d.has(-1);if(l){let N=Math.log2(i+1)+1,C=BigInt(1);if(N<u.cost){let S=new Set(d.values());u={...u,idxNum:c.KEY_EQ,cost:N,rows:C,usedConstraintIndices:S,orderByConsumed:!0}}}let h=s[0]??-1,p=null,g=null;for(let N=0;N<n.nConstraint;N++){let C=n.aConstraint[N];C.iColumn===h&&C.usable&&(C.op===F.GT||C.op===F.GE?(!p||C.op>p.op)&&(p={index:N,op:C.op}):(C.op===F.LT||C.op===F.LE)&&(!g||C.op<g.op)&&(g={index:N,op:C.op}))}if(p||g){let N=BigInt(Math.max(1,Math.floor(i/4))),C=Math.log2(i+1)*2+Number(N);if(C<u.cost){let S=new Set;p&&S.add(p.index),g&&S.add(g.index),u={...u,idxNum:c.KEY_RANGE_ASC,cost:C,rows:N,usedConstraintIndices:S,boundConstraintIndices:{lower:p?.index??-1,upper:g?.index??-1},lowerBoundOp:p?.op??null,upperBoundOp:g?.op??null}}}let E=!1,y=!1;n.nOrderBy===s.length&&s.length>0?(E=s.every((N,C)=>n.aOrderBy[C].iColumn===N&&n.aOrderBy[C].desc===n.aOrderBy[0].desc),E&&(y=n.aOrderBy[0].desc)):n.nOrderBy===1&&o&&n.aOrderBy[0].iColumn===-1&&(E=!0,y=n.aOrderBy[0].desc),E&&(u.idxNum===c.FULL_ASC||u.idxNum===c.KEY_RANGE_ASC)&&(u.orderByConsumed=!0,u.isDesc=y,u.idxNum===c.FULL_ASC?(u.idxNum=y?c.FULL_DESC:c.FULL_ASC,u.cost*=.9):(u.idxNum=y?c.KEY_RANGE_DESC:c.KEY_RANGE_ASC,u.cost*=.9)),n.idxNum=u.idxNum,n.estimatedCost=u.cost,n.estimatedRows=u.rows,n.orderByConsumed=u.orderByConsumed,n.idxFlags=u.idxNum===c.KEY_EQ?1:0,a=1,u.usedConstraintIndices.forEach(N=>{r[N].argvIndex=a++,r[N].omit=!0}),n.aConstraintUsage=r;let w=[`plan=${u.idxNum}`];return u.orderByConsumed&&w.push(`order=${u.isDesc?"DESC":"ASC"}`),u.lowerBoundOp&&w.push(`lb_op=${u.lowerBoundOp}`),u.upperBoundOp&&w.push(`ub_op=${u.upperBoundOp}`),u.usedConstraintIndices.size>0&&w.push(`constraints=[${[...u.usedConstraintIndices].join(",")}]`),n.idxStr=w.join(","),I.OK}async xFilter(t,n,r,s){t.reset();let o=t.table,a=o.data,i=o.inTransaction,c=o.pendingInserts,u=o.pendingUpdates,d=o.pendingDeletes;if(!a)throw new b("MemoryTable BTree not initialized in xFilter.",I.INTERNAL);let l=null,h=0,p=!1,g=new Map;r?.split(",").forEach(y=>{let w=y.indexOf("=");w>0&&g.set(y.substring(0,w),y.substring(w+1))}),p=g.get("order")==="DESC";try{switch(n){case 1:case 2:case 4:l=p?a.descending(a.last()):a.ascending(a.first());break;case 3:l=a.descending(a.last());break;case 0:default:l=a.ascending(a.first());break}}catch(y){throw console.error(`Error preparing BTree iterator (idxNum=${n}):`,y),t.reset(),y}let E=[];if(i){let y=new Map,w=o.compareKeys,N=o.keyFromEntry;if(l)for(let S of l){let R=a.at(S);if(R&&!d?.has(R._rowid_)){let L=N(R);y.set(L,R)}}if(u)for(let[S,R]of u.entries())y.has(R.oldKey)&&(y.set(R.oldKey,R.newRow),w(R.oldKey,R.newKey)!==0&&(y.delete(R.oldKey),y.set(R.newKey,R.newRow)));let C=new Map(y);if(c)for(let[S,R]of c.entries())C.set(S,R);E.push(...C.values()),E.sort((S,R)=>{let L=N(S),T=N(R),O=w(L,T);return p?-O:O})}else if(l)for(let y of l){let w=a.at(y);w&&E.push(w)}t.setResults(E)}async xNext(t){t.advance()}async xEof(t){return t.eof()}xColumn(t,n,r){let s=t.getCurrentRow();if(!s)return n.resultNull(),I.OK;if(r===-1)return n.resultInt64(s._rowid_),I.OK;if(r<0||r>=t.table.columns.length)return n.resultError(`Invalid column index ${r}`,I.RANGE),I.RANGE;let o=t.table.columns[r].name,a=Object.prototype.hasOwnProperty.call(s,o)?s[o]:null;return n.resultValue(a??null),I.OK}async xRowid(t){let n=t.getCurrentRowId();if(n===null)throw new b("Cursor is not pointing to a valid row",I.MISUSE);return n}async xUpdate(t,n,r){if(t.isReadOnly())throw new b(`Table '${t.tableName}' is read-only`,I.READONLY);let s=await wt.acquire(`MemoryTable.xUpdate:${t.schemaName}.${t.tableName}`),o=n._onConflict||W.ABORT;try{if(n.length===1&&typeof n[0]=="bigint")return t.deleteRow(n[0]),{};if(n.length>1&&n[0]===null){let a=Object.fromEntries(t.columns.map((c,u)=>[c.name,n[u+1]])),i=t.addRow(a);if(i.rowid!==void 0)return{rowid:i.rowid};if(o===W.IGNORE)return{};{let c=t.getPkColNames()??"rowid";throw new Ze(`UNIQUE constraint failed: ${t.tableName}.${c}`)}}else if(n.length>1&&typeof n[0]=="bigint"){let a=n[0],i=Object.fromEntries(t.columns.map((c,u)=>[c.name,n[u+1]]));try{if(!t.updateRow(a,i))throw new b(`Update failed for rowid ${a}`,I.NOTFOUND);return{}}catch(c){if(c instanceof Ze&&o===W.IGNORE)return{};throw c}}else throw new b("Unsupported arguments for xUpdate",I.ERROR)}finally{s()}}async xBegin(t){let n=await wt.acquire(`MemoryTable.xBegin:${t.schemaName}.${t.tableName}`);try{t.inTransaction?console.warn(`MemoryTable ${t.tableName}: Nested transaction started without savepoint support.`):(t.inTransaction=!0,t.pendingInserts=new Map,t.pendingUpdates=new Map,t.pendingDeletes=new Map)}finally{n()}}async xCommit(t){let n=await wt.acquire(`MemoryTable.xCommit:${t.schemaName}.${t.tableName}`);try{if(!t.inTransaction)return;if(!t.data)throw new Error("BTree missing during commit");if(t.pendingDeletes)for(let[r,s]of t.pendingDeletes.entries()){let o=t.data.find(s.oldKey);if(o.on)try{t.data.deleteAt(o),t.rowidToKeyMap&&t.rowidToKeyMap.delete(r)}catch(a){console.error(`Commit: Failed to delete rowid ${r} with key ${s.oldKey}`,a)}}if(t.pendingUpdates)for(let[r,s]of t.pendingUpdates.entries())if(t.compareKeys(s.oldKey,s.newKey)!==0){if(!t.pendingDeletes?.has(r)){let a=t.data.find(s.oldKey);if(a.on)try{t.data.deleteAt(a)}catch(i){console.warn(`Commit Update: Failed to delete old key ${s.oldKey}`,i)}}t.rowidToKeyMap&&t.rowidToKeyMap.delete(r);try{t.data.insert(s.newRow),t.rowidToKeyMap&&t.rowidToKeyMap.set(r,s.newKey)}catch(a){console.error(`Commit: Failed to insert updated rowid ${r} with new key ${s.newKey}`,a)}}else{let a=t.data.find(s.oldKey);if(a.on)try{t.data.updateAt(a,s.newRow)}catch(i){console.error(`Commit: Failed to update in-place rowid ${r} with key ${s.oldKey}`,i)}else console.warn(`Commit Update: Rowid ${r} with key ${s.oldKey} not found for in-place update.`)}if(t.pendingInserts)for(let[r,s]of t.pendingInserts.entries())try{t.data.insert(s),t.rowidToKeyMap&&t.rowidToKeyMap.set(s._rowid_,r)}catch(o){console.error(`Commit: Failed to insert rowid ${s._rowid_} with key ${r}`,o)}t.pendingInserts=null,t.pendingUpdates=null,t.pendingDeletes=null,t.inTransaction=!1}finally{n()}}async xRollback(t){let n=await wt.acquire(`MemoryTable.xRollback:${t.schemaName}.${t.tableName}`);try{if(!t.inTransaction)return;t.pendingInserts=null,t.pendingUpdates=null,t.pendingDeletes=null,t.inTransaction=!1}finally{n()}}async xSync(t){}async xRename(t,n){let r=`${t.schemaName.toLowerCase()}.${t.tableName.toLowerCase()}`,s=`${t.schemaName.toLowerCase()}.${n.toLowerCase()}`;if(r!==s){if(this.tables.has(s))throw new b(`Cannot rename memory table: target name '${n}' already exists in schema '${t.schemaName}'`);this.tables.delete(r),t.tableName=n,this.tables.set(s,t),console.log(`Memory table renamed from '${r}' to '${n}'`)}}async xSavepoint(t,n){t.createSavepoint(n)}async xRelease(t,n){t.releaseSavepoint(n)}async xRollbackTo(t,n){t.rollbackToSavepoint(n)}};var On=class e{db;program;stmt;programCounter=0;stack=[];framePointer=0;stackPointer=0;localsStartOffset=2;vdbeCursors;hasYielded=!1;done=!1;error=null;appliedBindings=!1;vtabContext;udfContext;ephemeralTables=new Map;static ephemeralModule=new Pt;aggregateContexts=new Map;aggregateIterator=null;currentAggregateEntry=null;savepoints=[];constructor(t,n){this.stmt=t,this.db=t.db,this.program=n;let r=Math.max(n.numMemCells+100,1e3);this.stack=new Array(r).fill(null).map(()=>({value:null})),this.stackPointer=0,this.framePointer=0,this.vdbeCursors=new Array(n.numCursors).fill(null).map(()=>({instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null})),this.vtabContext=new yt(this.db),this.udfContext=new yt(this.db)}applyBindings(t){this.appliedBindings||(console.log("VDBE applying bindings to stack..."),t.forEach((n,r)=>{let o=this.program.parameters.get(r)?.memIdx;o!==void 0&&o>=0?this._setStackValue(o,n):console.warn(`Could not map parameter ${r} to stack cell`)}),this.appliedBindings=!0)}clearAppliedBindings(){this.appliedBindings=!1}async reset(){this.programCounter=0,this.stackPointer=0,this.framePointer=0,this.appliedBindings=!1,this.hasYielded=!1,this.done=!1,this.error=null,this.udfContext._clear(),this.udfContext._cleanupAuxData(),this.aggregateContexts.clear(),this.aggregateIterator=null,this.currentAggregateEntry=null,this.savepoints=[];let t=[];for(let n=0;n<this.vdbeCursors.length;n++){let r=this.vdbeCursors[n];r.sortedResults&&(r.sortedResults=null),r.instance&&t.push(r.vtab.module.xClose(r.instance)),r.isEphemeral&&this.ephemeralTables.delete(n),this.vdbeCursors[n]={instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null}}this.ephemeralTables.clear(),await Promise.allSettled(t)}async run(){if(this.done||this.error)return this.error?this.error.code:I.MISUSE;this.hasYielded=!1;try{for(this.appliedBindings||this.applyBindings(new Map);!this.done&&!this.hasYielded&&!this.error;){let t=this.program.instructions[this.programCounter];if(!t){this.error=new b(`Invalid program counter: ${this.programCounter}`,I.INTERNAL);break}console.debug(`VDBE Exec: [${this.programCounter}] FP=${this.framePointer} SP=${this.stackPointer} ${f[t.opcode]} ${t.p1} ${t.p2} ${t.p3} ${t.p4!==null?`P4:${String(t.p4)}`:""} ${t.comment?`-- ${t.comment}`:""}`),await this.executeInstruction(t),!this.error&&!this.done&&!this.hasYielded&&this.programCounter<this.program.instructions.length&&this.program.instructions[this.programCounter]===t&&this.programCounter++}}catch(t){console.error("VDBE Execution Error:",t),t instanceof b?this.error=t:t instanceof Error?this.error=new b(`Runtime error: ${t.message}`,I.ERROR):this.error=new b("Unknown runtime error",I.INTERNAL),this.done=!0}return this.error?this.error.code:this.hasYielded?I.ROW:this.done?I.DONE:I.INTERNAL}_setStackValue(t,n){if(t<0)throw new b(`Invalid stack write index ${t}`,I.INTERNAL);for(;t>=this.stack.length;)this.stack.push({value:null});t>=this.stackPointer&&(this.stackPointer=t+1),this.stack[t]||(this.stack[t]={value:null}),this.stack[t].value=n instanceof Uint8Array?n.slice():n}_getStackValue(t){return t<0||t>=this.stackPointer?null:this.stack[t]?.value??null}_getMemValue(t){let n=this.framePointer+t;return this._getStackValue(n)}_setMem(t,n){if(t<this.localsStartOffset)throw new b(`Write attempt to control info/argument area via _setMem: Offset=${t}`,I.INTERNAL);let r=this.framePointer+t;this._setStackValue(r,n)}async executeInstruction(t){let n=t.p1,r=t.p2,s=t.p3,o=t.p4,a=t.p5,i=c=>{c?this.programCounter=r:this.programCounter++};switch(t.opcode){case f.Init:this.programCounter=r;return;case f.Goto:this.programCounter=r;return;case f.FrameEnter:{let l=n,h=this.stackPointer-1,p=h+l;for(;p>this.stack.length;)this.stack.push({value:null});this._setStackValue(h+1,this.framePointer);for(let g=this.localsStartOffset;g<l;g++)this._setStackValue(h+g,null);this.framePointer=h,this.stackPointer=p;break}case f.FrameLeave:{if(this.framePointer===0&&this._getStackValue(1)===null)console.warn("FrameLeave called on base frame? Potentially harmless if program ends.");else{let l=this._getStackValue(this.framePointer+1),h=typeof l=="number"?l:-1;if(isNaN(h)||h<0)throw new b(`Invalid old frame pointer ${l} at FP ${this.framePointer+1}`,I.INTERNAL);this.stackPointer=this.framePointer,this.framePointer=h}break}case f.Push:{let l=this._getMemValue(n);this._setStackValue(this.stackPointer,l);break}case f.Subroutine:{let l=n,h=r,p=this.programCounter+1;this._setStackValue(this.stackPointer,p),this.programCounter=h;return}case f.Return:{let l=this._getStackValue(this.stackPointer),h=typeof l=="number"?l:-1;if(!Number.isInteger(h)||h<0)throw new b(`Invalid return address ${l} at SP ${this.stackPointer} (expected after FrameLeave)`,I.INTERNAL);this.stackPointer++,this.programCounter=h;return}case f.Integer:this._setMem(r,n);break;case f.Int64:this._setMem(r,this.program.constants[o]);break;case f.String8:this._setMem(r,this.program.constants[o]);break;case f.Null:this._setMem(r,null);break;case f.Real:this._setMem(r,this.program.constants[o]);break;case f.Blob:this._setMem(r,this.program.constants[o]);break;case f.ZeroBlob:{let l=Number(this._getMemValue(n));this._setMem(r,new Uint8Array(l>=0?Math.trunc(l):0));break}case f.SCopy:this._setMem(r,this._getMemValue(n));break;case f.Clear:{let l=n,h=r;if(l<this.localsStartOffset)throw new b(`Clear opcode attempt to clear control/arg area: Offset=${l}`,I.INTERNAL);let p=this.framePointer+l,g=p+h;if(p<0||g>this.stackPointer)throw new b(`Clear opcode stack access out of bounds: FP=${this.framePointer} Offset=${l} Count=${h} SP=${this.stackPointer}`,I.INTERNAL);for(let E=p;E<g;E++)this._setStackValue(E,null);break}case f.IfTrue:i(Fo(this._getMemValue(n)));return;case f.IfFalse:i(!Fo(this._getMemValue(n)));return;case f.IfZero:{let l=this._getMemValue(n);i(l===0||l===0n||l===null);return}case f.IfNull:i(this._getMemValue(n)===null);return;case f.IfNotNull:i(this._getMemValue(n)!==null);return;case f.IsNull:this._setMem(r,this._getMemValue(n)===null);break;case f.NotNull:this._setMem(r,this._getMemValue(n)!==null);break;case f.Eq:case f.Ne:case f.Lt:case f.Le:case f.Gt:case f.Ge:{let l=this._getMemValue(n),h=this._getMemValue(s),p=r,g=o,E=g?.type==="coll"?g.name:"BINARY",y=de(l,h,E),w=!1;switch(t.opcode){case f.Eq:w=y===0;break;case f.Ne:w=y!==0;break;case f.Lt:w=y<0;break;case f.Le:w=y<=0;break;case f.Gt:w=y>0;break;case f.Ge:w=y>=0;break}i(w);return}case f.Add:this._binaryArithOp(n,r,s,(l,h)=>Number(l)+Number(h));break;case f.Subtract:this._binaryArithOp(n,r,s,(l,h)=>Number(h)-Number(l));break;case f.Multiply:this._binaryArithOp(n,r,s,(l,h)=>Number(l)*Number(h));break;case f.Divide:{let l=this._getMemValue(n),h=this._getMemValue(r);this._setMem(s,l===0||l===0n||l===null||h===null||Number(l)===0?null:Number(h)/Number(l))}break;case f.Remainder:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null)if(typeof l=="bigint"||typeof h=="bigint"){let g=BigInt(l),E=BigInt(h);g!==0n&&(p=E%g)}else{let g=Number(l),E=Number(h);g!==0&&!isNaN(g)&&!isNaN(E)&&(p=E%g)}}catch{}this._setMem(s,p)}break;case f.Concat:{let l="";for(let h=n;h<=r;h++){let p=this._getMemValue(h);p!==null&&!(p instanceof Uint8Array)&&(l+=String(p))}this._setMem(s,l);break}case f.Negative:{let l=this._getMemValue(n),h=null;try{l!==null&&(h=typeof l=="bigint"?-l:-Number(l)),typeof h=="number"&&isNaN(h)&&(h=null)}catch{h=null}this._setMem(r,h)}break;case f.BitAnd:case f.BitOr:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null){let g=BigInt(l),E=BigInt(h);p=t.opcode===f.BitAnd?g&E:g|E}}catch{p=0n}this._setMem(s,p);break}case f.ShiftLeft:case f.ShiftRight:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null){let g=BigInt(l),E=BigInt(h);p=t.opcode===f.ShiftLeft?E<<g:E>>g}}catch{p=0n}this._setMem(s,p);break}case f.BitNot:{let l=this._getMemValue(n),h=null;try{l!==null&&(h=~BigInt(l))}catch{h=-1n}this._setMem(r,h);break}case f.Function:{let l=o;if(!l||l.type!=="funcdef")throw new b("Invalid P4 for Function",I.INTERNAL);let h=[];for(let p=0;p<l.nArgs;p++)h.push(this._getMemValue(r+p));this.udfContext=new yt(this.db,l.funcDef.userData),this.udfContext._clear();try{l.funcDef.xFunc(this.udfContext,Object.freeze(h));let p=this.udfContext._getError();if(p)throw p;this._setMem(s,this.udfContext._getResult())}catch(p){throw p instanceof Error?new b(`Func ${l.funcDef.name}: ${p.message}`,I.ERROR):p}break}case f.MakeRecord:{let l=[];for(let p=0;p<r;p++)l.push(this._getMemValue(n+p));let h=JSON.stringify(l,(p,g)=>typeof g=="bigint"?g.toString()+"n":g instanceof Uint8Array?`blob:${Buffer.from(g).toString("hex")}`:g);this._setMem(s,h);break}case f.AggStep:{let l=o;if(!l||l.type!=="funcdef")throw new b("Invalid P4 for AggStep",I.INTERNAL);let p=this._getMemValue(s),g=[];for(let y=0;y<l.nArgs;y++)g.push(this._getMemValue(r+y));let E=this.aggregateContexts.get(p);this.udfContext._clear(),this.udfContext._setAggregateContextRef(E?.accumulator);try{l.funcDef.xStep(this.udfContext,Object.freeze(g));let y=this.udfContext._getError();if(y)throw y;let w=this.udfContext._getAggregateContextRef();if(E===void 0&&w!==void 0){let N=[];for(let C=0;C<a;C++)N.push(this._getMemValue(n+C));this.aggregateContexts.set(p,{accumulator:w,keyValues:Object.freeze(N)})}else E!==void 0&&w!==void 0&&w!==E.accumulator&&(E.accumulator=w)}catch(y){console.error(`VDBE AggStep Error in function ${l.funcDef.name}:`,y),y instanceof b?this.error=y:y instanceof Error?this.error=new b(`Runtime error in aggregate ${l.funcDef.name} xStep: ${y.message}`,I.ERROR):this.error=new b(`Unknown runtime error in aggregate ${l.funcDef.name} xStep`,I.INTERNAL),this.done=!0;return}break}case f.AggFinal:{let l=o;if(!l||l.type!=="funcdef")throw new b("Invalid P4 for AggFinal",I.INTERNAL);let p=this._getMemValue(n),g=this.aggregateContexts.get(p);this.udfContext=new yt(this.db,l.funcDef.userData),this.udfContext._clear(),this.udfContext._setAggregateContextRef(g?.accumulator);try{l.funcDef.xFinal(this.udfContext);let E=this.udfContext._getError();if(E)throw E;this._setMem(s,this.udfContext._getResult())}catch{}break}case f.AggIterate:this.aggregateIterator=this.aggregateContexts.entries(),this.currentAggregateEntry=null;break;case f.AggNext:if(!this.aggregateIterator)throw new Error;let c=this.aggregateIterator.next();c.done?(this.currentAggregateEntry=null,this.programCounter=r):(this.currentAggregateEntry=c.value,this.programCounter++);return;case f.AggKey:if(!this.currentAggregateEntry)throw new Error;let u=this.currentAggregateEntry[0];this._setMem(r,u);break;case f.AggContext:if(!this.currentAggregateEntry)throw new Error;this._setMem(r,this.currentAggregateEntry[1]?.accumulator);break;case f.AggGroupValue:if(!this.currentAggregateEntry)throw new Error;this._setMem(s,this.currentAggregateEntry[1]?.keyValues[r]??null);break;case f.Affinity:{let l=n,h=r,p=o.toUpperCase(),g=this.framePointer+l,E=g+h;if(l<this.localsStartOffset)throw new b(`Affinity opcode attempt on control/arg area: Offset=${l}`,I.INTERNAL);if(g<0||E>this.stackPointer)throw new b(`Affinity opcode stack access out of bounds: FP=${this.framePointer} Offset=${l} Count=${h} SP=${this.stackPointer}`,I.INTERNAL);let y;switch(p){case"NUMERIC":y=gu;break;case"INTEGER":y=$o;break;case"REAL":y=pu;break;case"TEXT":y=Eu;break;case"BLOB":y=yu;break;default:y=w=>w}for(let w=0;w<h;w++){let N=l+w,C=this._getMemValue(N),S=y(C);S!==C&&this._setMem(N,S)}break}case f.Move:{let l=n,h=r,p=s,g=this.framePointer+l,E=this.framePointer+h;if(g<0||E<0||g+p>this.stackPointer||E+p>this.stackPointer)throw new b(`Move opcode stack access out of bounds: FP=${this.framePointer} SrcOff=${l} DestOff=${h} Count=${p} SP=${this.stackPointer}`,I.INTERNAL);if(g===E)break;if(E>g&&E<g+p)for(let y=p-1;y>=0;y--)this._setStackValue(E+y,this._getStackValue(g+y));else for(let y=0;y<p;y++)this._setStackValue(E+y,this._getStackValue(g+y));break}case f.OpenRead:{let l=n,h=o;if(!h?.vtabInstance)throw new Error("Missing vtab instance");let p=h.vtabInstance,g=await p.module.xOpen(p);this.vdbeCursors[l]={instance:g,vtab:p,isValid:!1,isEof:!1,sortedResults:null};break}case f.OpenWrite:{let l=n,h=o;if(!h?.vtabInstance)throw new Error("Missing vtab instance");let p=h.vtabInstance,g=await p.module.xOpen(p);this.vdbeCursors[l]={instance:g,vtab:p,isValid:!1,isEof:!1,sortedResults:null};break}case f.Close:{let l=n,h=this.vdbeCursors[l];h&&(h.sortedResults&&(h.sortedResults=null),h.instance&&await h.vtab.module.xClose(h.instance),h.isEphemeral&&this.ephemeralTables.delete(l),this.vdbeCursors[l]={instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null});break}case f.VFilter:{let l=n,h=r,p=s,g=o,E=this.vdbeCursors[l];if(!E?.vtab||!E.instance)throw new Error("VFilter on unopened cursor");let y=[];for(let N=0;N<g.nArgs;N++)y.push(this._getMemValue(p+N));await E.vtab.module.xFilter(E.instance,g.idxNum,g.idxStr,y);let w=await E.vtab.module.xEof(E.instance);E.isEof=w,E.isValid=!w,w?this.programCounter=h:this.programCounter++;return}case f.VNext:{let l=n,h=r,p=this.vdbeCursors[l];if(p?.sortedResults)return;if(!p?.instance)throw new Error("VNext on unopened cursor");await p.vtab.module.xNext(p.instance);let g=await p.vtab.module.xEof(p.instance);p.isEof=g,p.isValid=!g,g?this.programCounter=h:this.programCounter++;return}case f.Rewind:{let l=n,h=r,p=this.vdbeCursors[l];if(p?.sortedResults)return;if(!p?.instance)throw new Error("Rewind on unopened cursor");await p.vtab.module.xFilter(p.instance,0,null,[]);let g=await p.vtab.module.xEof(p.instance);p.isEof=g,p.isValid=!g,g?this.programCounter=h:this.programCounter++;return}case f.VColumn:{let l=n,h=r,p=s,g=this.vdbeCursors[l];if(g?.sortedResults){let y=g.sortedResults;if(y.index<0||y.index>=y.rows.length)throw new Error;let w=y.rows[y.index];if(h<0||h>=w.length)throw new Error;this._setMem(p,w[h].value);break}if(!g?.instance||!g.isValid)throw new Error("VColumn on invalid cursor");this.vtabContext._clear();let E=g.vtab.module.xColumn(g.instance,this.vtabContext,h);if(E!==I.OK)throw new b(`xColumn failed (col ${h}, cursor ${l})`,E);this._setMem(p,this.vtabContext._getResult());break}case f.VRowid:{let l=n,h=r,p=this.vdbeCursors[l];if(!p?.instance||!p.isValid)throw new Error("VRowid on invalid cursor");let g=await p.vtab.module.xRowid(p.instance);this._setMem(h,g);break}case f.VUpdate:{let l=r,h=s,p=n,g=o;if(!g?.table?.vtabInstance?.module?.xUpdate)throw new Error("VUpdate called on non-virtual table or module lacks xUpdate");let E=[];for(let w=0;w<p;w++)E.push(this._getMemValue(l+w)??null);E._onConflict=g.onConflict||W.ABORT;let y=E[0];try{let w=await g.table.vtabInstance.module.xUpdate(g.table.vtabInstance,E,y);h>0&&(E[0]===null?w&&w.rowid!==void 0?this._setMem(h,w.rowid):this._setMem(h,null):this._setMem(h,null))}catch(w){w instanceof b?this.error=w:w instanceof Error?this.error=new b(`Runtime error during VUpdate: ${w.message}`,I.ERROR):this.error=new b("Unknown error during VUpdate execution",I.ERROR),this.done=!0;return}}break;case f.VBegin:case f.VCommit:case f.VRollback:case f.VSync:case f.VSavepoint:case f.VRelease:case f.VRollbackTo:console.warn(`VTab transaction Opcode ${f[t.opcode]} not fully implemented`);break;case f.ResultRow:let d=this.framePointer+n;if(d<0||d+r>this.stackPointer)throw new b(`ResultRow stack access out of bounds: FP=${this.framePointer} Offset=${n} Count=${r} SP=${this.stackPointer}`,I.INTERNAL);this.stmt.setCurrentRow(this.stack.slice(d,d+r)),this.hasYielded=!0,this.programCounter++;return;case f.Sort:console.warn("Opcode.Sort execution logic needs review for stack frame compatibility.");break;case f.Halt:this.done=!0,n!==I.OK&&(this.error=new b(o??`Execution halted with code ${n}`,n));break;case f.Noop:break;case f.OpenEphemeral:{let l=n,h=r,p=o,g=new mr(this.db,e.ephemeralModule,"_temp_internal",`_eph_${l}`);if(this.ephemeralTables.set(l,{table:g,module:e.ephemeralModule}),p&&p.columns&&p.primaryKeyDefinition){console.log(`VDBE OpenEphemeral: Initializing cursor ${l} with provided schema (PK def length: ${p.primaryKeyDefinition.length})`);let y=p.columns.map(w=>({name:w.name,type:w.affinity}));g.setColumns(y,p.primaryKeyDefinition)}else{console.log(`VDBE OpenEphemeral: Initializing cursor ${l} with default schema (${h} cols)`);let y=Array.from({length:h},(w,N)=>({name:`eph_col${N}`,type:A.TEXT}));g.setColumns(y,[])}let E=await e.ephemeralModule.xOpen(g);this.vdbeCursors[l]={instance:E,vtab:g,isValid:!1,isEof:!1,isEphemeral:!0};break}case f.ConstraintViolation:{let l=typeof o=="string"&&o?o:"Constraint failed";throw new Ze(l)}case f.StackPop:{let l=n;if(l<0)throw new b("StackPop count cannot be negative",I.INTERNAL);if(this.stackPointer<l)throw new b(`Stack underflow during StackPop: SP=${this.stackPointer}, Count=${l}`,I.INTERNAL);this.stackPointer-=l;break}case f.Halt:{this.done=!0;break}default:throw new b(`Unsupported opcode: ${f[t.opcode]} (${t.opcode})`,I.INTERNAL)}this.programCounter<this.program.instructions.length&&this.program.instructions[this.programCounter]===t&&this.programCounter++}_binaryArithOp(t,n,r,s){let o=this._getMemValue(t),a=this._getMemValue(n),i=null;if(o!==null&&a!==null)if(typeof o=="bigint"||typeof a=="bigint")try{i=s(BigInt(o),BigInt(a))}catch{i=null}else{let c=Number(o),u=Number(a);if(!isNaN(c)&&!isNaN(u))try{i=s(c,u)}catch{i=null}}this._setMem(r,i)}handleVdbeError(t,n,r){let s=`VDBE Error during ${n} at PC ${r}: ${t instanceof Error?t.message:String(t)}`,o=t instanceof b?t.code:I.INTERNAL;this.error=new b(s,o,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}handleVTabError(t,n,r,s){let o=`Error in VTab ${n}.${r} at PC ${s}: ${t instanceof Error?t.message:String(t)}`,a=t instanceof b?t.code:I.ERROR;this.error=new b(o,a,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}handleUdfError(t,n,r,s="xFunc"){let o=`Error in function ${n} (${s}) at PC ${r}: ${t instanceof Error?t.message:String(t)}`,a=t instanceof b?t.code:I.ERROR;this.error=new b(o,a,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}};var xn=class{db;sql;finalized=!1;busy=!1;boundParameters=new Map;columnNames=[];currentRowInternal=null;vdbeProgram=null;vdbe=null;needsCompile=!0;constructor(t,n){this.db=t,this.sql=n}async compile(){if(this.vdbeProgram&&!this.needsCompile)return this.vdbeProgram;if(this.finalized)throw new M("Statement finalized");console.log("Compiling statement..."),this.vdbeProgram=null;try{let n=new Be().parse(this.sql),r=new Rn(this.db);this.vdbeProgram=r.compile(n,this.sql),this.needsCompile=!1,console.log("Compilation complete.")}catch(t){throw console.error("Compilation failed:",t),t instanceof b?t:t instanceof gt?new b(`Parse error: ${t.message}`,I.ERROR):t instanceof Error?new b(`Compilation error: ${t.message}`,I.INTERNAL):new b("Unknown compilation error",I.INTERNAL)}if(!this.vdbeProgram)throw new b("Compilation resulted in no program",I.INTERNAL);return this.vdbeProgram}bind(t,n){if(this.finalized)throw new M("Statement finalized");if(this.busy)throw new M("Statement busy");if(typeof t=="number"){if(t<1)throw new RangeError(`Parameter index ${t} out of range (must be >= 1)`);this.boundParameters.set(t,n)}else if(typeof t=="string")this.boundParameters.set(t,n);else throw new M("Invalid parameter key type");return this.vdbe&&(this.vdbe.clearAppliedBindings(),this.vdbe.applyBindings(this.boundParameters)),this}bindAll(t){if(this.finalized)throw new M("Statement finalized");if(this.busy)throw new M("Statement busy");if(Array.isArray(t))for(let n=0;n<t.length;n++)this.bind(n+1,t[n]);else if(typeof t=="object"&&t!==null)for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&this.bind(n,t[n]);else throw new M("Invalid parameters type for bindAll. Use array or object.");return this}async step(){if(this.finalized)throw new M("Statement finalized");if(await this.compile(),!this.vdbe&&this.vdbeProgram&&(this.vdbe=new On(this,this.vdbeProgram),this.vdbe.applyBindings(this.boundParameters)),!this.vdbe)throw new b("VDBE not initialized after compile",I.INTERNAL);this.busy=!0,this.currentRowInternal=null;let t=await this.vdbe.run();if(t===I.ROW){if(!this.currentRowInternal)throw this.busy=!1,new b("VDBE returned ROW but setCurrentRow was not called",I.INTERNAL)}else this.busy=!1,this.currentRowInternal=null;if(t!==I.ROW&&t!==I.DONE&&t!==I.OK)throw new b(`VDBE execution failed with status: ${I[t]}`,t);return console.log(`Step result: ${I[t]}`),t}setCurrentRow(t){this.currentRowInternal=t}getArray(){if(this.finalized)throw new M("Statement finalized");if(!this.currentRowInternal)throw new M("No row available");return this.currentRowInternal.map(t=>t.value)}getAsObject(){if(this.finalized)throw new M("Statement finalized");if(!this.currentRowInternal)throw new M("No row available");let t=this.vdbeProgram?.columnNames||[];if(t.length===0&&this.currentRowInternal.length>0)return this.currentRowInternal.reduce((r,s,o)=>(r[`col_${o}`]=s.value,r),{});if(t.length!==this.currentRowInternal.length)throw new b(`Column name/value count mismatch (${t.length} vs ${this.currentRowInternal.length})`,I.INTERNAL);let n={};for(let r=0;r<t.length;r++){let s=t[r];s in n||(n[s]=this.currentRowInternal[r].value)}return n}getColumnNames(){if(this.finalized)throw new M("Statement finalized");return[...this.vdbeProgram?.columnNames||[]]}async reset(){if(this.finalized)throw new M("Statement finalized");this.vdbe&&await this.vdbe.reset(),this.currentRowInternal=null,this.busy=!1,this.needsCompile=!1}clearBindings(){if(this.finalized)throw new M("Statement finalized");if(this.busy)throw new M("Statement busy - reset first");return this.boundParameters.clear(),this.vdbe&&this.vdbe.clearAppliedBindings(),this}async finalize(){this.finalized||(this.finalized=!0,this.busy=!1,this.vdbe&&await this.vdbe.reset(),this.boundParameters.clear(),this.currentRowInternal=null,this.vdbeProgram=null,this.vdbe=null,this.db._statementFinalized(this))}async run(t){if(this.finalized)throw new M("Statement finalized");if(this.busy)throw new M("Statement busy - already running?");t&&this.bindAll(t);try{let n;do if(n=await this.step(),n===I.ROW)this.currentRowInternal=null;else if(n!==I.DONE&&n!==I.OK)throw new b("Execution failed during run()",n);while(n===I.ROW)}finally{await this.reset()}}async get(t){if(this.finalized)throw new M("Statement finalized");if(this.busy)throw new M("Statement busy - already running?");t&&this.bindAll(t);let n;try{let r=await this.step();if(r===I.ROW)n=this.getAsObject();else if(r!==I.DONE&&r!==I.OK)throw new b("Execution failed during get()",r);let s=r;for(;s===I.ROW;)if(s=await this.step(),s!==I.ROW&&s!==I.DONE&&s!==I.OK){console.warn(`Error consuming remaining rows after get(): ${I[s]}`);break}}finally{await this.reset()}return n}async all(t){if(this.finalized)throw new M("Statement finalized");if(this.busy)throw new M("Statement busy - already running?");t&&this.bindAll(t);let n=[];try{let r;do if(r=await this.step(),r===I.ROW)n.push(this.getAsObject());else if(r!==I.DONE&&r!==I.OK)throw new b("Execution failed during all()",r);while(r===I.ROW)}finally{await this.reset()}return n}getParameterCount(){if(this.finalized)throw new M("Statement finalized");return this.needsCompile&&!this.vdbeProgram?0:this.vdbeProgram?.parameters.size||0}getParameterName(t){if(this.finalized)throw new M("Statement finalized");if(t<1)throw new RangeError("Parameter index must be >= 1");if(this.needsCompile&&!this.vdbeProgram)return null;for(let[n,r]of this.vdbeProgram?.parameters||[])if(typeof n=="string"&&r.memIdx===t)return n;return null}getParameterIndex(t){if(this.finalized)throw new M("Statement finalized");if(!t)throw new M("Parameter name cannot be empty");if(this.needsCompile&&!this.vdbeProgram)return null;let n=this.vdbeProgram?.parameters.get(t);return n?n.memIdx:null}getColumnType(t){if(this.finalized)throw new M("Statement finalized");if(!this.currentRowInternal)throw new M("No row available");if(t<0||t>=this.currentRowInternal.length)throw new RangeError(`Column index ${t} out of range (0-${this.currentRowInternal.length-1})`);let n=this.currentRowInternal[t].value;return n===null?A.NULL:typeof n=="number"?A.REAL:typeof n=="bigint"?A.INTEGER:typeof n=="string"?A.TEXT:n instanceof Uint8Array?A.BLOB:typeof n=="boolean"?A.INTEGER:A.TEXT}getColumnName(t){if(this.finalized)throw new M("Statement finalized");let n=this.vdbeProgram?.columnNames||[];if(t<0||n.length>0&&t>=n.length)throw new RangeError(`Column index ${t} out of range (0-${n.length-1})`);return n[t]||`col_${t}`}getColumnBytes(t){if(this.finalized)throw new M("Statement finalized");if(!this.currentRowInternal)throw new M("No row available");if(t<0||t>=this.currentRowInternal.length)throw new RangeError(`Column index ${t} out of range (0-${this.currentRowInternal.length-1})`);let n=this.currentRowInternal[t].value;return n===null?0:n instanceof Uint8Array?n.byteLength:typeof n=="string"?new TextEncoder().encode(n).length:new TextEncoder().encode(String(n)).length}};function bm(e){return`FUNCTION ${e.name}(${Array(e.numArgs).fill("?").join(", ")})`}var fs=class extends Ve{},Ho=class extends Ke{schemaRows=[];currentIndex=-1;isEof=!0;constructor(t){super(t)}reset(){this.schemaRows=[],this.currentIndex=-1,this.isEof=!0}setResults(t){this.schemaRows=t,this.currentIndex=-1,this.isEof=this.schemaRows.length===0,this.isEof||this.advance()}getCurrentRow(){return this.isEof||this.currentIndex<0||this.currentIndex>=this.schemaRows.length?null:this.schemaRows[this.currentIndex]}getCurrentRowId(){return this.getCurrentRow()?._rowid_??null}advance(){this.currentIndex>=this.schemaRows.length-1?(this.isEof=!0,this.currentIndex=this.schemaRows.length):(this.currentIndex++,this.isEof=!1)}eof(){return this.isEof}},an=class e{static COLUMNS=[{name:"type",type:A.TEXT,collation:"BINARY"},{name:"name",type:A.TEXT,collation:"BINARY"},{name:"tbl_name",type:A.TEXT,collation:"BINARY"},{name:"rootpage",type:A.INTEGER,collation:"BINARY"},{name:"sql",type:A.TEXT,collation:"BINARY"}];static COLUMN_INDEX_MAP=Object.fromEntries(this.COLUMNS.map((t,n)=>[t.name,n]));constructor(){}xCreate(t,n,r,s,o,a){return console.log(`SchemaTableModule xCreate: ${s}.${o}`),new fs(t,this,s,o)}xConnect(t,n,r,s,o,a){return console.log(`SchemaTableModule xConnect: ${s}.${o}`),new fs(t,this,s,o)}async xDisconnect(t){console.log(`Schema table '${t.tableName}' disconnected`)}async xDestroy(t){console.warn(`Attempted to destroy schema table '${t.tableName}'`)}async xOpen(t){return new Ho(t)}async xClose(t){t.reset()}xBestIndex(t,n){return n.idxNum=0,n.estimatedCost=1e3,n.estimatedRows=BigInt(100),n.orderByConsumed=!1,n.idxFlags=0,n.aConstraintUsage=Array.from({length:n.nConstraint},()=>({argvIndex:0,omit:!1})),n.idxStr="fullscan",I.OK}async xFilter(t,n,r,s){t.reset();let a=t.table.db.schemaManager,i=[],c=BigInt(0),u=d=>{for(let l of d.getAllTables()){if(l.name.toLowerCase()==="sqlite_schema"&&l.schemaName==="main")continue;let h=null;try{l.isVirtual&&l.vtabModuleName&&(h=`create table ${l.name} using ${l.vtabModuleName}(...)`)}catch(p){console.warn(`Failed to stringify CREATE TABLE for ${l.name}:`,p)}i.push({type:"table",name:l.name,tbl_name:l.name,rootpage:1,sql:h,_rowid_:c++})}for(let l of d._getAllFunctions())i.push({type:"function",name:l.name,tbl_name:l.name,rootpage:0,sql:bm(l),_rowid_:c++})};u(a.getMainSchema()),u(a.getTempSchema()),t.setResults(i)}async xNext(t){t.advance()}async xEof(t){return t.eof()}xColumn(t,n,r){let s=t.getCurrentRow();if(!s)return n.resultNull(),I.OK;switch(e.COLUMNS[r]?.name){case"type":n.resultText(s.type);break;case"name":n.resultText(s.name);break;case"tbl_name":n.resultText(s.tbl_name);break;case"rootpage":n.resultInt(s.rootpage);break;case"sql":s.sql===null?n.resultNull():n.resultText(s.sql);break;default:if(r===-1)n.resultInt64(s._rowid_);else return n.resultError(`Invalid column index ${r} for sqlite_schema`,I.RANGE),I.RANGE;break}return I.OK}async xRowid(t){let n=t.getCurrentRowId();if(n===null)throw new b("Cursor is not pointing to a valid schema row",I.MISUSE);return n}async xUpdate(t,n,r){throw new b("Cannot modify read-only table: sqlite_schema",I.READONLY)}async xBegin(t){}async xSync(t){}async xCommit(t){}async xRollback(t){}async xRename(t,n){throw new b("Cannot rename built-in table: sqlite_schema",I.ERROR)}async xSavepoint(t,n){}async xRelease(t,n){}async xRollbackTo(t,n){}xShadowName(t){return!1}};var Mn=class{schemas=new Map;currentSchemaName="main";modules=new Map;defaultVTabModule=null;db;constructor(t){this.db=t,this.schemas.set("main",new An("main")),this.schemas.set("temp",new An("temp"))}setCurrentSchema(t){this.schemas.has(t.toLowerCase())?this.currentSchemaName=t.toLowerCase():console.warn(`Attempted to set current schema to non-existent schema: ${t}`)}getCurrentSchemaName(){return this.currentSchemaName}registerModule(t,n){let r=t.toLowerCase();this.modules.has(r)&&console.warn(`Replacing existing virtual table module: ${r}`),this.modules.set(r,n),console.log(`Registered VTab module: ${r}`)}getModule(t){return this.modules.get(t.toLowerCase())}setDefaultVTabModule(t){if(t===null){this.defaultVTabModule=null,console.log("Default VTab module cleared.");return}let n=t.toLowerCase();if(this.modules.has(n))this.defaultVTabModule=n,console.log(`Default VTab module set to: ${n}`);else throw new b(`Cannot set default VTab module: module '${n}' not registered.`)}getDefaultVTabModuleName(){return this.defaultVTabModule}getSchema(t){return this.schemas.get(t.toLowerCase())}getMainSchema(){return this.schemas.get("main")}getTempSchema(){return this.schemas.get("temp")}_getAllSchemas(){return this.schemas.values()}addSchema(t){let n=t.toLowerCase();if(this.schemas.has(n))throw new b(`Schema '${t}' already exists`,I.ERROR);let r=new An(t);return this.schemas.set(n,r),console.log(`SchemaManager: Added schema '${t}'`),r}removeSchema(t){let n=t.toLowerCase();if(n==="main"||n==="temp")throw new b(`Cannot detach schema '${t}'`,I.ERROR);let r=this.schemas.get(n);return r?(r.clearFunctions(),r.clearTables(),r.clearViews(),this.schemas.delete(n),console.log(`SchemaManager: Removed schema '${t}'`),!0):!1}_findTable(t,n){let r=t.toLowerCase();if(r==="sqlite_schema"){let s=this.db._getVtabModule("sqlite_schema");if(!s){console.error("sqlite_schema module not registered!");return}let o=an.COLUMNS.map(i=>({name:i.name,affinity:i.type,notNull:!1,primaryKey:!1,pkOrder:0,defaultValue:null,collation:i.collation??"BINARY",hidden:!1,generated:!1})),a=new Map(Object.entries(an.COLUMN_INDEX_MAP));return{name:"sqlite_schema",schemaName:"main",columns:Object.freeze(o),columnIndexMap:Object.freeze(a),primaryKeyDefinition:[],checkConstraints:Object.freeze([]),isVirtual:!0,vtabModule:s.module,vtabInstance:void 0,vtabAuxData:s.auxData,vtabArgs:[],vtabModuleName:"sqlite_schema"}}if(n)return this.schemas.get(n.toLowerCase())?.getTable(r);{let o=this.schemas.get("main")?.getTable(r);return o||(o=this.schemas.get("temp")?.getTable(r),o)}}findTable(t,n){return this._findTable(t,n)}findFunction(t,n){return this.getMainSchema().getFunction(t,n)}declareVtab(t,n,r,s){let o=this.schemas.get(t.toLowerCase());if(!o)throw new b(`Schema not found: ${t}`,I.ERROR);console.log(`SchemaManager: Declaring VTab in '${t}' using SQL: ${n}`);let a;try{let h=new Be().parse(n);if(h.type!=="createTable")throw new b(`Expected CREATE TABLE statement, got ${h.type}`,I.ERROR);a=h}catch(l){throw new b(`Failed to parse CREATE TABLE statement: ${l.message}`,I.ERROR)}let i=a.table.name,c=a.moduleArgs;if(o.getTable(i)){if(a.ifNotExists)return console.log(`SchemaManager: VTab ${i} already exists in schema ${t}, skipping creation (IF NOT EXISTS).`),o.getTable(i);throw new b(`Table ${i} already exists in schema ${t}`,I.ERROR)}console.warn(`SchemaManager.declareVtab: Using placeholder column definition for ${i}. VTab module should define actual columns.`);let u=[_e("column1"),_e("column2")],d={name:i,schemaName:o.name,checkConstraints:[],columns:Object.freeze(u),columnIndexMap:Object.freeze(fe(u)),primaryKeyDefinition:Object.freeze(xl(u)),isVirtual:!0,vtabModule:r.module,vtabInstance:r,vtabAuxData:s,vtabArgs:Object.freeze(c||[]),vtabModuleName:a.moduleName};return o.addTable(d),d}getView(t,n){let r=t??this.currentSchemaName;return this.schemas.get(r)?.getView(n)}getSchemaItem(t,n){let r=t??this.currentSchemaName,s=this.schemas.get(r);if(!s)return;let o=s.getView(n);return o||s.getTable(n)}dropTable(t,n){let r=this.schemas.get(t);if(!r)return!1;let s=r.getTable(n),o=null;s?.isVirtual&&s.vtabInstance&&s.vtabModule?.xDestroy&&(console.log(`Calling xDestroy for VTab ${t}.${n}`),o=s.vtabModule.xDestroy(s.vtabInstance).catch(i=>{console.error(`Error during VTab xDestroy for ${t}.${n}:`,i)}));let a=r.removeTable(n);return o&&o.then(()=>console.log(`xDestroy completed for VTab ${t}.${n}`)),a}dropView(t,n){let r=this.schemas.get(t);return r?r.removeView(n):!1}clearAll(){this.schemas.forEach(t=>{t.clearTables(),t.clearFunctions(),t.clearViews()}),console.log("SchemaManager: Cleared all schemas.")}getSchemaOrFail(t){let n=this.schemas.get(t.toLowerCase());if(!n)throw new b(`Schema not found: ${t}`);return n}getTable(t,n){let r=t??this.currentSchemaName;return this.schemas.get(r)?.getTable(n)}};function Cu(e,t){if(e===null||t===void 0||t==="any")return e;try{switch(t){case"string":return e instanceof Uint8Array?"":String(e);case"number":if(typeof e=="boolean")return e?1:0;let n=Number(e);return isNaN(n)?null:n;case"bigint":return BigInt(e);case"boolean":if(typeof e=="number")return e!==0;if(typeof e=="bigint")return e!==0n;if(typeof e=="string"){let r=e.trim().toLowerCase();if(r==="true")return!0;if(r==="false")return!1;let s=Number(e);return!isNaN(s)&&s!==0}return!!e;case"blob":return e instanceof Uint8Array?e:null}}catch(n){return console.warn(`Coercion failed for value ${e} to type ${t}:`,n),null}return e}function V(e,t){return{name:e.name,numArgs:e.numArgs,flags:e.flags??v.UTF8|v.DETERMINISTIC,xFunc:(r,s)=>{try{if(e.numArgs>=0&&s.length!==e.numArgs)throw new Error(`Function ${e.name} called with ${s.length} arguments, expected ${e.numArgs}`);let o=s.map((i,c)=>Cu(i,e.argTypes?.[c])),a=t(...o);a==null?r.resultNull():typeof a=="string"?r.resultText(a):typeof a=="number"?Number.isInteger(a)?r.resultInt64(BigInt(a)):r.resultDouble(a):typeof a=="bigint"?r.resultInt64(a):a instanceof Uint8Array?r.resultBlob(a):typeof a=="boolean"?r.resultInt(a?1:0):(console.warn(`Function ${e.name} returned unknown type: ${typeof a}. Coercing to NULL.`),r.resultNull())}catch(o){let a=o instanceof Error?o.message:String(o);r.resultError(`Error in function ${e.name}: ${a}`,I.ERROR)}}}}function Ce(e,t,n){return{name:e.name,numArgs:e.numArgs,flags:e.flags??v.UTF8,xStep:(s,o)=>{if(e.numArgs>=0&&o.length!==e.numArgs)throw new Error(`Aggregate ${e.name} step called with ${o.length} arguments, expected ${e.numArgs}`);let a=s.getAggregateContext();a===void 0&&(a=e.initialState??null);let i=o.map((u,d)=>Cu(u,e.argTypes?.[d])),c=t(a,...i);s.setAggregateContext(c)},xFinal:s=>{try{let o=s.getAggregateContext();o===void 0&&(o=e.initialState??null);let a=n(o);a==null?s.resultNull():typeof a=="string"?s.resultText(a):typeof a=="number"?Number.isInteger(a)?s.resultInt64(BigInt(a)):s.resultDouble(a):typeof a=="bigint"?s.resultInt64(a):a instanceof Uint8Array?s.resultBlob(a):typeof a=="boolean"?s.resultInt(a?1:0):(console.warn(`Aggregate ${e.name} xFinal returned unknown type: ${typeof a}. Coercing to NULL.`),s.resultNull())}catch(o){let a=o instanceof Error?o.message:String(o);s.resultError(`Error in aggregate function ${e.name} xFinal: ${a}`,I.ERROR)}}}}var Nm=e=>typeof e=="string"?e.toLowerCase():null,Su=V({name:"lower",numArgs:1,flags:v.UTF8|v.DETERMINISTIC},Nm),Cm=e=>typeof e=="string"?e.toUpperCase():null,Au=V({name:"upper",numArgs:1,flags:v.UTF8|v.DETERMINISTIC},Cm),Sm=e=>e===null?null:typeof e=="string"||e instanceof Uint8Array?e.length:null,Ru=V({name:"length",numArgs:1,flags:v.UTF8|v.DETERMINISTIC},Sm),Tu=(e,t,n)=>{if(e===null||t===null)return null;let r=String(e),s=Number(t),o=n===void 0?void 0:Number(n);if(isNaN(s)||o!==void 0&&isNaN(o))return null;s=Math.trunc(s),o=o===void 0?void 0:Math.trunc(o);let a=r.length,i;s>0?i=s-1:s<0?i=a+s:i=0,i=Math.max(0,i);let c;return o===void 0?c=a:o>=0?c=i+o:c=i,r.substring(i,c)},vu=V({name:"substr",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},(e,t,n)=>Tu(e,t,n)),Lu=V({name:"substring",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},(e,t,n)=>Tu(e,t,n)),Am=e=>{if(e===null)return null;if(typeof e=="bigint")return e<0n?-e:e;let t=Number(e);return isNaN(t)?null:Math.abs(t)},Ou=V({name:"abs",numArgs:1,flags:v.DETERMINISTIC},Am),Rm=(e,t)=>{if(e===null)return null;let n=Number(e);if(isNaN(n))return null;let r=0;if(t!=null){let s=Number(t);if(isNaN(s))return null;r=Math.trunc(s)}try{let s=Math.pow(10,r);return Math.round(n*s)/s}catch{return null}},xu=V({name:"round",numArgs:-1,flags:v.DETERMINISTIC},(e,t)=>Rm(e,t)),Tm=(...e)=>{for(let t of e)if(t!==null)return t;return null},Mu=V({name:"coalesce",numArgs:-1,flags:v.DETERMINISTIC},Tm),vm=(e,t)=>de(e,t)===0?null:e,Du=V({name:"nullif",numArgs:2,flags:v.DETERMINISTIC},vm);function Lm(e,t){let r=e.replace(/[.*+^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,".");try{return new RegExp(`^${r}$`).test(t)}catch(s){return console.error(`Invalid LIKE pattern converted to regex: ^${r}$`,s),!1}}var Om=(e,t)=>e===null||t===null?null:Lm(String(t),String(e)),Pu=V({name:"like",numArgs:2,flags:v.UTF8|v.DETERMINISTIC},Om);function xm(e,t){let r=e.replace(/[.*+^${}()|[\]\\]/g,"\\$&").replace(/\\\*/g,".*").replace(/\\\?/g,".");try{return new RegExp(`^${r}$`).test(t)}catch(s){return console.error(`Invalid GLOB pattern converted to regex: ^${r}$`,s),!1}}var Mm=(e,t)=>t===null||e===null?null:xm(String(e),String(t)),ku=V({name:"glob",numArgs:2,flags:v.UTF8|v.DETERMINISTIC},Mm);var Dm=e=>(e??0)+1,Pm=e=>e??0,Fu=Ce({name:"count",numArgs:0,flags:v.UTF8|v.DETERMINISTIC,initialState:0},Dm,Pm),km=(e,t)=>{if(t===null)return e;let n=e?.sum??0,r=t;try{if(typeof t!="bigint"&&(r=Number(t),isNaN(r)))return e;if(typeof n=="bigint"||typeof r=="bigint")return{sum:BigInt(n)+BigInt(r)};{let s=n+r;return s>Number.MAX_SAFE_INTEGER||s<Number.MIN_SAFE_INTEGER?{sum:BigInt(n)+BigInt(r)}:{sum:s}}}catch(s){return console.warn("Error during SUM step coercion:",s),e}},Fm=e=>e?.sum??null,Uu=Ce({name:"sum",numArgs:1,flags:v.UTF8},km,Fm),Um=(e,t)=>{if(t===null)return e;let n=e?.sum??0,r=e?.count??0,s=t;try{return typeof t!="bigint"&&(s=Number(t),isNaN(s))?e:{sum:Number(n)+Number(s),count:r+1}}catch(o){return console.warn("Error during AVG step coercion:",o),e}},$m=e=>!e||e.count===0?null:Number(e.sum)/e.count,$u=Ce({name:"avg",numArgs:1,flags:v.UTF8},Um,$m),Bm=(e,t)=>t===null?e:e===null?{min:t}:de(t,e.min)<0?{min:t}:e,_m=e=>e?.min??null,Bu=Ce({name:"min",numArgs:1,flags:v.UTF8},Bm,_m),Vm=(e,t)=>t===null?e:e===null?{max:t}:de(t,e.max)>0?{max:t}:e,Km=e=>e?.max??null,_u=Ce({name:"max",numArgs:1,flags:v.UTF8},Vm,Km),qm=(e,t)=>t===null?e??0:(e??0)+1,Gm=e=>e??0,Vu=Ce({name:"count",numArgs:1,flags:v.UTF8|v.DETERMINISTIC},qm,Gm),jm=(e,t,n)=>{if(t===null)return e??{values:[]};let r=e?.values??[],s=String(t);return r.push(s),{values:r}},Ym=(e,t)=>{if(!e||e.values.length===0)return null;let n=t==null?",":String(t);return e.values.join(n)},kb=Ce({name:"group_concat",numArgs:-1,flags:v.UTF8},(e,...t)=>jm(e,t[0],t[1]),(e,...t)=>Ym(e,t[1])),Wm=(e,t,n=",")=>{let r=e??{values:[],separator:String(n)},s=n==null?r.separator:String(n);if(t===null)return{...r,separator:s};let o=String(t);return r.values.push(o),{values:r.values,separator:s}},zm=e=>!e||e.values.length===0?null:e.values.join(e.separator),Ku=Ce({name:"group_concat",numArgs:-1,flags:v.UTF8,initialState:{values:[],separator:","}},Wm,zm);function xe(e,t,n,r,s){return Rt(t,((o,a)=>{let i=o[a];if(i===void 0)throw new TypeError(Ni(a));return i})(e,t),n,r,s)}function Rt(e,t,n,r,s,o){let a=yr(t,n,r);if(s&&t!==a)throw new RangeError(Ad(e,t,n,r,o));return a}function ye(e){return e!==null&&/object|function/.test(typeof e)}function Pe(e,t=Map){let n=new t;return(r,...s)=>{if(n.has(r))return n.get(r);let o=e(r,...s);return n.set(r,o),o}}function Un(e){return dn({name:e},1)}function dn(e,t){return st(n=>({value:n,configurable:1,writable:!t}),e)}function rc(e){return st(t=>({get:t,configurable:1}),e)}function vs(e){return{[Symbol.toStringTag]:{value:e,configurable:1}}}function $n(e,t){let n={},r=e.length;for(let s of t)n[e[--r]]=s;return n}function st(e,t,n){let r={};for(let s in t)r[s]=e(t[s],s,n);return r}function Rr(e,t,n){let r={};for(let s=0;s<t.length;s++){let o=t[s];r[o]=e(o,s,n)}return r}function sc(e,t,n){let r={};for(let s=0;s<e.length;s++)r[t[s]]=n[e[s]];return r}function je(e,t){let n=Object.create(null);for(let r of e)n[r]=t[r];return n}function qu(e,t){for(let n of t)if(n in e)return 1;return 0}function oc(e,t,n){for(let r of e)if(t[r]!==n[r])return 0;return 1}function ac(e,t,n){let r={...n};for(let s=0;s<t;s++)r[e[s]]=0;return r}function q(e,...t){return(...n)=>e(...t,...n)}function Gu(e){return e[0].toUpperCase()+e.substring(1)}function Tr(e){return e.slice().sort()}function Is(e,t){return String(t).padStart(e,"0")}function Ft(e,t){return Math.sign(e-t)}function yr(e,t,n){return Math.min(Math.max(e,t),n)}function Ct(e,t){return[Math.floor(e/t),gr(e,t)]}function gr(e,t){return(e%t+t)%t}function $t(e,t){return[Ls(e,t),la(e,t)]}function Ls(e,t){return Math.trunc(e/t)||0}function la(e,t){return e%t||0}function ds(e){return Math.abs(e%1)===.5}function ic(e,t,n){let r=0,s=0;for(let i=0;i<=t;i++){let c=e[n[i]],u=rt[i],d=Z/u,[l,h]=$t(c,d);r+=h*u,s+=l}let[o,a]=$t(r,Z);return[s+o,a]}function Os(e,t,n){let r={};for(let s=t;s>=0;s--){let o=rt[s];r[n[s]]=Ls(e,o),e=la(e,o)}return r}function lc(e){if(e!==void 0)return ge(e)}function uc(e){if(e!==void 0)return ot(e)}function ua(e){if(e!==void 0)return xs(e)}function ot(e){return fc(xs(e))}function xs(e){return fa(_p(e))}function cc(e,t){if(t==null)throw new RangeError(Ni(e));return t}function vr(e){if(!ye(e))throw new TypeError(pp);return e}function ca(e,t,n=e){if(typeof t!==e)throw new TypeError(Wt(n,t));return t}function fa(e,t="number"){if(!Number.isInteger(e))throw new RangeError(up(t,e));return e||0}function fc(e,t="number"){if(e<=0)throw new RangeError(cp(t,e));return e}function da(e){if(typeof e=="symbol")throw new TypeError(mp);return String(e)}function gs(e,t){return ye(e)?String(e):ge(e,t)}function ha(e){if(typeof e=="string")return BigInt(e);if(typeof e!="bigint")throw new TypeError(hp(e));return e}function dc(e,t="number"){if(typeof e=="bigint")throw new TypeError(dp(t));if(e=Number(e),!Number.isFinite(e))throw new RangeError(fp(t,e));return e}function Se(e,t){return Math.trunc(dc(e,t))||0}function ma(e,t){return fa(dc(e,t),t)}function ju(e,t){return fc(Se(e,t),t)}function pa(e,t){let[n,r]=$t(t,Z),s=e+n,o=Math.sign(s);return o&&o===-Math.sign(r)&&(s-=o,r+=o*Z),[s,r]}function Pn(e,t,n=1){return pa(e[0]+t[0]*n,e[1]+t[1]*n)}function un(e,t){return pa(e[0],e[1]+t)}function tt(e,t){return Pn(t,e,-1)}function qe(e,t){return Ft(e[0],t[0])||Ft(e[1],t[1])}function hc(e,t,n){return qe(e,t)===-1||qe(e,n)===1}function ga(e,t=1){let n=BigInt(Z/t);return[Number(e/n),Number(e%n)*t]}function wr(e,t=1){let n=Z/t,[r,s]=$t(e,n);return[r,s*t]}function nt(e,t=1,n){let[r,s]=e,[o,a]=$t(s,t);return r*(Z/t)+(o+(n?a/t:0))}function Ea(e,t,n=Ct){let[r,s]=e,[o,a]=n(s,t);return[r*(Z/t)+o,a]}function ya(e){return xe(e,"isoYear",Ar,Sr,1),e.isoYear===Ar?xe(e,"isoMonth",4,12,1):e.isoYear===Sr&&xe(e,"isoMonth",1,9,1),e}function Xe(e){return ke({...e,...Re,isoHour:12}),e}function ke(e){let t=xe(e,"isoYear",Ar,Sr,1),n=t===Ar?1:t===Sr?-1:0;return n&&at(he({...e,isoDay:e.isoDay+n,isoNanosecond:e.isoNanosecond-n})),e}function at(e){if(!e||hc(e,Wp,Yp))throw new RangeError(zt);return e}function Bt(e){return ic(e,5,ze)[1]}function Ms(e){let[t,n]=Ct(e,Z);return[Os(n,5,ze),t]}function Yu(e){return Ea(e,et)}function Ae(e){return Bn(e.isoYear,e.isoMonth,e.isoDay,e.isoHour,e.isoMinute,e.isoSecond,e.isoMillisecond)}function he(e){let t=Ae(e);if(t!==void 0){let[n,r]=$t(t,De);return[n,r*ct+(e.isoMicrosecond||0)*kr+(e.isoNanosecond||0)]}}function wa(e,t){let[n,r]=Ms(Bt(e)-t);return at(he({...e,isoDay:e.isoDay+r,...n}))}function bs(...e){return Bn(...e)/kd}function Bn(...e){let[t,n]=mc(...e),r=t.valueOf();if(!isNaN(r))return r-n*De}function mc(e,t=1,n=1,r=0,s=0,o=0,a=0){let i=e===Ar?1:e===Sr?-1:0,c=new Date;return c.setUTCHours(r,s,o,a),c.setUTCFullYear(e,t-1,n+i),[c,i]}function _n(e,t){let[n,r]=un(e,t);r<0&&(r+=Z,n-=1);let[s,o]=Ct(r,ct),[a,i]=Ct(o,kr);return Ds(n*De+s,a,i)}function Ds(e,t=0,n=0){let r=Math.ceil(Math.max(0,Math.abs(e)-Fi)/De)*Math.sign(e),s=new Date(e-r*De);return $n(uo,[s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate()+r,s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds(),s.getUTCMilliseconds(),t,n])}function Ia(e,t){if(t<-Fi)throw new RangeError(zt);let n=e.formatToParts(t),r={};for(let s of n)r[s.type]=s.value;return r}function ba(e){return[e.isoYear,e.isoMonth,e.isoDay]}function pc(e,t){return[t,0]}function gc(){return kt}function Ec(e,t){switch(t){case 2:return Na(e)?29:28;case 4:case 6:case 9:case 11:return 30}return 31}function yc(e){return Na(e)?366:365}function Na(e){return e%4==0&&(e%100!=0||e%400==0)}function wc(e){let[t,n]=mc(e.isoYear,e.isoMonth,e.isoDay);return gr(t.getUTCDay()-n,7)||7}function Ic(e){return this.id===Zn?(({isoYear:t})=>t<1?["gregory-inverse",1-t]:["gregory",t])(e):this.id===Kt?Zp(e):[]}function Hm(e){let t=Ae(e);if(t<Hp){let{isoYear:o}=e;return o<1?["japanese-inverse",1-o]:["japanese",o]}let n=Ia(Vi(Kt),t),{era:r,eraYear:s}=kf(n,Kt);return[r,s]}function Ps(e){return hn(e),Vn(e,1),e}function hn(e){return bc(e,1),e}function Wu(e){return oc(Di,e,bc(e))}function bc(e,t){let{isoYear:n}=e,r=xe(e,"isoMonth",1,gc(),t);return{isoYear:n,isoMonth:r,isoDay:xe(e,"isoDay",1,Ec(n,r),t)}}function Vn(e,t){return $n(ze,[xe(e,"isoHour",0,23,t),xe(e,"isoMinute",0,59,t),xe(e,"isoSecond",0,59,t),xe(e,"isoMillisecond",0,999,t),xe(e,"isoMicrosecond",0,999,t),xe(e,"isoNanosecond",0,999,t)])}function j(e){return e===void 0?0:Xd(vr(e))}function Lr(e,t=0){e=it(e);let n=Jd(e),r=ag(e,t);return[Xd(e),r,n]}function Kn(e,t,n,r=9,s=0,o=4){t=it(t);let a=Zd(t,r,s),i=Aa(t),c=$r(t,o),u=Ur(t,r,s,1);return a==null?a=Math.max(n,u):Rc(a,u),i=Ra(i,u,1),e&&(c=(d=>d<4?(d+2)%4:d)(c)),[a,u,i,c]}function ks(e,t=6,n){let r=Aa(e=Fs(e,Ts)),s=$r(e,7),o=Ur(e,t);return o=cc(Ts,o),r=Ra(r,o,void 0,n),[o,r,s]}function Ca(e){return Ui(it(e))}function Nc(e,t){return Sa(it(e),t)}function Cc(e){let t=Fs(e,ea),n=qt(ea,sg,t,0);if(!n)throw new RangeError(Wt(ea,n));return n}function Sa(e,t=4){let n=Ac(e);return[$r(e,4),...Sc(Ur(e,t),n)]}function Sc(e,t){return e!=null?[rt[e],e<4?9-3*e:-1]:[t===void 0?1:10**(9-t),t]}function Aa(e){let t=e[Er];return t===void 0?1:Se(t,Er)}function Ra(e,t,n,r){let s=r?Z:rt[t+1];if(s){let o=rt[t];if(s%((e=Rt(Er,e,1,s/o-(r?0:1),1))*o))throw new RangeError(Wt(Er,e))}else e=Rt(Er,e,1,n?10**9:1,1);return e}function Ac(e){let t=e[Qo];if(t!==void 0){if(typeof t!="number"){if(da(t)==="auto")return;throw new RangeError(Wt(Qo,t))}t=Rt(Qo,Math.floor(t),0,9,1)}return t}function it(e){return e===void 0?{}:vr(e)}function Fs(e,t){return typeof e=="string"?{[t]:e}:vr(e)}function Us(e){return{overflow:Xp[e]}}function Ta(e,t,n=9,r=0,s){let o=t[e];if(o===void 0)return s?r:void 0;if(o=da(o),o==="auto")return s?r:null;let a=na[o];if(a===void 0&&(a=qp[o]),a===void 0)throw new RangeError(vd(e,o,na));return Rt(e,a,r,n,1,Ai),a}function qt(e,t,n,r=0){let s=n[e];if(s===void 0)return r;let o=da(s),a=t[o];if(a===void 0)throw new RangeError(vd(e,o,t));return a}function Rc(e,t){if(t>e)throw new RangeError(Pp)}function lt(e){return{branding:mo,epochNanoseconds:e}}function Ye(e,t,n){return{branding:Ot,calendar:n,timeZone:t,epochNanoseconds:e}}function We(e,t=e.calendar){return{branding:wn,calendar:t,...je(Gp,e)}}function ut(e,t=e.calendar){return{branding:Xn,calendar:t,...je(Pi,e)}}function Ir(e,t=e.calendar){return{branding:co,calendar:t,...je(Pi,e)}}function Ns(e,t=e.calendar){return{branding:fo,calendar:t,...je(Pi,e)}}function Qe(e){return{branding:ho,...je(Yd,e)}}function ae(e){return{branding:po,sign:Gt(e),...je(Oi,e)}}function $s(e){return Ea(e.epochNanoseconds,ct)[0]}function Tc(e){return((t,n=1)=>{let[r,s]=t,o=Math.floor(s/n),a=Z/n;return BigInt(r)*BigInt(a)+BigInt(o)})(e.epochNanoseconds)}function vc(e){return e.epochNanoseconds}function Lc(e,t,n,r,s){let o=cn(r),[a,i]=((w,N)=>{let C=N((w=Fs(w,oa))[zd]),S=og(w);return S=cc(oa,S),[S,C]})(s,e),c=Math.max(a,o);if(!i&&Nr(c,i))return zu(r,a);if(!i)throw new RangeError(oo);if(!r.sign)return 0;let[u,d,l]=Gs(t,n,i),h=Ha(l),p=js(l),g=Za(l),E=p(d,u,r);kn(i)||(ke(u),ke(E));let y=g(d,u,E,a);return Nr(a,i)?zu(y,a):((w,N,C,S,R,L,T)=>{let O=Gt(w),[x,$]=va(S,Mi(C,w),C,O,R,L,T),z=La(N,x,$);return w[Y[C]]+z*O})(y,h(E),a,d,u,h,p)}function zu(e,t){return nt(me(e),rt[t],1)}function va(e,t,n,r,s,o,a){let i=Y[n],c={...t,[i]:t[i]+r},u=a(e,s,t),d=a(e,s,c);return[o(u),o(d)]}function La(e,t,n){let r=nt(tt(t,n));if(!r)throw new RangeError(Hn);return nt(tt(t,e))/r}function Oc(e,t){let[n,r,s]=ks(t,5,1);return lt(_s(e.epochNanoseconds,n,r,s,1))}function xc(e,t,n){let{epochNanoseconds:r,timeZone:s,calendar:o}=t,[a,i,c]=ks(n);if(a===0&&i===1)return t;let u=e(s);if(a===6)r=((d,l,h,p)=>{let g=Fe(h,l),[E,y]=d(g),w=h.epochNanoseconds,N=Vt(l,E),C=Vt(l,y);if(hc(w,N,C))throw new RangeError(Hn);return _c(La(w,N,C),p)?C:N})($c,u,t,c);else{let d=u.R(r);r=Gn(u,Fc(_n(r,d),a,i,c),d,2,0,1)}return Ye(r,s,o)}function Mc(e,t){return We(Fc(e,...ks(t)),e.calendar)}function Dc(e,t){let[n,r,s]=ks(t,5);var o;return Qe((o=s,Oa(e,Or(n,r),o)[0]))}function Pc(e,t){let n=e(t.timeZone),r=Fe(t,n),[s,o]=$c(r),a=nt(tt(Vt(n,s),Vt(n,o)),lo,1);if(a<=0)throw new RangeError(Hn);return a}function kc(e,t){let{timeZone:n,calendar:r}=t,s=((o,a,i)=>Vt(a,o(Fe(i,a))))(Bc,e(n),t);return Ye(s,n,r)}function Fc(e,t,n,r){return Uc(e,Or(t,n),r)}function Uc(e,t,n){let[r,s]=Oa(e,t,n);return ke({...mn(e,s),...r})}function Oa(e,t,n){return Ms(_t(Bt(e),t,n))}function Cs(e){return _t(e,io,7)}function Or(e,t){return rt[e]*t}function $c(e){let t=Bc(e);return[t,mn(t,1)]}function Bc(e){return jp(6,e)}function Zm(e,t,n){let r=Math.min(cn(e),6);return jn(Vs(me(e,r),t,n),r)}function Bs(e,t,n,r,s,o,a,i,c,u){if(r===0&&s===1)return e;let d=Nr(r,i)?kn(i)&&r<6&&n>=6?Jm:Xm:Qm,[l,h,p]=d(e,t,n,r,s,o,a,i,c,u);return p&&r!==7&&(l=((g,E,y,w,N,C,S,R)=>{let L=Gt(g);for(let T=w+1;T<=y;T++){if(T===7&&y!==7)continue;let O=Mi(T,g);O[Y[T]]+=L;let x=nt(tt(S(R(N,C,O)),E));if(x&&Math.sign(x)!==L)break;g=O}return g})(l,h,n,Math.max(6,r),a,i,c,u)),l}function _s(e,t,n,r,s){if(t===6){let o=(a=>a[0]+a[1]/Z)(e);return[_t(o,n,r),0]}return Vs(e,Or(t,n),r,s)}function Vs(e,t,n,r){let[s,o]=e;r&&o<0&&(o+=Z,s-=1);let[a,i]=Ct(_t(o,t,n),Z);return pa(s+a,i)}function _t(e,t,n){return _c(e/t,n)*t}function _c(e,t){return ug[t](e)}function Xm(e,t,n,r,s,o){let a=Gt(e),i=me(e),c=_s(i,r,s,o),u=tt(i,c),d=Math.sign(c[0]-i[0])===a,l=jn(c,Math.min(n,6));return[{...e,...l},Pn(t,u),d]}function Jm(e,t,n,r,s,o,a,i,c,u){let d=Gt(e)||1,l=nt(me(e,5)),h=Or(r,s),p=_t(l,h,o),[g,E]=va(a,{...e,...xi},6,d,i,c,u),y=p-nt(tt(g,E)),w=0;y&&Math.sign(y)!==d?t=un(g,p):(w+=d,p=_t(y,h,o),t=un(E,p));let N=Ws(p);return[{...e,...N,days:e.days+w},t,!!w]}function Qm(e,t,n,r,s,o,a,i,c,u){let d=Gt(e),l=Y[r],h=Mi(r,e);r===7&&(e={...e,weeks:e.weeks+Math.trunc(e.days/7)});let p=Ls(e[l],s)*s;h[l]=p;let[g,E]=va(a,h,r,s*d,i,c,u),y=p+La(t,g,E)*d*s,w=_t(y,s,o),N=Math.sign(w-y)===d;return h[l]=w,[h,N?E:g,N]}function xa(e,t,n,r){let[s,o,a,i]=(u=>{let d=Sa(u=it(u));return[u.timeZone,...d]})(r),c=s!==void 0;return((u,d,l,h,p,g)=>{l=Vs(l,p,h,1);let E=d.R(l);return $a(_n(l,E),g)+(u?qn(Cs(E)):"Z")})(c,t(c?e(s):In),n.epochNanoseconds,o,a,i)}function Ma(e,t,n){let[r,s,o,a,i,c]=(u=>{u=it(u);let d=Ui(u),l=Ac(u),h=lg(u),p=$r(u,4),g=Ur(u,4);return[d,ig(u),h,p,...Sc(g,l)]})(n);return((u,d,l,h,p,g,E,y,w,N)=>{h=Vs(h,w,y,1);let C=u(l).R(h);return $a(_n(h,C),N)+qn(Cs(C),E)+((S,R)=>R!==1?"["+(R===2?"!":"")+S+"]":"")(l,g)+Ba(d,p)})(e,t.calendar,t.timeZone,t.epochNanoseconds,r,s,o,a,i,c)}function Da(e,t){let[n,r,s,o]=(u=>(u=it(u),[Ui(u),...Sa(u)]))(t);return a=e.calendar,i=n,c=o,$a(Uc(e,s,r),c)+Ba(a,i);var a,i,c}function Pa(e,t){return n=e.calendar,r=e,s=Ca(t),Ss(r)+Ba(n,s);var n,r,s}function ka(e,t){return Vc(e.calendar,Kc,e,Ca(t))}function Fa(e,t){return Vc(e.calendar,ep,e,Ca(t))}function Ua(e,t){let[n,r,s]=Nc(t);return o=s,qc(Oa(e,r,n)[0],o);var o}function Ks(e,t){let[n,r,s]=Nc(t,3);return r>1&&pn(e={...e,...Zm(e,r,n)}),((o,a)=>{let{sign:i}=o,c=i===-1?Te(o):o,{hours:u,minutes:d}=c,[l,h]=Ea(me(c,3),et,$t);Zc(l);let p=_a(h,a),g=a>=0||!i||p;return(i<0?"-":"")+"P"+Hu({Y:ln(c.years),M:ln(c.months),W:ln(c.weeks),D:ln(c.days)})+(u||d||l||g?"T"+Hu({H:ln(u),M:ln(d),S:ln(l,g)+p}):"")})(e,s)}function Vc(e,t,n,r){let s=r>1||r===0&&e!==G;return r===1?e===G?t(n):Ss(n):s?Ss(n)+Gc(e,r===2):t(n)}function Hu(e){let t=[];for(let n in e){let r=e[n];r&&t.push(r,n)}return t.join("")}function $a(e,t){return Ss(e)+"T"+qc(e,t)}function Ss(e){return Kc(e)+"-"+Je(e.isoDay)}function Kc(e){let{isoYear:t}=e;return(t<0||t>9999?jc(t)+Is(6,Math.abs(t)):Is(4,t))+"-"+Je(e.isoMonth)}function ep(e){return Je(e.isoMonth)+"-"+Je(e.isoDay)}function qc(e,t){let n=[Je(e.isoHour),Je(e.isoMinute)];return t!==-1&&n.push(Je(e.isoSecond)+((r,s,o,a)=>_a(r*ct+s*kr+o,a))(e.isoMillisecond,e.isoMicrosecond,e.isoNanosecond,t)),n.join(":")}function qn(e,t=0){if(t===1)return"";let[n,r]=Ct(Math.abs(e),lo),[s,o]=Ct(r,io),[a,i]=Ct(o,et);return jc(e)+Je(n)+":"+Je(s)+(a||i?":"+Je(a)+_a(i):"")}function Ba(e,t){return t!==1&&(t>1||t===0&&e!==G)?Gc(e,t===2):""}function Gc(e,t){return"["+(t?"!":"")+"u-ca="+e+"]"}function _a(e,t){let n=Is(9,e);return n=t===void 0?n.replace(dg,""):n.slice(0,t),n?"."+n:""}function jc(e){return e<0?"-":"+"}function ln(e,t){return e||t?e.toLocaleString("fullwide",{useGrouping:0}):""}function tp(e,t){let{epochNanoseconds:n}=e,r=(t.R?t:t(e.timeZone)).R(n),s=_n(n,r);return{calendar:e.calendar,...s,offsetNanoseconds:r}}function Gn(e,t,n,r=0,s=0,o,a){if(n!==void 0&&r===1&&(r===1||a))return wa(t,n);let i=e.I(t);if(n!==void 0&&r!==3){let c=((u,d,l,h)=>{let p=he(d);h&&(l=Cs(l));for(let g of u){let E=nt(tt(g,p));if(h&&(E=Cs(E)),E===l)return g}})(i,t,n,o);if(c!==void 0)return c;if(r===0)throw new RangeError(vp)}return a?he(t):xr(e,t,s,i)}function xr(e,t,n=0,r=e.I(t)){if(r.length===1)return r[0];if(n===1)throw new RangeError(Lp);if(r.length)return r[n===3?1:0];let s=he(t),o=((i,c)=>{let u=i.R(un(c,-Z));return(d=>{if(d>Z)throw new RangeError(Tp);return d})(i.R(un(c,Z))-u)})(e,s),a=o*(n===2?-1:1);return(r=e.I(_n(s,a)))[n===2?0:r.length-1]}function Vt(e,t){let n=e.I(t);if(n.length)return n[0];let r=un(he(t),-Z);return e.O(r,1)}function Va(e,t,n){return lt(at(Pn(t.epochNanoseconds,(r=>{if(Xc(r))throw new RangeError(Mp);return me(r,5)})(e?Te(n):n))))}function Ka(e,t,n,r,s,o=Object.create(null)){let a=t(r.timeZone),i=e(r.calendar);return{...r,...Wa(a,i,r,n?Te(s):s,o)}}function qa(e,t,n,r,s=Object.create(null)){let{calendar:o}=n;return We(za(e(o),n,t?Te(r):r,s),o)}function Ga(e,t,n,r,s){let{calendar:o}=n;return ut(qs(e(o),n,t?Te(r):r,s),o)}function ja(e,t,n,r,s){let o=n.calendar,a=e(o),i=Xe(br(a,n));t&&(r=Ys(r)),r.sign<0&&(i=a.P(i,{...pe,months:1}),i=mn(i,-1));let c=a.P(i,r,s);return Ir(br(a,c),o)}function Ya(e,t,n){return Qe(Yc(t,e?Te(n):n)[0])}function Wa(e,t,n,r,s){let o=me(r,5),a=n.epochNanoseconds;if(Xc(r)){let i=Fe(n,e);a=Pn(xr(e,{...qs(t,i,{...r,...xi},s),...je(ze,i)}),o)}else a=Pn(a,o),j(s);return{epochNanoseconds:at(a)}}function za(e,t,n,r){let[s,o]=Yc(t,n);return ke({...qs(e,t,{...n,...xi,days:n.days+o},r),...s})}function qs(e,t,n,r){if(n.years||n.months||n.weeks)return e.P(t,n,r);j(r);let s=n.days+me(n,5)[0];return s?Xe(mn(t,s)):t}function br(e,t,n=1){return mn(t,n-e.day(t))}function Yc(e,t){let[n,r]=me(t,5),[s,o]=Ms(Bt(e)+r);return[s,n+o]}function mn(e,t){return t?{...e,...Ds(Ae(e)+t*De)}:e}function Gs(e,t,n){let r=e(n.calendar);return kn(n)?[n,r,t(n.timeZone)]:[{...n,...Re},r]}function Ha(e){return e?vc:he}function js(e){return e?q(Wa,e):za}function Za(e){return e?q(rp,e):sp}function kn(e){return e&&e.epochNanoseconds}function Nr(e,t){return e<=6-(kn(t)?1:0)}function Xa(e,t,n,r,s,o,a){let i=e(it(a).relativeTo),c=Math.max(cn(s),cn(o));if(Nr(c,i))return ae(pn(((E,y,w,N)=>{let C=Pn(me(E),me(y),N?-1:1);if(!Number.isFinite(C[0]))throw new RangeError(zt);return{...pe,...jn(C,w)}})(s,o,c,r)));if(!i)throw new RangeError(oo);r&&(o=Te(o));let[u,d,l]=Gs(t,n,i),h=js(l),p=Za(l),g=h(d,u,s);return ae(p(d,u,h(d,g,o),c))}function Wc(e,t,n,r,s){let o=cn(r),[a,i,c,u,d]=((L,T,O)=>{L=Fs(L,Ts);let x=Zd(L),$=O(L[zd]),z=Aa(L),ee=$r(L,7),H=Ur(L);if(x===void 0&&H===void 0)throw new RangeError(Dp);if(H==null&&(H=0),x==null&&(x=Math.max(H,T)),Rc(x,H),z=Ra(z,H,1),z>1&&H>5&&x!==H)throw new RangeError("For calendar units with roundingIncrement > 1, use largestUnit = smallestUnit");return[x,H,z,ee,$]})(s,o,e),l=Math.max(o,a);if(!d&&l<=6)return ae(pn(((L,T,O,x,$)=>{let z=_s(me(L),O,x,$);return{...pe,...jn(z,T)}})(r,a,i,c,u)));if(!kn(d)&&!r.sign)return r;if(!d)throw new RangeError(oo);let[h,p,g]=Gs(t,n,d),E=Ha(g),y=js(g),w=Za(g),N=y(p,h,r);kn(d)||(ke(h),ke(N));let C=w(p,h,N,a),S=r.sign,R=Gt(C);if(S&&R&&S!==R)throw new RangeError(Hn);return C=Bs(C,E(N),a,i,c,u,p,h,E,y),ae(C)}function zc(e){return e.sign===-1?Ys(e):e}function Ys(e){return ae(Te(e))}function Te(e){let t={};for(let n of Y)t[n]=-1*e[n]||0;return t}function Hc(e){return!e.sign}function Gt(e,t=Y){let n=0;for(let r of t){let s=Math.sign(e[r]);if(s){if(n&&n!==s)throw new RangeError(xp);n=s}}return n}function pn(e){for(let t of Kp)Rt(t,e[t],-ec,ec,1);return Zc(nt(me(e),et)),e}function Zc(e){if(!Number.isSafeInteger(e))throw new RangeError(Op)}function me(e,t=6){return ic(e,t,Y)}function jn(e,t=6){let[n,r]=e,s=Os(r,t,Y);if(s[Y[t]]+=n*(Z/rt[t]),!Number.isFinite(s[Y[t]]))throw new RangeError(zt);return s}function Ws(e,t=5){return Os(e,t,Y)}function Xc(e){return!!Gt(e,jd)}function cn(e){let t=9;for(;t>0&&!e[Y[t]];t--);return t}function np(e,t){return[e,t]}function Zu(e){let t=Math.floor(e/ys)*ys;return[t,t+ys]}function Jc(e){let t=jt(e=gs(e));if(!t)throw new RangeError(Me(e));let n;if(t.j)n=0;else{if(!t.offset)throw new RangeError(Me(e));n=gn(t.offset)}return t.timeZone&&ti(t.timeZone,1),lt(wa(Ps(t),n))}function Qc(e){let t=jt(ge(e));if(!t)throw new RangeError(Me(e));if(t.timeZone)return uf(t,t.offset?gn(t.offset):void 0);if(t.j)throw new RangeError(Me(e));return ff(t)}function ef(e,t){let n=jt(ge(e));if(!n||!n.timeZone)throw new RangeError(Me(e));let{offset:r}=n,s=r?gn(r):void 0,[,o,a]=Lr(t);return uf(n,s,o,a)}function gn(e){let t=ti(e);if(t===void 0)throw new RangeError(Me(e));return t}function tf(e){let t=jt(ge(e));if(!t||t.j)throw new RangeError(Me(e));return We(cf(t))}function zs(e,t,n){let r=jt(ge(e));if(!r||r.j)throw new RangeError(Me(e));return t?r.calendar===G&&(r=r.isoYear===-271821&&r.isoMonth===4?{...r,isoDay:20,...Re}:{...r,isoDay:1,...Re}):n&&r.calendar===G&&(r={...r,isoYear:At}),ut(r.C?cf(r):ff(r))}function nf(e,t){let n=Qa(ge(t));if(n)return Ja(n),Ir(ya(hn(n)));let r=zs(t,1);return Ir(br(e(r.calendar),r))}function Ja(e){if(e.calendar!==G)throw new RangeError(St(e.calendar))}function rf(e,t){let n=ei(ge(t));if(n)return Ja(n),Ns(hn(n));let r=zs(t,0,1),{calendar:s}=r,o=e(s),[a,i,c]=o.v(r),[u,d]=o.q(a,i),[l,h]=o.G(u,d,c);return Ns(Xe(o.V(l,h,c)),s)}function sf(e){let t,n=(r=>{let s=Eg.exec(r);return s?(Hs(s[10]),mf(s)):void 0})(ge(e));if(!n){if(n=jt(e),!n)throw new RangeError(Me(e));if(!n.C)throw new RangeError(Me(e));if(n.j)throw new RangeError(St("Z"));Ja(n)}if((t=Qa(e))&&Wu(t))throw new RangeError(Me(e));if((t=ei(e))&&Wu(t))throw new RangeError(Me(e));return Qe(Vn(n,1))}function of(e){let t=(n=>{let r=Ig.exec(n);return r?(s=>{function o(d,l,h){let p=0,g=0;if(h&&([p,c]=Ct(c,rt[h])),d!==void 0){if(i)throw new RangeError(St(d));g=(E=>{let y=parseInt(E);if(!Number.isFinite(y))throw new RangeError(St(E));return y})(d),a=1,l&&(c=ni(l)*(rt[h]/et),i=1)}return p+g}let a=0,i=0,c=0,u={...$n(Y,[o(s[2]),o(s[3]),o(s[4]),o(s[5]),o(s[6],s[7],5),o(s[8],s[9],4),o(s[10],s[11],3)]),...Os(c,2,Y)};if(!a)throw new RangeError(Rd(Y));return ri(s[1])<0&&(u=Te(u)),u})(r):void 0})(ge(e));if(!t)throw new RangeError(Me(e));return ae(pn(t))}function af(e){let t=jt(e)||Qa(e)||ei(e);return t?t.calendar:e}function lf(e){let t=jt(e);return t&&(t.timeZone||t.j&&In||t.offset)||e}function uf(e,t,n=0,r=0){let s=Zs(e.timeZone),o=B(s),a;return Ps(e),a=e.C?Gn(o,e,t,n,r,!o.$,e.j):Vt(o,e),Ye(a,s,Dr(e.calendar))}function cf(e){return df(ke(Ps(e)))}function ff(e){return df(Xe(hn(e)))}function df(e){return{...e,calendar:Dr(e.calendar)}}function jt(e){let t=gg.exec(e);return t?(n=>{let r=n[10],s=(r||"").toUpperCase()==="Z";return{isoYear:hf(n),isoMonth:parseInt(n[4]),isoDay:parseInt(n[5]),...mf(n.slice(5)),...Hs(n[16]),C:!!n[6],j:s,offset:s?void 0:r}})(t):void 0}function Qa(e){let t=mg.exec(e);return t?(n=>({isoYear:hf(n),isoMonth:parseInt(n[4]),isoDay:1,...Hs(n[5])}))(t):void 0}function ei(e){let t=pg.exec(e);return t?(n=>({isoYear:At,isoMonth:parseInt(n[1]),isoDay:parseInt(n[2]),...Hs(n[3])}))(t):void 0}function ti(e,t){let n=yg.exec(e);return n?((r,s)=>{let o=r[4]||r[5];if(s&&o)throw new RangeError(St(o));return(a=>{if(Math.abs(a)>=Z)throw new RangeError(Rp);return a})((Dn(r[2])*lo+Dn(r[3])*io+Dn(r[4])*et+ni(r[5]||""))*ri(r[1]))})(n,t):void 0}function hf(e){let t=ri(e[1]),n=parseInt(e[2]||e[3]);if(t<0&&!n)throw new RangeError(St(-0));return t*n}function mf(e){let t=Dn(e[3]);return{...Ms(ni(e[4]||""))[0],isoHour:Dn(e[1]),isoMinute:Dn(e[2]),isoSecond:t===60?59:t}}function Hs(e){let t,n,r=[];if(e.replace(wg,(s,o,a)=>{let i=!!o,[c,u]=a.split("=").reverse();if(u){if(u==="u-ca")r.push(c),t||(t=i);else if(i||/[A-Z]/.test(u))throw new RangeError(St(s))}else{if(n)throw new RangeError(St(s));n=c}return""}),r.length>1&&t)throw new RangeError(St(e));return{timeZone:n,calendar:r[0]||G}}function ni(e){return parseInt(e.padEnd(9,"0"))}function Yn(e){return new RegExp(`^${e}$`,"i")}function ri(e){return e&&e!=="+"?-1:1}function Dn(e){return e===void 0?0:parseInt(e)}function pf(e){return Zs(ge(e))}function Zs(e){let t=si(e);return typeof t=="number"?qn(t):t?(n=>{if(Cg.test(n))throw new RangeError(Si(n));if(Ng.test(n))throw new RangeError(Ap);return n.toLowerCase().split("/").map((r,s)=>(r.length<=3||/\d/.test(r))&&!/etc|yap/.test(r)?r.toUpperCase():r.replace(/baja|dumont|[a-z]+/g,(o,a)=>o.length<=2&&!s||o==="in"||o==="chat"?o.toUpperCase():o.length>2||!a?Gu(o).replace(/island|noronha|murdo|rivadavia|urville/,Gu):o)).join("/")})(e):In}function Xu(e){let t=si(e);return typeof t=="number"?t:t?t.resolvedOptions().timeZone:In}function si(e){let t=ti(e=e.toUpperCase(),1);return t!==void 0?t:e!==In?bg(e):void 0}function oi(e,t){return qe(e.epochNanoseconds,t.epochNanoseconds)}function ai(e,t){return qe(e.epochNanoseconds,t.epochNanoseconds)}function gf(e,t,n,r,s,o){let a=e(it(o).relativeTo),i=Math.max(cn(r),cn(s));if(oc(Y,r,s))return 0;if(Nr(i,a))return qe(me(r),me(s));if(!a)throw new RangeError(oo);let[c,u,d]=Gs(t,n,a),l=Ha(d),h=js(d);return qe(l(h(u,c,r)),l(h(u,c,s)))}function ii(e,t){return En(e,t)||Xs(e,t)}function En(e,t){return Ft(Ae(e),Ae(t))}function Xs(e,t){return Ft(Bt(e),Bt(t))}function Ef(e,t){return!oi(e,t)}function yf(e,t){return!ai(e,t)&&!!Sf(e.timeZone,t.timeZone)&&e.calendar===t.calendar}function wf(e,t){return!ii(e,t)&&e.calendar===t.calendar}function If(e,t){return!En(e,t)&&e.calendar===t.calendar}function bf(e,t){return!En(e,t)&&e.calendar===t.calendar}function Nf(e,t){return!En(e,t)&&e.calendar===t.calendar}function Cf(e,t){return!Xs(e,t)}function Sf(e,t){if(e===t)return 1;try{return Xu(e)===Xu(t)}catch{}}function li(e,t,n,r){let s=Kn(e,r,3,5),o=Js(t.epochNanoseconds,n.epochNanoseconds,...s);return ae(e?Te(o):o)}function ui(e,t,n,r,s,o){let a=eo(r.calendar,s.calendar),[i,c,u,d]=Kn(n,o,5),l=r.epochNanoseconds,h=s.epochNanoseconds,p=qe(h,l),g;if(p)if(i<6)g=Js(l,h,i,c,u,d);else{let E=t(((w,N)=>{if(!Sf(w,N))throw new RangeError(Md);return w})(r.timeZone,s.timeZone)),y=e(a);g=Rf(y,E,r,s,p,i,o),g=Bs(g,h,i,c,u,d,y,r,vc,q(Wa,E))}else g=pe;return ae(n?Te(g):g)}function ci(e,t,n,r,s){let o=eo(n.calendar,r.calendar),[a,i,c,u]=Kn(t,s,6),d=he(n),l=he(r),h=qe(l,d),p;if(h)if(a<=6)p=Js(d,l,a,i,c,u);else{let g=e(o);p=Tf(g,n,r,h,a,s),p=Bs(p,l,a,i,c,u,g,n,he,za)}else p=pe;return ae(t?Te(p):p)}function fi(e,t,n,r,s){let o=eo(n.calendar,r.calendar);return Af(t,()=>e(o),n,r,...Kn(t,s,6,9,6))}function di(e,t,n,r,s){let o=eo(n.calendar,r.calendar),a=Kn(t,s,9,9,8),i=e(o),c=br(i,n),u=br(i,r);return c.isoYear===u.isoYear&&c.isoMonth===u.isoMonth&&c.isoDay===u.isoDay?ae(pe):Af(t,()=>i,Xe(c),Xe(u),...a,8)}function Af(e,t,n,r,s,o,a,i,c=6){let u=he(n),d=he(r);if(u===void 0||d===void 0)throw new RangeError(zt);let l;if(qe(d,u))if(s===6)l=Js(u,d,s,o,a,i);else{let h=t();l=h.N(n,r,s),o===c&&a===1||(l=Bs(l,d,s,o,a,i,h,n,he,qs))}else l=pe;return ae(e?Te(l):l)}function hi(e,t,n,r){let[s,o,a,i]=Kn(e,r,5,5),c=_t(mi(t,n),Or(o,a),i),u={...pe,...Ws(c,s)};return ae(e?Te(u):u)}function rp(e,t,n,r,s,o){let a=qe(r.epochNanoseconds,n.epochNanoseconds);return a?s<6?vf(n.epochNanoseconds,r.epochNanoseconds,s):Rf(t,e,n,r,a,s,o):pe}function sp(e,t,n,r,s){let o=he(t),a=he(n),i=qe(a,o);return i?r<=6?vf(o,a,r):Tf(e,t,n,i,r,s):pe}function Rf(e,t,n,r,s,o,a){let[i,c,u]=((h,p,g,E)=>{function y(){return T={...mn(C,R++*-E),...N},O=xr(h,T),qe(S,O)===-E}let w=Fe(p,h),N=je(ze,w),C=Fe(g,h),S=g.epochNanoseconds,R=0,L=mi(w,C),T,O;if(Math.sign(L)===-E&&R++,y()&&(E===-1||y()))throw new RangeError(Hn);let x=nt(tt(O,S));return[w,T,x]})(t,n,r,s);var d,l;return{...o===6?(d=i,l=c,{...pe,days:Lf(d,l)}):e.N(i,c,o,a),...Ws(u)}}function Tf(e,t,n,r,s,o){let[a,i,c]=((u,d,l)=>{let h=d,p=mi(u,d);return Math.sign(p)===-l&&(h=mn(d,-l),p+=Z*l),[u,h,p]})(t,n,r);return{...e.N(a,i,s,o),...Ws(c)}}function Js(e,t,n,r,s,o){return{...pe,...jn(_s(tt(e,t),r,s,o),n)}}function vf(e,t,n){return{...pe,...jn(tt(e,t),n)}}function Lf(e,t){return Qs(Ae(e),Ae(t))}function Qs(e,t){return Math.trunc((t-e)/De)}function mi(e,t){return Bt(t)-Bt(e)}function eo(e,t){if(e!==t)throw new RangeError(xd);return e}function Of(e){return this.m(e)[0]}function xf(e){return this.m(e)[1]}function pi(e){let[t]=this.v(e);return Qs(this.p(t),Ae(e))+1}function gi(e){let t=Sg.exec(e);if(!t)throw new RangeError(Cp(e));return[parseInt(t[1]),!!t[2]]}function Mr(e,t){return"M"+Je(e)+(t?"L":"")}function As(e,t,n){return e+(t||n&&e>=n?1:0)}function Ei(e,t){return e-(t&&e>=t?1:0)}function Mf(e,t){return(t+e)*(Math.sign(t)||1)||0}function ta(e){return Kd[Pf(e)]}function Df(e){return Bp[Pf(e)]}function Pf(e){return fn(e.id||G)}function op(e){function t(s){return((o,a)=>({...kf(o,a),o:o.month,day:parseInt(o.day)}))(Ia(n,s),r)}let n=Vi(e),r=fn(e);return{id:e,h:ap(t),l:ip(t)}}function ap(e){return Pe(t=>{let n=Ae(t);return e(n)},WeakMap)}function ip(e){let t=e(0).year-zp;return Pe(n=>{let r,s=Bn(n-t),o=0,a=[],i=[];do s+=400*De;while((r=e(s)).year<=n);do if(s+=(1-r.day)*De,r.year===n&&(a.push(s),i.push(r.o)),s-=De,++o>100||s<-Fi)throw new RangeError(Hn);while((r=e(s)).year>=n);return{i:a.reverse(),u:Pd(i.reverse())}})}function kf(e,t){let n,r,s=Ff(e);if(e.era){let o=Kd[t],a=qd[t]||{};o!==void 0&&(n=t==="islamic"?"ah":e.era.normalize("NFD").toLowerCase().replace(/[^a-z0-9]/g,""),n==="bc"||n==="b"?n="bce":n==="ad"||n==="a"?n="ce":n==="beforeroc"&&(n="broc"),n=a[n]||n,r=s,s=Mf(r,o[n]||0))}return{era:n,eraYear:r,year:s}}function Ff(e){return parseInt(e.relatedYear||e.year)}function Rs(e){let{year:t,o:n,day:r}=this.h(e),{u:s}=this.l(t);return[t,s[n]+1,r]}function Cr(e,t=1,n=1){return this.l(e).i[t-1]+(n-1)*De}function Uf(e,t){let n=Es.call(this,e);return[Ei(t,n),n===t]}function Es(e){let t=Qu(this,e),n=Qu(this,e-1),r=t.length;if(r>n.length){let s=Df(this);if(s<0)return-s;for(let o=0;o<r;o++)if(t[o]!==n[o])return o+1}}function hs(e){return Qs(Cr.call(this,e),Cr.call(this,e+1))}function Ju(e,t){let{i:n}=this.l(e),r=t+1,s=n;return r>n.length&&(r=1,s=this.l(e+1).i),Qs(n[t-1],s[r-1])}function ms(e){return this.l(e).i.length}function $f(e){let t=this.h(e);return[t.era,t.eraYear]}function Qu(e,t){return Object.keys(e.l(t).u)}function Wn(e){return Dr(ge(e))}function Dr(e){if((e=e.toLowerCase())!==G&&e!==Zn){let t=Vi(e).resolvedOptions().calendar;if(fn(e)!==fn(t))throw new RangeError(Ci(e));return t}return e}function fn(e){return e==="islamicc"&&(e="islamic"),e.split("-")[0]}function Bf(e,t){return n=>n===G?e:n===Zn||n===Kt?Object.assign(Object.create(e),{id:n}):Object.assign(Object.create(t),Ag(n))}function _f(e,t,n,r){let s=Yt(n,r,vt,[],$d);if(s.timeZone!==void 0){let o=n.F(s),a=Pr(s),i=e(s.timeZone);return{epochNanoseconds:Gn(t(i),{...o,...a},s.offset!==void 0?gn(s.offset):void 0),timeZone:i}}return{...n.F(s),...Re}}function Vf(e,t,n,r,s,o){let a=Yt(n,s,vt,Fd,$d),i=e(a.timeZone),[c,u,d]=Lr(o),l=n.F(a,Us(c)),h=Pr(a,c);return Ye(Gn(t(i),{...l,...h},a.offset!==void 0?gn(a.offset):void 0,u,d),i,r)}function Kf(e,t,n){let r=Yt(e,t,vt,[],ft),s=j(n);return We(ke({...e.F(r,Us(s)),...Pr(r,s)}))}function qf(e,t,n,r=[]){let s=Yt(e,t,vt,r);return e.F(s,n)}function Gf(e,t,n,r){let s=Yt(e,t,Li,r);return e.K(s,n)}function jf(e,t,n,r){let s=Yt(e,n,vt,Fr);return t&&s.month!==void 0&&s.monthCode===void 0&&s.year===void 0&&(s.year=At),e._(s,r)}function Yf(e,t){return Qe(Pr(Ge(e,ra,[],1),j(t)))}function Wf(e){let t=Ge(e,Oi);return ae(pn({...pe,...t}))}function Yt(e,t,n,r=[],s=[]){return Ge(t,[...e.fields(n),...s].sort(),r)}function Ge(e,t,n,r=!n){let s={},o,a=0;for(let i of t){if(i===o)throw new RangeError(Ep(i));if(i==="constructor"||i==="__proto__")throw new RangeError(gp(i));let c=e[i];if(c!==void 0)a=1,tc[i]&&(c=tc[i](c,i)),s[i]=c;else if(n){if(n.includes(i))throw new TypeError(Ni(i));s[i]=Vd[i]}o=i}if(r&&!a)throw new TypeError(Rd(t));return s}function Pr(e,t){return Vn(Ki({...Vd,...e}),t)}function zf(e,t,n,r,s){let{calendar:o,timeZone:a}=n,i=e(o),c=t(a),u=[...i.fields(vt),...Ud].sort(),d=(w=>{let N=Fe(w,B),C=qn(N.offsetNanoseconds),S=Eo(w.calendar),[R,L,T]=S.v(N),[O,x]=S.q(R,L),$=Mr(O,x);return{...Dg(N),year:R,monthCode:$,day:T,offset:C}})(n),l=Ge(r,u),h=i.k(d,l),p={...d,...l},[g,E,y]=Lr(s,2);return Ye(Gn(c,{...i.F(h,Us(g)),...Vn(Ki(p),g)},gn(p.offset),E,y),a,o)}function Hf(e,t,n,r){let s=e(t.calendar),o=[...s.fields(vt),...ft].sort(),a={...nd(i=t),hour:i.isoHour,minute:i.isoMinute,second:i.isoSecond,millisecond:i.isoMillisecond,microsecond:i.isoMicrosecond,nanosecond:i.isoNanosecond};var i;let c=Ge(n,o),u=j(r),d=s.k(a,c),l={...a,...c};return We(ke({...s.F(d,Us(u)),...Vn(Ki(l),u)}))}function Zf(e,t,n,r){let s=e(t.calendar),o=s.fields(vt).sort(),a=nd(t),i=Ge(n,o),c=s.k(a,i);return s.F(c,r)}function Xf(e,t,n,r){let s=e(t.calendar),o=s.fields(Li).sort(),a=(u=>{let d=Eo(u.calendar),[l,h]=d.v(u),[p,g]=d.q(l,h);return{year:l,monthCode:Mr(p,g)}})(t),i=Ge(n,o),c=s.k(a,i);return s.K(c,r)}function Jf(e,t,n,r){let s=e(t.calendar),o=s.fields(vt).sort(),a=(u=>{let d=Eo(u.calendar),[l,h,p]=d.v(u),[g,E]=d.q(l,h);return{monthCode:Mr(g,E),day:p}})(t),i=Ge(n,o),c=s.k(a,i);return s._(c,r)}function Qf(e,t,n){return Qe(((r,s,o)=>Pr({...je(ra,r),...Ge(s,ra)},j(o)))(e,t,n))}function ed(e,t){return ae((n=e,r=t,pn({...n,...Ge(r,Oi)})));var n,r}function td(e,t,n,r,s){t=je(n=e.fields(n),t),r=Ge(r,s=e.fields(s),[]);let o=e.k(t,r);return o=Ge(o,[...n,...s].sort(),[]),e.F(o)}function Zo(e,t){let n=ta(e),r=qd[e.id||""]||{},{era:s,eraYear:o,year:a}=t;if(s!==void 0||o!==void 0){if(s===void 0||o===void 0)throw new TypeError(wp);if(!n)throw new RangeError(yp);let i=n[r[s]||s];if(i===void 0)throw new RangeError(bp(s));let c=Mf(o,i);if(a!==void 0&&a!==c)throw new RangeError(Ip);a=c}else if(a===void 0)throw new TypeError(Np(n));return a}function ps(e,t,n,r){let{month:s,monthCode:o}=t;if(o!==void 0){let a=((i,c,u,d)=>{let l=i.L(u),[h,p]=gi(c),g=As(h,p,l);if(p){let E=Df(i);if(E===void 0)throw new RangeError(pr);if(E>0){if(g>E)throw new RangeError(pr);if(l===void 0){if(d===1)throw new RangeError(pr);g--}}else{if(g!==-E)throw new RangeError(pr);if(l===void 0&&d===1)throw new RangeError(pr)}}return g})(e,o,n,r);if(s!==void 0&&s!==a)throw new RangeError(Sp);s=a,r=1}else if(s===void 0)throw new TypeError(Od);return Rt("month",s,1,e.B(n),r)}function Xo(e,t,n,r,s){return xe(t,"day",1,e.U(r,n),s)}function Jo(e,t,n,r){let s=0,o=[];for(let a of n)t[a]!==void 0?s=1:o.push(a);if(Object.assign(e,t),s)for(let a of r||o)delete e[a]}function nd(e){let t=Eo(e.calendar),[n,r,s]=t.v(e),[o,a]=t.q(n,r);return{year:n,monthCode:Mr(o,a),day:s}}function rd(e){return lt(at(ga(ha(e))))}function sd(e,t,n,r,s=G){return Ye(at(ga(ha(n))),t(r),e(s))}function od(e,t,n,r,s=0,o=0,a=0,i=0,c=0,u=0,d=G){return We(ke(Ps(st(Se,$n(uo,[t,n,r,s,o,a,i,c,u])))),e(d))}function ad(e,t,n,r,s=G){return ut(Xe(hn(st(Se,{isoYear:t,isoMonth:n,isoDay:r}))),e(s))}function id(e,t,n,r=G,s=1){let o=Se(t),a=Se(n),i=e(r);return Ir(ya(hn({isoYear:o,isoMonth:a,isoDay:Se(s)})),i)}function ld(e,t,n,r=G,s=At){let o=Se(t),a=Se(n),i=e(r);return Ns(Xe(hn({isoYear:Se(s),isoMonth:o,isoDay:a})),i)}function ud(e=0,t=0,n=0,r=0,s=0,o=0){return Qe(Vn(st(Se,$n(ze,[e,t,n,r,s,o])),1))}function cd(e=0,t=0,n=0,r=0,s=0,o=0,a=0,i=0,c=0,u=0){return ae(pn(st(ma,$n(Y,[e,t,n,r,s,o,a,i,c,u]))))}function fd(e,t,n=G){return Ye(e.epochNanoseconds,t,n)}function dd(e){return lt(e.epochNanoseconds)}function yi(e,t){return We(Fe(t,e))}function wi(e,t){return ut(Fe(t,e))}function Ii(e,t){return Qe(Fe(t,e))}function hd(e,t,n,r){let s=((o,a,i,c)=>{let u=(d=>Jd(it(d)))(c);return xr(o(a),i,u)})(e,n,t,r);return Ye(at(s),n,t.calendar)}function md(e,t,n,r,s){let o=e(s.timeZone),a=s.plainTime,i=a!==void 0?t(a):void 0,c=n(o),u;return u=i?xr(c,{...r,...i}):Vt(c,{...r,...Re}),Ye(u,o,r.calendar)}function pd(e,t=Re){return We(ke({...e,...t}))}function gd(e,t,n){return((r,s)=>{let o=Yt(r,s,Bd);return r.K(o,void 0)})(e(t.calendar),n)}function Ed(e,t,n){return((r,s)=>{let o=Yt(r,s,_d);return r._(o)})(e(t.calendar),n)}function yd(e,t,n,r){return((s,o,a)=>td(s,o,Bd,vr(a),Fr))(e(t.calendar),n,r)}function wd(e,t,n,r){return((s,o,a)=>td(s,o,_d,vr(a),Ri))(e(t.calendar),n,r)}function Id(e){return lt(at(wr(ma(e),ct)))}function bd(e){return lt(at(ga(ha(e))))}function yn(e,t,n){let r=new Set(n);return(s,o)=>{let a=n&&qu(s,n);if(!qu(s=((i,c)=>{let u={};for(let d in c)i.has(d)||(u[d]=c[d]);return u})(r,s),e)){if(o&&a)throw new TypeError("Invalid formatting options");s={...t,...s}}return n&&(s.timeZone=In,["full","long"].includes(s.J)&&(s.J="medium")),s}}function Tt(e,t=bi,n=0){let[r,,,s]=e;return(o,a=Jg,...i)=>{let c=t(s&&s(...i),o,a,r,n),u=c.resolvedOptions();return[c,...lp(e,u,i)]}}function bi(e,t,n,r,s){if(n=r(n,s),e){if(n.timeZone!==void 0)throw new TypeError(kp);n.timeZone=e}return new Lt(t,n)}function lp(e,t,n){let[,r,s]=e;return n.map(o=>(o.calendar&&((a,i,c)=>{if((c||a!==G)&&a!==i)throw new RangeError(xd)})(o.calendar,t.calendar,s),r(o,t)))}function Nd(e,t,n){let r=t.timeZone,s=e(r),o={...Fe(t,s),...n||Re},a;return a=n?Gn(s,o,o.offsetNanoseconds,2):Vt(s,o),Ye(a,r,t.calendar)}function Cd(e,t=Re){return We(ke({...e,...t}))}function to(e,t){return{...e,calendar:t}}function Sd(e,t){return{...e,timeZone:t}}function no(e){let t=ro();return _n(t,e.R(t))}function ro(){return wr(Date.now(),ct)}function zn(){return nc||(nc=new Lt().resolvedOptions().timeZone)}var up=(e,t)=>`Non-integer ${e}: ${t}`,cp=(e,t)=>`Non-positive ${e}: ${t}`,fp=(e,t)=>`Non-finite ${e}: ${t}`,dp=e=>`Cannot convert bigint to ${e}`,hp=e=>`Invalid bigint: ${e}`,mp="Cannot convert Symbol to string",pp="Invalid object",Ad=(e,t,n,r,s)=>s?Ad(e,s[t],s[n],s[r]):Wt(e,t)+`; must be between ${n}-${r}`,Wt=(e,t)=>`Invalid ${e}: ${t}`,Ni=e=>`Missing ${e}`,gp=e=>`Invalid field ${e}`,Ep=e=>`Duplicate field ${e}`,Rd=e=>"No valid fields: "+e.join(),Td="Invalid bag",vd=(e,t,n)=>Wt(e,t)+"; must be "+Object.keys(n).join(),Ld="Cannot use valueOf",so="Invalid calling context",yp="Forbidden era/eraYear",wp="Mismatching era/eraYear",Ip="Mismatching year/eraYear",bp=e=>`Invalid era: ${e}`,Np=e=>"Missing year"+(e?"/era/eraYear":""),Cp=e=>`Invalid monthCode: ${e}`,Sp="Mismatching month/monthCode",Od="Missing month/monthCode",pr="Invalid leap month",Hn="Invalid protocol results",Ci=e=>Wt("Calendar",e),xd="Mismatching Calendars",Si=e=>Wt("TimeZone",e),Md="Mismatching TimeZones",Ap="Forbidden ICU TimeZone",Rp="Out-of-bounds offset",Tp="Out-of-bounds TimeZone gap",vp="Invalid TimeZone offset",Lp="Ambiguous offset",zt="Out-of-bounds date",Op="Out-of-bounds duration",xp="Cannot mix duration signs",oo="Missing relativeTo",Mp="Cannot use large units",Dp="Required smallestUnit or largestUnit",Pp="smallestUnit > largestUnit",Me=e=>`Cannot parse: ${e}`,St=e=>`Invalid substring: ${e}`,Dd=e=>`Cannot format ${e}`,ao="Mismatching types for formatting",kp="Cannot specify TimeZone",Pd=q(Rr,(e,t)=>t),Fn=q(Rr,(e,t,n)=>n),Je=q(Is,2),na={nanosecond:0,microsecond:1,millisecond:2,second:3,minute:4,hour:5,day:6,week:7,month:8,year:9},Ai=Object.keys(na),De=864e5,kd=1e3,kr=1e3,ct=1e6,et=1e9,io=6e10,lo=36e11,Z=864e11,rt=[1,kr,ct,et,io,lo,Z],ft=Ai.slice(0,6),ra=Tr(ft),Fp=["offset"],Fd=["timeZone"],Ud=ft.concat(Fp),$d=Ud.concat(Fd),sa=["era","eraYear"],Up=sa.concat(["year"]),Ri=["year"],Ti=["monthCode"],vi=["month"].concat(Ti),Fr=["day"],Li=vi.concat(Ri),Bd=Ti.concat(Ri),vt=Fr.concat(Li),$p=Fr.concat(vi),_d=Fr.concat(Ti),Vd=Fn(ft,0),G="iso8601",Zn="gregory",Kt="japanese",Kd={[Zn]:{"gregory-inverse":-1,gregory:0},[Kt]:{"japanese-inverse":-1,japanese:0,meiji:1867,taisho:1911,showa:1925,heisei:1988,reiwa:2018},ethiopic:{ethioaa:0,ethiopic:5500},coptic:{"coptic-inverse":-1,coptic:0},roc:{"roc-inverse":-1,roc:0},buddhist:{be:0},islamic:{ah:0},indian:{saka:0},persian:{ap:0}},qd={[Zn]:{bce:"gregory-inverse",ce:"gregory"},[Kt]:{bce:"japanese-inverse",ce:"japanese"},ethiopic:{era0:"ethioaa",era1:"ethiopic"},coptic:{era0:"coptic-inverse",era1:"coptic"},roc:{broc:"roc-inverse",minguo:"roc"}},Bp={chinese:13,dangi:13,hebrew:-6},ge=q(ca,"string"),Gd=q(ca,"boolean"),_p=q(ca,"number"),Y=Ai.map(e=>e+"s"),Oi=Tr(Y),Vp=Y.slice(0,6),jd=Y.slice(6),Kp=jd.slice(1),qp=Pd(Y),pe=Fn(Y,0),xi=Fn(Vp,0),Mi=q(ac,Y),ze=["isoNanosecond","isoMicrosecond","isoMillisecond","isoSecond","isoMinute","isoHour"],Di=["isoDay","isoMonth","isoYear"],uo=ze.concat(Di),Pi=Tr(Di),Yd=Tr(ze),Gp=Tr(uo),Re=Fn(Yd,0),jp=q(ac,uo),ki=1e8,Fi=ki*De,Yp=[ki,0],Wp=[-ki,0],Sr=275760,Ar=-271821,Lt=Intl.DateTimeFormat,Wd="en-GB",zp=1970,At=1972,kt=12,Hp=Bn(1868,9,8),Zp=Pe(Hm,WeakMap),Ts="smallestUnit",oa="unit",Er="roundingIncrement",Qo="fractionalSecondDigits",zd="relativeTo",ea="direction",Hd={constrain:0,reject:1},Xp=Object.keys(Hd),Jp={compatible:0,reject:1,earlier:2,later:3},Qp={reject:0,use:1,prefer:2,ignore:3},eg={auto:0,never:1,critical:2,always:3},tg={auto:0,never:1,critical:2},ng={auto:0,never:1},rg={floor:0,halfFloor:1,ceil:2,halfCeil:3,trunc:4,halfTrunc:5,expand:6,halfExpand:7,halfEven:8},sg={previous:-1,next:1},Ur=q(Ta,Ts),Zd=q(Ta,"largestUnit"),og=q(Ta,oa),Xd=q(qt,"overflow",Hd),Jd=q(qt,"disambiguation",Jp),ag=q(qt,"offset",Qp),Ui=q(qt,"calendarName",eg),ig=q(qt,"timeZoneName",tg),lg=q(qt,"offset",ng),$r=q(qt,"roundingMode",rg),co="PlainYearMonth",fo="PlainMonthDay",Xn="PlainDate",wn="PlainDateTime",ho="PlainTime",Ot="ZonedDateTime",mo="Instant",po="Duration",ug=[Math.floor,e=>ds(e)?Math.floor(e):Math.round(e),Math.ceil,e=>ds(e)?Math.ceil(e):Math.round(e),Math.trunc,e=>ds(e)?Math.trunc(e)||0:Math.round(e),e=>e<0?Math.floor(e):Math.ceil(e),e=>Math.sign(e)*Math.round(Math.abs(e))||0,e=>ds(e)?(e=Math.trunc(e)||0)+e%2:Math.round(e)],In="UTC",ys=5184e3,cg=bs(1847),fg=bs(new Date().getUTCFullYear()+10),dg=/0+$/,Fe=Pe(tp,WeakMap),ec=2**32-1,B=Pe(e=>{let t=si(e);return typeof t=="object"?new ia(t):new aa(t||0)}),aa=class{constructor(t){this.$=t}R(){return this.$}I(t){return(n=>{let r=he({...n,...Re});if(!r||Math.abs(r[0])>1e8)throw new RangeError(zt)})(t),[wa(t,this.$)]}O(){}},ia=class{constructor(t){this.nn=(n=>{function r(u){let d=yr(u,i,c),[l,h]=Zu(d),p=o(l),g=o(h);return p===g?p:s(a(l,h),p,g,u)}function s(u,d,l,h){let p,g;for(;(h===void 0||(p=h<u[0]?d:h>=u[1]?l:void 0)===void 0)&&(g=u[1]-u[0]);){let E=u[0]+Math.floor(g/2);n(E)===l?u[1]=E:u[0]=E+1}return p}let o=Pe(n),a=Pe(np),i=cg,c=fg;return{tn(u){let d=r(u-86400),l=r(u+86400),h=u-d,p=u-l;if(d===l)return[h];let g=r(h);return g===r(p)?[u-g]:d>l?[h,p]:[]},rn:r,O(u,d){let l=yr(u,i,c),[h,p]=Zu(l),g=ys*d,E=d<0?()=>p>i||(i=l,0):()=>h<c||(c=l,0);for(;E();){let y=o(h),w=o(p);if(y!==w){let N=a(h,p);s(N,y,w);let C=N[0];if((Ft(C,u)||1)===d)return C}h+=g,p+=g}}}})((n=>r=>{let s=Ia(n,r*kd);return bs(Ff(s),parseInt(s.month),parseInt(s.day),parseInt(s.hour),parseInt(s.minute),parseInt(s.second))-r})(t))}R(t){return this.nn.rn((n=>Yu(n)[0])(t))*et}I(t){let[n,r]=[bs((s=t).isoYear,s.isoMonth,s.isoDay,s.isoHour,s.isoMinute,s.isoSecond),s.isoMillisecond*ct+s.isoMicrosecond*kr+s.isoNanosecond];var s;return this.nn.tn(n).map(o=>at(un(wr(o,et),r)))}O(t,n){let[r,s]=Yu(t),o=this.nn.O(r+(n>0||s?1:0),n);if(o!==void 0)return wr(o,et)}},$i="([+-])",ws="(?:[.,](\\d{1,9}))?",Qd=`(?:(?:${$i}(\\d{6}))|(\\d{4}))-?(\\d{2})`,Bi="(\\d{2})(?::?(\\d{2})(?::?(\\d{2})"+ws+")?)?",_i=$i+Bi,hg=Qd+"-?(\\d{2})(?:[T ]"+Bi+"(Z|"+_i+")?)?",eh="\\[(!?)([^\\]]*)\\]",go=`((?:${eh}){0,9})`,mg=Yn(Qd+go),pg=Yn("(?:--)?(\\d{2})-?(\\d{2})"+go),gg=Yn(hg+go),Eg=Yn("T?"+Bi+"(?:"+_i+")?"+go),yg=Yn(_i),wg=new RegExp(eh,"g"),Ig=Yn(`${$i}?P(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(?:T(?:(\\d+)${ws}H)?(?:(\\d+)${ws}M)?(?:(\\d+)${ws}S)?)?`),bg=Pe(e=>new Lt(Wd,{timeZone:e,era:"short",year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"})),Ng=/^(AC|AE|AG|AR|AS|BE|BS|CA|CN|CS|CT|EA|EC|IE|IS|JS|MI|NE|NS|PL|PN|PR|PS|SS|VS)T$/,Cg=/[^\w\/:+-]+/,Sg=/^M(\d{2})(L?)$/,Ag=Pe(op),Vi=Pe(e=>new Lt(Wd,{calendar:e,timeZone:In,era:"short",year:"numeric",month:"short",day:"numeric"})),th={P(e,t,n){let r=j(n),s,{years:o,months:a,weeks:i,days:c}=t;if(c+=me(t,5)[0],o||a)s=((u,d,l,h,p)=>{let[g,E,y]=u.v(d);if(l){let[w,N]=u.q(g,E);g+=l,E=As(w,N,u.L(g)),E=Rt("month",E,1,u.B(g),p)}return h&&([g,E]=u.un(g,E,h)),y=Rt("day",y,1,u.U(g,E),p),u.p(g,E,y)})(this,e,o,a,r);else{if(!i&&!c)return e;s=Ae(e)}if(s===void 0)throw new RangeError(zt);return s+=(7*i+c)*De,Xe(Ds(s))},N(e,t,n){if(n<=7){let c=0,u=Lf({...e,...Re},{...t,...Re});return n===7&&([c,u]=$t(u,7)),{...pe,weeks:c,days:u}}let r=this.v(e),s=this.v(t),[o,a,i]=((c,u,d,l,h,p,g)=>{let E=h-u,y=p-d,w=g-l;if(E||y){let N=Math.sign(E||y),C=c.U(h,p),S=0;if(Math.sign(w)===-N){let R=C;[h,p]=c.un(h,p,-N),E=h-u,y=p-d,C=c.U(h,p),S=N<0?-R:C}if(w=g-Math.min(l,C)+S,E){let[R,L]=c.q(u,d),[T,O]=c.q(h,p);if(y=T-R||Number(O)-Number(L),Math.sign(y)===-N){let x=N<0&&-c.B(h);E=(h-=N)-u,y=p-As(R,L,c.L(h))+(x||c.B(h))}}}return[E,y,w]})(this,...r,...s);return n===8&&(a+=this.cn(o,r[0]),o=0),{...pe,years:o,months:a,days:i}},F(e,t){let n=j(t),r=Zo(this,e),s=ps(this,e,r,n),o=Xo(this,e,s,r,n);return ut(Xe(this.V(r,s,o)),this.id||G)},K(e,t){let n=j(t),r=Zo(this,e),s=ps(this,e,r,n);return Ir(ya(this.V(r,s,1)),this.id||G)},_(e,t){let n=j(t),r,s,o,a=e.eraYear!==void 0||e.year!==void 0?Zo(this,e):void 0,i=!this.id;if(a===void 0&&i&&(a=At),a!==void 0){let l=ps(this,e,a,n);r=Xo(this,e,l,a,n);let h=this.L(a);s=Ei(l,h),o=l===h}else{if(e.monthCode===void 0)throw new TypeError(Od);if([s,o]=gi(e.monthCode),this.id&&this.id!==Zn&&this.id!==Kt)if(this.id&&fn(this.id)==="coptic"&&n===0){let l=o||s!==13?30:6;r=e.day,r=yr(r,1,l)}else if(this.id&&fn(this.id)==="chinese"&&n===0){let l=!o||s!==1&&s!==9&&s!==10&&s!==11&&s!==12?30:29;r=e.day,r=yr(r,1,l)}else r=e.day;else r=Xo(this,e,ps(this,e,At,n),At,n)}let c=this.G(s,o,r);if(!c)throw new RangeError("Cannot guess year");let[u,d]=c;return Ns(Xe(this.V(u,d,r)),this.id||G)},fields(e){return ta(this)&&e.includes("year")?[...e,...sa]:e},k(e,t){let n=Object.assign(Object.create(null),e);return Jo(n,t,vi),ta(this)&&(Jo(n,t,Up),this.id===Kt&&Jo(n,t,$p,sa)),n},inLeapYear(e){let[t]=this.v(e);return this.sn(t)},monthsInYear(e){let[t]=this.v(e);return this.B(t)},daysInMonth(e){let[t,n]=this.v(e);return this.U(t,n)},daysInYear(e){let[t]=this.v(e);return this.fn(t)},dayOfYear:pi,era(e){return this.hn(e)[0]},eraYear(e){return this.hn(e)[1]},monthCode(e){let[t,n]=this.v(e),[r,s]=this.q(t,n);return Mr(r,s)},dayOfWeek:wc,daysInWeek(){return 7}},Rg={v:ba,hn:Ic,q:pc},Tg={dayOfYear:pi,v:ba,p:Bn},vg=Object.assign({},Tg,{weekOfYear:Of,yearOfWeek:xf,m(e){function t(p){return(7-p<r?7:0)-p}function n(p){let g=yc(h+p),E=p||1,y=t(gr(c+g*E,7));return d=(g+(y-u)*E)/7}let r=this.id?1:4,s=wc(e),o=this.dayOfYear(e),a=gr(s-1,7),i=o-1,c=gr(a-i,7),u=t(c),d,l=Math.floor((i-u)/7)+1,h=e.isoYear;return l?l>n(0)&&(l=1,h++):(l=n(-1),h--),[l,h,d]}}),Lg=Object.assign({},th,vg,{v:ba,hn:Ic,q:pc,G(e,t){if(!t)return[At,e]},sn:Na,L(){},B:gc,cn:e=>e*kt,U:Ec,fn:yc,V:(e,t,n)=>({isoYear:e,isoMonth:t,isoDay:n}),p:Bn,un:(e,t,n)=>(e+=Ls(n,kt),(t+=la(n,kt))<1?(e--,t+=kt):t>kt&&(e++,t-=kt),[e,t]),year(e){return e.isoYear},month(e){return e.isoMonth},day:e=>e.isoDay}),Og={v:Rs,hn:$f,q:Uf},xg={dayOfYear:pi,v:Rs,p:Cr,weekOfYear:Of,yearOfWeek:xf,m(){return[]}},Mg=Object.assign({},th,xg,{v:Rs,hn:$f,q:Uf,G(e,t,n){let r=this.id&&fn(this.id)==="chinese"?((u,d,l)=>{if(d)switch(u){case 1:return 1651;case 2:return l<30?1947:1765;case 3:return l<30?1966:1955;case 4:return l<30?1963:1944;case 5:return l<30?1971:1952;case 6:return l<30?1960:1941;case 7:return l<30?1968:1938;case 8:return l<30?1957:1718;case 9:return 1832;case 10:return 1870;case 11:return 1814;case 12:return 1890}return 1972})(e,t,n):At,[s,o,a]=Rs.call(this,{isoYear:r,isoMonth:kt,isoDay:31}),i=Es.call(this,s),c=o===i;(Ft(e,Ei(o,i))||Ft(Number(t),Number(c))||Ft(n,a))===1&&s--;for(let u=0;u<100;u++){let d=s-u,l=Es.call(this,d),h=As(e,t,l);if(t===(h===l)&&n<=Ju.call(this,d,h))return[d,h]}},sn(e){let t=hs.call(this,e);return t>hs.call(this,e-1)&&t>hs.call(this,e+1)},L:Es,B:ms,cn(e,t){let n=t+e,r=Math.sign(e),s=r<0?-1:0,o=0;for(let a=t;a!==n;a+=r)o+=ms.call(this,a+s);return o},U:Ju,fn:hs,V(e,t,n){return Ds(Cr.call(this,e,t,n))},p:Cr,un(e,t,n){if(n){if(t+=n,!Number.isSafeInteger(t))throw new RangeError(zt);if(n<0)for(;t<1;)t+=ms.call(this,--e);else{let r;for(;t>(r=ms.call(this,e));)t-=r,e++}}return[e,t]},year(e){return this.h(e).year},month(e){let{year:t,o:n}=this.h(e),{u:r}=this.l(t);return r[n]+1},day(e){return this.h(e).day}}),Eo=Bf(Rg,Og),U=Bf(Lg,Mg),tc={era:gs,eraYear:Se,year:Se,month:ju,monthCode(e){let t=gs(e);return gi(t),t},day:ju,...Fn(ft,Se),...Fn(Y,ma),offset(e){let t=gs(e);return gn(t),t}},Ki=q(sc,ft,ze),Dg=q(sc,ze,ft),Ut="numeric",Br=["timeZoneName"],nh={month:Ut,day:Ut},qi={year:Ut,month:Ut},Gi=Object.assign({},qi,{day:Ut}),ji={hour:Ut,minute:Ut,second:Ut},Yi=Object.assign({},Gi,ji),Pg=Object.assign({},Yi,{timeZoneName:"short"}),kg=Object.keys(qi),Fg=Object.keys(nh),Ug=Object.keys(Gi),$g=Object.keys(ji),Wi=["dateStyle"],Bg=kg.concat(Wi),_g=Fg.concat(Wi),zi=Ug.concat(Wi,["weekday"]),_r=$g.concat(["dayPeriod","timeStyle","fractionalSecondDigits"]),Hi=zi.concat(_r),Vg=Br.concat(_r),Kg=Br.concat(zi),qg=Br.concat(["day","weekday"],_r),Gg=Br.concat(["year","weekday"],_r),jg=yn(Hi,Yi),Yg=yn(Hi,Pg),Wg=yn(Hi,Yi,Br),zg=yn(zi,Gi,Vg),Hg=yn(_r,ji,Kg),Zg=yn(Bg,qi,qg),Xg=yn(_g,nh,Gg),Jg={},rh=new Lt(void 0,{calendar:G}).resolvedOptions().calendar===G,Zi=[jg,$s],sh=[Yg,$s,0,(e,t)=>{let n=e.timeZone;if(t&&t.timeZone!==n)throw new RangeError(Md);return n}],Xi=[Wg,Ae],Ji=[zg,Ae],Qi=[Hg,e=>Bt(e)/ct],el=[Zg,Ae,rh],tl=[Xg,Ae,rh],nc;function Jt(e,t,n,r,s){function o(...c){if(!(this instanceof o))throw new TypeError(so);ih(this,t(...c))}function a(c,u){return Object.defineProperties(function(...d){return c.call(this,i(this),...d)},Un(u))}function i(c){let u=Le(c);if(!u||u.branding!==e)throw new TypeError(so);return u}return Object.defineProperties(o.prototype,{...rc(st(a,n)),...dn(st(a,r)),...vs("Temporal."+e)}),Object.defineProperties(o,{...dn(s),...Un(e)}),[o,c=>{let u=Object.create(o.prototype);return ih(u,c),u},i]}function rr(e){if(Le(e)||e.calendar!==void 0||e.timeZone!==void 0)throw new TypeError(Td);return e}function qr(e){return lh(e)||G}function lh(e){let{calendar:t}=e;if(t!==void 0)return Io(t)}function Io(e){if(ye(e)){let{calendar:t}=Le(e)||{};if(!t)throw new TypeError(Ci(e));return t}return(t=>Dr(af(ge(t))))(e)}function sl(e){let t={};for(let n in e)t[n]=r=>{let{calendar:s}=r;return U(s)[n](r)};return t}function Qt(){throw new TypeError(Ld)}function He(e){if(ye(e)){let{timeZone:t}=Le(e)||{};if(!t)throw new TypeError(Si(e));return t}return(t=>Zs(lf(ge(t))))(e)}function le(e){if(ye(e)){let t=Le(e);return t&&t.branding===po?t:Wf(e)}return of(e)}function Vr(e){if(e!==void 0){if(ye(e)){let t=Le(e)||{};switch(t.branding){case Ot:case Xn:return t;case wn:return ut(t)}let n=qr(e);return{..._f(He,B,U(n),e),calendar:n}}return Qc(e)}}function Ht(e,t){if(ye(e)){let r=Le(e)||{};switch(r.branding){case ho:return j(t),r;case wn:return j(t),Qe(r);case Ot:return j(t),Ii(B,r)}return Yf(e,t)}let n=sf(e);return j(t),n}function ol(e){return e===void 0?void 0:Ht(e)}function Jn(e,t){if(ye(e)){let r=Le(e)||{};switch(r.branding){case wn:return j(t),r;case Xn:return j(t),We({...r,...Re});case Ot:return j(t),yi(B,r)}return Kf(U(qr(e)),e,t)}let n=tf(e);return j(t),n}function oh(e,t){if(ye(e)){let r=Le(e);if(r&&r.branding===fo)return j(t),r;let s=lh(e);return jf(U(s||G),!s,e,t)}let n=rf(U,e);return j(t),n}function Qn(e,t){if(ye(e)){let r=Le(e);return r&&r.branding===co?(j(t),r):Gf(U(qr(e)),e,t)}let n=nf(U,e);return j(t),n}function er(e,t){if(ye(e)){let r=Le(e)||{};switch(r.branding){case Xn:return j(t),r;case wn:return j(t),ut(r);case Ot:return j(t),wi(B,r)}return qf(U(qr(e)),e,t)}let n=zs(e);return j(t),n}function tr(e,t){if(ye(e)){let n=Le(e);if(n&&n.branding===Ot)return Lr(t),n;let r=qr(e);return Vf(He,B,U(r),r,e,t)}return ef(e,t)}function ah(e){return st(t=>n=>t(nl(n)),e)}function nl(e){return Fe(e,B)}function nr(e){if(ye(e)){let t=Le(e);if(t)switch(t.branding){case mo:return t;case Ot:return lt(t.epochNanoseconds)}}return Jc(e)}function Qg(){function e(o,a){return new t(o,a)}function t(o,a=Object.create(null)){wo.set(this,((i,c)=>{let u=new Lt(i,c),d=u.resolvedOptions(),l=d.locale,h=je(Object.keys(c),d),p=Pe(nE),g=(E,...y)=>{if(E){if(y.length!==2)throw new TypeError(ao);for(let S of y)if(S===void 0)throw new TypeError(ao)}E||y[0]!==void 0||(y=[]);let w=y.map(S=>Le(S)||Number(S)),N,C=0;for(let S of w){let R=typeof S=="object"?S.branding:void 0;if(C++&&R!==N)throw new TypeError(ao);N=R}return N?p(N)(l,h,...w):[u,...w]};return g.X=u,g})(o,a))}let n=Lt.prototype,r=Object.getOwnPropertyDescriptors(n),s=Object.getOwnPropertyDescriptors(Lt);for(let o in r){let a=r[o],i=o.startsWith("format")&&eE(o);typeof a.value=="function"?a.value=o==="constructor"?e:i||tE(o):i&&(a.get=function(){if(!wo.has(this))throw new TypeError(so);return(...c)=>i.apply(this,c)},Object.defineProperties(a.get,Un(`get ${o}`)))}return s.prototype.value=t.prototype=Object.create({},r),Object.defineProperties(e,s),e}function eE(e){return Object.defineProperties(function(...t){let n=wo.get(this),[r,...s]=n(e.includes("Range"),...t);return r[e](...s)},Un(e))}function tE(e){return Object.defineProperties(function(...t){return wo.get(this).X[e](...t)},Un(e))}function nE(e){let t=lE[e];if(!t)throw new TypeError(Dd(e));return Tt(t,Pe(bi),1)}var yo=new WeakMap,Le=yo.get.bind(yo),ih=yo.set.bind(yo),uh={era:lc,eraYear:ua,year:xs,month:ot,daysInMonth:ot,daysInYear:ot,inLeapYear:Gd,monthsInYear:ot},al={monthCode:ge},ch={day:ot},rE={dayOfWeek:ot,dayOfYear:ot,weekOfYear:uc,yearOfWeek:ua,daysInWeek:ot},il=sl(Object.assign({},uh,al,ch,rE)),sE=sl({...uh,...al}),oE=sl({...al,...ch}),Gr={calendarId:e=>e.calendar},aE=Rr(e=>t=>t[e],Y.concat("sign")),ll=Rr((e,t)=>n=>n[ze[t]],ft),fh={epochMilliseconds:$s,epochNanoseconds:Tc},[iE,re,Bb]=Jt(po,cd,{...aE,blank:Hc},{with:(e,t)=>re(ed(e,t)),negated:e=>re(Ys(e)),abs:e=>re(zc(e)),add:(e,t,n)=>re(Xa(Vr,U,B,0,e,le(t),n)),subtract:(e,t,n)=>re(Xa(Vr,U,B,1,e,le(t),n)),round:(e,t)=>re(Wc(Vr,U,B,e,t)),total:(e,t)=>Lc(Vr,U,B,e,t),toLocaleString(e,t,n){return Intl.DurationFormat?new Intl.DurationFormat(t,n).format(this):Ks(e)},toString:Ks,toJSON:e=>Ks(e),valueOf:Qt},{from:e=>re(le(e)),compare:(e,t,n)=>gf(Vr,U,B,le(e),le(t),n)}),lE={Instant:Zi,PlainDateTime:Xi,PlainDate:Ji,PlainTime:Qi,PlainYearMonth:el,PlainMonthDay:tl},uE=Tt(Zi),cE=Tt(sh),fE=Tt(Xi),dE=Tt(Ji),hE=Tt(Qi),mE=Tt(el),pE=Tt(tl),[gE,Xt]=Jt(ho,ud,ll,{with(e,t,n){return Xt(Qf(this,rr(t),n))},add:(e,t)=>Xt(Ya(0,e,le(t))),subtract:(e,t)=>Xt(Ya(1,e,le(t))),until:(e,t,n)=>re(hi(0,e,Ht(t),n)),since:(e,t,n)=>re(hi(1,e,Ht(t),n)),round:(e,t)=>Xt(Dc(e,t)),equals:(e,t)=>Cf(e,Ht(t)),toLocaleString(e,t,n){let[r,s]=hE(t,n,e);return r.format(s)},toString:Ua,toJSON:e=>Ua(e),valueOf:Qt},{from:(e,t)=>Xt(Ht(e,t)),compare:(e,t)=>Xs(Ht(e),Ht(t))}),[EE,dt]=Jt(wn,q(od,Wn),{...Gr,...il,...ll},{with:(e,t,n)=>dt(Hf(U,e,rr(t),n)),withCalendar:(e,t)=>dt(to(e,Io(t))),withPlainTime:(e,t)=>dt(Cd(e,ol(t))),add:(e,t,n)=>dt(qa(U,0,e,le(t),n)),subtract:(e,t,n)=>dt(qa(U,1,e,le(t),n)),until:(e,t,n)=>re(ci(U,0,e,Jn(t),n)),since:(e,t,n)=>re(ci(U,1,e,Jn(t),n)),round:(e,t)=>dt(Mc(e,t)),equals:(e,t)=>wf(e,Jn(t)),toZonedDateTime:(e,t,n)=>ve(hd(B,e,He(t),n)),toPlainDate:e=>ht(ut(e)),toPlainTime:e=>Xt(Qe(e)),toLocaleString(e,t,n){let[r,s]=fE(t,n,e);return r.format(s)},toString:Da,toJSON:e=>Da(e),valueOf:Qt},{from:(e,t)=>dt(Jn(e,t)),compare:(e,t)=>ii(Jn(e),Jn(t))}),[yE,rl,_b]=Jt(fo,q(ld,Wn),{...Gr,...oE},{with:(e,t,n)=>rl(Jf(U,e,rr(t),n)),equals:(e,t)=>Nf(e,oh(t)),toPlainDate(e,t){return ht(wd(U,e,this,t))},toLocaleString(e,t,n){let[r,s]=pE(t,n,e);return r.format(s)},toString:Fa,toJSON:e=>Fa(e),valueOf:Qt},{from:(e,t)=>rl(oh(e,t))}),[wE,Kr,Vb]=Jt(co,q(id,Wn),{...Gr,...sE},{with:(e,t,n)=>Kr(Xf(U,e,rr(t),n)),add:(e,t,n)=>Kr(ja(U,0,e,le(t),n)),subtract:(e,t,n)=>Kr(ja(U,1,e,le(t),n)),until:(e,t,n)=>re(di(U,0,e,Qn(t),n)),since:(e,t,n)=>re(di(U,1,e,Qn(t),n)),equals:(e,t)=>bf(e,Qn(t)),toPlainDate(e,t){return ht(yd(U,e,this,t))},toLocaleString(e,t,n){let[r,s]=mE(t,n,e);return r.format(s)},toString:ka,toJSON:e=>ka(e),valueOf:Qt},{from:(e,t)=>Kr(Qn(e,t)),compare:(e,t)=>En(Qn(e),Qn(t))}),[IE,ht,Kb]=Jt(Xn,q(ad,Wn),{...Gr,...il},{with:(e,t,n)=>ht(Zf(U,e,rr(t),n)),withCalendar:(e,t)=>ht(to(e,Io(t))),add:(e,t,n)=>ht(Ga(U,0,e,le(t),n)),subtract:(e,t,n)=>ht(Ga(U,1,e,le(t),n)),until:(e,t,n)=>re(fi(U,0,e,er(t),n)),since:(e,t,n)=>re(fi(U,1,e,er(t),n)),equals:(e,t)=>If(e,er(t)),toZonedDateTime(e,t){let n=ye(t)?t:{timeZone:t};return ve(md(He,Ht,B,e,n))},toPlainDateTime:(e,t)=>dt(pd(e,ol(t))),toPlainYearMonth(e){return Kr(gd(U,e,this))},toPlainMonthDay(e){return rl(Ed(U,e,this))},toLocaleString(e,t,n){let[r,s]=dE(t,n,e);return r.format(s)},toString:Pa,toJSON:e=>Pa(e),valueOf:Qt},{from:(e,t)=>ht(er(e,t)),compare:(e,t)=>En(er(e),er(t))}),[bE,ve]=Jt(Ot,q(sd,Wn,pf),{...fh,...Gr,...ah(il),...ah(ll),offset:e=>qn(nl(e).offsetNanoseconds),offsetNanoseconds:e=>nl(e).offsetNanoseconds,timeZoneId:e=>e.timeZone,hoursInDay:e=>Pc(B,e)},{with:(e,t,n)=>ve(zf(U,B,e,rr(t),n)),withCalendar:(e,t)=>ve(to(e,Io(t))),withTimeZone:(e,t)=>ve(Sd(e,He(t))),withPlainTime:(e,t)=>ve(Nd(B,e,ol(t))),add:(e,t,n)=>ve(Ka(U,B,0,e,le(t),n)),subtract:(e,t,n)=>ve(Ka(U,B,1,e,le(t),n)),until:(e,t,n)=>re(ae(ui(U,B,0,e,tr(t),n))),since:(e,t,n)=>re(ae(ui(U,B,1,e,tr(t),n))),round:(e,t)=>ve(xc(B,e,t)),startOfDay:e=>ve(kc(B,e)),equals:(e,t)=>yf(e,tr(t)),toInstant:e=>Zt(dd(e)),toPlainDateTime:e=>dt(yi(B,e)),toPlainDate:e=>ht(wi(B,e)),toPlainTime:e=>Xt(Ii(B,e)),toLocaleString(e,t,n={}){let[r,s]=cE(t,n,e);return r.format(s)},toString:(e,t)=>Ma(B,e,t),toJSON:e=>Ma(B,e),valueOf:Qt,getTimeZoneTransition(e,t){let{timeZone:n,epochNanoseconds:r}=e,s=Cc(t),o=B(n).O(r,s);return o?ve({...e,epochNanoseconds:o}):null}},{from:(e,t)=>ve(tr(e,t)),compare:(e,t)=>ai(tr(e),tr(t))}),[NE,Zt,qb]=Jt(mo,rd,fh,{add:(e,t)=>Zt(Va(0,e,le(t))),subtract:(e,t)=>Zt(Va(1,e,le(t))),until:(e,t,n)=>re(li(0,e,nr(t),n)),since:(e,t,n)=>re(li(1,e,nr(t),n)),round:(e,t)=>Zt(Oc(e,t)),equals:(e,t)=>Ef(e,nr(t)),toZonedDateTimeISO:(e,t)=>ve(fd(e,He(t))),toLocaleString(e,t,n){let[r,s]=uE(t,n,e);return r.format(s)},toString:(e,t)=>xa(He,B,e,t),toJSON:e=>xa(He,B,e),valueOf:Qt},{from:e=>Zt(nr(e)),fromEpochMilliseconds:e=>Zt(Id(e)),fromEpochNanoseconds:e=>Zt(bd(e)),compare:(e,t)=>oi(nr(e),nr(t))}),CE=Object.defineProperties({},{...vs("Temporal.Now"),...dn({timeZoneId:()=>zn(),instant:()=>Zt(lt(ro())),zonedDateTimeISO:(e=zn())=>ve(Ye(ro(),He(e),G)),plainDateTimeISO:(e=zn())=>dt(We(no(B(He(e))),G)),plainDateISO:(e=zn())=>ht(ut(no(B(He(e))),G)),plainTimeISO:(e=zn())=>Xt(Qe(no(B(He(e)))))})}),se=Object.defineProperties({},{...vs("Temporal"),...dn({PlainYearMonth:wE,PlainMonthDay:yE,PlainDate:IE,PlainTime:gE,PlainDateTime:EE,ZonedDateTime:bE,Instant:NE,Duration:iE,Now:CE})}),SE=Qg(),wo=new WeakMap,AE=Object.defineProperties(Object.create(Intl),dn({DateTimeFormat:SE}));var dh=864e5,hh=24405875e-1,bo={year:2e3,month:1,day:1};function RE(e,t=!1){if(e==null)return null;try{if(typeof e=="number"){if(t)return se.Instant.fromEpochMilliseconds(e*1e3).toZonedDateTimeISO("UTC");if(e>1e6&&e<4e6){let o=(e-hh)*dh;return se.Instant.fromEpochMilliseconds(o).toZonedDateTimeISO("UTC")}else{try{if(e>-2208988800&&e<3250368e4)return se.Instant.fromEpochMilliseconds(e*1e3).toZonedDateTimeISO("UTC")}catch{}try{if(e>-22089888e5&&e<3250368e7)return se.Instant.fromEpochMilliseconds(e).toZonedDateTimeISO("UTC")}catch{}return null}}if(typeof e!="string")return null;let n=e.trim();if(n.toLowerCase()==="now")return se.Now.zonedDateTimeISO();try{return/^\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}(:\d{2}(\.\d+)?)?$/.test(n)?se.Instant.from(n.replace(" ","T")+"Z").toZonedDateTimeISO("UTC"):se.ZonedDateTime.from(n)}catch{}try{return se.PlainDateTime.from(n.replace(" ","T")).toZonedDateTime("UTC")}catch{}try{return se.PlainDate.from(n).toZonedDateTime("UTC")}catch{}try{let o=se.PlainTime.from(n);return se.PlainDateTime.from({...bo,hour:o.hour,minute:o.minute,second:o.second,millisecond:o.millisecond,microsecond:o.microsecond,nanosecond:o.nanosecond}).toZonedDateTime("UTC")}catch{}let s=n.match(/^(\d{4})(\d{2})(\d{2})$/);if(s)return se.PlainDateTime.from({year:parseInt(s[1]),month:parseInt(s[2]),day:parseInt(s[3])}).toZonedDateTime("UTC");if(s=n.match(/^(\d{2}):(\d{2})$/),s){let o={hour:parseInt(s[1]),minute:parseInt(s[2])};return se.PlainDateTime.from({...bo,...o}).toZonedDateTime("UTC")}if(s=n.match(/^(\d{2}):(\d{2}):(\d{2})$/),s){let o={hour:parseInt(s[1]),minute:parseInt(s[2]),second:parseInt(s[3])};return se.PlainDateTime.from({...bo,...o}).toZonedDateTime("UTC")}if(s=n.match(/^(\d{2}):(\d{2}):(\d{2})\.(\d{1,9})$/),s){let o=parseInt(s[4].padEnd(9,"0").substring(0,9)),a={hour:parseInt(s[1]),minute:parseInt(s[2]),second:parseInt(s[3]),millisecond:Math.floor(o/1e6),microsecond:Math.floor(o%1e6/1e3),nanosecond:o%1e3};return se.PlainDateTime.from({...bo,...a}).toZonedDateTime("UTC")}return console.warn(`Failed to parse date/time string with Temporal: ${e}`),null}catch(n){return console.warn(`Error parsing date/time value "${e}":`,n),null}}var TE=/^\s*([+-]?\s*\d+(\.\d+)?)\s+(day|hour|minute|second|month|year)s?\s*$/i,vE=/^\s*weekday\s+([0-6])\s*$/i;function LE(e,t){let n=t.trim().toLowerCase(),r=n.match(TE);if(r){let o=r[1].replace(/\s/g,""),a=parseFloat(o),i=r[3];if(isNaN(a))throw new Error(`Invalid number in modifier: ${t}`);let c={};if(i==="year"||i==="month"||i==="day")c[`${i}s`]=Math.trunc(a);else if(i==="hour"||i==="minute"||i==="second")if(i==="second"){let d=Math.trunc(a),l=Math.round(a%1*1e9);c.seconds=d,l!==0&&(c.nanoseconds=l)}else c[`${i}s`]=a;else throw new Error(`Internal error: Unknown unit ${i}`);let u=se.Duration.from(c);return e.add(u)}switch(n){case"start of day":return e.startOfDay();case"start of month":return e.startOfDay().with({day:1});case"start of year":return e.startOfDay().with({month:1,day:1})}let s=n.match(vE);if(s){let o=parseInt(s[1],10),a=o===0?7:o,i=e.dayOfWeek,c=a-i;return c>0&&(c-=7),c!==0?e.add({days:c}):e}return console.warn(`Modifier not implemented or unrecognized: ${t}`),e}function jr(e){if(e.length===0)return null;let t=e[0],n=1,r=!1,s=[],o=e.findIndex(u=>typeof u=="string"&&u.trim().toLowerCase()==="unixepoch");if(o!==-1)if(o===0){if(e.length<2)return null;t=e[1],r=!0,n=2,s=e.slice(n)}else{if(t=e[0],r=!0,typeof t!="number")return null;s=e.slice(1).filter((u,d)=>d!==o-1),n=1}else t=e[0],s=e.slice(1),n=1;let a="UTC",i=[];for(let u of s){if(typeof u!="string")continue;let d=u.trim().toLowerCase();d==="localtime"?a=se.Now.timeZoneId():d==="utc"?a="UTC":i.push(u)}let c=RE(t,r);if(!c)return null;if(a!==c.timeZoneId)try{c=c.toInstant().toZonedDateTimeISO(a)}catch(u){return console.warn(`Failed to convert to timezone "${a}":`,u),null}for(let u of i)if(typeof u=="string")try{c=LE(c,u)}catch(d){return console.warn(`Error applying modifier "${u}":`,d),null}return c}var OE=(...e)=>{let t=jr(e);return t?t.toPlainDate().toString():null},mh=V({name:"date",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},OE),xE=(...e)=>{let t=jr(e);return t?t.toPlainTime().toString({smallestUnit:"second"}):null},ph=V({name:"time",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},xE),ME=(...e)=>{let t=jr(e);if(!t)return null;let n=t.toPlainDate().toString(),r=t.toPlainTime().toString({smallestUnit:"second"});return`${n} ${r}`},gh=V({name:"datetime",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},ME),DE=(...e)=>{let t=jr(e);return t?t.toInstant().epochMilliseconds/dh+hh:null},Eh=V({name:"julianday",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},DE),PE=(e,...t)=>{if(typeof e!="string")return null;let n=jr(t);if(!n)return null;try{let r=e;return r=r.replace(/%./g,s=>{switch(s){case"%Y":return n.year.toString().padStart(4,"0");case"%m":return n.month.toString().padStart(2,"0");case"%d":return n.day.toString().padStart(2,"0");case"%j":return n.dayOfYear.toString().padStart(3,"0");case"%H":return n.hour.toString().padStart(2,"0");case"%M":return n.minute.toString().padStart(2,"0");case"%S":return n.second.toString().padStart(2,"0");case"%f":return`.${n.millisecond.toString().padStart(3,"0")}`;case"%s":return Math.floor(n.epochMilliseconds/1e3).toString();case"%w":return(n.dayOfWeek%7).toString();case"%W":return(n.weekOfYear??0).toString().padStart(2,"0");case"%%":return"%";default:return console.warn(`Unsupported strftime specifier: ${s}`),s}}),r}catch(r){return console.error("Error during strftime formatting:",r),null}},yh=V({name:"strftime",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},PE);function we(e){if(typeof e!="string")return null;try{return JSON.parse(e)}catch{return null}}function en(e,t,n=!1){if(!t||typeof t!="string")return null;let r=e,s=null,o=null,a=t.startsWith("$")?t.substring(1):t;if(a==="")return{parent:null,key:"",value:e,exists:!0};for(;a.length>0;){if(s=r,o=null,r==null)return null;if(a.startsWith(".")){a=a.substring(1);let i;if(a.startsWith('"')){let c=a.indexOf('"',1);if(c===-1)return null;i=a.substring(1,c),a=a.substring(c+1)}else{let c=a.match(/^([^[.\\s]+)/);if(!c)return null;i=c[1],a=a.substring(i.length)}if(typeof r!="object"||Array.isArray(r)){if(!n||typeof s!="object"||s===null||Array.isArray(s)||typeof o!="string")return{parent:s,key:i,value:void 0,exists:!1};console.debug(`JSON Path: Creating intermediate object for key "${o}"`),s[o]={},r=s[o],s=r,o=i,r=r[i]}else o=i,r=r[i]}else if(a.startsWith("[")){let i=a.indexOf("]");if(i===-1)return null;let c=a.substring(1,i).trim(),u=parseInt(c,10);if(a=a.substring(i+1),!Number.isInteger(u)||u<0)return null;if(Array.isArray(r))o=u,r=u<r.length?r[u]:void 0;else{if(!n||s===null||typeof o===null)return{parent:s,key:u,value:void 0,exists:!1};let d=[];if(Array.isArray(s)&&typeof o=="number")console.debug(`JSON Path: Creating intermediate array for index ${o}`),s[o]=d;else if(typeof s=="object"&&!Array.isArray(s)&&typeof o=="string")console.debug(`JSON Path: Creating intermediate array for key "${o}"`),s[o]=d;else return{parent:s,key:u,value:void 0,exists:!1};r=d,s=r,o=u,r=u<r.length?r[u]:void 0}}else return null}return o===null?null:{parent:s,key:o,value:r,exists:r!==void 0}}function tn(e){if(typeof e=="bigint")return e>=Number.MIN_SAFE_INTEGER&&e<=Number.MAX_SAFE_INTEGER?Number(e):e.toString();if(e instanceof Uint8Array||typeof e=="number"&&!Number.isFinite(e))return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e}function bn(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(bn);let t={};for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=bn(e[n]));return t}function sr(e){if(e===null)return"null";switch(typeof e){case"boolean":return e?"true":"false";case"number":return Number.isInteger(e)?"integer":"real";case"string":return"text";case"object":return Array.isArray(e)?"array":"object";default:return"null"}}function No(e,t){if(!t||t==="$")return e;let n=t.startsWith("$.")?t.substring(2).split("."):t.startsWith("$")?t.substring(1).split("."):t.split("."),r=e;for(let s of n){if(r==null)return;let o=s.match(/^\s*\[(\d+)\]\s*$/);if(o){let a=parseInt(o[1],10);if(Array.isArray(r)&&a>=0&&a<r.length)r=r[a];else return}else if(typeof r=="object"&&r!==null&&Object.prototype.hasOwnProperty.call(r,s))r=r[s];else return}return r}var ul={};Mo(ul,{JsonPatchError:()=>J,_areEquals:()=>zr,applyOperation:()=>Nn,applyPatch:()=>ar,applyReducer:()=>BE,deepClone:()=>UE,getValueByPointer:()=>To,validate:()=>Ih,validator:()=>vo});var kE=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,s){r.__proto__=s}||function(r,s){for(var o in s)s.hasOwnProperty(o)&&(r[o]=s[o])},e(t,n)};return function(t,n){e(t,n);function r(){this.constructor=t}t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),FE=Object.prototype.hasOwnProperty;function So(e,t){return FE.call(e,t)}function Ao(e){if(Array.isArray(e)){for(var t=new Array(e.length),n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(e);var r=[];for(var s in e)So(e,s)&&r.push(s);return r}function ue(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Ro(e){for(var t=0,n=e.length,r;t<n;){if(r=e.charCodeAt(t),r>=48&&r<=57){t++;continue}return!1}return!0}function mt(e){return e.indexOf("/")===-1&&e.indexOf("~")===-1?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function Yr(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Co(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(var t=0,n=e.length;t<n;t++)if(Co(e[t]))return!0}else if(typeof e=="object"){for(var r=Ao(e),s=r.length,o=0;o<s;o++)if(Co(e[r[o]]))return!0}}return!1}function wh(e,t){var n=[e];for(var r in t){var s=typeof t[r]=="object"?JSON.stringify(t[r],null,2):t[r];typeof s<"u"&&n.push(r+": "+s)}return n.join(`
`)}var Wr=function(e){kE(t,e);function t(n,r,s,o,a){var i=this.constructor,c=e.call(this,wh(n,{name:r,index:s,operation:o,tree:a}))||this;return c.name=r,c.index=s,c.operation=o,c.tree=a,Object.setPrototypeOf(c,i.prototype),c.message=wh(n,{name:r,index:s,operation:o,tree:a}),c}return t}(Error);var J=Wr,UE=ue,or={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){var r=To(n,this.path);r&&(r=ue(r));var s=Nn(n,{op:"remove",path:this.from}).removed;return Nn(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(e,t,n){var r=To(n,this.from);return Nn(n,{op:"add",path:this.path,value:ue(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:zr(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}},$E={add:function(e,t,n){return Ro(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){var r=e.splice(t,1);return{newDocument:n,removed:r[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:or.move,copy:or.copy,test:or.test,_get:or._get};function To(e,t){if(t=="")return e;var n={op:"_get",path:t};return Nn(e,n),n.value}function Nn(e,t,n,r,s,o){if(n===void 0&&(n=!1),r===void 0&&(r=!0),s===void 0&&(s=!0),o===void 0&&(o=0),n&&(typeof n=="function"?n(t,0,e,t.path):vo(t,0)),t.path===""){var a={newDocument:e};if(t.op==="add")return a.newDocument=t.value,a;if(t.op==="replace")return a.newDocument=t.value,a.removed=e,a;if(t.op==="move"||t.op==="copy")return a.newDocument=To(e,t.from),t.op==="move"&&(a.removed=e),a;if(t.op==="test"){if(a.test=zr(e,t.value),a.test===!1)throw new J("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a.newDocument=e,a}else{if(t.op==="remove")return a.removed=e,a.newDocument=null,a;if(t.op==="_get")return t.value=e,a;if(n)throw new J("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",o,t,e);return a}}else{r||(e=ue(e));var i=t.path||"",c=i.split("/"),u=e,d=1,l=c.length,h=void 0,p=void 0,g=void 0;for(typeof n=="function"?g=n:g=vo;;){if(p=c[d],p&&p.indexOf("~")!=-1&&(p=Yr(p)),s&&(p=="__proto__"||p=="prototype"&&d>0&&c[d-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&h===void 0&&(u[p]===void 0?h=c.slice(0,d).join("/"):d==l-1&&(h=t.path),h!==void 0&&g(t,0,e,h)),d++,Array.isArray(u)){if(p==="-")p=u.length;else{if(n&&!Ro(p))throw new J("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",o,t,e);Ro(p)&&(p=~~p)}if(d>=l){if(n&&t.op==="add"&&p>u.length)throw new J("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",o,t,e);var a=$E[t.op].call(t,u,p,e);if(a.test===!1)throw new J("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a}}else if(d>=l){var a=or[t.op].call(t,u,p,e);if(a.test===!1)throw new J("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a}if(u=u[p],n&&d<l&&(!u||typeof u!="object"))throw new J("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",o,t,e)}}}function ar(e,t,n,r,s){if(r===void 0&&(r=!0),s===void 0&&(s=!0),n&&!Array.isArray(t))throw new J("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=ue(e));for(var o=new Array(t.length),a=0,i=t.length;a<i;a++)o[a]=Nn(e,t[a],n,!0,s,a),e=o[a].newDocument;return o.newDocument=e,o}function BE(e,t,n){var r=Nn(e,t);if(r.test===!1)throw new J("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function vo(e,t,n,r){if(typeof e!="object"||e===null||Array.isArray(e))throw new J("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(or[e.op]){if(typeof e.path!="string")throw new J("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new J('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new J("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new J("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if((e.op==="add"||e.op==="replace"||e.op==="test")&&Co(e.value))throw new J("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n){if(e.op=="add"){var s=e.path.split("/").length,o=r.split("/").length;if(s!==o+1&&s!==o)throw new J("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==r)throw new J("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if(e.op==="move"||e.op==="copy"){var a={op:"_get",path:e.from,value:void 0},i=Ih([a],n);if(i&&i.name==="OPERATION_PATH_UNRESOLVABLE")throw new J("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}}else throw new J("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n)}function Ih(e,t,n){try{if(!Array.isArray(e))throw new J("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)ar(ue(t),ue(e),n||!0);else{n=n||vo;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(s){if(s instanceof J)return s;throw s}}function zr(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var n=Array.isArray(e),r=Array.isArray(t),s,o,a;if(n&&r){if(o=e.length,o!=t.length)return!1;for(s=o;s--!==0;)if(!zr(e[s],t[s]))return!1;return!0}if(n!=r)return!1;var i=Object.keys(e);if(o=i.length,o!==Object.keys(t).length)return!1;for(s=o;s--!==0;)if(!t.hasOwnProperty(i[s]))return!1;for(s=o;s--!==0;)if(a=i[s],!zr(e[a],t[a]))return!1;return!0}return e!==e&&t!==t}var hl={};Mo(hl,{compare:()=>WE,generate:()=>cl,observe:()=>YE,unobserve:()=>jE});var fl=new WeakMap,_E=function(){function e(t){this.observers=new Map,this.obj=t}return e}(),VE=function(){function e(t,n){this.callback=t,this.observer=n}return e}();function KE(e){return fl.get(e)}function qE(e,t){return e.observers.get(t)}function GE(e,t){e.observers.delete(t.callback)}function jE(e,t){t.unobserve()}function YE(e,t){var n=[],r,s=KE(e);if(!s)s=new _E(e),fl.set(e,s);else{var o=qE(s,t);r=o&&o.observer}if(r)return r;if(r={},s.value=ue(e),t){r.callback=t,r.next=null;var a=function(){cl(r)},i=function(){clearTimeout(r.next),r.next=setTimeout(a)};typeof window<"u"&&(window.addEventListener("mouseup",i),window.addEventListener("keyup",i),window.addEventListener("mousedown",i),window.addEventListener("keydown",i),window.addEventListener("change",i))}return r.patches=n,r.object=e,r.unobserve=function(){cl(r),clearTimeout(r.next),GE(s,r),typeof window<"u"&&(window.removeEventListener("mouseup",i),window.removeEventListener("keyup",i),window.removeEventListener("mousedown",i),window.removeEventListener("keydown",i),window.removeEventListener("change",i))},s.observers.set(t,new VE(t,r)),r}function cl(e,t){t===void 0&&(t=!1);var n=fl.get(e.object);dl(n.value,e.object,e.patches,"",t),e.patches.length&&ar(n.value,e.patches);var r=e.patches;return r.length>0&&(e.patches=[],e.callback&&e.callback(r)),r}function dl(e,t,n,r,s){if(t!==e){typeof t.toJSON=="function"&&(t=t.toJSON());for(var o=Ao(t),a=Ao(e),i=!1,c=!1,u=a.length-1;u>=0;u--){var d=a[u],l=e[d];if(So(t,d)&&!(t[d]===void 0&&l!==void 0&&Array.isArray(t)===!1)){var h=t[d];typeof l=="object"&&l!=null&&typeof h=="object"&&h!=null&&Array.isArray(l)===Array.isArray(h)?dl(l,h,n,r+"/"+mt(d),s):l!==h&&(i=!0,s&&n.push({op:"test",path:r+"/"+mt(d),value:ue(l)}),n.push({op:"replace",path:r+"/"+mt(d),value:ue(h)}))}else Array.isArray(e)===Array.isArray(t)?(s&&n.push({op:"test",path:r+"/"+mt(d),value:ue(l)}),n.push({op:"remove",path:r+"/"+mt(d)}),c=!0):(s&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}),i=!0)}if(!(!c&&o.length==a.length))for(var u=0;u<o.length;u++){var d=o[u];!So(e,d)&&t[d]!==void 0&&n.push({op:"add",path:r+"/"+mt(d),value:ue(t[d])})}}}function WE(e,t,n){n===void 0&&(n=!1);var r=[];return dl(e,t,r,"",n),r}var a0=Object.assign({},ul,hl,{JsonPatchError:Wr,deepClone:ue,escapePathComponent:mt,unescapePathComponent:Yr});var zE=e=>we(e)!==null?1:0,bh=V({name:"json_valid",numArgs:1,flags:v.UTF8|v.DETERMINISTIC},zE),HE=(e,t)=>{let n=we(e);if(n===null&&typeof e=="string")return null;let r=n;if(t!=null){if(typeof t!="string")return"null";let s=en(n,t);if(r=s?.exists?s.value:void 0,r===void 0)return null}return sr(r)},Nh=V({name:"json_type",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},HE),ZE=(e,...t)=>{let n=we(e);if(n===null&&typeof e=="string"||t.length===0)return null;let r;for(let s of t)if(typeof s=="string"){let o=en(n,s);if(r=o?.exists?o.value:void 0,r!==void 0)break}else return null;if(r===void 0)return null;if(r===null)return null;if(typeof r=="boolean")return r?1:0;if(typeof r=="number")return r;if(typeof r=="string")return r;if(typeof r=="object")try{return JSON.stringify(r)}catch{return null}else return null},Ch=V({name:"json_extract",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},ZE),XE=e=>{if(e===null)return"null";switch(typeof e){case"number":return Number.isFinite(e)?String(e):"null";case"boolean":return e?"true":"false";case"string":return JSON.stringify(e);case"bigint":case"object":default:return null}},Sh=V({name:"json_quote",numArgs:1,flags:v.UTF8|v.DETERMINISTIC},XE),JE=(...e)=>{let t=e.map(n=>tn(n));try{return JSON.stringify(t)}catch{return null}},Ah=V({name:"json_array",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},JE),QE=(...e)=>{if(e.length%2!==0)return null;let t={};for(let n=0;n<e.length;n+=2){let r=e[n],s=e[n+1];if(typeof r!="string")return null;t[r]=tn(s)}try{return JSON.stringify(t)}catch{return null}},Rh=V({name:"json_object",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},QE),ey=(e,t)=>{let n=we(e);if(n===null&&typeof e=="string")return null;let r=n;if(t!=null){if(typeof t!="string")return 0;let s=en(n,t);r=s?.exists?s.value:void 0}return Array.isArray(r)?r.length:0},Th=V({name:"json_array_length",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},ey),ty=(e,t)=>{let n=we(e),r=we(t);if(n===null&&typeof e=="string"||!Array.isArray(r))return null;try{let s=ar(n,r,!0).newDocument;return JSON.stringify(s)}catch(s){return console.error(`json_patch failed: ${s?.message}`,s),null}},vh=V({name:"json_patch",numArgs:2,flags:v.UTF8},ty),ny=(e,...t)=>{let n=we(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=bn(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=tn(a),c=en(r,o);if(c===null)continue;let{parent:u,key:d,exists:l}=c;if(!l){if(u===null)continue;Array.isArray(u)&&typeof d=="number"?d===u.length?u.push(i):d<u.length&&u.splice(d,0,i):typeof u=="object"&&typeof d=="string"&&(u[d]=i)}}try{return JSON.stringify(r)}catch{return null}},Lh=V({name:"json_insert",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},ny),ry=(e,...t)=>{let n=we(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=bn(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=tn(a),c=en(r,o);if(c===null)continue;let{parent:u,key:d,exists:l}=c;l&&(u===null&&d===""?r=i:(u!==null&&typeof d=="string"&&typeof u=="object"&&!Array.isArray(u)||u!==null&&typeof d=="number"&&Array.isArray(u)&&d>=0&&d<u.length)&&(u[d]=i))}try{return JSON.stringify(r)}catch{return null}},Oh=V({name:"json_replace",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},ry),sy=(e,...t)=>{let n=we(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=bn(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=tn(a),c=en(r,o,!0);if(c===null)continue;let{parent:u,key:d,exists:l}=c;if(u===null&&d==="")r=i;else if(u!==null){if(typeof u=="object"&&!Array.isArray(u)&&typeof d=="string")u[d]=i;else if(Array.isArray(u)&&typeof d=="number"){if(d>=0&&d<u.length)u[d]=i;else if(d===u.length)u.push(i);else if(d>u.length){for(;u.length<d;)u.push(null);u.push(i)}}}}try{return JSON.stringify(r)}catch{return null}},xh=V({name:"json_set",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},sy),oy=(e,...t)=>{let n=we(e);if(n===null&&typeof e=="string")return null;if(t.length===0)return JSON.stringify(n);let r=bn(n);for(let s of t){if(typeof s!="string")return null;let o=en(r,s);if(o===null||!o.exists||o.parent===null)continue;let{parent:a,key:i}=o;Array.isArray(a)&&typeof i=="number"?i>=0&&i<a.length&&a.splice(i,1):typeof a=="object"&&typeof i=="string"&&Object.prototype.hasOwnProperty.call(a,i)&&delete a[i]}try{return JSON.stringify(r)}catch{return null}},Mh=V({name:"json_remove",numArgs:-1,flags:v.UTF8|v.DETERMINISTIC},oy),ay=(e,t)=>{let n=e??[],r=tn(t);return n.push(r),n},iy=e=>{try{return e&&e.length>0?JSON.stringify(e):null}catch{return null}},Dh=Ce({name:"json_group_array",numArgs:1,flags:v.UTF8,initialState:[]},ay,iy),ly=(e,t,n)=>{let r=e??{};if(typeof t!="string"||t===null)return r;let s=tn(n);return r[t]=s,r},uy=e=>{try{return e&&Object.keys(e).length>0?JSON.stringify(e):null}catch{return null}},Ph=Ce({name:"json_group_object",numArgs:2,flags:v.UTF8,initialState:{}},ly,uy);var ml=[Su,Au,Ru,vu,Lu,Ou,xu,Mu,Du,Pu,ku,Fu,Uu,$u,Bu,_u,Vu,Ku,mh,ph,gh,Eh,yh,bh,Nh,Ch,Sh,Ah,Rh,Lh,Oh,xh,Mh,Th,vh,Dh,Ph];var cy=Object.freeze([{name:"key",affinity:A.INTEGER|A.TEXT},{name:"value",affinity:A.TEXT},{name:"type",affinity:A.TEXT},{name:"atom",affinity:A.TEXT},{name:"id",affinity:A.INTEGER},{name:"parent",affinity:A.INTEGER},{name:"fullkey",affinity:A.TEXT},{name:"path",affinity:A.TEXT}]),El=Object.freeze(cy.map(e=>({..._e(e.name),affinity:e.affinity}))),kh=Object.freeze(fe(El)),pl=class extends Ve{parsedJson;rootPath;tableSchema;constructor(t,n,r,s,o,a){if(super(t,n,r,s),this.parsedJson=we(o),this.rootPath=typeof a=="string"&&a?a:null,this.parsedJson===null&&typeof o=="string")throw new b(`Invalid JSON provided to ${s}`,I.ERROR);this.tableSchema=Object.freeze({name:s,schemaName:r,checkConstraints:[],columns:El,columnIndexMap:kh,primaryKeyDefinition:[],isVirtual:!0,vtabModule:n,vtabInstance:this,vtabModuleName:"json_each"})}},gl=class extends Ke{stack=[];currentRow=null;isEof=!0;elementIdCounter=0;constructor(t){super(t)}reset(){this.stack=[],this.currentRow=null,this.isEof=!0,this.elementIdCounter=0}startIteration(t,n){this.reset();let r=n??"$";t!==void 0?(this.stack.push({value:t,parentPath:"",parentKey:null,parentId:0,currentIndex:-1}),this.isEof=!1,this.next()):this.isEof=!0}next(){if(this.stack.length===0){this.isEof=!0,this.currentRow=null;return}let t=this.stack[this.stack.length-1],n=t.value,r=t.parentKey,s=this.elementIdCounter++,o=t.parentPath,a=r!==null?`${o}${typeof r=="number"?`[${r}]`:`.${r}`}`:o,i=sr(n),c=i==="object"||i==="array"?null:n;if(this.currentRow={key:r,value:i==="object"||i==="array"?JSON.stringify(n):n,type:i,atom:c,id:s,parent:t.parentId,fullkey:a,path:o},this.stack.pop(),Array.isArray(n))for(let u=n.length-1;u>=0;u--)this.stack.push({value:n[u],parentPath:a,parentKey:u,parentId:s,currentIndex:-1});else if(typeof n=="object"&&n!==null){let u=Object.keys(n).sort().reverse();for(let d of u)this.stack.push({value:n[d],parentPath:a,parentKey:d,parentId:s,currentIndex:-1})}this.stack.length}eof(){return this.isEof}column(t){if(!this.currentRow)return null;let n=El[t]?.name;if(n==="value"&&this.currentRow){let r=this.currentRow.type;if(r==="object"||r==="array"){let s=this.currentRow._originalValue;return s?JSON.stringify(s):null}else return this.currentRow[n]??null}else return this.currentRow[n]??null}},Lo=class{xConnect(t,n,r,s,o,a){return new pl(t,this,s,o,a.jsonSource,a.rootPath)}xCreate(t,n,r,s,o,a){return this.xConnect(t,n,r,s,o,a)}async xDisconnect(t){}async xDestroy(t){}async xOpen(t){return new gl(t)}async xClose(t){t.reset()}xBestIndex(t,n){return n.estimatedCost=1e5,n.idxNum=0,n.idxStr=null,n.orderByConsumed=!1,I.OK}async xFilter(t,n,r,s){let o=t.table.rootPath,a=t.table.parsedJson;o&&(a=No(a,o)),t.startIteration(a,o)}async xNext(t){t.next()}async xEof(t){return t.eof()}xColumn(t,n,r){return n.resultValue(t.column(r)),I.OK}xRowid(t){let n=kh.get("id"),r=t.column(n);return typeof r=="number"?Promise.resolve(BigInt(r)):Promise.reject(new b("Cannot get rowid for json_each cursor",I.ERROR))}async xUpdate(){throw new b("json_each table is read-only",I.READONLY)}async xBegin(){return Promise.resolve()}async xSync(){return Promise.resolve()}async xCommit(){return Promise.resolve()}async xRollback(){return Promise.resolve()}async xRename(){throw new b("Cannot rename json_each table",I.ERROR)}};var fy=Object.freeze([{name:"key",affinity:A.INTEGER|A.TEXT},{name:"value",affinity:A.TEXT},{name:"type",affinity:A.TEXT},{name:"atom",affinity:A.TEXT},{name:"id",affinity:A.INTEGER},{name:"parent",affinity:A.INTEGER},{name:"fullkey",affinity:A.TEXT},{name:"path",affinity:A.TEXT}]),Il=Object.freeze(fy.map(e=>({..._e(e.name),affinity:e.affinity}))),Fh=Object.freeze(fe(Il)),yl=class extends Ve{parsedJson;rootPath;tableSchema;constructor(t,n,r,s,o,a){if(super(t,n,r,s),this.parsedJson=we(o),this.rootPath=typeof a=="string"&&a?a:null,this.parsedJson===null&&typeof o=="string")throw new b(`Invalid JSON provided to ${s}`,I.ERROR);this.tableSchema=Object.freeze({name:s,schemaName:r,checkConstraints:[],columns:Il,columnIndexMap:Fh,primaryKeyDefinition:[],isVirtual:!0,vtabModule:n,vtabInstance:this,vtabModuleName:"json_tree"})}},wl=class extends Ke{stack=[];currentRow=null;isEof=!0;elementIdCounter=0;constructor(t){super(t)}reset(){this.stack=[],this.currentRow=null,this.isEof=!0,this.elementIdCounter=0}startIteration(t,n){this.reset();let r=n??"$";t!==void 0?(this.stack.push({value:t,parentPath:"",parentKey:null,parentId:0,childrenPushed:!1}),this.isEof=!1,this.next()):this.isEof=!0}next(){if(this.stack.length===0){this.isEof=!0,this.currentRow=null;return}let t=this.stack[this.stack.length-1],n=t.value,r=typeof n=="object"&&n!==null;if(this.currentRow===null||!t.childrenPushed){let a=t.parentKey,i=++this.elementIdCounter,c=t.parentPath,u=a!==null?`${c}${typeof a=="number"?`[${a}]`:`.${a}`}`:c,d=sr(n),l=r?null:n;if(this.currentRow={key:a,value:r?JSON.stringify(n):n,type:d,atom:l,id:i,parent:t.parentId,fullkey:u,path:c,_originalValue:r?n:void 0},r){t.childrenPushed=!1;return}else{this.stack.pop(),this.next();return}}t.childrenPushed=!0;let s=this.currentRow.id,o=this.currentRow.fullkey;if(this.stack.pop(),Array.isArray(n))for(let a=n.length-1;a>=0;a--)this.stack.push({value:n[a],parentPath:o,parentKey:a,parentId:s,childrenPushed:!1});else if(typeof n=="object"&&n!==null){let a=Object.keys(n).sort().reverse();for(let i of a)this.stack.push({value:n[i],parentPath:o,parentKey:i,parentId:s,childrenPushed:!1})}this.currentRow=null,this.next()}eof(){return this.isEof}column(t){if(!this.currentRow)return null;let n=Il[t]?.name;if(n==="value"&&this.currentRow){let r=this.currentRow.type;if(r==="object"||r==="array"){let s=this.currentRow._originalValue;return s!==void 0?JSON.stringify(s):null}else return this.currentRow[n]??null}else return this.currentRow[n]??null}},Oo=class{xConnect(t,n,r,s,o,a){return new yl(t,this,s,o,a.jsonSource,a.rootPath)}xCreate(t,n,r,s,o,a){return this.xConnect(t,n,r,s,o,a)}async xDisconnect(t){}async xDestroy(t){}async xOpen(t){return new wl(t)}async xClose(t){t.reset()}xBestIndex(t,n){return n.estimatedCost=1e5,n.idxNum=0,n.idxStr=null,n.orderByConsumed=!1,I.OK}async xFilter(t,n,r,s){let o=t.table.rootPath,a=t.table.parsedJson;o&&(a=No(a,o)),t.startIteration(a,o)}async xNext(t){t.next()}async xEof(t){return t.eof()}xColumn(t,n,r){return n.resultValue(t.column(r)),I.OK}xRowid(t){let n=Fh.get("id"),r=t.column(n);return typeof r=="number"?Promise.resolve(BigInt(r)):Promise.reject(new b("Cannot get rowid for json_tree cursor",I.ERROR))}async xUpdate(){throw new b("json_tree table is read-only",I.READONLY)}async xBegin(){return Promise.resolve()}async xSync(){return Promise.resolve()}async xCommit(){return Promise.resolve()}async xRollback(){return Promise.resolve()}async xRename(){throw new b("Cannot rename json_tree table",I.ERROR)}};function Uh(e){if(!e.isOpen)throw new M("Database is closed");let t=e.schemaManager,n={schemaVersion:1,schemas:{}};for(let r of t._getAllSchemas()){let s={tables:[],functions:[]};for(let o of r.getAllTables()){let a={name:o.name,columns:o.columns.map(i=>{let c=A[i.affinity],u=null;return typeof i.defaultValue=="string"||typeof i.defaultValue=="number"||i.defaultValue===null?u=i.defaultValue:typeof i.defaultValue=="bigint"?u=i.defaultValue.toString()+"n":i.defaultValue instanceof Uint8Array&&(u=`x'${Array.from(i.defaultValue).map(l=>l.toString(16).padStart(2,"0")).join("")}'`),{name:i.name,affinity:c,notNull:i.notNull,primaryKey:i.primaryKey,defaultValue:u,collation:i.collation,hidden:i.hidden,generated:i.generated}}),primaryKeyDefinition:[...o.primaryKeyDefinition],isVirtual:o.isVirtual,vtabModule:o.vtabModuleName,vtabArgs:o.vtabArgs?[...o.vtabArgs]:void 0};s.tables.push(a)}for(let o of r._getAllFunctions()){let a={name:o.name,numArgs:o.numArgs,flags:o.flags};s.functions.push(a)}n.schemas[r.name]=s}return JSON.stringify(n,null,2)}function $h(e,t){if(!e.isOpen)throw new M("Database is closed");let n=e.schemaManager;if(e.inTransaction)throw new M("Cannot import schema during a transaction");let s;try{s=JSON.parse(t)}catch(o){throw new Error(`Failed to parse JSON schema: ${o.message}`)}if(s.schemaVersion!==1)throw new Error(`Unsupported schema version: ${s.schemaVersion}. Expected version 1.`);n.clearAll();for(let o in s.schemas){if(!Object.prototype.hasOwnProperty.call(s.schemas,o))continue;let a=n.getSchema(o);if(a)a.clearTables(),a.clearFunctions();else{if(o==="main"||o==="temp")throw console.error(`Core schema ${o} missing during import!`),new b(`Internal error: Core schema ${o} is missing.`,I.INTERNAL);a=n.addSchema(o)}let i=s.schemas[o];for(let c of i.tables){let u=c.columns.map(l=>{let h=A[l.affinity];if(h===void 0)throw new Error(`Invalid affinity string "${l.affinity}" for column ${l.name}`);let p=null;if(typeof l.defaultValue=="string")if(l.defaultValue.endsWith("n"))try{p=BigInt(l.defaultValue.slice(0,-1))}catch{}else if(l.defaultValue.toLowerCase().startsWith("x'")&&l.defaultValue.endsWith("'")){let g=l.defaultValue.slice(2,-1);try{let E=new Uint8Array(g.length/2);for(let y=0;y<g.length;y+=2)E[y/2]=parseInt(g.substring(y,y+2),16);p=E}catch{}}else p=l.defaultValue;else(typeof l.defaultValue=="number"||l.defaultValue===null)&&(p=l.defaultValue);return{name:l.name,affinity:h,notNull:l.notNull,primaryKey:l.primaryKey,pkOrder:c.primaryKeyDefinition.find(g=>g.index===c.columns.indexOf(l))?c.primaryKeyDefinition.findIndex(g=>g.index===c.columns.indexOf(l))+1:0,defaultValue:p,collation:l.collation,hidden:l.hidden,generated:l.generated}}),d={name:c.name,schemaName:o,checkConstraints:[],columns:Object.freeze(u),columnIndexMap:Object.freeze(fe(u)),primaryKeyDefinition:Object.freeze(c.primaryKeyDefinition),isVirtual:c.isVirtual,vtabModuleName:c.vtabModule,vtabArgs:c.vtabArgs?Object.freeze(c.vtabArgs):void 0};a.addTable(d)}for(let c of i.functions){let u={name:c.name,numArgs:c.numArgs,flags:c.flags};a.addFunction(u)}}console.warn("Schema imported from JSON. Function implementations and VTab connections must be re-established manually.")}var xo=class{schemaManager;isOpen=!0;statements=new Set;registeredVTabs=new Map;isAutocommit=!0;inTransaction=!1;defaultVtabModuleName="memory";defaultVtabModuleArgs=[];constructor(){this.schemaManager=new Mn(this),console.log("Database instance created."),this.registerBuiltinFunctions(),this.registerVtabModule("memory",new Pt),this.registerVtabModule("json_each",new Lo),this.registerVtabModule("json_tree",new Oo),this.registerVtabModule("sqlite_schema",new an),this.registerDefaultCollations()}registerBuiltinFunctions(){let t=this.schemaManager.getMainSchema();ml.forEach(n=>{try{t.addFunction(n)}catch(r){console.error(`Failed to register built-in function ${n.name}/${n.numArgs}:`,r)}}),console.log(`Registered ${ml.length} built-in functions.`)}registerDefaultCollations(){dr("BINARY",ko),dr("NOCASE",fu),dr("RTRIM",du),console.log("Default collations registered (BINARY, NOCASE, RTRIM)")}async prepare(t){if(!this.isOpen)throw new M("Database is closed");console.log(`Preparing SQL: ${t}`);let n=new xn(this,t);try{return this.statements.add(n),n}catch(r){throw this.statements.delete(n),r}}async exec(t,n,r){if(!this.isOpen)throw new M("Database is closed");typeof n=="function"&&r===void 0&&(r=n,n=void 0),console.log(`Executing SQL: ${t}`);let s=await this.prepare(t);try{n&&typeof n!="function"&&s.bindAll(n);let o=await s.step();for(;o===I.ROW;){if(r){let a=s.getAsObject(),i=s.getColumnNames();r(a,i)}o=await s.step()}if(o!==I.DONE&&o!==I.OK)throw new b("Execution failed",o)}finally{await s.finalize()}}registerVtabModule(t,n,r){if(!this.isOpen)throw new M("Database is closed");let s=t.toLowerCase();if(this.registeredVTabs.has(s))throw new b(`Virtual table module '${t}' already registered`,I.ERROR);console.log(`Registering VTab module: ${t}`),this.registeredVTabs.set(s,{module:n,auxData:r})}async beginTransaction(t="deferred"){if(!this.isOpen)throw new M("Database is closed");if(this.inTransaction)throw new b("Transaction already active",I.ERROR);await this.exec(`BEGIN ${t.toUpperCase()} TRANSACTION`),this.inTransaction=!0,this.isAutocommit=!1}async commit(){if(!this.isOpen)throw new M("Database is closed");if(!this.inTransaction)throw new b("No transaction active",I.ERROR);await this.exec("COMMIT"),this.inTransaction=!1,this.isAutocommit=!0}async rollback(){if(!this.isOpen)throw new M("Database is closed");if(!this.inTransaction)throw new b("No transaction active",I.ERROR);await this.exec("ROLLBACK"),this.inTransaction=!1,this.isAutocommit=!0}async close(){if(!this.isOpen)return;console.log("Closing database..."),this.isOpen=!1;let t=Array.from(this.statements).map(n=>n.finalize());await Promise.allSettled(t),this.statements.clear(),this.schemaManager.clearAll(),this.registeredVTabs.clear(),console.log("Database closed.")}_statementFinalized(t){this.statements.delete(t)}getAutocommit(){if(!this.isOpen)throw new M("Database is closed");return this.isAutocommit}defineVirtualTable(t){if(!this.isOpen)throw new M("Database is closed");if(!t.isVirtual||!t.vtabModule)throw new M("Definition must be for a virtual table with a module");if(t.schemaName!=="main")throw new M("Programmatic definition only supported for 'main' schema currently");this.schemaManager.getMainSchema().addTable(t)}_getVtabModule(t){return this.registeredVTabs.get(t.toLowerCase())}_findTable(t,n){return this.schemaManager.findTable(t,n)}_findFunction(t,n){return this.schemaManager.findFunction(t,n)}createScalarFunction(t,n,r){if(!this.isOpen)throw new M("Database is closed");let s=n.deterministic?v.DETERMINISTIC|v.UTF8:v.UTF8,o=n.flags??s,a=V({name:t,numArgs:n.numArgs,flags:o},r);try{this.schemaManager.getMainSchema().addFunction(a)}catch(i){throw console.error(`Failed to register scalar function ${t}/${n.numArgs}:`,i),i instanceof Error?i:new Error(String(i))}}createAggregateFunction(t,n,r,s){if(!this.isOpen)throw new M("Database is closed");let o=n.flags??v.UTF8,a=Ce({name:t,numArgs:n.numArgs,flags:o,initialState:n.initialState},r,s);try{this.schemaManager.getMainSchema().addFunction(a)}catch(i){throw console.error(`Failed to register aggregate function ${t}/${n.numArgs}:`,i),i instanceof Error?i:new Error(String(i))}}registerFunction(t){if(!this.isOpen)throw new M("Database is closed");try{this.schemaManager.getMainSchema().addFunction(t)}catch(n){throw console.error(`Failed to register function ${t.name}/${t.numArgs}:`,n),n instanceof Error?n:new Error(String(n))}}exportSchemaJson(){return Uh(this)}importSchemaJson(t){$h(this,t)}setDefaultVtabModule(t,n=[]){console.warn("Deprecated: Use `PRAGMA default_vtab_module` and `PRAGMA default_vtab_args` instead."),this.setDefaultVtabName(t),this.setDefaultVtabArgs(n)}setDefaultVtabName(t){this.registeredVTabs.has(t.toLowerCase())||console.warn(`Setting default VTab module to '${t}', which is not currently registered.`),this.defaultVtabModuleName=t}setDefaultVtabArgs(t){this.defaultVtabModuleArgs=[...t]}setDefaultVtabArgsFromJson(t){try{let n=JSON.parse(t);if(!Array.isArray(n)||!n.every(r=>typeof r=="string"))throw new Error("JSON value must be an array of strings.");this.setDefaultVtabArgs(n)}catch(n){let r=n instanceof Error?n.message:String(n);throw new b(`Invalid JSON for default_vtab_args: ${r}`,I.ERROR)}}getDefaultVtabModule(){return{name:this.defaultVtabModuleName,args:[...this.defaultVtabModuleArgs]}}registerCollation(t,n){if(!this.isOpen)throw new b("Database is closed",I.ERROR);dr(t,n),console.log(`Registered collation: ${t}`)}_getCollation(t){return hu(t)}async*eval(t,n){if(!this.isOpen)throw new M("Database is closed");let r=null;try{r=await this.prepare(t),n&&r.bindAll(n);let s;for(;(s=await r.step())===I.ROW;)yield r.getAsObject();if(s!==I.DONE&&s!==I.OK)throw new b(`Iteration failed for query: ${t}`,s)}finally{r&&await r.finalize()}}};return Yh(dy);})();
/*! Bundled license information:

fast-json-patch/module/helpers.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

fast-json-patch/module/duplex.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2021 Joachim Wester
   * MIT license
   *)
*/
return DigithoughtSqliter}));
