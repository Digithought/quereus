(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.DigithoughtSqliter = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var DigithoughtSqliter=(()=>{var Yh=Object.create;var ns=Object.defineProperty;var Wh=Object.getOwnPropertyDescriptor;var zh=Object.getOwnPropertyNames;var Zh=Object.getPrototypeOf,Hh=Object.prototype.hasOwnProperty;var hr=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Bo=(e,t)=>{for(var n in t)ns(e,n,{get:t[n],enumerable:!0})},Al=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of zh(t))!Hh.call(e,s)&&s!==n&&ns(e,s,{get:()=>t[s],enumerable:!(r=Wh(t,s))||r.enumerable});return e};var Xh=(e,t,n)=>(n=e!=null?Yh(Zh(e)):{},Al(t||!e||!e.__esModule?ns(n,"default",{value:e,enumerable:!0}):n,e)),Jh=e=>Al(ns({},"__esModule",{value:!0}),e);var Au=hr(Mn=>{"use strict";Object.defineProperty(Mn,"__esModule",{value:!0});Mn.BranchNode=Mn.LeafNode=void 0;var Yo=class{entries;constructor(t){this.entries=t}};Mn.LeafNode=Yo;var Wo=class{partitions;nodes;constructor(t,n){this.partitions=t,this.nodes=n}};Mn.BranchNode=Wo});var Tu=hr(ge=>{"use strict";Object.defineProperty(ge,"__esModule",{value:!0});ge.BTree=ge.NodeCapacity=void 0;var vt=Zo(),xt=Au();ge.NodeCapacity=64;var zo=class{keyFromEntry;compare;_root;_version=0;constructor(t=r=>r,n=(r,s)=>r<s?-1:r>s?1:0){this.keyFromEntry=t,this.compare=n,this._root=new xt.LeafNode([])}first(){return this.getFirst(this._root)}last(){return this.getLast(this._root)}find(t){return this.getPath(this._root,t)}get(t){return this.at(this.find(t))}at(t){return this.validatePath(t),t.on?t.leafNode.entries[t.leafIndex]:void 0}*range(t){let n=t.first?this.findFirst(t):t.isAscending?this.first():this.last(),r=t.last?this.findLast(t):t.isAscending?this.last():this.first(),s=this.keyFromEntry(r.leafNode.entries[r.leafIndex]),o=t.isAscending?this.internalAscending(n):this.internalDescending(n),a=t.isAscending?1:-1;for(let i of o){if(!i.on||!r.on||this.compareKeys(this.keyFromEntry(i.leafNode.entries[i.leafIndex]),s)*a>0)break;yield i}}isValid(t){return t.version===this._version}insert(t){Object.freeze(t);let n=this.internalInsert(t);return n.on&&(n.version=++this._version),n}updateAt(t,n){this.validatePath(t),t.on&&Object.freeze(n);let r=this.internalUpdate(t,n);return r[0].on&&(r[0].version=++this._version),r}upsert(t){let n=this.find(this.keyFromEntry(t));return Object.freeze(t),n.on?n.leafNode.entries[n.leafIndex]=t:this.internalInsertAt(n,t),n.version=++this._version,n}merge(t,n){let r=this.keyFromEntry(t),s=this.find(r);if(s.on){let o=this.updateAt(s,n(s.leafNode.entries[s.leafIndex]));return o[0].on&&(o[0].version=++this._version),o}else return this.internalInsertAt(s,Object.freeze(t)),s.on=!0,s.version=++this._version,[s,!1]}deleteAt(t){this.validatePath(t);let n=this.internalDelete(t);return n&&++this._version,n}ascending(t){return this.validatePath(t),this.internalAscending(t.clone())}descending(t){return this.validatePath(t),this.internalDescending(t.clone())}getCount(t){let n=0,r=t?t.path.clone():this.first();if(t?.ascending??!0)for(;r.on;)n+=r.leafNode.entries.length-r.leafIndex,r.leafIndex=r.leafNode.entries.length-1,this.internalNext(r);else for(;r.on;)n+=r.leafIndex+1,r.leafIndex=0,this.internalPrior(r);return n}next(t){let n=t.clone();return this.moveNext(n),n}moveNext(t){this.validatePath(t),this.internalNext(t)}prior(t){let n=t.clone();return this.movePrior(n),n}movePrior(t){this.validatePath(t),this.internalPrior(t)}compareKeys(t,n){let r=this.compare(t,n);if(r!==0&&r===this.compare(n,t))throw new Error("Inconsistent comparison function for given values");return r}*internalAscending(t){for(this.validatePath(t);t.on;)yield t,this.moveNext(t)}*internalDescending(t){for(this.validatePath(t);t.on;)yield t,this.movePrior(t)}findFirst(t){let n=this.find(t.first.key);return(!n.on||t.first&&!t.first.inclusive)&&(t.isAscending?this.internalNext(n):this.internalPrior(n)),n}findLast(t){let n=this.find(t.last.key);return(!n.on||t.last&&!t.last.inclusive)&&(t.isAscending?this.internalPrior(n):this.internalNext(n)),n}getPath(t,n){if(t instanceof xt.LeafNode){let r=t,[s,o]=this.indexOfEntry(r.entries,n);return new vt.Path([],r,o,s,this._version)}else{let r=t,s=this.indexOfKey(r.partitions,n),o=this.getPath(r.nodes[s],n);return o.branches.unshift(new vt.PathBranch(r,s)),o}}indexOfEntry(t,n){let r=0,s=t.length-1,o=0,a=-1;for(;r<=s;){if(o=r+s>>>1,a=this.compareKeys(n,this.keyFromEntry(t[o])),a===0)return[!0,o];a<0?s=o-1:r=o+1}return[!1,r]}indexOfKey(t,n){let r=0,s=t.length-1,o=0,a=-1;for(;r<=s;){if(o=r+s>>>1,a=this.compareKeys(n,t[o]),a===0)return o+1;a<0?s=o-1:r=o+1}return r}internalNext(t){if(t.on)if(t.leafIndex>=t.leafNode.entries.length-1){let n=0,r=!1,s=t.branches.length-1;for(;n<=s&&!r;){let o=t.branches[s-n];o.index===o.node.partitions.length?++n:r=!0}if(!r)t.leafIndex=t.leafNode.entries.length,t.on=!1;else{t.branches.splice(-n,n);let o=t.branches.at(-1);++o.index,this.moveToFirst(o.node.nodes[o.index],t)}}else++t.leafIndex,t.on=!0;else if(t.on=t.branches.every(n=>n.index>=0&&n.index<n.node.nodes.length)&&t.leafIndex>=0&&t.leafIndex<t.leafNode.entries.length,t.on)return}internalPrior(t){if(this.validatePath(t),t.leafIndex<=0){let n=0,r=!1,s=t.branches.length-1;for(;n<=s&&!r;)t.branches[s-n].index===0?++n:r=!0;if(!r)t.leafIndex=0,t.on=!1;else{t.branches.splice(-n,n);let o=t.branches.at(-1);--o.index,this.moveToLast(o.node.nodes[o.index],t)}}else--t.leafIndex,t.on=!0}internalUpdate(t,n){if(t.on){let r=this.keyFromEntry(t.leafNode.entries[t.leafIndex]),s=this.keyFromEntry(n);if(this.compareKeys(r,s)!==0){let o=this.internalInsert(n);return o.on&&(this.internalDelete(this.find(r)),o=this.find(s)),[o,!1]}else t.leafNode.entries[t.leafIndex]=n}return[t,!0]}internalDelete(t){if(t.on){if(t.leafNode.entries.splice(t.leafIndex,1),t.branches.length>0){if(t.leafIndex===0){let r=t.branches.at(-1);this.updatePartition(r.index,t,t.branches.length-1,this.keyFromEntry(t.leafNode.entries[t.leafIndex]))}let n=this.rebalanceLeaf(t,t.branches.length);n&&(this._root=n)}return t.on=!1,!0}else return!1}internalInsert(t){let n=this.find(this.keyFromEntry(t));return n.on?(n.on=!1,n):(this.internalInsertAt(n,t),n.on=!0,n)}internalInsertAt(t,n){let r=this.leafInsert(t,n),s=t.branches.length-1;for(;r&&s>=0;)r=this.branchInsert(t,s,r),--s;if(r){let o=new xt.BranchNode([r.key],[this._root,r.right]);this._root=o,t.branches.unshift(new vt.PathBranch(o,r.indexDelta))}}moveToFirst(t,n){if(t instanceof xt.LeafNode){let r=t;n.leafNode=r,n.leafIndex=0,n.on=r.entries.length>0}else n.branches.push(new vt.PathBranch(t,0)),this.moveToFirst(t.nodes[0],n)}moveToLast(t,n){if(t instanceof xt.LeafNode){let r=t,s=r.entries.length;n.leafNode=r,n.on=s>0,n.leafIndex=s>0?s-1:0}else{let r=t,s=new vt.PathBranch(r,r.partitions.length);n.branches.push(s),this.moveToLast(r.nodes[s.index],n)}}getFirst(t){if(t instanceof xt.LeafNode){let n=t;return new vt.Path([],n,0,n.entries.length>0,this._version)}else{let n=t,r=this.getFirst(n.nodes[0]);return r.branches.unshift(new vt.PathBranch(n,0)),r}}getLast(t){if(t instanceof xt.LeafNode){let n=t,r=n.entries.length;return new vt.Path([],n,r>0?r-1:0,r>0,this._version)}else{let n=t,r=n.nodes.length-1,s=this.getLast(n.nodes[r]);return s.branches.unshift(new vt.PathBranch(n,r)),s}}leafInsert(t,n){let{leafNode:r,leafIndex:s}=t;if(r.entries.length<ge.NodeCapacity){r.entries.splice(s,0,n);return}let o=r.entries.length+1>>>1,a=r.entries.splice(o),i=new xt.LeafNode(a);return s<o?r.entries.splice(s,0,n):(t.leafNode=i,t.leafIndex-=r.entries.length,i.entries.splice(t.leafIndex,0,n)),new ys(this.keyFromEntry(a[0]),i,s<o?0:1)}branchInsert(t,n,r){let s=t.branches[n],{index:o,node:a}=s;if(s.index+=r.indexDelta,a.partitions.splice(o,0,r.key),a.nodes.splice(o+1,0,r.right),a.nodes.length<=ge.NodeCapacity)return;let i=a.nodes.length>>>1,c=a.partitions.splice(i),f=a.partitions.pop(),d=a.nodes.splice(i),l=new xt.BranchNode(c,d);return s.index>=i&&(s.index-=i),new ys(f,l,s.index<i?0:1)}rebalanceLeaf(t,n){if(n===0||t.leafNode.entries.length>=ge.NodeCapacity>>>1)return;let r=t.leafNode,s=t.branches.at(n-1),o=s.index,a=s.node,i=o<a.nodes.length?a.nodes[o+1]:void 0;if(i&&i.entries.length>ge.NodeCapacity>>>1){let f=i.entries.shift();r.entries.push(f),this.updatePartition(o+1,t,n-1,this.keyFromEntry(i.entries[0]));return}let c=o>0?a.nodes[o-1]:void 0;if(c&&c.entries.length>ge.NodeCapacity>>>1){let f=c.entries.pop();r.entries.unshift(f),this.updatePartition(o,t,n-1,this.keyFromEntry(f)),t.leafIndex+=1;return}if(i&&i.entries.length+r.entries.length<=ge.NodeCapacity)return r.entries.push(...i.entries),a.partitions.splice(o,1),a.nodes.splice(o+1,1),o===0&&this.updatePartition(o,t,n-1,this.keyFromEntry(r.entries[0])),this.rebalanceBranch(t,n-1);if(c&&c.entries.length+r.entries.length<=ge.NodeCapacity)return c.entries.push(...r.entries),a.partitions.splice(o-1,1),a.nodes.splice(o,1),t.leafNode=c,t.leafIndex+=c.entries.length,this.rebalanceBranch(t,n-1)}rebalanceBranch(t,n){let r=t.branches[n],s=r.node;if(n===0&&s.partitions.length===0)return t.branches[n+1]?.node??t.leafNode;if(n===0||s.nodes.length>=ge.NodeCapacity<<1)return;let o=t.branches.at(n-1),a=o.index,i=o.node,c=a<i.nodes.length?i.nodes[a+1]:void 0;if(c&&c.nodes.length>ge.NodeCapacity>>>1){s.partitions.push(i.partitions[a]);let d=c.nodes.shift();s.nodes.push(d);let l=c.partitions.shift();this.updatePartition(a+1,t,n-1,l);return}let f=a>0?i.nodes[a-1]:void 0;if(f&&f.nodes.length>ge.NodeCapacity>>>1){s.partitions.unshift(i.partitions[a-1]);let d=f.nodes.pop();s.nodes.unshift(d);let l=f.partitions.pop();r.index+=1,this.updatePartition(a,t,n-1,l);return}if(c&&c.nodes.length+s.nodes.length<=ge.NodeCapacity){let d=i.partitions.splice(a,1)[0];return s.partitions.push(d),s.partitions.push(...c.partitions),s.nodes.push(...c.nodes),i.nodes.splice(a+1,1),a===0&&i.partitions.length>0&&this.updatePartition(a,t,n-1,i.partitions[0]),this.rebalanceBranch(t,n-1)}if(f&&f.nodes.length+s.nodes.length<=ge.NodeCapacity){let d=i.partitions.splice(a-1,1)[0];return f.partitions.push(d),f.partitions.push(...s.partitions),f.nodes.push(...s.nodes),i.nodes.splice(a,1),r.node=f,r.index+=f.nodes.length,this.rebalanceBranch(t,n-1)}}updatePartition(t,n,r,s){let o=n.branches[r];t>0?o.node.partitions[t-1]=s:r!==0&&this.updatePartition(n.branches[r-1].index,n,r-1,s)}validatePath(t){if(!this.isValid(t))throw new Error("Path is invalid due to mutation of the tree")}};ge.BTree=zo;var ys=class{key;right;indexDelta;constructor(t,n,r){this.key=t,this.right=n,this.indexDelta=r}}});var vu=hr(Dn=>{"use strict";Object.defineProperty(Dn,"__esModule",{value:!0});Dn.KeyRange=Dn.KeyBound=void 0;var Ho=class{key;inclusive;constructor(t,n=!0){this.key=t,this.inclusive=n}};Dn.KeyBound=Ho;var Xo=class{first;last;isAscending;constructor(t,n,r=!0){this.first=t,this.last=n,this.isAscending=r}};Dn.KeyRange=Xo});var xu=hr(Pn=>{"use strict";Object.defineProperty(Pn,"__esModule",{value:!0});Pn.Path=Pn.PathBranch=void 0;var Jo=class e{node;index;constructor(t,n){this.node=t,this.index=n}clone(){return new e(this.node,this.index)}};Pn.PathBranch=Jo;var Qo=class e{branches;leafNode;leafIndex;on;version;constructor(t,n,r,s,o){this.branches=t,this.leafNode=n,this.leafIndex=r,this.on=s,this.version=o}isEqual(t){return this.leafNode===t.leafNode&&this.leafIndex===t.leafIndex&&this.on===t.on&&this.version===t.version}clone(){return new e(this.branches.map(t=>t.clone()),this.leafNode,this.leafIndex,this.on,this.version)}};Pn.Path=Qo});var Zo=hr(Lt=>{"use strict";var vm=Lt&&Lt.__createBinding||(Object.create?function(e,t,n,r){r===void 0&&(r=n);var s=Object.getOwnPropertyDescriptor(t,n);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,s)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]}),ea=Lt&&Lt.__exportStar||function(e,t){for(var n in e)n!=="default"&&!Object.prototype.hasOwnProperty.call(t,n)&&vm(t,e,n)};Object.defineProperty(Lt,"__esModule",{value:!0});ea(Tu(),Lt);ea(vu(),Lt);ea(xu(),Lt)});var wy={};Bo(wy,{Compiler:()=>On,ConflictResolution:()=>oe,ConstraintError:()=>Ct,Database:()=>Uo,FunctionContext:()=>Ze,Latches:()=>Tt,Lexer:()=>vn,MemoryTableModule:()=>Kt,MisuseError:()=>$,Opcode:()=>u,ParseError:()=>St,Parser:()=>ze,SchemaManager:()=>$n,SqlDataType:()=>A,SqliteError:()=>R,Statement:()=>Fn,StatusCode:()=>I,TokenType:()=>m,Vdbe:()=>kn,VirtualTable:()=>at,VirtualTableCursor:()=>it,createInstruction:()=>xn});var I;(function(e){e[e.OK=0]="OK",e[e.ERROR=1]="ERROR",e[e.INTERNAL=2]="INTERNAL",e[e.PERM=3]="PERM",e[e.ABORT=4]="ABORT",e[e.BUSY=5]="BUSY",e[e.LOCKED=6]="LOCKED",e[e.NOMEM=7]="NOMEM",e[e.READONLY=8]="READONLY",e[e.INTERRUPT=9]="INTERRUPT",e[e.IOERR=10]="IOERR",e[e.CORRUPT=11]="CORRUPT",e[e.NOTFOUND=12]="NOTFOUND",e[e.FULL=13]="FULL",e[e.CANTOPEN=14]="CANTOPEN",e[e.PROTOCOL=15]="PROTOCOL",e[e.EMPTY=16]="EMPTY",e[e.SCHEMA=17]="SCHEMA",e[e.TOOBIG=18]="TOOBIG",e[e.CONSTRAINT=19]="CONSTRAINT",e[e.MISMATCH=20]="MISMATCH",e[e.MISUSE=21]="MISUSE",e[e.NOLFS=22]="NOLFS",e[e.AUTH=23]="AUTH",e[e.FORMAT=24]="FORMAT",e[e.RANGE=25]="RANGE",e[e.NOTADB=26]="NOTADB",e[e.NOTICE=27]="NOTICE",e[e.WARNING=28]="WARNING",e[e.ROW=100]="ROW",e[e.DONE=101]="DONE"})(I||(I={}));var A;(function(e){e[e.INTEGER=1]="INTEGER",e[e.REAL=2]="REAL",e[e.TEXT=3]="TEXT",e[e.BLOB=4]="BLOB",e[e.NULL=5]="NULL",e[e.NUMERIC=6]="NUMERIC"})(A||(A={}));var u;(function(e){e[e.Init=1]="Init",e[e.Goto=2]="Goto",e[e.Halt=0]="Halt",e[e.Noop=145]="Noop",e[e.Null=11]="Null",e[e.Integer=6]="Integer",e[e.Int64=118]="Int64",e[e.String8=119]="String8",e[e.Real=117]="Real",e[e.Blob=40]="Blob",e[e.ZeroBlob=146]="ZeroBlob",e[e.SCopy=9]="SCopy",e[e.Move=12]="Move",e[e.Clear=10]="Clear",e[e.IfTrue=15]="IfTrue",e[e.IfFalse=16]="IfFalse",e[e.IfZero=93]="IfZero",e[e.IfNull=17]="IfNull",e[e.IfNotNull=18]="IfNotNull",e[e.IsNull=8]="IsNull",e[e.NotNull=19]="NotNull",e[e.Eq=76]="Eq",e[e.Ne=75]="Ne",e[e.Lt=77]="Lt",e[e.Le=78]="Le",e[e.Gt=79]="Gt",e[e.Ge=80]="Ge",e[e.Once=14]="Once",e[e.IfPos=97]="IfPos",e[e.IfNeg=98]="IfNeg",e[e.Add=67]="Add",e[e.Subtract=68]="Subtract",e[e.Multiply=69]="Multiply",e[e.Divide=70]="Divide",e[e.Remainder=71]="Remainder",e[e.Concat=72]="Concat",e[e.Negative=73]="Negative",e[e.BitAnd=74]="BitAnd",e[e.BitOr=84]="BitOr",e[e.ShiftLeft=85]="ShiftLeft",e[e.ShiftRight=86]="ShiftRight",e[e.BitNot=87]="BitNot",e[e.Not=88]="Not",e[e.Affinity=91]="Affinity",e[e.OpenEphemeral=5]="OpenEphemeral",e[e.Rewind=7]="Rewind",e[e.MakeRecord=83]="MakeRecord",e[e.IdxInsert=123]="IdxInsert",e[e.Function=108]="Function",e[e.OpenRead=58]="OpenRead",e[e.OpenWrite=59]="OpenWrite",e[e.Close=159]="Close",e[e.VFilter=166]="VFilter",e[e.VNext=167]="VNext",e[e.VColumn=192]="VColumn",e[e.VUpdate=168]="VUpdate",e[e.VRowid=169]="VRowid",e[e.VBegin=170]="VBegin",e[e.VCommit=171]="VCommit",e[e.VRollback=172]="VRollback",e[e.VSync=173]="VSync",e[e.VSavepoint=174]="VSavepoint",e[e.VRelease=175]="VRelease",e[e.VRollbackTo=176]="VRollbackTo",e[e.ResultRow=81]="ResultRow",e[e.Sort=130]="Sort",e[e.Sorted=115]="Sorted",e[e.Subroutine=133]="Subroutine",e[e.Return=134]="Return",e[e.FrameEnter=135]="FrameEnter",e[e.FrameLeave=136]="FrameLeave",e[e.Push=131]="Push",e[e.StackPop=132]="StackPop",e[e.AggStep=109]="AggStep",e[e.AggFinal=110]="AggFinal",e[e.AggIterate=126]="AggIterate",e[e.AggNext=127]="AggNext",e[e.AggKey=128]="AggKey",e[e.AggContext=129]="AggContext",e[e.AggGroupValue=140]="AggGroupValue",e[e.AggReset=147]="AggReset",e[e.CollSeq=120]="CollSeq",e[e.OpenPseudo=121]="OpenPseudo",e[e.Next=124]="Next",e[e.VerifyCookie=107]="VerifyCookie",e[e.Savepoint=141]="Savepoint",e[e.SeekRel=160]="SeekRel",e[e.MaxPtr=161]="MaxPtr",e[e.AggFrame=162]="AggFrame",e[e.FrameValue=163]="FrameValue",e[e.RangeScan=164]="RangeScan",e[e.Lag=165]="Lag",e[e.Lead=166]="Lead"})(u||(u={}));var M;(function(e){e[e.UTF8=1]="UTF8",e[e.DETERMINISTIC=2048]="DETERMINISTIC",e[e.DIRECTONLY=524288]="DIRECTONLY",e[e.INNOCUOUS=2097152]="INNOCUOUS"})(M||(M={}));var Tl;(function(e){e[e.CONSTRAINT_SUPPORT=1]="CONSTRAINT_SUPPORT",e[e.INNOCUOUS=2]="INNOCUOUS",e[e.DIRECTONLY=3]="DIRECTONLY",e[e.USES_ALL_SCHEMAS=4]="USES_ALL_SCHEMAS"})(Tl||(Tl={}));var G;(function(e){e[e.EQ=2]="EQ",e[e.GT=4]="GT",e[e.LE=8]="LE",e[e.LT=16]="LT",e[e.GE=32]="GE",e[e.MATCH=64]="MATCH",e[e.LIKE=65]="LIKE",e[e.GLOB=66]="GLOB",e[e.REGEXP=67]="REGEXP",e[e.NE=68]="NE",e[e.ISNOT=69]="ISNOT",e[e.ISNOTNULL=70]="ISNOTNULL",e[e.ISNULL=71]="ISNULL",e[e.IS=72]="IS",e[e.LIMIT=73]="LIMIT",e[e.OFFSET=74]="OFFSET",e[e.FUNCTION=150]="FUNCTION"})(G||(G={}));var oe;(function(e){e[e.ROLLBACK=1]="ROLLBACK",e[e.ABORT=4]="ABORT",e[e.FAIL=3]="FAIL",e[e.IGNORE=2]="IGNORE",e[e.REPLACE=5]="REPLACE"})(oe||(oe={}));var vl;(function(e){e[e.DELETE=9]="DELETE",e[e.INSERT=18]="INSERT",e[e.UPDATE=23]="UPDATE"})(vl||(vl={}));var R=class e extends Error{code;cause;line;column;constructor(t,n=I.ERROR,r,s,o){super(t),this.code=n,this.name="SqliteError",this.cause=r,this.line=s,this.column=o,s!==void 0&&o!==void 0&&(this.message=`${t} (at line ${s}, column ${o})`),Error.captureStackTrace&&Error.captureStackTrace(this,e)}},rs=class extends R{token;constructor(t,n){super(t,I.ERROR,void 0,n.startLine,n.startColumn),this.token=n,this.name="ParseError"}},Ct=class extends R{constructor(t,n=I.CONSTRAINT){super(t,n),this.name="ConstraintError"}};var $=class e extends R{constructor(t="API misuse"){super(t,I.MISUSE),this.name="MisuseError",Object.setPrototypeOf(this,e.prototype)}};var m;(function(e){e.INTEGER="INTEGER",e.FLOAT="FLOAT",e.STRING="STRING",e.IDENTIFIER="IDENTIFIER",e.BLOB="BLOB",e.SELECT="SELECT",e.FROM="FROM",e.WHERE="WHERE",e.INSERT="INSERT",e.UPDATE="UPDATE",e.DELETE="DELETE",e.CREATE="CREATE",e.DROP="DROP",e.ALTER="ALTER",e.TABLE="TABLE",e.INDEX="INDEX",e.VIEW="VIEW",e.TEMP="TEMP",e.TEMPORARY="TEMPORARY",e.VIRTUAL="VIRTUAL",e.USING="USING",e.INTO="INTO",e.NULL="NULL",e.NOT="NOT",e.AND="AND",e.OR="OR",e.IN="IN",e.LIKE="LIKE",e.BETWEEN="BETWEEN",e.IS="IS",e.AS="AS",e.DISTINCT="DISTINCT",e.GROUP="GROUP",e.BY="BY",e.HAVING="HAVING",e.ORDER="ORDER",e.ASC="ASC",e.DESC="DESC",e.LIMIT="LIMIT",e.OFFSET="OFFSET",e.UNION="UNION",e.ALL="ALL",e.PRIMARY="PRIMARY",e.CONSTRAINT="CONSTRAINT",e.GENERATED="GENERATED",e.COLLATE="COLLATE",e.KEY="KEY",e.UNIQUE="UNIQUE",e.DEFAULT="DEFAULT",e.CHECK="CHECK",e.FOREIGN="FOREIGN",e.REFERENCES="REFERENCES",e.AUTOINCREMENT="AUTOINCREMENT",e.ON="ON",e.CONFLICT="CONFLICT",e.CASCADE="CASCADE",e.RESTRICT="RESTRICT",e.SET="SET",e.NO="NO",e.ACTION="ACTION",e.WITHOUT="WITHOUT",e.ROWID="ROWID",e.RENAME="RENAME",e.COLUMN="COLUMN",e.TO="TO",e.ADD="ADD",e.ALWAYS="ALWAYS",e.ABORT="ABORT",e.FAIL="FAIL",e.IGNORE="IGNORE",e.BEGIN="BEGIN",e.COMMIT="COMMIT",e.ROLLBACK="ROLLBACK",e.TRANSACTION="TRANSACTION",e.DEFERRED="DEFERRED",e.IMMEDIATE="IMMEDIATE",e.EXCLUSIVE="EXCLUSIVE",e.JOIN="JOIN",e.INNER="INNER",e.LEFT="LEFT",e.RIGHT="RIGHT",e.FULL="FULL",e.CROSS="CROSS",e.OUTER="OUTER",e.NATURAL="NATURAL",e.REPLACE="REPLACE",e.VALUES="VALUES",e.EXISTS="EXISTS",e.IF="IF",e.DEFERRABLE="DEFERRABLE",e.INITIALLY="INITIALLY",e.STORED="STORED",e.SAVEPOINT="SAVEPOINT",e.RELEASE="RELEASE",e.PRAGMA="PRAGMA",e.PLUS="PLUS",e.MINUS="MINUS",e.ASTERISK="ASTERISK",e.SLASH="SLASH",e.PERCENT="PERCENT",e.EQUAL="EQUAL",e.EQUAL_EQUAL="EQUAL_EQUAL",e.NOT_EQUAL="NOT_EQUAL",e.LESS="LESS",e.LESS_EQUAL="LESS_EQUAL",e.GREATER="GREATER",e.GREATER_EQUAL="GREATER_EQUAL",e.LPAREN="LPAREN",e.RPAREN="RPAREN",e.COMMA="COMMA",e.DOT="DOT",e.SEMICOLON="SEMICOLON",e.TILDE="TILDE",e.PIPE="PIPE",e.PIPE_PIPE="PIPE_PIPE",e.AMPERSAND="AMPERSAND",e.AMPERSAND_AMPERSAND="AMPERSAND_AMPERSAND",e.QUESTION="QUESTION",e.COLON="COLON",e.DOLLAR="DOLLAR",e.ARROW="ARROW",e.EOF="EOF",e.ERROR="ERROR"})(m||(m={}));var Qh={select:m.SELECT,from:m.FROM,where:m.WHERE,insert:m.INSERT,update:m.UPDATE,delete:m.DELETE,create:m.CREATE,drop:m.DROP,alter:m.ALTER,table:m.TABLE,index:m.INDEX,view:m.VIEW,virtual:m.VIRTUAL,using:m.USING,null:m.NULL,not:m.NOT,and:m.AND,or:m.OR,in:m.IN,like:m.LIKE,between:m.BETWEEN,is:m.IS,as:m.AS,distinct:m.DISTINCT,group:m.GROUP,by:m.BY,having:m.HAVING,order:m.ORDER,asc:m.ASC,desc:m.DESC,limit:m.LIMIT,offset:m.OFFSET,union:m.UNION,all:m.ALL,primary:m.PRIMARY,key:m.KEY,unique:m.UNIQUE,default:m.DEFAULT,check:m.CHECK,foreign:m.FOREIGN,references:m.REFERENCES,on:m.ON,conflict:m.CONFLICT,cascade:m.CASCADE,restrict:m.RESTRICT,set:m.SET,autoincrement:m.AUTOINCREMENT,no:m.NO,action:m.ACTION,without:m.WITHOUT,rowid:m.ROWID,begin:m.BEGIN,commit:m.COMMIT,rollback:m.ROLLBACK,transaction:m.TRANSACTION,deferred:m.DEFERRED,immediate:m.IMMEDIATE,exclusive:m.EXCLUSIVE,deferrable:m.DEFERRABLE,initially:m.INITIALLY,stored:m.STORED,join:m.JOIN,inner:m.INNER,left:m.LEFT,right:m.RIGHT,full:m.FULL,cross:m.CROSS,outer:m.OUTER,natural:m.NATURAL,replace:m.REPLACE,values:m.VALUES,exists:m.EXISTS,if:m.IF,into:m.INTO,temp:m.TEMP,temporary:m.TEMPORARY,rename:m.RENAME,to:m.TO,add:m.ADD,always:m.ALWAYS,abort:m.ABORT,fail:m.FAIL,ignore:m.IGNORE,savepoint:m.SAVEPOINT,release:m.RELEASE,pragma:m.PRAGMA},vn=class{source;tokens=[];start=0;current=0;line=1;column=1;startLine=1;startColumn=1;constructor(t){this.source=t}scanTokens(){for(;!this.isAtEnd();)this.start=this.current,this.startLine=this.line,this.startColumn=this.column,this.scanToken();return this.tokens.push({type:m.EOF,lexeme:"",startLine:this.line,startColumn:this.column,startOffset:this.source.length,endLine:this.line,endColumn:this.column,endOffset:this.source.length}),this.tokens}isAtEnd(){return this.current>=this.source.length}scanToken(){let t=this.advance();switch(t){case"(":this.addToken(m.LPAREN);break;case")":this.addToken(m.RPAREN);break;case",":this.addToken(m.COMMA);break;case".":this.addToken(m.DOT);break;case";":this.addToken(m.SEMICOLON);break;case"+":this.addToken(m.PLUS);break;case"-":this.match(">")?this.addToken(m.ARROW):this.addToken(m.MINUS);break;case"*":this.addToken(m.ASTERISK);break;case"/":if(this.match("/"))for(;this.peek()!==`
`&&!this.isAtEnd();)this.advance();else this.match("*")?this.multilineComment():this.addToken(m.SLASH);break;case"%":this.addToken(m.PERCENT);break;case"~":this.addToken(m.TILDE);break;case"?":this.addToken(m.QUESTION);break;case":":this.addToken(m.COLON);break;case"$":this.addToken(m.DOLLAR);break;case"=":this.addToken(this.match("=")?m.EQUAL_EQUAL:m.EQUAL);break;case"!":this.addToken(this.match("=")?m.NOT_EQUAL:m.ERROR);break;case"<":this.match("=")?this.addToken(m.LESS_EQUAL):this.match(">")?this.addToken(m.NOT_EQUAL):this.addToken(m.LESS);break;case">":this.addToken(this.match("=")?m.GREATER_EQUAL:m.GREATER);break;case"|":this.addToken(this.match("|")?m.PIPE_PIPE:m.PIPE);break;case"&":this.addToken(this.match("&")?m.AMPERSAND_AMPERSAND:m.AMPERSAND);break;case"'":this.string("'");break;case'"':this.string('"');break;case"`":this.backtickIdentifier();break;case"[":this.bracketIdentifier();break;case"x":case"X":this.match("'")?this.blobLiteral():this.identifier();break;case" ":case"\r":case"	":break;case`
`:this.line++,this.column=1;break;default:this.isDigit(t)?this.number():this.isAlpha(t)?this.identifier():this.addErrorToken(`Unexpected character: ${t}`);break}}advance(){let t=this.source.charAt(this.current);return this.current++,t===`
`?(this.line++,this.column=1):this.column++,t}match(t){return this.isAtEnd()||this.source.charAt(this.current)!==t?!1:(this.current++,this.column++,!0)}peek(){return this.isAtEnd()?"\0":this.source.charAt(this.current)}peekNext(){return this.current+1>=this.source.length?"\0":this.source.charAt(this.current+1)}string(t){let n="",r=!1;for(;!this.isAtEnd()&&this.peek()!==t||r;){if(this.peek()===`
`&&(this.line++,this.column=1),r){let s=this.peek();switch(s){case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"\\":n+="\\";break;case"'":n+="'";break;case'"':n+='"';break;case"0":n+="\0";break;default:n+=s;break}r=!1}else this.peek()==="\\"?r=!0:n+=this.peek();this.advance()}if(this.isAtEnd()){this.addErrorToken("Unterminated string.");return}if(this.advance(),this.peek()===t&&(this.advance(),this.string(t),this.tokens.length>0&&this.tokens[this.tokens.length-1].type===m.STRING)){let s=this.tokens.pop();n+=s.literal}this.addToken(m.STRING,n)}backtickIdentifier(){let t="";for(;!this.isAtEnd()&&this.peek()!=="`";)this.peek()===`
`&&(this.line++,this.column=1),t+=this.advance();if(this.isAtEnd()){this.addErrorToken("Unterminated identifier.");return}this.advance(),this.addToken(m.IDENTIFIER,t)}bracketIdentifier(){let t="";for(;!this.isAtEnd()&&this.peek()!=="]";)this.peek()===`
`&&(this.line++,this.column=1),t+=this.advance();if(this.isAtEnd()){this.addErrorToken("Unterminated identifier.");return}this.advance(),this.addToken(m.IDENTIFIER,t)}blobLiteral(){let t="";for(;!this.isAtEnd()&&this.peek()!=="'";)if(this.isHexDigit(this.peek()))t+=this.advance();else if(this.isWhitespace(this.peek()))this.advance();else{this.addErrorToken("Invalid character in blob literal.");return}if(this.isAtEnd()){this.addErrorToken("Unterminated blob literal.");return}if(this.advance(),t.length%2!==0){this.addErrorToken("Blob literal must have an even number of hex digits.");return}try{let n=new Uint8Array(t.length/2);for(let r=0;r<t.length;r+=2)n[r/2]=parseInt(t.substring(r,r+2),16);this.addToken(m.BLOB,n)}catch{this.addErrorToken("Invalid blob literal.")}}number(){let t=!1,n="";for(;this.isDigit(this.peek());)n+=this.advance();if(this.peek()==="."&&this.isDigit(this.peekNext()))for(t=!0,n+=this.advance();this.isDigit(this.peek());)n+=this.advance();if(this.peek().toLowerCase()==="e"){if(t=!0,n+=this.advance(),(this.peek()==="+"||this.peek()==="-")&&(n+=this.advance()),!this.isDigit(this.peek())){this.addErrorToken("Invalid number literal: expected digits after exponent.");return}for(;this.isDigit(this.peek());)n+=this.advance()}if(t)this.addToken(m.FLOAT,parseFloat(n));else{let r=parseInt(n,10);r>Number.MAX_SAFE_INTEGER||r<Number.MIN_SAFE_INTEGER?this.addToken(m.INTEGER,BigInt(n)):this.addToken(m.INTEGER,r)}}identifier(){for(;this.isAlphaNumeric(this.peek());)this.advance();let t=this.source.substring(this.start,this.current).toLowerCase(),n=Qh[t]||m.IDENTIFIER;this.addToken(n)}multilineComment(){let t=1;for(;t>0&&!this.isAtEnd();)this.peek()==="/"&&this.peekNext()==="*"?(this.advance(),this.advance(),t++):this.peek()==="*"&&this.peekNext()==="/"?(this.advance(),this.advance(),t--):(this.peek()===`
`?(this.line++,this.column=1):this.column++,this.advance());t>0&&this.addErrorToken("Unterminated comment.")}isDigit(t){return t>="0"&&t<="9"}isHexDigit(t){return t>="0"&&t<="9"||t>="a"&&t<="f"||t>="A"&&t<="F"}isAlpha(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t==="_"}isAlphaNumeric(t){return this.isAlpha(t)||this.isDigit(t)}isWhitespace(t){return t===" "||t==="\r"||t===`
`||t==="	"}addToken(t,n){let r=this.source.substring(this.start,this.current);this.tokens.push({type:t,lexeme:r,literal:n,startLine:this.startLine,startColumn:this.startColumn,startOffset:this.start,endLine:this.line,endColumn:this.column-1,endOffset:this.current})}addErrorToken(t){this.tokens.push({type:m.ERROR,lexeme:t,startLine:this.line,startColumn:this.column-1,startOffset:this.current-1,endLine:this.line,endColumn:this.column-1,endOffset:this.current})}};var St=class extends Error{token;constructor(t,n){super(n),this.token=t,this.name="ParseError"}};function K(e,t){return{start:{line:e.startLine,column:e.startColumn,offset:e.startOffset},end:{line:t.endLine,column:t.endColumn,offset:t.endOffset}}}var ze=class{tokens=[];current=0;parameterPosition=1;initialize(t){let n=new vn(t);this.tokens=n.scanTokens(),this.current=0,this.parameterPosition=1;let r=this.tokens.find(s=>s.type===m.ERROR);if(r)throw new St(r,`${r.lexeme} at line ${r.startLine}, column ${r.startColumn}`);return this}parse(t){this.initialize(t);try{let n=this.tryParseWithClause(),r=this.peek(),s=this.statement(r);if(n&&"withClause"in s)s.withClause=n,n.loc&&s.loc&&(s.loc.start=n.loc.start);else if(n)throw this.error(this.previous(),`WITH clause cannot be used with ${s.type} statement.`);if(this.match(m.SEMICOLON),!this.isAtEnd())throw this.error(this.peek(),`Unexpected token after end of statement: ${this.peek().lexeme}`);return s}catch(n){if(n instanceof St){if(!n.message.includes(`at line ${n.token.startLine}`)){let r=` at line ${n.token.startLine}, column ${n.token.startColumn}`;n.message=n.message+r}throw n}throw console.error("Unhandled parser error:",n),new Error(`Parser error: ${n instanceof Error?n.message:n}`)}}tryParseWithClause(){if(!this.check(m.IDENTIFIER)||this.peek().lexeme.toUpperCase()!=="WITH")return;let t=this.advance(),n=this.matchKeyword("RECURSIVE"),r=[];do r.push(this.commonTableExpression());while(this.match(m.COMMA));let s=this.previous();return{type:"withClause",recursive:n,ctes:r,loc:K(t,s)}}commonTableExpression(){let t=this.peek(),n=this.consumeIdentifier("Expected CTE name."),r=this.previous(),s;if(this.match(m.LPAREN)){if(s=[],!this.check(m.RPAREN))do s.push(this.consumeIdentifier("Expected column name in CTE definition."));while(this.match(m.COMMA));r=this.consume(m.RPAREN,"Expected ')' after CTE column list.")}this.consume(m.AS,"Expected 'AS' after CTE name."),this.consume(m.LPAREN,"Expected '(' before CTE query.");let o=this.peek(),a;if(this.check(m.SELECT))a=this.selectStatement(o);else if(this.check(m.INSERT))a=this.insertStatement(o);else if(this.check(m.UPDATE))a=this.updateStatement(o);else if(this.check(m.DELETE))a=this.deleteStatement(o);else throw this.error(this.peek(),"Expected SELECT, INSERT, UPDATE, or DELETE statement for CTE query.");return r=this.consume(m.RPAREN,"Expected ')' after CTE query."),{type:"commonTableExpr",name:n,columns:s,query:a,loc:K(t,r)}}statement(t){switch(t.lexeme.toUpperCase()){case"SELECT":return this.advance(),this.selectStatement(t);case"INSERT":return this.advance(),this.insertStatement(t);case"UPDATE":return this.advance(),this.updateStatement(t);case"DELETE":return this.advance(),this.deleteStatement(t);case"CREATE":return this.advance(),this.createStatement(t);case"DROP":return this.advance(),this.dropStatement(t);case"ALTER":return this.advance(),this.alterTableStatement(t);case"BEGIN":return this.advance(),this.beginStatement(t);case"COMMIT":return this.advance(),this.commitStatement(t);case"ROLLBACK":return this.advance(),this.rollbackStatement(t);case"SAVEPOINT":return this.advance(),this.savepointStatement(t);case"RELEASE":return this.advance(),this.releaseStatement(t);case"PRAGMA":return this.advance(),this.pragmaStatement(t);default:throw this.error(t,`Expected statement type (SELECT, INSERT, UPDATE, DELETE, CREATE, etc.), got '${t.lexeme}'.`)}}insertStatement(t){this.matchKeyword("INTO");let n=this.tableIdentifier(),r;if(this.match(m.LPAREN)){r=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name.");r.push(this.advance().lexeme)}while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after column list.")}let s,o,a=this.previous();if(this.match(m.VALUES)){s=[];do{this.consume(m.LPAREN,"Expected '(' before values.");let i=[];if(!this.check(m.RPAREN))do i.push(this.expression());while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after values."),s.push(i),a=this.previous()}while(this.match(m.COMMA))}else if(this.check(m.SELECT)){let i=this.peek();o=this.selectStatement(i),a=this.previous()}else throw this.error(this.peek(),"Expected VALUES or SELECT after INSERT.");return{type:"insert",table:n,columns:r,values:s,select:o,loc:K(t,a)}}selectStatement(t){let n=t??this.previous(),r=n,s=this.matchKeyword("DISTINCT");s&&(r=this.previous());let o=!s&&this.matchKeyword("ALL");o&&(r=this.previous());let a=this.columnList();a.length>0&&(r=this.previous());let i;this.match(m.FROM)&&(i=this.tableSourceList(),i.length>0&&(r=this.previous()));let c;this.match(m.WHERE)&&(c=this.expression(),r=this.previous());let f;if(this.match(m.GROUP)&&this.consume(m.BY,"Expected 'BY' after 'GROUP'.")){f=[];do f.push(this.expression());while(this.match(m.COMMA));r=this.previous()}let d;this.match(m.HAVING)&&(d=this.expression(),r=this.previous());let l;if(this.match(m.ORDER)&&this.consume(m.BY,"Expected 'BY' after 'ORDER'.")){l=[];do{let w=this.expression(),y=this.match(m.DESC)?"desc":(this.match(m.ASC),"asc");l.push({expr:w,direction:y})}while(this.match(m.COMMA));r=this.previous()}let h,p;this.match(m.LIMIT)&&(h=this.expression(),r=this.previous(),this.match(m.OFFSET)?(p=this.expression(),r=this.previous()):this.match(m.COMMA)&&(p=h,h=this.expression(),r=this.previous()));let g,E=!1;if(this.match(m.UNION)){E=this.match(m.ALL);let w=this.peek();if(this.match(m.SELECT))g=this.selectStatement(w),r=this.previous();else throw this.error(this.peek(),"Expected 'SELECT' after 'UNION'.")}return{type:"select",columns:a,from:i,where:c,groupBy:f,having:d,orderBy:l,limit:h,offset:p,distinct:s,all:o,union:g,unionAll:E,loc:K(n,r)}}columnList(){let t=[],n=this.peek();do if(n=this.peek(),this.match(m.ASTERISK))t.push({type:"all"});else if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.DOT)&&this.checkNext(2,m.ASTERISK)){let r=this.advance().lexeme;this.advance(),this.advance(),t.push({type:"all",table:r})}else{let r=this.expression(),s,o=this.previous();if(this.match(m.AS))if(this.check(m.IDENTIFIER)||this.check(m.STRING)){let a=this.advance();s=a.lexeme,a.type===m.STRING&&(s=a.literal),o=a}else throw this.error(this.peek(),"Expected identifier or string after 'AS'.");else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.LPAREN)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isEndOfClause()){let a=this.advance();s=a.lexeme,o=a}t.push({type:"column",expr:r,alias:s})}while(this.match(m.COMMA));return t}tableIdentifier(){let t=this.peek(),n,r,s=t;if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.DOT)){if(n=this.advance().lexeme,this.advance(),!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected table name after schema.");r=this.advance().lexeme,s=this.previous()}else if(this.check(m.IDENTIFIER))r=this.advance().lexeme,s=this.previous();else throw this.error(this.peek(),"Expected table name.");return{type:"identifier",name:r,schema:n,loc:K(t,s)}}tableSourceList(){let t=[];do{let n=this.tableSource();for(;this.isJoinToken();)n=this.joinClause(n);t.push(n)}while(this.match(m.COMMA));return t}tableSource(){let t=this.peek();return this.check(m.IDENTIFIER)&&this.checkNext(1,m.LPAREN)?this.functionSource(t):this.standardTableSource(t)}standardTableSource(t){let n=this.tableIdentifier(),r=this.previous(),s;if(this.match(m.AS)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected alias after 'AS'.");let o=this.advance();s=o.lexeme,r=o}else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isJoinToken()&&!this.isEndOfClause()){let o=this.advance();s=o.lexeme,r=o}return{type:"table",table:n,alias:s,loc:K(t,r)}}functionSource(t){let n=this.tableIdentifier(),r=this.previous();this.consume(m.LPAREN,"Expected '(' after table function name.");let s=[],o=this.previous();if(!this.check(m.RPAREN))do s.push(this.expression()),o=this.previous();while(this.match(m.COMMA));r=this.consume(m.RPAREN,"Expected ')' after table function arguments.");let a;if(this.match(m.AS)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected alias after 'AS'.");let i=this.advance();a=i.lexeme,r=i}else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isJoinToken()&&!this.isEndOfClause()){let i=this.advance();a=i.lexeme,r=i}return{type:"functionSource",name:n,args:s,alias:a,loc:K(t,r)}}joinClause(t){let n=this.peek(),r="inner";this.match(m.LEFT)?(this.match(m.OUTER),r="left"):this.match(m.RIGHT)?(this.match(m.OUTER),r="right"):this.match(m.FULL)?(this.match(m.OUTER),r="full"):this.match(m.CROSS)?r="cross":this.match(m.INNER)&&(r="inner"),this.consume(m.JOIN,"Expected 'JOIN'.");let s=this.tableSource(),o,a,i=this.previous();if(this.match(m.ON))o=this.expression(),i=this.previous();else if(this.match(m.USING)){this.consume(m.LPAREN,"Expected '(' after 'USING'."),a=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name.");a.push(this.advance().lexeme)}while(this.match(m.COMMA));i=this.consume(m.RPAREN,"Expected ')' after columns.")}else if(r!=="cross")throw this.error(this.peek(),"Expected 'ON' or 'USING' after JOIN.");return{type:"join",joinType:r,left:t,right:s,condition:o,columns:a,loc:K(n,i)}}expression(){return this.logicalOr()}logicalOr(){let t=this.logicalAnd();for(;this.match(m.OR);){let n="OR",r=this.logicalAnd();t={type:"binary",operator:n,left:t,right:r,loc:K(this.peek(),this.previous())}}return t}logicalAnd(){let t=this.equality();for(;this.match(m.AND);){let n="AND",r=this.equality();t={type:"binary",operator:n,left:t,right:r,loc:K(this.peek(),this.previous())}}return t}equality(){let t=this.comparison();for(;this.match(m.EQUAL,m.EQUAL_EQUAL,m.NOT_EQUAL);){let n=this.previous().type===m.NOT_EQUAL?"!=":"=",r=this.comparison();t={type:"binary",operator:n,left:t,right:r,loc:K(this.peek(),this.previous())}}return t}comparison(){let t=this.term();for(;this.match(m.LESS,m.LESS_EQUAL,m.GREATER,m.GREATER_EQUAL);){let n;switch(this.previous().type){case m.LESS:n="<";break;case m.LESS_EQUAL:n="<=";break;case m.GREATER:n=">";break;case m.GREATER_EQUAL:n=">=";break;default:n="?"}let r=this.term();t={type:"binary",operator:n,left:t,right:r,loc:K(this.peek(),this.previous())}}return t}term(){let t=this.factor();for(;this.match(m.PLUS,m.MINUS);){let n=this.previous().type===m.PLUS?"+":"-",r=this.factor();t={type:"binary",operator:n,left:t,right:r,loc:K(this.peek(),this.previous())}}return t}factor(){if(this.match(m.MINUS,m.PLUS,m.TILDE)){let r=this.previous().lexeme,s=this.factor();return{type:"unary",operator:r,expr:s,loc:K(this.peek(),this.previous())}}let t=this.collateExpression();for(;this.match(m.ASTERISK,m.SLASH,m.PERCENT);){let r=this.previous().lexeme,s=this.collateExpression();t={type:"binary",operator:r,left:t,right:s,loc:K(this.peek(),this.previous())}}return t}primary(){let t=this.peek();if(this.match(m.INTEGER,m.FLOAT,m.STRING,m.NULL,m.BLOB)){let n=this.previous(),r=n.literal;return n.type===m.NULL&&(r=null),{type:"literal",value:r,loc:K(t,n)}}if(this.match(m.QUESTION)){let n=this.previous();return{type:"parameter",index:this.parameterPosition++,loc:K(t,n)}}if(this.match(m.COLON,m.DOLLAR)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected identifier after parameter prefix.");let n=this.advance();return{type:"parameter",name:n.lexeme,loc:K(t,n)}}if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.LPAREN)){let n=this.advance().lexeme;this.consume(m.LPAREN,"Expected '(' after function name.");let r=[];if(!this.check(m.RPAREN))do this.match(m.ASTERISK)?r.push({type:"literal",value:"*"}):r.push(this.expression());while(this.match(m.COMMA));let s=this.consume(m.RPAREN,"Expected ')' after function arguments."),o={type:"function",name:n,args:r,loc:K(t,s)};if(this.matchKeyword("OVER")){let a=this.parseWindowSpecification(),i=this.previous();return{type:"windowFunction",function:o,window:a,loc:K(t,i)}}return o}if(this.check(m.IDENTIFIER))if(this.checkNext(1,m.DOT)&&this.checkNext(2,m.IDENTIFIER)&&this.checkNext(3,m.DOT)&&this.checkNext(4,m.IDENTIFIER)){let n=this.advance().lexeme;this.advance();let r=this.advance().lexeme;this.advance();let s=this.advance();return{type:"column",name:s.lexeme,table:r,schema:n,loc:K(t,s)}}else if(this.checkNext(1,m.DOT)&&this.checkNext(2,m.IDENTIFIER)){let n=this.advance().lexeme;this.advance();let r=this.advance();return{type:"column",name:r.lexeme,table:n,loc:K(t,r)}}else{let n=this.advance();return{type:"column",name:n.lexeme,loc:K(t,n)}}if(this.match(m.LPAREN)){let n=this.expression();return this.consume(m.RPAREN,"Expected ')' after expression."),n}throw this.error(this.peek(),"Expected expression.")}parseWindowSpecification(){if(this.match(m.LPAREN)){let t,n,r;if(this.matchKeyword("PARTITION")){this.consumeKeyword("BY","Expected 'BY' after 'PARTITION'."),t=[];do t.push(this.expression());while(this.match(m.COMMA))}if(this.matchKeyword("ORDER")){this.consumeKeyword("BY","Expected 'BY' after 'ORDER'."),n=[];do{let s=this.expression(),o=this.match(m.DESC)?"desc":(this.match(m.ASC),"asc");n.push({expr:s,direction:o})}while(this.match(m.COMMA))}if(this.matchKeyword("ROWS")||this.matchKeyword("RANGE")){let s=this.previous().lexeme.toLowerCase(),o=this.parseWindowFrameBound(),a=null;this.matchKeyword("AND")&&(a=this.parseWindowFrameBound()),r={type:s,start:o,end:a}}return this.consume(m.RPAREN,"Expected ')' after window specification."),{type:"windowDefinition",partitionBy:t,orderBy:n,frame:r}}else throw this.error(this.peek(),"Window name references are not yet supported. Use explicit window specs.")}parseWindowFrameBound(){if(this.matchKeyword("UNBOUNDED")){if(this.matchKeyword("PRECEDING"))return{type:"unboundedPreceding"};if(this.matchKeyword("FOLLOWING"))return{type:"unboundedFollowing"};throw this.error(this.peek(),"Expected PRECEDING or FOLLOWING after UNBOUNDED.")}else{if(this.matchKeyword("CURRENT"))return this.consumeKeyword("ROW","Expected 'ROW' after 'CURRENT'."),{type:"currentRow"};{let t=this.expression();if(this.matchKeyword("PRECEDING"))return{type:"preceding",value:t};if(this.matchKeyword("FOLLOWING"))return{type:"following",value:t};throw this.error(this.peek(),"Expected PRECEDING or FOLLOWING after frame value.")}}}match(...t){for(let n of t)if(this.check(n))return this.advance(),!0;return!1}consume(t,n){if(this.check(t))return this.advance();throw this.error(this.peek(),n)}check(t){return this.isAtEnd()?!1:this.peek().type===t}checkNext(t,n){return this.current+t>=this.tokens.length?!1:this.tokens[this.current+t].type===n}advance(){return this.isAtEnd()||this.current++,this.previous()}isAtEnd(){return this.peek().type===m.EOF}peek(){return this.tokens[this.current]}previous(){return this.tokens[this.current-1]}error(t,n){let r=` at line ${t.startLine}, column ${t.startColumn}`;return new St(t,n+r)}isJoinToken(){return this.check(m.JOIN)||this.check(m.INNER)||this.check(m.LEFT)||this.check(m.RIGHT)||this.check(m.FULL)||this.check(m.CROSS)}isEndOfClause(){let t=this.peek().type;return t===m.FROM||t===m.WHERE||t===m.GROUP||t===m.HAVING||t===m.ORDER||t===m.LIMIT||t===m.UNION||t===m.SEMICOLON||t===m.EOF}updateStatement(t){let n=this.tableIdentifier();this.consume(m.SET,"Expected 'SET' after table name in UPDATE.");let r=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name in SET clause.");let a=this.advance().lexeme;this.consume(m.EQUAL,"Expected '=' after column name in SET clause.");let i=this.expression();r.push({column:a,value:i})}while(this.match(m.COMMA));let s;this.match(m.WHERE)&&(s=this.expression());let o=this.previous();return{type:"update",table:n,assignments:r,where:s,loc:K(t,o)}}deleteStatement(t){this.matchKeyword("FROM");let n=this.tableIdentifier(),r;this.match(m.WHERE)&&(r=this.expression());let s=this.previous();return{type:"delete",table:n,where:r,loc:K(t,s)}}createStatement(t){if(this.peekKeyword("TABLE"))return this.consumeKeyword("TABLE","Expected 'TABLE' after CREATE."),this.createTableStatement(t);if(this.peekKeyword("INDEX"))return this.consumeKeyword("INDEX","Expected 'INDEX' after CREATE."),this.createIndexStatement(t);if(this.peekKeyword("VIEW"))return this.consumeKeyword("VIEW","Expected 'VIEW' after CREATE."),this.createViewStatement(t);if(this.peekKeyword("UNIQUE"))return this.consumeKeyword("UNIQUE","Expected 'UNIQUE' after CREATE."),this.consumeKeyword("INDEX","Expected 'INDEX' after CREATE UNIQUE."),this.createIndexStatement(t,!0);throw this.error(this.peek(),"Expected TABLE, [UNIQUE] INDEX, VIEW, or VIRTUAL after CREATE.")}createTableStatement(t){let n=!1;(this.peekKeyword("TEMP")||this.peekKeyword("TEMPORARY"))&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier(),o=[],a=[],i=!1;if(this.check(m.LPAREN)){this.consume(m.LPAREN,"Expected '(' to start table definition.");do this.peekKeyword("PRIMARY")||this.peekKeyword("UNIQUE")||this.peekKeyword("CHECK")||this.peekKeyword("FOREIGN")||this.peekKeyword("CONSTRAINT")?a.push(this.tableConstraint()):o.push(this.columnDefinition());while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after table definition."),this.matchKeyword("WITHOUT")&&(this.consumeKeyword("ROWID","Expected 'ROWID' after 'WITHOUT'."),i=!0)}else if(this.matchKeyword("AS")){let c=this.selectStatement();throw new Error("CREATE TABLE AS SELECT is not fully implemented.")}else throw this.error(this.peek(),"Expected '(' or 'AS' after table name.");return{type:"createTable",table:s,ifNotExists:r,columns:o,constraints:a,withoutRowid:i,isTemporary:n,loc:K(t,this.previous())}}createIndexStatement(t,n=!1){!n&&this.peekKeyword("UNIQUE")&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier();this.consumeKeyword("ON","Expected 'ON' after index name.");let o=this.tableIdentifier();this.consume(m.LPAREN,"Expected '(' before indexed columns.");let a=this.indexedColumnList();this.consume(m.RPAREN,"Expected ')' after indexed columns.");let i;return this.matchKeyword("WHERE")&&(i=this.expression()),{type:"createIndex",index:s,table:o,ifNotExists:r,columns:a,where:i,isUnique:n,loc:K(t,this.previous())}}createViewStatement(t){let n=!1;(this.peekKeyword("TEMP")||this.peekKeyword("TEMPORARY"))&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier(),o;if(this.check(m.LPAREN)){if(this.consume(m.LPAREN,"Expected '(' to start view column list."),o=[],!this.check(m.RPAREN))do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name in view column list.");o.push(this.advance().lexeme)}while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after view column list.")}this.consumeKeyword("AS","Expected 'AS' before SELECT statement for CREATE VIEW.");let a=this.selectStatement();return{type:"createView",view:s,ifNotExists:r,columns:o,select:a,isTemporary:n,loc:K(t,this.previous())}}dropStatement(t){let n;if(this.peekKeyword("TABLE"))this.consumeKeyword("TABLE","Expected TABLE after DROP."),n="table";else if(this.peekKeyword("VIEW"))this.consumeKeyword("VIEW","Expected VIEW after DROP."),n="view";else if(this.peekKeyword("INDEX"))this.consumeKeyword("INDEX","Expected INDEX after DROP."),n="index";else throw this.error(this.peek(),"Expected TABLE, VIEW, or INDEX after DROP.");let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF'."),r=!0);let s=this.tableIdentifier();return{type:"drop",objectType:n,name:s,ifExists:r,loc:K(t,this.previous())}}alterTableStatement(t){this.consumeKeyword("TABLE","Expected 'TABLE' after ALTER.");let n=this.tableIdentifier(),r;if(this.peekKeyword("RENAME"))if(this.consumeKeyword("RENAME","Expected RENAME."),this.matchKeyword("COLUMN")){let s=this.consumeIdentifier("Expected old column name after RENAME COLUMN.");this.consumeKeyword("TO","Expected 'TO' after old column name.");let o=this.consumeIdentifier("Expected new column name after TO.");r={type:"renameColumn",oldName:s,newName:o}}else this.consumeKeyword("TO","Expected 'TO' after RENAME."),r={type:"renameTable",newName:this.consumeIdentifier("Expected new table name after RENAME TO.")};else if(this.peekKeyword("ADD"))this.consumeKeyword("ADD","Expected ADD."),this.matchKeyword("COLUMN"),r={type:"addColumn",column:this.columnDefinition()};else if(this.peekKeyword("DROP"))this.consumeKeyword("DROP","Expected DROP."),this.matchKeyword("COLUMN"),r={type:"dropColumn",name:this.consumeIdentifier("Expected column name after DROP COLUMN.")};else throw this.error(this.peek(),"Expected RENAME, ADD, or DROP after table name in ALTER TABLE.");return{type:"alterTable",table:n,action:r,loc:K(t,this.previous())}}beginStatement(t){let n;return this.peekKeyword("DEFERRED")?(this.advance(),n="deferred"):this.peekKeyword("IMMEDIATE")?(this.advance(),n="immediate"):this.peekKeyword("EXCLUSIVE")&&(this.advance(),n="exclusive"),this.matchKeyword("TRANSACTION"),{type:"begin",mode:n,loc:K(t,this.previous())}}commitStatement(t){return this.matchKeyword("TRANSACTION"),{type:"commit",loc:K(t,this.previous())}}rollbackStatement(t){this.matchKeyword("TRANSACTION");let n;if(this.matchKeyword("TO")){if(this.matchKeyword("SAVEPOINT"),!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected savepoint name after ROLLBACK TO.");n=this.advance().lexeme}return{type:"rollback",savepoint:n,loc:K(t,this.previous())}}savepointStatement(t){return{type:"savepoint",name:this.consumeIdentifier("Expected savepoint name after SAVEPOINT."),loc:K(t,this.previous())}}releaseStatement(t){return this.matchKeyword("SAVEPOINT"),{type:"release",savepoint:this.consumeIdentifier("Expected savepoint name after RELEASE [SAVEPOINT]."),loc:K(t,this.previous())}}pragmaStatement(t){let n=this.consumeIdentifier("Expected pragma name."),r;if(this.match(m.EQUAL))if(this.check(m.IDENTIFIER))r={type:"identifier",name:this.advance().lexeme};else if(this.match(m.STRING,m.INTEGER,m.FLOAT,m.NULL)){let s=this.previous();r={type:"literal",value:s.type===m.NULL?null:s.literal}}else if(this.match(m.MINUS))if(this.check(m.INTEGER)||this.check(m.FLOAT))r={type:"literal",value:-this.advance().literal};else throw this.error(this.peek(),"Expected number after '-'.");else throw this.error(this.peek(),"Expected pragma value (identifier, string, number, or NULL).");else throw this.error(this.peek(),"Expected '=' after pragma name.");return{type:"pragma",name:n.toLowerCase(),value:r,loc:K(t,this.previous())}}indexedColumnList(){let t=[];do t.push(this.indexedColumn());while(this.match(m.COMMA));return t}indexedColumn(){let t=this.expression(),n;t.type==="column"&&!t.table&&!t.schema&&(n=t.name);let r;return this.match(m.ASC)?r="asc":this.match(m.DESC)&&(r="desc"),n?{name:n,direction:r}:{expr:t,direction:r}}consumeIdentifier(t){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),t);return this.advance().lexeme}columnDefinition(){let t=this.consumeIdentifier("Expected column name."),n;if(this.check(m.IDENTIFIER)&&(n=this.advance().lexeme,this.match(m.LPAREN))){n+="(";let s=1;for(;s>0&&!this.isAtEnd();){let o=this.peek();o.type===m.LPAREN&&s++,o.type===m.RPAREN&&s--,s>0&&(n+=this.advance().lexeme)}n+=")",this.consume(m.RPAREN,"Expected ')' after type parameters.")}let r=this.columnConstraintList();return{name:t,dataType:n,constraints:r}}columnConstraintList(){let t=[];for(;this.isColumnConstraintStart();)t.push(this.columnConstraint());return t}isColumnConstraintStart(){return this.check(m.CONSTRAINT)||this.check(m.PRIMARY)||this.check(m.NOT)||this.check(m.UNIQUE)||this.check(m.CHECK)||this.check(m.DEFAULT)||this.check(m.COLLATE)||this.check(m.REFERENCES)||this.check(m.GENERATED)}columnConstraint(){let t,n=this.peek(),r=n;if(this.match(m.CONSTRAINT)&&(t=this.consumeIdentifier("Expected constraint name after CONSTRAINT."),r=this.previous()),this.match(m.PRIMARY)){this.consume(m.KEY,"Expected KEY after PRIMARY.");let s=this.match(m.ASC)?"asc":this.match(m.DESC)?"desc":void 0;s&&(r=this.previous());let o=this.parseConflictClause();o&&(r=this.previous());let a=this.match(m.AUTOINCREMENT);return a&&(r=this.previous()),{type:"primaryKey",name:t,onConflict:o,autoincrement:a,direction:s,loc:K(n,r)}}else if(this.match(m.NOT)){this.consume(m.NULL,"Expected NULL after NOT."),r=this.previous();let s=this.parseConflictClause();return s&&(r=this.previous()),{type:"notNull",name:t,onConflict:s,loc:K(n,r)}}else if(this.match(m.UNIQUE)){r=this.previous();let s=this.parseConflictClause();return s&&(r=this.previous()),{type:"unique",name:t,onConflict:s,loc:K(n,r)}}else if(this.match(m.CHECK)){this.consume(m.LPAREN,"Expected '(' after CHECK.");let s=this.expression();return r=this.consume(m.RPAREN,"Expected ')' after CHECK expression."),{type:"check",name:t,expr:s,loc:K(n,r)}}else if(this.match(m.DEFAULT)){let s=this.expression();return r=this.previous(),{type:"default",name:t,expr:s,loc:K(n,r)}}else if(this.match(m.COLLATE)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected collation name after COLLATE.");let s=this.advance().lexeme;return r=this.previous(),{type:"collate",name:t,collation:s,loc:K(n,r)}}else if(this.match(m.REFERENCES)){let s=this.foreignKeyClause();return r=this.previous(),{type:"foreignKey",name:t,foreignKey:s,loc:K(n,r)}}else if(this.match(m.GENERATED)){this.consume(m.ALWAYS,"Expected ALWAYS after GENERATED."),this.consume(m.AS,"Expected AS after GENERATED ALWAYS."),this.consume(m.LPAREN,"Expected '(' after AS.");let s=this.expression();this.consume(m.RPAREN,"Expected ')' after generated expression."),r=this.previous();let o=!1;return this.match(m.STORED)?(o=!0,r=this.previous()):this.match(m.VIRTUAL)&&(r=this.previous()),{type:"generated",name:t,generated:{expr:s,stored:o},loc:K(n,r)}}throw this.error(this.peek(),"Expected column constraint type (PRIMARY KEY, NOT NULL, UNIQUE, CHECK, DEFAULT, COLLATE, REFERENCES, GENERATED).")}tableConstraint(){let t;if(this.match(m.CONSTRAINT)&&(t=this.consumeIdentifier("Expected constraint name after CONSTRAINT.")),this.match(m.PRIMARY)){this.consume(m.KEY,"Expected KEY after PRIMARY."),this.consume(m.LPAREN,"Expected '(' before PRIMARY KEY columns.");let n=this.identifierListWithDirection();this.consume(m.RPAREN,"Expected ')' after PRIMARY KEY columns.");let r=this.parseConflictClause();return{type:"primaryKey",name:t,columns:n,onConflict:r}}else if(this.match(m.UNIQUE)){this.consume(m.LPAREN,"Expected '(' before UNIQUE columns.");let r=this.identifierList().map(o=>({name:o}));this.consume(m.RPAREN,"Expected ')' after UNIQUE columns.");let s=this.parseConflictClause();return{type:"unique",name:t,columns:r,onConflict:s}}else if(this.match(m.CHECK)){this.consume(m.LPAREN,"Expected '(' after CHECK.");let n=this.expression();return this.consume(m.RPAREN,"Expected ')' after CHECK expression."),{type:"check",name:t,expr:n}}else if(this.match(m.FOREIGN)){this.consume(m.KEY,"Expected KEY after FOREIGN."),this.consume(m.LPAREN,"Expected '(' before FOREIGN KEY columns.");let n=this.identifierList().map(s=>({name:s}));this.consume(m.RPAREN,"Expected ')' after FOREIGN KEY columns.");let r=this.foreignKeyClause();return{type:"foreignKey",name:t,columns:n,foreignKey:r}}throw this.error(this.peek(),"Expected table constraint type (PRIMARY KEY, UNIQUE, CHECK, FOREIGN KEY).")}foreignKeyClause(){this.consume(m.REFERENCES,"Expected REFERENCES for foreign key.");let t=this.consumeIdentifier("Expected foreign table name."),n;this.match(m.LPAREN)&&(n=this.identifierList(),this.consume(m.RPAREN,"Expected ')' after foreign columns."));let r,s,o,a;for(;this.check(m.ON)||this.check(m.DEFERRABLE)||this.check(m.NOT);)if(this.match(m.ON))if(this.match(m.DELETE))r=this.parseForeignKeyAction();else if(this.match(m.UPDATE))s=this.parseForeignKeyAction();else throw this.error(this.peek(),"Expected DELETE or UPDATE after ON.");else if(this.match(m.DEFERRABLE)){if(o=!0,this.match(m.INITIALLY))if(this.match(m.DEFERRED))a=!0;else if(this.match(m.IMMEDIATE))a=!1;else throw this.error(this.peek(),"Expected DEFERRED or IMMEDIATE after INITIALLY.")}else if(this.match(m.NOT)){if(this.consume(m.DEFERRABLE,"Expected DEFERRABLE after NOT."),o=!1,this.match(m.INITIALLY))if(this.match(m.DEFERRED))a=!0;else if(this.match(m.IMMEDIATE))a=!1;else throw this.error(this.peek(),"Expected DEFERRED or IMMEDIATE after INITIALLY.")}else break;return{table:t,columns:n,onDelete:r,onUpdate:s,deferrable:o,initiallyDeferred:a}}parseConflictClause(){if(this.match(m.ON)){if(this.consume(m.CONFLICT,"Expected CONFLICT after ON."),this.match(m.ROLLBACK))return oe.ROLLBACK;if(this.match(m.ABORT))return oe.ABORT;if(this.match(m.FAIL))return oe.FAIL;if(this.match(m.IGNORE))return oe.IGNORE;if(this.match(m.REPLACE))return oe.REPLACE;throw this.error(this.peek(),"Expected conflict resolution algorithm (ROLLBACK, ABORT, FAIL, IGNORE, REPLACE).")}}parseForeignKeyAction(){if(this.match(m.SET)){if(this.match(m.NULL))return"setNull";if(this.match(m.DEFAULT))return"setDefault";throw this.error(this.peek(),"Expected NULL or DEFAULT after SET.")}else{if(this.match(m.CASCADE))return"cascade";if(this.match(m.RESTRICT))return"restrict";if(this.match(m.NO))return this.consume(m.ACTION,"Expected ACTION after NO."),"noAction"}throw this.error(this.peek(),"Expected foreign key action (SET NULL, SET DEFAULT, CASCADE, RESTRICT, NO ACTION).")}identifierList(){let t=[];do t.push(this.consumeIdentifier("Expected identifier in list."));while(this.match(m.COMMA));return t}identifierListWithDirection(){let t=[];do{let n=this.consumeIdentifier("Expected identifier in list."),r=this.match(m.ASC)?"asc":this.match(m.DESC)?"desc":void 0;t.push({name:n,direction:r})}while(this.match(m.COMMA));return t}peekKeyword(t){if(this.isAtEnd())return!1;let n=this.peek();return n.type===m.IDENTIFIER&&n.lexeme.toUpperCase()===t||n.type===m[t.toUpperCase()]}matchKeyword(t){return this.isAtEnd()?!1:this.peekKeyword(t)?(this.advance(),!0):!1}consumeKeyword(t,n){if(this.peekKeyword(t))return this.advance();throw this.error(this.peek(),n)}collateExpression(){let t=this.primary();if(this.match(m.COLLATE)){let n=this.previous(),r=this.consumeIdentifier("Expected collation name after COLLATE.");t={type:"collate",expr:t,collation:r,loc:K(this.peek(),this.previous())}}return t}};function xn(e,t=0,n=0,r=0,s=null,o=0,a){return{opcode:e,p1:t,p2:n,p3:r,p4:s,p5:o,comment:a}}function xl(e,t){let r=e.currentFrameLocals<2?2:e.currentFrameLocals+1,s=r+t-1;e.currentFrameLocals=Math.max(e.currentFrameLocals,s),e.maxLocalOffsetInCurrentFrame=Math.max(e.maxLocalOffsetInCurrentFrame,s);let o=e.framePointer+s;return e.numMemCells=Math.max(e.numMemCells,o),r}function Ll(e){let t=e.numCursors;return e.numCursors++,t}function Ol(e,t){let n=e.constants.length;return e.constants.push(t),n}function Ml(e,t,n=0,r=0,s=0,o=null,a=0,i){let c=e.subroutineDepth>0?e.subroutineCode:e.instructions,f=xn(t,n,r,s,o,a,i);return c.push(f),c.length-1}function Dl(e){return-((e.subroutineDepth>0?e.subroutineCode:e.instructions).length+1)}function Pl(e,t){if(t>=0){console.warn(`Attempting to resolve a non-placeholder address: ${t}`);return}let n=e.subroutineDepth>0?e.subroutineCode:e.instructions,r=n.length,s=-(t+1);if(s<0||s>=n.length){console.warn(`Placeholder address ${t} corresponds to invalid index ${s} in current code block.`);return}let o=n[s],a={[u.Goto]:"p2",[u.IfTrue]:"p2",[u.IfFalse]:"p2",[u.IfZero]:"p2",[u.IfNull]:"p2",[u.IfNotNull]:"p2",[u.Eq]:"p2",[u.Ne]:"p2",[u.Lt]:"p2",[u.Le]:"p2",[u.Gt]:"p2",[u.Ge]:"p2",[u.Once]:"p2",[u.VFilter]:"p2",[u.VNext]:"p2",[u.Rewind]:"p2",[u.Subroutine]:"p2"},i=o.opcode;if(i in a){let c=a[i];c&&o[c]===t?o[c]=r:console.warn(`Instruction at index ${s} (${u[o.opcode]}) does not match placeholder ${t} for its expected address parameter (${c||"none"}).`)}else console.warn(`Opcode ${u[o.opcode]} not configured for address resolution.`)}function kl(e){return(e.subroutineDepth>0?e.subroutineCode:e.instructions).length}function Te(e){return{name:e,affinity:A.TEXT,notNull:!1,primaryKey:!1,pkOrder:0,defaultValue:null,collation:"BINARY",hidden:!1,generated:!1}}function Oe(e){let t=new Map;return e.forEach((n,r)=>{t.set(n.name.toLowerCase(),r)}),t}function Fl(e){let t=e.map((n,r)=>({...n,index:r})).filter(n=>n.primaryKey).sort((n,r)=>n.pkOrder-r.pkOrder);return Object.freeze(t.map(n=>({index:n.index,desc:!1})))}function $l(e,t,n,r){let s=Array.from({length:n},(i,c)=>Te(`eph_col${c}`)),o=[];r&&(r.keyIndices.forEach((i,c)=>{i>=0&&i<s.length&&r.collations?.[c]&&(s[i].collation=r.collations[c])}),o=Object.freeze(r.keyIndices.map((i,c)=>({index:i,desc:r.directions[c]}))),o.forEach(i=>{i.index>=0&&i.index<s.length&&(s[i.index].primaryKey=!0)}));let a={name:`ephemeral_${t}`,schemaName:"temp",columns:Object.freeze(s),columnIndexMap:Object.freeze(Oe(s)),primaryKeyDefinition:o,isVirtual:!0};return e.tableSchemas.set(t,a),e.ephemeralTables.set(t,a),a}function Ul(e,t){t.forEach(n=>{e.emit(u.Close,n,0,0,null,0,`Close inner cursor ${n}`),e.tableSchemas.delete(n),e.ephemeralTables.delete(n),e.cursorPlanningInfo.delete(n);for(let[r,s]of e.tableAliases.entries())if(s===n){e.tableAliases.delete(r);break}})}var nm=e=>/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e),rm=new Set(["ABORT","ACTION","ADD","AFTER","ALL","ALTER","ANALYZE","AND","AS","ASC","ATTACH","AUTOINCREMENT","BEFORE","BEGIN","BETWEEN","BY","CASCADE","CASE","CAST","CHECK","COLLATE","COLUMN","COMMIT","CONFLICT","CONSTRAINT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","DATABASE","DEFAULT","DEFERRABLE","DEFERRED","DELETE","DESC","DETACH","DISTINCT","DROP","EACH","ELSE","END","ESCAPE","EXCEPT","EXCLUSIVE","EXISTS","EXPLAIN","FAIL","FOR","FOREIGN","FROM","FULL","GLOB","GROUP","HAVING","IF","IGNORE","IMMEDIATE","IN","INDEX","INDEXED","INITIALLY","INNER","INSERT","INSTEAD","INTERSECT","INTO","IS","ISNULL","JOIN","KEY","LEFT","LIKE","LIMIT","MATCH","NATURAL","NO","NOT","NOTNULL","NULL","OF","OFFSET","ON","OR","ORDER","OUTER","PLAN","PRAGMA","PRIMARY","QUERY","RAISE","RECURSIVE","REFERENCES","REGEXP","REINDEX","RELEASE","RENAME","REPLACE","RESTRICT","RIGHT","ROLLBACK","ROW","SAVEPOINT","SELECT","SET","TABLE","TEMP","TEMPORARY","THEN","TO","TRANSACTION","TRIGGER","UNION","UNIQUE","UPDATE","USING","VACUUM","VALUES","VIEW","VIRTUAL","WHEN","WHERE","WITH","WITHOUT"].map(e=>e.toUpperCase()));function ss(e){return rm.has(e.toUpperCase())||!nm(e)?`"${e.replace(/"/g,'""')}"`:e}function Re(e){switch(e.type){case"literal":return e.value===null?"null":typeof e.value=="string"?`'${e.value.replace(/'/g,"''")}'`:String(e.value);case"identifier":return ss(e.name);case"column":let t=ss(e.name);return e.table&&(t=`${ss(e.table)}.${t}`,e.schema&&(t=`${ss(e.schema)}.${t}`)),t;case"binary":return`(${Re(e.left)} ${e.operator} ${Re(e.right)})`;case"unary":return`${e.operator} (${Re(e.expr)})`;default:return"?"}}function Bl(e,t){let n=e.db,r=t.table.schema||"main",s=t.table.name,o,a=[],i=!1;if(t.moduleName)o=t.moduleName,a=t.moduleArgs||[],i=!0;else{let h=n.getDefaultVtabModule();o=h.name,a=[...h.args]}let c=n._getVtabModule(o);if(!c)throw new R(`No virtual table module named '${o}'`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let f;try{if(o.toLowerCase()==="memory"){let h,p;if(i){if(a.length===0||!a[0].trim().toUpperCase().startsWith("CREATE TABLE"))throw new Error("When using 'USING memory(...)', the first argument must be the CREATE TABLE DDL string.");let g=a[0],w=new ze().parse(g);if(w.type!=="createTable")throw new Error("Argument provided to 'USING memory(...)' did not parse as a CREATE TABLE statement.");let y=w;h=y.columns.map(N=>({name:N.name,type:as(N.dataType)})),p=os(y.columns,y.constraints)}else{if(!t.columns||t.columns.length===0)throw new Error("Cannot create implicit memory table without column definitions.");h=t.columns.map(g=>({name:g.name,type:as(g.dataType)})),p=os(t.columns,t.constraints||[])}f={columns:Object.freeze(h),primaryKey:p,readOnly:!1}}else if(o.toLowerCase()==="json_each"||o.toLowerCase()==="json_tree"){if(a.length<1||a.length>2)throw new Error(`${o} requires 1 or 2 arguments (jsonSource, [rootPath])`);f={jsonSource:a[0],rootPath:a[1]}}else console.warn(`Compiler creating generic BaseModuleConfig for module '${o}'. Module may need specific argument parsing.`),f={}}catch(h){throw new R(`Failed to parse arguments for module '${o}': ${h.message}`,I.ERROR,h instanceof Error?h:void 0,t.loc?.start.line,t.loc?.start.column)}let d;try{d=c.module.xCreate(n,c.auxData,o,r,s,f)}catch(h){let p=h instanceof Error?h.message:String(h),g=h instanceof R?h.code:I.ERROR;throw new R(`Module '${o}' xCreate failed for table '${s}': ${p}`,g,h instanceof Error?h:void 0,t.loc?.start.line,t.loc?.start.column)}let l=n.schemaManager.getSchema(r);if(!l)throw new R(`Internal error: Schema '${r}' not found during CREATE TABLE.`,I.INTERNAL);if(l.getTable(s))if(t.ifNotExists){console.log(`Skipping CREATE TABLE: Table ${r}.${s} already exists (IF NOT EXISTS).`),e.emit(u.Noop,0,0,0,null,0,`CREATE TABLE ${s} (skipped IF NOT EXISTS)`);return}else throw new R(`Table ${r}.${s} already exists`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!d.tableSchema)throw new R(`Module '${o}' xCreate did not provide a tableSchema for '${s}'.`,I.INTERNAL);d.tableSchema.schemaName.toLowerCase()!==r.toLowerCase()&&(console.warn(`VTab module ${o} created table ${s} in schema ${d.tableSchema.schemaName}, but expected ${r}.`),d.tableSchema.schemaName=r),d.tableSchema.vtabModuleName||(d.tableSchema.vtabModuleName=o),d.tableSchema.vtabArgs||(d.tableSchema.vtabArgs=Object.freeze(a)),l.addTable(d.tableSchema),console.log(`Successfully created table ${r}.${s} using module ${o}`),e.emit(u.Noop,0,0,0,null,0,`CREATE TABLE ${s}`)}function _l(e,t){e.emit(u.Noop,0,0,0,null,0,"CREATE INDEX (no-op in VDBE)")}function Vl(e,t){let n=t.view.schema??e.db.schemaManager.getCurrentSchemaName(),r=t.view.name,s;try{s=e.db.schemaManager.getSchemaOrFail(n)}catch{let c=e.db.schemaManager.getSchema(n);if(!c)throw new R(`Schema '${n}' not found`,I.ERROR);s=c}let o=s.getTable(r)??s.getView(r);if(o)if(t.ifNotExists){e.emit(u.Noop,0,0,0,null,0,`View ${n}.${r} already exists (IF NOT EXISTS)`);return}else{let i="selectAst"in o?"view":"table";throw new R(`cannot create ${i} ${r}: already exists in schema ${s.name}`,I.ERROR)}let a={name:r,schemaName:s.name,sql:e.sql,selectAst:t.select,columns:t.columns?Object.freeze(t.columns):void 0};try{s.addView(a)}catch(i){throw i instanceof R?i:new R(`Error adding view ${r} to schema ${s.name}: ${i.message}`,I.INTERNAL)}e.emit(u.Noop,0,0,0,null,0,`Schema definition for VIEW ${n}.${r}`)}function Kl(e,t){let n=t.name.schema??e.db.schemaManager.getCurrentSchemaName(),r=t.name.name,s=!1,o=t.objectType;try{switch(t.objectType){case"table":s=e.db.schemaManager.dropTable(n,r);break;case"view":s=e.db.schemaManager.dropView(n,r);break;case"index":e.emit(u.Noop,0,0,0,null,0,`DROP INDEX ${n}.${r} (Not fully implemented)`),s=!0,o="index",console.warn("DROP INDEX compilation is a placeholder.");break;default:throw new R(`Unsupported object type for DROP: ${t.objectType}`)}if(!s&&!t.ifExists)throw new R(`no such ${o}: ${r}`,I.ERROR)}catch(i){throw i instanceof R?i:new R(`Error dropping ${o} ${r}: ${i.message}`,I.INTERNAL)}let a=s?`Schema definition drop for ${o.toUpperCase()} ${n}.${r}`:`${o.toUpperCase()} ${n}.${r} did not exist (IF EXISTS)`;e.emit(u.Noop,0,0,0,null,0,a)}function Gl(e,t){e.emit(u.Noop,0,0,0,null,0,"ALTER TABLE (no-op in VDBE)")}function ql(e,t){e.emit(u.VBegin,0,0,0,null,0,`BEGIN ${t.mode||"DEFERRED"}`)}function jl(e,t){e.emit(u.VCommit,0,0,0,null,0,"COMMIT")}function Yl(e,t){let n=e.db,r=t.name,s=t.value,o=a=>a?a.type==="literal"?a.value===null?null:String(a.value):a.type==="identifier"?a.name:null:null;switch(r){case"default_vtab_module":{let a=o(s);if(a===null)throw new R("PRAGMA default_vtab_module requires a string or identifier value.",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);console.log(`Setting default VTab module to: ${a}`),n.setDefaultVtabName(a);break}case"default_vtab_args":{let a=o(s);a===null?(console.log("Clearing default VTab args."),n.setDefaultVtabArgsFromJson("[]")):(console.log(`Setting default VTab args from JSON: ${a}`),n.setDefaultVtabArgsFromJson(a));break}default:console.warn(`Ignoring unrecognized PRAGMA: ${r}`);break}e.emit(u.Noop,0,0,0,null,0,`PRAGMA ${r}`)}function os(e,t){let n=new Map;e.forEach((o,a)=>n.set(o.name.toLowerCase(),a));let r=[],s=!1;if(t){for(let o of t)if(o.type==="primaryKey"&&o.columns){if(s)throw new Error("Multiple primary keys defined");s=!0,r=o.columns.map(a=>{let i=n.get(a.name.toLowerCase());if(i===void 0)throw new Error(`PK column ${a.name} not found`);return{index:i,desc:a.direction==="desc"}});break}}return s||e.forEach((o,a)=>{let i=o.constraints.find(c=>c.type==="primaryKey");if(i){if(s)throw new Error("Multiple primary keys defined (column + table/column)");s=!0,r=[{index:a,desc:i.direction==="desc"}]}}),r.length>0?Object.freeze(r):void 0}function as(e){let t=e?.toUpperCase()||"";return t.includes("INT")?A.INTEGER:t.includes("REAL")||t.includes("FLOAT")||t.includes("DOUBLE")?A.REAL:t.includes("BLOB")?A.BLOB:t.includes("BOOL")?A.INTEGER:A.TEXT}function Wl(e,t){let n=[];if(!t||t.length===0)return n;let r=(s,o)=>{if(s.type==="table"){let a=s.table.name,i=s.table.schema||"main",c=(s.alias||a).toLowerCase(),f=a.toLowerCase(),d=e.cteMap.get(f);if(d){if(d.type==="materialized"){let p=d.cursorIdx;n.push(p);let g=d.schema;if(e.tableSchemas.set(p,g),e.tableAliases.has(c)||o.has(c))throw new R(`Duplicate table name or alias: ${c}`,I.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);e.tableAliases.set(c,p),o.set(c,p),console.log(`FROM: Using materialized CTE '${f}' with cursor ${p} for alias '${c}'`)}else throw new R(`Unsupported CTE type '${d.type}' found for ${f}`,I.INTERNAL);return}let l=e.allocateCursor();n.push(l);let h=e.db._findTable(a,i);if(!h)throw new R(`Table not found: ${i}.${a}`,I.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column);if(e.tableSchemas.set(l,h),e.tableAliases.has(c)||o.has(c))throw new R(`Duplicate table name or alias: ${c}`,I.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);if(e.tableAliases.set(c,l),o.set(c,l),h.isVirtual&&h.vtabInstance){let p={type:"vtab",tableSchema:h};e.emit(u.OpenRead,l,0,0,p,0,`Open VTab ${s.alias||a}`)}else if(h.isVirtual&&!h.vtabInstance){console.warn(`VTab ${a} found but not connected, attempting connect...`);let p=e.db._getVtabModule(h.vtabModuleName??"");if(!p)throw new R(`Module ${h.vtabModuleName} not found for VTab ${a}`,I.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column);let g=h.vtabModuleName??"",E=h.vtabArgs??[],w={};try{if(g.toLowerCase()==="memory")if(E.length>0&&E[0].trim().toUpperCase().startsWith("CREATE TABLE")){let C=E[0],O=new ze().parse(C);if(O.type==="createTable"){let v=O;w={columns:Object.freeze(v.columns.map(x=>({name:x.name,type:as(x.dataType)}))),primaryKey:os(v.columns,v.constraints),readOnly:!1}}else console.warn(`Could not parse stored DDL argument for memory table ${a} during connect.`)}else throw console.warn(`Could not reconstruct schema for memory table ${a} during connect: DDL argument missing or invalid.`),new R(`Cannot connect to memory table ${a}: schema information missing from stored arguments.`);else if(g.toLowerCase()==="json_each"||g.toLowerCase()==="json_tree"){if(E.length<1||E.length>2)throw new Error(`${g} requires 1 or 2 stored arguments (jsonSource, [rootPath])`);w={jsonSource:E[0],rootPath:E[1]}}else w={}}catch(C){throw new R(`Failed to parse stored arguments for module '${g}' on connect: ${C.message}`,I.ERROR,C instanceof Error?C:void 0)}let y=p.module.xConnect(e.db,p.auxData,g,i,a,w),N={...h,vtabInstance:y};e.db.schemaManager.getSchema(i)?.addTable(N),e.tableSchemas.set(l,N);let b={type:"vtab",tableSchema:N};e.emit(u.OpenRead,l,0,0,b,0,`Open VTab ${s.alias||a}`)}else throw new R("Regular tables not supported",I.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column)}else if(s.type==="join")r(s.left,o),r(s.right,o);else if(s.type==="functionSource"){let a=s.name.name,i=e.db._getVtabModule(a);if(!i)throw new R(`Table-valued function or virtual table module not found: ${a}`,I.ERROR,void 0,s.name.loc?.start.line,s.name.loc?.start.column);let c=[];for(let y of s.args){let N=e.allocateMemoryCells(1);if(e.compileExpression(y,N),y.type==="literal")if(y.value===null||typeof y.value=="string")c.push(y.value===null?"":y.value);else throw new R(`Table-valued function arguments must be string literals (or NULL) for ${a}.`,I.ERROR,void 0,y.loc?.start.line,y.loc?.start.column);else throw y.type==="parameter"?new R(`Parameters not supported as arguments to table-valued functions like ${a} yet.`,I.ERROR,void 0,y.loc?.start.line,y.loc?.start.column):new R(`Only literals supported as arguments to table-valued functions like ${a} yet.`,I.ERROR,void 0,y.loc?.start.line,y.loc?.start.column)}let f="main",d=s.alias||a,l=a,h={};try{if(l.toLowerCase()==="json_each"||l.toLowerCase()==="json_tree"){if(c.length<1||c.length>2)throw new Error(`${l} requires 1 or 2 arguments (jsonSource, [rootPath])`);h={jsonSource:c[0],rootPath:c[1]}}else console.warn(`Compiler creating generic BaseModuleConfig for TVF module '${l}'. Module may need specific argument parsing.`),h={}}catch(y){throw new R(`Failed to parse arguments for TVF module '${l}': ${y.message}`,I.ERROR,y instanceof Error?y:void 0,s.name.loc?.start.line,s.name.loc?.start.column)}let p=i.module.xConnect(e.db,i.auxData,l,f,d,h);if(!p||!p.tableSchema)throw new R(`Module ${a} xConnect did not return a valid table instance or schema.`,I.INTERNAL);let g=e.allocateCursor();n.push(g),e.tableSchemas.set(g,p.tableSchema);let E=(s.alias||a).toLowerCase();if(e.tableAliases.has(E)||o.has(E))throw new R(`Duplicate table name or alias: ${E}`,I.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);e.tableAliases.set(E,g),o.set(E,g);let w={type:"vtab",tableSchema:p.tableSchema};e.emit(u.OpenRead,g,0,0,w,0,`Open TVF ${E}`)}else throw new R(`Unsupported FROM clause type during cursor opening: ${s.type}`,I.INTERNAL)};for(let s of t)r(s,new Map);return n}function _o(e,t,n){let r=new Map;if(!t)return r;let s=o=>{if(o.type==="column"){let a=o,i=-1;if(a.table)i=e.tableAliases.get(a.table.toLowerCase())??-1;else{let c=!1;for(let f of n)e.tableSchemas.get(f)?.columnIndexMap.has(a.name.toLowerCase())&&(i!==-1&&(c=!0),i=f);if(c)throw new R(`Ambiguous column reference in usage analysis: ${a.name}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}if(n.has(i)){let c=e.tableSchemas.get(i),f=c?.columnIndexMap.get(a.name.toLowerCase());f!==void 0?(r.has(i)||r.set(i,new Set),r.get(i).add(f)):a.name.toLowerCase()==="rowid"&&!c?.isVirtual&&(r.has(i)||r.set(i,new Set),r.get(i).add(-1))}}else o.type==="binary"?(s(o.left),s(o.right)):o.type==="unary"?s(o.expr):o.type==="function"?o.args.forEach(s):o.type==="cast"?s(o.expr):o.type==="subquery"?console.warn("Subquery column usage analysis not implemented for colUsed mask."):o.type==="collate"?s(o.expr):o.type==="identifier"&&s({type:"column",name:o.name,loc:o.loc})};return s(t),r}function am(e,t,n,r,s){let o=BigInt(0),a=new Set(e.tableAliases.values()),i=e.tableSchemas.get(t);if(!i)return o;let c=f=>{f>=0&&f<63?o|=BigInt(1)<<BigInt(f):f===-1&&(o|=BigInt(1)<<BigInt(63))};return n.forEach(f=>{if(f.type==="all"){let d=!1;if(!f.table)d=!0;else{let l=f.table.toLowerCase();e.tableAliases.get(l)===t&&(d=!0)}d&&(i.columns.forEach((l,h)=>{l.hidden||c(h)}),i.isVirtual||c(-1))}else f.expr&&_o(e,f.expr,a).get(t)?.forEach(c)}),r&&_o(e,r,a).get(t)?.forEach(c),s&&s.forEach(f=>{_o(e,f.expr,a).get(t)?.forEach(c)}),i.primaryKeyDefinition?.forEach(f=>{f.index>=0&&f.index<i.columns.length&&c(f.index)}),o}function im(e,t,n,r,s){let o=[],a=new Map,i=new Set,c=d=>{if(d.type==="literal"||d.type==="parameter")return!0;if(d.type==="column"){let l=d,h=-1;if(l.table)h=e.tableAliases.get(l.table.toLowerCase())??-1;else{let p=!1,g=!1,E=!1;n.columnIndexMap.has(l.name.toLowerCase())&&(p=!0,h=t);for(let w of e.tableAliases.values()){if(w===t)continue;e.tableSchemas.get(w)?.columnIndexMap.has(l.name.toLowerCase())&&((p||g)&&(E=!0),h=w,g=!0)}if(E)throw new R(`Ambiguous column in constraint analysis: ${l.name}`,I.ERROR,void 0,d.loc?.start.line,d.loc?.start.column)}return h!==-1&&h!==t}return d.type==="binary"?c(d.left)&&c(d.right):d.type==="unary"?c(d.expr):d.type==="function"?d.args.every(c):d.type==="subquery"?!1:d.type==="cast"||d.type==="collate"?c(d.expr):!1},f=d=>{if(d&&!i.has(d)){if(d.type==="unary"&&(d.operator.toUpperCase()==="IS NULL"||d.operator.toUpperCase()==="IS NOT NULL")){if(d.expr.type==="column"){let l=d.expr,h=l.name.toLowerCase(),p=-1;if(l.table?p=e.tableAliases.get(l.table.toLowerCase())??-1:n.columnIndexMap.has(h)&&(p=t),p===t){let g=n.columnIndexMap.get(h);if(g!==void 0){let E=d.operator.toUpperCase()==="IS NULL"?G.ISNULL:G.ISNOTNULL,w=o.length;o.push({iColumn:g,op:E,usable:!0}),a.set(w,d),i.add(d)}}}return}if(d.type==="binary"){let l=d;if(l.operator.toUpperCase()==="AND"){f(l.left),f(l.right);return}if(l.operator.toUpperCase()==="OR"){console.debug("Skipping OR constraint for xBestIndex planning.");return}if(l.operator.toUpperCase()==="BETWEEN"){if(l.left.type==="column"&&l.right.type==="binary"&&l.right.operator.toUpperCase()==="AND"){let y=l.left,N=l.right.left,b=l.right.right,C={type:"binary",operator:">=",left:y,right:N,loc:l.loc},S={type:"binary",operator:"<=",left:y,right:b,loc:l.loc};f(C),f(S)}else console.warn("Unsupported BETWEEN structure for planning.");return}if(l.operator.toUpperCase()==="IN"){if(l.left.type==="column"&&l.right.type==="function"&&l.right.name==="_list_"){let y=l.left,N=l.right.args,b=-1,C=y.name.toLowerCase();if(y.table?b=e.tableAliases.get(y.table.toLowerCase())??-1:n.columnIndexMap.has(C)&&(b=t),b===t&&N.every(c)){let S=n.columnIndexMap.get(C);S!==void 0&&(N.forEach(O=>{let v=o.length;o.push({iColumn:S,op:G.EQ,usable:!0}),a.set(v,O)}),i.add(l))}}else l.right.type==="subquery"&&console.warn("IN (subquery) constraint skipped for xBestIndex planning.");return}let h,p,g,E=!1,w=-1;if(l.left.type==="column"?(h=l.left,p=l.right,g=is(l.operator),h.table?w=e.tableAliases.get(h.table.toLowerCase())??-1:n.columnIndexMap.has(h.name.toLowerCase())&&(w=t)):l.right.type==="column"&&(h=l.right,p=l.left,E=!0,g=is(l.operator,!0),h.table?w=e.tableAliases.get(h.table.toLowerCase())??-1:n.columnIndexMap.has(h.name.toLowerCase())&&(w=t)),h&&g&&p&&w===t)if(c(p)){let y=n.columnIndexMap.get(h.name.toLowerCase());if(y!==void 0){let N=o.length;o.push({iColumn:y,op:g,usable:!0}),a.set(N,p),i.add(l)}}else console.debug(`Skipping constraint for xBestIndex (value references target table): ${h.name} ${l.operator} ...`);else if(l.left.type==="column"&&l.right.type==="column"){let y=l.left,N=l.right,b=e.tableAliases.get(y.table?.toLowerCase()??"")??(n.columnIndexMap.has(y.name.toLowerCase())?t:-1),C=e.tableAliases.get(N.table?.toLowerCase()??"")??(n.columnIndexMap.has(N.name.toLowerCase())?t:-1),S,O,v;if(b===t&&C!==-1&&C!==t?(S=y,O=N,v=is(l.operator,!1)):C===t&&b!==-1&&b!==t&&(S=N,O=y,v=is(l.operator,!0)),S&&O&&v){let x=n.columnIndexMap.get(S.name.toLowerCase());if(x!==void 0){let L=o.length;o.push({iColumn:x,op:v,usable:!0}),a.set(L,O),i.add(l)}}}}}};return f(r),{constraints:o,constraintExpressions:a,handledNodes:i}}function zl(e,t,n,r,s){if(!n.isVirtual||!n.vtabModule?.xBestIndex||!n.vtabInstance){e.cursorPlanningInfo.set(t,{idxNum:0,idxStr:null,usage:[],cost:1e10,rows:BigInt(1e6),orderByConsumed:!1,constraints:[],constraintExpressions:new Map,handledWhereNodes:new Set});return}let o=r.type==="select"||r.type==="update"||r.type==="delete"?r.where:void 0,a=r.type==="select"?r.orderBy:void 0,i=r.type==="select"?r.columns:[],{constraints:c,constraintExpressions:f,handledNodes:d}=im(e,t,n,o,s),l=[];a&&a.forEach(w=>{if(w.expr.type==="column"){let y=w.expr,N=y.name.toLowerCase(),b=-1;if(y.table)b=e.tableAliases.get(y.table.toLowerCase())??-1;else if(n.columnIndexMap.has(N)){b=t;for(let C of s)if(e.tableSchemas.get(C)?.columnIndexMap.has(N)){b=-1;break}}else for(let C of s)if(e.tableSchemas.get(C)?.columnIndexMap.has(N)){b=C;break}if(b===t){let C=n.columnIndexMap.get(N);C!==void 0?l.push({iColumn:C,desc:w.direction==="desc"}):N==="rowid"&&l.push({iColumn:-1,desc:w.direction==="desc"})}}else console.warn("Skipping non-column ORDER BY term for xBestIndex planning")});let h=am(e,t,i,o,a),p={nConstraint:c.length,aConstraint:Object.freeze([...c]),nOrderBy:l.length,aOrderBy:Object.freeze([...l]),colUsed:h,aConstraintUsage:Array.from({length:c.length},()=>({argvIndex:0,omit:!1})),idxNum:0,idxStr:null,orderByConsumed:!1,estimatedCost:1e10,estimatedRows:BigInt(1e6),idxFlags:0},g;try{g=n.vtabModule.xBestIndex(n.vtabInstance,p)}catch(w){console.error(`Error calling xBestIndex for ${n.name}:`,w),g=I.ERROR}if(g!==I.OK)throw new R(`xBestIndex failed for table ${n.name} with code ${g}`,g,void 0,r.loc?.start.line,r.loc?.start.column);let E={idxNum:p.idxNum,idxStr:p.idxStr,usage:p.aConstraintUsage,cost:p.estimatedCost,rows:p.estimatedRows,orderByConsumed:p.orderByConsumed,constraints:[...p.aConstraint],constraintExpressions:f,handledWhereNodes:d};e.cursorPlanningInfo.set(t,E),console.log(`Planning for ${n.name} (cursor ${t}, outer: ${[...s]}): idxNum=${E.idxNum}, cost=${E.cost}, rows=${E.rows}, usage=`,E.usage,`handledNodes=${E.handledWhereNodes.size}`,`colUsed=${h.toString(2)}`)}function is(e,t=!1){switch(e.toUpperCase()){case"=":case"==":return G.EQ;case"<":return t?G.GT:G.LT;case"<=":return t?G.GE:G.LE;case">":return t?G.LT:G.GT;case">=":return t?G.LE:G.GE;case"!=":case"<>":return G.NE;case"IS":return G.IS;case"IS NOT":return G.ISNOT;case"LIKE":return G.LIKE;case"GLOB":return G.GLOB;case"REGEXP":return G.REGEXP;case"MATCH":return G.MATCH;default:return}}function Zl(e,t,n){let r=e.cursorPlanningInfo.get(t);if(!r||r.constraints.length===0||r.usage.every(a=>a.argvIndex===0))return;let s=e.allocateMemoryCells(1),o=e.tableSchemas.get(t);if(!o)throw new Error(`Internal: Schema missing for cursor ${t} during verification`);for(let a=0;a<r.constraints.length;a++){let i=r.constraints[a],c=r.usage[a];if(c.argvIndex>0&&!c.omit){let f=r.constraintExpressions.get(a),d=null,l=f?.loc;if(i.iColumn===-1){console.warn(`Verification of rowid constraint (constraint ${a}) not implemented.`);continue}let h=o.columns[i.iColumn]?.name;if(!h){console.error(`Cannot find column name for index ${i.iColumn} in table ${o.name} during verification.`);continue}let p={type:"column",name:h};if(i.op===G.ISNULL||i.op===G.ISNOTNULL)if(f?.type==="unary")d={...f,expr:p},l=f.loc;else{console.warn(`Cannot reconstruct IS NULL/IS NOT NULL verification expression for constraint ${a}.`);continue}else{if(!f){console.warn(`Could not find original value expression for constraint verification (cursor ${t}, constraint ${a}, op ${i.op})`);continue}let E={[G.EQ]:{op:"="},[G.LT]:{op:"<"},[G.LE]:{op:"<="},[G.GT]:{op:">"},[G.GE]:{op:">="},[G.NE]:{op:"!="},[G.IS]:{op:"IS"},[G.ISNOT]:{op:"IS NOT"},[G.LIKE]:{op:"LIKE"},[G.GLOB]:{op:"GLOB"},[G.REGEXP]:{op:"REGEXP"},[G.MATCH]:{op:"MATCH"}}[i.op];if(!E){console.warn(`Cannot map constraint op ${i.op} back to AST operator for verification.`);continue}d={type:"binary",operator:E.op,left:p,right:f,loc:l}}if(d){e.compileExpression(d,s);let g=d.type==="unary"||d.type==="binary"?d.operator:`op${i.op}`;e.emit(u.IfFalse,s,n,0,null,0,`Verify constraint ${a} (${g})`)}}}}function fn(e,t,n,r){if(!t)return;let s=new Set;n.forEach(a=>{e.cursorPlanningInfo.get(a)?.handledWhereNodes.forEach(i=>{s.add(i)})});let o=a=>{if(!s.has(a))if(a.type==="binary")if(a.operator.toUpperCase()==="AND")o(a.left),o(a.right);else if(a.operator.toUpperCase()==="OR"){let i=e.allocateMemoryCells(1),c=e.allocateAddress();e.compileExpression(a.left,i),e.emit(u.IfTrue,i,c,0,null,0,"OR: check left"),e.compileExpression(a.right,i),e.emit(u.IfFalse,i,r,0,null,0,"OR: check right, jump if false"),e.resolveAddress(c)}else{let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(u.IfFalse,i,r,0,null,0,`Check unhandled: ${a.operator}`)}else if(a.type==="unary"){let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(u.IfFalse,i,r,0,null,0,`Check unhandled: ${a.operator}`)}else{let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(u.IfFalse,i,r,0,null,0,`Check unhandled: ${a.type}`)}};o(t)}function At(e,t,n){let r={isCorrelated:!1,correlatedColumns:[]},s=new Set,o=(a,i)=>{if(a){if(a.type==="select"){let c=a,f=new Map,d=new Set;c.from?.forEach(h=>{let p=g=>{if(g.type==="table"){let E=(g.alias||g.table.name).toLowerCase(),w=e.tableAliases.get(E);w!==void 0?(f.set(E,w),d.add(w)):console.warn(`Alias/Table ${E} not found in global map during correlation analysis. Scope issue?`)}else if(g.type==="join")p(g.left),p(g.right);else if(g.type==="functionSource"){let E=(g.alias||g.name.name).toLowerCase(),w=e.tableAliases.get(E);w!==void 0?(f.set(E,w),d.add(w)):console.warn(`Alias/TVF ${E} not found in global map during correlation analysis. Scope issue?`)}};p(h)});let l=new Set([...i,...d]);c.columns.forEach(h=>{h.type==="column"&&h.expr&&o(h.expr,l)}),o(c.where,l),c.groupBy?.forEach(h=>o(h,l)),o(c.having,l);return}if(a.type==="column"||a.type==="identifier"){let c,f;a.type==="column"?(c=a.name,f=a.table):(c=a.name,f=void 0);let d=-1,l=!1;if(f){let h=f.toLowerCase(),p=e.tableAliases.get(h);p!==void 0&&i.has(p)&&(d=p,l=!0)}else{let h=-1,p=!1;for(let g of i)e.tableSchemas.get(g)?.columnIndexMap.has(c.toLowerCase())&&(h!==-1&&(p=!0),h=g);if(p)throw new R(`Ambiguous column in subquery correlation check: ${c}`,I.ERROR,void 0,a.loc?.start.line,a.loc?.start.column);h!==-1&&(d=h,l=!0)}if(l&&n.has(d)){let h=d,g=e.tableSchemas.get(h)?.columnIndexMap.get(c.toLowerCase())??-1;if(g!==-1){r.isCorrelated=!0;let E=`${h}.${g}`;s.has(E)||(r.correlatedColumns.push({outerCursor:h,outerColumnIndex:g}),s.add(E))}else console.warn(`Outer column ${c} resolved to cursor ${h} but index not found in schema.`)}}else a.type==="binary"?(o(a.left,i),o(a.right,i)):a.type==="unary"?o(a.expr,i):a.type==="function"?a.args.forEach(c=>o(c,i)):a.type==="cast"?o(a.expr,i):a.type==="subquery"?o(a.query,i):a.type==="collate"&&o(a.expr,i)}};return o(t,n),r}function mr(e,t){return`${e.toLowerCase()}/${t}`}function pr(e){if(!e)return A.BLOB;let t=e.toUpperCase();return t.includes("INT")?A.INTEGER:t.includes("TEXT")||t.includes("CHAR")||t.includes("CLOB")?A.TEXT:t.includes("BLOB")?A.BLOB:t.includes("REAL")||t.includes("FLOA")||t.includes("DOUB")?A.REAL:A.NUMERIC}var Ln=class{name;tables=new Map;functions=new Map;views=new Map;constructor(t){this.name=t}addTable(t){if(t.schemaName!==this.name)throw new Error(`Table ${t.name} has wrong schema name ${t.schemaName}, expected ${this.name}`);if(this.views.has(t.name.toLowerCase()))throw new R(`Schema '${this.name}': Cannot add table '${t.name}', a view with the same name already exists.`);this.tables.set(t.name.toLowerCase(),t),console.log(`Schema '${this.name}': Added/Updated table '${t.name}'`)}getTable(t){return this.tables.get(t.toLowerCase())}getAllTables(){return this.tables.values()}removeTable(t){let n=t.toLowerCase(),r=this.tables.has(n);return r&&(console.log(`Schema '${this.name}': Removed table '${t}'`),this.tables.delete(n)),r}clearTables(){this.tables.clear()}addView(t){if(t.schemaName!==this.name)throw new Error(`View ${t.name} has wrong schema name ${t.schemaName}, expected ${this.name}`);if(this.tables.has(t.name.toLowerCase()))throw new R(`Schema '${this.name}': Cannot add view '${t.name}', a table with the same name already exists.`);this.views.set(t.name.toLowerCase(),t),console.log(`Schema '${this.name}': Added/Updated view '${t.name}'`)}getView(t){return this.views.get(t.toLowerCase())}getAllViews(){return this.views.values()}removeView(t){let n=t.toLowerCase(),r=this.views.has(n);return r&&(console.log(`Schema '${this.name}': Removed view '${t}'`),this.views.delete(n)),r}clearViews(){this.views.clear()}addFunction(t){let n=mr(t.name,t.numArgs),r=this.functions.get(n);if(r?.xDestroy&&r.userData!==t.userData)try{r.xDestroy(r.userData)}catch(s){console.error(`Destructor failed for function ${n}`,s)}this.functions.set(n,t),console.log(`Schema '${this.name}': Added/Updated function '${t.name}/${t.numArgs}'`)}getFunction(t,n){let r=mr(t,n),s=mr(t,-1);return this.functions.get(r)??this.functions.get(s)}_getAllFunctions(){return this.functions.values()}removeFunction(t,n){let r=mr(t,n),s=this.functions.get(r);if(s){if(s.xDestroy&&s.userData)try{s.xDestroy(s.userData)}catch(o){console.error(`Destructor failed for function ${r}`,o)}return console.log(`Schema '${this.name}': Removed function '${t}/${n}'`),this.functions.delete(r)}return!1}clearFunctions(){this.functions.forEach(t=>{if(t.xDestroy&&t.userData)try{t.xDestroy(t.userData)}catch(n){console.error(`Destructor failed for function ${t.name}/${t.numArgs}`,n)}}),this.functions.clear()}};function dn(e,t,n){switch(t.type){case"literal":let r=t.value;return r===null?A.NULL:typeof r=="number"?A.REAL:typeof r=="bigint"?A.INTEGER:typeof r=="string"?A.TEXT:r instanceof Uint8Array?A.BLOB:A.BLOB;case"column":return Hl(e,t,n)?.column?.affinity??A.BLOB;case"cast":return pr(t.targetType);case"function":return e.db._findFunction(t.name,t.args.length)?.affinity??A.BLOB;case"parameter":return A.BLOB;case"unary":switch(t.operator.toUpperCase()){case"-":case"+":return A.NUMERIC;case"~":return A.INTEGER;case"NOT":return A.INTEGER;default:return A.BLOB}case"binary":switch(t.operator.toUpperCase()){case"+":case"-":case"*":case"/":case"%":case"&":case"|":case"<<":case">>":return A.NUMERIC;case"||":return A.TEXT;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":case"IN":case"LIKE":case"GLOB":case"BETWEEN":return A.INTEGER;case"AND":case"OR":let o=dn(e,t.left,n),a=dn(e,t.right,n);return o===A.TEXT||a===A.TEXT?A.TEXT:o===A.BLOB||a===A.BLOB?A.BLOB:A.NUMERIC;default:return A.BLOB}case"subquery":return A.BLOB;case"identifier":return dn(e,{type:"column",name:t.name},n);case"collate":return dn(e,t.expr,n);default:return A.BLOB}}function Hl(e,t,n){let r=-1;if(t.table)r=e.tableAliases.get(t.table.toLowerCase())??-1;else for(let[i,c]of e.tableAliases.entries())if(e.tableSchemas.get(c)?.columnIndexMap.has(t.name.toLowerCase())){if(r!==-1)return null;r=c}if(r===-1)return null;let s=e.tableSchemas.get(r);if(!s)return null;let o=s.columnIndexMap.get(t.name.toLowerCase());if(o===void 0)return t.name.toLowerCase()==="rowid"&&s.primaryKeyDefinition?.length===0&&!s.isVirtual,null;let a=s.columns[o];return{table:s,column:a}}function Vt(e,t,n){switch(t.type){case"literal":return"BINARY";case"column":return Hl(e,t,n)?.column.collation||"BINARY";case"collate":return t.collation.toUpperCase();case"cast":return Vt(e,t.expr,n);case"function":return"BINARY";case"parameter":return"BINARY";case"unary":return Vt(e,t.expr,n);case"binary":switch(t.operator.toUpperCase()){case"||":case"+":case"-":case"*":case"/":case"%":case"&":case"|":case"<<":case">>":return"BINARY";case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":case"LIKE":case"GLOB":case"BETWEEN":case"IN":{let s=Vt(e,t.left,n),o=Vt(e,t.right,n);return s!=="BINARY"&&o==="BINARY"?s:o!=="BINARY"&&s==="BINARY"?o:"BINARY"}case"AND":case"OR":return"BINARY";default:return"BINARY"}case"subquery":return"BINARY";case"identifier":return Vt(e,{type:"column",name:t.name},n);default:return"BINARY"}}function ls(e,t,n){let r=t.value;if(r===null)e.emit(u.Null,0,n,0,null,0,"NULL literal");else if(typeof r=="number")if(Number.isSafeInteger(r))e.emit(u.Integer,r,n,0,null,0,`Integer literal: ${r}`);else if(Number.isInteger(r)){let s=e.addConstant(BigInt(r));e.emit(u.Int64,0,n,0,s,0,`Large Integer literal: ${r}`)}else{let s=e.addConstant(r);e.emit(u.Real,0,n,0,s,0,`Float literal: ${r}`)}else if(typeof r=="string"){let s=e.addConstant(r);e.emit(u.String8,0,n,0,s,0,`String literal: '${r}'`)}else if(r instanceof Uint8Array){let s=e.addConstant(r);e.emit(u.Blob,r.length,n,0,s,0,"BLOB literal")}else if(typeof r=="bigint"){let s=e.addConstant(r);e.emit(u.Int64,0,n,0,s,0,`BigInt literal: ${r}`)}else throw new R(`Unsupported literal type: ${typeof r}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}function gr(e,t,n,r,s,o){if(e.subroutineDepth>0&&o){let f=r?.correlatedColumns.find(d=>{let l=e.tableSchemas.get(d.outerCursor),h=l?.columns[d.outerColumnIndex]?.name.toLowerCase();if(!h)return!1;if(t.table){let p=[...e.tableAliases.entries()].find(([w,y])=>y===d.outerCursor)?.[0],g=l?.name.toLowerCase(),E=t.table.toLowerCase();if(p?.toLowerCase()===E||g===E)return h===t.name.toLowerCase()}else return h===t.name.toLowerCase();return!1});if(f){let d=`${f.outerCursor}.${f.outerColumnIndex}`,l=o.get(d);if(l!==void 0){e.emit(u.SCopy,l,n,0,null,0,`Sub: Use outer arg ${t.name} from FP[${l}]`);return}else throw new R(`Internal error: Correlated column ${t.name} not found in argument map.`,I.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column)}}if(s){let f=t.name.toLowerCase(),d=s.finalColumnMap.find(l=>l.expr?.alias?.toLowerCase()===f||l.expr?.type==="column"&&!l.expr?.alias&&l.expr.name.toLowerCase()===f);if(d){e.emit(u.SCopy,d.targetReg,n,0,null,0,`HAVING: Use grouped/aggregated col '${t.name}' from reg ${d.targetReg}`);return}throw new R(`Column "${t.name}" must appear in the GROUP BY clause or be used in an aggregate function`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}let a=-1,i=-1,c;if(t.table){let f=t.table.toLowerCase(),d=e.tableAliases.get(f);if(d===void 0)throw new R(`Table or alias not found: ${t.table}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);if(a=d,c=e.tableSchemas.get(a),!c)throw new R(`Internal error: Schema not found for cursor ${a}`,I.INTERNAL);let l=c.columnIndexMap.get(t.name.toLowerCase());if(l===void 0)if(t.name.toLowerCase()==="rowid"&&c.isVirtual)i=-1;else throw new R(`Column not found in table ${t.table}: ${t.name}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);else i=l}else{let f=0,d=-1,l=-1,h;for(let[p,g]of e.tableAliases.entries()){let E=e.tableSchemas.get(g);if(E){let w=E.columnIndexMap.get(t.name.toLowerCase());if(w!==void 0){if(d!==-1)throw new R(`Ambiguous column name: ${t.name}. Qualify with table name or alias.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);d=g,l=w,h=E,f++}else if(t.name.toLowerCase()==="rowid"&&E.isVirtual){if(d!==-1)throw new R(`Ambiguous column name: ${t.name} (rowid). Qualify with table name or alias.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);d=g,l=-1,h=E,f++}}}if(d===-1)throw new R(`Column not found: ${t.name}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);a=d,i=l,c=h}if(!c)throw new Error("Internal: Schema resolution failed");if(c.isVirtual)e.emit(u.VColumn,a,i,n,0,0,`Get column: ${c.name}.${t.name} (idx ${i})`);else throw new R("Regular tables not implemented",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}function us(e,t,n,r,s,o){if(t.right.type==="subquery"&&["=","==","!=","<>","<","<=",">",">=","IN"].includes(t.operator.toUpperCase())){let d=t.right.query;switch(t.operator.toUpperCase()){case"IN":e.compileInSubquery(t.left,d,n,!1);return;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":e.compileComparisonSubquery(t.left,t.operator,d,n);return;default:throw new R(`Operator '${t.operator}' cannot be used with a subquery on the right side.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}if(t.left.type==="subquery"&&["=","==","!=","<>","<","<=",">",">="].includes(t.operator.toUpperCase())){let d=t.left.query;switch(t.operator.toUpperCase()){case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":e.compileComparisonSubquery(t.left,t.operator,d,n);return;default:throw new R(`Operator '${t.operator}' cannot be used with a subquery on the left side.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}let a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1);e.compileExpression(t.left,a,r,s,o),e.compileExpression(t.right,i,r,s,o);let c,f=["=","==","!=","<>","<","<=",">",">=","IS","IS NOT","LIKE","GLOB"].includes(t.operator.toUpperCase());if(f)if(t.left.type==="collate")c=t.left.collation.toUpperCase();else if(t.right.type==="collate")c=t.right.collation.toUpperCase();else{let d=Vt(e,t.left,r),l=Vt(e,t.right,r);d!=="BINARY"&&l==="BINARY"?c=d:l!=="BINARY"&&d==="BINARY"?c=l:d!=="BINARY"&&l!=="BINARY"&&d!==l?c="BINARY":c=d}switch(t.operator.toUpperCase()){case"+":e.emit(u.Add,a,i,n,null,0,"Add");break;case"-":e.emit(u.Subtract,a,i,n,null,0,"Subtract");break;case"*":e.emit(u.Multiply,a,i,n,null,0,"Multiply");break;case"/":e.emit(u.Divide,a,i,n,null,0,"Divide");break;case"%":e.emit(u.Remainder,a,i,n,null,0,"Remainder");break;case"||":e.emit(u.Concat,a,i,n,null,0,"Concat");break;case"&":e.emit(u.BitAnd,a,i,n,null,0,"BitAnd");break;case"|":e.emit(u.BitOr,a,i,n,null,0,"BitOr");break;case"<<":e.emit(u.ShiftLeft,i,a,n,null,0,"ShiftLeft");break;case">>":e.emit(u.ShiftRight,i,a,n,null,0,"ShiftRight");break;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":{let d,l=!0,h=null;switch(f&&c&&c!=="BINARY"&&(h={type:"coll",name:c}),t.operator.toUpperCase()){case"=":case"==":d=u.Eq,l=!0;break;case"IS":d=u.Eq,l=!1;break;case"!=":case"<>":d=u.Ne,l=!0;break;case"IS NOT":d=u.Ne,l=!1;break;case"<":d=u.Lt,l=!0;break;case"<=":d=u.Le,l=!0;break;case">":d=u.Gt,l=!0;break;case">=":d=u.Ge,l=!0;break;default:throw new Error("Impossible operator")}let p=dn(e,t.left,r),g=dn(e,t.right,r),E=[A.INTEGER,A.REAL,A.NUMERIC].includes(p),w=[A.INTEGER,A.REAL,A.NUMERIC].includes(g),y=[A.TEXT,A.BLOB].includes(p),N=[A.TEXT,A.BLOB].includes(g);E&&N?e.emit(u.Affinity,i,1,0,"NUMERIC",0,"Apply NUMERIC affinity to RHS"):w&&y&&e.emit(u.Affinity,a,1,0,"NUMERIC",0,"Apply NUMERIC affinity to LHS");let b=e.allocateAddress(),C=e.allocateAddress(),S=e.allocateAddress();l&&(e.emit(u.IfNull,a,C,0,null,0,"Compare: If left NULL"),e.emit(u.IfNull,i,C,0,null,0,"Compare: If right NULL")),e.emit(d,a,b,i,h,0,`Compare ${t.operator}${h?` (${h.name})`:""}`),e.emit(u.Integer,0,n,0,null,0,"Load 0 (false result)"),e.emit(u.Goto,0,S,0,null,0),e.resolveAddress(b),e.emit(u.Integer,1,n,0,null,0,"Load 1 (true result)"),e.emit(u.Goto,0,S,0,null,0),l&&(e.resolveAddress(C),e.emit(u.Null,0,n,0,null,0,"Null comparison result")),e.resolveAddress(S);break}case"LIKE":case"GLOB":throw new R(`Operator ${t.operator} not fully implemented yet with collation support.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);case"AND":{let d=e.allocateAddress(),l=e.allocateAddress();e.emit(u.SCopy,a,n,0,null,0,"AND: Copy left initially"),e.emit(u.IfTrue,a,d,0,null,0,"AND: If left is true, evaluate right"),e.emit(u.Goto,0,l,0,null,0,"AND: Left is false/null, finish"),e.resolveAddress(d),e.emit(u.SCopy,i,n,0,null,0,"AND: Copy right as result"),e.resolveAddress(l);break}case"OR":{let d=e.allocateAddress(),l=e.allocateAddress();e.emit(u.SCopy,a,n,0,null,0,"OR: Copy left initially"),e.emit(u.IfTrue,a,l,0,null,0,"OR: If left is true, finish"),e.resolveAddress(d),e.emit(u.SCopy,i,n,0,null,0,"OR: Copy right as result"),e.resolveAddress(l);break}default:throw new R(`Unsupported binary operator: ${t.operator}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function cs(e,t,n,r,s,o){if(t.operator.toUpperCase()==="NOT"&&t.expr.type==="binary"&&t.expr.operator.toUpperCase()==="IN"&&t.expr.right.type==="subquery"){e.compileInSubquery(t.expr.left,t.expr.right.query,n,!0);return}if(t.operator.toUpperCase()==="NOT"&&t.expr.type==="subquery"){e.compileExistsSubquery(t.expr.query,n);let i=e.allocateAddress(),c=e.allocateAddress();e.emit(u.IfNull,n,c,0,null,0,"NOT EXISTS: Skip if NULL"),e.emit(u.Not,n,n,0,null,0,"NOT EXISTS: Invert boolean"),e.resolveAddress(c);return}if(t.operator.toUpperCase()==="EXISTS"&&t.expr.type==="subquery"){e.compileExistsSubquery(t.expr.query,n);return}if(t.operator.toUpperCase()==="IS NULL"){let i=e.allocateMemoryCells(1);e.compileExpression(t.expr,i,r,s,o),e.emit(u.IsNull,i,n,0,null,0,"Check IS NULL");return}if(t.operator.toUpperCase()==="IS NOT NULL"){let i=e.allocateMemoryCells(1);e.compileExpression(t.expr,i,r,s,o),e.emit(u.NotNull,i,n,0,null,0,"Check IS NOT NULL");return}let a=e.allocateMemoryCells(1);switch(e.compileExpression(t.expr,a,r,s,o),t.operator.toUpperCase()){case"-":e.emit(u.Negative,a,n,0,null,0,"Unary Minus");break;case"+":e.emit(u.SCopy,a,n,0,null,0,"Unary Plus (no-op)");break;case"~":e.emit(u.BitNot,a,n,0,null,0,"Bitwise NOT");break;case"NOT":let i=e.allocateAddress(),c=e.allocateAddress(),f=e.allocateAddress();e.emit(u.IfNull,a,i,0,null,0,"NOT: Check if operand is NULL"),e.emit(u.IfZero,a,c,0,null,0,"NOT: Check if operand is 0 (false)"),e.emit(u.Integer,0,n,0,null,0,"NOT: Set result 0 (operand was true)"),e.emit(u.Goto,0,f,0,null,0),e.resolveAddress(c),e.emit(u.Integer,1,n,0,null,0,"NOT: Set result 1 (operand was false)"),e.emit(u.Goto,0,f,0,null,0),e.resolveAddress(i),e.emit(u.Null,0,n,0,null,0,"NOT: Set result NULL (operand was NULL)"),e.resolveAddress(f);break;default:throw new R(`Unsupported unary operator: ${t.operator}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function fs(e,t,n,r,s,o){e.compileExpression(t.expr,n,r,s,o);let a=t.targetType.toUpperCase(),i=pr(a),c;switch(i){case A.INTEGER:c="INTEGER";break;case A.REAL:c="REAL";break;case A.TEXT:c="TEXT";break;case A.BLOB:c="BLOB";break;case A.NUMERIC:c="NUMERIC";break;default:c="BLOB"}e.emit(u.Affinity,n,1,0,c,0,`CAST to ${a}`)}function ds(e,t,n,r,s,o){if(s){let f=s.finalColumnMap.find(d=>d.expr?.type==="function"&&d.expr.name.toLowerCase()===t.name.toLowerCase()&&JSON.stringify(d.expr.args)===JSON.stringify(t.args));if(f){e.emit(u.SCopy,f.targetReg,n,0,null,0,`HAVING: Use aggregated func '${t.name}' from reg ${f.targetReg}`);return}}let a=e.allocateMemoryCells(t.args.length||1);for(let f=0;f<t.args.length;f++)e.compileExpression(t.args[f],a+f,r,s,o);let i=e.db._findFunction(t.name,t.args.length);if(!i)throw new R(`Function not found: ${t.name}/${t.args.length}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let c=!!(i.xStep&&i.xFinal);if(c&&!s)e.emit(u.Null,0,n,0,null,0,`Aggregate func ${t.name} in scalar context -> NULL`);else if(i.xFunc){let f={type:"funcdef",funcDef:i,nArgs:t.args.length};e.emit(u.Function,a,t.args.length,n,f,0,`Call func: ${t.name}`)}else throw c&&s&&!i.xFunc?new R(`Aggregate function ${i.name} used incorrectly in HAVING clause.`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column):c&&!s?new R(`Aggregate function ${i.name} used in a scalar context`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column):new R(`Invalid function call context for ${i.name}`,I.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column)}function hs(e,t,n){let r=t.name||t.index;e.parameters.set(r,{memIdx:n}),e.emit(u.Null,0,n,0,null,0,`Parameter placeholder: ${r} -> R[${n}]`)}function ms(e,t,n,r,s,o){e.compileExpression(t.expr,n,r,s,o)}function Xl(e,t,n,r,s,o){switch(t.type){case"literal":ls(e,t,n);break;case"identifier":gr(e,{type:"column",name:t.name,alias:t.name},n,r,s,o);break;case"column":gr(e,t,n,r,s,o);break;case"binary":us(e,t,n,r,s,o);break;case"unary":cs(e,t,n,r,s,o);break;case"cast":fs(e,t,n,r,s,o);break;case"function":ds(e,t,n,r,s,o);break;case"parameter":hs(e,t,n);break;case"subquery":e.compileSubquery(t,n);break;case"collate":ms(e,t,n,r,s,o);break;default:throw new R(`Unsupported expression type: ${t.type}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function Jl(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new R(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new R(`Table ${n.name} is not a virtual table supporting INSERT`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=t.columns;if(!r)r=n.columns.filter(d=>!d.hidden).map(d=>d.name);else{let d=new Set(n.columns.map(l=>l.name.toLowerCase()));for(let l of r)if(!d.has(l.toLowerCase()))throw new R(`Column '${l}' not found in table '${n.name}'`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}let s=r.length,o=r.map(d=>n.columnIndexMap.get(d.toLowerCase())),a=e.allocateCursor(),i={type:"vtab",tableSchema:n};e.emit(u.OpenWrite,a,s,0,i,0,`OpenWrite ${n.name}`);let c=e.allocateMemoryCells(1),f=e.allocateMemoryCells(n.columns.length+1);if(t.values)for(let d of t.values){if(d.length!==s)throw new R(`Column count mismatch: table ${n.name} expected ${s} columns, but ${d.length} values were supplied`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);e.emit(u.Null,0,f,0,null,0,"Rowid=NULL for INSERT");for(let h=0;h<n.columns.length;h++)e.emit(u.Null,0,f+1+h);for(let h=0;h<s;h++){let p=o[h];e.compileExpression(d[h],f+1+p)}let l={onConflict:t.onConflict||oe.ABORT,table:n};e.emit(u.VUpdate,n.columns.length+1,f,c,l,0,`VUpdate INSERT ${n.name}`)}else throw t.select?new R("INSERT ... SELECT compilation not implemented yet.",I.ERROR,void 0,t.select.loc?.start.line,t.select.loc?.start.column):new R("INSERT statement missing VALUES or SELECT clause.",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);e.emit(u.Close,a,0,0,null,0,`Close ${n.name}`)}function Ql(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new R(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new R(`Table ${n.name} is not a virtual table supporting UPDATE`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=e.allocateCursor(),s={type:"vtab",tableSchema:n};e.emit(u.OpenRead,r,0,0,s,0,`OpenRead for UPDATE ${n.name}`),e.planTableAccess(r,n,t,new Set);let o=e.cursorPlanningInfo.get(r),a=e.allocateMemoryCells(1),i=e.allocateAddress(),c=e.allocateAddress(),f=e.allocateAddress(),d=0,l={idxNum:0,idxStr:null,nArgs:0};if(o&&o.idxNum!==0){let N=[];o.usage.forEach((C,S)=>{if(C.argvIndex>0){let O=o.constraintExpressions?.get(S);if(!O)throw new R(`Internal error: Missing expression for constraint ${S} used in UPDATE VFilter`,I.INTERNAL);for(;N.length<C.argvIndex;)N.push(null);N[C.argvIndex-1]={constraintIdx:S,expr:O}}});let b=N.filter(C=>C!==null);b.length>0&&(d=e.allocateMemoryCells(b.length),b.forEach((C,S)=>{e.compileExpression(C.expr,d+S)})),l={idxNum:o.idxNum,idxStr:o.idxStr,nArgs:b.length}}e.emit(u.VFilter,r,i,d,l,0,`Filter for UPDATE ${n.name} (Plan: ${o?.idxNum})`),e.resolveAddress(c),fn(e,t.where,[r],f);let h=new Map;n.columns.forEach((N,b)=>{h.set(N.name.toLowerCase(),b)});let p=new Map,g=new Set;for(let N of t.assignments){let b=N.column.toLowerCase(),C=h.get(b);if(C===void 0)throw new R(`Column '${N.column}' not found in table '${n.name}'`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);if(g.has(C))throw new R(`Column '${N.column}' specified more than once in SET clause`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let S=e.allocateMemoryCells(1);e.compileExpression(N.value,S),p.set(C,S),g.add(C)}e.emit(u.VRowid,r,a,0,null,0,"Get Rowid for UPDATE");let E=n.columns.length,w=e.allocateMemoryCells(E+1);e.emit(u.SCopy,a,w,0,null,0,"Copy Rowid for VUpdate");for(let N=0;N<E;N++){let b=w+1+N;if(g.has(N)){let C=p.get(N);e.emit(u.SCopy,C,b,0,null,0,`Copy NEW value for col ${N}`)}else e.emit(u.VColumn,r,N,b,0,0,`Get OLD value for col ${N}`)}let y={onConflict:t.onConflict||oe.ABORT,table:n};e.emit(u.VUpdate,E+1,w,0,y,0,`VUpdate UPDATE ${n.name}`),e.resolveAddress(f),e.emit(u.VNext,r,i,0,null,0,"Advance to next row for UPDATE"),e.emit(u.Goto,0,c,0,null,0,"Loop back for next UPDATE"),e.resolveAddress(i),e.emit(u.Close,r,0,0,null,0,`Close ${n.name}`)}function eu(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new R(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new R(`Table ${n.name} is not a virtual table supporting DELETE`,I.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=e.allocateCursor(),s={type:"vtab",tableSchema:n};e.emit(u.OpenRead,r,0,0,s,0,`OpenRead for DELETE ${n.name}`),e.planTableAccess(r,n,t,new Set);let o=e.cursorPlanningInfo.get(r),a=e.allocateMemoryCells(1),i=e.allocateAddress(),c=e.allocateAddress(),f=e.allocateAddress(),d=0,l={idxNum:0,idxStr:null,nArgs:0};if(o&&o.idxNum!==0){let p=[];o.usage.forEach((E,w)=>{if(E.argvIndex>0){let y=o.constraintExpressions?.get(w);if(!y)throw new R(`Internal error: Missing expression for constraint ${w} used in DELETE VFilter`,I.INTERNAL);for(;p.length<E.argvIndex;)p.push(null);p[E.argvIndex-1]={constraintIdx:w,expr:y}}});let g=p.filter(E=>E!==null);g.length>0&&(d=e.allocateMemoryCells(g.length),g.forEach((E,w)=>{e.compileExpression(E.expr,d+w)})),l={idxNum:o.idxNum,idxStr:o.idxStr,nArgs:g.length}}e.emit(u.VFilter,r,i,d,l,0,`Filter for DELETE ${n.name} (Plan: ${o?.idxNum})`),e.resolveAddress(c),fn(e,t.where,[r],f),e.emit(u.VRowid,r,a,0,null,0,"Get Rowid for DELETE");let h={onConflict:oe.ABORT,table:n};e.emit(u.VUpdate,1,a,0,h,0,`VUpdate DELETE ${n.name}`),e.resolveAddress(f),e.emit(u.VNext,r,i,0,null,0,"Advance to next row for DELETE"),e.emit(u.Goto,0,c,0,null,0,"Loop back for next DELETE"),e.resolveAddress(i),e.emit(u.Close,r,0,0,null,0,`Close ${n.name}`)}function tu(e,t){if(t.savepoint){let n=e.addConstant(t.savepoint);e.emit(u.Savepoint,0,0,0,n,0,`ROLLBACK TO ${t.savepoint}`),e.emit(u.VRollbackTo,0,0,0,n,0,`VRollbackTo ${t.savepoint}`)}else e.emit(u.VRollback,0,0,0,null,0,"ROLLBACK")}function nu(e,t){let n=e.addConstant(t.name);e.emit(u.Savepoint,1,0,0,n,0,`SAVEPOINT ${t.name}`),e.emit(u.VSavepoint,0,0,0,n,0,`VSavepoint ${t.name}`)}function ru(e,t){if(!t.savepoint)throw new R("RELEASE statement requires a savepoint name.",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let n=e.addConstant(t.savepoint);e.emit(u.Savepoint,2,0,0,n,0,`RELEASE ${t.savepoint}`),e.emit(u.VRelease,0,0,0,n,0,`VRelease ${t.savepoint}`)}function su(e,t){let n=[];if(t.columns.forEach(y=>{y.type==="column"&&y.expr?.type==="windowFunction"&&n.push(y.expr)}),n.length===0)throw new R("Internal error: setupWindowSorter called with no window functions found in SELECT list.",I.INTERNAL);let r=new Map,s=new Map,o=[],a=new Map,i=[],c=[],f=[],d=0,l=y=>{let N=y.type==="literal"&&y.value==="*"?"literal:*":Re(y);if(!r.has(N)){let b=`col_${d}_${y.type}`,C=Te(b);C.affinity=A.TEXT,o.push(C),r.set(N,d),a.set(d,y),d++}return r.get(N)},h=n[0].window;h?.partitionBy&&h.partitionBy.forEach(y=>{let N=l(y);i.includes(N)||i.push(N)}),h?.orderBy&&h.orderBy.forEach(y=>{let N=l(y.expr);c.includes(N)||(c.push(N),f.push(y.direction==="desc"))}),n.forEach(y=>{y.function.args&&y.function.args.forEach(N=>{l(N)})}),t.columns.forEach(y=>{y.type==="column"&&y.expr&&y.expr.type!=="windowFunction"&&l(y.expr)}),n.forEach((y,N)=>{let b=`win_result_${y.function.name}_${N}`,C=Te(b);C.affinity=A.INTEGER,o.push(C);let S=e.allocateMemoryCells(1);s.set(y,{sorterIndex:d,resultReg:S}),d++});let p={type:"sortkey",keyIndices:[...i,...c],directions:[...i.map(()=>!1),...f]},g=e.allocateCursor(),E=e.allocateMemoryCells(o.length),w={name:`window_sorter_${g}`,type:"ephemeral",columns:o};return{cursor:g,schema:w,sortKeyP4:p,numPartitionKeys:i.length,dataBaseReg:E,exprToSorterIndex:r,windowResultPlaceholders:s,indexToExpression:a}}function ou(e,t,n,r,s){let o=t.cursor,a=t.schema.columns.length,i=t.numPartitionKeys,c=t.sortKeyP4.keyIndices,f=c.slice(0,i),d=c.slice(i),l=d.length,h=e.allocateMemoryCells(i>0?i:1),p=e.allocateMemoryCells(i>0?i:1),g=e.allocateMemoryCells(1),E=e.allocateMemoryCells(a),w=e.allocateMemoryCells(1),y=e.allocateMemoryCells(1),N=e.allocateMemoryCells(l>0?l:1),b=e.allocateMemoryCells(l>0?l:1),C=e.allocateMemoryCells(1),S=e.allocateMemoryCells(1),O=e.allocateMemoryCells(1),v=0,x=0,L=0,U=0,B=0,_=0,k=0;s&&(v=e.allocateMemoryCells(1),x=e.allocateMemoryCells(1),L=e.allocateMemoryCells(1),U=e.allocateMemoryCells(1),(s.start.type==="preceding"||s.start.type==="following")&&s.start.value&&(_=e.allocateMemoryCells(1)),s.end&&(s.end.type==="preceding"||s.end.type==="following")&&s.end.value&&(k=e.allocateMemoryCells(1)),e.emit(u.Null,0,v,1,null,0,"Init Frame Start Ptr"),e.emit(u.Null,0,x,1,null,0,"Init Frame End Ptr"),e.emit(u.Null,0,L,1,null,0,"Init Current Row Ptr"),e.emit(u.Null,0,U,1,null,0,"Init Partition Start Ptr"));let J=e.allocateAddress(),le=e.allocateAddress(),ae=e.allocateAddress(),ue=e.allocateAddress(),Ae=e.allocateAddress();if(i>0?e.emit(u.Null,0,p,i,null,0,"Init Prev Partition Keys to NULL"):e.emit(u.Integer,1,g,0,null,0,"Init: Assume first row is new 'partition'"),l>0&&e.emit(u.Null,0,b,l,null,0,"Init Prev Order Keys to NULL"),e.emit(u.Integer,0,w,0,null,0,"Init Row Number Counter to 0"),e.emit(u.Integer,0,C,0,null,0,"Init Rank"),e.emit(u.Integer,0,S,0,null,0,"Init Dense Rank"),e.emit(u.Integer,1,y,0,null,0,"Load constant 1"),e.emit(u.Rewind,o,le,0,null,0,"Rewind Window Sorter"),e.resolveAddress(J),s&&e.emit(u.VRowid,o,L,0,null,0,"Get Current Row Pointer"),i>0){e.emit(u.Integer,0,g,0,null,0,"Assume same partition");for(let F=0;F<i;F++){let j=f[F],P=h+F,z=p+F;e.emit(u.VColumn,o,j,P,null,0,`Read Win Part Key ${F} (idx ${j})`),e.emit(u.Ne,P,ae,z,null,1,`Check Part Key ${F} != Prev`)}e.emit(u.Goto,0,ue,0,null,0,"Partition Keys Match"),e.resolveAddress(ae),e.emit(u.Integer,1,g,0,null,0,"Flag New Partition"),e.emit(u.Integer,0,w,0,null,0,"Reset Row Number Counter to 0"),e.emit(u.Integer,0,C,0,null,0,"Reset Rank Counter"),e.emit(u.Integer,0,S,0,null,0,"Reset Dense Rank Counter"),l>0&&e.emit(u.Null,0,b,l,null,0,"Reset Prev Order Keys to NULL"),s&&(e.emit(u.Null,0,v,1,null,0,"Reset Frame Start Ptr"),e.emit(u.Null,0,x,1,null,0,"Reset Frame End Ptr"),e.emit(u.Move,L,U,1,null,0,"Set Partition Start Ptr")),e.emit(u.Move,h,p,i,null,0,"Update Prev Part Keys"),e.emit(u.Goto,0,Ae,0,null,0,"Continue after partition reset"),e.resolveAddress(ue)}else{let F=e.allocateAddress();e.emit(u.IfFalse,g,F,0,null,0,"Check if first row"),s&&e.emit(u.Move,L,U,1,null,0,"Set Partition Start Ptr (First Row)"),e.emit(u.Integer,0,g,0,null,0,"Clear New Partition flag after first row"),e.resolveAddress(F)}e.resolveAddress(Ae);for(let F=0;F<a;F++)if(i>0&&f.includes(F)){let j=f.indexOf(F);e.emit(u.Move,h+j,E+F,1,null,0,`Copy already read Part Key ${j}`)}else e.emit(u.VColumn,o,F,E+F,null,0,`Read Win Full Row Col ${F}`);if(e.emit(u.Add,w,y,w,null,0,"Increment Row Number"),e.emit(u.Integer,0,O,0,null,0,"Assume order keys same"),l>0){let F=e.allocateAddress(),j=e.allocateAddress();for(let P=0;P<l;P++){let z=d[P],T=E+z;e.emit(u.Move,T,N+P,1,null,0,`Store Current Order Key ${P}`);let D=b+P;e.emit(u.Ne,T,j,D,null,1,`Check Order Key ${P}`)}e.emit(u.Goto,0,F,0,null,0,"Order Keys Match"),e.resolveAddress(j),e.emit(u.Integer,1,O,0,null,0,"Flag Order Keys Differ"),e.resolveAddress(F)}let Le=e.allocateAddress(),Ye=e.allocateAddress();e.emit(u.IfTrue,g,Le,0,null,0,"If New Partition, Update Ranks"),l>0?e.emit(u.IfTrue,O,Le,0,null,0,"If Order Keys Differ, Update Ranks"):e.emit(u.IfFalse,g,Ye,0,null,0,"If same partition and no ORDER BY, skip rank update"),e.emit(u.Goto,0,Ye,0,null,0,"Skip Rank Updates"),e.resolveAddress(Le),e.emit(u.Move,w,C,1,null,0,"Update Rank = Current RowNumber");let Bt=e.allocateAddress();if(e.emit(u.IfTrue,g,Bt,0,null,0,"Skip Dense Rank check if new partition"),e.emit(u.IfFalse,O,Bt,0,null,0,"Skip Dense Rank inc if order keys same"),e.emit(u.Add,S,y,S,null,0,"Increment Dense Rank"),e.resolveAddress(Bt),e.resolveAddress(Ye),s)if(_>0&&s.start.type!=="currentRow"&&s.start.type!=="unboundedPreceding"&&s.start.type!=="unboundedFollowing"&&e.compileExpression(s.start.value,_),k>0&&s.end&&s.end.type!=="currentRow"&&s.end.type!=="unboundedPreceding"&&s.end.type!=="unboundedFollowing"&&e.compileExpression(s.end.value,k),s.type==="rows"){switch(s.start.type){case"unboundedPreceding":e.emit(u.Move,U,v,1,null,0,"Frame Start = Partition Start");break;case"preceding":e.emit(u.SeekRel,o,v,L,_,-1,`SeekRel ${o} -> ${v} from ${L} offset ${_} dir -1`),e.emit(u.MaxPtr,v,U,v,null,0,`MaxPtr ${v}, ${U} -> ${v}`);break;case"currentRow":e.emit(u.Move,L,v,1,null,0,"Frame Start = Current Row");break;case"following":e.emit(u.SeekRel,o,v,L,_,1,`SeekRel ${o} -> ${v} from ${L} offset ${_} dir +1`);break;default:throw new Error(`Unhandled ROWS frame start type: ${s.start.type}`)}let F=s.end;if(!F)e.emit(u.Move,L,x,1,null,0,"Default Frame End = Current Row");else switch(F.type){case"unboundedFollowing":e.emit(u.Noop,0,0,0,null,0,"Frame End = Partition End (Placeholder)"),e.emit(u.Null,0,x,1,null,0,"Set Frame End to Partition End (Placeholder)");break;case"preceding":e.emit(u.SeekRel,o,x,L,k,-1,`SeekRel ${o} -> ${x} from ${L} offset ${k} dir -1`),e.emit(u.MaxPtr,x,U,x,null,0,`MaxPtr ${x}, ${U} -> ${x}`);break;case"currentRow":e.emit(u.Move,L,x,1,null,0,"Frame End = Current Row");break;case"following":e.emit(u.SeekRel,o,x,L,k,1,`SeekRel ${o} -> ${x} from ${L} offset ${k} dir +1`);break;default:throw new Error(`Unhandled ROWS frame end type: ${F.type}`)}}else if(s.type==="range"){let F=d,j=t.sortKeyP4.directions.slice(i),P=t.sortKeyP4.collations?.slice(i)??F.map(()=>{}),z={type:"rangescaninfo",frameDef:s,orderByIndices:F,orderByDirs:j,orderByColls:P,currPtrReg:L,partStartPtrReg:U,startBoundReg:_>0?_:void 0,endBoundReg:k>0?k:void 0};e.emit(u.RangeScan,o,v,x,z,0,`Calculate RANGE frame for ${o}`)}else throw new Error(`Unhandled frame type: ${s.type}`);t.windowResultPlaceholders.forEach((F,j)=>{let P=j.function.name.toLowerCase(),z=F.resultReg;switch(P){case"row_number":e.emit(u.Move,w,z,1,null,0,"Store ROW_NUMBER");break;case"rank":e.emit(u.Move,C,z,1,null,0,"Store RANK");break;case"dense_rank":e.emit(u.Move,S,z,1,null,0,"Store DENSE_RANK");break;case"sum":case"avg":case"count":case"min":case"max":if(!s)e.emit(u.Noop,0,0,0,null,0,`WARN: Default frame assumed for ${P}`),e.emit(u.Null,0,z,1,null,0,`Placeholder ${P} (Default Frame)`);else{let T=j.function.args.length>0?t.exprToSorterIndex.get(Re(j.function.args[0])):-1,D=e.db._findFunction(P,j.function.args.length);if(!D)throw new Error(`Window function ${P} not found`);let q={type:"aggframeinfo",funcDef:D,argIdx:T??-1,nArgs:j.function.args.length};e.emit(u.AggFrame,o,z,v,q,x,`AggFrame ${P} -> ${z}`)}break;case"first_value":case"last_value":if(!s)e.emit(u.Noop,0,0,0,null,0,`WARN: Default frame assumed for ${P}`),e.emit(u.Null,0,z,1,null,0,`Placeholder ${P} (Default Frame)`);else{let T=t.exprToSorterIndex.get(Re(j.function.args[0]));if(T===void 0)throw new Error(`${P} argument expression not found in sorter: ${Re(j.function.args[0])}`);let D=P==="first_value"?v:x;e.emit(u.FrameValue,o,z,D,T,0,`FrameValue ${P} -> ${z}`)}break;case"nth_value":e.emit(u.Null,0,z,1,null,0,`Placeholder ${P}`);break;case"lag":case"lead":{let T=j.function.args,D=T[0],q=T.length>1?T[1]:null,Z=T.length>2?T[2]:null,V=t.exprToSorterIndex.get(Re(D));if(V===void 0)throw new Error(`${P} argument expression not found in sorter: ${Re(D)}`);let Y;q?(Y=e.allocateMemoryCells(1),e.compileExpression(q,Y)):(Y=e.allocateMemoryCells(1),e.emit(u.Integer,1,Y,0,null,0,"Default offset 1"));let ee;Z?(ee=e.allocateMemoryCells(1),e.compileExpression(Z,ee)):(ee=e.allocateMemoryCells(1),e.emit(u.Null,0,ee,0,null,0,"Default default NULL"));let ye=P==="lag"?u.Lag:u.Lead,de={type:"lagleadinfo",currRowPtrReg:L,argColIdx:V};e.emit(ye,o,z,Y,de,ee,`${P} -> ${z}`);break}default:e.emit(u.Null,0,z,1,null,0,`Placeholder for Unknown WF ${P}`);break}}),l>0&&e.emit(u.Move,N,b,l,null,0,"Update Prev Order Keys"),e.emit(u.VNext,o,le,0,null,0,"Next Window Row"),e.emit(u.Goto,0,J,0,null,0,"Goto Next Window Calc"),e.resolveAddress(le)}function dm(e){return e.type==="column"&&e.expr?.type==="function"&&e.expr.isAggregate===!0}function hm(e){return e.type==="column"&&e.expr?.type==="windowFunction"}function iu(e,t){if(!t.from||t.from.length===0){mm(e,t);return}let n=t.columns.filter(hm),r=n.length>0,s,o,a=!!t.groupBy&&t.groupBy.length>0,i=t.columns.filter(dm),c=i.length>0,f=c&&!a,d=c||a,l=0,h=[],p=0,g=e.resultColumns,E=e.columnAliases;e.resultColumns=[],e.columnAliases=[];let w=e.compileFromCore(t.from),y=[...w];y.forEach(T=>{let D=e.tableSchemas.get(T);D&&e.planTableAccess(T,D,t,new Set)});let N=!1,b=null;if(t.orderBy&&t.orderBy.length>0&&(y.every(D=>e.cursorPlanningInfo.get(D)?.orderByConsumed??!1)||(N=!0)),r){s=su(e,t),n.length>0&&n[0].expr.window?.frame&&(o=n[0].expr.window.frame);let T=s.cursor,D=e.createEphemeralSchema(T,s.schema.columns.length,s.sortKeyP4);e.emit(u.OpenEphemeral,T,s.schema.columns.length,0,D,0,"Open Window Function Sorter")}let C=0,S=0,O=[],v=0,x=0,L=[],U=e.compileSelectCore(t,w);if(C=U.resultBaseReg,S=U.numCols,O=U.columnMap,r&&s)L=[],t.columns.forEach((T,D)=>{if(T.type==="column"){if(T.expr&&T.expr.type==="windowFunction"){let q=T.expr,Z=s.windowResultPlaceholders.get(q);if(!Z)throw new R(`Internal error: Window function placeholder not found for ${q.function.name}`,I.INTERNAL);L.push({targetReg:Z.resultReg,sourceCursor:-1,sourceColumnIndex:Z.sorterIndex,expr:q})}else if(T.expr){let q=Re(T.expr),Z=s.exprToSorterIndex.get(q);if(Z===void 0)throw new R(`Internal error: SELECT expression ${q} not found in window sorter schema`,I.INTERNAL);L.push({targetReg:e.allocateMemoryCells(1),sourceCursor:s.cursor,sourceColumnIndex:Z,expr:T.expr})}}else if(T.type==="all")throw new R("SELECT * with window functions is not yet supported. Please specify columns explicitly.",I.ERROR)}),x=L.length;else if(d){let T=(t.groupBy?.length??0)+i.length;f&&!a&&(T=i.length),T===0&&a&&(T=t.groupBy.length),T===0&&(T=1),v=e.allocateMemoryCells(T)}else v=C,x=S,L=O;let B=-1,_;if(N){let T=t.orderBy,D=[],q=[];T.forEach(Z=>{let V=L.findIndex(Y=>{let ee=Y.expr?.alias?.toLowerCase(),ye=Z.expr?.alias?.toLowerCase();return ye&&ee===ye?!0:Z.expr.type==="column"&&Y.expr?.type==="column"&&!ye&&!Y.expr?.alias?Z.expr.name.toLowerCase()===Y.expr.name.toLowerCase():JSON.stringify(Z.expr)===JSON.stringify(Y.expr)});if(V===-1)throw new R(`ORDER BY term "${JSON.stringify(Z.expr)}" not found in result columns`);D.push(V),q.push(Z.direction==="desc")}),b={keyIndices:D,directions:q,type:"sortkey"},console.log(`Memory Sort: ${x} cols, keys: ${D.join(",")}, dirs: ${q.join(",")}`),B=e.allocateCursor(),_=e.createEphemeralSchema(B,x,b),e.emit(u.OpenEphemeral,B,x,0,_,0,"Open Ephemeral Sorter")}d&&e.emit(u.AggReset,0,0,0,null,0,"Reset Aggregation Context");let k=0,J=0;if(t.limit)k=e.allocateMemoryCells(1),e.compileExpression(t.limit,k),t.offset?(J=e.allocateMemoryCells(1),e.compileExpression(t.offset,J)):(J=e.allocateMemoryCells(1),e.emit(u.Integer,0,J,0,null,0,"Default OFFSET 0"));else if(t.offset)throw new R("OFFSET requires a LIMIT clause",I.ERROR);let le=[],ae=[],ue=[],Ae=[],Le=new Set,Ye=0,Bt=0;w.forEach((T,D)=>{if(!e.tableSchemas.get(T))throw new R(`Internal error: Schema not found for cursor ${T}`,I.INTERNAL);let Z=e.allocateAddress(),V=e.allocateAddress(),Y=e.allocateAddress();le.push(Z),ae.push(V),ue.push(Y);let ee=au(t.from,D),ye=ee==="left"?e.allocateMemoryCells(1):0;Ae.push(ye),ye>0&&e.emit(u.Integer,0,ye,0,null,0,`Init LEFT JOIN Match Flag [${D}] = 0`);let de=e.cursorPlanningInfo.get(T),X={idxNum:0,idxStr:null,nArgs:0},he=0;if(de&&de.idxNum!==0){let We=[];de.usage.forEach((_t,dr)=>{if(_t.argvIndex>0){let ts=de.constraintExpressions?.get(dr);if(!ts)throw new R(`Internal error: Missing expression for constraint ${dr} used in VFilter`,I.INTERNAL);for(;We.length<_t.argvIndex;)We.push(null);We[_t.argvIndex-1]={constraintIdx:dr,expr:ts}}});let bt=We.filter(_t=>_t!==null);bt.length>0&&(he=e.allocateMemoryCells(bt.length),bt.forEach((_t,dr)=>{let ts=At(e,_t.expr,Le);e.compileExpression(_t.expr,he+dr,ts)})),X={idxNum:de.idxNum,idxStr:de.idxStr,nArgs:bt.length}}if(e.emit(u.VFilter,T,V,he,X,0,`Filter/Scan Cursor ${D}`),e.resolveAddress(Z),e.verifyWhereConstraints(T,Y),D>0){let We=pm(t.from,D-1,D,e);We&&ee!=="cross"&&gm(e,We,w.slice(0,D+1),Y)}if(D>0){let We=D-1,bt=Ae[We];bt>0&&e.emit(u.Integer,1,bt,0,null,0,`Set LEFT JOIN Match Flag [${We}] = 1`)}Le.add(T)}),Bt=e.getCurrentAddress();let F=e.allocateAddress();fn(e,t.where,w,F);let{resultBaseReg:j,numCols:P,columnMap:z}=e.compileSelectCore(t,w);if(P!==S)throw new Error("Internal: Column count mismatch during loop recompilation");if(r&&s){let T=s.dataBaseReg;s.schema.columns.forEach((V,Y)=>{let ee=s.indexToExpression.get(Y);if(ee){let ye=z.find(de=>de.expr&&Re(de.expr)===Re(ee));ye?e.emit(u.Move,ye.targetReg,T+Y,1,null,0,`Move ${Y}: ${Re(ee).substring(0,20)}`):e.emit(u.Null,0,T+Y,1,null,0,`NULL for sorter col ${Y} (expr not found in current row)`)}else e.emit(u.Null,0,T+Y,1,null,0,`NULL placeholder for window result col ${Y}`)});let D=e.allocateMemoryCells(1),q=e.allocateMemoryCells(1);e.emit(u.Null,0,q,0,null,0,"Window Sort: NULL Rowid"),e.emit(u.MakeRecord,T,s.schema.columns.length,D,null,0,"Make Window Sort Record");let Z=e.allocateMemoryCells(s.schema.columns.length+1);e.emit(u.Move,q,Z,1,null,0,"Copy rowid for insert"),e.emit(u.Move,T,Z+1,s.schema.columns.length,null,0,"Copy data for insert"),e.emit(u.VUpdate,s.schema.columns.length+1,Z,s.cursor,{table:s.schema},0,"Insert Row into Window Sorter")}else if(d){let T=0,D=0,q=0;a?(D=t.groupBy.length,T=e.allocateMemoryCells(D),t.groupBy.forEach((Z,V)=>{e.compileExpression(Z,T+V)}),q=e.allocateMemoryCells(1),e.emit(u.MakeRecord,T,D,q,null,0,"Make GROUP BY Key")):(q=e.allocateMemoryCells(1),e.emit(u.Integer,0,q,0,null,0,"Use constant key 0 for simple aggregate")),i.forEach(Z=>{let V=Z.expr,Y=e.db._findFunction(V.name,V.args.length);if(!Y)throw new Error("Aggregate function definition disappeared?");let ee=e.allocateMemoryCells(V.args.length||1);V.args.forEach((de,X)=>{e.compileExpression(de,ee+X)});let ye={type:"funcdef",funcDef:Y,nArgs:V.args.length};e.emit(u.AggStep,T,ee,q,ye,D,`AggStep for ${V.name}`)})}else{let T=e.allocateAddress();if(k>0){let D=e.allocateAddress();e.emit(u.IfZero,J,D,0,null,0,"Check Offset == 0"),e.emit(u.Subtract,1,J,J,null,0,"Decrement Offset"),e.emit(u.Goto,0,T,0,null,0,"Skip Row (Offset)"),e.resolveAddress(D)}if(N){let D=e.allocateMemoryCells(x+1);e.emit(u.Null,0,D,0,null,0,"Sort: NULL Rowid for Eph Insert"),e.emit(u.Move,j,D+1,x,null,0,"Sort: Copy result to Eph Insert Data"),e.emit(u.VUpdate,x+1,D,B,{table:_},0,"Sort: Insert Row into Ephemeral")}else if(e.emit(u.ResultRow,j,x,0,null,0,"Output result row"),k>0){let D=e.allocateAddress();e.emit(u.IfZero,k,D,0,null,0,"Skip Limit Check if already 0"),e.emit(u.Subtract,1,k,k,null,0,"Decrement Limit"),e.emit(u.IfZero,k,ae[0],0,null,0,"Check Limit Reached"),e.resolveAddress(D)}e.resolveAddress(T)}Ye=e.getCurrentAddress()+2,e.emit(u.Goto,0,Ye,0,null,0,"Goto Innermost VNext"),e.resolveAddress(F),e.emit(u.Goto,0,Ye,0,null,0,"WHERE Failed, Goto VNext");for(let T=w.length-1;T>=0;T--){let D=w[T],q=le[T],Z=ae[T],V=ue[T],Y=Ae[T];e.resolveAddress(V);let ee=e.getCurrentAddress();if(T===w.length-1&&(e.resolveAddress(Ye-2),e.resolveAddress(Ye-1),Ye=ee),e.emit(u.VNext,D,Z,0,null,0,`VNext Cursor ${T}`),e.emit(u.Goto,0,q,0,null,0,`Goto LoopStart ${T}`),e.resolveAddress(Z),au(t.from,T)==="left"&&Y>0){let de=e.allocateAddress();if(e.emit(u.IfTrue,Y,de,0,null,0,`LEFT JOIN EOF: Skip NULL pad if match found [${T}]`),O.forEach(X=>{X.sourceCursor===D&&e.emit(u.Null,0,X.targetReg,0,null,0,`LEFT JOIN EOF: NULL Pad Col ${X.sourceColumnIndex} from Cursor ${D}`)}),T>0){let X=Ae[T-1];X>0&&e.emit(u.Integer,1,X,0,null,0,`Set LEFT JOIN Match Flag [${T-1}] = 1 (due to NULL pad EOF)`)}e.emit(u.Goto,0,Bt,0,null,0,`LEFT JOIN EOF: Process NULL-padded row [${T}]`),e.resolveAddress(de)}Y>0&&e.emit(u.Integer,0,Y,0,null,0,`Reset LEFT JOIN Match Flag [${T}] before outer VNext/EOF`),Le.delete(D)}if(r&&s){e.emit(u.Sort,s.cursor,0,0,null,0,"Sort Window Function Data");let T=e.allocateMemoryCells(L.length),D=e.allocateAddress(),q=e.allocateAddress();ou(e,s,T,L.length,o),e.emit(u.Rewind,s.cursor,q,0,null,0,"Rewind Window Sorter for Output"),e.resolveAddress(D),L.forEach((V,Y)=>{if(V.expr?.type==="windowFunction"){let ee=s.windowResultPlaceholders.get(V.expr);if(!ee)throw new R(`Internal error: Window placeholder not found for output column ${Y}`,I.INTERNAL);e.emit(u.Move,ee.resultReg,T+Y,1,null,0,`Move window result to output ${Y}`)}else{let ee=V.sourceColumnIndex;e.emit(u.VColumn,s.cursor,ee,T+Y,null,0,`Read sorter col ${ee} to output ${Y}`)}});let Z=e.allocateAddress();if(k>0){let V=e.allocateAddress();e.emit(u.IfZero,J,V,0,null,0,"Window: Check Offset == 0"),e.emit(u.Subtract,1,J,J,null,0,"Window: Decrement Offset"),e.emit(u.Goto,0,Z,0,null,0,"Window: Skip Row (Offset)"),e.resolveAddress(V)}if(e.emit(u.ResultRow,T,L.length,0,null,0,"Output Window Function Row"),k>0){let V=e.allocateAddress();e.emit(u.IfZero,k,V,0,null,0,"Window: Skip Limit Check if 0"),e.emit(u.Subtract,1,k,k,null,0,"Window: Decrement Limit"),e.emit(u.IfZero,k,q,0,null,0,"Window: Check Limit Reached"),e.resolveAddress(V)}e.resolveAddress(Z),e.emit(u.VNext,s.cursor,q,0,null,0,"Next Window Row"),e.emit(u.Goto,0,D,0,null,0,"Window Loop"),e.resolveAddress(q),e.emit(u.Close,s.cursor,0,0,null,0,"Close Window Sorter")}if(d&&!r){let T=e.allocateAddress(),D=e.allocateAddress(),q=e.allocateMemoryCells(1),Z=e.allocateMemoryCells(1),V=e.allocateMemoryCells(1);L=[];let Y=v;a&&t.groupBy.forEach((X,he)=>{L.push({targetReg:Y++,sourceCursor:-1,sourceColumnIndex:-1,expr:X})}),i.forEach(X=>{L.push({targetReg:Y++,sourceCursor:-1,sourceColumnIndex:-1,expr:X.expr})}),x=L.length,x===0&&!a&&(x=1),e.columnAliases=L.map((X,he)=>X.expr?.alias??(X.expr?.type==="column"?X.expr.name:`col${he}`)),e.emit(u.AggIterate,q,0,0,null,0,"Start Aggregate Result Iteration"),e.resolveAddress(T),e.emit(u.AggNext,q,D,0,null,0,"Next Aggregate Group"),e.emit(u.AggKey,q,Z,0,null,0,"Get Group Key"),e.emit(u.AggContext,q,V,0,null,0,"Get Aggregate Context");let ee=0,ye=0;L.forEach(X=>{if(X.expr?.type==="function"&&X.expr.isAggregate){let he=X.expr,bt={type:"funcdef",funcDef:e.db._findFunction(he.name,he.args.length),nArgs:he.args.length};e.emit(u.AggFinal,V,0,X.targetReg,bt,0,`AggFinal for ${he.name}`),ye++}else if(a)e.emit(u.AggGroupValue,q,ee,X.targetReg,null,0,`Output Group Key ${ee}`),ee++;else throw new Error("Internal: Unexpected column type in aggregate output loop")});let de=e.allocateAddress();if(t.having){let X=e.allocateMemoryCells(1),he={finalColumnMap:L};e.compileExpression(t.having,X,void 0,he),e.emit(u.IfFalse,X,de,0,null,0,"Check HAVING Clause")}if(N){let X=e.allocateMemoryCells(x+1);e.emit(u.Null,0,X,0,null,0,"Agg Sort: NULL Rowid"),e.emit(u.Move,v,X+1,x,null,0,"Agg Sort: Copy group result"),e.emit(u.VUpdate,x+1,X,B,{table:_},0,"Agg Sort: Insert Group Row")}else{let X=e.allocateAddress();if(k>0){let he=e.allocateAddress();e.emit(u.IfZero,J,he,0,null,0,"Agg Check Offset == 0"),e.emit(u.Subtract,1,J,J,null,0,"Agg Decrement Offset"),e.emit(u.Goto,0,X,0,null,0,"Agg Skip Row (Offset)"),e.resolveAddress(he)}if(e.emit(u.ResultRow,v,x,0,null,0,"Output Aggregate Group Row"),k>0){let he=e.allocateAddress();e.emit(u.IfZero,k,he,0,null,0,"Agg Skip Limit Check if 0"),e.emit(u.Subtract,1,k,k,null,0,"Agg Decrement Limit"),e.emit(u.IfZero,k,D,0,null,0,"Agg Check Limit Reached"),e.resolveAddress(he)}e.resolveAddress(X)}e.resolveAddress(de),e.emit(u.Goto,0,T,0,null,0,"Loop Aggregate Results"),e.resolveAddress(D)}if(N&&!r){let T=e.allocateAddress(),D=e.allocateAddress(),q=e.allocateMemoryCells(x);e.emit(u.Rewind,B,D,0,null,0,"Rewind Sorter"),e.resolveAddress(T);let Z=e.allocateAddress();if(k>0){let V=e.allocateAddress();e.emit(u.IfZero,J,V,0,null,0,"Sort Check Offset == 0"),e.emit(u.Subtract,1,J,J,null,0,"Sort Decrement Offset"),e.emit(u.Goto,0,Z,0,null,0,"Sort Skip Row (Offset)"),e.resolveAddress(V)}for(let V=0;V<x;V++)e.emit(u.VColumn,B,V,q+V,0,0,`Read Sorted Col ${V}`);if(e.emit(u.ResultRow,q,x,0,null,0,"Output sorted row"),k>0){let V=e.allocateAddress();e.emit(u.IfZero,k,V,0,null,0,"Sort Skip Limit Check if already 0"),e.emit(u.Subtract,1,k,k,null,0,"Sort Decrement Limit"),e.emit(u.IfZero,k,D,0,null,0,"Sort Check Limit Reached"),e.resolveAddress(V)}e.resolveAddress(Z),e.emit(u.VNext,B,D,0,null,0,"VNext Sorter"),e.emit(u.Goto,0,T,0,null,0,"Loop Sorter Results"),e.resolveAddress(D),e.emit(u.Close,B,0,0,null,0,"Close Sorter")}N||e.closeCursorsUsedBySelect(w),e.resultColumns=g,e.columnAliases=E}function mm(e,t){let{resultBaseReg:n,numCols:r,columnMap:s}=e.compileSelectCore(t,[]);if(e.columnAliases=s.map((o,a)=>o.expr?.alias??(o.expr?.type==="column"?o.expr.name:`col${a}`)),t.where){let o=e.allocateMemoryCells(1),a=e.allocateAddress();e.compileExpression(t.where,o),e.emit(u.IfFalse,o,a,0,null,0,"Check WHERE for constant SELECT"),e.emit(u.ResultRow,n,r,0,null,0,"Output constant result row"),e.resolveAddress(a)}else e.emit(u.ResultRow,n,r,0,null,0,"Output constant result row")}function lu(e,t,n,r,s){let o=e.resultColumns,a=e.columnAliases;e.resultColumns=[],e.columnAliases=[];let i=new Set;t.from?.forEach(E=>{let w=y=>{if(y.type==="table"){let N=(y.alias||y.table.name).toLowerCase(),b=e.tableAliases.get(N);b!==void 0&&i.add(b)}else y.type==="join"&&(w(y.left),w(y.right))};w(E)});let c=new Set([...n,...i]),f=0;t.columns.some(E=>E.type==="all")&&c.forEach(E=>{let w=e.tableSchemas.get(E),y=[...e.tableAliases.entries()].find(([,b])=>b===E)?.[0],N=t.columns.find(b=>b.type==="all"&&b.table&&(b.table.toLowerCase()===w?.name.toLowerCase()||b.table.toLowerCase()===y?.toLowerCase()));w&&(!N||N.table)&&(f+=w?.columns.filter(b=>!b.hidden).length||0)}),f+=t.columns.filter(E=>E.type==="column").length,f===0&&(f=1);let l=e.allocateMemoryCells(f),h=0,p=[],g=l;for(let E of t.columns)if(E.type==="all")c.forEach(w=>{let y=e.tableSchemas.get(w),N=[...e.tableAliases.entries()].find(([,b])=>b===w)?.[0];y&&(!E.table||E.table.toLowerCase()===N?.toLowerCase()||E.table.toLowerCase()===y.name.toLowerCase())&&y.columns.forEach(b=>{if(!b.hidden){let C=g++,S=y.columnIndexMap.get(b.name.toLowerCase());if(S===void 0&&b.name.toLowerCase()!=="rowid")e.emit(u.Null,0,C,0,null,0,`Expand *: Col ${b.name} Idx Error`),p.push({targetReg:C,sourceCursor:w,sourceColumnIndex:-1});else{e.emit(u.VColumn,w,S??-1,C,0,0,`Expand *: ${N||y.name}.${b.name}`);let v={type:"column",name:b.name,table:N||y.name};p.push({targetReg:C,sourceCursor:w,sourceColumnIndex:S??-1,expr:v})}let O=`${N||y.name}.${b.name}`;e.resultColumns.push({name:O}),e.columnAliases.push(O),h++}})});else if(E.expr){let w=g++;e.compileExpression(E.expr,w,r,void 0,s);let y=-1,N=-1;if(E.expr.type==="column"){let C=E.expr;if(C.table)y=e.tableAliases.get(C.table.toLowerCase())??-1;else for(let S of c)if(e.tableSchemas.get(S)?.columnIndexMap.has(C.name.toLowerCase())){if(y!==-1){y=-1,N=-1;break}y=S}y!==-1&&(N=e.tableSchemas.get(y)?.columnIndexMap.get(C.name.toLowerCase())??-1)}p.push({targetReg:w,sourceCursor:y,sourceColumnIndex:N,expr:E.expr});let b=E.alias||(E.expr.type==="column"?E.expr.name:`col${h+1}`);e.columnAliases.push(b),e.resultColumns.push({name:b,expr:E.expr}),h++}return e.resultColumns=o,e.columnAliases=a,{resultBaseReg:l,numCols:h,columnMap:p}}function pm(e,t,n,r){if(!e||e.length!==1||e[0].type!=="join")return;let s=(o,a)=>{if(o.type==="table")return{node:null,nextLevel:a+1};if(o.type==="join"){let i=s(o.left,a);if(i.node)return i;let c=s(o.right,i.nextLevel);return c.node?c:i.nextLevel-1===t&&c.nextLevel-1===n?{node:o,nextLevel:c.nextLevel}:{node:null,nextLevel:c.nextLevel}}else throw new Error("Invalid node type in FROM clause during join node search")};return s(e[0],0).node??void 0}function au(e,t){if(t===0||!e||e.length===0)return;let n=(s,o)=>{if(s.type==="table")return{joinNode:null,nextLevel:o+1};if(s.type==="join"){let a=n(s.left,o);if(a.joinNode)return a;let i=n(s.right,a.nextLevel);return i.joinNode?i:i.nextLevel-1===t?{joinNode:s,nextLevel:i.nextLevel}:{joinNode:null,nextLevel:i.nextLevel}}else throw new Error("Invalid node type in FROM clause during join type search")};return e.length>1?"cross":n(e[0],0).joinNode?.joinType}function gm(e,t,n,r){if(n.length<2)throw new Error("Internal: compileJoinCondition called with insufficient active cursors.");let s=n[n.length-2],o=n[n.length-1];if(t.condition){let a=e.allocateMemoryCells(1);e.compileExpression(t.condition,a),e.emit(u.IfFalse,a,r,0,null,0,"JOIN: Check ON Condition")}else if(t.columns){let a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1),c=e.allocateMemoryCells(1),f=e.tableSchemas.get(s),d=e.tableSchemas.get(o);if(!f||!d)throw new Error("Internal: Schema not found for USING clause cursors.");for(let l of t.columns){let h=f.columnIndexMap.get(l.toLowerCase()),p=d.columnIndexMap.get(l.toLowerCase());if(h===void 0||p===void 0)throw new R(`Column '${l}' specified in USING clause not found in both tables.`,I.ERROR);e.emit(u.VColumn,s,h,i,0,0,`USING(${l}) Left`),e.emit(u.VColumn,o,p,c,0,0,`USING(${l}) Right`);let g=e.allocateAddress(),E=e.allocateAddress(),w=e.allocateMemoryCells(1);e.emit(u.IfNull,i,E,0,null,0,"USING: Skip if left NULL"),e.emit(u.IfNull,c,E,0,null,0,"USING: Skip if right NULL"),e.emit(u.Eq,i,g,c,null,0,`USING Compare ${l}`),e.emit(u.Integer,0,w,0,null,0),e.emit(u.Goto,0,E,0,null,0),e.resolveAddress(g),e.emit(u.Integer,1,w,0,null,0),e.resolveAddress(E),e.emit(u.IfFalse,w,r,0,null,0,`USING: Jump if ${l} not equal`)}}}function uu(e,t,n){console.warn("compileSubquery assuming scalar context. EXISTS/IN should be handled by parent expression compiler."),e.compileScalarSubquery(t.query,n)}function cu(e,t,n){let r=new Set(e.tableAliases.values()),s=At(e,t,r);s.isCorrelated?fu(e,t,n,s):ym(e,t,n)}function ym(e,t,n){if(t.columns.length!==1||t.columns[0].type==="all")throw new R("Scalar subquery must return exactly one column (cannot be *)",I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let r=e.allocateMemoryCells(1),s=e.allocateAddress(),o=e.allocateAddress(),a=e.allocateAddress(),i=e.allocateAddress(),c=e.allocateAddress();e.emit(u.Integer,0,r,0,null,0,"Init Subquery: hasRow=0");let f=[],{resultBaseReg:d,numCols:l}=e.compileSelectCore(t,f);if(l!==1)throw new Error("Scalar Subquery core compile error: Expected 1 column");let h=f[0];h===void 0?(e.emit(u.Integer,1,r,0,null,0,"Subquery: Set hasRow=1 (literal)"),e.emit(u.SCopy,d,n,0,null,0,"Subquery: Copy literal result"),e.emit(u.Goto,0,i,0,null,0,"Subquery: Finish (literal)")):(e.emit(u.VFilter,h,o,0,{idxNum:0,idxStr:null,nArgs:0},0,"Subquery: Start scan"),e.resolveAddress(s),e.emit(u.IfTrue,r,a,0,null,0,"Subquery: Check if >1 row"),e.emit(u.Integer,1,r,0,null,0,"Subquery: Set hasRow=1"),e.emit(u.SCopy,d,n,0,null,0,"Subquery: Copy row result"),e.emit(u.VNext,h,o,0,null,0,"Subquery: VNext"),e.emit(u.Goto,0,s,0,null,0,"Subquery: Loop"),e.resolveAddress(o)),e.closeCursorsUsedBySelect(f),e.emit(u.IfFalse,r,c,0,null,0,"Subquery: Check if hasRow is false (0 rows)"),e.emit(u.Goto,0,i,0,null,0,"Subquery: Finish (1 row)"),e.resolveAddress(a),e.emit(u.Halt,I.ERROR,0,0,"Scalar subquery returned more than one row",0,"Error: Subquery >1 row"),e.resolveAddress(c),e.emit(u.Null,0,n,0,null,0,"Subquery: Set NULL Result (0 rows)"),e.resolveAddress(i)}function fu(e,t,n,r){let s=e.subroutineDefs?.get(t);if(!s){e.startSubroutineCompilation();let p=e.getCurrentAddress(),g=2,E=3,w=4,y=4,N=new Map;r.correlatedColumns.forEach((k,J)=>{let le=-(J+1);N.set(`${k.outerCursor}.${k.outerColumnIndex}`,le)});let b=[],{resultBaseReg:C,numCols:S}=e.compileSelectCore(t,b,r,N);if(S!==1)throw new R("Correlated scalar subquery must return one column",I.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column);let O=e.allocateAddress(),v=e.allocateAddress(),x=e.allocateAddress(),L=e.allocateAddress(),U=e.allocateAddress(),B=b[0];e.emit(u.Integer,0,E,0,null,0,"Sub: Init hasRow=0"),e.emit(u.Integer,0,w,0,null,0,"Sub: Init error=0");let _=e.allocateAddress();B!==void 0?(e.emit(u.VFilter,B,v,0,{idxNum:0,idxStr:null,nArgs:0},0,"Sub: Start scan"),e.resolveAddress(O),e.emit(u.IfTrue,w,_,0,null,0,"Sub: Skip if error already set"),e.emit(u.IfTrue,E,x,0,null,0,"Sub: Check if >1 row"),e.emit(u.Integer,1,E,0,null,0,"Sub: Set hasRow=1"),e.emit(u.SCopy,C,g,0,null,0,"Sub: Copy first row result"),e.emit(u.Goto,0,_,0,null,0),e.resolveAddress(x),e.emit(u.Integer,1,w,0,null,0,"Sub: Set error=1 (>1 row)"),e.emit(u.Null,0,g,0,null,0,"Sub: Set NULL on >1 row error"),e.resolveAddress(_),e.emit(u.VNext,B,v,0,null,0,"Sub: VNext"),e.emit(u.Goto,0,O,0,null,0,"Sub: Loop")):(e.emit(u.Integer,1,E,0,null,0,"Sub: Set hasRow=1 (literal)"),e.emit(u.SCopy,C,g,0,null,0,"Sub: Copy literal result"),e.emit(u.Goto,0,L-1,0,null,0)),e.resolveAddress(v),e.closeCursorsUsedBySelect(b),e.resolveAddress(e.getCurrentAddress()),e.emit(u.IfTrue,w,L,0,null,0,"Sub: Jump if error flag set"),e.emit(u.IfFalse,E,U,0,null,0,"Sub: Check if hasRow is false (0 rows)"),e.emit(u.Goto,0,L,0,null,0,"Sub: Finish (1 row, no error)"),e.resolveAddress(U),e.emit(u.Null,0,g,0,null,0,"Sub: Set NULL result (0 rows)"),e.resolveAddress(L),e.emit(u.SCopy,g,-1,0,null,0,"Sub: Store result in Arg FP[-1]"),e.emit(u.SCopy,w,-2,0,null,0,"Sub: Store error in Arg FP[-2]"),e.emit(u.FrameLeave,0,0,0,null,0,"Leave Subroutine Frame"),e.emit(u.Return,0,0,0,null,0,"Return from subquery"),s={startAddress:p,correlation:r},e.subroutineDefs?.set(t,s),e.endSubroutineCompilation()}let o=r.correlatedColumns.length,a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1);r.correlatedColumns.forEach(p=>{let g=e.allocateMemoryCells(1),E=[...e.tableAliases.entries()].find(([b,C])=>C===p.outerCursor)?.[0],w=e.tableSchemas.get(p.outerCursor);if(!w)throw new Error(`Internal: Schema for outer cursor ${p.outerCursor} not found`);let y=w.columns[p.outerColumnIndex]?.name;if(!y)throw new Error(`Internal: Column index ${p.outerColumnIndex} not found for outer cursor ${p.outerCursor}`);let N={type:"column",name:y,table:E};e.compileExpression(N,g),e.emit(u.Push,g,0,0,null,0,`Push outer val ${y}`)}),e.emit(u.Push,0,0,0,null,0,"Push placeholder for Sub Error Status"),e.emit(u.Push,0,0,0,null,0,"Push placeholder for Sub Result");let c=o+2;e.emit(u.Subroutine,c,s.startAddress,0,null,0,"Call correlated subquery");let f=e.stackPointer-1,d=e.stackPointer-2;e.emit(u.SCopy,f,a,0,null,0,`Copy sub result from stack[${f}]`),e.emit(u.SCopy,d,i,0,null,0,`Copy sub error from stack[${d}]`),e.emit(u.StackPop,c,0,0,null,0,"Pop subquery args/results");let l=e.allocateAddress(),h=e.allocateAddress();e.emit(u.IfZero,i,l,0,null,0,"Check subquery error flag"),e.emit(u.Halt,I.ERROR,0,0,"Correlated scalar subquery returned multiple rows",0,"Error: Subquery >1 row"),e.resolveAddress(l),e.emit(u.SCopy,a,n,0,null,0,"Copy final subquery result"),e.resolveAddress(h)}function du(e,t,n,r,s){if(n.columns.length!==1||n.columns[0].type==="all")throw new R("Subquery for IN operator must return exactly one column (cannot be *)",I.ERROR,void 0,n.loc?.start.line,n.loc?.start.column);let o=At(e,n,new Set(e.tableAliases.values()));o.isCorrelated?Im(e,t,n,r,s,o):wm(e,t,n,r,s)}function wm(e,t,n,r,s){let o=e.allocateMemoryCells(1),a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1),c=e.allocateMemoryCells(1),f=e.allocateCursor(),d=e.allocateAddress(),l=e.allocateAddress(),h=e.allocateAddress(),p=e.allocateAddress(),g=e.allocateAddress(),E=e.allocateAddress(),w=e.allocateAddress(),y=e.allocateAddress();e.emit(u.Integer,0,i,0,null,0,"IN: Init hasNull=0"),e.emit(u.Integer,0,c,0,null,0,"IN: Init matchFound=0"),e.compileExpression(t,o),e.emit(u.IfNull,o,E,0,null,0,"IN: Check if Left Expr is NULL (early exit)"),e.emit(u.OpenEphemeral,f,1,0,null,0,"IN: Open Ephemeral Table");let N=e.createEphemeralSchema(f,1),b=[],{resultBaseReg:C,numCols:S}=e.compileSelectCore(n,b);if(S!==1)throw new Error("IN Subquery core compile error");let O=b[0],v=e.allocateAddress(),x=e.allocateAddress(),L=e.allocateMemoryCells(2);O===void 0?(e.emit(u.IfNull,C,w,0,null,0,"IN: Check literal NULL"),e.emit(u.Null,0,L,0,null,0),e.emit(u.SCopy,C,L+1,0,null,0),e.emit(u.VUpdate,2,L,0,{table:N},0,"IN: Insert literal"),e.emit(u.Goto,0,y,0,null,0),e.resolveAddress(w),e.emit(u.Integer,1,i,0,null,0,"IN: Set hasNull=1 (literal)"),e.resolveAddress(y)):(e.emit(u.VFilter,O,x,0,{idxNum:0,idxStr:null,nArgs:0},0,"IN: Subquery Scan Start"),e.resolveAddress(v),e.emit(u.IfNull,C,w,0,null,0,"IN: Check subquery NULL"),e.emit(u.Null,0,L,0,null,0,"IN: Prep Insert Rowid"),e.emit(u.SCopy,C,L+1,0,null,0,"IN: Prep Insert Value"),e.emit(u.VUpdate,2,L,0,{table:N},0,"IN: Insert subquery result"),e.emit(u.Goto,0,y,0,null,0),e.resolveAddress(w),e.emit(u.Integer,1,i,0,null,0,"IN: Set hasNull=1"),e.resolveAddress(y),e.emit(u.VNext,O,x,0,null,0,"IN: Subquery VNext"),e.emit(u.Goto,0,v,0,null,0,"IN: Subquery Loop"),e.resolveAddress(x)),e.closeCursorsUsedBySelect(b),e.emit(u.Rewind,f,p,0,null,0,"IN: Rewind Ephemeral Table"),e.resolveAddress(d),e.emit(u.VColumn,f,0,a,0,0,"IN: Get value from Ephemeral"),e.emit(u.Eq,o,h,a,null,0,"IN: Compare values (jump if EQ)"),e.resolveAddress(l),e.emit(u.VNext,f,p,0,null,0,"IN: VNext Ephemeral"),e.emit(u.Goto,0,d,0,null,0,"IN: Loop Ephemeral Scan"),e.resolveAddress(h),e.emit(u.IfNull,o,E,0,null,0,"IN: If left was NULL, result is NULL"),e.emit(u.IfNull,a,E,0,null,0,"IN: If matching eph val was NULL, result is NULL"),e.emit(u.Integer,1,c,0,null,0,"IN: Set matchFound=1"),e.emit(u.Goto,0,p,0,null,0,"IN: Jump to end (match found)"),e.resolveAddress(p),e.closeCursorsUsedBySelect([f]);let U=s?0:1,B=s?1:0,_=e.allocateAddress(),k=e.allocateAddress();e.emit(u.IfTrue,c,k,0,null,0),e.emit(u.IfTrue,i,E,0,null,0,"IN: Check if NULL present (no match)"),e.resolveAddress(_),e.emit(u.Integer,B,r,0,null,0,`IN: Set Final Result (${B})`),e.emit(u.Goto,0,g,0,null,0,"IN: Jump to final"),e.resolveAddress(k),e.emit(u.Integer,U,r,0,null,0,`IN: Set Final Result (${U})`),e.emit(u.Goto,0,g,0,null,0),e.resolveAddress(E),e.emit(u.Null,0,r,0,null,0,"IN: Set NULL Result"),e.resolveAddress(g)}function Im(e,t,n,r,s,o){let a=e.subroutineDefs?.get(n);if(!a){e.startSubroutineCompilation();let h=e.getCurrentAddress(),p=2,g=3,E=4,w=new Map;w.set("_caller_left_expr_",-1),o.correlatedColumns.forEach((ae,ue)=>{w.set(`${ae.outerCursor}.${ae.outerColumnIndex}`,-(ue+2))});let y=[],{resultBaseReg:N,numCols:b}=e.compileSelectCore(n,y,o,w);if(b!==1)throw new R("Correlated IN subquery requires 1 column",I.INTERNAL,void 0,n.loc?.start.line,n.loc?.start.column);let C=e.allocateAddress(),S=e.allocateAddress(),O=e.allocateAddress(),v=e.allocateAddress(),x=e.allocateAddress(),L=e.allocateAddress(),U=y[0];if(e.emit(u.Integer,0,p,0,null,0,"SubIN: Init match=0"),e.emit(u.Integer,0,g,0,null,0,"SubIN: Init hasNull=0"),U!==void 0)e.emit(u.VFilter,U,S,0,{idxNum:0,idxStr:null,nArgs:0},0,"SubIN: Start scan"),e.resolveAddress(C),e.emit(u.SCopy,N,E,0,null,0,"SubIN: Get subquery value"),e.emit(u.IfNull,E,v,0,null,0,"SubIN: Check if subquery value is NULL"),e.emit(u.Eq,-1,O,E,null,0,"SubIN: Compare with Arg (Jump if EQ)"),e.emit(u.Goto,0,x,0,null,0),e.resolveAddress(v),e.emit(u.Integer,1,g,0,null,0,"SubIN: Set hasNull=1"),e.emit(u.Goto,0,x,0,null,0),e.resolveAddress(O),e.emit(u.Integer,1,p,0,null,0,"SubIN: Set match=1"),e.resolveAddress(x),e.emit(u.VNext,U,S,0,null,0,"SubIN: VNext"),e.emit(u.Goto,0,C,0,null,0,"SubIN: Loop");else{e.emit(u.SCopy,N,E,0,null,0,"SubIN: Get literal subquery value");let ae=e.allocateAddress(),ue=e.allocateAddress();e.emit(u.IfNull,E,ae,0,null,0),e.emit(u.Eq,-1,ue,E,null,0),e.emit(u.Goto,0,S,0,null,0),e.resolveAddress(ue),e.emit(u.Integer,1,p,0,null,0),e.emit(u.Goto,0,S,0,null,0),e.resolveAddress(ae),e.emit(u.Integer,1,g,0,null,0)}e.resolveAddress(S),e.closeCursorsUsedBySelect(y);let B=s?0:1,_=s?1:0,k=e.allocateAddress(),J=e.allocateAddress(),le=e.allocateAddress();e.emit(u.IfTrue,p,le,0,null,0),e.emit(u.IfTrue,g,J,0,null,0),e.resolveAddress(k),e.emit(u.Integer,_,-1,0,null,0,"SubIN: Set Final False/True"),e.emit(u.Goto,0,J+1,0,null,0),e.resolveAddress(le),e.emit(u.Integer,B,-1,0,null,0,"SubIN: Set Final True/False"),e.emit(u.Goto,0,J,0,null,0),e.resolveAddress(J),e.emit(u.Null,0,-1,0,null,0,"SubIN: Set Final NULL"),e.resolveAddress(e.getCurrentAddress()),e.emit(u.FrameLeave,0,0,0,null,0,"Leave SubIN Frame"),e.emit(u.Return,0,0,0,null,0,"Return from SubIN"),a={startAddress:h,correlation:o},e.subroutineDefs?.set(n,a),e.endSubroutineCompilation()}let i=e.allocateMemoryCells(1),c=e.allocateAddress(),f=e.allocateAddress();e.compileExpression(t,i),e.emit(u.IfNull,i,c,0,null,0,"IN: Check if Left Expr is NULL");let d=0;o.correlatedColumns.forEach((h,p)=>{let g=e.allocateMemoryCells(1),E=[...e.tableAliases.entries()].find(([N,b])=>b===h.outerCursor)?.[0],w=e.tableSchemas.get(h.outerCursor);if(!w)throw new Error(`Schema ${h.outerCursor} not found`);let y=w.columns[h.outerColumnIndex]?.name;if(!y)throw new Error(`Col ${h.outerColumnIndex} not found`);e.compileExpression({type:"column",name:y,table:E},g),e.emit(u.Push,g,0,0,null,0,`Push outer val ${y}`),d++}),e.emit(u.Push,i,0,0,null,0,"Push Left Value for SubIN"),d++,e.emit(u.Subroutine,d,a.startAddress,0,null,0,"Call SubIN");let l=e.stackPointer-1;e.emit(u.SCopy,l,r,0,null,0,"Copy SubIN result from stack"),e.emit(u.StackPop,d,0,0,null,0,"Pop SubIN args"),e.emit(u.Goto,0,f,0,null,0),e.resolveAddress(c),e.emit(u.Null,0,r,0,null,0,"IN: Set NULL Result"),e.resolveAddress(f)}function hu(e,t,n,r,s){let o=At(e,r,new Set(e.tableAliases.values()));o.isCorrelated?Nm(e,t,n,r,s,o):Rm(e,t,n,r,s)}function Rm(e,t,n,r,s){let o=e.allocateMemoryCells(1),a=e.allocateMemoryCells(1),i=e.allocateAddress(),c=e.allocateAddress(),f=e.allocateAddress(),d;switch(e.compileExpression(t,o),e.emit(u.IfNull,o,i,0,null,0,"Skip compare if left is NULL"),e.compileScalarSubquery(r,a),e.emit(u.IfNull,a,i,0,null,0,"Skip compare if subquery is NULL"),n.toUpperCase()){case"=":case"==":case"IS":d=u.Eq;break;case"!=":case"<>":case"IS NOT":d=u.Ne;break;case"<":d=u.Lt;break;case"<=":d=u.Le;break;case">":d=u.Gt;break;case">=":d=u.Ge;break;default:throw new R(`Unsupported comparison operator with subquery: ${n}`,I.ERROR,void 0,r.loc?.start.line,r.loc?.start.column)}e.emit(d,a,c,o,null,0,"Compare Subquery Result"),e.emit(u.Integer,0,s,0,null,0,"Set comparison FALSE"),e.emit(u.Goto,0,f,0,null,0),e.resolveAddress(c),e.emit(u.Integer,1,s,0,null,0,"Set comparison TRUE"),e.emit(u.Goto,0,f,0,null,0),e.resolveAddress(i),e.emit(u.Null,0,s,0,null,0,"Set comparison NULL"),e.resolveAddress(f)}function Nm(e,t,n,r,s,o){let a=e.subroutineDefs?.get(r);if(!a){let y=e.allocateMemoryCells(1);if(fu(e,r,y,o),a=e.subroutineDefs?.get(r),!a)throw new Error("Internal: Failed to compile correlated scalar subquery subroutine.")}let i=e.allocateMemoryCells(1),c=e.allocateMemoryCells(1),f=e.allocateMemoryCells(1),d=e.allocateAddress(),l=e.allocateAddress(),h=e.allocateAddress();e.compileExpression(t,i),e.emit(u.IfNull,i,d,0,null,0,"Skip compare if left is NULL");let p=0;o.correlatedColumns.forEach(y=>{let N=e.allocateMemoryCells(1),b=[...e.tableAliases.entries()].find(([O,v])=>v===y.outerCursor)?.[0],C=e.tableSchemas.get(y.outerCursor);if(!C)throw new Error(`Schema ${y.outerCursor} not found`);let S=C.columns[y.outerColumnIndex]?.name;if(!S)throw new Error(`Col ${y.outerColumnIndex} not found`);e.compileExpression({type:"column",name:S,table:b},N),e.emit(u.Push,N,0,0,null,0,`Push outer val ${S}`),p++}),e.emit(u.Push,0,0,0,null,0,"Push placeholder for Sub Error Status"),p++,e.emit(u.Push,0,0,0,null,0,"Push placeholder for Sub Result"),p++,e.emit(u.Subroutine,p,a.startAddress,0,null,0,"Call correlated subquery for comparison");let g=e.stackPointer-1,E=e.stackPointer-2;e.emit(u.SCopy,g,c,0,null,0,`Copy sub result from stack[${g}]`),e.emit(u.SCopy,E,f,0,null,0,`Copy sub error from stack[${E}]`),e.emit(u.StackPop,p,0,0,null,0,"Pop subquery args/results"),e.emit(u.IfTrue,f,d,0,null,0,"Skip compare if subquery had error (>1 row)"),e.emit(u.IfNull,c,d,0,null,0,"Skip compare if subquery result is NULL (0 rows)");let w;switch(n.toUpperCase()){case"=":case"==":case"IS":w=u.Eq;break;case"!=":case"<>":case"IS NOT":w=u.Ne;break;case"<":w=u.Lt;break;case"<=":w=u.Le;break;case">":w=u.Gt;break;case">=":w=u.Ge;break;default:throw new R(`Unsupported comparison operator with subquery: ${n}`,I.ERROR,void 0,r.loc?.start.line,r.loc?.start.column)}e.emit(w,c,l,i,null,0,"Compare Left Expr with Sub Result"),e.emit(u.Integer,0,s,0,null,0,"Set comparison FALSE"),e.emit(u.Goto,0,h,0,null,0),e.resolveAddress(l),e.emit(u.Integer,1,s,0,null,0,"Set comparison TRUE"),e.emit(u.Goto,0,h,0,null,0),e.resolveAddress(d),e.emit(u.Null,0,s,0,null,0,"Set comparison NULL"),e.resolveAddress(h)}function mu(e,t,n){let r=At(e,t,new Set(e.tableAliases.values()));r.isCorrelated?Cm(e,t,n,r):bm(e,t,n)}function bm(e,t,n){let r=e.allocateAddress(),s=e.allocateAddress(),o=e.allocateAddress(),a=e.allocateAddress(),i=e.allocateAddress(),c=e.compileFromCore(t.from),f=c[0];if(f===void 0){if(t.where){let d=e.allocateMemoryCells(1);e.compileExpression(t.where,d),e.emit(u.IfFalse,d,s,0,null,0,"EXISTS: Check constant WHERE")}e.emit(u.Integer,1,n,0,null,0,"EXISTS: Literal/No-FROM subquery is TRUE"),e.emit(u.Goto,0,o,0,null,0),e.resolveAddress(s),e.emit(u.Integer,0,n,0,null,0,"EXISTS: Set FALSE (constant WHERE failed)"),e.resolveAddress(o);return}if(e.emit(u.VFilter,f,s,0,{idxNum:0,idxStr:null,nArgs:0},0,"EXISTS: Start scan"),e.resolveAddress(a),t.where){let d=e.allocateMemoryCells(1);e.compileExpression(t.where,d),e.emit(u.IfFalse,d,i,0,null,0,"EXISTS: Check WHERE, jump to VNext if false")}e.emit(u.Integer,1,n,0,null,0,"EXISTS: Set TRUE (found row)"),e.emit(u.Goto,0,o,0,null,0,"EXISTS: Finish (found row)"),e.resolveAddress(i),e.emit(u.VNext,f,s,0,null,0,"EXISTS: VNext"),e.emit(u.Goto,0,a,0,null,0,"EXISTS: Loop back"),e.resolveAddress(s),e.emit(u.Integer,0,n,0,null,0,"EXISTS: Set FALSE (no rows found)"),e.resolveAddress(o),e.closeCursorsUsedBySelect(c)}function Cm(e,t,n,r){let s=e.subroutineDefs?.get(t);if(!s){e.startSubroutineCompilation();let i=e.getCurrentAddress(),c=2,f=new Map;r.correlatedColumns.forEach((E,w)=>{f.set(`${E.outerCursor}.${E.outerColumnIndex}`,-(w+1))});let d=e.compileFromCore(t.from),l=d[0],h=e.allocateAddress(),p=e.allocateAddress(),g=e.allocateAddress();if(e.emit(u.Integer,0,c,0,null,0,"SubEXISTS: Init result=0"),l===void 0){if(t.where){let E=e.allocateMemoryCells(1);e.compileExpression(t.where,E,r,void 0,f),e.emit(u.IfFalse,E,p,0,null,0,"SubEXISTS: Check const WHERE")}e.emit(u.Integer,1,c,0,null,0,"SubEXISTS: Set result=1 (const)")}else{if(e.emit(u.VFilter,l,p,0,{idxNum:0,idxStr:null,nArgs:0},0,"SubEXISTS: Start scan"),e.resolveAddress(h),t.where){let E=e.allocateMemoryCells(1);e.compileExpression(t.where,E,r,void 0,f),e.emit(u.IfFalse,E,g,0,null,0,"SubEXISTS: Check WHERE")}e.emit(u.Integer,1,c,0,null,0,"SubEXISTS: Set result=1 (row found)"),e.emit(u.Goto,0,p,0,null,0,"SubEXISTS: Exit loop early"),e.resolveAddress(g),e.emit(u.VNext,l,p,0,null,0,"SubEXISTS: VNext"),e.emit(u.Goto,0,h,0,null,0,"SubEXISTS: Loop back")}e.resolveAddress(p),e.closeCursorsUsedBySelect(d),e.emit(u.SCopy,c,-1,0,null,0,"SubEXISTS: Store result in Arg FP[-1]"),e.emit(u.FrameLeave,0,0,0,null,0,"Leave SubEXISTS Frame"),e.emit(u.Return,0,0,0,null,0,"Return from SubEXISTS"),s={startAddress:i,correlation:r},e.subroutineDefs?.set(t,s),e.endSubroutineCompilation()}let o=0;r.correlatedColumns.forEach(i=>{let c=e.allocateMemoryCells(1),f=[...e.tableAliases.entries()].find(([h,p])=>p===i.outerCursor)?.[0],d=e.tableSchemas.get(i.outerCursor);if(!d)throw new Error(`Schema ${i.outerCursor} not found`);let l=d.columns[i.outerColumnIndex]?.name;if(!l)throw new Error(`Col ${i.outerColumnIndex} not found`);e.compileExpression({type:"column",name:l,table:f},c),e.emit(u.Push,c,0,0,null,0,`Push outer val ${l}`),o++}),e.emit(u.Push,0,0,0,null,0,"Push placeholder for Sub EXISTS Result (Arg 0)"),o++,e.emit(u.Subroutine,o,s.startAddress,0,null,0,"Call SubEXISTS");let a=e.stackPointer-1;e.emit(u.SCopy,a,n,0,null,0,"Copy SubEXISTS result from stack"),e.emit(u.StackPop,o,0,0,null,0,"Pop SubEXISTS args")}function gu(e,t,n){let r=t.name.toLowerCase();if(console.log(`Compiling CTE: ${r}, Recursive Context: ${n}`),n&&pu(e,t,r)){console.log(`Compiling RECURSIVE CTE: ${r}`),Tm(e,t);return}if(!n&&pu(e,t,r))throw new R(`Recursive CTE '${r}' used without 'RECURSIVE' keyword`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);console.log(`Compiling Non-Recursive CTE (Materializing): ${r}`),Am(e,t)}function Am(e,t){let n=t.name.toLowerCase(),r=ps(e,["tableAliases","tableSchemas","ephemeralTables","cteMap","cursorPlanningInfo","resultColumns","columnAliases"]),s,o=-1,a;try{if(t.query.type==="select"){let i=Array.from(r.tableAliases?.values()??[]);a=e.compileSelectCore(t.query,i),o=e.allocateCursor();let c=a.columnMap.map((f,d)=>{let l=A.TEXT;f.expr?.type==="literal"&&(typeof f.expr.value=="number"&&(l=A.REAL),typeof f.expr.value=="bigint"&&(l=A.INTEGER),f.expr.value===null&&(l=A.NULL));let h=e.columnAliases[a.resultBaseReg+d]??`cte_col_${d}`;return{...Te(h),affinity:l}});s=e.createEphemeralSchema(o,a.numCols),s.columns=Object.freeze(c),s.columnIndexMap=Object.freeze(Oe(c)),console.log(`CTE '${n}': Inferred ${a.numCols} columns for ephemeral table ${o}`)}else throw new R(`CTE query type '${t.query.type}' not yet supported for materialization`,I.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column)}finally{gs(e,r)}e.cteMap.set(n,{type:"materialized",cursorIdx:o,schema:s}),e.tableSchemas.set(o,s),e.ephemeralTables.set(o,s),e.emit(u.OpenWrite,o,s.columns.length,0,s,0,`OpenWrite Ephemeral CTE '${n}'`),Vo(e,t.query,o,s),console.log(`Finished compiling materialized CTE: ${n}`)}function Tm(e,t){let n=t.name.toLowerCase();if(t.query.type!=="select"||!t.query.union&&!t.query.unionAll)throw new R(`Recursive CTE '${n}' must use UNION or UNION ALL`,I.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column);let r={...t.query,union:void 0,unionAll:void 0},s=t.query.union;if(!s)throw new R(`Recursive CTE '${n}' is missing the recursive part after UNION ALL`,I.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column);let o=t.query.unionAll??!1,a=e.allocateCursor(),i=e.allocateCursor(),c=ps(e,["tableAliases","tableSchemas","ephemeralTables","cteMap","cursorPlanningInfo","resultColumns","columnAliases"]),f,d,l;try{l=e.compileSelectCore(r,Array.from(c.tableAliases?.values()??[]));let w=[],y;if(!o){for(let b=0;b<l.numCols;b++)w.push({index:b,desc:!1});y={type:"sortkey",keyIndices:w.map(b=>b.index),directions:w.map(b=>b.desc)},console.log(`Recursive CTE '${n}': Using UNION (distinct), creating PK on all columns for Result table ${a}`)}f=e.createEphemeralSchema(a,l.numCols,y),d=e.createEphemeralSchema(i,l.numCols);let N=l.columnMap.map((b,C)=>{let S=A.TEXT;b.expr?.type==="literal"&&(typeof b.expr.value=="number"&&(S=A.REAL),typeof b.expr.value=="bigint"&&(S=A.INTEGER),b.expr.value===null&&(S=A.NULL));let O=e.columnAliases[l.resultBaseReg+C]??`cte_col_${C}`;return{...Te(O),affinity:S}});f.columns=Object.freeze(N),f.columnIndexMap=Object.freeze(Oe(N)),d.columns=Object.freeze(N),d.columnIndexMap=Object.freeze(Oe(N))}finally{gs(e,c)}e.cteMap.set(n,{type:"materialized",cursorIdx:a,schema:f}),e.tableSchemas.set(a,f),e.ephemeralTables.set(a,f),e.ephemeralTables.set(i,d),e.emit(u.OpenWrite,a,f.columns.length,0,f,0,`OpenWrite REC CTE Result '${n}'`),e.emit(u.OpenWrite,i,d.columns.length,0,d,0,`OpenWrite REC CTE Queue '${n}'`),console.log(`REC CTE '${n}': Compiling initial term...`),Vo(e,r,a,f,!0,i,d,!0),console.log(`REC CTE '${n}': Compiling recursive loop...`);let h=e.getCurrentAddress(),p=e.allocateAddress(),g=e.allocateAddress();e.emit(u.Rewind,i,g,0,null,0,"REC CTE: Rewind Queue"),e.resolveAddress(p),e.emit(u.VNext,i,g,0,null,0,"REC CTE: VNext Queue");let E=ps(e,["tableAliases","tableSchemas","cteMap","ephemeralTables","cursorPlanningInfo"]);try{e.cteMap.set(n,{type:"materialized",cursorIdx:i,schema:d}),e.tableAliases.set(n,i),e.tableSchemas.set(i,d),console.log(`REC CTE '${n}': Mapping self-reference to QUEUE cursor ${i}`),Vo(e,s,a,f,!0,i,d,o)}finally{console.log(`REC CTE '${n}': Restoring state after recursive step compilation.`),gs(e,E)}e.emit(u.Goto,0,p,0,null,0,"REC CTE: Loop back"),e.resolveAddress(g),e.emit(u.Close,i,0,0,null,0,`Close REC CTE Queue '${n}'`),e.ephemeralTables.delete(i),console.log(`Finished compiling recursive CTE: ${n}`)}function Vo(e,t,n,r,s=!1,o,a,i=!0){let c=ps(e,["tableAliases","tableSchemas","ephemeralTables","cursorPlanningInfo"]),f=0,d=0,l=[];try{l=e.compileFromCore(t.from);let h=new Set(Array.from(e.tableAliases.values()));l.forEach(v=>{let x=e.tableSchemas.get(v);x&&e.planTableAccess(v,x,t,h)});let p=[],g=[],E=e.allocateAddress(),w=new Set;l.length===0?e.resolveAddress(E):l.forEach((v,x)=>{if(!e.tableSchemas.get(v))throw new Error(`Internal: Schema missing for query cursor ${v}`);let U=e.allocateAddress(),B=e.allocateAddress();p.push(U),g.push(B);let _=e.cursorPlanningInfo.get(v),k={idxNum:0,idxStr:null,nArgs:0},J=0;if(_&&_.idxNum!==0){let le=[];_.usage.forEach((ue,Ae)=>{if(ue.argvIndex>0){let Le=_.constraintExpressions?.get(Ae);if(!Le)throw new R(`Internal error: Missing expression for constraint ${Ae} used in CTE pop VFilter`,I.INTERNAL);for(;le.length<ue.argvIndex;)le.push(null);le[ue.argvIndex-1]={constraintIdx:Ae,expr:Le}}});let ae=le.filter(ue=>ue!==null);ae.length>0&&(J=e.allocateMemoryCells(ae.length),ae.forEach((ue,Ae)=>{let Le=At(e,ue.expr,w);e.compileExpression(ue.expr,J+Ae,Le)})),k={idxNum:_.idxNum,idxStr:_.idxStr,nArgs:ae.length}}e.emit(u.VFilter,v,B,J,k,0,`Populate Ephemeral: Scan Cursor ${x}`),e.resolveAddress(U),e.verifyWhereConstraints(v,B),w.add(v),x===l.length-1&&e.resolveAddress(E)});let y=e.allocateAddress();fn(e,t.where,l,y);let N=e.compileSelectCore(t,Array.from(w));if(f=N.resultBaseReg,d=N.numCols,d!==r.columns.length)throw new R(`CTE column count mismatch during population: expected ${r.columns.length}, got ${d}`,I.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let b=e.allocateMemoryCells(d+1);e.emit(u.Null,0,b,0,null,0,"Populate Eph: Rowid=NULL"),e.emit(u.Move,f,b+1,d,null,0,"Populate Eph: Copy Result");let C=i?oe.ABORT:oe.IGNORE,S={table:r,onConflict:C},O=e.allocateMemoryCells(1);if(e.emit(u.Integer,-1,O,0,null,0,"Populate Eph: Init target rowid check"),e.emit(u.VUpdate,d+1,b,O,S,0,`Populate Eph: Insert Target ${n}`),s&&o!==void 0&&a){let v=e.allocateAddress();i||e.emit(u.IfNull,O,v,0,null,0,"Populate Eph: Skip queue if target insert ignored");let x={table:a,onConflict:oe.ABORT};e.emit(u.VUpdate,d+1,b,0,x,0,`Populate Eph: Insert Queue ${o}`),e.resolveAddress(v)}if(e.resolveAddress(y),l.length>0)for(let v=l.length-1;v>=0;v--){let x=l[v],L=p[v],U=g[v];e.emit(u.Goto,0,L-1,0,null,0,`Populate Eph: Goto VNext ${v}`),e.resolveAddress(U),w.delete(x)}}finally{e.closeCursorsUsedBySelect(l),gs(e,c)}}function ps(e,t){let n={};for(let r of t){let s=e[r];s instanceof Map?n[r]=new Map(s):Array.isArray(s)?n[r]=[...s]:n[r]=s}return n}function gs(e,t){for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}function pu(e,t,n){if(t.query.type!=="select")return!1;let r=t.query;if(r.union){let s=o=>{if(!o)return!1;if(o.type==="table"){if(o.table.name.toLowerCase()===n.toLowerCase())return!0}else if(o.type==="join")return s(o.left)||s(o.right);return!1};return r.union.from?.some(s)??!1}return!1}var On=class{db;sql="";constants=[];instructions=[];numMemCells=0;currentFrameLocals=0;numCursors=0;parameters=new Map;columnAliases=[];cteMap=new Map;tableSchemas=new Map;tableAliases=new Map;ephemeralTables=new Map;resultColumns=[];cursorPlanningInfo=new Map;subroutineCode=[];subroutineDefs=new Map;subroutineDepth=0;currentFrameEnterInsn=null;maxLocalOffsetInCurrentFrame=0;stackPointer=0;framePointer=0;outerCursors=[];constructor(t){this.db=t}compile(t,n){try{this.sql=n,this.constants=[],this.instructions=[],this.numMemCells=0,this.numCursors=0,this.parameters=new Map,this.columnAliases=[],this.cteMap=new Map,this.tableSchemas=new Map,this.tableAliases=new Map,this.ephemeralTables=new Map,this.resultColumns=[],this.cursorPlanningInfo=new Map,this.subroutineCode=[],this.subroutineDefs=new Map,this.subroutineDepth=0,this.currentFrameLocals=0,this.currentFrameEnterInsn=null,this.maxLocalOffsetInCurrentFrame=0,this.stackPointer=0,this.framePointer=0,this.outerCursors=[],this.emit(u.Init,0,1,0,null,0,"Start of program");let r;switch("withClause"in t&&t.withClause!==void 0&&(r=t.withClause,this.compileWithClause(r)),t.type){case"select":this.compileSelect(t);break;case"insert":this.compileInsert(t);break;case"update":this.compileUpdate(t);break;case"delete":this.compileDelete(t);break;case"createTable":this.compileCreateTable(t);break;case"createIndex":this.compileCreateIndex(t);break;case"createView":this.compileCreateView(t);break;case"drop":this.compileDrop(t);break;case"alterTable":this.compileAlterTable(t);break;case"begin":this.compileBegin(t);break;case"commit":this.compileCommit(t);break;case"rollback":this.compileRollback(t);break;case"savepoint":this.compileSavepoint(t);break;case"release":this.compileRelease(t);break;case"pragma":this.compilePragma(t);break;default:throw new R(`Unsupported statement type: ${t.type}`,I.ERROR)}return this.subroutineCode.length>0&&(this.instructions.push(...this.subroutineCode),this.subroutineCode=[]),this.emit(u.Halt,I.OK,0,0,null,0,"End of program"),{instructions:this.instructions,constants:this.constants,numMemCells:this.numMemCells+1,numCursors:this.numCursors,parameters:this.parameters,columnNames:this.columnAliases,sql:this.sql}}catch(r){throw r instanceof rs?new R(r.message,I.ERROR,r,r.line,r.column):r instanceof R?r:new R(`Unexpected compiler error: ${r instanceof Error?r.message:String(r)}`,I.INTERNAL,r instanceof Error?r:void 0)}}startSubroutineCompilation(){this.subroutineDepth++,this.maxLocalOffsetInCurrentFrame=0;let t=xn(u.FrameEnter,0,0,0,null,0,`Enter Subroutine Frame Depth ${this.subroutineDepth}`);this.subroutineCode.push(t);let n=this.subroutineCode.length-1;return this.currentFrameEnterInsn=t,n}endSubroutineCompilation(){if(this.subroutineDepth>0){if(this.currentFrameEnterInsn){let t=this.maxLocalOffsetInCurrentFrame+1;this.currentFrameEnterInsn.p1=t,this.currentFrameEnterInsn=null}else console.error("Compiler Error: Mismatched start/endSubroutineCompilation or missing FrameEnter tracking.");this.subroutineDepth--}else console.warn("Attempted to end subroutine compilation at depth 0")}allocateMemoryCells(t){return xl(this,t)}allocateCursor(){return Ll(this)}addConstant(t){return Ol(this,t)}emit(t,n,r,s,o,a,i){return Ml(this,t,n,r,s,o,a,i)}allocateAddress(){return Dl(this)}resolveAddress(t){Pl(this,t)}getCurrentAddress(){return kl(this)}createEphemeralSchema(t,n,r){return $l(this,t,n,r)}closeCursorsUsedBySelect(t){Ul(this,t)}compileFromCore(t){return Wl(this,t)}planTableAccess(t,n,r,s){zl(this,t,n,r,s)}verifyWhereConstraints(t,n){Zl(this,t,n)}compileExpression(t,n,r,s,o){Xl(this,t,n,r,s,o)}compileLiteral(t,n){ls(this,t,n)}compileColumn(t,n,r,s,o){gr(this,t,n,r,s,o)}compileBinary(t,n,r,s,o){us(this,t,n,r,s,o)}compileUnary(t,n,r,s,o){cs(this,t,n,r,s,o)}compileCast(t,n,r,s,o){fs(this,t,n,r,s,o)}compileCollate(t,n,r,s,o){ms(this,t,n,r,s,o)}compileFunction(t,n,r,s,o){ds(this,t,n,r,s,o)}compileParameter(t,n){hs(this,t,n)}compileSubquery(t,n){uu(this,t,n)}compileScalarSubquery(t,n){cu(this,t,n)}compileInSubquery(t,n,r,s){du(this,t,n,r,s)}compileComparisonSubquery(t,n,r,s){hu(this,t,n,r,s)}compileExistsSubquery(t,n){mu(this,t,n)}compileSelect(t){iu(this,t)}compileInsert(t){Jl(this,t)}compileUpdate(t){Ql(this,t)}compileDelete(t){eu(this,t)}compileCreateTable(t){Bl(this,t)}compileCreateIndex(t){_l(this,t)}compileCreateView(t){Vl(this,t)}compileDrop(t){Kl(this,t)}compileAlterTable(t){Gl(this,t)}compileBegin(t){ql(this,t)}compileCommit(t){jl(this,t)}compileRollback(t){tu(this,t)}compileSavepoint(t){nu(this,t)}compileRelease(t){ru(this,t)}compileSelectCore(t,n,r,s){return lu(this,t,n,r,s)}compileWithClause(t){if(t){console.log(`Compiling WITH${t.recursive?" RECURSIVE":""} clause...`);for(let n of t.ctes){let r=n.name.toLowerCase();if(this.cteMap.has(r))throw new R(`Duplicate CTE name: '${n.name}'`,I.ERROR);gu(this,n,t.recursive)}console.log("Finished compiling WITH clause.")}}compilePragma(t){Yl(this,t)}};var Es=new Map,Ko=(e,t)=>e<t?-1:e>t?1:0,yu=(e,t)=>{let n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:0},wu=(e,t)=>{let n=e.length,r=t.length;for(;n>0&&e[n-1]===" ";)n--;for(;r>0&&t[r-1]===" ";)r--;let s=Math.min(n,r);for(let o=0;o<s;o++)if(e[o]!==t[o])return e[o]<t[o]?-1:1;return n-r};function Er(e,t){let n=e.toUpperCase();Es.has(n)&&console.warn(`Overwriting existing collation: ${n}`),Es.set(n,t)}function Iu(e){return Es.get(e.toUpperCase())}function Go(e){if(e==null)return!1;switch(typeof e){case"boolean":return e;case"number":return e!==0;case"bigint":return e!==0n;case"string":return e.length>0;case"object":return e instanceof Uint8Array,!1;default:return!1}}var Me;(function(e){e[e.NULL=0]="NULL",e[e.NUMERIC=1]="NUMERIC",e[e.TEXT=2]="TEXT",e[e.BLOB=3]="BLOB",e[e.UNKNOWN=99]="UNKNOWN"})(Me||(Me={}));function Eu(e){if(e==null)return Me.NULL;let t=typeof e;return t==="number"||t==="bigint"||t==="boolean"?Me.NUMERIC:t==="string"?Me.TEXT:t==="object"&&e instanceof Uint8Array?Me.BLOB:Me.UNKNOWN}function fe(e,t,n="BINARY"){let r=Eu(e),s=Eu(t);if(r===Me.NULL&&s===Me.NULL)return 0;if(r===Me.NULL)return-1;if(s===Me.NULL)return 1;if(r!==s)return r-s;let o=typeof e=="boolean"?e?1:0:e,a=typeof t=="boolean"?t?1:0:t;switch(r){case Me.NUMERIC:return o<a?-1:o>a?1:0;case Me.TEXT:let i=Es.get(n.toUpperCase());return i?i(o,a):(console.warn(`Unknown collation requested: ${n}. Falling back to BINARY.`),Ko(o,a));case Me.BLOB:let c=o,f=a,d=Math.min(c.length,f.length);for(let l=0;l<d;l++)if(c[l]!==f[l])return c[l]<f[l]?-1:1;return c.length<f.length?-1:c.length>f.length?1:0;default:return 0}}function Ru(e){if(e=e.trim(),!e)return null;let t=e.startsWith("-")?-1:(e.startsWith("+"),1);t!==1&&(e=e.substring(1));let n="";for(let r=0;r<e.length&&(e[r]>="0"&&e[r]<="9");r++)n+=e[r];if(!n)return null;try{let r=BigInt(n)*BigInt(t);return r>=Number.MIN_SAFE_INTEGER&&r<=Number.MAX_SAFE_INTEGER?Number(r):r}catch{return null}}function qo(e){if(e=e.trim(),!e)return null;let t=parseFloat(e);return isNaN(t)?null:t}function jo(e){if(e===null||typeof e=="bigint")return e;if(typeof e=="number"){let t=Math.trunc(e);if(t>=Number.MIN_SAFE_INTEGER&&t<=Number.MAX_SAFE_INTEGER)return t;try{return BigInt(t)}catch{return e}}if(typeof e=="string"){let t=Ru(e);if(t!==null)return t;let n=qo(e);return n!==null?jo(n):null}return e instanceof Uint8Array?null:e}function Nu(e){return e===null?null:typeof e=="number"||typeof e=="bigint"?Number(e):typeof e=="string"?qo(e):e instanceof Uint8Array?null:e}function bu(e){if(e===null||typeof e=="number"||typeof e=="bigint")return e;if(typeof e=="string"){let t=Ru(e);if(t!==null)return t;let n=qo(e);return n!==null?n:e}return e instanceof Uint8Array,e}function Cu(e){return e===null||typeof e=="string"?e:typeof e=="number"||typeof e=="bigint"?String(e):e instanceof Uint8Array?e:String(e)}function Su(e){return e}var Ze=class{_result=void 0;_result_set=!1;_error=null;_subtype=0;userData;db;auxData=new Map;_aggregateContext=void 0;constructor(t,n){this.db=t,this.userData=n}_getResult(){if(this._error)throw this._error;return this._result_set?this._result:null}_getError(){return this._error}_getSubtype(){return this._subtype}_clear(){this._result=void 0,this._result_set=!1,this._error=null,this._subtype=0}_setAggregateContextRef(t){this._aggregateContext=t}_getAggregateContextRef(){return this._aggregateContext}setResult(t){this._result_set||this._error||(this._result=t,this._result_set=!0)}resultBlob(t){this.setResult(t)}resultDouble(t){this.setResult(t)}resultError(t,n=I.ERROR){this._result_set||this._error||(this._error=new R(t,n))}resultInt(t){this.setResult(Math.trunc(t))}resultInt64(t){this.setResult(t)}resultNull(){this.setResult(null)}resultText(t){this.setResult(t)}resultValue(t){this.setResult(t)}resultZeroblob(t){this.setResult(new Uint8Array(t))}resultSubtype(t){this._subtype=t>>>0}getUserData(){return this.userData}getDbConnection(){return this.db}getAuxData(t){return this.auxData.get(t)?.data}setAuxData(t,n,r){if(this._error)return;let s=this.auxData.get(t);if(s?.destructor&&s.data!==n)try{s.destructor(s.data)}catch(o){console.error("Internal: AuxData destructor failed",o)}n===void 0&&r===void 0?this.auxData.delete(t):this.auxData.set(t,{data:n,destructor:r})}getAggregateContext(t=!1){return this._aggregateContext===void 0&&t?{}:this._aggregateContext}setAggregateContext(t){this._aggregateContext=t}_cleanupAuxData(){this.auxData.forEach(t=>{if(t.destructor)try{t.destructor(t.data)}catch(n){console.error("Internal: AuxData destructor failed",n)}}),this.auxData.clear()}};var at=class{module;db;tableName;schemaName;errorMessage;tableSchema;constructor(t,n,r,s){this.db=t,this.module=n,this.schemaName=r,this.tableName=s}setErrorMessage(t){this.errorMessage=t}};var it=class{table;constructor(t){this.table=t}};var Tt=class{static lockQueues=new Map;static async acquire(t){let n=this.lockQueues.get(t)??Promise.resolve(),r,s=new Promise(a=>{r=a});return this.lockQueues.set(t,s),await n,()=>{r(),this.lockQueues.get(t)===s&&this.lockQueues.delete(t)}}};var yr=Xh(Zo(),1);var wr=class extends it{mergedResults=[];currentIndex=-1;isEof=!0;constructor(t){super(t)}reset(){this.mergedResults=[],this.currentIndex=-1,this.isEof=!0}getCurrentRow(){return this.isEof||this.currentIndex<0||this.currentIndex>=this.mergedResults.length?null:this.mergedResults[this.currentIndex]}getCurrentRowId(){return this.getCurrentRow()?._rowid_??null}setResults(t){this.mergedResults=t,this.currentIndex=-1,this.isEof=this.mergedResults.length===0,this.isEof||this.advance()}advance(){this.currentIndex>=this.mergedResults.length-1?(this.isEof=!0,this.currentIndex=this.mergedResults.length):(this.currentIndex++,this.isEof=!1)}eof(){return this.isEof}getMergedResults(){return this.mergedResults}},Ir=class extends at{columns=[];primaryKeyColumnIndices=[];keyFromEntry=t=>t._rowid_;compareKeys=fe;data=null;nextRowid=BigInt(1);readOnly;rowidToKeyMap=null;isSorter=!1;inTransaction=!1;pendingInserts=null;pendingUpdates=null;pendingDeletes=null;savepoints=[];constructor(t,n,r,s,o=!1){super(t,n,r,s),this.readOnly=o}setColumns(t,n){if(this.columns=[...t],n.length===0)console.log(`MemoryTable '${this.tableName}': Using rowid as BTree key.`),this.keyFromEntry=r=>r._rowid_,this.compareKeys=(r,s)=>fe(r,s),this.rowidToKeyMap=null;else if(n.length===1){let{index:r,desc:s}=n[0],o=this.columns[r]?.name,a=this.columns[r]?.collation||"BINARY";o?(console.log(`MemoryTable '${this.tableName}': Using PRIMARY KEY column '${o}' (index ${r}, ${s?"DESC":"ASC"}) as BTree key.`),this.primaryKeyColumnIndices=Object.freeze([r]),this.keyFromEntry=i=>i[o],this.compareKeys=(i,c)=>{let f=fe(i,c,a);return s?-f:f},this.rowidToKeyMap=new Map):(console.error(`MemoryTable '${this.tableName}': Invalid primary key index ${r}. Falling back to rowid key.`),this.keyFromEntry=i=>i._rowid_,this.compareKeys=(i,c)=>fe(i,c),this.rowidToKeyMap=null)}else{let r=n.map(s=>({name:this.columns[s.index]?.name,desc:s.desc,collation:this.columns[s.index]?.collation||"BINARY"}));if(r.some(s=>!s.name))console.error(`MemoryTable '${this.tableName}': Invalid composite primary key indices. Falling back to rowid key.`),this.keyFromEntry=s=>s._rowid_,this.compareKeys=(s,o)=>fe(s,o),this.rowidToKeyMap=null;else{let s=r.map(o=>o.name);console.log(`MemoryTable '${this.tableName}': Using Composite PRIMARY KEY (${r.map(o=>`${o.name} ${o.desc?"DESC":"ASC"}`).join(", ")}) as BTree key.`),this.keyFromEntry=o=>s.map(a=>o[a]),this.compareKeys=(o,a)=>this.compareCompositeKeysWithOrder(o,a,r.map(i=>i.desc),r.map(i=>i.collation)),this.rowidToKeyMap=new Map}}this.data=new yr.BTree(this.keyFromEntry,this.compareKeys)}compareCompositeKeysWithOrder(t,n,r,s=[]){let o=t,a=n,i=Math.min(o.length,a.length);for(let c=0;c<i;c++){let f=r[c]?-1:1,d=s[c]||"BINARY",l=fe(o[c],a[c],d)*f;if(l!==0)return l}return o.length-a.length}getRowByBTreeKey(t){if(!this.data)return null;let n=this.data.find(t);return n.on?this.data.at(n)??null:null}findPathByRowid(t){if(!this.data)return null;if(!this.rowidToKeyMap&&this.columns.length>0)return console.error(`MemoryTable ${this.tableName}: Attempt to find by rowid without rowidToKeyMap on a keyed table.`),null;if(this.rowidToKeyMap){let n=this.rowidToKeyMap.get(t);if(n===void 0)return null;let r=this.data.find(n);return r.on&&this.data.at(r)?._rowid_===t?r:null}else{let n=this.data.find(t);return n.on?n:null}}addRow(t){if(!this.data)throw new Error("MemoryTable BTree not initialized.");let n=this.nextRowid,r={...t,_rowid_:n},s=this.keyFromEntry(r),o=!1;if(this.data.get(s)!==void 0&&(o=!0),!o&&this.inTransaction){if(this.pendingInserts?.has(s))o=!0;else if(this.pendingUpdates){for(let a of this.pendingUpdates.values())if(this.compareKeys(a.newKey,s)===0){o=!0;break}}}if(o)return{};this.nextRowid++;try{if(this.inTransaction){if(this.pendingInserts||(this.pendingInserts=new Map),this.pendingDeletes){for(let[a,i]of this.pendingDeletes.entries())if(this.compareKeys(i.oldKey,s)===0){this.pendingDeletes.delete(a);break}}this.pendingInserts.set(s,r)}else this.data.insert(r),this.rowidToKeyMap&&this.rowidToKeyMap.set(n,s);return{rowid:n}}catch(a){throw this.nextRowid=n,new R(`Internal BTree error during insert: ${a.message}`,I.INTERNAL)}}updateRow(t,n){if(!this.data)throw new Error("MemoryTable BTree not initialized.");let r,s,o=null,a=!1;if(this.inTransaction){let d=this.pendingUpdates?.get(t);if(d)r=d.newRow,s=d.newKey;else for(let[l,h]of this.pendingInserts?.entries()??[])if(h._rowid_===t){r=h,s=l,a=!0;break}if(this.pendingDeletes?.has(t))return!1}if(!r){if(o=this.findPathByRowid(t),!o||(r=this.data.at(o),!r))return!1;s=this.keyFromEntry(r)}if(!s)throw new Error("Old key not found during update");let i={...r,...n,_rowid_:t},c=this.keyFromEntry(i),f=this.compareKeys(c,s)!==0;if(f){let d=!1;if(this.data.get(c)!==void 0&&(d=!0),!d&&this.inTransaction){if(this.pendingInserts?.has(c))d=!0;else if(this.pendingUpdates){for(let l of this.pendingUpdates.values())if(l.newRow._rowid_!==t&&this.compareKeys(l.newKey,c)===0){d=!0;break}}}if(d){let l=this.getPkColNames()??"rowid";throw new Ct(`UNIQUE constraint failed: ${this.tableName}.${l}`)}}try{if(this.inTransaction){if(this.pendingUpdates||(this.pendingUpdates=new Map),a)this.pendingInserts?.set(c,i),f&&this.pendingInserts?.delete(s);else{let d=this.pendingUpdates.has(t)?this.pendingUpdates.get(t).oldRow:r;this.pendingUpdates.set(t,{oldRow:d,newRow:i,oldKey:s,newKey:c})}return!0}else if(f){if(o||(o=this.data.find(s)),!o||!o.on)throw new Error("Cannot find original row path for key change update");return this.data.deleteAt(o),this.rowidToKeyMap&&this.rowidToKeyMap.delete(t),this.data.insert(i),this.rowidToKeyMap&&this.rowidToKeyMap.set(t,c),!0}else{if(o||(o=this.data.find(s)),!o||!o.on)throw new Error("Cannot find original row path for same key update");return this.data.updateAt(o,i),!0}}catch(d){if(d instanceof Ct)throw d;if(console.error("Failed to update row:",d),!this.inTransaction&&f)try{o&&this.data.deleteAt(o),this.data.insert(r),this.rowidToKeyMap&&this.rowidToKeyMap.set(t,s)}catch{}throw new R(`Internal BTree error during update: ${d instanceof Error?d.message:String(d)}`,I.INTERNAL)}}deleteRow(t){if(!this.data)throw new Error("MemoryTable BTree not initialized.");if(this.inTransaction){let n=!1;if(this.pendingInserts){for(let[i,c]of this.pendingInserts.entries())if(c._rowid_===t){this.pendingInserts.delete(i),n=!0;break}}if(n)return!0;let r=this.pendingUpdates?.get(t);if(r)return this.pendingDeletes||(this.pendingDeletes=new Map),this.pendingDeletes.set(t,{oldRow:r.oldRow,oldKey:r.oldKey}),this.pendingUpdates?.delete(t),!0;let s=this.findPathByRowid(t);if(!s)return!1;let o=this.data.at(s);if(!o)return!1;let a=this.keyFromEntry(o);return this.pendingDeletes||(this.pendingDeletes=new Map),this.pendingDeletes.set(t,{oldRow:o,oldKey:a}),!0}else{let n=this.findPathByRowid(t);if(!n)return!1;try{return this.data.deleteAt(n),this.rowidToKeyMap&&this.rowidToKeyMap.delete(t),!0}catch(r){return console.error("BTree deleteAt failed:",r),!1}}}clear(){this.data&&(this.data=new yr.BTree(this.keyFromEntry,this.compareKeys)),this.rowidToKeyMap&&this.rowidToKeyMap.clear(),this.nextRowid=BigInt(1)}get size(){return this.data?.getCount()??0}getRowIds(){if(!this.data)return[];let t=[];for(let n of this.data.ascending(this.data.first())){let r=this.data.at(n);r&&t.push(r._rowid_)}return t}getAllRows(){if(!this.data)return[];let t=[];for(let n of this.data.ascending(this.data.first())){let r=this.data.at(n);r&&t.push(r)}return t}isReadOnly(){return this.readOnly}getPkColNames(){return this.primaryKeyColumnIndices.length===0?null:this.primaryKeyColumnIndices.map(t=>this.columns[t]?.name??"?").join(", ")}createSavepoint(t){if(this.inTransaction){for(;this.savepoints.length<t;){console.warn(`MemoryTable ${this.tableName}: Filling missing savepoint index ${this.savepoints.length}`);let n=this.savepoints.length>0?this.savepoints[this.savepoints.length-1]:this.createBufferSnapshot();this.savepoints.push(n)}this.savepoints[t]=this.createBufferSnapshot(),console.log(`MemoryTable ${this.tableName}: Created savepoint at index ${t}`)}}releaseSavepoint(t){this.inTransaction&&t>=0&&t<this.savepoints.length&&(this.savepoints.length=t,console.log(`MemoryTable ${this.tableName}: Released savepoints from index ${t}`))}rollbackToSavepoint(t){if(!this.inTransaction)return;if(t<0||t>=this.savepoints.length){console.error(`MemoryTable ${this.tableName}: Invalid savepoint index ${t} for rollback.`);return}let n=this.savepoints[t];this.pendingInserts=new Map(n.inserts),this.pendingUpdates=new Map(n.updates),this.pendingDeletes=new Map(n.deletes),this.savepoints.length=t+1,console.log(`MemoryTable ${this.tableName}: Rolled back to savepoint index ${t}`)}createBufferSnapshot(){return{inserts:new Map(this.pendingInserts??[]),updates:new Map(this.pendingUpdates??[]),deletes:new Map(this.pendingDeletes??[])}}_configureAsSorter(t){if(this.isSorter){console.warn(`MemoryTable ${this.tableName}: Already configured as sorter.`);return}console.log(`MemoryTable ${this.tableName}: Configuring BTree for sorting with keys:`,t.keyIndices,"directions:",t.directions);let n=this.columns.map(o=>o.name),r=o=>{let a=t.keyIndices.map(i=>{let c=n[i];return c?o[c]:null});return a.push(o._rowid_),a},s=(o,a)=>{let i=o,c=a,f=Math.min(i.length,c.length)-1;for(let h=0;h<f;h++){let p=t.directions[h]?-1:1,g=t.collations?.[h]||"BINARY",E=fe(i[h],c[h],g)*p;if(E!==0)return E}let d=i[f],l=c[f];return fe(d,l)};this.keyFromEntry=r,this.compareKeys=s,this.isSorter=!0,this.data=new yr.BTree(r,s),this.rowidToKeyMap=null}},Kt=class{static SCHEMA_VERSION=1;tables=new Map;constructor(){}xCreate(t,n,r,s,o,a){let i=`${s.toLowerCase()}.${o.toLowerCase()}`;if(this.tables.has(i))throw new R(`Memory table '${o}' already exists in schema '${s}'`,I.ERROR);let c=new Ir(t,this,s,o,!!a.readOnly);return this.tables.set(i,c),c.setColumns(a.columns,a.primaryKey??[]),console.log(`MemoryTable '${o}' created (Schema set directly from options)`),c}xConnect(t,n,r,s,o,a){let i=`${s.toLowerCase()}.${o.toLowerCase()}`,c=this.tables.get(i);return c?(console.log(`MemoryTable '${o}' connected (found existing instance)`),c):(console.log(`MemoryTable '${o}' not found, creating new instance via xConnect...`),this.xCreate(t,n,r,s,o,a))}async xDisconnect(t){console.log(`Memory table '${t.tableName}' disconnected`)}async xDestroy(t){t.clear();let n=`${t.schemaName.toLowerCase()}.${t.tableName.toLowerCase()}`;this.tables.delete(n),console.log(`Memory table '${t.tableName}' destroyed`)}async xOpen(t){return t.data||(t.data=new yr.BTree(t.keyFromEntry,t.compareKeys)),new wr(t)}async xClose(t){t.reset()}xBestIndex(t,n){if(t.isSorter)return n.idxNum=0,n.estimatedCost=1,n.estimatedRows=BigInt(t.size||1),n.orderByConsumed=!0,n.idxFlags=0,n.aConstraintUsage=Array.from({length:n.nConstraint},()=>({argvIndex:0,omit:!1})),n.idxStr="sortplan",I.OK;let r=Array.from({length:n.nConstraint},()=>({argvIndex:0,omit:!1})),s=t.primaryKeyColumnIndices,o=s.length===0,a=1,i=t.size||1,c={FULL_ASC:0,KEY_EQ:1,KEY_RANGE_ASC:2,FULL_DESC:3,KEY_RANGE_DESC:4},f={idxNum:c.FULL_ASC,cost:i*10,rows:BigInt(i),usedConstraintIndices:new Set,boundConstraintIndices:{lower:-1,upper:-1},orderByConsumed:!1,isDesc:!1,lowerBoundOp:null,upperBoundOp:null},d=new Map,l=s.length>0;for(let N=0;N<n.nConstraint;N++){let b=n.aConstraint[N];if(b.op===G.EQ&&b.usable)if(o&&b.iColumn===-1){d.set(-1,N);break}else s.includes(b.iColumn)&&d.set(b.iColumn,N)}if(s.length>0){for(let N of s)if(!d.has(N)){l=!1;break}}else l=d.has(-1);if(l){let N=Math.log2(i+1)+1,b=BigInt(1);if(N<f.cost){let C=new Set(d.values());f={...f,idxNum:c.KEY_EQ,cost:N,rows:b,usedConstraintIndices:C,orderByConsumed:!0}}}let h=s[0]??-1,p=null,g=null;for(let N=0;N<n.nConstraint;N++){let b=n.aConstraint[N];b.iColumn===h&&b.usable&&(b.op===G.GT||b.op===G.GE?(!p||b.op>p.op)&&(p={index:N,op:b.op}):(b.op===G.LT||b.op===G.LE)&&(!g||b.op<g.op)&&(g={index:N,op:b.op}))}if(p||g){let N=BigInt(Math.max(1,Math.floor(i/4))),b=Math.log2(i+1)*2+Number(N);if(b<f.cost){let C=new Set;p&&C.add(p.index),g&&C.add(g.index),f={...f,idxNum:c.KEY_RANGE_ASC,cost:b,rows:N,usedConstraintIndices:C,boundConstraintIndices:{lower:p?.index??-1,upper:g?.index??-1},lowerBoundOp:p?.op??null,upperBoundOp:g?.op??null}}}let E=!1,w=!1;n.nOrderBy===s.length&&s.length>0?(E=s.every((N,b)=>n.aOrderBy[b].iColumn===N&&n.aOrderBy[b].desc===n.aOrderBy[0].desc),E&&(w=n.aOrderBy[0].desc)):n.nOrderBy===1&&o&&n.aOrderBy[0].iColumn===-1&&(E=!0,w=n.aOrderBy[0].desc),E&&(f.idxNum===c.FULL_ASC||f.idxNum===c.KEY_RANGE_ASC)&&(f.orderByConsumed=!0,f.isDesc=w,f.idxNum===c.FULL_ASC?(f.idxNum=w?c.FULL_DESC:c.FULL_ASC,f.cost*=.9):(f.idxNum=w?c.KEY_RANGE_DESC:c.KEY_RANGE_ASC,f.cost*=.9)),n.idxNum=f.idxNum,n.estimatedCost=f.cost,n.estimatedRows=f.rows,n.orderByConsumed=f.orderByConsumed,n.idxFlags=f.idxNum===c.KEY_EQ?1:0,a=1,f.usedConstraintIndices.forEach(N=>{r[N].argvIndex=a++,r[N].omit=!0}),n.aConstraintUsage=r;let y=[`plan=${f.idxNum}`];return f.orderByConsumed&&y.push(`order=${f.isDesc?"DESC":"ASC"}`),f.lowerBoundOp&&y.push(`lb_op=${f.lowerBoundOp}`),f.upperBoundOp&&y.push(`ub_op=${f.upperBoundOp}`),f.usedConstraintIndices.size>0&&y.push(`constraints=[${[...f.usedConstraintIndices].join(",")}]`),n.idxStr=y.join(","),I.OK}async xFilter(t,n,r,s){t.reset();let o=t.table,a=o.data,i=o.inTransaction,c=o.pendingInserts,f=o.pendingUpdates,d=o.pendingDeletes;if(!a)throw new R("MemoryTable BTree not initialized in xFilter.",I.INTERNAL);let l=null,h=0,p=!1,g=new Map;r?.split(",").forEach(w=>{let y=w.indexOf("=");y>0&&g.set(w.substring(0,y),w.substring(y+1))}),p=g.get("order")==="DESC";try{switch(n){case 1:case 2:case 4:l=p?a.descending(a.last()):a.ascending(a.first());break;case 3:l=a.descending(a.last());break;case 0:default:l=a.ascending(a.first());break}}catch(w){throw console.error(`Error preparing BTree iterator (idxNum=${n}):`,w),t.reset(),w}let E=[];if(i){let w=new Map,y=o.compareKeys,N=o.keyFromEntry;if(l)for(let C of l){let S=a.at(C);if(S&&!d?.has(S._rowid_)){let O=N(S);w.set(O,S)}}if(f)for(let[C,S]of f.entries())w.has(S.oldKey)&&(w.set(S.oldKey,S.newRow),y(S.oldKey,S.newKey)!==0&&(w.delete(S.oldKey),w.set(S.newKey,S.newRow)));let b=new Map(w);if(c)for(let[C,S]of c.entries())b.set(C,S);E.push(...b.values()),E.sort((C,S)=>{let O=N(C),v=N(S),x=y(O,v);return p?-x:x})}else if(l)for(let w of l){let y=a.at(w);y&&E.push(y)}t.setResults(E)}async xNext(t){t.advance()}async xEof(t){return t.eof()}xColumn(t,n,r){let s=t.getCurrentRow();if(!s)return n.resultNull(),I.OK;if(r===-1)return n.resultInt64(s._rowid_),I.OK;if(r<0||r>=t.table.columns.length)return n.resultError(`Invalid column index ${r}`,I.RANGE),I.RANGE;let o=t.table.columns[r].name,a=Object.prototype.hasOwnProperty.call(s,o)?s[o]:null;return n.resultValue(a??null),I.OK}async xRowid(t){let n=t.getCurrentRowId();if(n===null)throw new R("Cursor is not pointing to a valid row",I.MISUSE);return n}async xUpdate(t,n,r){if(t.isReadOnly())throw new R(`Table '${t.tableName}' is read-only`,I.READONLY);let s=await Tt.acquire(`MemoryTable.xUpdate:${t.schemaName}.${t.tableName}`),o=n._onConflict||oe.ABORT;try{if(n.length===1&&typeof n[0]=="bigint")return t.deleteRow(n[0]),{};if(n.length>1&&n[0]===null){let a=Object.fromEntries(t.columns.map((c,f)=>[c.name,n[f+1]])),i=t.addRow(a);if(i.rowid!==void 0)return{rowid:i.rowid};if(o===oe.IGNORE)return{};{let c=t.getPkColNames()??"rowid";throw new Ct(`UNIQUE constraint failed: ${t.tableName}.${c}`)}}else if(n.length>1&&typeof n[0]=="bigint"){let a=n[0],i=Object.fromEntries(t.columns.map((c,f)=>[c.name,n[f+1]]));try{if(!t.updateRow(a,i))throw new R(`Update failed for rowid ${a}`,I.NOTFOUND);return{}}catch(c){if(c instanceof Ct&&o===oe.IGNORE)return{};throw c}}else throw new R("Unsupported arguments for xUpdate",I.ERROR)}finally{s()}}async xBegin(t){let n=await Tt.acquire(`MemoryTable.xBegin:${t.schemaName}.${t.tableName}`);try{t.inTransaction?console.warn(`MemoryTable ${t.tableName}: Nested transaction started without savepoint support.`):(t.inTransaction=!0,t.pendingInserts=new Map,t.pendingUpdates=new Map,t.pendingDeletes=new Map)}finally{n()}}async xCommit(t){let n=await Tt.acquire(`MemoryTable.xCommit:${t.schemaName}.${t.tableName}`);try{if(!t.inTransaction)return;if(!t.data)throw new Error("BTree missing during commit");if(t.pendingDeletes)for(let[r,s]of t.pendingDeletes.entries()){let o=t.data.find(s.oldKey);if(o.on)try{t.data.deleteAt(o),t.rowidToKeyMap&&t.rowidToKeyMap.delete(r)}catch(a){console.error(`Commit: Failed to delete rowid ${r} with key ${s.oldKey}`,a)}}if(t.pendingUpdates)for(let[r,s]of t.pendingUpdates.entries())if(t.compareKeys(s.oldKey,s.newKey)!==0){if(!t.pendingDeletes?.has(r)){let a=t.data.find(s.oldKey);if(a.on)try{t.data.deleteAt(a)}catch(i){console.warn(`Commit Update: Failed to delete old key ${s.oldKey}`,i)}}t.rowidToKeyMap&&t.rowidToKeyMap.delete(r);try{t.data.insert(s.newRow),t.rowidToKeyMap&&t.rowidToKeyMap.set(r,s.newKey)}catch(a){console.error(`Commit: Failed to insert updated rowid ${r} with new key ${s.newKey}`,a)}}else{let a=t.data.find(s.oldKey);if(a.on)try{t.data.updateAt(a,s.newRow)}catch(i){console.error(`Commit: Failed to update in-place rowid ${r} with key ${s.oldKey}`,i)}else console.warn(`Commit Update: Rowid ${r} with key ${s.oldKey} not found for in-place update.`)}if(t.pendingInserts)for(let[r,s]of t.pendingInserts.entries())try{t.data.insert(s),t.rowidToKeyMap&&t.rowidToKeyMap.set(s._rowid_,r)}catch(o){console.error(`Commit: Failed to insert rowid ${s._rowid_} with key ${r}`,o)}t.pendingInserts=null,t.pendingUpdates=null,t.pendingDeletes=null,t.inTransaction=!1}finally{n()}}async xRollback(t){let n=await Tt.acquire(`MemoryTable.xRollback:${t.schemaName}.${t.tableName}`);try{if(!t.inTransaction)return;t.pendingInserts=null,t.pendingUpdates=null,t.pendingDeletes=null,t.inTransaction=!1}finally{n()}}async xSync(t){}async xRename(t,n){let r=`${t.schemaName.toLowerCase()}.${t.tableName.toLowerCase()}`,s=`${t.schemaName.toLowerCase()}.${n.toLowerCase()}`;if(r!==s){if(this.tables.has(s))throw new R(`Cannot rename memory table: target name '${n}' already exists in schema '${t.schemaName}'`);this.tables.delete(r),t.tableName=n,this.tables.set(s,t),console.log(`Memory table renamed from '${r}' to '${n}'`)}}async xSavepoint(t,n){t.createSavepoint(n)}async xRelease(t,n){t.releaseSavepoint(n)}async xRollbackTo(t,n){t.rollbackToSavepoint(n)}async seekRelative(t,n,r){let s=t.getMergedResults();if(!s||s.length===0)return null;let o=-1;for(let a=0;a<s.length;a++)if(s[a]._rowid_===n){o=a;break}return o===-1||o+r<0||o+r>=s.length?null:s[o+r]._rowid_}async xColumnAtPointer(t,n,r){let s=t.getMergedResults();if(!s||s.length===0)return null;let o;try{let c=BigInt(n);o=s.find(f=>f._rowid_===c)}catch(c){throw console.error("xColumnAtPointer: Could not convert pointer to BigInt",n,c),new R(`xColumnAtPointer: Invalid pointer ${n}`,I.INTERNAL,c instanceof Error?c:void 0)}if(!o)return console.warn(`xColumnAtPointer: Rowid ${n} not found in cursor results.`),null;if(r===-1)return o._rowid_;let a=t.table.columns;if(r<0||r>=a.length)return console.error(`xColumnAtPointer: Invalid column index ${r}`),null;let i=a[r].name;return Object.prototype.hasOwnProperty.call(o,i)?o[i]:null}async xAggregateFrame(t,n,r,s,o){let a=t.getMergedResults();if(!a||a.length===0){let l=new Ze(t.table.db,n.userData);return n.xFinal?(n.xFinal(l),l._getResult()??null):null}let i=-1,c=-1;try{let l=BigInt(r);i=a.findIndex(h=>h._rowid_===l)}catch(l){throw new R(`xAggregateFrame: Invalid start pointer ${r}`,I.INTERNAL,l instanceof Error?l:void 0)}if(s===null)c=a.length-1;else try{let l=BigInt(s);c=a.findIndex(h=>h._rowid_===l)}catch(l){throw new R(`xAggregateFrame: Invalid end pointer ${s}`,I.INTERNAL,l instanceof Error?l:void 0)}if(i===-1)throw new R(`xAggregateFrame: Start pointer row ${r} not found in cursor results`,I.INTERNAL);if(c===-1&&s!==null)throw new R(`xAggregateFrame: End pointer row ${s} not found in cursor results`,I.INTERNAL);i>c&&(i=0,c=-1);let f=new Ze(t.table.db,n.userData),d=[];for(let l=i;l<=c;l++){let h=a[l],p=null;if(o>=0){let g=t.table.columns;if(o>=g.length)throw new Error(`Invalid argColIdx ${o}`);let E=g[o].name;p=Object.prototype.hasOwnProperty.call(h,E)?h[E]:null}f._clear(),n.numArgs>0?d[0]=p:d.length=0;try{if(n.xStep){n.xStep(f,d);let g=f._getError();if(g)throw g}else throw new Error(`Aggregate function ${n.name} missing xStep`)}catch(g){throw new R(`Error during ${n.name} xStep: ${g instanceof Error?g.message:String(g)}`,I.ERROR,g instanceof Error?g:void 0)}}f._clear();try{if(n.xFinal){n.xFinal(f);let l=f._getError();if(l)throw l;return f._getResult()??null}else return n.xValue?(n.xValue(f),f._getResult()??null):(console.warn(`Aggregate function ${n.name} missing xFinal/xValue, returning accumulator.`),f._getAggregateContextRef()??null)}catch(l){throw new R(`Error during ${n.name} xFinal/xValue: ${l instanceof Error?l.message:String(l)}`,I.ERROR,l instanceof Error?l:void 0)}}};var kn=class e{db;program;stmt;programCounter=0;stack=[];framePointer=0;stackPointer=0;localsStartOffset=2;vdbeCursors;hasYielded=!1;done=!1;error=null;appliedBindings=!1;vtabContext;udfContext;ephemeralTables=new Map;static ephemeralModule=new Kt;aggregateContexts=new Map;aggregateIterator=null;currentAggregateEntry=null;savepoints=[];constructor(t,n){this.stmt=t,this.db=t.db,this.program=n;let r=Math.max(n.numMemCells+100,1e3);this.stack=new Array(r).fill(null).map(()=>({value:null})),this.stackPointer=0,this.framePointer=0,this.vdbeCursors=new Array(n.numCursors).fill(null).map(()=>({instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null})),this.vtabContext=new Ze(this.db),this.udfContext=new Ze(this.db)}applyBindings(t){this.appliedBindings||(console.log("VDBE applying bindings to stack..."),t.forEach((n,r)=>{let o=this.program.parameters.get(r)?.memIdx;o!==void 0&&o>=0?this._setStackValue(o,n):console.warn(`Could not map parameter ${r} to stack cell`)}),this.appliedBindings=!0)}clearAppliedBindings(){this.appliedBindings=!1}async reset(){this.programCounter=0,this.stackPointer=0,this.framePointer=0,this.appliedBindings=!1,this.hasYielded=!1,this.done=!1,this.error=null,this.udfContext._clear(),this.udfContext._cleanupAuxData(),this.aggregateContexts.clear(),this.aggregateIterator=null,this.currentAggregateEntry=null,this.savepoints=[];let t=[];for(let n=0;n<this.vdbeCursors.length;n++){let r=this.vdbeCursors[n];r.sortedResults&&(r.sortedResults=null),r.instance&&t.push(r.vtab.module.xClose(r.instance)),r.isEphemeral&&this.ephemeralTables.delete(n),this.vdbeCursors[n]={instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null}}this.ephemeralTables.clear(),await Promise.allSettled(t)}async run(){if(this.done||this.error)return this.error?this.error.code:I.MISUSE;this.hasYielded=!1;try{for(this.appliedBindings||this.applyBindings(new Map);!this.done&&!this.hasYielded&&!this.error;){let t=this.program.instructions[this.programCounter];if(!t){this.error=new R(`Invalid program counter: ${this.programCounter}`,I.INTERNAL);break}console.debug(`VDBE Exec: [${this.programCounter}] FP=${this.framePointer} SP=${this.stackPointer} ${u[t.opcode]} ${t.p1} ${t.p2} ${t.p3} ${t.p4!==null?`P4:${String(t.p4)}`:""} ${t.comment?`-- ${t.comment}`:""}`),await this.executeInstruction(t),!this.error&&!this.done&&!this.hasYielded&&this.programCounter<this.program.instructions.length&&this.program.instructions[this.programCounter]===t&&this.programCounter++}}catch(t){console.error("VDBE Execution Error:",t),t instanceof R?this.error=t:t instanceof Error?this.error=new R(`Runtime error: ${t.message}`,I.ERROR):this.error=new R("Unknown runtime error",I.INTERNAL),this.done=!0}return this.error?this.error.code:this.hasYielded?I.ROW:this.done?I.DONE:I.INTERNAL}_setStackValue(t,n){if(t<0)throw new R(`Invalid stack write index ${t}`,I.INTERNAL);for(;t>=this.stack.length;)this.stack.push({value:null});t>=this.stackPointer&&(this.stackPointer=t+1),this.stack[t]||(this.stack[t]={value:null}),this.stack[t].value=n instanceof Uint8Array?n.slice():n}_getStackValue(t){return t<0||t>=this.stackPointer?null:this.stack[t]?.value??null}_getMemValue(t){let n=this.framePointer+t;return this._getStackValue(n)}_setMem(t,n){if(t<this.localsStartOffset)throw new R(`Write attempt to control info/argument area via _setMem: Offset=${t}`,I.INTERNAL);let r=this.framePointer+t;this._setStackValue(r,n)}async executeInstruction(t){let n=t.p1,r=t.p2,s=t.p3,o=t.p4,a=t.p5,i=c=>{c?this.programCounter=r:this.programCounter++};switch(t.opcode){case u.Init:this.programCounter=r;return;case u.Goto:this.programCounter=r;return;case u.FrameEnter:{let l=n,h=this.stackPointer-1,p=h+l;for(;p>this.stack.length;)this.stack.push({value:null});this._setStackValue(h+1,this.framePointer);for(let g=this.localsStartOffset;g<l;g++)this._setStackValue(h+g,null);this.framePointer=h,this.stackPointer=p;break}case u.FrameLeave:{if(this.framePointer===0&&this._getStackValue(1)===null)console.warn("FrameLeave called on base frame? Potentially harmless if program ends.");else{let l=this._getStackValue(this.framePointer+1),h=typeof l=="number"?l:-1;if(isNaN(h)||h<0)throw new R(`Invalid old frame pointer ${l} at FP ${this.framePointer+1}`,I.INTERNAL);this.stackPointer=this.framePointer,this.framePointer=h}break}case u.Push:{let l=this._getMemValue(n);this._setStackValue(this.stackPointer,l);break}case u.Subroutine:{let l=n,h=r,p=this.programCounter+1;this._setStackValue(this.stackPointer,p),this.programCounter=h;return}case u.Return:{let l=this._getStackValue(this.stackPointer),h=typeof l=="number"?l:-1;if(!Number.isInteger(h)||h<0)throw new R(`Invalid return address ${l} at SP ${this.stackPointer} (expected after FrameLeave)`,I.INTERNAL);this.stackPointer++,this.programCounter=h;return}case u.Integer:this._setMem(r,n);break;case u.Int64:this._setMem(r,this.program.constants[o]);break;case u.String8:this._setMem(r,this.program.constants[o]);break;case u.Null:this._setMem(r,null);break;case u.Real:this._setMem(r,this.program.constants[o]);break;case u.Blob:this._setMem(r,this.program.constants[o]);break;case u.ZeroBlob:{let l=Number(this._getMemValue(n));this._setMem(r,new Uint8Array(l>=0?Math.trunc(l):0));break}case u.SCopy:this._setMem(r,this._getMemValue(n));break;case u.Clear:{let l=n,h=r;if(l<this.localsStartOffset)throw new R(`Clear opcode attempt to clear control/arg area: Offset=${l}`,I.INTERNAL);let p=this.framePointer+l,g=p+h;if(p<0||g>this.stackPointer)throw new R(`Clear opcode stack access out of bounds: FP=${this.framePointer} Offset=${l} Count=${h} SP=${this.stackPointer}`,I.INTERNAL);for(let E=p;E<g;E++)this._setStackValue(E,null);break}case u.IfTrue:i(Go(this._getMemValue(n)));return;case u.IfFalse:i(!Go(this._getMemValue(n)));return;case u.IfZero:{let l=this._getMemValue(n);i(l===0||l===0n||l===null);return}case u.IfNull:i(this._getMemValue(n)===null);return;case u.IfNotNull:i(this._getMemValue(n)!==null);return;case u.IsNull:this._setMem(r,this._getMemValue(n)===null);break;case u.NotNull:this._setMem(r,this._getMemValue(n)!==null);break;case u.Eq:case u.Ne:case u.Lt:case u.Le:case u.Gt:case u.Ge:{let l=this._getMemValue(n),h=this._getMemValue(s),p=r,g=o,E=g?.type==="coll"?g.name:"BINARY",w=fe(l,h,E),y=!1;switch(t.opcode){case u.Eq:y=w===0;break;case u.Ne:y=w!==0;break;case u.Lt:y=w<0;break;case u.Le:y=w<=0;break;case u.Gt:y=w>0;break;case u.Ge:y=w>=0;break}i(y);return}case u.Add:this._binaryArithOp(n,r,s,(l,h)=>Number(l)+Number(h));break;case u.Subtract:this._binaryArithOp(n,r,s,(l,h)=>Number(h)-Number(l));break;case u.Multiply:this._binaryArithOp(n,r,s,(l,h)=>Number(l)*Number(h));break;case u.Divide:{let l=this._getMemValue(n),h=this._getMemValue(r);this._setMem(s,l===0||l===0n||l===null||h===null||Number(l)===0?null:Number(h)/Number(l))}break;case u.Remainder:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null)if(typeof l=="bigint"||typeof h=="bigint"){let g=BigInt(l),E=BigInt(h);g!==0n&&(p=E%g)}else{let g=Number(l),E=Number(h);g!==0&&!isNaN(g)&&!isNaN(E)&&(p=E%g)}}catch{}this._setMem(s,p)}break;case u.Concat:{let l="";for(let h=n;h<=r;h++){let p=this._getMemValue(h);p!==null&&!(p instanceof Uint8Array)&&(l+=String(p))}this._setMem(s,l);break}case u.Negative:{let l=this._getMemValue(n),h=null;try{l!==null&&(h=typeof l=="bigint"?-l:-Number(l)),typeof h=="number"&&isNaN(h)&&(h=null)}catch{h=null}this._setMem(r,h)}break;case u.BitAnd:case u.BitOr:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null){let g=BigInt(l),E=BigInt(h);p=t.opcode===u.BitAnd?g&E:g|E}}catch{p=0n}this._setMem(s,p);break}case u.ShiftLeft:case u.ShiftRight:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null){let g=BigInt(l),E=BigInt(h);p=t.opcode===u.ShiftLeft?E<<g:E>>g}}catch{p=0n}this._setMem(s,p);break}case u.BitNot:{let l=this._getMemValue(n),h=null;try{l!==null&&(h=~BigInt(l))}catch{h=-1n}this._setMem(r,h);break}case u.Function:{let l=o;if(!l||l.type!=="funcdef")throw new R("Invalid P4 for Function",I.INTERNAL);let h=[];for(let p=0;p<l.nArgs;p++)h.push(this._getMemValue(r+p));this.udfContext=new Ze(this.db,l.funcDef.userData),this.udfContext._clear();try{l.funcDef.xFunc(this.udfContext,Object.freeze(h));let p=this.udfContext._getError();if(p)throw p;this._setMem(s,this.udfContext._getResult())}catch(p){throw p instanceof Error?new R(`Func ${l.funcDef.name}: ${p.message}`,I.ERROR):p}break}case u.MakeRecord:{let l=[];for(let p=0;p<r;p++)l.push(this._getMemValue(n+p));let h=JSON.stringify(l,(p,g)=>typeof g=="bigint"?g.toString()+"n":g instanceof Uint8Array?`blob:${Buffer.from(g).toString("hex")}`:g);this._setMem(s,h);break}case u.AggStep:{let l=o;if(!l||l.type!=="funcdef")throw new R("Invalid P4 for AggStep",I.INTERNAL);let p=this._getMemValue(s),g=[];for(let w=0;w<l.nArgs;w++)g.push(this._getMemValue(r+w));let E=this.aggregateContexts.get(p);this.udfContext._clear(),this.udfContext._setAggregateContextRef(E?.accumulator);try{l.funcDef.xStep(this.udfContext,Object.freeze(g));let w=this.udfContext._getError();if(w)throw w;let y=this.udfContext._getAggregateContextRef();if(E===void 0&&y!==void 0){let N=[];for(let b=0;b<a;b++)N.push(this._getMemValue(n+b));this.aggregateContexts.set(p,{accumulator:y,keyValues:Object.freeze(N)})}else E!==void 0&&y!==void 0&&y!==E.accumulator&&(E.accumulator=y)}catch(w){console.error(`VDBE AggStep Error in function ${l.funcDef.name}:`,w),w instanceof R?this.error=w:w instanceof Error?this.error=new R(`Runtime error in aggregate ${l.funcDef.name} xStep: ${w.message}`,I.ERROR):this.error=new R(`Unknown runtime error in aggregate ${l.funcDef.name} xStep`,I.INTERNAL),this.done=!0;return}break}case u.AggFinal:{let l=o;if(!l||l.type!=="funcdef")throw new R("Invalid P4 for AggFinal",I.INTERNAL);let p=this._getMemValue(n),g=this.aggregateContexts.get(p);this.udfContext=new Ze(this.db,l.funcDef.userData),this.udfContext._clear(),this.udfContext._setAggregateContextRef(g?.accumulator);try{l.funcDef.xFinal(this.udfContext);let E=this.udfContext._getError();if(E)throw E;this._setMem(s,this.udfContext._getResult())}catch{}break}case u.AggIterate:this.aggregateIterator=this.aggregateContexts.entries(),this.currentAggregateEntry=null;break;case u.AggNext:if(!this.aggregateIterator)throw new Error;let c=this.aggregateIterator.next();c.done?(this.currentAggregateEntry=null,this.programCounter=r):(this.currentAggregateEntry=c.value,this.programCounter++);return;case u.AggKey:if(!this.currentAggregateEntry)throw new Error;let f=this.currentAggregateEntry[0];this._setMem(r,f);break;case u.AggContext:if(!this.currentAggregateEntry)throw new Error;this._setMem(r,this.currentAggregateEntry[1]?.accumulator);break;case u.AggGroupValue:if(!this.currentAggregateEntry)throw new Error;this._setMem(s,this.currentAggregateEntry[1]?.keyValues[r]??null);break;case u.Affinity:{let l=n,h=r,p=o.toUpperCase(),g=this.framePointer+l,E=g+h;if(l<this.localsStartOffset)throw new R(`Affinity opcode attempt on control/arg area: Offset=${l}`,I.INTERNAL);if(g<0||E>this.stackPointer)throw new R(`Affinity opcode stack access out of bounds: FP=${this.framePointer} Offset=${l} Count=${h} SP=${this.stackPointer}`,I.INTERNAL);let w;switch(p){case"NUMERIC":w=bu;break;case"INTEGER":w=jo;break;case"REAL":w=Nu;break;case"TEXT":w=Cu;break;case"BLOB":w=Su;break;default:w=y=>y}for(let y=0;y<h;y++){let N=l+y,b=this._getMemValue(N),C=w(b);C!==b&&this._setMem(N,C)}break}case u.Move:{let l=n,h=r,p=s,g=this.framePointer+l,E=this.framePointer+h;if(g<0||E<0||g+p>this.stackPointer||E+p>this.stackPointer)throw new R(`Move opcode stack access out of bounds: FP=${this.framePointer} SrcOff=${l} DestOff=${h} Count=${p} SP=${this.stackPointer}`,I.INTERNAL);if(g===E)break;if(E>g&&E<g+p)for(let w=p-1;w>=0;w--)this._setStackValue(E+w,this._getStackValue(g+w));else for(let w=0;w<p;w++)this._setStackValue(E+w,this._getStackValue(g+w));break}case u.OpenRead:{let l=n,h=o;if(!h?.vtabInstance)throw new Error("Missing vtab instance");let p=h.vtabInstance,g=await p.module.xOpen(p);this.vdbeCursors[l]={instance:g,vtab:p,isValid:!1,isEof:!1,sortedResults:null};break}case u.OpenWrite:{let l=n,h=o;if(!h?.vtabInstance)throw new Error("Missing vtab instance");let p=h.vtabInstance,g=await p.module.xOpen(p);this.vdbeCursors[l]={instance:g,vtab:p,isValid:!1,isEof:!1,sortedResults:null};break}case u.Close:{let l=n,h=this.vdbeCursors[l];h&&(h.sortedResults&&(h.sortedResults=null),h.instance&&await h.vtab.module.xClose(h.instance),h.isEphemeral&&this.ephemeralTables.delete(l),this.vdbeCursors[l]={instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null});break}case u.VFilter:{let l=n,h=r,p=s,g=o,E=this.vdbeCursors[l];if(!E?.vtab||!E.instance)throw new Error("VFilter on unopened cursor");let w=[];for(let N=0;N<g.nArgs;N++)w.push(this._getMemValue(p+N));await E.vtab.module.xFilter(E.instance,g.idxNum,g.idxStr,w);let y=await E.vtab.module.xEof(E.instance);E.isEof=y,E.isValid=!y,y?this.programCounter=h:this.programCounter++;return}case u.VNext:{let l=n,h=r,p=this.vdbeCursors[l];if(p?.sortedResults)return;if(!p?.instance)throw new Error("VNext on unopened cursor");await p.vtab.module.xNext(p.instance);let g=await p.vtab.module.xEof(p.instance);p.isEof=g,p.isValid=!g,g?this.programCounter=h:this.programCounter++;return}case u.Rewind:{let l=n,h=r,p=this.vdbeCursors[l];if(p?.sortedResults)return;if(!p?.instance)throw new Error("Rewind on unopened cursor");await p.vtab.module.xFilter(p.instance,0,null,[]);let g=await p.vtab.module.xEof(p.instance);p.isEof=g,p.isValid=!g,g?this.programCounter=h:this.programCounter++;return}case u.VColumn:{let l=n,h=r,p=s,g=this.vdbeCursors[l];if(g?.sortedResults){let w=g.sortedResults;if(w.index<0||w.index>=w.rows.length)throw new Error;let y=w.rows[w.index];if(h<0||h>=y.length)throw new Error;this._setMem(p,y[h].value);break}if(!g?.instance||!g.isValid)throw new Error("VColumn on invalid cursor");this.vtabContext._clear();let E=g.vtab.module.xColumn(g.instance,this.vtabContext,h);if(E!==I.OK)throw new R(`xColumn failed (col ${h}, cursor ${l})`,E);this._setMem(p,this.vtabContext._getResult());break}case u.VRowid:{let l=n,h=r,p=this.vdbeCursors[l];if(!p?.instance||!p.isValid)throw new Error("VRowid on invalid cursor");let g=await p.vtab.module.xRowid(p.instance);this._setMem(h,g);break}case u.VUpdate:{let l=r,h=s,p=n,g=o;if(!g?.table?.vtabInstance?.module?.xUpdate)throw new Error("VUpdate called on non-virtual table or module lacks xUpdate");let E=[];for(let y=0;y<p;y++)E.push(this._getMemValue(l+y)??null);E._onConflict=g.onConflict||oe.ABORT;let w=E[0];try{let y=await g.table.vtabInstance.module.xUpdate(g.table.vtabInstance,E,w);h>0&&(E[0]===null?y&&y.rowid!==void 0?this._setMem(h,y.rowid):this._setMem(h,null):this._setMem(h,null))}catch(y){y instanceof R?this.error=y:y instanceof Error?this.error=new R(`Runtime error during VUpdate: ${y.message}`,I.ERROR):this.error=new R("Unknown error during VUpdate execution",I.ERROR),this.done=!0;return}}break;case u.VBegin:case u.VCommit:case u.VRollback:case u.VSync:case u.VSavepoint:case u.VRelease:case u.VRollbackTo:console.warn(`VTab transaction Opcode ${u[t.opcode]} not fully implemented`);break;case u.ResultRow:let d=this.framePointer+n;if(d<0||d+r>this.stackPointer)throw new R(`ResultRow stack access out of bounds: FP=${this.framePointer} Offset=${n} Count=${r} SP=${this.stackPointer}`,I.INTERNAL);this.stmt.setCurrentRow(this.stack.slice(d,d+r)),this.hasYielded=!0,this.programCounter++;return;case u.Sort:console.warn("Opcode.Sort execution logic needs review for stack frame compatibility.");break;case u.Halt:this.done=!0,n!==I.OK&&(this.error=new R(o??`Execution halted with code ${n}`,n));return;case u.Noop:break;case u.OpenEphemeral:{let l=n,h=r,p=o,g=new Ir(this.db,e.ephemeralModule,"_temp_internal",`_eph_${l}`);if(this.ephemeralTables.set(l,{table:g,module:e.ephemeralModule}),p&&p.columns&&p.primaryKeyDefinition){console.log(`VDBE OpenEphemeral: Initializing cursor ${l} with provided schema (PK def length: ${p.primaryKeyDefinition.length})`);let w=p.columns.map(y=>({name:y.name,type:y.affinity}));g.setColumns(w,p.primaryKeyDefinition)}else{console.log(`VDBE OpenEphemeral: Initializing cursor ${l} with default schema (${h} cols)`);let w=Array.from({length:h},(y,N)=>({name:`eph_col${N}`,type:A.TEXT}));g.setColumns(w,[])}let E=await e.ephemeralModule.xOpen(g);this.vdbeCursors[l]={instance:E,vtab:g,isValid:!1,isEof:!1,isEphemeral:!0};break}case u.StackPop:{let l=n;if(l<0)throw new R("StackPop count cannot be negative",I.INTERNAL);if(this.stackPointer<l)throw new R(`Stack underflow during StackPop: SP=${this.stackPointer}, Count=${l}`,I.INTERNAL);this.stackPointer-=l;break}case u.MaxPtr:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;if(l===null&&h===null)p=null;else if(l===null)p=h;else if(h===null)p=l;else try{p=l>h?l:h}catch(g){console.error("Error comparing pointers for MaxPtr",l,h,g),p=null}this._setMem(s,p);break}case u.SeekRel:{let l=n,h=r,p=s,g=o,E=a,w=this.vdbeCursors[l],y=w?.instance;if(!y)throw new R(`SeekRel: Invalid cursor index ${l}`,I.INTERNAL);let N=this._getMemValue(p),b=this._getMemValue(g),S=(typeof b=="number"||typeof b=="bigint"?Number(b):0)*E,O=null;try{let v=w?.vtab?.module;v&&typeof v.seekRelative=="function"?O=await v.seekRelative(y,N,S):console.warn(`SeekRel: Module for cursor ${l} does not implement seekRelative. Opcode ignored.`)}catch(v){this.handleVTabError(v,`cursor ${l}`,"seekRelative",this.programCounter);return}this._setMem(h,O);break}case u.AggFrame:{let l=n,h=r,p=s,g=o,E=a,w=this.vdbeCursors[l],y=w?.instance,N=w?.vtab?.module;if(!y||!N)throw new R(`AggFrame: Invalid cursor ${l}`,I.INTERNAL);let b=this._getMemValue(p),C=this._getMemValue(E),S=null;try{typeof N.xAggregateFrame=="function"?S=await N.xAggregateFrame(y,g.funcDef,b,C,g.argIdx):console.warn(`AggFrame: Module for cursor ${l} does not implement xAggregateFrame.`)}catch(O){this.handleVTabError(O,`cursor ${l}`,"xAggregateFrame",this.programCounter);return}this._setMem(h,S);break}case u.FrameValue:{let l=n,h=r,p=s,g=o,E=this.vdbeCursors[l],w=E?.instance,y=E?.vtab?.module;if(!w||!y)throw new R(`FrameValue: Invalid cursor ${l}`,I.INTERNAL);let N=this._getMemValue(p),b=null;try{typeof y.xColumnAtPointer=="function"?b=await y.xColumnAtPointer(w,N,g):console.warn(`FrameValue: Module for cursor ${l} does not implement xColumnAtPointer.`)}catch(C){this.handleVTabError(C,`cursor ${l}`,"xColumnAtPointer",this.programCounter);return}this._setMem(h,b);break}case u.RangeScan:{let l=n,h=r,p=s,g=t.p4,E=this.vdbeCursors[l],w=E?.instance;if(!E||!w||!(w instanceof wr))throw new R(`RangeScan: Invalid cursor type for ${l}`,I.INTERNAL);let y=w.getMergedResults();if(!y||y.length===0){this._setMem(h,null),this._setMem(p,null);break}let N=this._getMemValue(g.currPtrReg),b=this._getMemValue(g.partStartPtrReg);if(N===null||N instanceof Uint8Array)throw new R("RangeScan: Current row pointer is NULL or Blob",I.INTERNAL);if(b===null||b instanceof Uint8Array)throw new R("RangeScan: Partition start pointer is NULL or Blob",I.INTERNAL);let C=-1;try{let F=BigInt(N);C=y.findIndex(j=>j._rowid_===F)}catch{throw new R(`RangeScan: Invalid current row pointer value ${N}`,I.INTERNAL)}if(C===-1)throw new R(`RangeScan: Current row pointer ${N} not found in results`,I.INTERNAL);let S=y[C],O=F=>g.orderByIndices.map(j=>F[E.vtab.columns[j].name]),v=O(S),x=(F,j)=>{for(let P=0;P<F.length;P++){let z=g.orderByDirs[P]?-1:1,T=g.orderByColls[P],D=fe(F[P],j[P],T)*z;if(D!==0)return D}return 0},L=-1,U=-1,B=g.frameDef.start,_=g.frameDef.end,k=!1;(B.type==="preceding"||B.type==="following")&&B.value&&(k=!0),_&&(_.type==="preceding"||_.type==="following")&&_.value&&(k=!0);let J=-1,le=null,ae=A.BLOB;if(k){if(g.orderByIndices.length!==1)throw new R("RANGE with offset requires exactly one ORDER BY clause",I.ERROR);if(J=g.orderByIndices[0],le=E.vtab.columns[J],!le)throw new Error(`Invalid orderByColIdx ${J}`);if(ae=le.type||A.BLOB,ae!==A.INTEGER&&ae!==A.REAL&&ae!==A.NUMERIC)throw new R(`RANGE with offset requires ORDER BY clause with NUMERIC affinity (found ${ae})`,I.ERROR)}let ue=(F,j)=>{if(!F||!j)return null;let P=this._getMemValue(j);if(P===null||typeof P!="number"&&typeof P!="bigint")throw new R(`Invalid value for RANGE offset N: ${P}`,I.ERROR);let z=Number(P),T=v[0];if(T===null||typeof T!="number"&&typeof T!="bigint")throw new R(`Cannot calculate RANGE offset from non-numeric current key: ${T}`,I.ERROR);let D=Number(T);return F.type==="preceding"?D-z:F.type==="following"?D+z:null},Ae=ue(B,g.startBoundReg),Le=_?ue(_,g.endBoundReg):null;if(B.type==="unboundedPreceding"){try{let F=BigInt(b);L=y.findIndex(j=>j._rowid_===F)}catch{throw new R(`RangeScan: Invalid partition start pointer value ${b}`,I.INTERNAL)}if(L===-1)throw new R(`RangeScan: Partition start pointer ${b} not found`,I.INTERNAL)}else if(B.type==="currentRow"){for(L=C;L>0&&x(O(y[L-1]),v)===0;)L--;try{let F=BigInt(b),j=y.findIndex(P=>P._rowid_===F);j>L&&(L=j)}catch{}}else if(B.type==="preceding"||B.type==="following"){let F=B.type==="preceding",j=F?fe:(P,z,T)=>-fe(P,z,T);L=-1;for(let P=C;P>=0&&P<y.length;F?P--:P++){let z=O(y[P])[0];if(j(z,Ae,le?.collation)<=0){let T=P;for(;T>0&&x(O(y[T-1]),O(y[P]))===0;)T--;L=T;break}}try{let P=BigInt(b),z=y.findIndex(T=>T._rowid_===P);(L===-1||z>L)&&(L=z)}catch{}}if(!_||_.type==="currentRow")U=y.length-1;else if(_.type==="unboundedFollowing")U=y.length-1;else if(_.type==="preceding"||_.type==="following"){let F=_.type==="following",j=F?fe:(P,z,T)=>-fe(P,z,T);U=-1;for(let P=C;P>=0&&P<y.length;F?P++:P--){let z=O(y[P])[0];if(j(z,Le,le?.collation)<=0){let T=P;for(;T<y.length-1&&x(O(y[T+1]),O(y[P]))===0;)T++;U=T;break}}if(U===-1)if(F)U=y.length-1;else try{let P=BigInt(b);U=y.findIndex(z=>z._rowid_===P)}catch{U=0}}let Ye=L>=0&&L<y.length?y[L]._rowid_:null,Bt=U>=0&&U<y.length?y[U]._rowid_:null;this._setMem(h,Ye),this._setMem(p,Bt);break}case u.Lag:case u.Lead:{let l=n,h=r,p=s,g=t.p4,E=a,w=g.argColIdx,y=this.vdbeCursors[l],N=y?.instance,b=y?.vtab?.module;if(!N||!b||!y.vtab)throw new R(`Lag/Lead: Invalid cursor ${l}`,I.INTERNAL);let C=g.currRowPtrReg,S=this._getMemValue(C);if(S===null||S instanceof Uint8Array)throw new R("Lag/Lead: Current row pointer is NULL or Blob",I.INTERNAL);let O=this._getMemValue(p),v=this._getMemValue(E),x=typeof O=="number"||typeof O=="bigint"?Number(O):1,L=t.opcode===u.Lead?x:-x,U=null,B=v;try{typeof b.seekRelative=="function"?U=await b.seekRelative(N,S,L):console.warn(`Lag/Lead: Module for cursor ${l} does not implement seekRelative.`),U!==null&&(typeof b.xColumnAtPointer=="function"?B=await b.xColumnAtPointer(N,U,w):(console.warn(`Lag/Lead: Module for cursor ${l} does not implement xColumnAtPointer.`),B=v))}catch(_){this.handleVTabError(_,y.vtab.tableName,"seekRelative/xColumnAtPointer",this.programCounter);return}this._setMem(h,B);break}default:throw new R(`Unsupported opcode: ${u[t.opcode]} (${t.opcode})`,I.INTERNAL)}this.programCounter<this.program.instructions.length&&this.program.instructions[this.programCounter]===t&&this.programCounter++}_binaryArithOp(t,n,r,s){let o=this._getMemValue(t),a=this._getMemValue(n),i=null;if(o!==null&&a!==null)if(typeof o=="bigint"||typeof a=="bigint")try{i=s(BigInt(o),BigInt(a))}catch{i=null}else{let c=Number(o),f=Number(a);if(!isNaN(c)&&!isNaN(f))try{i=s(c,f)}catch{i=null}}this._setMem(r,i)}handleVdbeError(t,n,r){let s=`VDBE Error during ${n} at PC ${r}: ${t instanceof Error?t.message:String(t)}`,o=t instanceof R?t.code:I.INTERNAL;this.error=new R(s,o,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}handleVTabError(t,n,r,s){let o=`Error in VTab ${n}.${r} at PC ${s}: ${t instanceof Error?t.message:String(t)}`,a=t instanceof R?t.code:I.ERROR;this.error=new R(o,a,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}handleUdfError(t,n,r,s="xFunc"){let o=`Error in function ${n} (${s}) at PC ${r}: ${t instanceof Error?t.message:String(t)}`,a=t instanceof R?t.code:I.ERROR;this.error=new R(o,a,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}};var Fn=class{db;sql;finalized=!1;busy=!1;boundParameters=new Map;columnNames=[];currentRowInternal=null;vdbeProgram=null;vdbe=null;needsCompile=!0;constructor(t,n){this.db=t,this.sql=n}async compile(){if(this.vdbeProgram&&!this.needsCompile)return this.vdbeProgram;if(this.finalized)throw new $("Statement finalized");console.log("Compiling statement..."),this.vdbeProgram=null;try{let n=new ze().parse(this.sql),r=new On(this.db);this.vdbeProgram=r.compile(n,this.sql),this.needsCompile=!1,console.log("Compilation complete.")}catch(t){throw console.error("Compilation failed:",t),t instanceof R?t:t instanceof St?new R(`Parse error: ${t.message}`,I.ERROR):t instanceof Error?new R(`Compilation error: ${t.message}`,I.INTERNAL):new R("Unknown compilation error",I.INTERNAL)}if(!this.vdbeProgram)throw new R("Compilation resulted in no program",I.INTERNAL);return this.vdbeProgram}bind(t,n){if(this.finalized)throw new $("Statement finalized");if(this.busy)throw new $("Statement busy");if(typeof t=="number"){if(t<1)throw new RangeError(`Parameter index ${t} out of range (must be >= 1)`);this.boundParameters.set(t,n)}else if(typeof t=="string")this.boundParameters.set(t,n);else throw new $("Invalid parameter key type");return this.vdbe&&(this.vdbe.clearAppliedBindings(),this.vdbe.applyBindings(this.boundParameters)),this}bindAll(t){if(this.finalized)throw new $("Statement finalized");if(this.busy)throw new $("Statement busy");if(Array.isArray(t))for(let n=0;n<t.length;n++)this.bind(n+1,t[n]);else if(typeof t=="object"&&t!==null)for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&this.bind(n,t[n]);else throw new $("Invalid parameters type for bindAll. Use array or object.");return this}async step(){if(this.finalized)throw new $("Statement finalized");if(await this.compile(),!this.vdbe&&this.vdbeProgram&&(this.vdbe=new kn(this,this.vdbeProgram),this.vdbe.applyBindings(this.boundParameters)),!this.vdbe)throw new R("VDBE not initialized after compile",I.INTERNAL);this.busy=!0,this.currentRowInternal=null;let t=await this.vdbe.run();if(t===I.ROW){if(!this.currentRowInternal)throw this.busy=!1,new R("VDBE returned ROW but setCurrentRow was not called",I.INTERNAL)}else this.busy=!1,this.currentRowInternal=null;if(t!==I.ROW&&t!==I.DONE&&t!==I.OK)throw new R(`VDBE execution failed with status: ${I[t]}`,t);return console.log(`Step result: ${I[t]}`),t}setCurrentRow(t){this.currentRowInternal=t}getArray(){if(this.finalized)throw new $("Statement finalized");if(!this.currentRowInternal)throw new $("No row available");return this.currentRowInternal.map(t=>t.value)}getAsObject(){if(this.finalized)throw new $("Statement finalized");if(!this.currentRowInternal)throw new $("No row available");let t=this.vdbeProgram?.columnNames||[];if(t.length===0&&this.currentRowInternal.length>0)return this.currentRowInternal.reduce((r,s,o)=>(r[`col_${o}`]=s.value,r),{});if(t.length!==this.currentRowInternal.length)throw new R(`Column name/value count mismatch (${t.length} vs ${this.currentRowInternal.length})`,I.INTERNAL);let n={};for(let r=0;r<t.length;r++){let s=t[r];s in n||(n[s]=this.currentRowInternal[r].value)}return n}getColumnNames(){if(this.finalized)throw new $("Statement finalized");return[...this.vdbeProgram?.columnNames||[]]}async reset(){if(this.finalized)throw new $("Statement finalized");this.vdbe&&await this.vdbe.reset(),this.currentRowInternal=null,this.busy=!1,this.needsCompile=!1}clearBindings(){if(this.finalized)throw new $("Statement finalized");if(this.busy)throw new $("Statement busy - reset first");return this.boundParameters.clear(),this.vdbe&&this.vdbe.clearAppliedBindings(),this}async finalize(){this.finalized||(this.finalized=!0,this.busy=!1,this.vdbe&&await this.vdbe.reset(),this.boundParameters.clear(),this.currentRowInternal=null,this.vdbeProgram=null,this.vdbe=null,this.db._statementFinalized(this))}async run(t){if(this.finalized)throw new $("Statement finalized");if(this.busy)throw new $("Statement busy - already running?");t&&this.bindAll(t);try{let n;do if(n=await this.step(),n===I.ROW)this.currentRowInternal=null;else if(n!==I.DONE&&n!==I.OK)throw new R("Execution failed during run()",n);while(n===I.ROW)}finally{await this.reset()}}async get(t){if(this.finalized)throw new $("Statement finalized");if(this.busy)throw new $("Statement busy - already running?");t&&this.bindAll(t);let n;try{let r=await this.step();if(r===I.ROW)n=this.getAsObject();else if(r!==I.DONE&&r!==I.OK)throw new R("Execution failed during get()",r);let s=r;for(;s===I.ROW;)if(s=await this.step(),s!==I.ROW&&s!==I.DONE&&s!==I.OK){console.warn(`Error consuming remaining rows after get(): ${I[s]}`);break}}finally{await this.reset()}return n}async all(t){if(this.finalized)throw new $("Statement finalized");if(this.busy)throw new $("Statement busy - already running?");t&&this.bindAll(t);let n=[];try{let r;do if(r=await this.step(),r===I.ROW)n.push(this.getAsObject());else if(r!==I.DONE&&r!==I.OK)throw new R("Execution failed during all()",r);while(r===I.ROW)}finally{await this.reset()}return n}getParameterCount(){if(this.finalized)throw new $("Statement finalized");return this.needsCompile&&!this.vdbeProgram?0:this.vdbeProgram?.parameters.size||0}getParameterName(t){if(this.finalized)throw new $("Statement finalized");if(t<1)throw new RangeError("Parameter index must be >= 1");if(this.needsCompile&&!this.vdbeProgram)return null;for(let[n,r]of this.vdbeProgram?.parameters||[])if(typeof n=="string"&&r.memIdx===t)return n;return null}getParameterIndex(t){if(this.finalized)throw new $("Statement finalized");if(!t)throw new $("Parameter name cannot be empty");if(this.needsCompile&&!this.vdbeProgram)return null;let n=this.vdbeProgram?.parameters.get(t);return n?n.memIdx:null}getColumnType(t){if(this.finalized)throw new $("Statement finalized");if(!this.currentRowInternal)throw new $("No row available");if(t<0||t>=this.currentRowInternal.length)throw new RangeError(`Column index ${t} out of range (0-${this.currentRowInternal.length-1})`);let n=this.currentRowInternal[t].value;return n===null?A.NULL:typeof n=="number"?A.REAL:typeof n=="bigint"?A.INTEGER:typeof n=="string"?A.TEXT:n instanceof Uint8Array?A.BLOB:typeof n=="boolean"?A.INTEGER:A.TEXT}getColumnName(t){if(this.finalized)throw new $("Statement finalized");let n=this.vdbeProgram?.columnNames||[];if(t<0||n.length>0&&t>=n.length)throw new RangeError(`Column index ${t} out of range (0-${n.length-1})`);return n[t]||`col_${t}`}getColumnBytes(t){if(this.finalized)throw new $("Statement finalized");if(!this.currentRowInternal)throw new $("No row available");if(t<0||t>=this.currentRowInternal.length)throw new RangeError(`Column index ${t} out of range (0-${this.currentRowInternal.length-1})`);let n=this.currentRowInternal[t].value;return n===null?0:n instanceof Uint8Array?n.byteLength:typeof n=="string"?new TextEncoder().encode(n).length:new TextEncoder().encode(String(n)).length}};var $n=class{schemas=new Map;currentSchemaName="main";modules=new Map;defaultVTabModule=null;db;constructor(t){this.db=t,this.schemas.set("main",new Ln("main")),this.schemas.set("temp",new Ln("temp"))}setCurrentSchema(t){this.schemas.has(t.toLowerCase())?this.currentSchemaName=t.toLowerCase():console.warn(`Attempted to set current schema to non-existent schema: ${t}`)}getCurrentSchemaName(){return this.currentSchemaName}registerModule(t,n){let r=t.toLowerCase();this.modules.has(r)&&console.warn(`Replacing existing virtual table module: ${r}`),this.modules.set(r,n),console.log(`Registered VTab module: ${r}`)}getModule(t){return this.modules.get(t.toLowerCase())}setDefaultVTabModule(t){if(t===null){this.defaultVTabModule=null,console.log("Default VTab module cleared.");return}let n=t.toLowerCase();if(this.modules.has(n))this.defaultVTabModule=n,console.log(`Default VTab module set to: ${n}`);else throw new R(`Cannot set default VTab module: module '${n}' not registered.`)}getDefaultVTabModuleName(){return this.defaultVTabModule}getSchema(t){return this.schemas.get(t.toLowerCase())}getMainSchema(){return this.schemas.get("main")}getTempSchema(){return this.schemas.get("temp")}_getAllSchemas(){return this.schemas.values()}addSchema(t){let n=t.toLowerCase();if(this.schemas.has(n))throw new R(`Schema '${t}' already exists`,I.ERROR);let r=new Ln(t);return this.schemas.set(n,r),console.log(`SchemaManager: Added schema '${t}'`),r}removeSchema(t){let n=t.toLowerCase();if(n==="main"||n==="temp")throw new R(`Cannot detach schema '${t}'`,I.ERROR);let r=this.schemas.get(n);return r?(r.clearFunctions(),r.clearTables(),r.clearViews(),this.schemas.delete(n),console.log(`SchemaManager: Removed schema '${t}'`),!0):!1}findTable(t,n){return n?this.schemas.get(n.toLowerCase())?.getTable(t):this.getMainSchema().getTable(t)??this.getTempSchema().getTable(t)}findFunction(t,n){return this.getMainSchema().getFunction(t,n)}declareVtab(t,n,r,s){let o=this.schemas.get(t.toLowerCase());if(!o)throw new R(`Schema not found: ${t}`,I.ERROR);console.log(`SchemaManager: Declaring VTab in '${t}' using SQL: ${n}`);let a;try{let h=new ze().parse(n);if(h.type!=="createTable")throw new R(`Expected CREATE TABLE statement, got ${h.type}`,I.ERROR);a=h}catch(l){throw new R(`Failed to parse CREATE TABLE statement: ${l.message}`,I.ERROR)}let i=a.table.name,c=a.moduleArgs;if(o.getTable(i)){if(a.ifNotExists)return console.log(`SchemaManager: VTab ${i} already exists in schema ${t}, skipping creation (IF NOT EXISTS).`),o.getTable(i);throw new R(`Table ${i} already exists in schema ${t}`,I.ERROR)}console.warn(`SchemaManager.declareVtab: Using placeholder column definition for ${i}. VTab module should define actual columns.`);let f=[Te("column1"),Te("column2")],d={name:i,schemaName:o.name,columns:Object.freeze(f),columnIndexMap:Object.freeze(Oe(f)),primaryKeyDefinition:Object.freeze(Fl(f)),isVirtual:!0,vtabModule:r.module,vtabInstance:r,vtabAuxData:s,vtabArgs:Object.freeze(c||[]),vtabModuleName:a.moduleName};return o.addTable(d),d}getView(t,n){let r=t??this.currentSchemaName;return this.schemas.get(r)?.getView(n)}getSchemaItem(t,n){let r=t??this.currentSchemaName,s=this.schemas.get(r);if(!s)return;let o=s.getView(n);return o||s.getTable(n)}dropTable(t,n){let r=this.schemas.get(t);if(!r)return!1;let s=r.getTable(n),o=null;s?.isVirtual&&s.vtabInstance&&s.vtabModule?.xDestroy&&(console.log(`Calling xDestroy for VTab ${t}.${n}`),o=s.vtabModule.xDestroy(s.vtabInstance).catch(i=>{console.error(`Error during VTab xDestroy for ${t}.${n}:`,i)}));let a=r.removeTable(n);return o&&o.then(()=>console.log(`xDestroy completed for VTab ${t}.${n}`)),a}dropView(t,n){let r=this.schemas.get(t);return r?r.removeView(n):!1}clearAll(){this.schemas.forEach(t=>{t.clearTables(),t.clearFunctions(),t.clearViews()}),console.log("SchemaManager: Cleared all schemas.")}getSchemaOrFail(t){let n=this.schemas.get(t.toLowerCase());if(!n)throw new R(`Schema not found: ${t}`);return n}getTable(t,n){let r=t??this.currentSchemaName;return this.schemas.get(r)?.getTable(n)}};function Lu(e,t){if(e===null||t===void 0||t==="any")return e;try{switch(t){case"string":return e instanceof Uint8Array?"":String(e);case"number":if(typeof e=="boolean")return e?1:0;let n=Number(e);return isNaN(n)?null:n;case"bigint":return BigInt(e);case"boolean":if(typeof e=="number")return e!==0;if(typeof e=="bigint")return e!==0n;if(typeof e=="string"){let r=e.trim().toLowerCase();if(r==="true")return!0;if(r==="false")return!1;let s=Number(e);return!isNaN(s)&&s!==0}return!!e;case"blob":return e instanceof Uint8Array?e:null}}catch(n){return console.warn(`Coercion failed for value ${e} to type ${t}:`,n),null}return e}function Q(e,t){return{name:e.name,numArgs:e.numArgs,flags:e.flags??M.UTF8|M.DETERMINISTIC,xFunc:(r,s)=>{try{if(e.numArgs>=0&&s.length!==e.numArgs)throw new Error(`Function ${e.name} called with ${s.length} arguments, expected ${e.numArgs}`);let o=s.map((i,c)=>Lu(i,e.argTypes?.[c])),a=t(...o);a==null?r.resultNull():typeof a=="string"?r.resultText(a):typeof a=="number"?Number.isInteger(a)?r.resultInt64(BigInt(a)):r.resultDouble(a):typeof a=="bigint"?r.resultInt64(a):a instanceof Uint8Array?r.resultBlob(a):typeof a=="boolean"?r.resultInt(a?1:0):(console.warn(`Function ${e.name} returned unknown type: ${typeof a}. Coercing to NULL.`),r.resultNull())}catch(o){let a=o instanceof Error?o.message:String(o);r.resultError(`Error in function ${e.name}: ${a}`,I.ERROR)}}}}function De(e,t,n){return{name:e.name,numArgs:e.numArgs,flags:e.flags??M.UTF8,xStep:(s,o)=>{if(e.numArgs>=0&&o.length!==e.numArgs)throw new Error(`Aggregate ${e.name} step called with ${o.length} arguments, expected ${e.numArgs}`);let a=s.getAggregateContext();a===void 0&&(a=e.initialState??null);let i=o.map((f,d)=>Lu(f,e.argTypes?.[d])),c=t(a,...i);s.setAggregateContext(c)},xFinal:s=>{try{let o=s.getAggregateContext();o===void 0&&(o=e.initialState??null);let a=n(o);a==null?s.resultNull():typeof a=="string"?s.resultText(a):typeof a=="number"?Number.isInteger(a)?s.resultInt64(BigInt(a)):s.resultDouble(a):typeof a=="bigint"?s.resultInt64(a):a instanceof Uint8Array?s.resultBlob(a):typeof a=="boolean"?s.resultInt(a?1:0):(console.warn(`Aggregate ${e.name} xFinal returned unknown type: ${typeof a}. Coercing to NULL.`),s.resultNull())}catch(o){let a=o instanceof Error?o.message:String(o);s.resultError(`Error in aggregate function ${e.name} xFinal: ${a}`,I.ERROR)}}}}var xm=e=>typeof e=="string"?e.toLowerCase():null,Ou=Q({name:"lower",numArgs:1,flags:M.UTF8|M.DETERMINISTIC},xm),Lm=e=>typeof e=="string"?e.toUpperCase():null,Mu=Q({name:"upper",numArgs:1,flags:M.UTF8|M.DETERMINISTIC},Lm),Om=e=>e===null?null:typeof e=="string"||e instanceof Uint8Array?e.length:null,Du=Q({name:"length",numArgs:1,flags:M.UTF8|M.DETERMINISTIC},Om),Pu=(e,t,n)=>{if(e===null||t===null)return null;let r=String(e),s=Number(t),o=n===void 0?void 0:Number(n);if(isNaN(s)||o!==void 0&&isNaN(o))return null;s=Math.trunc(s),o=o===void 0?void 0:Math.trunc(o);let a=r.length,i;s>0?i=s-1:s<0?i=a+s:i=0,i=Math.max(0,i);let c;return o===void 0?c=a:o>=0?c=i+o:c=i,r.substring(i,c)},ku=Q({name:"substr",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},(e,t,n)=>Pu(e,t,n)),Fu=Q({name:"substring",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},(e,t,n)=>Pu(e,t,n)),Mm=e=>{if(e===null)return null;if(typeof e=="bigint")return e<0n?-e:e;let t=Number(e);return isNaN(t)?null:Math.abs(t)},$u=Q({name:"abs",numArgs:1,flags:M.DETERMINISTIC},Mm),Dm=(e,t)=>{if(e===null)return null;let n=Number(e);if(isNaN(n))return null;let r=0;if(t!=null){let s=Number(t);if(isNaN(s))return null;r=Math.trunc(s)}try{let s=Math.pow(10,r);return Math.round(n*s)/s}catch{return null}},Uu=Q({name:"round",numArgs:-1,flags:M.DETERMINISTIC},(e,t)=>Dm(e,t)),Pm=(...e)=>{for(let t of e)if(t!==null)return t;return null},Bu=Q({name:"coalesce",numArgs:-1,flags:M.DETERMINISTIC},Pm),km=(e,t)=>fe(e,t)===0?null:e,_u=Q({name:"nullif",numArgs:2,flags:M.DETERMINISTIC},km);function Fm(e,t){let r=e.replace(/[.*+^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,".");try{return new RegExp(`^${r}$`).test(t)}catch(s){return console.error(`Invalid LIKE pattern converted to regex: ^${r}$`,s),!1}}var $m=(e,t)=>e===null||t===null?null:Fm(String(t),String(e)),Vu=Q({name:"like",numArgs:2,flags:M.UTF8|M.DETERMINISTIC},$m);function Um(e,t){let r=e.replace(/[.*+^${}()|[\]\\]/g,"\\$&").replace(/\\\*/g,".*").replace(/\\\?/g,".");try{return new RegExp(`^${r}$`).test(t)}catch(s){return console.error(`Invalid GLOB pattern converted to regex: ^${r}$`,s),!1}}var Bm=(e,t)=>t===null||e===null?null:Um(String(e),String(t)),Ku=Q({name:"glob",numArgs:2,flags:M.UTF8|M.DETERMINISTIC},Bm);var _m=e=>(e??0)+1,Vm=e=>e??0,Gu=De({name:"count",numArgs:0,flags:M.UTF8|M.DETERMINISTIC,initialState:0},_m,Vm),Km=(e,t)=>{if(t===null)return e;let n=e?.sum??0,r=t;try{if(typeof t!="bigint"&&(r=Number(t),isNaN(r)))return e;if(typeof n=="bigint"||typeof r=="bigint")return{sum:BigInt(n)+BigInt(r)};{let s=n+r;return s>Number.MAX_SAFE_INTEGER||s<Number.MIN_SAFE_INTEGER?{sum:BigInt(n)+BigInt(r)}:{sum:s}}}catch(s){return console.warn("Error during SUM step coercion:",s),e}},Gm=e=>e?.sum??null,qu=De({name:"sum",numArgs:1,flags:M.UTF8},Km,Gm),qm=(e,t)=>{if(t===null)return e;let n=e?.sum??0,r=e?.count??0,s=t;try{return typeof t!="bigint"&&(s=Number(t),isNaN(s))?e:{sum:Number(n)+Number(s),count:r+1}}catch(o){return console.warn("Error during AVG step coercion:",o),e}},jm=e=>!e||e.count===0?null:Number(e.sum)/e.count,ju=De({name:"avg",numArgs:1,flags:M.UTF8},qm,jm),Ym=(e,t)=>t===null?e:e===null?{min:t}:fe(t,e.min)<0?{min:t}:e,Wm=e=>e?.min??null,Yu=De({name:"min",numArgs:1,flags:M.UTF8},Ym,Wm),zm=(e,t)=>t===null?e:e===null?{max:t}:fe(t,e.max)>0?{max:t}:e,Zm=e=>e?.max??null,Wu=De({name:"max",numArgs:1,flags:M.UTF8},zm,Zm),Hm=(e,t)=>t===null?e??0:(e??0)+1,Xm=e=>e??0,zu=De({name:"count",numArgs:1,flags:M.UTF8|M.DETERMINISTIC},Hm,Xm),Jm=(e,t,n)=>{if(t===null)return e??{values:[]};let r=e?.values??[],s=String(t);return r.push(s),{values:r}},Qm=(e,t)=>{if(!e||e.values.length===0)return null;let n=t==null?",":String(t);return e.values.join(n)},K0=De({name:"group_concat",numArgs:-1,flags:M.UTF8},(e,...t)=>Jm(e,t[0],t[1]),(e,...t)=>Qm(e,t[1])),ep=(e,t,n=",")=>{let r=e??{values:[],separator:String(n)},s=n==null?r.separator:String(n);if(t===null)return{...r,separator:s};let o=String(t);return r.values.push(o),{values:r.values,separator:s}},tp=e=>!e||e.values.length===0?null:e.values.join(e.separator),Zu=De({name:"group_concat",numArgs:-1,flags:M.UTF8,initialState:{values:[],separator:","}},ep,tp);function _e(e,t,n,r,s){return Pt(t,((o,a)=>{let i=o[a];if(i===void 0)throw new TypeError(Ti(a));return i})(e,t),n,r,s)}function Pt(e,t,n,r,s,o){let a=Cr(t,n,r);if(s&&t!==a)throw new RangeError(Md(e,t,n,r,o));return a}function ve(e){return e!==null&&/object|function/.test(typeof e)}function Ge(e,t=Map){let n=new t;return(r,...s)=>{if(n.has(r))return n.get(r);let o=e(r,...s);return n.set(r,o),o}}function Kn(e){return En({name:e},1)}function En(e,t){return dt(n=>({value:n,configurable:1,writable:!t}),e)}function cc(e){return dt(t=>({get:t,configurable:1}),e)}function ks(e){return{[Symbol.toStringTag]:{value:e,configurable:1}}}function Gn(e,t){let n={},r=e.length;for(let s of t)n[e[--r]]=s;return n}function dt(e,t,n){let r={};for(let s in t)r[s]=e(t[s],s,n);return r}function Mr(e,t,n){let r={};for(let s=0;s<t.length;s++){let o=t[s];r[o]=e(o,s,n)}return r}function fc(e,t,n){let r={};for(let s=0;s<e.length;s++)r[t[s]]=n[e[s]];return r}function Je(e,t){let n=Object.create(null);for(let r of e)n[r]=t[r];return n}function Hu(e,t){for(let n of t)if(n in e)return 1;return 0}function dc(e,t,n){for(let r of e)if(t[r]!==n[r])return 0;return 1}function hc(e,t,n){let r={...n};for(let s=0;s<t;s++)r[e[s]]=0;return r}function te(e,...t){return(...n)=>e(...t,...n)}function Xu(e){return e[0].toUpperCase()+e.substring(1)}function Dr(e){return e.slice().sort()}function Ts(e,t){return String(t).padStart(e,"0")}function qt(e,t){return Math.sign(e-t)}function Cr(e,t,n){return Math.min(Math.max(e,t),n)}function Ot(e,t){return[Math.floor(e/t),Nr(e,t)]}function Nr(e,t){return(e%t+t)%t}function Yt(e,t){return[Fs(e,t),ha(e,t)]}function Fs(e,t){return Math.trunc(e/t)||0}function ha(e,t){return e%t||0}function ws(e){return Math.abs(e%1)===.5}function mc(e,t,n){let r=0,s=0;for(let i=0;i<=t;i++){let c=e[n[i]],f=ft[i],d=ie/f,[l,h]=Yt(c,d);r+=h*f,s+=l}let[o,a]=Yt(r,ie);return[s+o,a]}function $s(e,t,n){let r={};for(let s=t;s>=0;s--){let o=ft[s];r[n[s]]=Fs(e,o),e=ha(e,o)}return r}function pc(e){if(e!==void 0)return Se(e)}function gc(e){if(e!==void 0)return ht(e)}function ma(e){if(e!==void 0)return Us(e)}function ht(e){return yc(Us(e))}function Us(e){return ga(Wp(e))}function Ec(e,t){if(t==null)throw new RangeError(Ti(e));return t}function Pr(e){if(!ve(e))throw new TypeError(Np);return e}function pa(e,t,n=e){if(typeof t!==e)throw new TypeError(tn(n,t));return t}function ga(e,t="number"){if(!Number.isInteger(e))throw new RangeError(gp(t,e));return e||0}function yc(e,t="number"){if(e<=0)throw new RangeError(Ep(t,e));return e}function Ea(e){if(typeof e=="symbol")throw new TypeError(Rp);return String(e)}function bs(e,t){return ve(e)?String(e):Se(e,t)}function ya(e){if(typeof e=="string")return BigInt(e);if(typeof e!="bigint")throw new TypeError(Ip(e));return e}function wc(e,t="number"){if(typeof e=="bigint")throw new TypeError(wp(t));if(e=Number(e),!Number.isFinite(e))throw new RangeError(yp(t,e));return e}function Pe(e,t){return Math.trunc(wc(e,t))||0}function wa(e,t){return ga(wc(e,t),t)}function Ju(e,t){return yc(Pe(e,t),t)}function Ia(e,t){let[n,r]=Yt(t,ie),s=e+n,o=Math.sign(s);return o&&o===-Math.sign(r)&&(s-=o,r+=o*ie),[s,r]}function Bn(e,t,n=1){return Ia(e[0]+t[0]*n,e[1]+t[1]*n)}function mn(e,t){return Ia(e[0],e[1]+t)}function ut(e,t){return Bn(t,e,-1)}function He(e,t){return qt(e[0],t[0])||qt(e[1],t[1])}function Ic(e,t,n){return He(e,t)===-1||He(e,n)===1}function Ra(e,t=1){let n=BigInt(ie/t);return[Number(e/n),Number(e%n)*t]}function Sr(e,t=1){let n=ie/t,[r,s]=Yt(e,n);return[r,s*t]}function ct(e,t=1,n){let[r,s]=e,[o,a]=Yt(s,t);return r*(ie/t)+(o+(n?a/t:0))}function Na(e,t,n=Ot){let[r,s]=e,[o,a]=n(s,t);return[r*(ie/t)+o,a]}function ba(e){return _e(e,"isoYear",Or,Lr,1),e.isoYear===Or?_e(e,"isoMonth",4,12,1):e.isoYear===Lr&&_e(e,"isoMonth",1,9,1),e}function rt(e){return qe({...e,...Fe,isoHour:12}),e}function qe(e){let t=_e(e,"isoYear",Or,Lr,1),n=t===Or?1:t===Lr?-1:0;return n&&mt(Ne({...e,isoDay:e.isoDay+n,isoNanosecond:e.isoNanosecond-n})),e}function mt(e){if(!e||Ic(e,eg,Qp))throw new RangeError(nn);return e}function Wt(e){return mc(e,5,tt)[1]}function Bs(e){let[t,n]=Ot(e,ie);return[$s(n,5,tt),t]}function Qu(e){return Na(e,lt)}function ke(e){return qn(e.isoYear,e.isoMonth,e.isoDay,e.isoHour,e.isoMinute,e.isoSecond,e.isoMillisecond)}function Ne(e){let t=ke(e);if(t!==void 0){let[n,r]=Yt(t,Ke);return[n,r*yt+(e.isoMicrosecond||0)*Vr+(e.isoNanosecond||0)]}}function Ca(e,t){let[n,r]=Bs(Wt(e)-t);return mt(Ne({...e,isoDay:e.isoDay+r,...n}))}function vs(...e){return qn(...e)/Kd}function qn(...e){let[t,n]=Rc(...e),r=t.valueOf();if(!isNaN(r))return r-n*Ke}function Rc(e,t=1,n=1,r=0,s=0,o=0,a=0){let i=e===Or?1:e===Lr?-1:0,c=new Date;return c.setUTCHours(r,s,o,a),c.setUTCFullYear(e,t-1,n+i),[c,i]}function jn(e,t){let[n,r]=mn(e,t);r<0&&(r+=ie,n-=1);let[s,o]=Ot(r,yt),[a,i]=Ot(o,Vr);return _s(n*Ke+s,a,i)}function _s(e,t=0,n=0){let r=Math.ceil(Math.max(0,Math.abs(e)-Vi)/Ke)*Math.sign(e),s=new Date(e-r*Ke);return Gn(Eo,[s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate()+r,s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds(),s.getUTCMilliseconds(),t,n])}function Sa(e,t){if(t<-Vi)throw new RangeError(nn);let n=e.formatToParts(t),r={};for(let s of n)r[s.type]=s.value;return r}function Aa(e){return[e.isoYear,e.isoMonth,e.isoDay]}function Nc(e,t){return[t,0]}function bc(){return Gt}function Cc(e,t){switch(t){case 2:return Ta(e)?29:28;case 4:case 6:case 9:case 11:return 30}return 31}function Sc(e){return Ta(e)?366:365}function Ta(e){return e%4==0&&(e%100!=0||e%400==0)}function Ac(e){let[t,n]=Rc(e.isoYear,e.isoMonth,e.isoDay);return Nr(t.getUTCDay()-n,7)||7}function Tc(e){return this.id===tr?(({isoYear:t})=>t<1?["gregory-inverse",1-t]:["gregory",t])(e):this.id===Ht?rg(e):[]}function np(e){let t=ke(e);if(t<ng){let{isoYear:o}=e;return o<1?["japanese-inverse",1-o]:["japanese",o]}let n=Sa(Yi(Ht),t),{era:r,eraYear:s}=Kf(n,Ht);return[r,s]}function Vs(e){return yn(e),Yn(e,1),e}function yn(e){return vc(e,1),e}function ec(e){return dc(Ui,e,vc(e))}function vc(e,t){let{isoYear:n}=e,r=_e(e,"isoMonth",1,bc(),t);return{isoYear:n,isoMonth:r,isoDay:_e(e,"isoDay",1,Cc(n,r),t)}}function Yn(e,t){return Gn(tt,[_e(e,"isoHour",0,23,t),_e(e,"isoMinute",0,59,t),_e(e,"isoSecond",0,59,t),_e(e,"isoMillisecond",0,999,t),_e(e,"isoMicrosecond",0,999,t),_e(e,"isoNanosecond",0,999,t)])}function re(e){return e===void 0?0:sh(Pr(e))}function kr(e,t=0){e=pt(e);let n=oh(e),r=hg(e,t);return[sh(e),r,n]}function Wn(e,t,n,r=9,s=0,o=4){t=pt(t);let a=rh(t,r,s),i=La(t),c=qr(t,o),f=Gr(t,r,s,1);return a==null?a=Math.max(n,f):Dc(a,f),i=Oa(i,f,1),e&&(c=(d=>d<4?(d+2)%4:d)(c)),[a,f,i,c]}function Ks(e,t=6,n){let r=La(e=Gs(e,Ps)),s=qr(e,7),o=Gr(e,t);return o=Ec(Ps,o),r=Oa(r,o,void 0,n),[o,r,s]}function va(e){return Ki(pt(e))}function xc(e,t){return xa(pt(e),t)}function Lc(e){let t=Gs(e,oa),n=Xt(oa,fg,t,0);if(!n)throw new RangeError(tn(oa,n));return n}function xa(e,t=4){let n=Mc(e);return[qr(e,4),...Oc(Gr(e,t),n)]}function Oc(e,t){return e!=null?[ft[e],e<4?9-3*e:-1]:[t===void 0?1:10**(9-t),t]}function La(e){let t=e[br];return t===void 0?1:Pe(t,br)}function Oa(e,t,n,r){let s=r?ie:ft[t+1];if(s){let o=ft[t];if(s%((e=Pt(br,e,1,s/o-(r?0:1),1))*o))throw new RangeError(tn(br,e))}else e=Pt(br,e,1,n?10**9:1,1);return e}function Mc(e){let t=e[sa];if(t!==void 0){if(typeof t!="number"){if(Ea(t)==="auto")return;throw new RangeError(tn(sa,t))}t=Pt(sa,Math.floor(t),0,9,1)}return t}function pt(e){return e===void 0?{}:Pr(e)}function Gs(e,t){return typeof e=="string"?{[t]:e}:Pr(e)}function qs(e){return{overflow:sg[e]}}function Ma(e,t,n=9,r=0,s){let o=t[e];if(o===void 0)return s?r:void 0;if(o=Ea(o),o==="auto")return s?r:null;let a=ia[o];if(a===void 0&&(a=Hp[o]),a===void 0)throw new RangeError(kd(e,o,ia));return Pt(e,a,r,n,1,Li),a}function Xt(e,t,n,r=0){let s=n[e];if(s===void 0)return r;let o=Ea(s),a=t[o];if(a===void 0)throw new RangeError(kd(e,o,t));return a}function Dc(e,t){if(t>e)throw new RangeError(Vp)}function gt(e){return{branding:Ro,epochNanoseconds:e}}function Qe(e,t,n){return{branding:Ut,calendar:n,timeZone:t,epochNanoseconds:e}}function et(e,t=e.calendar){return{branding:Cn,calendar:t,...Je(Xp,e)}}function Et(e,t=e.calendar){return{branding:nr,calendar:t,...Je(Bi,e)}}function Ar(e,t=e.calendar){return{branding:yo,calendar:t,...Je(Bi,e)}}function xs(e,t=e.calendar){return{branding:wo,calendar:t,...Je(Bi,e)}}function ot(e){return{branding:Io,...Je(Qd,e)}}function Ee(e){return{branding:No,sign:Jt(e),...Je(ki,e)}}function js(e){return Na(e.epochNanoseconds,yt)[0]}function Pc(e){return((t,n=1)=>{let[r,s]=t,o=Math.floor(s/n),a=ie/n;return BigInt(r)*BigInt(a)+BigInt(o)})(e.epochNanoseconds)}function kc(e){return e.epochNanoseconds}function Fc(e,t,n,r,s){let o=pn(r),[a,i]=((y,N)=>{let b=N((y=Gs(y,ca))[th]),C=dg(y);return C=Ec(ca,C),[C,b]})(s,e),c=Math.max(a,o);if(!i&&vr(c,i))return tc(r,a);if(!i)throw new RangeError(ho);if(!r.sign)return 0;let[f,d,l]=Xs(t,n,i),h=ei(l),p=Js(l),g=ti(l),E=p(d,f,r);_n(i)||(qe(f),qe(E));let w=g(d,f,E,a);return vr(a,i)?tc(w,a):((y,N,b,C,S,O,v)=>{let x=Jt(y),[L,U]=Da(C,$i(b,y),b,x,S,O,v),B=Pa(N,L,U);return y[se[b]]+B*x})(w,h(E),a,d,f,h,p)}function tc(e,t){return ct(be(e),ft[t],1)}function Da(e,t,n,r,s,o,a){let i=se[n],c={...t,[i]:t[i]+r},f=a(e,s,t),d=a(e,s,c);return[o(f),o(d)]}function Pa(e,t,n){let r=ct(ut(t,n));if(!r)throw new RangeError(er);return ct(ut(t,e))/r}function $c(e,t){let[n,r,s]=Ks(t,5,1);return gt(Ws(e.epochNanoseconds,n,r,s,1))}function Uc(e,t,n){let{epochNanoseconds:r,timeZone:s,calendar:o}=t,[a,i,c]=Ks(n);if(a===0&&i===1)return t;let f=e(s);if(a===6)r=((d,l,h,p)=>{let g=je(h,l),[E,w]=d(g),y=h.epochNanoseconds,N=Zt(l,E),b=Zt(l,w);if(Ic(y,N,b))throw new RangeError(er);return Wc(Pa(y,N,b),p)?b:N})(jc,f,t,c);else{let d=f.R(r);r=Zn(f,Gc(jn(r,d),a,i,c),d,2,0,1)}return Qe(r,s,o)}function Bc(e,t){return et(Gc(e,...Ks(t)),e.calendar)}function _c(e,t){let[n,r,s]=Ks(t,5);var o;return ot((o=s,ka(e,Fr(n,r),o)[0]))}function Vc(e,t){let n=e(t.timeZone),r=je(t,n),[s,o]=jc(r),a=ct(ut(Zt(n,s),Zt(n,o)),go,1);if(a<=0)throw new RangeError(er);return a}function Kc(e,t){let{timeZone:n,calendar:r}=t,s=((o,a,i)=>Zt(a,o(je(i,a))))(Yc,e(n),t);return Qe(s,n,r)}function Gc(e,t,n,r){return qc(e,Fr(t,n),r)}function qc(e,t,n){let[r,s]=ka(e,t,n);return qe({...wn(e,s),...r})}function ka(e,t,n){return Bs(zt(Wt(e),t,n))}function Ls(e){return zt(e,po,7)}function Fr(e,t){return ft[e]*t}function jc(e){let t=Yc(e);return[t,wn(t,1)]}function Yc(e){return Jp(6,e)}function rp(e,t,n){let r=Math.min(pn(e),6);return Hn(zs(be(e,r),t,n),r)}function Ys(e,t,n,r,s,o,a,i,c,f){if(r===0&&s===1)return e;let d=vr(r,i)?_n(i)&&r<6&&n>=6?op:sp:ap,[l,h,p]=d(e,t,n,r,s,o,a,i,c,f);return p&&r!==7&&(l=((g,E,w,y,N,b,C,S)=>{let O=Jt(g);for(let v=y+1;v<=w;v++){if(v===7&&w!==7)continue;let x=$i(v,g);x[se[v]]+=O;let L=ct(ut(C(S(N,b,x)),E));if(L&&Math.sign(L)!==O)break;g=x}return g})(l,h,n,Math.max(6,r),a,i,c,f)),l}function Ws(e,t,n,r,s){if(t===6){let o=(a=>a[0]+a[1]/ie)(e);return[zt(o,n,r),0]}return zs(e,Fr(t,n),r,s)}function zs(e,t,n,r){let[s,o]=e;r&&o<0&&(o+=ie,s-=1);let[a,i]=Ot(zt(o,t,n),ie);return Ia(s+a,i)}function zt(e,t,n){return Wc(e/t,n)*t}function Wc(e,t){return gg[t](e)}function sp(e,t,n,r,s,o){let a=Jt(e),i=be(e),c=Ws(i,r,s,o),f=ut(i,c),d=Math.sign(c[0]-i[0])===a,l=Hn(c,Math.min(n,6));return[{...e,...l},Bn(t,f),d]}function op(e,t,n,r,s,o,a,i,c,f){let d=Jt(e)||1,l=ct(be(e,5)),h=Fr(r,s),p=zt(l,h,o),[g,E]=Da(a,{...e,...Fi},6,d,i,c,f),w=p-ct(ut(g,E)),y=0;w&&Math.sign(w)!==d?t=mn(g,p):(y+=d,p=zt(w,h,o),t=mn(E,p));let N=eo(p);return[{...e,...N,days:e.days+y},t,!!y]}function ap(e,t,n,r,s,o,a,i,c,f){let d=Jt(e),l=se[r],h=$i(r,e);r===7&&(e={...e,weeks:e.weeks+Math.trunc(e.days/7)});let p=Fs(e[l],s)*s;h[l]=p;let[g,E]=Da(a,h,r,s*d,i,c,f),w=p+Pa(t,g,E)*d*s,y=zt(w,s,o),N=Math.sign(y-w)===d;return h[l]=y,[h,N?E:g,N]}function Fa(e,t,n,r){let[s,o,a,i]=(f=>{let d=xa(f=pt(f));return[f.timeZone,...d]})(r),c=s!==void 0;return((f,d,l,h,p,g)=>{l=zs(l,p,h,1);let E=d.R(l);return Ga(jn(l,E),g)+(f?zn(Ls(E)):"Z")})(c,t(c?e(s):Sn),n.epochNanoseconds,o,a,i)}function $a(e,t,n){let[r,s,o,a,i,c]=(f=>{f=pt(f);let d=Ki(f),l=Mc(f),h=pg(f),p=qr(f,4),g=Gr(f,4);return[d,mg(f),h,p,...Oc(g,l)]})(n);return((f,d,l,h,p,g,E,w,y,N)=>{h=zs(h,y,w,1);let b=f(l).R(h);return Ga(jn(h,b),N)+zn(Ls(b),E)+((C,S)=>S!==1?"["+(S===2?"!":"")+C+"]":"")(l,g)+qa(d,p)})(e,t.calendar,t.timeZone,t.epochNanoseconds,r,s,o,a,i,c)}function Ua(e,t){let[n,r,s,o]=(f=>(f=pt(f),[Ki(f),...xa(f)]))(t);return a=e.calendar,i=n,c=o,Ga(qc(e,s,r),c)+qa(a,i);var a,i,c}function Ba(e,t){return n=e.calendar,r=e,s=va(t),Os(r)+qa(n,s);var n,r,s}function _a(e,t){return zc(e.calendar,Zc,e,va(t))}function Va(e,t){return zc(e.calendar,ip,e,va(t))}function Ka(e,t){let[n,r,s]=xc(t);return o=s,Hc(ka(e,r,n)[0],o);var o}function Zs(e,t){let[n,r,s]=xc(t,3);return r>1&&In(e={...e,...rp(e,r,n)}),((o,a)=>{let{sign:i}=o,c=i===-1?$e(o):o,{hours:f,minutes:d}=c,[l,h]=Na(be(c,3),lt,Yt);rf(l);let p=ja(h,a),g=a>=0||!i||p;return(i<0?"-":"")+"P"+nc({Y:hn(c.years),M:hn(c.months),W:hn(c.weeks),D:hn(c.days)})+(f||d||l||g?"T"+nc({H:hn(f),M:hn(d),S:hn(l,g)+p}):"")})(e,s)}function zc(e,t,n,r){let s=r>1||r===0&&e!==ne;return r===1?e===ne?t(n):Os(n):s?Os(n)+Xc(e,r===2):t(n)}function nc(e){let t=[];for(let n in e){let r=e[n];r&&t.push(r,n)}return t.join("")}function Ga(e,t){return Os(e)+"T"+Hc(e,t)}function Os(e){return Zc(e)+"-"+st(e.isoDay)}function Zc(e){let{isoYear:t}=e;return(t<0||t>9999?Jc(t)+Ts(6,Math.abs(t)):Ts(4,t))+"-"+st(e.isoMonth)}function ip(e){return st(e.isoMonth)+"-"+st(e.isoDay)}function Hc(e,t){let n=[st(e.isoHour),st(e.isoMinute)];return t!==-1&&n.push(st(e.isoSecond)+((r,s,o,a)=>ja(r*yt+s*Vr+o,a))(e.isoMillisecond,e.isoMicrosecond,e.isoNanosecond,t)),n.join(":")}function zn(e,t=0){if(t===1)return"";let[n,r]=Ot(Math.abs(e),go),[s,o]=Ot(r,po),[a,i]=Ot(o,lt);return Jc(e)+st(n)+":"+st(s)+(a||i?":"+st(a)+ja(i):"")}function qa(e,t){return t!==1&&(t>1||t===0&&e!==ne)?Xc(e,t===2):""}function Xc(e,t){return"["+(t?"!":"")+"u-ca="+e+"]"}function ja(e,t){let n=Ts(9,e);return n=t===void 0?n.replace(wg,""):n.slice(0,t),n?"."+n:""}function Jc(e){return e<0?"-":"+"}function hn(e,t){return e||t?e.toLocaleString("fullwide",{useGrouping:0}):""}function lp(e,t){let{epochNanoseconds:n}=e,r=(t.R?t:t(e.timeZone)).R(n),s=jn(n,r);return{calendar:e.calendar,...s,offsetNanoseconds:r}}function Zn(e,t,n,r=0,s=0,o,a){if(n!==void 0&&r===1&&(r===1||a))return Ca(t,n);let i=e.I(t);if(n!==void 0&&r!==3){let c=((f,d,l,h)=>{let p=Ne(d);h&&(l=Ls(l));for(let g of f){let E=ct(ut(g,p));if(h&&(E=Ls(E)),E===l)return g}})(i,t,n,o);if(c!==void 0)return c;if(r===0)throw new RangeError(kp)}return a?Ne(t):$r(e,t,s,i)}function $r(e,t,n=0,r=e.I(t)){if(r.length===1)return r[0];if(n===1)throw new RangeError(Fp);if(r.length)return r[n===3?1:0];let s=Ne(t),o=((i,c)=>{let f=i.R(mn(c,-ie));return(d=>{if(d>ie)throw new RangeError(Pp);return d})(i.R(mn(c,ie))-f)})(e,s),a=o*(n===2?-1:1);return(r=e.I(jn(s,a)))[n===2?0:r.length-1]}function Zt(e,t){let n=e.I(t);if(n.length)return n[0];let r=mn(Ne(t),-ie);return e.O(r,1)}function Ya(e,t,n){return gt(mt(Bn(t.epochNanoseconds,(r=>{if(sf(r))throw new RangeError(Bp);return be(r,5)})(e?$e(n):n))))}function Wa(e,t,n,r,s,o=Object.create(null)){let a=t(r.timeZone),i=e(r.calendar);return{...r,...Ja(a,i,r,n?$e(s):s,o)}}function za(e,t,n,r,s=Object.create(null)){let{calendar:o}=n;return et(Qa(e(o),n,t?$e(r):r,s),o)}function Za(e,t,n,r,s){let{calendar:o}=n;return Et(Hs(e(o),n,t?$e(r):r,s),o)}function Ha(e,t,n,r,s){let o=n.calendar,a=e(o),i=rt(Tr(a,n));t&&(r=Qs(r)),r.sign<0&&(i=a.P(i,{...Ce,months:1}),i=wn(i,-1));let c=a.P(i,r,s);return Ar(Tr(a,c),o)}function Xa(e,t,n){return ot(Qc(t,e?$e(n):n)[0])}function Ja(e,t,n,r,s){let o=be(r,5),a=n.epochNanoseconds;if(sf(r)){let i=je(n,e);a=Bn($r(e,{...Hs(t,i,{...r,...Fi},s),...Je(tt,i)}),o)}else a=Bn(a,o),re(s);return{epochNanoseconds:mt(a)}}function Qa(e,t,n,r){let[s,o]=Qc(t,n);return qe({...Hs(e,t,{...n,...Fi,days:n.days+o},r),...s})}function Hs(e,t,n,r){if(n.years||n.months||n.weeks)return e.P(t,n,r);re(r);let s=n.days+be(n,5)[0];return s?rt(wn(t,s)):t}function Tr(e,t,n=1){return wn(t,n-e.day(t))}function Qc(e,t){let[n,r]=be(t,5),[s,o]=Bs(Wt(e)+r);return[s,n+o]}function wn(e,t){return t?{...e,..._s(ke(e)+t*Ke)}:e}function Xs(e,t,n){let r=e(n.calendar);return _n(n)?[n,r,t(n.timeZone)]:[{...n,...Fe},r]}function ei(e){return e?kc:Ne}function Js(e){return e?te(Ja,e):Qa}function ti(e){return e?te(cp,e):fp}function _n(e){return e&&e.epochNanoseconds}function vr(e,t){return e<=6-(_n(t)?1:0)}function ni(e,t,n,r,s,o,a){let i=e(pt(a).relativeTo),c=Math.max(pn(s),pn(o));if(vr(c,i))return Ee(In(((E,w,y,N)=>{let b=Bn(be(E),be(w),N?-1:1);if(!Number.isFinite(b[0]))throw new RangeError(nn);return{...Ce,...Hn(b,y)}})(s,o,c,r)));if(!i)throw new RangeError(ho);r&&(o=$e(o));let[f,d,l]=Xs(t,n,i),h=Js(l),p=ti(l),g=h(d,f,s);return Ee(p(d,f,h(d,g,o),c))}function ef(e,t,n,r,s){let o=pn(r),[a,i,c,f,d]=((O,v,x)=>{O=Gs(O,Ps);let L=rh(O),U=x(O[th]),B=La(O),_=qr(O,7),k=Gr(O);if(L===void 0&&k===void 0)throw new RangeError(_p);if(k==null&&(k=0),L==null&&(L=Math.max(k,v)),Dc(L,k),B=Oa(B,k,1),B>1&&k>5&&L!==k)throw new RangeError("For calendar units with roundingIncrement > 1, use largestUnit = smallestUnit");return[L,k,B,_,U]})(s,o,e),l=Math.max(o,a);if(!d&&l<=6)return Ee(In(((O,v,x,L,U)=>{let B=Ws(be(O),x,L,U);return{...Ce,...Hn(B,v)}})(r,a,i,c,f)));if(!_n(d)&&!r.sign)return r;if(!d)throw new RangeError(ho);let[h,p,g]=Xs(t,n,d),E=ei(g),w=Js(g),y=ti(g),N=w(p,h,r);_n(d)||(qe(h),qe(N));let b=y(p,h,N,a),C=r.sign,S=Jt(b);if(C&&S&&C!==S)throw new RangeError(er);return b=Ys(b,E(N),a,i,c,f,p,h,E,w),Ee(b)}function tf(e){return e.sign===-1?Qs(e):e}function Qs(e){return Ee($e(e))}function $e(e){let t={};for(let n of se)t[n]=-1*e[n]||0;return t}function nf(e){return!e.sign}function Jt(e,t=se){let n=0;for(let r of t){let s=Math.sign(e[r]);if(s){if(n&&n!==s)throw new RangeError(Up);n=s}}return n}function In(e){for(let t of Zp)Pt(t,e[t],-ic,ic,1);return rf(ct(be(e),lt)),e}function rf(e){if(!Number.isSafeInteger(e))throw new RangeError($p)}function be(e,t=6){return mc(e,t,se)}function Hn(e,t=6){let[n,r]=e,s=$s(r,t,se);if(s[se[t]]+=n*(ie/ft[t]),!Number.isFinite(s[se[t]]))throw new RangeError(nn);return s}function eo(e,t=5){return $s(e,t,se)}function sf(e){return!!Jt(e,Jd)}function pn(e){let t=9;for(;t>0&&!e[se[t]];t--);return t}function up(e,t){return[e,t]}function rc(e){let t=Math.floor(e/Ss)*Ss;return[t,t+Ss]}function of(e){let t=Qt(e=bs(e));if(!t)throw new RangeError(Ve(e));let n;if(t.j)n=0;else{if(!t.offset)throw new RangeError(Ve(e));n=Rn(t.offset)}return t.timeZone&&ai(t.timeZone,1),gt(Ca(Vs(t),n))}function af(e){let t=Qt(Se(e));if(!t)throw new RangeError(Ve(e));if(t.timeZone)return gf(t,t.offset?Rn(t.offset):void 0);if(t.j)throw new RangeError(Ve(e));return yf(t)}function lf(e,t){let n=Qt(Se(e));if(!n||!n.timeZone)throw new RangeError(Ve(e));let{offset:r}=n,s=r?Rn(r):void 0,[,o,a]=kr(t);return gf(n,s,o,a)}function Rn(e){let t=ai(e);if(t===void 0)throw new RangeError(Ve(e));return t}function uf(e){let t=Qt(Se(e));if(!t||t.j)throw new RangeError(Ve(e));return et(Ef(t))}function to(e,t,n){let r=Qt(Se(e));if(!r||r.j)throw new RangeError(Ve(e));return t?r.calendar===ne&&(r=r.isoYear===-271821&&r.isoMonth===4?{...r,isoDay:20,...Fe}:{...r,isoDay:1,...Fe}):n&&r.calendar===ne&&(r={...r,isoYear:Dt}),Et(r.C?Ef(r):yf(r))}function cf(e,t){let n=si(Se(t));if(n)return ri(n),Ar(ba(yn(n)));let r=to(t,1);return Ar(Tr(e(r.calendar),r))}function ri(e){if(e.calendar!==ne)throw new RangeError(Mt(e.calendar))}function ff(e,t){let n=oi(Se(t));if(n)return ri(n),xs(yn(n));let r=to(t,0,1),{calendar:s}=r,o=e(s),[a,i,c]=o.v(r),[f,d]=o.q(a,i),[l,h]=o.G(f,d,c);return xs(rt(o.V(l,h,c)),s)}function df(e){let t,n=(r=>{let s=Cg.exec(r);return s?(no(s[10]),Rf(s)):void 0})(Se(e));if(!n){if(n=Qt(e),!n)throw new RangeError(Ve(e));if(!n.C)throw new RangeError(Ve(e));if(n.j)throw new RangeError(Mt("Z"));ri(n)}if((t=si(e))&&ec(t))throw new RangeError(Ve(e));if((t=oi(e))&&ec(t))throw new RangeError(Ve(e));return ot(Yn(n,1))}function hf(e){let t=(n=>{let r=Tg.exec(n);return r?(s=>{function o(d,l,h){let p=0,g=0;if(h&&([p,c]=Ot(c,ft[h])),d!==void 0){if(i)throw new RangeError(Mt(d));g=(E=>{let w=parseInt(E);if(!Number.isFinite(w))throw new RangeError(Mt(E));return w})(d),a=1,l&&(c=ii(l)*(ft[h]/lt),i=1)}return p+g}let a=0,i=0,c=0,f={...Gn(se,[o(s[2]),o(s[3]),o(s[4]),o(s[5]),o(s[6],s[7],5),o(s[8],s[9],4),o(s[10],s[11],3)]),...$s(c,2,se)};if(!a)throw new RangeError(Dd(se));return li(s[1])<0&&(f=$e(f)),f})(r):void 0})(Se(e));if(!t)throw new RangeError(Ve(e));return Ee(In(t))}function mf(e){let t=Qt(e)||si(e)||oi(e);return t?t.calendar:e}function pf(e){let t=Qt(e);return t&&(t.timeZone||t.j&&Sn||t.offset)||e}function gf(e,t,n=0,r=0){let s=ro(e.timeZone),o=H(s),a;return Vs(e),a=e.C?Zn(o,e,t,n,r,!o.$,e.j):Zt(o,e),Qe(a,s,Br(e.calendar))}function Ef(e){return wf(qe(Vs(e)))}function yf(e){return wf(rt(yn(e)))}function wf(e){return{...e,calendar:Br(e.calendar)}}function Qt(e){let t=bg.exec(e);return t?(n=>{let r=n[10],s=(r||"").toUpperCase()==="Z";return{isoYear:If(n),isoMonth:parseInt(n[4]),isoDay:parseInt(n[5]),...Rf(n.slice(5)),...no(n[16]),C:!!n[6],j:s,offset:s?void 0:r}})(t):void 0}function si(e){let t=Rg.exec(e);return t?(n=>({isoYear:If(n),isoMonth:parseInt(n[4]),isoDay:1,...no(n[5])}))(t):void 0}function oi(e){let t=Ng.exec(e);return t?(n=>({isoYear:Dt,isoMonth:parseInt(n[1]),isoDay:parseInt(n[2]),...no(n[3])}))(t):void 0}function ai(e,t){let n=Sg.exec(e);return n?((r,s)=>{let o=r[4]||r[5];if(s&&o)throw new RangeError(Mt(o));return(a=>{if(Math.abs(a)>=ie)throw new RangeError(Dp);return a})((Un(r[2])*go+Un(r[3])*po+Un(r[4])*lt+ii(r[5]||""))*li(r[1]))})(n,t):void 0}function If(e){let t=li(e[1]),n=parseInt(e[2]||e[3]);if(t<0&&!n)throw new RangeError(Mt(-0));return t*n}function Rf(e){let t=Un(e[3]);return{...Bs(ii(e[4]||""))[0],isoHour:Un(e[1]),isoMinute:Un(e[2]),isoSecond:t===60?59:t}}function no(e){let t,n,r=[];if(e.replace(Ag,(s,o,a)=>{let i=!!o,[c,f]=a.split("=").reverse();if(f){if(f==="u-ca")r.push(c),t||(t=i);else if(i||/[A-Z]/.test(f))throw new RangeError(Mt(s))}else{if(n)throw new RangeError(Mt(s));n=c}return""}),r.length>1&&t)throw new RangeError(Mt(e));return{timeZone:n,calendar:r[0]||ne}}function ii(e){return parseInt(e.padEnd(9,"0"))}function Xn(e){return new RegExp(`^${e}$`,"i")}function li(e){return e&&e!=="+"?-1:1}function Un(e){return e===void 0?0:parseInt(e)}function Nf(e){return ro(Se(e))}function ro(e){let t=ui(e);return typeof t=="number"?zn(t):t?(n=>{if(Lg.test(n))throw new RangeError(xi(n));if(xg.test(n))throw new RangeError(Mp);return n.toLowerCase().split("/").map((r,s)=>(r.length<=3||/\d/.test(r))&&!/etc|yap/.test(r)?r.toUpperCase():r.replace(/baja|dumont|[a-z]+/g,(o,a)=>o.length<=2&&!s||o==="in"||o==="chat"?o.toUpperCase():o.length>2||!a?Xu(o).replace(/island|noronha|murdo|rivadavia|urville/,Xu):o)).join("/")})(e):Sn}function sc(e){let t=ui(e);return typeof t=="number"?t:t?t.resolvedOptions().timeZone:Sn}function ui(e){let t=ai(e=e.toUpperCase(),1);return t!==void 0?t:e!==Sn?vg(e):void 0}function ci(e,t){return He(e.epochNanoseconds,t.epochNanoseconds)}function fi(e,t){return He(e.epochNanoseconds,t.epochNanoseconds)}function bf(e,t,n,r,s,o){let a=e(pt(o).relativeTo),i=Math.max(pn(r),pn(s));if(dc(se,r,s))return 0;if(vr(i,a))return He(be(r),be(s));if(!a)throw new RangeError(ho);let[c,f,d]=Xs(t,n,a),l=ei(d),h=Js(d);return He(l(h(f,c,r)),l(h(f,c,s)))}function di(e,t){return Nn(e,t)||so(e,t)}function Nn(e,t){return qt(ke(e),ke(t))}function so(e,t){return qt(Wt(e),Wt(t))}function Cf(e,t){return!ci(e,t)}function Sf(e,t){return!fi(e,t)&&!!Of(e.timeZone,t.timeZone)&&e.calendar===t.calendar}function Af(e,t){return!di(e,t)&&e.calendar===t.calendar}function Tf(e,t){return!Nn(e,t)&&e.calendar===t.calendar}function vf(e,t){return!Nn(e,t)&&e.calendar===t.calendar}function xf(e,t){return!Nn(e,t)&&e.calendar===t.calendar}function Lf(e,t){return!so(e,t)}function Of(e,t){if(e===t)return 1;try{return sc(e)===sc(t)}catch{}}function hi(e,t,n,r){let s=Wn(e,r,3,5),o=oo(t.epochNanoseconds,n.epochNanoseconds,...s);return Ee(e?$e(o):o)}function mi(e,t,n,r,s,o){let a=io(r.calendar,s.calendar),[i,c,f,d]=Wn(n,o,5),l=r.epochNanoseconds,h=s.epochNanoseconds,p=He(h,l),g;if(p)if(i<6)g=oo(l,h,i,c,f,d);else{let E=t(((y,N)=>{if(!Of(y,N))throw new RangeError(Bd);return y})(r.timeZone,s.timeZone)),w=e(a);g=Df(w,E,r,s,p,i,o),g=Ys(g,h,i,c,f,d,w,r,kc,te(Ja,E))}else g=Ce;return Ee(n?$e(g):g)}function pi(e,t,n,r,s){let o=io(n.calendar,r.calendar),[a,i,c,f]=Wn(t,s,6),d=Ne(n),l=Ne(r),h=He(l,d),p;if(h)if(a<=6)p=oo(d,l,a,i,c,f);else{let g=e(o);p=Pf(g,n,r,h,a,s),p=Ys(p,l,a,i,c,f,g,n,Ne,Qa)}else p=Ce;return Ee(t?$e(p):p)}function gi(e,t,n,r,s){let o=io(n.calendar,r.calendar);return Mf(t,()=>e(o),n,r,...Wn(t,s,6,9,6))}function Ei(e,t,n,r,s){let o=io(n.calendar,r.calendar),a=Wn(t,s,9,9,8),i=e(o),c=Tr(i,n),f=Tr(i,r);return c.isoYear===f.isoYear&&c.isoMonth===f.isoMonth&&c.isoDay===f.isoDay?Ee(Ce):Mf(t,()=>i,rt(c),rt(f),...a,8)}function Mf(e,t,n,r,s,o,a,i,c=6){let f=Ne(n),d=Ne(r);if(f===void 0||d===void 0)throw new RangeError(nn);let l;if(He(d,f))if(s===6)l=oo(f,d,s,o,a,i);else{let h=t();l=h.N(n,r,s),o===c&&a===1||(l=Ys(l,d,s,o,a,i,h,n,Ne,Hs))}else l=Ce;return Ee(e?$e(l):l)}function yi(e,t,n,r){let[s,o,a,i]=Wn(e,r,5,5),c=zt(wi(t,n),Fr(o,a),i),f={...Ce,...eo(c,s)};return Ee(e?$e(f):f)}function cp(e,t,n,r,s,o){let a=He(r.epochNanoseconds,n.epochNanoseconds);return a?s<6?kf(n.epochNanoseconds,r.epochNanoseconds,s):Df(t,e,n,r,a,s,o):Ce}function fp(e,t,n,r,s){let o=Ne(t),a=Ne(n),i=He(a,o);return i?r<=6?kf(o,a,r):Pf(e,t,n,i,r,s):Ce}function Df(e,t,n,r,s,o,a){let[i,c,f]=((h,p,g,E)=>{function w(){return v={...wn(b,S++*-E),...N},x=$r(h,v),He(C,x)===-E}let y=je(p,h),N=Je(tt,y),b=je(g,h),C=g.epochNanoseconds,S=0,O=wi(y,b),v,x;if(Math.sign(O)===-E&&S++,w()&&(E===-1||w()))throw new RangeError(er);let L=ct(ut(x,C));return[y,v,L]})(t,n,r,s);var d,l;return{...o===6?(d=i,l=c,{...Ce,days:Ff(d,l)}):e.N(i,c,o,a),...eo(f)}}function Pf(e,t,n,r,s,o){let[a,i,c]=((f,d,l)=>{let h=d,p=wi(f,d);return Math.sign(p)===-l&&(h=wn(d,-l),p+=ie*l),[f,h,p]})(t,n,r);return{...e.N(a,i,s,o),...eo(c)}}function oo(e,t,n,r,s,o){return{...Ce,...Hn(Ws(ut(e,t),r,s,o),n)}}function kf(e,t,n){return{...Ce,...Hn(ut(e,t),n)}}function Ff(e,t){return ao(ke(e),ke(t))}function ao(e,t){return Math.trunc((t-e)/Ke)}function wi(e,t){return Wt(t)-Wt(e)}function io(e,t){if(e!==t)throw new RangeError(Ud);return e}function $f(e){return this.m(e)[0]}function Uf(e){return this.m(e)[1]}function Ii(e){let[t]=this.v(e);return ao(this.p(t),ke(e))+1}function Ri(e){let t=Og.exec(e);if(!t)throw new RangeError(Lp(e));return[parseInt(t[1]),!!t[2]]}function Ur(e,t){return"M"+st(e)+(t?"L":"")}function Ms(e,t,n){return e+(t||n&&e>=n?1:0)}function Ni(e,t){return e-(t&&e>=t?1:0)}function Bf(e,t){return(t+e)*(Math.sign(t)||1)||0}function aa(e){return Zd[Vf(e)]}function _f(e){return Yp[Vf(e)]}function Vf(e){return gn(e.id||ne)}function dp(e){function t(s){return((o,a)=>({...Kf(o,a),o:o.month,day:parseInt(o.day)}))(Sa(n,s),r)}let n=Yi(e),r=gn(e);return{id:e,h:hp(t),l:mp(t)}}function hp(e){return Ge(t=>{let n=ke(t);return e(n)},WeakMap)}function mp(e){let t=e(0).year-tg;return Ge(n=>{let r,s=qn(n-t),o=0,a=[],i=[];do s+=400*Ke;while((r=e(s)).year<=n);do if(s+=(1-r.day)*Ke,r.year===n&&(a.push(s),i.push(r.o)),s-=Ke,++o>100||s<-Vi)throw new RangeError(er);while((r=e(s)).year>=n);return{i:a.reverse(),u:Vd(i.reverse())}})}function Kf(e,t){let n,r,s=Gf(e);if(e.era){let o=Zd[t],a=Hd[t]||{};o!==void 0&&(n=t==="islamic"?"ah":e.era.normalize("NFD").toLowerCase().replace(/[^a-z0-9]/g,""),n==="bc"||n==="b"?n="bce":n==="ad"||n==="a"?n="ce":n==="beforeroc"&&(n="broc"),n=a[n]||n,r=s,s=Bf(r,o[n]||0))}return{era:n,eraYear:r,year:s}}function Gf(e){return parseInt(e.relatedYear||e.year)}function Ds(e){let{year:t,o:n,day:r}=this.h(e),{u:s}=this.l(t);return[t,s[n]+1,r]}function xr(e,t=1,n=1){return this.l(e).i[t-1]+(n-1)*Ke}function qf(e,t){let n=Cs.call(this,e);return[Ni(t,n),n===t]}function Cs(e){let t=ac(this,e),n=ac(this,e-1),r=t.length;if(r>n.length){let s=_f(this);if(s<0)return-s;for(let o=0;o<r;o++)if(t[o]!==n[o])return o+1}}function Is(e){return ao(xr.call(this,e),xr.call(this,e+1))}function oc(e,t){let{i:n}=this.l(e),r=t+1,s=n;return r>n.length&&(r=1,s=this.l(e+1).i),ao(n[t-1],s[r-1])}function Rs(e){return this.l(e).i.length}function jf(e){let t=this.h(e);return[t.era,t.eraYear]}function ac(e,t){return Object.keys(e.l(t).u)}function Jn(e){return Br(Se(e))}function Br(e){if((e=e.toLowerCase())!==ne&&e!==tr){let t=Yi(e).resolvedOptions().calendar;if(gn(e)!==gn(t))throw new RangeError(vi(e));return t}return e}function gn(e){return e==="islamicc"&&(e="islamic"),e.split("-")[0]}function Yf(e,t){return n=>n===ne?e:n===tr||n===Ht?Object.assign(Object.create(e),{id:n}):Object.assign(Object.create(t),Mg(n))}function Wf(e,t,n,r){let s=en(n,r,Ft,[],jd);if(s.timeZone!==void 0){let o=n.F(s),a=_r(s),i=e(s.timeZone);return{epochNanoseconds:Zn(t(i),{...o,...a},s.offset!==void 0?Rn(s.offset):void 0),timeZone:i}}return{...n.F(s),...Fe}}function zf(e,t,n,r,s,o){let a=en(n,s,Ft,Gd,jd),i=e(a.timeZone),[c,f,d]=kr(o),l=n.F(a,qs(c)),h=_r(a,c);return Qe(Zn(t(i),{...l,...h},a.offset!==void 0?Rn(a.offset):void 0,f,d),i,r)}function Zf(e,t,n){let r=en(e,t,Ft,[],wt),s=re(n);return et(qe({...e.F(r,qs(s)),..._r(r,s)}))}function Hf(e,t,n,r=[]){let s=en(e,t,Ft,r);return e.F(s,n)}function Xf(e,t,n,r){let s=en(e,t,Pi,r);return e.K(s,n)}function Jf(e,t,n,r){let s=en(e,n,Ft,Kr);return t&&s.month!==void 0&&s.monthCode===void 0&&s.year===void 0&&(s.year=Dt),e._(s,r)}function Qf(e,t){return ot(_r(Xe(e,la,[],1),re(t)))}function ed(e){let t=Xe(e,ki);return Ee(In({...Ce,...t}))}function en(e,t,n,r=[],s=[]){return Xe(t,[...e.fields(n),...s].sort(),r)}function Xe(e,t,n,r=!n){let s={},o,a=0;for(let i of t){if(i===o)throw new RangeError(Cp(i));if(i==="constructor"||i==="__proto__")throw new RangeError(bp(i));let c=e[i];if(c!==void 0)a=1,lc[i]&&(c=lc[i](c,i)),s[i]=c;else if(n){if(n.includes(i))throw new TypeError(Ti(i));s[i]=zd[i]}o=i}if(r&&!a)throw new TypeError(Dd(t));return s}function _r(e,t){return Yn(Wi({...zd,...e}),t)}function td(e,t,n,r,s){let{calendar:o,timeZone:a}=n,i=e(o),c=t(a),f=[...i.fields(Ft),...qd].sort(),d=(y=>{let N=je(y,H),b=zn(N.offsetNanoseconds),C=Co(y.calendar),[S,O,v]=C.v(N),[x,L]=C.q(S,O),U=Ur(x,L);return{..._g(N),year:S,monthCode:U,day:v,offset:b}})(n),l=Xe(r,f),h=i.k(d,l),p={...d,...l},[g,E,w]=kr(s,2);return Qe(Zn(c,{...i.F(h,qs(g)),...Yn(Wi(p),g)},Rn(p.offset),E,w),a,o)}function nd(e,t,n,r){let s=e(t.calendar),o=[...s.fields(Ft),...wt].sort(),a={...ud(i=t),hour:i.isoHour,minute:i.isoMinute,second:i.isoSecond,millisecond:i.isoMillisecond,microsecond:i.isoMicrosecond,nanosecond:i.isoNanosecond};var i;let c=Xe(n,o),f=re(r),d=s.k(a,c),l={...a,...c};return et(qe({...s.F(d,qs(f)),...Yn(Wi(l),f)}))}function rd(e,t,n,r){let s=e(t.calendar),o=s.fields(Ft).sort(),a=ud(t),i=Xe(n,o),c=s.k(a,i);return s.F(c,r)}function sd(e,t,n,r){let s=e(t.calendar),o=s.fields(Pi).sort(),a=(f=>{let d=Co(f.calendar),[l,h]=d.v(f),[p,g]=d.q(l,h);return{year:l,monthCode:Ur(p,g)}})(t),i=Xe(n,o),c=s.k(a,i);return s.K(c,r)}function od(e,t,n,r){let s=e(t.calendar),o=s.fields(Ft).sort(),a=(f=>{let d=Co(f.calendar),[l,h,p]=d.v(f),[g,E]=d.q(l,h);return{monthCode:Ur(g,E),day:p}})(t),i=Xe(n,o),c=s.k(a,i);return s._(c,r)}function ad(e,t,n){return ot(((r,s,o)=>_r({...Je(la,r),...Xe(s,la)},re(o)))(e,t,n))}function id(e,t){return Ee((n=e,r=t,In({...n,...Xe(r,ki)})));var n,r}function ld(e,t,n,r,s){t=Je(n=e.fields(n),t),r=Xe(r,s=e.fields(s),[]);let o=e.k(t,r);return o=Xe(o,[...n,...s].sort(),[]),e.F(o)}function ta(e,t){let n=aa(e),r=Hd[e.id||""]||{},{era:s,eraYear:o,year:a}=t;if(s!==void 0||o!==void 0){if(s===void 0||o===void 0)throw new TypeError(Ap);if(!n)throw new RangeError(Sp);let i=n[r[s]||s];if(i===void 0)throw new RangeError(vp(s));let c=Bf(o,i);if(a!==void 0&&a!==c)throw new RangeError(Tp);a=c}else if(a===void 0)throw new TypeError(xp(n));return a}function Ns(e,t,n,r){let{month:s,monthCode:o}=t;if(o!==void 0){let a=((i,c,f,d)=>{let l=i.L(f),[h,p]=Ri(c),g=Ms(h,p,l);if(p){let E=_f(i);if(E===void 0)throw new RangeError(Rr);if(E>0){if(g>E)throw new RangeError(Rr);if(l===void 0){if(d===1)throw new RangeError(Rr);g--}}else{if(g!==-E)throw new RangeError(Rr);if(l===void 0&&d===1)throw new RangeError(Rr)}}return g})(e,o,n,r);if(s!==void 0&&s!==a)throw new RangeError(Op);s=a,r=1}else if(s===void 0)throw new TypeError($d);return Pt("month",s,1,e.B(n),r)}function na(e,t,n,r,s){return _e(t,"day",1,e.U(r,n),s)}function ra(e,t,n,r){let s=0,o=[];for(let a of n)t[a]!==void 0?s=1:o.push(a);if(Object.assign(e,t),s)for(let a of r||o)delete e[a]}function ud(e){let t=Co(e.calendar),[n,r,s]=t.v(e),[o,a]=t.q(n,r);return{year:n,monthCode:Ur(o,a),day:s}}function cd(e){return gt(mt(Ra(ya(e))))}function fd(e,t,n,r,s=ne){return Qe(mt(Ra(ya(n))),t(r),e(s))}function dd(e,t,n,r,s=0,o=0,a=0,i=0,c=0,f=0,d=ne){return et(qe(Vs(dt(Pe,Gn(Eo,[t,n,r,s,o,a,i,c,f])))),e(d))}function hd(e,t,n,r,s=ne){return Et(rt(yn(dt(Pe,{isoYear:t,isoMonth:n,isoDay:r}))),e(s))}function md(e,t,n,r=ne,s=1){let o=Pe(t),a=Pe(n),i=e(r);return Ar(ba(yn({isoYear:o,isoMonth:a,isoDay:Pe(s)})),i)}function pd(e,t,n,r=ne,s=Dt){let o=Pe(t),a=Pe(n),i=e(r);return xs(rt(yn({isoYear:Pe(s),isoMonth:o,isoDay:a})),i)}function gd(e=0,t=0,n=0,r=0,s=0,o=0){return ot(Yn(dt(Pe,Gn(tt,[e,t,n,r,s,o])),1))}function Ed(e=0,t=0,n=0,r=0,s=0,o=0,a=0,i=0,c=0,f=0){return Ee(In(dt(wa,Gn(se,[e,t,n,r,s,o,a,i,c,f]))))}function yd(e,t,n=ne){return Qe(e.epochNanoseconds,t,n)}function wd(e){return gt(e.epochNanoseconds)}function bi(e,t){return et(je(t,e))}function Ci(e,t){return Et(je(t,e))}function Si(e,t){return ot(je(t,e))}function Id(e,t,n,r){let s=((o,a,i,c)=>{let f=(d=>oh(pt(d)))(c);return $r(o(a),i,f)})(e,n,t,r);return Qe(mt(s),n,t.calendar)}function Rd(e,t,n,r,s){let o=e(s.timeZone),a=s.plainTime,i=a!==void 0?t(a):void 0,c=n(o),f;return f=i?$r(c,{...r,...i}):Zt(c,{...r,...Fe}),Qe(f,o,r.calendar)}function Nd(e,t=Fe){return et(qe({...e,...t}))}function bd(e,t,n){return((r,s)=>{let o=en(r,s,Yd);return r.K(o,void 0)})(e(t.calendar),n)}function Cd(e,t,n){return((r,s)=>{let o=en(r,s,Wd);return r._(o)})(e(t.calendar),n)}function Sd(e,t,n,r){return((s,o,a)=>ld(s,o,Yd,Pr(a),Kr))(e(t.calendar),n,r)}function Ad(e,t,n,r){return((s,o,a)=>ld(s,o,Wd,Pr(a),Oi))(e(t.calendar),n,r)}function Td(e){return gt(mt(Sr(wa(e),yt)))}function vd(e){return gt(mt(Ra(ya(e))))}function bn(e,t,n){let r=new Set(n);return(s,o)=>{let a=n&&Hu(s,n);if(!Hu(s=((i,c)=>{let f={};for(let d in c)i.has(d)||(f[d]=c[d]);return f})(r,s),e)){if(o&&a)throw new TypeError("Invalid formatting options");s={...t,...s}}return n&&(s.timeZone=Sn,["full","long"].includes(s.J)&&(s.J="medium")),s}}function kt(e,t=Ai,n=0){let[r,,,s]=e;return(o,a=oE,...i)=>{let c=t(s&&s(...i),o,a,r,n),f=c.resolvedOptions();return[c,...pp(e,f,i)]}}function Ai(e,t,n,r,s){if(n=r(n,s),e){if(n.timeZone!==void 0)throw new TypeError(Kp);n.timeZone=e}return new $t(t,n)}function pp(e,t,n){let[,r,s]=e;return n.map(o=>(o.calendar&&((a,i,c)=>{if((c||a!==ne)&&a!==i)throw new RangeError(Ud)})(o.calendar,t.calendar,s),r(o,t)))}function xd(e,t,n){let r=t.timeZone,s=e(r),o={...je(t,s),...n||Fe},a;return a=n?Zn(s,o,o.offsetNanoseconds,2):Zt(s,o),Qe(a,r,t.calendar)}function Ld(e,t=Fe){return et(qe({...e,...t}))}function lo(e,t){return{...e,calendar:t}}function Od(e,t){return{...e,timeZone:t}}function uo(e){let t=co();return jn(t,e.R(t))}function co(){return Sr(Date.now(),yt)}function Qn(){return uc||(uc=new $t().resolvedOptions().timeZone)}var gp=(e,t)=>`Non-integer ${e}: ${t}`,Ep=(e,t)=>`Non-positive ${e}: ${t}`,yp=(e,t)=>`Non-finite ${e}: ${t}`,wp=e=>`Cannot convert bigint to ${e}`,Ip=e=>`Invalid bigint: ${e}`,Rp="Cannot convert Symbol to string",Np="Invalid object",Md=(e,t,n,r,s)=>s?Md(e,s[t],s[n],s[r]):tn(e,t)+`; must be between ${n}-${r}`,tn=(e,t)=>`Invalid ${e}: ${t}`,Ti=e=>`Missing ${e}`,bp=e=>`Invalid field ${e}`,Cp=e=>`Duplicate field ${e}`,Dd=e=>"No valid fields: "+e.join(),Pd="Invalid bag",kd=(e,t,n)=>tn(e,t)+"; must be "+Object.keys(n).join(),Fd="Cannot use valueOf",fo="Invalid calling context",Sp="Forbidden era/eraYear",Ap="Mismatching era/eraYear",Tp="Mismatching year/eraYear",vp=e=>`Invalid era: ${e}`,xp=e=>"Missing year"+(e?"/era/eraYear":""),Lp=e=>`Invalid monthCode: ${e}`,Op="Mismatching month/monthCode",$d="Missing month/monthCode",Rr="Invalid leap month",er="Invalid protocol results",vi=e=>tn("Calendar",e),Ud="Mismatching Calendars",xi=e=>tn("TimeZone",e),Bd="Mismatching TimeZones",Mp="Forbidden ICU TimeZone",Dp="Out-of-bounds offset",Pp="Out-of-bounds TimeZone gap",kp="Invalid TimeZone offset",Fp="Ambiguous offset",nn="Out-of-bounds date",$p="Out-of-bounds duration",Up="Cannot mix duration signs",ho="Missing relativeTo",Bp="Cannot use large units",_p="Required smallestUnit or largestUnit",Vp="smallestUnit > largestUnit",Ve=e=>`Cannot parse: ${e}`,Mt=e=>`Invalid substring: ${e}`,_d=e=>`Cannot format ${e}`,mo="Mismatching types for formatting",Kp="Cannot specify TimeZone",Vd=te(Mr,(e,t)=>t),Vn=te(Mr,(e,t,n)=>n),st=te(Ts,2),ia={nanosecond:0,microsecond:1,millisecond:2,second:3,minute:4,hour:5,day:6,week:7,month:8,year:9},Li=Object.keys(ia),Ke=864e5,Kd=1e3,Vr=1e3,yt=1e6,lt=1e9,po=6e10,go=36e11,ie=864e11,ft=[1,Vr,yt,lt,po,go,ie],wt=Li.slice(0,6),la=Dr(wt),Gp=["offset"],Gd=["timeZone"],qd=wt.concat(Gp),jd=qd.concat(Gd),ua=["era","eraYear"],qp=ua.concat(["year"]),Oi=["year"],Mi=["monthCode"],Di=["month"].concat(Mi),Kr=["day"],Pi=Di.concat(Oi),Yd=Mi.concat(Oi),Ft=Kr.concat(Pi),jp=Kr.concat(Di),Wd=Kr.concat(Mi),zd=Vn(wt,0),ne="iso8601",tr="gregory",Ht="japanese",Zd={[tr]:{"gregory-inverse":-1,gregory:0},[Ht]:{"japanese-inverse":-1,japanese:0,meiji:1867,taisho:1911,showa:1925,heisei:1988,reiwa:2018},ethiopic:{ethioaa:0,ethiopic:5500},coptic:{"coptic-inverse":-1,coptic:0},roc:{"roc-inverse":-1,roc:0},buddhist:{be:0},islamic:{ah:0},indian:{saka:0},persian:{ap:0}},Hd={[tr]:{bce:"gregory-inverse",ce:"gregory"},[Ht]:{bce:"japanese-inverse",ce:"japanese"},ethiopic:{era0:"ethioaa",era1:"ethiopic"},coptic:{era0:"coptic-inverse",era1:"coptic"},roc:{broc:"roc-inverse",minguo:"roc"}},Yp={chinese:13,dangi:13,hebrew:-6},Se=te(pa,"string"),Xd=te(pa,"boolean"),Wp=te(pa,"number"),se=Li.map(e=>e+"s"),ki=Dr(se),zp=se.slice(0,6),Jd=se.slice(6),Zp=Jd.slice(1),Hp=Vd(se),Ce=Vn(se,0),Fi=Vn(zp,0),$i=te(hc,se),tt=["isoNanosecond","isoMicrosecond","isoMillisecond","isoSecond","isoMinute","isoHour"],Ui=["isoDay","isoMonth","isoYear"],Eo=tt.concat(Ui),Bi=Dr(Ui),Qd=Dr(tt),Xp=Dr(Eo),Fe=Vn(Qd,0),Jp=te(hc,Eo),_i=1e8,Vi=_i*Ke,Qp=[_i,0],eg=[-_i,0],Lr=275760,Or=-271821,$t=Intl.DateTimeFormat,eh="en-GB",tg=1970,Dt=1972,Gt=12,ng=qn(1868,9,8),rg=Ge(np,WeakMap),Ps="smallestUnit",ca="unit",br="roundingIncrement",sa="fractionalSecondDigits",th="relativeTo",oa="direction",nh={constrain:0,reject:1},sg=Object.keys(nh),og={compatible:0,reject:1,earlier:2,later:3},ag={reject:0,use:1,prefer:2,ignore:3},ig={auto:0,never:1,critical:2,always:3},lg={auto:0,never:1,critical:2},ug={auto:0,never:1},cg={floor:0,halfFloor:1,ceil:2,halfCeil:3,trunc:4,halfTrunc:5,expand:6,halfExpand:7,halfEven:8},fg={previous:-1,next:1},Gr=te(Ma,Ps),rh=te(Ma,"largestUnit"),dg=te(Ma,ca),sh=te(Xt,"overflow",nh),oh=te(Xt,"disambiguation",og),hg=te(Xt,"offset",ag),Ki=te(Xt,"calendarName",ig),mg=te(Xt,"timeZoneName",lg),pg=te(Xt,"offset",ug),qr=te(Xt,"roundingMode",cg),yo="PlainYearMonth",wo="PlainMonthDay",nr="PlainDate",Cn="PlainDateTime",Io="PlainTime",Ut="ZonedDateTime",Ro="Instant",No="Duration",gg=[Math.floor,e=>ws(e)?Math.floor(e):Math.round(e),Math.ceil,e=>ws(e)?Math.ceil(e):Math.round(e),Math.trunc,e=>ws(e)?Math.trunc(e)||0:Math.round(e),e=>e<0?Math.floor(e):Math.ceil(e),e=>Math.sign(e)*Math.round(Math.abs(e))||0,e=>ws(e)?(e=Math.trunc(e)||0)+e%2:Math.round(e)],Sn="UTC",Ss=5184e3,Eg=vs(1847),yg=vs(new Date().getUTCFullYear()+10),wg=/0+$/,je=Ge(lp,WeakMap),ic=2**32-1,H=Ge(e=>{let t=ui(e);return typeof t=="object"?new da(t):new fa(t||0)}),fa=class{constructor(t){this.$=t}R(){return this.$}I(t){return(n=>{let r=Ne({...n,...Fe});if(!r||Math.abs(r[0])>1e8)throw new RangeError(nn)})(t),[Ca(t,this.$)]}O(){}},da=class{constructor(t){this.nn=(n=>{function r(f){let d=Cr(f,i,c),[l,h]=rc(d),p=o(l),g=o(h);return p===g?p:s(a(l,h),p,g,f)}function s(f,d,l,h){let p,g;for(;(h===void 0||(p=h<f[0]?d:h>=f[1]?l:void 0)===void 0)&&(g=f[1]-f[0]);){let E=f[0]+Math.floor(g/2);n(E)===l?f[1]=E:f[0]=E+1}return p}let o=Ge(n),a=Ge(up),i=Eg,c=yg;return{tn(f){let d=r(f-86400),l=r(f+86400),h=f-d,p=f-l;if(d===l)return[h];let g=r(h);return g===r(p)?[f-g]:d>l?[h,p]:[]},rn:r,O(f,d){let l=Cr(f,i,c),[h,p]=rc(l),g=Ss*d,E=d<0?()=>p>i||(i=l,0):()=>h<c||(c=l,0);for(;E();){let w=o(h),y=o(p);if(w!==y){let N=a(h,p);s(N,w,y);let b=N[0];if((qt(b,f)||1)===d)return b}h+=g,p+=g}}}})((n=>r=>{let s=Sa(n,r*Kd);return vs(Gf(s),parseInt(s.month),parseInt(s.day),parseInt(s.hour),parseInt(s.minute),parseInt(s.second))-r})(t))}R(t){return this.nn.rn((n=>Qu(n)[0])(t))*lt}I(t){let[n,r]=[vs((s=t).isoYear,s.isoMonth,s.isoDay,s.isoHour,s.isoMinute,s.isoSecond),s.isoMillisecond*yt+s.isoMicrosecond*Vr+s.isoNanosecond];var s;return this.nn.tn(n).map(o=>mt(mn(Sr(o,lt),r)))}O(t,n){let[r,s]=Qu(t),o=this.nn.O(r+(n>0||s?1:0),n);if(o!==void 0)return Sr(o,lt)}},Gi="([+-])",As="(?:[.,](\\d{1,9}))?",ah=`(?:(?:${Gi}(\\d{6}))|(\\d{4}))-?(\\d{2})`,qi="(\\d{2})(?::?(\\d{2})(?::?(\\d{2})"+As+")?)?",ji=Gi+qi,Ig=ah+"-?(\\d{2})(?:[T ]"+qi+"(Z|"+ji+")?)?",ih="\\[(!?)([^\\]]*)\\]",bo=`((?:${ih}){0,9})`,Rg=Xn(ah+bo),Ng=Xn("(?:--)?(\\d{2})-?(\\d{2})"+bo),bg=Xn(Ig+bo),Cg=Xn("T?"+qi+"(?:"+ji+")?"+bo),Sg=Xn(ji),Ag=new RegExp(ih,"g"),Tg=Xn(`${Gi}?P(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(?:T(?:(\\d+)${As}H)?(?:(\\d+)${As}M)?(?:(\\d+)${As}S)?)?`),vg=Ge(e=>new $t(eh,{timeZone:e,era:"short",year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"})),xg=/^(AC|AE|AG|AR|AS|BE|BS|CA|CN|CS|CT|EA|EC|IE|IS|JS|MI|NE|NS|PL|PN|PR|PS|SS|VS)T$/,Lg=/[^\w\/:+-]+/,Og=/^M(\d{2})(L?)$/,Mg=Ge(dp),Yi=Ge(e=>new $t(eh,{calendar:e,timeZone:Sn,era:"short",year:"numeric",month:"short",day:"numeric"})),lh={P(e,t,n){let r=re(n),s,{years:o,months:a,weeks:i,days:c}=t;if(c+=be(t,5)[0],o||a)s=((f,d,l,h,p)=>{let[g,E,w]=f.v(d);if(l){let[y,N]=f.q(g,E);g+=l,E=Ms(y,N,f.L(g)),E=Pt("month",E,1,f.B(g),p)}return h&&([g,E]=f.un(g,E,h)),w=Pt("day",w,1,f.U(g,E),p),f.p(g,E,w)})(this,e,o,a,r);else{if(!i&&!c)return e;s=ke(e)}if(s===void 0)throw new RangeError(nn);return s+=(7*i+c)*Ke,rt(_s(s))},N(e,t,n){if(n<=7){let c=0,f=Ff({...e,...Fe},{...t,...Fe});return n===7&&([c,f]=Yt(f,7)),{...Ce,weeks:c,days:f}}let r=this.v(e),s=this.v(t),[o,a,i]=((c,f,d,l,h,p,g)=>{let E=h-f,w=p-d,y=g-l;if(E||w){let N=Math.sign(E||w),b=c.U(h,p),C=0;if(Math.sign(y)===-N){let S=b;[h,p]=c.un(h,p,-N),E=h-f,w=p-d,b=c.U(h,p),C=N<0?-S:b}if(y=g-Math.min(l,b)+C,E){let[S,O]=c.q(f,d),[v,x]=c.q(h,p);if(w=v-S||Number(x)-Number(O),Math.sign(w)===-N){let L=N<0&&-c.B(h);E=(h-=N)-f,w=p-Ms(S,O,c.L(h))+(L||c.B(h))}}}return[E,w,y]})(this,...r,...s);return n===8&&(a+=this.cn(o,r[0]),o=0),{...Ce,years:o,months:a,days:i}},F(e,t){let n=re(t),r=ta(this,e),s=Ns(this,e,r,n),o=na(this,e,s,r,n);return Et(rt(this.V(r,s,o)),this.id||ne)},K(e,t){let n=re(t),r=ta(this,e),s=Ns(this,e,r,n);return Ar(ba(this.V(r,s,1)),this.id||ne)},_(e,t){let n=re(t),r,s,o,a=e.eraYear!==void 0||e.year!==void 0?ta(this,e):void 0,i=!this.id;if(a===void 0&&i&&(a=Dt),a!==void 0){let l=Ns(this,e,a,n);r=na(this,e,l,a,n);let h=this.L(a);s=Ni(l,h),o=l===h}else{if(e.monthCode===void 0)throw new TypeError($d);if([s,o]=Ri(e.monthCode),this.id&&this.id!==tr&&this.id!==Ht)if(this.id&&gn(this.id)==="coptic"&&n===0){let l=o||s!==13?30:6;r=e.day,r=Cr(r,1,l)}else if(this.id&&gn(this.id)==="chinese"&&n===0){let l=!o||s!==1&&s!==9&&s!==10&&s!==11&&s!==12?30:29;r=e.day,r=Cr(r,1,l)}else r=e.day;else r=na(this,e,Ns(this,e,Dt,n),Dt,n)}let c=this.G(s,o,r);if(!c)throw new RangeError("Cannot guess year");let[f,d]=c;return xs(rt(this.V(f,d,r)),this.id||ne)},fields(e){return aa(this)&&e.includes("year")?[...e,...ua]:e},k(e,t){let n=Object.assign(Object.create(null),e);return ra(n,t,Di),aa(this)&&(ra(n,t,qp),this.id===Ht&&ra(n,t,jp,ua)),n},inLeapYear(e){let[t]=this.v(e);return this.sn(t)},monthsInYear(e){let[t]=this.v(e);return this.B(t)},daysInMonth(e){let[t,n]=this.v(e);return this.U(t,n)},daysInYear(e){let[t]=this.v(e);return this.fn(t)},dayOfYear:Ii,era(e){return this.hn(e)[0]},eraYear(e){return this.hn(e)[1]},monthCode(e){let[t,n]=this.v(e),[r,s]=this.q(t,n);return Ur(r,s)},dayOfWeek:Ac,daysInWeek(){return 7}},Dg={v:Aa,hn:Tc,q:Nc},Pg={dayOfYear:Ii,v:Aa,p:qn},kg=Object.assign({},Pg,{weekOfYear:$f,yearOfWeek:Uf,m(e){function t(p){return(7-p<r?7:0)-p}function n(p){let g=Sc(h+p),E=p||1,w=t(Nr(c+g*E,7));return d=(g+(w-f)*E)/7}let r=this.id?1:4,s=Ac(e),o=this.dayOfYear(e),a=Nr(s-1,7),i=o-1,c=Nr(a-i,7),f=t(c),d,l=Math.floor((i-f)/7)+1,h=e.isoYear;return l?l>n(0)&&(l=1,h++):(l=n(-1),h--),[l,h,d]}}),Fg=Object.assign({},lh,kg,{v:Aa,hn:Tc,q:Nc,G(e,t){if(!t)return[Dt,e]},sn:Ta,L(){},B:bc,cn:e=>e*Gt,U:Cc,fn:Sc,V:(e,t,n)=>({isoYear:e,isoMonth:t,isoDay:n}),p:qn,un:(e,t,n)=>(e+=Fs(n,Gt),(t+=ha(n,Gt))<1?(e--,t+=Gt):t>Gt&&(e++,t-=Gt),[e,t]),year(e){return e.isoYear},month(e){return e.isoMonth},day:e=>e.isoDay}),$g={v:Ds,hn:jf,q:qf},Ug={dayOfYear:Ii,v:Ds,p:xr,weekOfYear:$f,yearOfWeek:Uf,m(){return[]}},Bg=Object.assign({},lh,Ug,{v:Ds,hn:jf,q:qf,G(e,t,n){let r=this.id&&gn(this.id)==="chinese"?((f,d,l)=>{if(d)switch(f){case 1:return 1651;case 2:return l<30?1947:1765;case 3:return l<30?1966:1955;case 4:return l<30?1963:1944;case 5:return l<30?1971:1952;case 6:return l<30?1960:1941;case 7:return l<30?1968:1938;case 8:return l<30?1957:1718;case 9:return 1832;case 10:return 1870;case 11:return 1814;case 12:return 1890}return 1972})(e,t,n):Dt,[s,o,a]=Ds.call(this,{isoYear:r,isoMonth:Gt,isoDay:31}),i=Cs.call(this,s),c=o===i;(qt(e,Ni(o,i))||qt(Number(t),Number(c))||qt(n,a))===1&&s--;for(let f=0;f<100;f++){let d=s-f,l=Cs.call(this,d),h=Ms(e,t,l);if(t===(h===l)&&n<=oc.call(this,d,h))return[d,h]}},sn(e){let t=Is.call(this,e);return t>Is.call(this,e-1)&&t>Is.call(this,e+1)},L:Cs,B:Rs,cn(e,t){let n=t+e,r=Math.sign(e),s=r<0?-1:0,o=0;for(let a=t;a!==n;a+=r)o+=Rs.call(this,a+s);return o},U:oc,fn:Is,V(e,t,n){return _s(xr.call(this,e,t,n))},p:xr,un(e,t,n){if(n){if(t+=n,!Number.isSafeInteger(t))throw new RangeError(nn);if(n<0)for(;t<1;)t+=Rs.call(this,--e);else{let r;for(;t>(r=Rs.call(this,e));)t-=r,e++}}return[e,t]},year(e){return this.h(e).year},month(e){let{year:t,o:n}=this.h(e),{u:r}=this.l(t);return r[n]+1},day(e){return this.h(e).day}}),Co=Yf(Dg,$g),W=Yf(Fg,Bg),lc={era:bs,eraYear:Pe,year:Pe,month:Ju,monthCode(e){let t=bs(e);return Ri(t),t},day:Ju,...Vn(wt,Pe),...Vn(se,wa),offset(e){let t=bs(e);return Rn(t),t}},Wi=te(fc,wt,tt),_g=te(fc,tt,wt),jt="numeric",jr=["timeZoneName"],uh={month:jt,day:jt},zi={year:jt,month:jt},Zi=Object.assign({},zi,{day:jt}),Hi={hour:jt,minute:jt,second:jt},Xi=Object.assign({},Zi,Hi),Vg=Object.assign({},Xi,{timeZoneName:"short"}),Kg=Object.keys(zi),Gg=Object.keys(uh),qg=Object.keys(Zi),jg=Object.keys(Hi),Ji=["dateStyle"],Yg=Kg.concat(Ji),Wg=Gg.concat(Ji),Qi=qg.concat(Ji,["weekday"]),Yr=jg.concat(["dayPeriod","timeStyle","fractionalSecondDigits"]),el=Qi.concat(Yr),zg=jr.concat(Yr),Zg=jr.concat(Qi),Hg=jr.concat(["day","weekday"],Yr),Xg=jr.concat(["year","weekday"],Yr),Jg=bn(el,Xi),Qg=bn(el,Vg),eE=bn(el,Xi,jr),tE=bn(Qi,Zi,zg),nE=bn(Yr,Hi,Zg),rE=bn(Yg,zi,Hg),sE=bn(Wg,uh,Xg),oE={},ch=new $t(void 0,{calendar:ne}).resolvedOptions().calendar===ne,tl=[Jg,js],fh=[Qg,js,0,(e,t)=>{let n=e.timeZone;if(t&&t.timeZone!==n)throw new RangeError(Bd);return n}],nl=[eE,ke],rl=[tE,ke],sl=[nE,e=>Wt(e)/yt],ol=[rE,ke,ch],al=[sE,ke,ch],uc;function an(e,t,n,r,s){function o(...c){if(!(this instanceof o))throw new TypeError(fo);mh(this,t(...c))}function a(c,f){return Object.defineProperties(function(...d){return c.call(this,i(this),...d)},Kn(f))}function i(c){let f=Be(c);if(!f||f.branding!==e)throw new TypeError(fo);return f}return Object.defineProperties(o.prototype,{...cc(dt(a,n)),...En(dt(a,r)),...ks("Temporal."+e)}),Object.defineProperties(o,{...En(s),...Kn(e)}),[o,c=>{let f=Object.create(o.prototype);return mh(f,c),f},i]}function lr(e){if(Be(e)||e.calendar!==void 0||e.timeZone!==void 0)throw new TypeError(Pd);return e}function Zr(e){return ph(e)||ne}function ph(e){let{calendar:t}=e;if(t!==void 0)return To(t)}function To(e){if(ve(e)){let{calendar:t}=Be(e)||{};if(!t)throw new TypeError(vi(e));return t}return(t=>Br(mf(Se(t))))(e)}function ul(e){let t={};for(let n in e)t[n]=r=>{let{calendar:s}=r;return W(s)[n](r)};return t}function ln(){throw new TypeError(Fd)}function nt(e){if(ve(e)){let{timeZone:t}=Be(e)||{};if(!t)throw new TypeError(xi(e));return t}return(t=>ro(pf(Se(t))))(e)}function we(e){if(ve(e)){let t=Be(e);return t&&t.branding===No?t:ed(e)}return hf(e)}function Wr(e){if(e!==void 0){if(ve(e)){let t=Be(e)||{};switch(t.branding){case Ut:case nr:return t;case Cn:return Et(t)}let n=Zr(e);return{...Wf(nt,H,W(n),e),calendar:n}}return af(e)}}function rn(e,t){if(ve(e)){let r=Be(e)||{};switch(r.branding){case Io:return re(t),r;case Cn:return re(t),ot(r);case Ut:return re(t),Si(H,r)}return Qf(e,t)}let n=df(e);return re(t),n}function cl(e){return e===void 0?void 0:rn(e)}function rr(e,t){if(ve(e)){let r=Be(e)||{};switch(r.branding){case Cn:return re(t),r;case nr:return re(t),et({...r,...Fe});case Ut:return re(t),bi(H,r)}return Zf(W(Zr(e)),e,t)}let n=uf(e);return re(t),n}function dh(e,t){if(ve(e)){let r=Be(e);if(r&&r.branding===wo)return re(t),r;let s=ph(e);return Jf(W(s||ne),!s,e,t)}let n=ff(W,e);return re(t),n}function sr(e,t){if(ve(e)){let r=Be(e);return r&&r.branding===yo?(re(t),r):Xf(W(Zr(e)),e,t)}let n=cf(W,e);return re(t),n}function or(e,t){if(ve(e)){let r=Be(e)||{};switch(r.branding){case nr:return re(t),r;case Cn:return re(t),Et(r);case Ut:return re(t),Ci(H,r)}return Hf(W(Zr(e)),e,t)}let n=to(e);return re(t),n}function ar(e,t){if(ve(e)){let n=Be(e);if(n&&n.branding===Ut)return kr(t),n;let r=Zr(e);return zf(nt,H,W(r),r,e,t)}return lf(e,t)}function hh(e){return dt(t=>n=>t(il(n)),e)}function il(e){return je(e,H)}function ir(e){if(ve(e)){let t=Be(e);if(t)switch(t.branding){case Ro:return t;case Ut:return gt(t.epochNanoseconds)}}return of(e)}function aE(){function e(o,a){return new t(o,a)}function t(o,a=Object.create(null)){Ao.set(this,((i,c)=>{let f=new $t(i,c),d=f.resolvedOptions(),l=d.locale,h=Je(Object.keys(c),d),p=Ge(uE),g=(E,...w)=>{if(E){if(w.length!==2)throw new TypeError(mo);for(let C of w)if(C===void 0)throw new TypeError(mo)}E||w[0]!==void 0||(w=[]);let y=w.map(C=>Be(C)||Number(C)),N,b=0;for(let C of y){let S=typeof C=="object"?C.branding:void 0;if(b++&&S!==N)throw new TypeError(mo);N=S}return N?p(N)(l,h,...y):[f,...y]};return g.X=f,g})(o,a))}let n=$t.prototype,r=Object.getOwnPropertyDescriptors(n),s=Object.getOwnPropertyDescriptors($t);for(let o in r){let a=r[o],i=o.startsWith("format")&&iE(o);typeof a.value=="function"?a.value=o==="constructor"?e:i||lE(o):i&&(a.get=function(){if(!Ao.has(this))throw new TypeError(fo);return(...c)=>i.apply(this,c)},Object.defineProperties(a.get,Kn(`get ${o}`)))}return s.prototype.value=t.prototype=Object.create({},r),Object.defineProperties(e,s),e}function iE(e){return Object.defineProperties(function(...t){let n=Ao.get(this),[r,...s]=n(e.includes("Range"),...t);return r[e](...s)},Kn(e))}function lE(e){return Object.defineProperties(function(...t){return Ao.get(this).X[e](...t)},Kn(e))}function uE(e){let t=pE[e];if(!t)throw new TypeError(_d(e));return kt(t,Ge(Ai),1)}var So=new WeakMap,Be=So.get.bind(So),mh=So.set.bind(So),gh={era:pc,eraYear:ma,year:Us,month:ht,daysInMonth:ht,daysInYear:ht,inLeapYear:Xd,monthsInYear:ht},fl={monthCode:Se},Eh={day:ht},cE={dayOfWeek:ht,dayOfYear:ht,weekOfYear:gc,yearOfWeek:ma,daysInWeek:ht},dl=ul(Object.assign({},gh,fl,Eh,cE)),fE=ul({...gh,...fl}),dE=ul({...fl,...Eh}),Hr={calendarId:e=>e.calendar},hE=Mr(e=>t=>t[e],se.concat("sign")),hl=Mr((e,t)=>n=>n[tt[t]],wt),yh={epochMilliseconds:js,epochNanoseconds:Pc},[mE,me,Y0]=an(No,Ed,{...hE,blank:nf},{with:(e,t)=>me(id(e,t)),negated:e=>me(Qs(e)),abs:e=>me(tf(e)),add:(e,t,n)=>me(ni(Wr,W,H,0,e,we(t),n)),subtract:(e,t,n)=>me(ni(Wr,W,H,1,e,we(t),n)),round:(e,t)=>me(ef(Wr,W,H,e,t)),total:(e,t)=>Fc(Wr,W,H,e,t),toLocaleString(e,t,n){return Intl.DurationFormat?new Intl.DurationFormat(t,n).format(this):Zs(e)},toString:Zs,toJSON:e=>Zs(e),valueOf:ln},{from:e=>me(we(e)),compare:(e,t,n)=>bf(Wr,W,H,we(e),we(t),n)}),pE={Instant:tl,PlainDateTime:nl,PlainDate:rl,PlainTime:sl,PlainYearMonth:ol,PlainMonthDay:al},gE=kt(tl),EE=kt(fh),yE=kt(nl),wE=kt(rl),IE=kt(sl),RE=kt(ol),NE=kt(al),[bE,on]=an(Io,gd,hl,{with(e,t,n){return on(ad(this,lr(t),n))},add:(e,t)=>on(Xa(0,e,we(t))),subtract:(e,t)=>on(Xa(1,e,we(t))),until:(e,t,n)=>me(yi(0,e,rn(t),n)),since:(e,t,n)=>me(yi(1,e,rn(t),n)),round:(e,t)=>on(_c(e,t)),equals:(e,t)=>Lf(e,rn(t)),toLocaleString(e,t,n){let[r,s]=IE(t,n,e);return r.format(s)},toString:Ka,toJSON:e=>Ka(e),valueOf:ln},{from:(e,t)=>on(rn(e,t)),compare:(e,t)=>so(rn(e),rn(t))}),[CE,It]=an(Cn,te(dd,Jn),{...Hr,...dl,...hl},{with:(e,t,n)=>It(nd(W,e,lr(t),n)),withCalendar:(e,t)=>It(lo(e,To(t))),withPlainTime:(e,t)=>It(Ld(e,cl(t))),add:(e,t,n)=>It(za(W,0,e,we(t),n)),subtract:(e,t,n)=>It(za(W,1,e,we(t),n)),until:(e,t,n)=>me(pi(W,0,e,rr(t),n)),since:(e,t,n)=>me(pi(W,1,e,rr(t),n)),round:(e,t)=>It(Bc(e,t)),equals:(e,t)=>Af(e,rr(t)),toZonedDateTime:(e,t,n)=>Ue(Id(H,e,nt(t),n)),toPlainDate:e=>Rt(Et(e)),toPlainTime:e=>on(ot(e)),toLocaleString(e,t,n){let[r,s]=yE(t,n,e);return r.format(s)},toString:Ua,toJSON:e=>Ua(e),valueOf:ln},{from:(e,t)=>It(rr(e,t)),compare:(e,t)=>di(rr(e),rr(t))}),[SE,ll,W0]=an(wo,te(pd,Jn),{...Hr,...dE},{with:(e,t,n)=>ll(od(W,e,lr(t),n)),equals:(e,t)=>xf(e,dh(t)),toPlainDate(e,t){return Rt(Ad(W,e,this,t))},toLocaleString(e,t,n){let[r,s]=NE(t,n,e);return r.format(s)},toString:Va,toJSON:e=>Va(e),valueOf:ln},{from:(e,t)=>ll(dh(e,t))}),[AE,zr,z0]=an(yo,te(md,Jn),{...Hr,...fE},{with:(e,t,n)=>zr(sd(W,e,lr(t),n)),add:(e,t,n)=>zr(Ha(W,0,e,we(t),n)),subtract:(e,t,n)=>zr(Ha(W,1,e,we(t),n)),until:(e,t,n)=>me(Ei(W,0,e,sr(t),n)),since:(e,t,n)=>me(Ei(W,1,e,sr(t),n)),equals:(e,t)=>vf(e,sr(t)),toPlainDate(e,t){return Rt(Sd(W,e,this,t))},toLocaleString(e,t,n){let[r,s]=RE(t,n,e);return r.format(s)},toString:_a,toJSON:e=>_a(e),valueOf:ln},{from:(e,t)=>zr(sr(e,t)),compare:(e,t)=>Nn(sr(e),sr(t))}),[TE,Rt,Z0]=an(nr,te(hd,Jn),{...Hr,...dl},{with:(e,t,n)=>Rt(rd(W,e,lr(t),n)),withCalendar:(e,t)=>Rt(lo(e,To(t))),add:(e,t,n)=>Rt(Za(W,0,e,we(t),n)),subtract:(e,t,n)=>Rt(Za(W,1,e,we(t),n)),until:(e,t,n)=>me(gi(W,0,e,or(t),n)),since:(e,t,n)=>me(gi(W,1,e,or(t),n)),equals:(e,t)=>Tf(e,or(t)),toZonedDateTime(e,t){let n=ve(t)?t:{timeZone:t};return Ue(Rd(nt,rn,H,e,n))},toPlainDateTime:(e,t)=>It(Nd(e,cl(t))),toPlainYearMonth(e){return zr(bd(W,e,this))},toPlainMonthDay(e){return ll(Cd(W,e,this))},toLocaleString(e,t,n){let[r,s]=wE(t,n,e);return r.format(s)},toString:Ba,toJSON:e=>Ba(e),valueOf:ln},{from:(e,t)=>Rt(or(e,t)),compare:(e,t)=>Nn(or(e),or(t))}),[vE,Ue]=an(Ut,te(fd,Jn,Nf),{...yh,...Hr,...hh(dl),...hh(hl),offset:e=>zn(il(e).offsetNanoseconds),offsetNanoseconds:e=>il(e).offsetNanoseconds,timeZoneId:e=>e.timeZone,hoursInDay:e=>Vc(H,e)},{with:(e,t,n)=>Ue(td(W,H,e,lr(t),n)),withCalendar:(e,t)=>Ue(lo(e,To(t))),withTimeZone:(e,t)=>Ue(Od(e,nt(t))),withPlainTime:(e,t)=>Ue(xd(H,e,cl(t))),add:(e,t,n)=>Ue(Wa(W,H,0,e,we(t),n)),subtract:(e,t,n)=>Ue(Wa(W,H,1,e,we(t),n)),until:(e,t,n)=>me(Ee(mi(W,H,0,e,ar(t),n))),since:(e,t,n)=>me(Ee(mi(W,H,1,e,ar(t),n))),round:(e,t)=>Ue(Uc(H,e,t)),startOfDay:e=>Ue(Kc(H,e)),equals:(e,t)=>Sf(e,ar(t)),toInstant:e=>sn(wd(e)),toPlainDateTime:e=>It(bi(H,e)),toPlainDate:e=>Rt(Ci(H,e)),toPlainTime:e=>on(Si(H,e)),toLocaleString(e,t,n={}){let[r,s]=EE(t,n,e);return r.format(s)},toString:(e,t)=>$a(H,e,t),toJSON:e=>$a(H,e),valueOf:ln,getTimeZoneTransition(e,t){let{timeZone:n,epochNanoseconds:r}=e,s=Lc(t),o=H(n).O(r,s);return o?Ue({...e,epochNanoseconds:o}):null}},{from:(e,t)=>Ue(ar(e,t)),compare:(e,t)=>fi(ar(e),ar(t))}),[xE,sn,H0]=an(Ro,cd,yh,{add:(e,t)=>sn(Ya(0,e,we(t))),subtract:(e,t)=>sn(Ya(1,e,we(t))),until:(e,t,n)=>me(hi(0,e,ir(t),n)),since:(e,t,n)=>me(hi(1,e,ir(t),n)),round:(e,t)=>sn($c(e,t)),equals:(e,t)=>Cf(e,ir(t)),toZonedDateTimeISO:(e,t)=>Ue(yd(e,nt(t))),toLocaleString(e,t,n){let[r,s]=gE(t,n,e);return r.format(s)},toString:(e,t)=>Fa(nt,H,e,t),toJSON:e=>Fa(nt,H,e),valueOf:ln},{from:e=>sn(ir(e)),fromEpochMilliseconds:e=>sn(Td(e)),fromEpochNanoseconds:e=>sn(vd(e)),compare:(e,t)=>ci(ir(e),ir(t))}),LE=Object.defineProperties({},{...ks("Temporal.Now"),...En({timeZoneId:()=>Qn(),instant:()=>sn(gt(co())),zonedDateTimeISO:(e=Qn())=>Ue(Qe(co(),nt(e),ne)),plainDateTimeISO:(e=Qn())=>It(et(uo(H(nt(e))),ne)),plainDateISO:(e=Qn())=>Rt(Et(uo(H(nt(e))),ne)),plainTimeISO:(e=Qn())=>on(ot(uo(H(nt(e)))))})}),pe=Object.defineProperties({},{...ks("Temporal"),...En({PlainYearMonth:AE,PlainMonthDay:SE,PlainDate:TE,PlainTime:bE,PlainDateTime:CE,ZonedDateTime:vE,Instant:xE,Duration:mE,Now:LE})}),OE=aE(),Ao=new WeakMap,ME=Object.defineProperties(Object.create(Intl),En({DateTimeFormat:OE}));var wh=864e5,Ih=24405875e-1,vo={year:2e3,month:1,day:1};function DE(e,t=!1){if(e==null)return null;try{if(typeof e=="number"){if(t)return pe.Instant.fromEpochMilliseconds(e*1e3).toZonedDateTimeISO("UTC");if(e>1e6&&e<4e6){let o=(e-Ih)*wh;return pe.Instant.fromEpochMilliseconds(o).toZonedDateTimeISO("UTC")}else{try{if(e>-2208988800&&e<3250368e4)return pe.Instant.fromEpochMilliseconds(e*1e3).toZonedDateTimeISO("UTC")}catch{}try{if(e>-22089888e5&&e<3250368e7)return pe.Instant.fromEpochMilliseconds(e).toZonedDateTimeISO("UTC")}catch{}return null}}if(typeof e!="string")return null;let n=e.trim();if(n.toLowerCase()==="now")return pe.Now.zonedDateTimeISO();try{return/^\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}(:\d{2}(\.\d+)?)?$/.test(n)?pe.Instant.from(n.replace(" ","T")+"Z").toZonedDateTimeISO("UTC"):pe.ZonedDateTime.from(n)}catch{}try{return pe.PlainDateTime.from(n.replace(" ","T")).toZonedDateTime("UTC")}catch{}try{return pe.PlainDate.from(n).toZonedDateTime("UTC")}catch{}try{let o=pe.PlainTime.from(n);return pe.PlainDateTime.from({...vo,hour:o.hour,minute:o.minute,second:o.second,millisecond:o.millisecond,microsecond:o.microsecond,nanosecond:o.nanosecond}).toZonedDateTime("UTC")}catch{}let s=n.match(/^(\d{4})(\d{2})(\d{2})$/);if(s)return pe.PlainDateTime.from({year:parseInt(s[1]),month:parseInt(s[2]),day:parseInt(s[3])}).toZonedDateTime("UTC");if(s=n.match(/^(\d{2}):(\d{2})$/),s){let o={hour:parseInt(s[1]),minute:parseInt(s[2])};return pe.PlainDateTime.from({...vo,...o}).toZonedDateTime("UTC")}if(s=n.match(/^(\d{2}):(\d{2}):(\d{2})$/),s){let o={hour:parseInt(s[1]),minute:parseInt(s[2]),second:parseInt(s[3])};return pe.PlainDateTime.from({...vo,...o}).toZonedDateTime("UTC")}if(s=n.match(/^(\d{2}):(\d{2}):(\d{2})\.(\d{1,9})$/),s){let o=parseInt(s[4].padEnd(9,"0").substring(0,9)),a={hour:parseInt(s[1]),minute:parseInt(s[2]),second:parseInt(s[3]),millisecond:Math.floor(o/1e6),microsecond:Math.floor(o%1e6/1e3),nanosecond:o%1e3};return pe.PlainDateTime.from({...vo,...a}).toZonedDateTime("UTC")}return console.warn(`Failed to parse date/time string with Temporal: ${e}`),null}catch(n){return console.warn(`Error parsing date/time value "${e}":`,n),null}}var PE=/^\s*([+-]?\s*\d+(\.\d+)?)\s+(day|hour|minute|second|month|year)s?\s*$/i,kE=/^\s*weekday\s+([0-6])\s*$/i;function FE(e,t){let n=t.trim().toLowerCase(),r=n.match(PE);if(r){let o=r[1].replace(/\s/g,""),a=parseFloat(o),i=r[3];if(isNaN(a))throw new Error(`Invalid number in modifier: ${t}`);let c={};if(i==="year"||i==="month"||i==="day")c[`${i}s`]=Math.trunc(a);else if(i==="hour"||i==="minute"||i==="second")if(i==="second"){let d=Math.trunc(a),l=Math.round(a%1*1e9);c.seconds=d,l!==0&&(c.nanoseconds=l)}else c[`${i}s`]=a;else throw new Error(`Internal error: Unknown unit ${i}`);let f=pe.Duration.from(c);return e.add(f)}switch(n){case"start of day":return e.startOfDay();case"start of month":return e.startOfDay().with({day:1});case"start of year":return e.startOfDay().with({month:1,day:1})}let s=n.match(kE);if(s){let o=parseInt(s[1],10),a=o===0?7:o,i=e.dayOfWeek,c=a-i;return c>0&&(c-=7),c!==0?e.add({days:c}):e}return console.warn(`Modifier not implemented or unrecognized: ${t}`),e}function Xr(e){if(e.length===0)return null;let t=e[0],n=1,r=!1,s=[],o=e.findIndex(f=>typeof f=="string"&&f.trim().toLowerCase()==="unixepoch");if(o!==-1)if(o===0){if(e.length<2)return null;t=e[1],r=!0,n=2,s=e.slice(n)}else{if(t=e[0],r=!0,typeof t!="number")return null;s=e.slice(1).filter((f,d)=>d!==o-1),n=1}else t=e[0],s=e.slice(1),n=1;let a="UTC",i=[];for(let f of s){if(typeof f!="string")continue;let d=f.trim().toLowerCase();d==="localtime"?a=pe.Now.timeZoneId():d==="utc"?a="UTC":i.push(f)}let c=DE(t,r);if(!c)return null;if(a!==c.timeZoneId)try{c=c.toInstant().toZonedDateTimeISO(a)}catch(f){return console.warn(`Failed to convert to timezone "${a}":`,f),null}for(let f of i)if(typeof f=="string")try{c=FE(c,f)}catch(d){return console.warn(`Error applying modifier "${f}":`,d),null}return c}var $E=(...e)=>{let t=Xr(e);return t?t.toPlainDate().toString():null},Rh=Q({name:"date",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},$E),UE=(...e)=>{let t=Xr(e);return t?t.toPlainTime().toString({smallestUnit:"second"}):null},Nh=Q({name:"time",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},UE),BE=(...e)=>{let t=Xr(e);if(!t)return null;let n=t.toPlainDate().toString(),r=t.toPlainTime().toString({smallestUnit:"second"});return`${n} ${r}`},bh=Q({name:"datetime",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},BE),_E=(...e)=>{let t=Xr(e);return t?t.toInstant().epochMilliseconds/wh+Ih:null},Ch=Q({name:"julianday",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},_E),VE=(e,...t)=>{if(typeof e!="string")return null;let n=Xr(t);if(!n)return null;try{let r=e;return r=r.replace(/%./g,s=>{switch(s){case"%Y":return n.year.toString().padStart(4,"0");case"%m":return n.month.toString().padStart(2,"0");case"%d":return n.day.toString().padStart(2,"0");case"%j":return n.dayOfYear.toString().padStart(3,"0");case"%H":return n.hour.toString().padStart(2,"0");case"%M":return n.minute.toString().padStart(2,"0");case"%S":return n.second.toString().padStart(2,"0");case"%f":return`.${n.millisecond.toString().padStart(3,"0")}`;case"%s":return Math.floor(n.epochMilliseconds/1e3).toString();case"%w":return(n.dayOfWeek%7).toString();case"%W":return(n.weekOfYear??0).toString().padStart(2,"0");case"%%":return"%";default:return console.warn(`Unsupported strftime specifier: ${s}`),s}}),r}catch(r){return console.error("Error during strftime formatting:",r),null}},Sh=Q({name:"strftime",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},VE);function xe(e){if(typeof e!="string")return null;try{return JSON.parse(e)}catch{return null}}function un(e,t,n=!1){if(!t||typeof t!="string")return null;let r=e,s=null,o=null,a=t.startsWith("$")?t.substring(1):t;if(a==="")return{parent:null,key:"",value:e,exists:!0};for(;a.length>0;){if(s=r,o=null,r==null)return null;if(a.startsWith(".")){a=a.substring(1);let i;if(a.startsWith('"')){let c=a.indexOf('"',1);if(c===-1)return null;i=a.substring(1,c),a=a.substring(c+1)}else{let c=a.match(/^([^[.\\s]+)/);if(!c)return null;i=c[1],a=a.substring(i.length)}if(typeof r!="object"||Array.isArray(r)){if(!n||typeof s!="object"||s===null||Array.isArray(s)||typeof o!="string")return{parent:s,key:i,value:void 0,exists:!1};console.debug(`JSON Path: Creating intermediate object for key "${o}"`),s[o]={},r=s[o],s=r,o=i,r=r[i]}else o=i,r=r[i]}else if(a.startsWith("[")){let i=a.indexOf("]");if(i===-1)return null;let c=a.substring(1,i).trim(),f=parseInt(c,10);if(a=a.substring(i+1),!Number.isInteger(f)||f<0)return null;if(Array.isArray(r))o=f,r=f<r.length?r[f]:void 0;else{if(!n||s===null||typeof o===null)return{parent:s,key:f,value:void 0,exists:!1};let d=[];if(Array.isArray(s)&&typeof o=="number")console.debug(`JSON Path: Creating intermediate array for index ${o}`),s[o]=d;else if(typeof s=="object"&&!Array.isArray(s)&&typeof o=="string")console.debug(`JSON Path: Creating intermediate array for key "${o}"`),s[o]=d;else return{parent:s,key:f,value:void 0,exists:!1};r=d,s=r,o=f,r=f<r.length?r[f]:void 0}}else return null}return o===null?null:{parent:s,key:o,value:r,exists:r!==void 0}}function cn(e){if(typeof e=="bigint")return e>=Number.MIN_SAFE_INTEGER&&e<=Number.MAX_SAFE_INTEGER?Number(e):e.toString();if(e instanceof Uint8Array||typeof e=="number"&&!Number.isFinite(e))return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e}function An(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(An);let t={};for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=An(e[n]));return t}function ur(e){if(e===null)return"null";switch(typeof e){case"boolean":return e?"true":"false";case"number":return Number.isInteger(e)?"integer":"real";case"string":return"text";case"object":return Array.isArray(e)?"array":"object";default:return"null"}}function xo(e,t){if(!t||t==="$")return e;let n=t.startsWith("$.")?t.substring(2).split("."):t.startsWith("$")?t.substring(1).split("."):t.split("."),r=e;for(let s of n){if(r==null)return;let o=s.match(/^\s*\[(\d+)\]\s*$/);if(o){let a=parseInt(o[1],10);if(Array.isArray(r)&&a>=0&&a<r.length)r=r[a];else return}else if(typeof r=="object"&&r!==null&&Object.prototype.hasOwnProperty.call(r,s))r=r[s];else return}return r}var ml={};Bo(ml,{JsonPatchError:()=>ce,_areEquals:()=>es,applyOperation:()=>Tn,applyPatch:()=>fr,applyReducer:()=>YE,deepClone:()=>qE,getValueByPointer:()=>Po,validate:()=>Th,validator:()=>ko});var KE=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,s){r.__proto__=s}||function(r,s){for(var o in s)s.hasOwnProperty(o)&&(r[o]=s[o])},e(t,n)};return function(t,n){e(t,n);function r(){this.constructor=t}t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),GE=Object.prototype.hasOwnProperty;function Oo(e,t){return GE.call(e,t)}function Mo(e){if(Array.isArray(e)){for(var t=new Array(e.length),n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(e);var r=[];for(var s in e)Oo(e,s)&&r.push(s);return r}function Ie(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Do(e){for(var t=0,n=e.length,r;t<n;){if(r=e.charCodeAt(t),r>=48&&r<=57){t++;continue}return!1}return!0}function Nt(e){return e.indexOf("/")===-1&&e.indexOf("~")===-1?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function Jr(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Lo(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(var t=0,n=e.length;t<n;t++)if(Lo(e[t]))return!0}else if(typeof e=="object"){for(var r=Mo(e),s=r.length,o=0;o<s;o++)if(Lo(e[r[o]]))return!0}}return!1}function Ah(e,t){var n=[e];for(var r in t){var s=typeof t[r]=="object"?JSON.stringify(t[r],null,2):t[r];typeof s<"u"&&n.push(r+": "+s)}return n.join(`
`)}var Qr=function(e){KE(t,e);function t(n,r,s,o,a){var i=this.constructor,c=e.call(this,Ah(n,{name:r,index:s,operation:o,tree:a}))||this;return c.name=r,c.index=s,c.operation=o,c.tree=a,Object.setPrototypeOf(c,i.prototype),c.message=Ah(n,{name:r,index:s,operation:o,tree:a}),c}return t}(Error);var ce=Qr,qE=Ie,cr={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){var r=Po(n,this.path);r&&(r=Ie(r));var s=Tn(n,{op:"remove",path:this.from}).removed;return Tn(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(e,t,n){var r=Po(n,this.from);return Tn(n,{op:"add",path:this.path,value:Ie(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:es(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}},jE={add:function(e,t,n){return Do(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){var r=e.splice(t,1);return{newDocument:n,removed:r[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:cr.move,copy:cr.copy,test:cr.test,_get:cr._get};function Po(e,t){if(t=="")return e;var n={op:"_get",path:t};return Tn(e,n),n.value}function Tn(e,t,n,r,s,o){if(n===void 0&&(n=!1),r===void 0&&(r=!0),s===void 0&&(s=!0),o===void 0&&(o=0),n&&(typeof n=="function"?n(t,0,e,t.path):ko(t,0)),t.path===""){var a={newDocument:e};if(t.op==="add")return a.newDocument=t.value,a;if(t.op==="replace")return a.newDocument=t.value,a.removed=e,a;if(t.op==="move"||t.op==="copy")return a.newDocument=Po(e,t.from),t.op==="move"&&(a.removed=e),a;if(t.op==="test"){if(a.test=es(e,t.value),a.test===!1)throw new ce("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a.newDocument=e,a}else{if(t.op==="remove")return a.removed=e,a.newDocument=null,a;if(t.op==="_get")return t.value=e,a;if(n)throw new ce("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",o,t,e);return a}}else{r||(e=Ie(e));var i=t.path||"",c=i.split("/"),f=e,d=1,l=c.length,h=void 0,p=void 0,g=void 0;for(typeof n=="function"?g=n:g=ko;;){if(p=c[d],p&&p.indexOf("~")!=-1&&(p=Jr(p)),s&&(p=="__proto__"||p=="prototype"&&d>0&&c[d-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&h===void 0&&(f[p]===void 0?h=c.slice(0,d).join("/"):d==l-1&&(h=t.path),h!==void 0&&g(t,0,e,h)),d++,Array.isArray(f)){if(p==="-")p=f.length;else{if(n&&!Do(p))throw new ce("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",o,t,e);Do(p)&&(p=~~p)}if(d>=l){if(n&&t.op==="add"&&p>f.length)throw new ce("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",o,t,e);var a=jE[t.op].call(t,f,p,e);if(a.test===!1)throw new ce("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a}}else if(d>=l){var a=cr[t.op].call(t,f,p,e);if(a.test===!1)throw new ce("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a}if(f=f[p],n&&d<l&&(!f||typeof f!="object"))throw new ce("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",o,t,e)}}}function fr(e,t,n,r,s){if(r===void 0&&(r=!0),s===void 0&&(s=!0),n&&!Array.isArray(t))throw new ce("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=Ie(e));for(var o=new Array(t.length),a=0,i=t.length;a<i;a++)o[a]=Tn(e,t[a],n,!0,s,a),e=o[a].newDocument;return o.newDocument=e,o}function YE(e,t,n){var r=Tn(e,t);if(r.test===!1)throw new ce("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function ko(e,t,n,r){if(typeof e!="object"||e===null||Array.isArray(e))throw new ce("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(cr[e.op]){if(typeof e.path!="string")throw new ce("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new ce('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new ce("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new ce("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if((e.op==="add"||e.op==="replace"||e.op==="test")&&Lo(e.value))throw new ce("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n){if(e.op=="add"){var s=e.path.split("/").length,o=r.split("/").length;if(s!==o+1&&s!==o)throw new ce("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==r)throw new ce("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if(e.op==="move"||e.op==="copy"){var a={op:"_get",path:e.from,value:void 0},i=Th([a],n);if(i&&i.name==="OPERATION_PATH_UNRESOLVABLE")throw new ce("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}}else throw new ce("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n)}function Th(e,t,n){try{if(!Array.isArray(e))throw new ce("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)fr(Ie(t),Ie(e),n||!0);else{n=n||ko;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(s){if(s instanceof ce)return s;throw s}}function es(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var n=Array.isArray(e),r=Array.isArray(t),s,o,a;if(n&&r){if(o=e.length,o!=t.length)return!1;for(s=o;s--!==0;)if(!es(e[s],t[s]))return!1;return!0}if(n!=r)return!1;var i=Object.keys(e);if(o=i.length,o!==Object.keys(t).length)return!1;for(s=o;s--!==0;)if(!t.hasOwnProperty(i[s]))return!1;for(s=o;s--!==0;)if(a=i[s],!es(e[a],t[a]))return!1;return!0}return e!==e&&t!==t}var yl={};Bo(yl,{compare:()=>ey,generate:()=>pl,observe:()=>QE,unobserve:()=>JE});var gl=new WeakMap,WE=function(){function e(t){this.observers=new Map,this.obj=t}return e}(),zE=function(){function e(t,n){this.callback=t,this.observer=n}return e}();function ZE(e){return gl.get(e)}function HE(e,t){return e.observers.get(t)}function XE(e,t){e.observers.delete(t.callback)}function JE(e,t){t.unobserve()}function QE(e,t){var n=[],r,s=ZE(e);if(!s)s=new WE(e),gl.set(e,s);else{var o=HE(s,t);r=o&&o.observer}if(r)return r;if(r={},s.value=Ie(e),t){r.callback=t,r.next=null;var a=function(){pl(r)},i=function(){clearTimeout(r.next),r.next=setTimeout(a)};typeof window<"u"&&(window.addEventListener("mouseup",i),window.addEventListener("keyup",i),window.addEventListener("mousedown",i),window.addEventListener("keydown",i),window.addEventListener("change",i))}return r.patches=n,r.object=e,r.unobserve=function(){pl(r),clearTimeout(r.next),XE(s,r),typeof window<"u"&&(window.removeEventListener("mouseup",i),window.removeEventListener("keyup",i),window.removeEventListener("mousedown",i),window.removeEventListener("keydown",i),window.removeEventListener("change",i))},s.observers.set(t,new zE(t,r)),r}function pl(e,t){t===void 0&&(t=!1);var n=gl.get(e.object);El(n.value,e.object,e.patches,"",t),e.patches.length&&fr(n.value,e.patches);var r=e.patches;return r.length>0&&(e.patches=[],e.callback&&e.callback(r)),r}function El(e,t,n,r,s){if(t!==e){typeof t.toJSON=="function"&&(t=t.toJSON());for(var o=Mo(t),a=Mo(e),i=!1,c=!1,f=a.length-1;f>=0;f--){var d=a[f],l=e[d];if(Oo(t,d)&&!(t[d]===void 0&&l!==void 0&&Array.isArray(t)===!1)){var h=t[d];typeof l=="object"&&l!=null&&typeof h=="object"&&h!=null&&Array.isArray(l)===Array.isArray(h)?El(l,h,n,r+"/"+Nt(d),s):l!==h&&(i=!0,s&&n.push({op:"test",path:r+"/"+Nt(d),value:Ie(l)}),n.push({op:"replace",path:r+"/"+Nt(d),value:Ie(h)}))}else Array.isArray(e)===Array.isArray(t)?(s&&n.push({op:"test",path:r+"/"+Nt(d),value:Ie(l)}),n.push({op:"remove",path:r+"/"+Nt(d)}),c=!0):(s&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}),i=!0)}if(!(!c&&o.length==a.length))for(var f=0;f<o.length;f++){var d=o[f];!Oo(e,d)&&t[d]!==void 0&&n.push({op:"add",path:r+"/"+Nt(d),value:Ie(t[d])})}}}function ey(e,t,n){n===void 0&&(n=!1);var r=[];return El(e,t,r,"",n),r}var hR=Object.assign({},ml,yl,{JsonPatchError:Qr,deepClone:Ie,escapePathComponent:Nt,unescapePathComponent:Jr});var ty=e=>xe(e)!==null?1:0,vh=Q({name:"json_valid",numArgs:1,flags:M.UTF8|M.DETERMINISTIC},ty),ny=(e,t)=>{let n=xe(e);if(n===null&&typeof e=="string")return null;let r=n;if(t!=null){if(typeof t!="string")return"null";let s=un(n,t);if(r=s?.exists?s.value:void 0,r===void 0)return null}return ur(r)},xh=Q({name:"json_type",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},ny),ry=(e,...t)=>{let n=xe(e);if(n===null&&typeof e=="string"||t.length===0)return null;let r;for(let s of t)if(typeof s=="string"){let o=un(n,s);if(r=o?.exists?o.value:void 0,r!==void 0)break}else return null;if(r===void 0)return null;if(r===null)return null;if(typeof r=="boolean")return r?1:0;if(typeof r=="number")return r;if(typeof r=="string")return r;if(typeof r=="object")try{return JSON.stringify(r)}catch{return null}else return null},Lh=Q({name:"json_extract",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},ry),sy=e=>{if(e===null)return"null";switch(typeof e){case"number":return Number.isFinite(e)?String(e):"null";case"boolean":return e?"true":"false";case"string":return JSON.stringify(e);case"bigint":case"object":default:return null}},Oh=Q({name:"json_quote",numArgs:1,flags:M.UTF8|M.DETERMINISTIC},sy),oy=(...e)=>{let t=e.map(n=>cn(n));try{return JSON.stringify(t)}catch{return null}},Mh=Q({name:"json_array",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},oy),ay=(...e)=>{if(e.length%2!==0)return null;let t={};for(let n=0;n<e.length;n+=2){let r=e[n],s=e[n+1];if(typeof r!="string")return null;t[r]=cn(s)}try{return JSON.stringify(t)}catch{return null}},Dh=Q({name:"json_object",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},ay),iy=(e,t)=>{let n=xe(e);if(n===null&&typeof e=="string")return null;let r=n;if(t!=null){if(typeof t!="string")return 0;let s=un(n,t);r=s?.exists?s.value:void 0}return Array.isArray(r)?r.length:0},Ph=Q({name:"json_array_length",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},iy),ly=(e,t)=>{let n=xe(e),r=xe(t);if(n===null&&typeof e=="string"||!Array.isArray(r))return null;try{let s=fr(n,r,!0).newDocument;return JSON.stringify(s)}catch(s){return console.error(`json_patch failed: ${s?.message}`,s),null}},kh=Q({name:"json_patch",numArgs:2,flags:M.UTF8},ly),uy=(e,...t)=>{let n=xe(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=An(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=cn(a),c=un(r,o);if(c===null)continue;let{parent:f,key:d,exists:l}=c;if(!l){if(f===null)continue;Array.isArray(f)&&typeof d=="number"?d===f.length?f.push(i):d<f.length&&f.splice(d,0,i):typeof f=="object"&&typeof d=="string"&&(f[d]=i)}}try{return JSON.stringify(r)}catch{return null}},Fh=Q({name:"json_insert",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},uy),cy=(e,...t)=>{let n=xe(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=An(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=cn(a),c=un(r,o);if(c===null)continue;let{parent:f,key:d,exists:l}=c;l&&(f===null&&d===""?r=i:(f!==null&&typeof d=="string"&&typeof f=="object"&&!Array.isArray(f)||f!==null&&typeof d=="number"&&Array.isArray(f)&&d>=0&&d<f.length)&&(f[d]=i))}try{return JSON.stringify(r)}catch{return null}},$h=Q({name:"json_replace",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},cy),fy=(e,...t)=>{let n=xe(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=An(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=cn(a),c=un(r,o,!0);if(c===null)continue;let{parent:f,key:d,exists:l}=c;if(f===null&&d==="")r=i;else if(f!==null){if(typeof f=="object"&&!Array.isArray(f)&&typeof d=="string")f[d]=i;else if(Array.isArray(f)&&typeof d=="number"){if(d>=0&&d<f.length)f[d]=i;else if(d===f.length)f.push(i);else if(d>f.length){for(;f.length<d;)f.push(null);f.push(i)}}}}try{return JSON.stringify(r)}catch{return null}},Uh=Q({name:"json_set",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},fy),dy=(e,...t)=>{let n=xe(e);if(n===null&&typeof e=="string")return null;if(t.length===0)return JSON.stringify(n);let r=An(n);for(let s of t){if(typeof s!="string")return null;let o=un(r,s);if(o===null||!o.exists||o.parent===null)continue;let{parent:a,key:i}=o;Array.isArray(a)&&typeof i=="number"?i>=0&&i<a.length&&a.splice(i,1):typeof a=="object"&&typeof i=="string"&&Object.prototype.hasOwnProperty.call(a,i)&&delete a[i]}try{return JSON.stringify(r)}catch{return null}},Bh=Q({name:"json_remove",numArgs:-1,flags:M.UTF8|M.DETERMINISTIC},dy),hy=(e,t)=>{let n=e??[],r=cn(t);return n.push(r),n},my=e=>{try{return e&&e.length>0?JSON.stringify(e):null}catch{return null}},_h=De({name:"json_group_array",numArgs:1,flags:M.UTF8,initialState:[]},hy,my),py=(e,t,n)=>{let r=e??{};if(typeof t!="string"||t===null)return r;let s=cn(n);return r[t]=s,r},gy=e=>{try{return e&&Object.keys(e).length>0?JSON.stringify(e):null}catch{return null}},Vh=De({name:"json_group_object",numArgs:2,flags:M.UTF8,initialState:{}},py,gy);var wl=[Ou,Mu,Du,ku,Fu,$u,Uu,Bu,_u,Vu,Ku,Gu,qu,ju,Yu,Wu,zu,Zu,Rh,Nh,bh,Ch,Sh,vh,xh,Lh,Oh,Mh,Dh,Fh,$h,Uh,Bh,Ph,kh,_h,Vh];var Ey=Object.freeze([{name:"key",affinity:A.INTEGER|A.TEXT},{name:"value",affinity:A.TEXT},{name:"type",affinity:A.TEXT},{name:"atom",affinity:A.TEXT},{name:"id",affinity:A.INTEGER},{name:"parent",affinity:A.INTEGER},{name:"fullkey",affinity:A.TEXT},{name:"path",affinity:A.TEXT}]),Nl=Object.freeze(Ey.map(e=>({...Te(e.name),affinity:e.affinity}))),Kh=Object.freeze(Oe(Nl)),Il=class extends at{parsedJson;rootPath;tableSchema;constructor(t,n,r,s,o,a){if(super(t,n,r,s),this.parsedJson=xe(o),this.rootPath=typeof a=="string"&&a?a:null,this.parsedJson===null&&typeof o=="string")throw new R(`Invalid JSON provided to ${s}`,I.ERROR);this.tableSchema=Object.freeze({name:s,schemaName:r,columns:Nl,columnIndexMap:Kh,primaryKeyDefinition:[],isVirtual:!0,vtabModule:n,vtabInstance:this,vtabModuleName:"json_each"})}},Rl=class extends it{stack=[];currentRow=null;isEof=!0;elementIdCounter=0;constructor(t){super(t)}reset(){this.stack=[],this.currentRow=null,this.isEof=!0,this.elementIdCounter=0}startIteration(t,n){this.reset();let r=n??"$";t!==void 0?(this.stack.push({value:t,parentPath:"",parentKey:null,parentId:0,currentIndex:-1}),this.isEof=!1,this.next()):this.isEof=!0}next(){if(this.stack.length===0){this.isEof=!0,this.currentRow=null;return}let t=this.stack[this.stack.length-1],n=t.value,r=t.parentKey,s=this.elementIdCounter++,o=t.parentPath,a=r!==null?`${o}${typeof r=="number"?`[${r}]`:`.${r}`}`:o,i=ur(n),c=i==="object"||i==="array"?null:n;if(this.currentRow={key:r,value:i==="object"||i==="array"?JSON.stringify(n):n,type:i,atom:c,id:s,parent:t.parentId,fullkey:a,path:o},this.stack.pop(),Array.isArray(n))for(let f=n.length-1;f>=0;f--)this.stack.push({value:n[f],parentPath:a,parentKey:f,parentId:s,currentIndex:-1});else if(typeof n=="object"&&n!==null){let f=Object.keys(n).sort().reverse();for(let d of f)this.stack.push({value:n[d],parentPath:a,parentKey:d,parentId:s,currentIndex:-1})}this.stack.length}eof(){return this.isEof}column(t){if(!this.currentRow)return null;let n=Nl[t]?.name;if(n==="value"&&this.currentRow){let r=this.currentRow.type;if(r==="object"||r==="array"){let s=this.currentRow._originalValue;return s?JSON.stringify(s):null}else return this.currentRow[n]??null}else return this.currentRow[n]??null}},Fo=class{xConnect(t,n,r,s,o,a){return new Il(t,this,s,o,a.jsonSource,a.rootPath)}xCreate(t,n,r,s,o,a){return this.xConnect(t,n,r,s,o,a)}async xDisconnect(t){}async xDestroy(t){}async xOpen(t){return new Rl(t)}async xClose(t){t.reset()}xBestIndex(t,n){return n.estimatedCost=1e5,n.idxNum=0,n.idxStr=null,n.orderByConsumed=!1,I.OK}async xFilter(t,n,r,s){let o=t.table.rootPath,a=t.table.parsedJson;o&&(a=xo(a,o)),t.startIteration(a,o)}async xNext(t){t.next()}async xEof(t){return t.eof()}xColumn(t,n,r){return n.resultValue(t.column(r)),I.OK}xRowid(t){let n=Kh.get("id"),r=t.column(n);return typeof r=="number"?Promise.resolve(BigInt(r)):Promise.reject(new R("Cannot get rowid for json_each cursor",I.ERROR))}async xUpdate(){throw new R("json_each table is read-only",I.READONLY)}async xBegin(){return Promise.resolve()}async xSync(){return Promise.resolve()}async xCommit(){return Promise.resolve()}async xRollback(){return Promise.resolve()}async xRename(){throw new R("Cannot rename json_each table",I.ERROR)}};var yy=Object.freeze([{name:"key",affinity:A.INTEGER|A.TEXT},{name:"value",affinity:A.TEXT},{name:"type",affinity:A.TEXT},{name:"atom",affinity:A.TEXT},{name:"id",affinity:A.INTEGER},{name:"parent",affinity:A.INTEGER},{name:"fullkey",affinity:A.TEXT},{name:"path",affinity:A.TEXT}]),Sl=Object.freeze(yy.map(e=>({...Te(e.name),affinity:e.affinity}))),Gh=Object.freeze(Oe(Sl)),bl=class extends at{parsedJson;rootPath;tableSchema;constructor(t,n,r,s,o,a){if(super(t,n,r,s),this.parsedJson=xe(o),this.rootPath=typeof a=="string"&&a?a:null,this.parsedJson===null&&typeof o=="string")throw new R(`Invalid JSON provided to ${s}`,I.ERROR);this.tableSchema=Object.freeze({name:s,schemaName:r,columns:Sl,columnIndexMap:Gh,primaryKeyDefinition:[],isVirtual:!0,vtabModule:n,vtabInstance:this,vtabModuleName:"json_tree"})}},Cl=class extends it{stack=[];currentRow=null;isEof=!0;elementIdCounter=0;constructor(t){super(t)}reset(){this.stack=[],this.currentRow=null,this.isEof=!0,this.elementIdCounter=0}startIteration(t,n){this.reset();let r=n??"$";t!==void 0?(this.stack.push({value:t,parentPath:"",parentKey:null,parentId:0,childrenPushed:!1}),this.isEof=!1,this.next()):this.isEof=!0}next(){if(this.stack.length===0){this.isEof=!0,this.currentRow=null;return}let t=this.stack[this.stack.length-1],n=t.value,r=typeof n=="object"&&n!==null;if(this.currentRow===null||!t.childrenPushed){let a=t.parentKey,i=++this.elementIdCounter,c=t.parentPath,f=a!==null?`${c}${typeof a=="number"?`[${a}]`:`.${a}`}`:c,d=ur(n),l=r?null:n;if(this.currentRow={key:a,value:r?JSON.stringify(n):n,type:d,atom:l,id:i,parent:t.parentId,fullkey:f,path:c,_originalValue:r?n:void 0},r){t.childrenPushed=!1;return}else{this.stack.pop(),this.next();return}}t.childrenPushed=!0;let s=this.currentRow.id,o=this.currentRow.fullkey;if(this.stack.pop(),Array.isArray(n))for(let a=n.length-1;a>=0;a--)this.stack.push({value:n[a],parentPath:o,parentKey:a,parentId:s,childrenPushed:!1});else if(typeof n=="object"&&n!==null){let a=Object.keys(n).sort().reverse();for(let i of a)this.stack.push({value:n[i],parentPath:o,parentKey:i,parentId:s,childrenPushed:!1})}this.currentRow=null,this.next()}eof(){return this.isEof}column(t){if(!this.currentRow)return null;let n=Sl[t]?.name;if(n==="value"&&this.currentRow){let r=this.currentRow.type;if(r==="object"||r==="array"){let s=this.currentRow._originalValue;return s!==void 0?JSON.stringify(s):null}else return this.currentRow[n]??null}else return this.currentRow[n]??null}},$o=class{xConnect(t,n,r,s,o,a){return new bl(t,this,s,o,a.jsonSource,a.rootPath)}xCreate(t,n,r,s,o,a){return this.xConnect(t,n,r,s,o,a)}async xDisconnect(t){}async xDestroy(t){}async xOpen(t){return new Cl(t)}async xClose(t){t.reset()}xBestIndex(t,n){return n.estimatedCost=1e5,n.idxNum=0,n.idxStr=null,n.orderByConsumed=!1,I.OK}async xFilter(t,n,r,s){let o=t.table.rootPath,a=t.table.parsedJson;o&&(a=xo(a,o)),t.startIteration(a,o)}async xNext(t){t.next()}async xEof(t){return t.eof()}xColumn(t,n,r){return n.resultValue(t.column(r)),I.OK}xRowid(t){let n=Gh.get("id"),r=t.column(n);return typeof r=="number"?Promise.resolve(BigInt(r)):Promise.reject(new R("Cannot get rowid for json_tree cursor",I.ERROR))}async xUpdate(){throw new R("json_tree table is read-only",I.READONLY)}async xBegin(){return Promise.resolve()}async xSync(){return Promise.resolve()}async xCommit(){return Promise.resolve()}async xRollback(){return Promise.resolve()}async xRename(){throw new R("Cannot rename json_tree table",I.ERROR)}};function qh(e){if(!e.isOpen)throw new $("Database is closed");let t=e.schemaManager,n={schemaVersion:1,schemas:{}};for(let r of t._getAllSchemas()){let s={tables:[],functions:[]};for(let o of r.getAllTables()){let a={name:o.name,columns:o.columns.map(i=>{let c=A[i.affinity],f=null;return typeof i.defaultValue=="string"||typeof i.defaultValue=="number"||i.defaultValue===null?f=i.defaultValue:typeof i.defaultValue=="bigint"?f=i.defaultValue.toString()+"n":i.defaultValue instanceof Uint8Array&&(f=`x'${Array.from(i.defaultValue).map(l=>l.toString(16).padStart(2,"0")).join("")}'`),{name:i.name,affinity:c,notNull:i.notNull,primaryKey:i.primaryKey,defaultValue:f,collation:i.collation,hidden:i.hidden,generated:i.generated}}),primaryKeyDefinition:[...o.primaryKeyDefinition],isVirtual:o.isVirtual,vtabModule:o.vtabModuleName,vtabArgs:o.vtabArgs?[...o.vtabArgs]:void 0};s.tables.push(a)}for(let o of r._getAllFunctions()){let a={name:o.name,numArgs:o.numArgs,flags:o.flags};s.functions.push(a)}n.schemas[r.name]=s}return JSON.stringify(n,null,2)}function jh(e,t){if(!e.isOpen)throw new $("Database is closed");let n=e.schemaManager;if(e.inTransaction)throw new $("Cannot import schema during a transaction");let s;try{s=JSON.parse(t)}catch(o){throw new Error(`Failed to parse JSON schema: ${o.message}`)}if(s.schemaVersion!==1)throw new Error(`Unsupported schema version: ${s.schemaVersion}. Expected version 1.`);n.clearAll();for(let o in s.schemas){if(!Object.prototype.hasOwnProperty.call(s.schemas,o))continue;let a=n.getSchema(o);if(a)a.clearTables(),a.clearFunctions();else{if(o==="main"||o==="temp")throw console.error(`Core schema ${o} missing during import!`),new R(`Internal error: Core schema ${o} is missing.`,I.INTERNAL);a=n.addSchema(o)}let i=s.schemas[o];for(let c of i.tables){let f=c.columns.map(l=>{let h=A[l.affinity];if(h===void 0)throw new Error(`Invalid affinity string "${l.affinity}" for column ${l.name}`);let p=null;if(typeof l.defaultValue=="string")if(l.defaultValue.endsWith("n"))try{p=BigInt(l.defaultValue.slice(0,-1))}catch{}else if(l.defaultValue.toLowerCase().startsWith("x'")&&l.defaultValue.endsWith("'")){let g=l.defaultValue.slice(2,-1);try{let E=new Uint8Array(g.length/2);for(let w=0;w<g.length;w+=2)E[w/2]=parseInt(g.substring(w,w+2),16);p=E}catch{}}else p=l.defaultValue;else(typeof l.defaultValue=="number"||l.defaultValue===null)&&(p=l.defaultValue);return{name:l.name,affinity:h,notNull:l.notNull,primaryKey:l.primaryKey,pkOrder:c.primaryKeyDefinition.find(g=>g.index===c.columns.indexOf(l))?c.primaryKeyDefinition.findIndex(g=>g.index===c.columns.indexOf(l))+1:0,defaultValue:p,collation:l.collation,hidden:l.hidden,generated:l.generated}}),d={name:c.name,schemaName:o,columns:Object.freeze(f),columnIndexMap:Object.freeze(Oe(f)),primaryKeyDefinition:Object.freeze(c.primaryKeyDefinition),isVirtual:c.isVirtual,vtabModuleName:c.vtabModule,vtabArgs:c.vtabArgs?Object.freeze(c.vtabArgs):void 0};a.addTable(d)}for(let c of i.functions){let f={name:c.name,numArgs:c.numArgs,flags:c.flags};a.addFunction(f)}}console.warn("Schema imported from JSON. Function implementations and VTab connections must be re-established manually.")}var Uo=class{schemaManager;isOpen=!0;statements=new Set;registeredVTabs=new Map;isAutocommit=!0;inTransaction=!1;defaultVtabModuleName="memory";defaultVtabModuleArgs=[];constructor(){this.schemaManager=new $n(this),console.log("Database instance created."),this.registerBuiltinFunctions(),this.registerVtabModule("memory",new Kt),this.registerVtabModule("json_each",new Fo),this.registerVtabModule("json_tree",new $o),this.registerDefaultCollations()}registerBuiltinFunctions(){let t=this.schemaManager.getMainSchema();wl.forEach(n=>{try{t.addFunction(n)}catch(r){console.error(`Failed to register built-in function ${n.name}/${n.numArgs}:`,r)}}),console.log(`Registered ${wl.length} built-in functions.`)}registerDefaultCollations(){Er("BINARY",Ko),Er("NOCASE",yu),Er("RTRIM",wu),console.log("Default collations registered (BINARY, NOCASE, RTRIM)")}async prepare(t){if(!this.isOpen)throw new $("Database is closed");console.log(`Preparing SQL: ${t}`);let n=new Fn(this,t);try{return this.statements.add(n),n}catch(r){throw this.statements.delete(n),r}}async exec(t,n,r){if(!this.isOpen)throw new $("Database is closed");typeof n=="function"&&r===void 0&&(r=n,n=void 0),console.log(`Executing SQL: ${t}`);let s=await this.prepare(t);try{n&&typeof n!="function"&&s.bindAll(n);let o=await s.step();for(;o===I.ROW;){if(r){let a=s.getAsObject(),i=s.getColumnNames();r(a,i)}o=await s.step()}if(o!==I.DONE&&o!==I.OK)throw new R("Execution failed",o)}finally{await s.finalize()}}registerVtabModule(t,n,r){if(!this.isOpen)throw new $("Database is closed");let s=t.toLowerCase();if(this.registeredVTabs.has(s))throw new R(`Virtual table module '${t}' already registered`,I.ERROR);console.log(`Registering VTab module: ${t}`),this.registeredVTabs.set(s,{module:n,auxData:r})}async beginTransaction(t="deferred"){if(!this.isOpen)throw new $("Database is closed");if(this.inTransaction)throw new R("Transaction already active",I.ERROR);await this.exec(`BEGIN ${t.toUpperCase()} TRANSACTION`),this.inTransaction=!0,this.isAutocommit=!1}async commit(){if(!this.isOpen)throw new $("Database is closed");if(!this.inTransaction)throw new R("No transaction active",I.ERROR);await this.exec("COMMIT"),this.inTransaction=!1,this.isAutocommit=!0}async rollback(){if(!this.isOpen)throw new $("Database is closed");if(!this.inTransaction)throw new R("No transaction active",I.ERROR);await this.exec("ROLLBACK"),this.inTransaction=!1,this.isAutocommit=!0}async close(){if(!this.isOpen)return;console.log("Closing database..."),this.isOpen=!1;let t=Array.from(this.statements).map(n=>n.finalize());await Promise.allSettled(t),this.statements.clear(),this.schemaManager.clearAll(),this.registeredVTabs.clear(),console.log("Database closed.")}_statementFinalized(t){this.statements.delete(t)}getAutocommit(){if(!this.isOpen)throw new $("Database is closed");return this.isAutocommit}defineVirtualTable(t){if(!this.isOpen)throw new $("Database is closed");if(!t.isVirtual||!t.vtabModule)throw new $("Definition must be for a virtual table with a module");if(t.schemaName!=="main")throw new $("Programmatic definition only supported for 'main' schema currently");this.schemaManager.getMainSchema().addTable(t)}_getVtabModule(t){return this.registeredVTabs.get(t.toLowerCase())}_findTable(t,n){return this.schemaManager.findTable(t,n)}_findFunction(t,n){return this.schemaManager.findFunction(t,n)}createScalarFunction(t,n,r){if(!this.isOpen)throw new $("Database is closed");let s=n.deterministic?M.DETERMINISTIC|M.UTF8:M.UTF8,o=n.flags??s,a=Q({name:t,numArgs:n.numArgs,flags:o},r);try{this.schemaManager.getMainSchema().addFunction(a)}catch(i){throw console.error(`Failed to register scalar function ${t}/${n.numArgs}:`,i),i instanceof Error?i:new Error(String(i))}}createAggregateFunction(t,n,r,s){if(!this.isOpen)throw new $("Database is closed");let o=n.flags??M.UTF8,a=De({name:t,numArgs:n.numArgs,flags:o,initialState:n.initialState},r,s);try{this.schemaManager.getMainSchema().addFunction(a)}catch(i){throw console.error(`Failed to register aggregate function ${t}/${n.numArgs}:`,i),i instanceof Error?i:new Error(String(i))}}registerFunction(t){if(!this.isOpen)throw new $("Database is closed");try{this.schemaManager.getMainSchema().addFunction(t)}catch(n){throw console.error(`Failed to register function ${t.name}/${t.numArgs}:`,n),n instanceof Error?n:new Error(String(n))}}exportSchemaJson(){return qh(this)}importSchemaJson(t){jh(this,t)}setDefaultVtabModule(t,n=[]){console.warn("Deprecated: Use `PRAGMA default_vtab_module` and `PRAGMA default_vtab_args` instead."),this.setDefaultVtabName(t),this.setDefaultVtabArgs(n)}setDefaultVtabName(t){this.registeredVTabs.has(t.toLowerCase())||console.warn(`Setting default VTab module to '${t}', which is not currently registered.`),this.defaultVtabModuleName=t}setDefaultVtabArgs(t){this.defaultVtabModuleArgs=[...t]}setDefaultVtabArgsFromJson(t){try{let n=JSON.parse(t);if(!Array.isArray(n)||!n.every(r=>typeof r=="string"))throw new Error("JSON value must be an array of strings.");this.setDefaultVtabArgs(n)}catch(n){let r=n instanceof Error?n.message:String(n);throw new R(`Invalid JSON for default_vtab_args: ${r}`,I.ERROR)}}getDefaultVtabModule(){return{name:this.defaultVtabModuleName,args:[...this.defaultVtabModuleArgs]}}registerCollation(t,n){if(!this.isOpen)throw new R("Database is closed",I.ERROR);Er(t,n),console.log(`Registered collation: ${t}`)}_getCollation(t){return Iu(t)}async*eval(t,n){if(!this.isOpen)throw new $("Database is closed");let r=null;try{r=await this.prepare(t),n&&r.bindAll(n);let s;for(;(s=await r.step())===I.ROW;)yield r.getAsObject();if(s!==I.DONE&&s!==I.OK)throw new R(`Iteration failed for query: ${t}`,s)}finally{r&&await r.finalize()}}};return Jh(wy);})();
/*! Bundled license information:

fast-json-patch/module/helpers.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

fast-json-patch/module/duplex.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2021 Joachim Wester
   * MIT license
   *)
*/
return DigithoughtSqliter}));
