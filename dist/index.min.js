(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.DigithoughtSqliter = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var DigithoughtSqliter=(()=>{var Uh=Object.create;var zr=Object.defineProperty;var $h=Object.getOwnPropertyDescriptor;var Bh=Object.getOwnPropertyNames;var _h=Object.getPrototypeOf,Vh=Object.prototype.hasOwnProperty;var ar=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Oo=(e,t)=>{for(var n in t)zr(e,n,{get:t[n],enumerable:!0})},yl=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Bh(t))!Vh.call(e,s)&&s!==n&&zr(e,s,{get:()=>t[s],enumerable:!(r=$h(t,s))||r.enumerable});return e};var Kh=(e,t,n)=>(n=e!=null?Uh(_h(e)):{},yl(t||!e||!e.__esModule?zr(n,"default",{value:e,enumerable:!0}):n,e)),Gh=e=>yl(zr({},"__esModule",{value:!0}),e);var gu=ar(Rn=>{"use strict";Object.defineProperty(Rn,"__esModule",{value:!0});Rn.BranchNode=Rn.LeafNode=void 0;var Uo=class{entries;constructor(t){this.entries=t}};Rn.LeafNode=Uo;var $o=class{partitions;nodes;constructor(t,n){this.partitions=t,this.nodes=n}};Rn.BranchNode=$o});var Eu=ar(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.BTree=oe.NodeCapacity=void 0;var It=_o(),bt=gu();oe.NodeCapacity=64;var Bo=class{keyFromEntry;compare;_root;_version=0;constructor(t=r=>r,n=(r,s)=>r<s?-1:r>s?1:0){this.keyFromEntry=t,this.compare=n,this._root=new bt.LeafNode([])}first(){return this.getFirst(this._root)}last(){return this.getLast(this._root)}find(t){return this.getPath(this._root,t)}get(t){return this.at(this.find(t))}at(t){return this.validatePath(t),t.on?t.leafNode.entries[t.leafIndex]:void 0}*range(t){let n=t.first?this.findFirst(t):t.isAscending?this.first():this.last(),r=t.last?this.findLast(t):t.isAscending?this.last():this.first(),s=this.keyFromEntry(r.leafNode.entries[r.leafIndex]),o=t.isAscending?this.internalAscending(n):this.internalDescending(n),a=t.isAscending?1:-1;for(let i of o){if(!i.on||!r.on||this.compareKeys(this.keyFromEntry(i.leafNode.entries[i.leafIndex]),s)*a>0)break;yield i}}isValid(t){return t.version===this._version}insert(t){Object.freeze(t);let n=this.internalInsert(t);return n.on&&(n.version=++this._version),n}updateAt(t,n){this.validatePath(t),t.on&&Object.freeze(n);let r=this.internalUpdate(t,n);return r[0].on&&(r[0].version=++this._version),r}upsert(t){let n=this.find(this.keyFromEntry(t));return Object.freeze(t),n.on?n.leafNode.entries[n.leafIndex]=t:this.internalInsertAt(n,t),n.version=++this._version,n}merge(t,n){let r=this.keyFromEntry(t),s=this.find(r);if(s.on){let o=this.updateAt(s,n(s.leafNode.entries[s.leafIndex]));return o[0].on&&(o[0].version=++this._version),o}else return this.internalInsertAt(s,Object.freeze(t)),s.on=!0,s.version=++this._version,[s,!1]}deleteAt(t){this.validatePath(t);let n=this.internalDelete(t);return n&&++this._version,n}ascending(t){return this.validatePath(t),this.internalAscending(t.clone())}descending(t){return this.validatePath(t),this.internalDescending(t.clone())}getCount(t){let n=0,r=t?t.path.clone():this.first();if(t?.ascending??!0)for(;r.on;)n+=r.leafNode.entries.length-r.leafIndex,r.leafIndex=r.leafNode.entries.length-1,this.internalNext(r);else for(;r.on;)n+=r.leafIndex+1,r.leafIndex=0,this.internalPrior(r);return n}next(t){let n=t.clone();return this.moveNext(n),n}moveNext(t){this.validatePath(t),this.internalNext(t)}prior(t){let n=t.clone();return this.movePrior(n),n}movePrior(t){this.validatePath(t),this.internalPrior(t)}compareKeys(t,n){let r=this.compare(t,n);if(r!==0&&r===this.compare(n,t))throw new Error("Inconsistent comparison function for given values");return r}*internalAscending(t){for(this.validatePath(t);t.on;)yield t,this.moveNext(t)}*internalDescending(t){for(this.validatePath(t);t.on;)yield t,this.movePrior(t)}findFirst(t){let n=this.find(t.first.key);return(!n.on||t.first&&!t.first.inclusive)&&(t.isAscending?this.internalNext(n):this.internalPrior(n)),n}findLast(t){let n=this.find(t.last.key);return(!n.on||t.last&&!t.last.inclusive)&&(t.isAscending?this.internalPrior(n):this.internalNext(n)),n}getPath(t,n){if(t instanceof bt.LeafNode){let r=t,[s,o]=this.indexOfEntry(r.entries,n);return new It.Path([],r,o,s,this._version)}else{let r=t,s=this.indexOfKey(r.partitions,n),o=this.getPath(r.nodes[s],n);return o.branches.unshift(new It.PathBranch(r,s)),o}}indexOfEntry(t,n){let r=0,s=t.length-1,o=0,a=-1;for(;r<=s;){if(o=r+s>>>1,a=this.compareKeys(n,this.keyFromEntry(t[o])),a===0)return[!0,o];a<0?s=o-1:r=o+1}return[!1,r]}indexOfKey(t,n){let r=0,s=t.length-1,o=0,a=-1;for(;r<=s;){if(o=r+s>>>1,a=this.compareKeys(n,t[o]),a===0)return o+1;a<0?s=o-1:r=o+1}return r}internalNext(t){if(t.on)if(t.leafIndex>=t.leafNode.entries.length-1){let n=0,r=!1,s=t.branches.length-1;for(;n<=s&&!r;){let o=t.branches[s-n];o.index===o.node.partitions.length?++n:r=!0}if(!r)t.leafIndex=t.leafNode.entries.length,t.on=!1;else{t.branches.splice(-n,n);let o=t.branches.at(-1);++o.index,this.moveToFirst(o.node.nodes[o.index],t)}}else++t.leafIndex,t.on=!0;else if(t.on=t.branches.every(n=>n.index>=0&&n.index<n.node.nodes.length)&&t.leafIndex>=0&&t.leafIndex<t.leafNode.entries.length,t.on)return}internalPrior(t){if(this.validatePath(t),t.leafIndex<=0){let n=0,r=!1,s=t.branches.length-1;for(;n<=s&&!r;)t.branches[s-n].index===0?++n:r=!0;if(!r)t.leafIndex=0,t.on=!1;else{t.branches.splice(-n,n);let o=t.branches.at(-1);--o.index,this.moveToLast(o.node.nodes[o.index],t)}}else--t.leafIndex,t.on=!0}internalUpdate(t,n){if(t.on){let r=this.keyFromEntry(t.leafNode.entries[t.leafIndex]),s=this.keyFromEntry(n);if(this.compareKeys(r,s)!==0){let o=this.internalInsert(n);return o.on&&(this.internalDelete(this.find(r)),o=this.find(s)),[o,!1]}else t.leafNode.entries[t.leafIndex]=n}return[t,!0]}internalDelete(t){if(t.on){if(t.leafNode.entries.splice(t.leafIndex,1),t.branches.length>0){if(t.leafIndex===0){let r=t.branches.at(-1);this.updatePartition(r.index,t,t.branches.length-1,this.keyFromEntry(t.leafNode.entries[t.leafIndex]))}let n=this.rebalanceLeaf(t,t.branches.length);n&&(this._root=n)}return t.on=!1,!0}else return!1}internalInsert(t){let n=this.find(this.keyFromEntry(t));return n.on?(n.on=!1,n):(this.internalInsertAt(n,t),n.on=!0,n)}internalInsertAt(t,n){let r=this.leafInsert(t,n),s=t.branches.length-1;for(;r&&s>=0;)r=this.branchInsert(t,s,r),--s;if(r){let o=new bt.BranchNode([r.key],[this._root,r.right]);this._root=o,t.branches.unshift(new It.PathBranch(o,r.indexDelta))}}moveToFirst(t,n){if(t instanceof bt.LeafNode){let r=t;n.leafNode=r,n.leafIndex=0,n.on=r.entries.length>0}else n.branches.push(new It.PathBranch(t,0)),this.moveToFirst(t.nodes[0],n)}moveToLast(t,n){if(t instanceof bt.LeafNode){let r=t,s=r.entries.length;n.leafNode=r,n.on=s>0,n.leafIndex=s>0?s-1:0}else{let r=t,s=new It.PathBranch(r,r.partitions.length);n.branches.push(s),this.moveToLast(r.nodes[s.index],n)}}getFirst(t){if(t instanceof bt.LeafNode){let n=t;return new It.Path([],n,0,n.entries.length>0,this._version)}else{let n=t,r=this.getFirst(n.nodes[0]);return r.branches.unshift(new It.PathBranch(n,0)),r}}getLast(t){if(t instanceof bt.LeafNode){let n=t,r=n.entries.length;return new It.Path([],n,r>0?r-1:0,r>0,this._version)}else{let n=t,r=n.nodes.length-1,s=this.getLast(n.nodes[r]);return s.branches.unshift(new It.PathBranch(n,r)),s}}leafInsert(t,n){let{leafNode:r,leafIndex:s}=t;if(r.entries.length<oe.NodeCapacity){r.entries.splice(s,0,n);return}let o=r.entries.length+1>>>1,a=r.entries.splice(o),i=new bt.LeafNode(a);return s<o?r.entries.splice(s,0,n):(t.leafNode=i,t.leafIndex-=r.entries.length,i.entries.splice(t.leafIndex,0,n)),new us(this.keyFromEntry(a[0]),i,s<o?0:1)}branchInsert(t,n,r){let s=t.branches[n],{index:o,node:a}=s;if(s.index+=r.indexDelta,a.partitions.splice(o,0,r.key),a.nodes.splice(o+1,0,r.right),a.nodes.length<=oe.NodeCapacity)return;let i=a.nodes.length>>>1,u=a.partitions.splice(i),c=a.partitions.pop(),d=a.nodes.splice(i),l=new bt.BranchNode(u,d);return s.index>=i&&(s.index-=i),new us(c,l,s.index<i?0:1)}rebalanceLeaf(t,n){if(n===0||t.leafNode.entries.length>=oe.NodeCapacity>>>1)return;let r=t.leafNode,s=t.branches.at(n-1),o=s.index,a=s.node,i=o<a.nodes.length?a.nodes[o+1]:void 0;if(i&&i.entries.length>oe.NodeCapacity>>>1){let c=i.entries.shift();r.entries.push(c),this.updatePartition(o+1,t,n-1,this.keyFromEntry(i.entries[0]));return}let u=o>0?a.nodes[o-1]:void 0;if(u&&u.entries.length>oe.NodeCapacity>>>1){let c=u.entries.pop();r.entries.unshift(c),this.updatePartition(o,t,n-1,this.keyFromEntry(c)),t.leafIndex+=1;return}if(i&&i.entries.length+r.entries.length<=oe.NodeCapacity)return r.entries.push(...i.entries),a.partitions.splice(o,1),a.nodes.splice(o+1,1),o===0&&this.updatePartition(o,t,n-1,this.keyFromEntry(r.entries[0])),this.rebalanceBranch(t,n-1);if(u&&u.entries.length+r.entries.length<=oe.NodeCapacity)return u.entries.push(...r.entries),a.partitions.splice(o-1,1),a.nodes.splice(o,1),t.leafNode=u,t.leafIndex+=u.entries.length,this.rebalanceBranch(t,n-1)}rebalanceBranch(t,n){let r=t.branches[n],s=r.node;if(n===0&&s.partitions.length===0)return t.branches[n+1]?.node??t.leafNode;if(n===0||s.nodes.length>=oe.NodeCapacity<<1)return;let o=t.branches.at(n-1),a=o.index,i=o.node,u=a<i.nodes.length?i.nodes[a+1]:void 0;if(u&&u.nodes.length>oe.NodeCapacity>>>1){s.partitions.push(i.partitions[a]);let d=u.nodes.shift();s.nodes.push(d);let l=u.partitions.shift();this.updatePartition(a+1,t,n-1,l);return}let c=a>0?i.nodes[a-1]:void 0;if(c&&c.nodes.length>oe.NodeCapacity>>>1){s.partitions.unshift(i.partitions[a-1]);let d=c.nodes.pop();s.nodes.unshift(d);let l=c.partitions.pop();r.index+=1,this.updatePartition(a,t,n-1,l);return}if(u&&u.nodes.length+s.nodes.length<=oe.NodeCapacity){let d=i.partitions.splice(a,1)[0];return s.partitions.push(d),s.partitions.push(...u.partitions),s.nodes.push(...u.nodes),i.nodes.splice(a+1,1),a===0&&i.partitions.length>0&&this.updatePartition(a,t,n-1,i.partitions[0]),this.rebalanceBranch(t,n-1)}if(c&&c.nodes.length+s.nodes.length<=oe.NodeCapacity){let d=i.partitions.splice(a-1,1)[0];return c.partitions.push(d),c.partitions.push(...s.partitions),c.nodes.push(...s.nodes),i.nodes.splice(a,1),r.node=c,r.index+=c.nodes.length,this.rebalanceBranch(t,n-1)}}updatePartition(t,n,r,s){let o=n.branches[r];t>0?o.node.partitions[t-1]=s:r!==0&&this.updatePartition(n.branches[r-1].index,n,r-1,s)}validatePath(t){if(!this.isValid(t))throw new Error("Path is invalid due to mutation of the tree")}};oe.BTree=Bo;var us=class{key;right;indexDelta;constructor(t,n,r){this.key=t,this.right=n,this.indexDelta=r}}});var yu=ar(An=>{"use strict";Object.defineProperty(An,"__esModule",{value:!0});An.KeyRange=An.KeyBound=void 0;var Vo=class{key;inclusive;constructor(t,n=!0){this.key=t,this.inclusive=n}};An.KeyBound=Vo;var Ko=class{first;last;isAscending;constructor(t,n,r=!0){this.first=t,this.last=n,this.isAscending=r}};An.KeyRange=Ko});var wu=ar(Tn=>{"use strict";Object.defineProperty(Tn,"__esModule",{value:!0});Tn.Path=Tn.PathBranch=void 0;var Go=class e{node;index;constructor(t,n){this.node=t,this.index=n}clone(){return new e(this.node,this.index)}};Tn.PathBranch=Go;var qo=class e{branches;leafNode;leafIndex;on;version;constructor(t,n,r,s,o){this.branches=t,this.leafNode=n,this.leafIndex=r,this.on=s,this.version=o}isEqual(t){return this.leafNode===t.leafNode&&this.leafIndex===t.leafIndex&&this.on===t.on&&this.version===t.version}clone(){return new e(this.branches.map(t=>t.clone()),this.leafNode,this.leafIndex,this.on,this.version)}};Tn.Path=qo});var _o=ar(Nt=>{"use strict";var gm=Nt&&Nt.__createBinding||(Object.create?function(e,t,n,r){r===void 0&&(r=n);var s=Object.getOwnPropertyDescriptor(t,n);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,s)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]}),jo=Nt&&Nt.__exportStar||function(e,t){for(var n in e)n!=="default"&&!Object.prototype.hasOwnProperty.call(t,n)&&gm(t,e,n)};Object.defineProperty(Nt,"__esModule",{value:!0});jo(Eu(),Nt);jo(yu(),Nt);jo(wu(),Nt)});var iy={};Oo(iy,{Compiler:()=>Sn,ConflictResolution:()=>W,ConstraintError:()=>pt,Database:()=>Lo,FunctionContext:()=>yt,Latches:()=>wt,Lexer:()=>bn,MemoryTableModule:()=>Pt,MisuseError:()=>x,Opcode:()=>f,ParseError:()=>gt,Parser:()=>Be,SchemaManager:()=>On,SqlDataType:()=>R,SqliteError:()=>b,Statement:()=>Ln,StatusCode:()=>w,TokenType:()=>m,Vdbe:()=>vn,VirtualTable:()=>Xe,VirtualTableCursor:()=>Je,createInstruction:()=>Nn});var w;(function(e){e[e.OK=0]="OK",e[e.ERROR=1]="ERROR",e[e.INTERNAL=2]="INTERNAL",e[e.PERM=3]="PERM",e[e.ABORT=4]="ABORT",e[e.BUSY=5]="BUSY",e[e.LOCKED=6]="LOCKED",e[e.NOMEM=7]="NOMEM",e[e.READONLY=8]="READONLY",e[e.INTERRUPT=9]="INTERRUPT",e[e.IOERR=10]="IOERR",e[e.CORRUPT=11]="CORRUPT",e[e.NOTFOUND=12]="NOTFOUND",e[e.FULL=13]="FULL",e[e.CANTOPEN=14]="CANTOPEN",e[e.PROTOCOL=15]="PROTOCOL",e[e.EMPTY=16]="EMPTY",e[e.SCHEMA=17]="SCHEMA",e[e.TOOBIG=18]="TOOBIG",e[e.CONSTRAINT=19]="CONSTRAINT",e[e.MISMATCH=20]="MISMATCH",e[e.MISUSE=21]="MISUSE",e[e.NOLFS=22]="NOLFS",e[e.AUTH=23]="AUTH",e[e.FORMAT=24]="FORMAT",e[e.RANGE=25]="RANGE",e[e.NOTADB=26]="NOTADB",e[e.NOTICE=27]="NOTICE",e[e.WARNING=28]="WARNING",e[e.ROW=100]="ROW",e[e.DONE=101]="DONE"})(w||(w={}));var R;(function(e){e[e.INTEGER=1]="INTEGER",e[e.REAL=2]="REAL",e[e.TEXT=3]="TEXT",e[e.BLOB=4]="BLOB",e[e.NULL=5]="NULL",e[e.NUMERIC=6]="NUMERIC"})(R||(R={}));var f;(function(e){e[e.Init=1]="Init",e[e.Goto=2]="Goto",e[e.Halt=0]="Halt",e[e.Noop=145]="Noop",e[e.Null=11]="Null",e[e.Integer=6]="Integer",e[e.Int64=118]="Int64",e[e.String8=119]="String8",e[e.Real=117]="Real",e[e.Blob=40]="Blob",e[e.ZeroBlob=146]="ZeroBlob",e[e.SCopy=9]="SCopy",e[e.Move=12]="Move",e[e.Clear=10]="Clear",e[e.IfTrue=15]="IfTrue",e[e.IfFalse=16]="IfFalse",e[e.IfZero=93]="IfZero",e[e.IfNull=17]="IfNull",e[e.IfNotNull=18]="IfNotNull",e[e.IsNull=8]="IsNull",e[e.NotNull=19]="NotNull",e[e.Eq=76]="Eq",e[e.Ne=75]="Ne",e[e.Lt=77]="Lt",e[e.Le=78]="Le",e[e.Gt=79]="Gt",e[e.Ge=80]="Ge",e[e.Once=14]="Once",e[e.IfPos=97]="IfPos",e[e.IfNeg=98]="IfNeg",e[e.Add=67]="Add",e[e.Subtract=68]="Subtract",e[e.Multiply=69]="Multiply",e[e.Divide=70]="Divide",e[e.Remainder=71]="Remainder",e[e.Concat=72]="Concat",e[e.Negative=73]="Negative",e[e.BitAnd=74]="BitAnd",e[e.BitOr=84]="BitOr",e[e.ShiftLeft=85]="ShiftLeft",e[e.ShiftRight=86]="ShiftRight",e[e.BitNot=87]="BitNot",e[e.Not=88]="Not",e[e.Affinity=91]="Affinity",e[e.OpenEphemeral=5]="OpenEphemeral",e[e.Rewind=7]="Rewind",e[e.MakeRecord=83]="MakeRecord",e[e.IdxInsert=123]="IdxInsert",e[e.Function=108]="Function",e[e.OpenRead=58]="OpenRead",e[e.OpenWrite=59]="OpenWrite",e[e.Close=57]="Close",e[e.VFilter=166]="VFilter",e[e.VNext=167]="VNext",e[e.VColumn=192]="VColumn",e[e.VUpdate=168]="VUpdate",e[e.VRowid=169]="VRowid",e[e.VBegin=170]="VBegin",e[e.VCommit=171]="VCommit",e[e.VRollback=172]="VRollback",e[e.VSync=173]="VSync",e[e.VSavepoint=174]="VSavepoint",e[e.VRelease=175]="VRelease",e[e.VRollbackTo=176]="VRollbackTo",e[e.ResultRow=81]="ResultRow",e[e.Sort=130]="Sort",e[e.Sorted=115]="Sorted",e[e.Subroutine=133]="Subroutine",e[e.Return=134]="Return",e[e.FrameEnter=135]="FrameEnter",e[e.FrameLeave=136]="FrameLeave",e[e.Push=131]="Push",e[e.StackPop=132]="StackPop",e[e.AggStep=109]="AggStep",e[e.AggFinal=110]="AggFinal",e[e.AggIterate=126]="AggIterate",e[e.AggNext=127]="AggNext",e[e.AggKey=128]="AggKey",e[e.AggContext=129]="AggContext",e[e.AggGroupValue=140]="AggGroupValue",e[e.AggReset=147]="AggReset",e[e.CollSeq=120]="CollSeq",e[e.OpenPseudo=121]="OpenPseudo",e[e.Next=124]="Next",e[e.VerifyCookie=107]="VerifyCookie",e[e.Savepoint=141]="Savepoint"})(f||(f={}));var T;(function(e){e[e.UTF8=1]="UTF8",e[e.DETERMINISTIC=2048]="DETERMINISTIC",e[e.DIRECTONLY=524288]="DIRECTONLY",e[e.INNOCUOUS=2097152]="INNOCUOUS"})(T||(T={}));var wl;(function(e){e[e.CONSTRAINT_SUPPORT=1]="CONSTRAINT_SUPPORT",e[e.INNOCUOUS=2]="INNOCUOUS",e[e.DIRECTONLY=3]="DIRECTONLY",e[e.USES_ALL_SCHEMAS=4]="USES_ALL_SCHEMAS"})(wl||(wl={}));var F;(function(e){e[e.EQ=2]="EQ",e[e.GT=4]="GT",e[e.LE=8]="LE",e[e.LT=16]="LT",e[e.GE=32]="GE",e[e.MATCH=64]="MATCH",e[e.LIKE=65]="LIKE",e[e.GLOB=66]="GLOB",e[e.REGEXP=67]="REGEXP",e[e.NE=68]="NE",e[e.ISNOT=69]="ISNOT",e[e.ISNOTNULL=70]="ISNOTNULL",e[e.ISNULL=71]="ISNULL",e[e.IS=72]="IS",e[e.LIMIT=73]="LIMIT",e[e.OFFSET=74]="OFFSET",e[e.FUNCTION=150]="FUNCTION"})(F||(F={}));var W;(function(e){e[e.ROLLBACK=1]="ROLLBACK",e[e.ABORT=4]="ABORT",e[e.FAIL=3]="FAIL",e[e.IGNORE=2]="IGNORE",e[e.REPLACE=5]="REPLACE"})(W||(W={}));var Il;(function(e){e[e.DELETE=9]="DELETE",e[e.INSERT=18]="INSERT",e[e.UPDATE=23]="UPDATE"})(Il||(Il={}));var b=class e extends Error{code;cause;line;column;constructor(t,n=w.ERROR,r,s,o){super(t),this.code=n,this.name="SqliteError",this.cause=r,this.line=s,this.column=o,s!==void 0&&o!==void 0&&(this.message=`${t} (at line ${s}, column ${o})`),Error.captureStackTrace&&Error.captureStackTrace(this,e)}},Zr=class extends b{token;constructor(t,n){super(t,w.ERROR,void 0,n.startLine,n.startColumn),this.token=n,this.name="ParseError"}},pt=class extends b{constructor(t,n=w.CONSTRAINT){super(t,n),this.name="ConstraintError"}};var x=class e extends b{constructor(t="API misuse"){super(t,w.MISUSE),this.name="MisuseError",Object.setPrototypeOf(this,e.prototype)}};var m;(function(e){e.INTEGER="INTEGER",e.FLOAT="FLOAT",e.STRING="STRING",e.IDENTIFIER="IDENTIFIER",e.BLOB="BLOB",e.SELECT="SELECT",e.FROM="FROM",e.WHERE="WHERE",e.INSERT="INSERT",e.UPDATE="UPDATE",e.DELETE="DELETE",e.CREATE="CREATE",e.DROP="DROP",e.ALTER="ALTER",e.TABLE="TABLE",e.INDEX="INDEX",e.VIEW="VIEW",e.TEMP="TEMP",e.TEMPORARY="TEMPORARY",e.VIRTUAL="VIRTUAL",e.USING="USING",e.INTO="INTO",e.NULL="NULL",e.NOT="NOT",e.AND="AND",e.OR="OR",e.IN="IN",e.LIKE="LIKE",e.BETWEEN="BETWEEN",e.IS="IS",e.AS="AS",e.DISTINCT="DISTINCT",e.GROUP="GROUP",e.BY="BY",e.HAVING="HAVING",e.ORDER="ORDER",e.ASC="ASC",e.DESC="DESC",e.LIMIT="LIMIT",e.OFFSET="OFFSET",e.UNION="UNION",e.ALL="ALL",e.PRIMARY="PRIMARY",e.CONSTRAINT="CONSTRAINT",e.GENERATED="GENERATED",e.COLLATE="COLLATE",e.KEY="KEY",e.UNIQUE="UNIQUE",e.DEFAULT="DEFAULT",e.CHECK="CHECK",e.FOREIGN="FOREIGN",e.REFERENCES="REFERENCES",e.AUTOINCREMENT="AUTOINCREMENT",e.ON="ON",e.CONFLICT="CONFLICT",e.CASCADE="CASCADE",e.RESTRICT="RESTRICT",e.SET="SET",e.NO="NO",e.ACTION="ACTION",e.WITHOUT="WITHOUT",e.ROWID="ROWID",e.RENAME="RENAME",e.COLUMN="COLUMN",e.TO="TO",e.ADD="ADD",e.ALWAYS="ALWAYS",e.ABORT="ABORT",e.FAIL="FAIL",e.IGNORE="IGNORE",e.BEGIN="BEGIN",e.COMMIT="COMMIT",e.ROLLBACK="ROLLBACK",e.TRANSACTION="TRANSACTION",e.DEFERRED="DEFERRED",e.IMMEDIATE="IMMEDIATE",e.EXCLUSIVE="EXCLUSIVE",e.JOIN="JOIN",e.INNER="INNER",e.LEFT="LEFT",e.RIGHT="RIGHT",e.FULL="FULL",e.CROSS="CROSS",e.OUTER="OUTER",e.NATURAL="NATURAL",e.REPLACE="REPLACE",e.VALUES="VALUES",e.EXISTS="EXISTS",e.IF="IF",e.DEFERRABLE="DEFERRABLE",e.INITIALLY="INITIALLY",e.STORED="STORED",e.SAVEPOINT="SAVEPOINT",e.RELEASE="RELEASE",e.PRAGMA="PRAGMA",e.PLUS="PLUS",e.MINUS="MINUS",e.ASTERISK="ASTERISK",e.SLASH="SLASH",e.PERCENT="PERCENT",e.EQUAL="EQUAL",e.EQUAL_EQUAL="EQUAL_EQUAL",e.NOT_EQUAL="NOT_EQUAL",e.LESS="LESS",e.LESS_EQUAL="LESS_EQUAL",e.GREATER="GREATER",e.GREATER_EQUAL="GREATER_EQUAL",e.LPAREN="LPAREN",e.RPAREN="RPAREN",e.COMMA="COMMA",e.DOT="DOT",e.SEMICOLON="SEMICOLON",e.TILDE="TILDE",e.PIPE="PIPE",e.PIPE_PIPE="PIPE_PIPE",e.AMPERSAND="AMPERSAND",e.AMPERSAND_AMPERSAND="AMPERSAND_AMPERSAND",e.QUESTION="QUESTION",e.COLON="COLON",e.DOLLAR="DOLLAR",e.ARROW="ARROW",e.EOF="EOF",e.ERROR="ERROR"})(m||(m={}));var qh={select:m.SELECT,from:m.FROM,where:m.WHERE,insert:m.INSERT,update:m.UPDATE,delete:m.DELETE,create:m.CREATE,drop:m.DROP,alter:m.ALTER,table:m.TABLE,index:m.INDEX,view:m.VIEW,virtual:m.VIRTUAL,using:m.USING,null:m.NULL,not:m.NOT,and:m.AND,or:m.OR,in:m.IN,like:m.LIKE,between:m.BETWEEN,is:m.IS,as:m.AS,distinct:m.DISTINCT,group:m.GROUP,by:m.BY,having:m.HAVING,order:m.ORDER,asc:m.ASC,desc:m.DESC,limit:m.LIMIT,offset:m.OFFSET,union:m.UNION,all:m.ALL,primary:m.PRIMARY,key:m.KEY,unique:m.UNIQUE,default:m.DEFAULT,check:m.CHECK,foreign:m.FOREIGN,references:m.REFERENCES,on:m.ON,conflict:m.CONFLICT,cascade:m.CASCADE,restrict:m.RESTRICT,set:m.SET,autoincrement:m.AUTOINCREMENT,no:m.NO,action:m.ACTION,without:m.WITHOUT,rowid:m.ROWID,begin:m.BEGIN,commit:m.COMMIT,rollback:m.ROLLBACK,transaction:m.TRANSACTION,deferred:m.DEFERRED,immediate:m.IMMEDIATE,exclusive:m.EXCLUSIVE,deferrable:m.DEFERRABLE,initially:m.INITIALLY,stored:m.STORED,join:m.JOIN,inner:m.INNER,left:m.LEFT,right:m.RIGHT,full:m.FULL,cross:m.CROSS,outer:m.OUTER,natural:m.NATURAL,replace:m.REPLACE,values:m.VALUES,exists:m.EXISTS,if:m.IF,into:m.INTO,temp:m.TEMP,temporary:m.TEMPORARY,rename:m.RENAME,to:m.TO,add:m.ADD,always:m.ALWAYS,abort:m.ABORT,fail:m.FAIL,ignore:m.IGNORE,savepoint:m.SAVEPOINT,release:m.RELEASE,pragma:m.PRAGMA},bn=class{source;tokens=[];start=0;current=0;line=1;column=1;startLine=1;startColumn=1;constructor(t){this.source=t}scanTokens(){for(;!this.isAtEnd();)this.start=this.current,this.startLine=this.line,this.startColumn=this.column,this.scanToken();return this.tokens.push({type:m.EOF,lexeme:"",startLine:this.line,startColumn:this.column,startOffset:this.source.length,endLine:this.line,endColumn:this.column,endOffset:this.source.length}),this.tokens}isAtEnd(){return this.current>=this.source.length}scanToken(){let t=this.advance();switch(t){case"(":this.addToken(m.LPAREN);break;case")":this.addToken(m.RPAREN);break;case",":this.addToken(m.COMMA);break;case".":this.addToken(m.DOT);break;case";":this.addToken(m.SEMICOLON);break;case"+":this.addToken(m.PLUS);break;case"-":this.match(">")?this.addToken(m.ARROW):this.addToken(m.MINUS);break;case"*":this.addToken(m.ASTERISK);break;case"/":if(this.match("/"))for(;this.peek()!==`
`&&!this.isAtEnd();)this.advance();else this.match("*")?this.multilineComment():this.addToken(m.SLASH);break;case"%":this.addToken(m.PERCENT);break;case"~":this.addToken(m.TILDE);break;case"?":this.addToken(m.QUESTION);break;case":":this.addToken(m.COLON);break;case"$":this.addToken(m.DOLLAR);break;case"=":this.addToken(this.match("=")?m.EQUAL_EQUAL:m.EQUAL);break;case"!":this.addToken(this.match("=")?m.NOT_EQUAL:m.ERROR);break;case"<":this.match("=")?this.addToken(m.LESS_EQUAL):this.match(">")?this.addToken(m.NOT_EQUAL):this.addToken(m.LESS);break;case">":this.addToken(this.match("=")?m.GREATER_EQUAL:m.GREATER);break;case"|":this.addToken(this.match("|")?m.PIPE_PIPE:m.PIPE);break;case"&":this.addToken(this.match("&")?m.AMPERSAND_AMPERSAND:m.AMPERSAND);break;case"'":this.string("'");break;case'"':this.string('"');break;case"`":this.backtickIdentifier();break;case"[":this.bracketIdentifier();break;case"x":case"X":this.match("'")?this.blobLiteral():this.identifier();break;case" ":case"\r":case"	":break;case`
`:this.line++,this.column=1;break;default:this.isDigit(t)?this.number():this.isAlpha(t)?this.identifier():this.addErrorToken(`Unexpected character: ${t}`);break}}advance(){let t=this.source.charAt(this.current);return this.current++,t===`
`?(this.line++,this.column=1):this.column++,t}match(t){return this.isAtEnd()||this.source.charAt(this.current)!==t?!1:(this.current++,this.column++,!0)}peek(){return this.isAtEnd()?"\0":this.source.charAt(this.current)}peekNext(){return this.current+1>=this.source.length?"\0":this.source.charAt(this.current+1)}string(t){let n="",r=!1;for(;!this.isAtEnd()&&this.peek()!==t||r;){if(this.peek()===`
`&&(this.line++,this.column=1),r){let s=this.peek();switch(s){case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"\\":n+="\\";break;case"'":n+="'";break;case'"':n+='"';break;case"0":n+="\0";break;default:n+=s;break}r=!1}else this.peek()==="\\"?r=!0:n+=this.peek();this.advance()}if(this.isAtEnd()){this.addErrorToken("Unterminated string.");return}if(this.advance(),this.peek()===t&&(this.advance(),this.string(t),this.tokens.length>0&&this.tokens[this.tokens.length-1].type===m.STRING)){let s=this.tokens.pop();n+=s.literal}this.addToken(m.STRING,n)}backtickIdentifier(){let t="";for(;!this.isAtEnd()&&this.peek()!=="`";)this.peek()===`
`&&(this.line++,this.column=1),t+=this.advance();if(this.isAtEnd()){this.addErrorToken("Unterminated identifier.");return}this.advance(),this.addToken(m.IDENTIFIER,t)}bracketIdentifier(){let t="";for(;!this.isAtEnd()&&this.peek()!=="]";)this.peek()===`
`&&(this.line++,this.column=1),t+=this.advance();if(this.isAtEnd()){this.addErrorToken("Unterminated identifier.");return}this.advance(),this.addToken(m.IDENTIFIER,t)}blobLiteral(){let t="";for(;!this.isAtEnd()&&this.peek()!=="'";)if(this.isHexDigit(this.peek()))t+=this.advance();else if(this.isWhitespace(this.peek()))this.advance();else{this.addErrorToken("Invalid character in blob literal.");return}if(this.isAtEnd()){this.addErrorToken("Unterminated blob literal.");return}if(this.advance(),t.length%2!==0){this.addErrorToken("Blob literal must have an even number of hex digits.");return}try{let n=new Uint8Array(t.length/2);for(let r=0;r<t.length;r+=2)n[r/2]=parseInt(t.substring(r,r+2),16);this.addToken(m.BLOB,n)}catch{this.addErrorToken("Invalid blob literal.")}}number(){let t=!1,n="";for(;this.isDigit(this.peek());)n+=this.advance();if(this.peek()==="."&&this.isDigit(this.peekNext()))for(t=!0,n+=this.advance();this.isDigit(this.peek());)n+=this.advance();if(this.peek().toLowerCase()==="e"){if(t=!0,n+=this.advance(),(this.peek()==="+"||this.peek()==="-")&&(n+=this.advance()),!this.isDigit(this.peek())){this.addErrorToken("Invalid number literal: expected digits after exponent.");return}for(;this.isDigit(this.peek());)n+=this.advance()}if(t)this.addToken(m.FLOAT,parseFloat(n));else{let r=parseInt(n,10);r>Number.MAX_SAFE_INTEGER||r<Number.MIN_SAFE_INTEGER?this.addToken(m.INTEGER,BigInt(n)):this.addToken(m.INTEGER,r)}}identifier(){for(;this.isAlphaNumeric(this.peek());)this.advance();let t=this.source.substring(this.start,this.current).toLowerCase(),n=qh[t]||m.IDENTIFIER;this.addToken(n)}multilineComment(){let t=1;for(;t>0&&!this.isAtEnd();)this.peek()==="/"&&this.peekNext()==="*"?(this.advance(),this.advance(),t++):this.peek()==="*"&&this.peekNext()==="/"?(this.advance(),this.advance(),t--):(this.peek()===`
`?(this.line++,this.column=1):this.column++,this.advance());t>0&&this.addErrorToken("Unterminated comment.")}isDigit(t){return t>="0"&&t<="9"}isHexDigit(t){return t>="0"&&t<="9"||t>="a"&&t<="f"||t>="A"&&t<="F"}isAlpha(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t==="_"}isAlphaNumeric(t){return this.isAlpha(t)||this.isDigit(t)}isWhitespace(t){return t===" "||t==="\r"||t===`
`||t==="	"}addToken(t,n){let r=this.source.substring(this.start,this.current);this.tokens.push({type:t,lexeme:r,literal:n,startLine:this.startLine,startColumn:this.startColumn,startOffset:this.start,endLine:this.line,endColumn:this.column-1,endOffset:this.current})}addErrorToken(t){this.tokens.push({type:m.ERROR,lexeme:t,startLine:this.line,startColumn:this.column-1,startOffset:this.current-1,endLine:this.line,endColumn:this.column-1,endOffset:this.current})}};var gt=class extends Error{token;constructor(t,n){super(n),this.token=t,this.name="ParseError"}};function k(e,t){return{start:{line:e.startLine,column:e.startColumn,offset:e.startOffset},end:{line:t.endLine,column:t.endColumn,offset:t.endOffset}}}var Be=class{tokens=[];current=0;parameterPosition=1;initialize(t){let n=new bn(t);this.tokens=n.scanTokens(),this.current=0,this.parameterPosition=1;let r=this.tokens.find(s=>s.type===m.ERROR);if(r)throw new gt(r,`${r.lexeme} at line ${r.startLine}, column ${r.startColumn}`);return this}parse(t){this.initialize(t);try{let n=this.tryParseWithClause(),r=this.peek(),s=this.statement(r);if(n&&"withClause"in s)s.withClause=n,n.loc&&s.loc&&(s.loc.start=n.loc.start);else if(n)throw this.error(this.previous(),`WITH clause cannot be used with ${s.type} statement.`);if(this.match(m.SEMICOLON),!this.isAtEnd())throw this.error(this.peek(),`Unexpected token after end of statement: ${this.peek().lexeme}`);return s}catch(n){if(n instanceof gt){if(!n.message.includes(`at line ${n.token.startLine}`)){let r=` at line ${n.token.startLine}, column ${n.token.startColumn}`;n.message=n.message+r}throw n}throw console.error("Unhandled parser error:",n),new Error(`Parser error: ${n instanceof Error?n.message:n}`)}}tryParseWithClause(){if(!this.check(m.IDENTIFIER)||this.peek().lexeme.toUpperCase()!=="WITH")return;let t=this.advance(),n=this.matchKeyword("RECURSIVE"),r=[];do r.push(this.commonTableExpression());while(this.match(m.COMMA));let s=this.previous();return{type:"withClause",recursive:n,ctes:r,loc:k(t,s)}}commonTableExpression(){let t=this.peek(),n=this.consumeIdentifier("Expected CTE name."),r=this.previous(),s;if(this.match(m.LPAREN)){if(s=[],!this.check(m.RPAREN))do s.push(this.consumeIdentifier("Expected column name in CTE definition."));while(this.match(m.COMMA));r=this.consume(m.RPAREN,"Expected ')' after CTE column list.")}this.consume(m.AS,"Expected 'AS' after CTE name."),this.consume(m.LPAREN,"Expected '(' before CTE query.");let o=this.peek(),a;if(this.check(m.SELECT))a=this.selectStatement(o);else if(this.check(m.INSERT))a=this.insertStatement(o);else if(this.check(m.UPDATE))a=this.updateStatement(o);else if(this.check(m.DELETE))a=this.deleteStatement(o);else throw this.error(this.peek(),"Expected SELECT, INSERT, UPDATE, or DELETE statement for CTE query.");return r=this.consume(m.RPAREN,"Expected ')' after CTE query."),{type:"commonTableExpr",name:n,columns:s,query:a,loc:k(t,r)}}statement(t){switch(t.lexeme.toUpperCase()){case"SELECT":return this.advance(),this.selectStatement(t);case"INSERT":return this.advance(),this.insertStatement(t);case"UPDATE":return this.advance(),this.updateStatement(t);case"DELETE":return this.advance(),this.deleteStatement(t);case"CREATE":return this.advance(),this.createStatement(t);case"DROP":return this.advance(),this.dropStatement(t);case"ALTER":return this.advance(),this.alterTableStatement(t);case"BEGIN":return this.advance(),this.beginStatement(t);case"COMMIT":return this.advance(),this.commitStatement(t);case"ROLLBACK":return this.advance(),this.rollbackStatement(t);case"SAVEPOINT":return this.advance(),this.savepointStatement(t);case"RELEASE":return this.advance(),this.releaseStatement(t);case"PRAGMA":return this.advance(),this.pragmaStatement(t);default:throw this.error(t,`Expected statement type (SELECT, INSERT, UPDATE, DELETE, CREATE, etc.), got '${t.lexeme}'.`)}}insertStatement(t){this.matchKeyword("INTO");let n=this.tableIdentifier(),r;if(this.match(m.LPAREN)){r=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name.");r.push(this.advance().lexeme)}while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after column list.")}let s,o,a=this.previous();if(this.match(m.VALUES)){s=[];do{this.consume(m.LPAREN,"Expected '(' before values.");let i=[];if(!this.check(m.RPAREN))do i.push(this.expression());while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after values."),s.push(i),a=this.previous()}while(this.match(m.COMMA))}else if(this.check(m.SELECT)){let i=this.peek();o=this.selectStatement(i),a=this.previous()}else throw this.error(this.peek(),"Expected VALUES or SELECT after INSERT.");return{type:"insert",table:n,columns:r,values:s,select:o,loc:k(t,a)}}selectStatement(t){let n=t??this.previous(),r=n,s=this.matchKeyword("DISTINCT");s&&(r=this.previous());let o=!s&&this.matchKeyword("ALL");o&&(r=this.previous());let a=this.columnList();a.length>0&&(r=this.previous());let i;this.match(m.FROM)&&(i=this.tableSourceList(),i.length>0&&(r=this.previous()));let u;this.match(m.WHERE)&&(u=this.expression(),r=this.previous());let c;if(this.match(m.GROUP)&&this.consume(m.BY,"Expected 'BY' after 'GROUP'.")){c=[];do c.push(this.expression());while(this.match(m.COMMA));r=this.previous()}let d;this.match(m.HAVING)&&(d=this.expression(),r=this.previous());let l;if(this.match(m.ORDER)&&this.consume(m.BY,"Expected 'BY' after 'ORDER'.")){l=[];do{let y=this.expression(),I=this.match(m.DESC)?"desc":(this.match(m.ASC),"asc");l.push({expr:y,direction:I})}while(this.match(m.COMMA));r=this.previous()}let h,p;this.match(m.LIMIT)&&(h=this.expression(),r=this.previous(),this.match(m.OFFSET)?(p=this.expression(),r=this.previous()):this.match(m.COMMA)&&(p=h,h=this.expression(),r=this.previous()));let g,E=!1;if(this.match(m.UNION)){E=this.match(m.ALL);let y=this.peek();if(this.match(m.SELECT))g=this.selectStatement(y),r=this.previous();else throw this.error(this.peek(),"Expected 'SELECT' after 'UNION'.")}return{type:"select",columns:a,from:i,where:u,groupBy:c,having:d,orderBy:l,limit:h,offset:p,distinct:s,all:o,union:g,unionAll:E,loc:k(n,r)}}columnList(){let t=[],n=this.peek();do if(n=this.peek(),this.match(m.ASTERISK))t.push({type:"all"});else if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.DOT)&&this.checkNext(2,m.ASTERISK)){let r=this.advance().lexeme;this.advance(),this.advance(),t.push({type:"all",table:r})}else{let r=this.expression(),s,o=this.previous();if(this.match(m.AS))if(this.check(m.IDENTIFIER)||this.check(m.STRING)){let a=this.advance();s=a.lexeme,a.type===m.STRING&&(s=a.literal),o=a}else throw this.error(this.peek(),"Expected identifier or string after 'AS'.");else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.LPAREN)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isEndOfClause()){let a=this.advance();s=a.lexeme,o=a}t.push({type:"column",expr:r,alias:s})}while(this.match(m.COMMA));return t}tableIdentifier(){let t=this.peek(),n,r,s=t;if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.DOT)){if(n=this.advance().lexeme,this.advance(),!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected table name after schema.");r=this.advance().lexeme,s=this.previous()}else if(this.check(m.IDENTIFIER))r=this.advance().lexeme,s=this.previous();else throw this.error(this.peek(),"Expected table name.");return{type:"identifier",name:r,schema:n,loc:k(t,s)}}tableSourceList(){let t=[];do{let n=this.tableSource();for(;this.isJoinToken();)n=this.joinClause(n);t.push(n)}while(this.match(m.COMMA));return t}tableSource(){let t=this.peek();return this.check(m.IDENTIFIER)&&this.checkNext(1,m.LPAREN)?this.functionSource(t):this.standardTableSource(t)}standardTableSource(t){let n=this.tableIdentifier(),r=this.previous(),s;if(this.match(m.AS)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected alias after 'AS'.");let o=this.advance();s=o.lexeme,r=o}else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isJoinToken()&&!this.isEndOfClause()){let o=this.advance();s=o.lexeme,r=o}return{type:"table",table:n,alias:s,loc:k(t,r)}}functionSource(t){let n=this.tableIdentifier(),r=this.previous();this.consume(m.LPAREN,"Expected '(' after table function name.");let s=[],o=this.previous();if(!this.check(m.RPAREN))do s.push(this.expression()),o=this.previous();while(this.match(m.COMMA));r=this.consume(m.RPAREN,"Expected ')' after table function arguments.");let a;if(this.match(m.AS)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected alias after 'AS'.");let i=this.advance();a=i.lexeme,r=i}else if(this.check(m.IDENTIFIER)&&!this.checkNext(1,m.DOT)&&!this.checkNext(1,m.COMMA)&&!this.isJoinToken()&&!this.isEndOfClause()){let i=this.advance();a=i.lexeme,r=i}return{type:"functionSource",name:n,args:s,alias:a,loc:k(t,r)}}joinClause(t){let n=this.peek(),r="inner";this.match(m.LEFT)?(this.match(m.OUTER),r="left"):this.match(m.RIGHT)?(this.match(m.OUTER),r="right"):this.match(m.FULL)?(this.match(m.OUTER),r="full"):this.match(m.CROSS)?r="cross":this.match(m.INNER)&&(r="inner"),this.consume(m.JOIN,"Expected 'JOIN'.");let s=this.tableSource(),o,a,i=this.previous();if(this.match(m.ON))o=this.expression(),i=this.previous();else if(this.match(m.USING)){this.consume(m.LPAREN,"Expected '(' after 'USING'."),a=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name.");a.push(this.advance().lexeme)}while(this.match(m.COMMA));i=this.consume(m.RPAREN,"Expected ')' after columns.")}else if(r!=="cross")throw this.error(this.peek(),"Expected 'ON' or 'USING' after JOIN.");return{type:"join",joinType:r,left:t,right:s,condition:o,columns:a,loc:k(n,i)}}expression(){return this.logicalOr()}logicalOr(){let t=this.logicalAnd();for(;this.match(m.OR);){let n="OR",r=this.logicalAnd();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}logicalAnd(){let t=this.equality();for(;this.match(m.AND);){let n="AND",r=this.equality();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}equality(){let t=this.comparison();for(;this.match(m.EQUAL,m.EQUAL_EQUAL,m.NOT_EQUAL);){let n=this.previous().type===m.NOT_EQUAL?"!=":"=",r=this.comparison();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}comparison(){let t=this.term();for(;this.match(m.LESS,m.LESS_EQUAL,m.GREATER,m.GREATER_EQUAL);){let n;switch(this.previous().type){case m.LESS:n="<";break;case m.LESS_EQUAL:n="<=";break;case m.GREATER:n=">";break;case m.GREATER_EQUAL:n=">=";break;default:n="?"}let r=this.term();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}term(){let t=this.factor();for(;this.match(m.PLUS,m.MINUS);){let n=this.previous().type===m.PLUS?"+":"-",r=this.factor();t={type:"binary",operator:n,left:t,right:r,loc:k(this.peek(),this.previous())}}return t}factor(){if(this.match(m.MINUS,m.PLUS,m.TILDE)){let r=this.previous().lexeme,s=this.factor();return{type:"unary",operator:r,expr:s,loc:k(this.peek(),this.previous())}}let t=this.collateExpression();for(;this.match(m.ASTERISK,m.SLASH,m.PERCENT);){let r=this.previous().lexeme,s=this.collateExpression();t={type:"binary",operator:r,left:t,right:s,loc:k(this.peek(),this.previous())}}return t}primary(){let t=this.peek();if(this.match(m.INTEGER,m.FLOAT,m.STRING,m.NULL,m.BLOB)){let n=this.previous(),r=n.literal;return n.type===m.NULL&&(r=null),{type:"literal",value:r,loc:k(t,n)}}if(this.match(m.QUESTION)){let n=this.previous();return{type:"parameter",index:this.parameterPosition++,loc:k(t,n)}}if(this.match(m.COLON,m.DOLLAR)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected identifier after parameter prefix.");let n=this.advance();return{type:"parameter",name:n.lexeme,loc:k(t,n)}}if(this.check(m.IDENTIFIER)&&this.checkNext(1,m.LPAREN)){let n=this.advance();this.consume(m.LPAREN,"Expected '(' after function name.");let r=[];if(!this.check(m.RPAREN))do this.match(m.ASTERISK)?r.push({type:"literal",value:"*",loc:k(this.peek(),this.peek())}):r.push(this.expression());while(this.match(m.COMMA));return this.consume(m.RPAREN,"Expected ')' after function arguments."),{type:"function",name:n.lexeme,args:r,isAggregate:!1,loc:k(t,this.previous())}}if(this.check(m.IDENTIFIER))if(this.checkNext(1,m.DOT)&&this.checkNext(2,m.IDENTIFIER)&&this.checkNext(3,m.DOT)&&this.checkNext(4,m.IDENTIFIER)){let n=this.advance().lexeme;this.advance();let r=this.advance().lexeme;this.advance();let s=this.advance();return{type:"column",name:s.lexeme,table:r,schema:n,loc:k(t,s)}}else if(this.checkNext(1,m.DOT)&&this.checkNext(2,m.IDENTIFIER)){let n=this.advance().lexeme;this.advance();let r=this.advance();return{type:"column",name:r.lexeme,table:n,loc:k(t,r)}}else{let n=this.advance();return{type:"column",name:n.lexeme,loc:k(t,n)}}if(this.match(m.LPAREN)){let n=this.expression();return this.consume(m.RPAREN,"Expected ')' after expression."),n}throw this.error(this.peek(),"Expected expression.")}match(...t){for(let n of t)if(this.check(n))return this.advance(),!0;return!1}consume(t,n){if(this.check(t))return this.advance();throw this.error(this.peek(),n)}check(t){return this.isAtEnd()?!1:this.peek().type===t}checkNext(t,n){return this.current+t>=this.tokens.length?!1:this.tokens[this.current+t].type===n}advance(){return this.isAtEnd()||this.current++,this.previous()}isAtEnd(){return this.peek().type===m.EOF}peek(){return this.tokens[this.current]}previous(){return this.tokens[this.current-1]}error(t,n){let r=` at line ${t.startLine}, column ${t.startColumn}`;return new gt(t,n+r)}isJoinToken(){return this.check(m.JOIN)||this.check(m.INNER)||this.check(m.LEFT)||this.check(m.RIGHT)||this.check(m.FULL)||this.check(m.CROSS)}isEndOfClause(){let t=this.peek().type;return t===m.FROM||t===m.WHERE||t===m.GROUP||t===m.HAVING||t===m.ORDER||t===m.LIMIT||t===m.UNION||t===m.SEMICOLON||t===m.EOF}updateStatement(t){let n=this.tableIdentifier();this.consume(m.SET,"Expected 'SET' after table name in UPDATE.");let r=[];do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name in SET clause.");let a=this.advance().lexeme;this.consume(m.EQUAL,"Expected '=' after column name in SET clause.");let i=this.expression();r.push({column:a,value:i})}while(this.match(m.COMMA));let s;this.match(m.WHERE)&&(s=this.expression());let o=this.previous();return{type:"update",table:n,assignments:r,where:s,loc:k(t,o)}}deleteStatement(t){this.matchKeyword("FROM");let n=this.tableIdentifier(),r;this.match(m.WHERE)&&(r=this.expression());let s=this.previous();return{type:"delete",table:n,where:r,loc:k(t,s)}}createStatement(t){if(this.peekKeyword("TABLE"))return this.consumeKeyword("TABLE","Expected 'TABLE' after CREATE."),this.createTableStatement(t);if(this.peekKeyword("INDEX"))return this.consumeKeyword("INDEX","Expected 'INDEX' after CREATE."),this.createIndexStatement(t);if(this.peekKeyword("VIEW"))return this.consumeKeyword("VIEW","Expected 'VIEW' after CREATE."),this.createViewStatement(t);if(this.peekKeyword("UNIQUE"))return this.consumeKeyword("UNIQUE","Expected 'UNIQUE' after CREATE."),this.consumeKeyword("INDEX","Expected 'INDEX' after CREATE UNIQUE."),this.createIndexStatement(t,!0);throw this.error(this.peek(),"Expected TABLE, [UNIQUE] INDEX, VIEW, or VIRTUAL after CREATE.")}createTableStatement(t){let n=!1;(this.peekKeyword("TEMP")||this.peekKeyword("TEMPORARY"))&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier(),o=[],a=[],i=!1;if(this.check(m.LPAREN)){this.consume(m.LPAREN,"Expected '(' to start table definition.");do this.peekKeyword("PRIMARY")||this.peekKeyword("UNIQUE")||this.peekKeyword("CHECK")||this.peekKeyword("FOREIGN")||this.peekKeyword("CONSTRAINT")?a.push(this.tableConstraint()):o.push(this.columnDefinition());while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after table definition."),this.matchKeyword("WITHOUT")&&(this.consumeKeyword("ROWID","Expected 'ROWID' after 'WITHOUT'."),i=!0)}else if(this.matchKeyword("AS")){let u=this.selectStatement();throw new Error("CREATE TABLE AS SELECT is not fully implemented.")}else throw this.error(this.peek(),"Expected '(' or 'AS' after table name.");return{type:"createTable",table:s,ifNotExists:r,columns:o,constraints:a,withoutRowid:i,isTemporary:n,loc:k(t,this.previous())}}createIndexStatement(t,n=!1){!n&&this.peekKeyword("UNIQUE")&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier();this.consumeKeyword("ON","Expected 'ON' after index name.");let o=this.tableIdentifier();this.consume(m.LPAREN,"Expected '(' before indexed columns.");let a=this.indexedColumnList();this.consume(m.RPAREN,"Expected ')' after indexed columns.");let i;return this.matchKeyword("WHERE")&&(i=this.expression()),{type:"createIndex",index:s,table:o,ifNotExists:r,columns:a,where:i,isUnique:n,loc:k(t,this.previous())}}createViewStatement(t){let n=!1;(this.peekKeyword("TEMP")||this.peekKeyword("TEMPORARY"))&&(n=!0,this.advance());let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("NOT","Expected 'NOT' after 'IF'."),this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF NOT'."),r=!0);let s=this.tableIdentifier(),o;if(this.check(m.LPAREN)){if(this.consume(m.LPAREN,"Expected '(' to start view column list."),o=[],!this.check(m.RPAREN))do{if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected column name in view column list.");o.push(this.advance().lexeme)}while(this.match(m.COMMA));this.consume(m.RPAREN,"Expected ')' after view column list.")}this.consumeKeyword("AS","Expected 'AS' before SELECT statement for CREATE VIEW.");let a=this.selectStatement();return{type:"createView",view:s,ifNotExists:r,columns:o,select:a,isTemporary:n,loc:k(t,this.previous())}}dropStatement(t){let n;if(this.peekKeyword("TABLE"))this.consumeKeyword("TABLE","Expected TABLE after DROP."),n="table";else if(this.peekKeyword("VIEW"))this.consumeKeyword("VIEW","Expected VIEW after DROP."),n="view";else if(this.peekKeyword("INDEX"))this.consumeKeyword("INDEX","Expected INDEX after DROP."),n="index";else throw this.error(this.peek(),"Expected TABLE, VIEW, or INDEX after DROP.");let r=!1;this.matchKeyword("IF")&&(this.consumeKeyword("EXISTS","Expected 'EXISTS' after 'IF'."),r=!0);let s=this.tableIdentifier();return{type:"drop",objectType:n,name:s,ifExists:r,loc:k(t,this.previous())}}alterTableStatement(t){this.consumeKeyword("TABLE","Expected 'TABLE' after ALTER.");let n=this.tableIdentifier(),r;if(this.peekKeyword("RENAME"))if(this.consumeKeyword("RENAME","Expected RENAME."),this.matchKeyword("COLUMN")){let s=this.consumeIdentifier("Expected old column name after RENAME COLUMN.");this.consumeKeyword("TO","Expected 'TO' after old column name.");let o=this.consumeIdentifier("Expected new column name after TO.");r={type:"renameColumn",oldName:s,newName:o}}else this.consumeKeyword("TO","Expected 'TO' after RENAME."),r={type:"renameTable",newName:this.consumeIdentifier("Expected new table name after RENAME TO.")};else if(this.peekKeyword("ADD"))this.consumeKeyword("ADD","Expected ADD."),this.matchKeyword("COLUMN"),r={type:"addColumn",column:this.columnDefinition()};else if(this.peekKeyword("DROP"))this.consumeKeyword("DROP","Expected DROP."),this.matchKeyword("COLUMN"),r={type:"dropColumn",name:this.consumeIdentifier("Expected column name after DROP COLUMN.")};else throw this.error(this.peek(),"Expected RENAME, ADD, or DROP after table name in ALTER TABLE.");return{type:"alterTable",table:n,action:r,loc:k(t,this.previous())}}beginStatement(t){let n;return this.peekKeyword("DEFERRED")?(this.advance(),n="deferred"):this.peekKeyword("IMMEDIATE")?(this.advance(),n="immediate"):this.peekKeyword("EXCLUSIVE")&&(this.advance(),n="exclusive"),this.matchKeyword("TRANSACTION"),{type:"begin",mode:n,loc:k(t,this.previous())}}commitStatement(t){return this.matchKeyword("TRANSACTION"),{type:"commit",loc:k(t,this.previous())}}rollbackStatement(t){this.matchKeyword("TRANSACTION");let n;if(this.matchKeyword("TO")){if(this.matchKeyword("SAVEPOINT"),!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected savepoint name after ROLLBACK TO.");n=this.advance().lexeme}return{type:"rollback",savepoint:n,loc:k(t,this.previous())}}savepointStatement(t){return{type:"savepoint",name:this.consumeIdentifier("Expected savepoint name after SAVEPOINT."),loc:k(t,this.previous())}}releaseStatement(t){return this.matchKeyword("SAVEPOINT"),{type:"release",savepoint:this.consumeIdentifier("Expected savepoint name after RELEASE [SAVEPOINT]."),loc:k(t,this.previous())}}pragmaStatement(t){let n=this.consumeIdentifier("Expected pragma name."),r;if(this.match(m.EQUAL))if(this.check(m.IDENTIFIER))r={type:"identifier",name:this.advance().lexeme};else if(this.match(m.STRING,m.INTEGER,m.FLOAT,m.NULL)){let s=this.previous();r={type:"literal",value:s.type===m.NULL?null:s.literal}}else if(this.match(m.MINUS))if(this.check(m.INTEGER)||this.check(m.FLOAT))r={type:"literal",value:-this.advance().literal};else throw this.error(this.peek(),"Expected number after '-'.");else throw this.error(this.peek(),"Expected pragma value (identifier, string, number, or NULL).");else throw this.error(this.peek(),"Expected '=' after pragma name.");return{type:"pragma",name:n.toLowerCase(),value:r,loc:k(t,this.previous())}}indexedColumnList(){let t=[];do t.push(this.indexedColumn());while(this.match(m.COMMA));return t}indexedColumn(){let t=this.expression(),n;t.type==="column"&&!t.table&&!t.schema&&(n=t.name);let r;return this.match(m.ASC)?r="asc":this.match(m.DESC)&&(r="desc"),n?{name:n,direction:r}:{expr:t,direction:r}}consumeIdentifier(t){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),t);return this.advance().lexeme}columnDefinition(){let t=this.consumeIdentifier("Expected column name."),n;if(this.check(m.IDENTIFIER)&&(n=this.advance().lexeme,this.match(m.LPAREN))){n+="(";let s=1;for(;s>0&&!this.isAtEnd();){let o=this.peek();o.type===m.LPAREN&&s++,o.type===m.RPAREN&&s--,s>0&&(n+=this.advance().lexeme)}n+=")",this.consume(m.RPAREN,"Expected ')' after type parameters.")}let r=this.columnConstraintList();return{name:t,dataType:n,constraints:r}}columnConstraintList(){let t=[];for(;this.isColumnConstraintStart();)t.push(this.columnConstraint());return t}isColumnConstraintStart(){return this.check(m.CONSTRAINT)||this.check(m.PRIMARY)||this.check(m.NOT)||this.check(m.UNIQUE)||this.check(m.CHECK)||this.check(m.DEFAULT)||this.check(m.COLLATE)||this.check(m.REFERENCES)||this.check(m.GENERATED)}columnConstraint(){let t,n=this.peek(),r=n;if(this.match(m.CONSTRAINT)&&(t=this.consumeIdentifier("Expected constraint name after CONSTRAINT."),r=this.previous()),this.match(m.PRIMARY)){this.consume(m.KEY,"Expected KEY after PRIMARY.");let s=this.match(m.ASC)?"asc":this.match(m.DESC)?"desc":void 0;s&&(r=this.previous());let o=this.parseConflictClause();o&&(r=this.previous());let a=this.match(m.AUTOINCREMENT);return a&&(r=this.previous()),{type:"primaryKey",name:t,onConflict:o,autoincrement:a,direction:s,loc:k(n,r)}}else if(this.match(m.NOT)){this.consume(m.NULL,"Expected NULL after NOT."),r=this.previous();let s=this.parseConflictClause();return s&&(r=this.previous()),{type:"notNull",name:t,onConflict:s,loc:k(n,r)}}else if(this.match(m.UNIQUE)){r=this.previous();let s=this.parseConflictClause();return s&&(r=this.previous()),{type:"unique",name:t,onConflict:s,loc:k(n,r)}}else if(this.match(m.CHECK)){this.consume(m.LPAREN,"Expected '(' after CHECK.");let s=this.expression();return r=this.consume(m.RPAREN,"Expected ')' after CHECK expression."),{type:"check",name:t,expr:s,loc:k(n,r)}}else if(this.match(m.DEFAULT)){let s=this.expression();return r=this.previous(),{type:"default",name:t,expr:s,loc:k(n,r)}}else if(this.match(m.COLLATE)){if(!this.check(m.IDENTIFIER))throw this.error(this.peek(),"Expected collation name after COLLATE.");let s=this.advance().lexeme;return r=this.previous(),{type:"collate",name:t,collation:s,loc:k(n,r)}}else if(this.match(m.REFERENCES)){let s=this.foreignKeyClause();return r=this.previous(),{type:"foreignKey",name:t,foreignKey:s,loc:k(n,r)}}else if(this.match(m.GENERATED)){this.consume(m.ALWAYS,"Expected ALWAYS after GENERATED."),this.consume(m.AS,"Expected AS after GENERATED ALWAYS."),this.consume(m.LPAREN,"Expected '(' after AS.");let s=this.expression();this.consume(m.RPAREN,"Expected ')' after generated expression."),r=this.previous();let o=!1;return this.match(m.STORED)?(o=!0,r=this.previous()):this.match(m.VIRTUAL)&&(r=this.previous()),{type:"generated",name:t,generated:{expr:s,stored:o},loc:k(n,r)}}throw this.error(this.peek(),"Expected column constraint type (PRIMARY KEY, NOT NULL, UNIQUE, CHECK, DEFAULT, COLLATE, REFERENCES, GENERATED).")}tableConstraint(){let t;if(this.match(m.CONSTRAINT)&&(t=this.consumeIdentifier("Expected constraint name after CONSTRAINT.")),this.match(m.PRIMARY)){this.consume(m.KEY,"Expected KEY after PRIMARY."),this.consume(m.LPAREN,"Expected '(' before PRIMARY KEY columns.");let n=this.identifierListWithDirection();this.consume(m.RPAREN,"Expected ')' after PRIMARY KEY columns.");let r=this.parseConflictClause();return{type:"primaryKey",name:t,columns:n,onConflict:r}}else if(this.match(m.UNIQUE)){this.consume(m.LPAREN,"Expected '(' before UNIQUE columns.");let r=this.identifierList().map(o=>({name:o}));this.consume(m.RPAREN,"Expected ')' after UNIQUE columns.");let s=this.parseConflictClause();return{type:"unique",name:t,columns:r,onConflict:s}}else if(this.match(m.CHECK)){this.consume(m.LPAREN,"Expected '(' after CHECK.");let n=this.expression();return this.consume(m.RPAREN,"Expected ')' after CHECK expression."),{type:"check",name:t,expr:n}}else if(this.match(m.FOREIGN)){this.consume(m.KEY,"Expected KEY after FOREIGN."),this.consume(m.LPAREN,"Expected '(' before FOREIGN KEY columns.");let n=this.identifierList().map(s=>({name:s}));this.consume(m.RPAREN,"Expected ')' after FOREIGN KEY columns.");let r=this.foreignKeyClause();return{type:"foreignKey",name:t,columns:n,foreignKey:r}}throw this.error(this.peek(),"Expected table constraint type (PRIMARY KEY, UNIQUE, CHECK, FOREIGN KEY).")}foreignKeyClause(){this.consume(m.REFERENCES,"Expected REFERENCES for foreign key.");let t=this.consumeIdentifier("Expected foreign table name."),n;this.match(m.LPAREN)&&(n=this.identifierList(),this.consume(m.RPAREN,"Expected ')' after foreign columns."));let r,s,o,a;for(;this.check(m.ON)||this.check(m.DEFERRABLE)||this.check(m.NOT);)if(this.match(m.ON))if(this.match(m.DELETE))r=this.parseForeignKeyAction();else if(this.match(m.UPDATE))s=this.parseForeignKeyAction();else throw this.error(this.peek(),"Expected DELETE or UPDATE after ON.");else if(this.match(m.DEFERRABLE)){if(o=!0,this.match(m.INITIALLY))if(this.match(m.DEFERRED))a=!0;else if(this.match(m.IMMEDIATE))a=!1;else throw this.error(this.peek(),"Expected DEFERRED or IMMEDIATE after INITIALLY.")}else if(this.match(m.NOT)){if(this.consume(m.DEFERRABLE,"Expected DEFERRABLE after NOT."),o=!1,this.match(m.INITIALLY))if(this.match(m.DEFERRED))a=!0;else if(this.match(m.IMMEDIATE))a=!1;else throw this.error(this.peek(),"Expected DEFERRED or IMMEDIATE after INITIALLY.")}else break;return{table:t,columns:n,onDelete:r,onUpdate:s,deferrable:o,initiallyDeferred:a}}parseConflictClause(){if(this.match(m.ON)){if(this.consume(m.CONFLICT,"Expected CONFLICT after ON."),this.match(m.ROLLBACK))return W.ROLLBACK;if(this.match(m.ABORT))return W.ABORT;if(this.match(m.FAIL))return W.FAIL;if(this.match(m.IGNORE))return W.IGNORE;if(this.match(m.REPLACE))return W.REPLACE;throw this.error(this.peek(),"Expected conflict resolution algorithm (ROLLBACK, ABORT, FAIL, IGNORE, REPLACE).")}}parseForeignKeyAction(){if(this.match(m.SET)){if(this.match(m.NULL))return"setNull";if(this.match(m.DEFAULT))return"setDefault";throw this.error(this.peek(),"Expected NULL or DEFAULT after SET.")}else{if(this.match(m.CASCADE))return"cascade";if(this.match(m.RESTRICT))return"restrict";if(this.match(m.NO))return this.consume(m.ACTION,"Expected ACTION after NO."),"noAction"}throw this.error(this.peek(),"Expected foreign key action (SET NULL, SET DEFAULT, CASCADE, RESTRICT, NO ACTION).")}identifierList(){let t=[];do t.push(this.consumeIdentifier("Expected identifier in list."));while(this.match(m.COMMA));return t}identifierListWithDirection(){let t=[];do{let n=this.consumeIdentifier("Expected identifier in list."),r=this.match(m.ASC)?"asc":this.match(m.DESC)?"desc":void 0;t.push({name:n,direction:r})}while(this.match(m.COMMA));return t}peekKeyword(t){if(this.isAtEnd())return!1;let n=this.peek();return n.type===m.IDENTIFIER&&n.lexeme.toUpperCase()===t||n.type===m[t.toUpperCase()]}matchKeyword(t){return this.isAtEnd()?!1:this.peekKeyword(t)?(this.advance(),!0):!1}consumeKeyword(t,n){if(this.peekKeyword(t))return this.advance();throw this.error(this.peek(),n)}collateExpression(){let t=this.primary();if(this.match(m.COLLATE)){let n=this.previous(),r=this.consumeIdentifier("Expected collation name after COLLATE.");t={type:"collate",expr:t,collation:r,loc:k(this.peek(),this.previous())}}return t}};function Nn(e,t=0,n=0,r=0,s=null,o=0,a){return{opcode:e,p1:t,p2:n,p3:r,p4:s,p5:o,comment:a}}function bl(e,t){let r=e.currentFrameLocals<2?2:e.currentFrameLocals+1,s=r+t-1;e.currentFrameLocals=Math.max(e.currentFrameLocals,s),e.maxLocalOffsetInCurrentFrame=Math.max(e.maxLocalOffsetInCurrentFrame,s);let o=e.framePointer+s;return e.numMemCells=Math.max(e.numMemCells,o),r}function Nl(e){let t=e.numCursors;return e.numCursors++,t}function Cl(e,t){let n=e.constants.length;return e.constants.push(t),n}function Sl(e,t,n=0,r=0,s=0,o=null,a=0,i){let u=e.subroutineDepth>0?e.subroutineCode:e.instructions,c=Nn(t,n,r,s,o,a,i);return u.push(c),u.length-1}function Rl(e){return-((e.subroutineDepth>0?e.subroutineCode:e.instructions).length+1)}function Al(e,t){if(t>=0){console.warn(`Attempting to resolve a non-placeholder address: ${t}`);return}let n=e.subroutineDepth>0?e.subroutineCode:e.instructions,r=n.length,s=-(t+1);if(s<0||s>=n.length){console.warn(`Placeholder address ${t} corresponds to invalid index ${s} in current code block.`);return}let o=n[s],a={[f.Goto]:"p2",[f.IfTrue]:"p2",[f.IfFalse]:"p2",[f.IfZero]:"p2",[f.IfNull]:"p2",[f.IfNotNull]:"p2",[f.Eq]:"p2",[f.Ne]:"p2",[f.Lt]:"p2",[f.Le]:"p2",[f.Gt]:"p2",[f.Ge]:"p2",[f.Once]:"p2",[f.VFilter]:"p2",[f.VNext]:"p2",[f.Rewind]:"p2",[f.Subroutine]:"p2"},i=o.opcode;if(i in a){let u=a[i];u&&o[u]===t?o[u]=r:console.warn(`Instruction at index ${s} (${f[o.opcode]}) does not match placeholder ${t} for its expected address parameter (${u||"none"}).`)}else console.warn(`Opcode ${f[o.opcode]} not configured for address resolution.`)}function Tl(e){return(e.subroutineDepth>0?e.subroutineCode:e.instructions).length}function _e(e){return{name:e,affinity:R.TEXT,notNull:!1,primaryKey:!1,pkOrder:0,defaultValue:null,collation:"BINARY",hidden:!1,generated:!1}}function be(e){let t=new Map;return e.forEach((n,r)=>{t.set(n.name.toLowerCase(),r)}),t}function vl(e){let t=e.map((n,r)=>({...n,index:r})).filter(n=>n.primaryKey).sort((n,r)=>n.pkOrder-r.pkOrder);return Object.freeze(t.map(n=>({index:n.index,desc:!1})))}function Ll(e,t,n,r){let s=Array.from({length:n},(i,u)=>_e(`eph_col${u}`)),o=[];r&&(r.keyIndices.forEach((i,u)=>{i>=0&&i<s.length&&r.collations?.[u]&&(s[i].collation=r.collations[u])}),o=Object.freeze(r.keyIndices.map((i,u)=>({index:i,desc:r.directions[u]}))),o.forEach(i=>{i.index>=0&&i.index<s.length&&(s[i.index].primaryKey=!0)}));let a={name:`ephemeral_${t}`,schemaName:"temp",columns:Object.freeze(s),columnIndexMap:Object.freeze(be(s)),primaryKeyDefinition:o,isVirtual:!0};return e.tableSchemas.set(t,a),e.ephemeralTables.set(t,a),a}function Ol(e,t){t.forEach(n=>{e.emit(f.Close,n,0,0,null,0,`Close inner cursor ${n}`),e.tableSchemas.delete(n),e.ephemeralTables.delete(n),e.cursorPlanningInfo.delete(n);for(let[r,s]of e.tableAliases.entries())if(s===n){e.tableAliases.delete(r);break}})}var My=new Set(["ABORT","ACTION","ADD","AFTER","ALL","ALTER","ANALYZE","AND","AS","ASC","ATTACH","AUTOINCREMENT","BEFORE","BEGIN","BETWEEN","BY","CASCADE","CASE","CAST","CHECK","COLLATE","COLUMN","COMMIT","CONFLICT","CONSTRAINT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","DATABASE","DEFAULT","DEFERRABLE","DEFERRED","DELETE","DESC","DETACH","DISTINCT","DROP","EACH","ELSE","END","ESCAPE","EXCEPT","EXCLUSIVE","EXISTS","EXPLAIN","FAIL","FOR","FOREIGN","FROM","FULL","GLOB","GROUP","HAVING","IF","IGNORE","IMMEDIATE","IN","INDEX","INDEXED","INITIALLY","INNER","INSERT","INSTEAD","INTERSECT","INTO","IS","ISNULL","JOIN","KEY","LEFT","LIKE","LIMIT","MATCH","NATURAL","NO","NOT","NOTNULL","NULL","OF","OFFSET","ON","OR","ORDER","OUTER","PLAN","PRAGMA","PRIMARY","QUERY","RAISE","RECURSIVE","REFERENCES","REGEXP","REINDEX","RELEASE","RENAME","REPLACE","RESTRICT","RIGHT","ROLLBACK","ROW","SAVEPOINT","SELECT","SET","TABLE","TEMP","TEMPORARY","THEN","TO","TRANSACTION","TRIGGER","UNION","UNIQUE","UPDATE","USING","VACUUM","VALUES","VIEW","VIRTUAL","WHEN","WHERE","WITH","WITHOUT"].map(e=>e.toUpperCase()));function xl(e,t){let n=e.db,r=t.table.schema||"main",s=t.table.name,o,a=[],i=!1;if(t.moduleName)o=t.moduleName,a=t.moduleArgs||[],i=!0;else{let h=n.getDefaultVtabModule();o=h.name,a=[...h.args]}let u=n._getVtabModule(o);if(!u)throw new b(`No virtual table module named '${o}'`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let c;try{if(o.toLowerCase()==="memory"){let h,p;if(i){if(a.length===0||!a[0].trim().toUpperCase().startsWith("CREATE TABLE"))throw new Error("When using 'USING memory(...)', the first argument must be the CREATE TABLE DDL string.");let g=a[0],y=new Be().parse(g);if(y.type!=="createTable")throw new Error("Argument provided to 'USING memory(...)' did not parse as a CREATE TABLE statement.");let I=y;h=I.columns.map(N=>({name:N.name,type:Xr(N.dataType)})),p=Hr(I.columns,I.constraints)}else{if(!t.columns||t.columns.length===0)throw new Error("Cannot create implicit memory table without column definitions.");h=t.columns.map(g=>({name:g.name,type:Xr(g.dataType)})),p=Hr(t.columns,t.constraints||[])}c={columns:Object.freeze(h),primaryKey:p,readOnly:!1}}else if(o.toLowerCase()==="json_each"||o.toLowerCase()==="json_tree"){if(a.length<1||a.length>2)throw new Error(`${o} requires 1 or 2 arguments (jsonSource, [rootPath])`);c={jsonSource:a[0],rootPath:a[1]}}else console.warn(`Compiler creating generic BaseModuleConfig for module '${o}'. Module may need specific argument parsing.`),c={}}catch(h){throw new b(`Failed to parse arguments for module '${o}': ${h.message}`,w.ERROR,h instanceof Error?h:void 0,t.loc?.start.line,t.loc?.start.column)}let d;try{d=u.module.xCreate(n,u.auxData,o,r,s,c)}catch(h){let p=h instanceof Error?h.message:String(h),g=h instanceof b?h.code:w.ERROR;throw new b(`Module '${o}' xCreate failed for table '${s}': ${p}`,g,h instanceof Error?h:void 0,t.loc?.start.line,t.loc?.start.column)}let l=n.schemaManager.getSchema(r);if(!l)throw new b(`Internal error: Schema '${r}' not found during CREATE TABLE.`,w.INTERNAL);if(l.getTable(s))if(t.ifNotExists){console.log(`Skipping CREATE TABLE: Table ${r}.${s} already exists (IF NOT EXISTS).`),e.emit(f.Noop,0,0,0,null,0,`CREATE TABLE ${s} (skipped IF NOT EXISTS)`);return}else throw new b(`Table ${r}.${s} already exists`,w.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!d.tableSchema)throw new b(`Module '${o}' xCreate did not provide a tableSchema for '${s}'.`,w.INTERNAL);d.tableSchema.schemaName.toLowerCase()!==r.toLowerCase()&&(console.warn(`VTab module ${o} created table ${s} in schema ${d.tableSchema.schemaName}, but expected ${r}.`),d.tableSchema.schemaName=r),d.tableSchema.vtabModuleName||(d.tableSchema.vtabModuleName=o),d.tableSchema.vtabArgs||(d.tableSchema.vtabArgs=Object.freeze(a)),l.addTable(d.tableSchema),console.log(`Successfully created table ${r}.${s} using module ${o}`),e.emit(f.Noop,0,0,0,null,0,`CREATE TABLE ${s}`)}function Ml(e,t){e.emit(f.Noop,0,0,0,null,0,"CREATE INDEX (no-op in VDBE)")}function Dl(e,t){let n=t.view.schema??e.db.schemaManager.getCurrentSchemaName(),r=t.view.name,s;try{s=e.db.schemaManager.getSchemaOrFail(n)}catch{let u=e.db.schemaManager.getSchema(n);if(!u)throw new b(`Schema '${n}' not found`,w.ERROR);s=u}let o=s.getTable(r)??s.getView(r);if(o)if(t.ifNotExists){e.emit(f.Noop,0,0,0,null,0,`View ${n}.${r} already exists (IF NOT EXISTS)`);return}else{let i="selectAst"in o?"view":"table";throw new b(`cannot create ${i} ${r}: already exists in schema ${s.name}`,w.ERROR)}let a={name:r,schemaName:s.name,sql:e.sql,selectAst:t.select,columns:t.columns?Object.freeze(t.columns):void 0};try{s.addView(a)}catch(i){throw i instanceof b?i:new b(`Error adding view ${r} to schema ${s.name}: ${i.message}`,w.INTERNAL)}e.emit(f.Noop,0,0,0,null,0,`Schema definition for VIEW ${n}.${r}`)}function Pl(e,t){let n=t.name.schema??e.db.schemaManager.getCurrentSchemaName(),r=t.name.name,s=!1,o=t.objectType;try{switch(t.objectType){case"table":s=e.db.schemaManager.dropTable(n,r);break;case"view":s=e.db.schemaManager.dropView(n,r);break;case"index":e.emit(f.Noop,0,0,0,null,0,`DROP INDEX ${n}.${r} (Not fully implemented)`),s=!0,o="index",console.warn("DROP INDEX compilation is a placeholder.");break;default:throw new b(`Unsupported object type for DROP: ${t.objectType}`)}if(!s&&!t.ifExists)throw new b(`no such ${o}: ${r}`,w.ERROR)}catch(i){throw i instanceof b?i:new b(`Error dropping ${o} ${r}: ${i.message}`,w.INTERNAL)}let a=s?`Schema definition drop for ${o.toUpperCase()} ${n}.${r}`:`${o.toUpperCase()} ${n}.${r} did not exist (IF EXISTS)`;e.emit(f.Noop,0,0,0,null,0,a)}function kl(e,t){e.emit(f.Noop,0,0,0,null,0,"ALTER TABLE (no-op in VDBE)")}function Fl(e,t){e.emit(f.VBegin,0,0,0,null,0,`BEGIN ${t.mode||"DEFERRED"}`)}function Ul(e,t){e.emit(f.VCommit,0,0,0,null,0,"COMMIT")}function $l(e,t){let n=e.db,r=t.name,s=t.value,o=a=>a?a.type==="literal"?a.value===null?null:String(a.value):a.type==="identifier"?a.name:null:null;switch(r){case"default_vtab_module":{let a=o(s);if(a===null)throw new b("PRAGMA default_vtab_module requires a string or identifier value.",w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);console.log(`Setting default VTab module to: ${a}`),n.setDefaultVtabName(a);break}case"default_vtab_args":{let a=o(s);a===null?(console.log("Clearing default VTab args."),n.setDefaultVtabArgsFromJson("[]")):(console.log(`Setting default VTab args from JSON: ${a}`),n.setDefaultVtabArgsFromJson(a));break}default:console.warn(`Ignoring unrecognized PRAGMA: ${r}`);break}e.emit(f.Noop,0,0,0,null,0,`PRAGMA ${r}`)}function Hr(e,t){let n=new Map;e.forEach((o,a)=>n.set(o.name.toLowerCase(),a));let r=[],s=!1;if(t){for(let o of t)if(o.type==="primaryKey"&&o.columns){if(s)throw new Error("Multiple primary keys defined");s=!0,r=o.columns.map(a=>{let i=n.get(a.name.toLowerCase());if(i===void 0)throw new Error(`PK column ${a.name} not found`);return{index:i,desc:a.direction==="desc"}});break}}return s||e.forEach((o,a)=>{let i=o.constraints.find(u=>u.type==="primaryKey");if(i){if(s)throw new Error("Multiple primary keys defined (column + table/column)");s=!0,r=[{index:a,desc:i.direction==="desc"}]}}),r.length>0?Object.freeze(r):void 0}function Xr(e){let t=e?.toUpperCase()||"";return t.includes("INT")?R.INTEGER:t.includes("REAL")||t.includes("FLOAT")||t.includes("DOUBLE")?R.REAL:t.includes("BLOB")?R.BLOB:t.includes("BOOL")?R.INTEGER:R.TEXT}function Bl(e,t){let n=[];if(!t||t.length===0)return n;let r=(s,o)=>{if(s.type==="table"){let a=s.table.name,i=s.table.schema||"main",u=(s.alias||a).toLowerCase(),c=a.toLowerCase(),d=e.cteMap.get(c);if(d){if(d.type==="materialized"){let p=d.cursorIdx;n.push(p);let g=d.schema;if(e.tableSchemas.set(p,g),e.tableAliases.has(u)||o.has(u))throw new b(`Duplicate table name or alias: ${u}`,w.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);e.tableAliases.set(u,p),o.set(u,p),console.log(`FROM: Using materialized CTE '${c}' with cursor ${p} for alias '${u}'`)}else throw new b(`Unsupported CTE type '${d.type}' found for ${c}`,w.INTERNAL);return}let l=e.allocateCursor();n.push(l);let h=e.db._findTable(a,i);if(!h)throw new b(`Table not found: ${i}.${a}`,w.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column);if(e.tableSchemas.set(l,h),e.tableAliases.has(u)||o.has(u))throw new b(`Duplicate table name or alias: ${u}`,w.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);if(e.tableAliases.set(u,l),o.set(u,l),h.isVirtual&&h.vtabInstance){let p={type:"vtab",tableSchema:h};e.emit(f.OpenRead,l,0,0,p,0,`Open VTab ${s.alias||a}`)}else if(h.isVirtual&&!h.vtabInstance){console.warn(`VTab ${a} found but not connected, attempting connect...`);let p=e.db._getVtabModule(h.vtabModuleName??"");if(!p)throw new b(`Module ${h.vtabModuleName} not found for VTab ${a}`,w.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column);let g=h.vtabModuleName??"",E=h.vtabArgs??[],y={};try{if(g.toLowerCase()==="memory")if(E.length>0&&E[0].trim().toUpperCase().startsWith("CREATE TABLE")){let S=E[0],L=new Be().parse(S);if(L.type==="createTable"){let v=L;y={columns:Object.freeze(v.columns.map(M=>({name:M.name,type:Xr(M.dataType)}))),primaryKey:Hr(v.columns,v.constraints),readOnly:!1}}else console.warn(`Could not parse stored DDL argument for memory table ${a} during connect.`)}else throw console.warn(`Could not reconstruct schema for memory table ${a} during connect: DDL argument missing or invalid.`),new b(`Cannot connect to memory table ${a}: schema information missing from stored arguments.`);else if(g.toLowerCase()==="json_each"||g.toLowerCase()==="json_tree"){if(E.length<1||E.length>2)throw new Error(`${g} requires 1 or 2 stored arguments (jsonSource, [rootPath])`);y={jsonSource:E[0],rootPath:E[1]}}else y={}}catch(S){throw new b(`Failed to parse stored arguments for module '${g}' on connect: ${S.message}`,w.ERROR,S instanceof Error?S:void 0)}let I=p.module.xConnect(e.db,p.auxData,g,i,a,y),N={...h,vtabInstance:I};e.db.schemaManager.getSchema(i)?.addTable(N),e.tableSchemas.set(l,N);let C={type:"vtab",tableSchema:N};e.emit(f.OpenRead,l,0,0,C,0,`Open VTab ${s.alias||a}`)}else throw new b("Regular tables not supported",w.ERROR,void 0,s.table.loc?.start.line,s.table.loc?.start.column)}else if(s.type==="join")r(s.left,o),r(s.right,o);else if(s.type==="functionSource"){let a=s.name.name,i=e.db._getVtabModule(a);if(!i)throw new b(`Table-valued function or virtual table module not found: ${a}`,w.ERROR,void 0,s.name.loc?.start.line,s.name.loc?.start.column);let u=[];for(let I of s.args){let N=e.allocateMemoryCells(1);if(e.compileExpression(I,N),I.type==="literal")if(I.value===null||typeof I.value=="string")u.push(I.value===null?"":I.value);else throw new b(`Table-valued function arguments must be string literals (or NULL) for ${a}.`,w.ERROR,void 0,I.loc?.start.line,I.loc?.start.column);else throw I.type==="parameter"?new b(`Parameters not supported as arguments to table-valued functions like ${a} yet.`,w.ERROR,void 0,I.loc?.start.line,I.loc?.start.column):new b(`Only literals supported as arguments to table-valued functions like ${a} yet.`,w.ERROR,void 0,I.loc?.start.line,I.loc?.start.column)}let c="main",d=s.alias||a,l=a,h={};try{if(l.toLowerCase()==="json_each"||l.toLowerCase()==="json_tree"){if(u.length<1||u.length>2)throw new Error(`${l} requires 1 or 2 arguments (jsonSource, [rootPath])`);h={jsonSource:u[0],rootPath:u[1]}}else console.warn(`Compiler creating generic BaseModuleConfig for TVF module '${l}'. Module may need specific argument parsing.`),h={}}catch(I){throw new b(`Failed to parse arguments for TVF module '${l}': ${I.message}`,w.ERROR,I instanceof Error?I:void 0,s.name.loc?.start.line,s.name.loc?.start.column)}let p=i.module.xConnect(e.db,i.auxData,l,c,d,h);if(!p||!p.tableSchema)throw new b(`Module ${a} xConnect did not return a valid table instance or schema.`,w.INTERNAL);let g=e.allocateCursor();n.push(g),e.tableSchemas.set(g,p.tableSchema);let E=(s.alias||a).toLowerCase();if(e.tableAliases.has(E)||o.has(E))throw new b(`Duplicate table name or alias: ${E}`,w.ERROR,void 0,s.loc?.start.line,s.loc?.start.column);e.tableAliases.set(E,g),o.set(E,g);let y={type:"vtab",tableSchema:p.tableSchema};e.emit(f.OpenRead,g,0,0,y,0,`Open TVF ${E}`)}else throw new b(`Unsupported FROM clause type during cursor opening: ${s.type}`,w.INTERNAL)};for(let s of t)r(s,new Map);return n}function xo(e,t,n){let r=new Map;if(!t)return r;let s=o=>{if(o.type==="column"){let a=o,i=-1;if(a.table)i=e.tableAliases.get(a.table.toLowerCase())??-1;else{let u=!1;for(let c of n)e.tableSchemas.get(c)?.columnIndexMap.has(a.name.toLowerCase())&&(i!==-1&&(u=!0),i=c);if(u)throw new b(`Ambiguous column reference in usage analysis: ${a.name}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}if(n.has(i)){let u=e.tableSchemas.get(i),c=u?.columnIndexMap.get(a.name.toLowerCase());c!==void 0?(r.has(i)||r.set(i,new Set),r.get(i).add(c)):a.name.toLowerCase()==="rowid"&&!u?.isVirtual&&(r.has(i)||r.set(i,new Set),r.get(i).add(-1))}}else o.type==="binary"?(s(o.left),s(o.right)):o.type==="unary"?s(o.expr):o.type==="function"?o.args.forEach(s):o.type==="cast"?s(o.expr):o.type==="subquery"?console.warn("Subquery column usage analysis not implemented for colUsed mask."):o.type==="collate"?s(o.expr):o.type==="identifier"&&s({type:"column",name:o.name,loc:o.loc})};return s(t),r}function Zh(e,t,n,r,s){let o=BigInt(0),a=new Set(e.tableAliases.values()),i=e.tableSchemas.get(t);if(!i)return o;let u=c=>{c>=0&&c<63?o|=BigInt(1)<<BigInt(c):c===-1&&(o|=BigInt(1)<<BigInt(63))};return n.forEach(c=>{if(c.type==="all"){let d=!1;if(!c.table)d=!0;else{let l=c.table.toLowerCase();e.tableAliases.get(l)===t&&(d=!0)}d&&(i.columns.forEach((l,h)=>{l.hidden||u(h)}),i.isVirtual||u(-1))}else c.expr&&xo(e,c.expr,a).get(t)?.forEach(u)}),r&&xo(e,r,a).get(t)?.forEach(u),s&&s.forEach(c=>{xo(e,c.expr,a).get(t)?.forEach(u)}),i.primaryKeyDefinition?.forEach(c=>{c.index>=0&&c.index<i.columns.length&&u(c.index)}),o}function Hh(e,t,n,r,s){let o=[],a=new Map,i=new Set,u=d=>{if(d.type==="literal"||d.type==="parameter")return!0;if(d.type==="column"){let l=d,h=-1;if(l.table)h=e.tableAliases.get(l.table.toLowerCase())??-1;else{let p=!1,g=!1,E=!1;n.columnIndexMap.has(l.name.toLowerCase())&&(p=!0,h=t);for(let y of e.tableAliases.values()){if(y===t)continue;e.tableSchemas.get(y)?.columnIndexMap.has(l.name.toLowerCase())&&((p||g)&&(E=!0),h=y,g=!0)}if(E)throw new b(`Ambiguous column in constraint analysis: ${l.name}`,w.ERROR,void 0,d.loc?.start.line,d.loc?.start.column)}return h!==-1&&h!==t}return d.type==="binary"?u(d.left)&&u(d.right):d.type==="unary"?u(d.expr):d.type==="function"?d.args.every(u):d.type==="subquery"?!1:d.type==="cast"||d.type==="collate"?u(d.expr):!1},c=d=>{if(d&&!i.has(d)){if(d.type==="unary"&&(d.operator.toUpperCase()==="IS NULL"||d.operator.toUpperCase()==="IS NOT NULL")){if(d.expr.type==="column"){let l=d.expr,h=l.name.toLowerCase(),p=-1;if(l.table?p=e.tableAliases.get(l.table.toLowerCase())??-1:n.columnIndexMap.has(h)&&(p=t),p===t){let g=n.columnIndexMap.get(h);if(g!==void 0){let E=d.operator.toUpperCase()==="IS NULL"?F.ISNULL:F.ISNOTNULL,y=o.length;o.push({iColumn:g,op:E,usable:!0}),a.set(y,d),i.add(d)}}}return}if(d.type==="binary"){let l=d;if(l.operator.toUpperCase()==="AND"){c(l.left),c(l.right);return}if(l.operator.toUpperCase()==="OR"){console.debug("Skipping OR constraint for xBestIndex planning.");return}if(l.operator.toUpperCase()==="BETWEEN"){if(l.left.type==="column"&&l.right.type==="binary"&&l.right.operator.toUpperCase()==="AND"){let I=l.left,N=l.right.left,C=l.right.right,S={type:"binary",operator:">=",left:I,right:N,loc:l.loc},A={type:"binary",operator:"<=",left:I,right:C,loc:l.loc};c(S),c(A)}else console.warn("Unsupported BETWEEN structure for planning.");return}if(l.operator.toUpperCase()==="IN"){if(l.left.type==="column"&&l.right.type==="function"&&l.right.name==="_list_"){let I=l.left,N=l.right.args,C=-1,S=I.name.toLowerCase();if(I.table?C=e.tableAliases.get(I.table.toLowerCase())??-1:n.columnIndexMap.has(S)&&(C=t),C===t&&N.every(u)){let A=n.columnIndexMap.get(S);A!==void 0&&(N.forEach(L=>{let v=o.length;o.push({iColumn:A,op:F.EQ,usable:!0}),a.set(v,L)}),i.add(l))}}else l.right.type==="subquery"&&console.warn("IN (subquery) constraint skipped for xBestIndex planning.");return}let h,p,g,E=!1,y=-1;if(l.left.type==="column"?(h=l.left,p=l.right,g=Jr(l.operator),h.table?y=e.tableAliases.get(h.table.toLowerCase())??-1:n.columnIndexMap.has(h.name.toLowerCase())&&(y=t)):l.right.type==="column"&&(h=l.right,p=l.left,E=!0,g=Jr(l.operator,!0),h.table?y=e.tableAliases.get(h.table.toLowerCase())??-1:n.columnIndexMap.has(h.name.toLowerCase())&&(y=t)),h&&g&&p&&y===t)if(u(p)){let I=n.columnIndexMap.get(h.name.toLowerCase());if(I!==void 0){let N=o.length;o.push({iColumn:I,op:g,usable:!0}),a.set(N,p),i.add(l)}}else console.debug(`Skipping constraint for xBestIndex (value references target table): ${h.name} ${l.operator} ...`);else if(l.left.type==="column"&&l.right.type==="column"){let I=l.left,N=l.right,C=e.tableAliases.get(I.table?.toLowerCase()??"")??(n.columnIndexMap.has(I.name.toLowerCase())?t:-1),S=e.tableAliases.get(N.table?.toLowerCase()??"")??(n.columnIndexMap.has(N.name.toLowerCase())?t:-1),A,L,v;if(C===t&&S!==-1&&S!==t?(A=I,L=N,v=Jr(l.operator,!1)):S===t&&C!==-1&&C!==t&&(A=N,L=I,v=Jr(l.operator,!0)),A&&L&&v){let M=n.columnIndexMap.get(A.name.toLowerCase());if(M!==void 0){let O=o.length;o.push({iColumn:M,op:v,usable:!0}),a.set(O,L),i.add(l)}}}}}};return c(r),{constraints:o,constraintExpressions:a,handledNodes:i}}function _l(e,t,n,r,s){if(!n.isVirtual||!n.vtabModule?.xBestIndex||!n.vtabInstance){e.cursorPlanningInfo.set(t,{idxNum:0,idxStr:null,usage:[],cost:1e10,rows:BigInt(1e6),orderByConsumed:!1,constraints:[],constraintExpressions:new Map,handledWhereNodes:new Set});return}let o=r.type==="select"||r.type==="update"||r.type==="delete"?r.where:void 0,a=r.type==="select"?r.orderBy:void 0,i=r.type==="select"?r.columns:[],{constraints:u,constraintExpressions:c,handledNodes:d}=Hh(e,t,n,o,s),l=[];a&&a.forEach(y=>{if(y.expr.type==="column"){let I=y.expr,N=I.name.toLowerCase(),C=-1;if(I.table)C=e.tableAliases.get(I.table.toLowerCase())??-1;else if(n.columnIndexMap.has(N)){C=t;for(let S of s)if(e.tableSchemas.get(S)?.columnIndexMap.has(N)){C=-1;break}}else for(let S of s)if(e.tableSchemas.get(S)?.columnIndexMap.has(N)){C=S;break}if(C===t){let S=n.columnIndexMap.get(N);S!==void 0?l.push({iColumn:S,desc:y.direction==="desc"}):N==="rowid"&&l.push({iColumn:-1,desc:y.direction==="desc"})}}else console.warn("Skipping non-column ORDER BY term for xBestIndex planning")});let h=Zh(e,t,i,o,a),p={nConstraint:u.length,aConstraint:Object.freeze([...u]),nOrderBy:l.length,aOrderBy:Object.freeze([...l]),colUsed:h,aConstraintUsage:Array.from({length:u.length},()=>({argvIndex:0,omit:!1})),idxNum:0,idxStr:null,orderByConsumed:!1,estimatedCost:1e10,estimatedRows:BigInt(1e6),idxFlags:0},g;try{g=n.vtabModule.xBestIndex(n.vtabInstance,p)}catch(y){console.error(`Error calling xBestIndex for ${n.name}:`,y),g=w.ERROR}if(g!==w.OK)throw new b(`xBestIndex failed for table ${n.name} with code ${g}`,g,void 0,r.loc?.start.line,r.loc?.start.column);let E={idxNum:p.idxNum,idxStr:p.idxStr,usage:p.aConstraintUsage,cost:p.estimatedCost,rows:p.estimatedRows,orderByConsumed:p.orderByConsumed,constraints:[...p.aConstraint],constraintExpressions:c,handledWhereNodes:d};e.cursorPlanningInfo.set(t,E),console.log(`Planning for ${n.name} (cursor ${t}, outer: ${[...s]}): idxNum=${E.idxNum}, cost=${E.cost}, rows=${E.rows}, usage=`,E.usage,`handledNodes=${E.handledWhereNodes.size}`,`colUsed=${h.toString(2)}`)}function Jr(e,t=!1){switch(e.toUpperCase()){case"=":case"==":return F.EQ;case"<":return t?F.GT:F.LT;case"<=":return t?F.GE:F.LE;case">":return t?F.LT:F.GT;case">=":return t?F.LE:F.GE;case"!=":case"<>":return F.NE;case"IS":return F.IS;case"IS NOT":return F.ISNOT;case"LIKE":return F.LIKE;case"GLOB":return F.GLOB;case"REGEXP":return F.REGEXP;case"MATCH":return F.MATCH;default:return}}function Vl(e,t,n){let r=e.cursorPlanningInfo.get(t);if(!r||r.constraints.length===0||r.usage.every(a=>a.argvIndex===0))return;let s=e.allocateMemoryCells(1),o=e.tableSchemas.get(t);if(!o)throw new Error(`Internal: Schema missing for cursor ${t} during verification`);for(let a=0;a<r.constraints.length;a++){let i=r.constraints[a],u=r.usage[a];if(u.argvIndex>0&&!u.omit){let c=r.constraintExpressions.get(a),d=null,l=c?.loc;if(i.iColumn===-1){console.warn(`Verification of rowid constraint (constraint ${a}) not implemented.`);continue}let h=o.columns[i.iColumn]?.name;if(!h){console.error(`Cannot find column name for index ${i.iColumn} in table ${o.name} during verification.`);continue}let p={type:"column",name:h};if(i.op===F.ISNULL||i.op===F.ISNOTNULL)if(c?.type==="unary")d={...c,expr:p},l=c.loc;else{console.warn(`Cannot reconstruct IS NULL/IS NOT NULL verification expression for constraint ${a}.`);continue}else{if(!c){console.warn(`Could not find original value expression for constraint verification (cursor ${t}, constraint ${a}, op ${i.op})`);continue}let E={[F.EQ]:{op:"="},[F.LT]:{op:"<"},[F.LE]:{op:"<="},[F.GT]:{op:">"},[F.GE]:{op:">="},[F.NE]:{op:"!="},[F.IS]:{op:"IS"},[F.ISNOT]:{op:"IS NOT"},[F.LIKE]:{op:"LIKE"},[F.GLOB]:{op:"GLOB"},[F.REGEXP]:{op:"REGEXP"},[F.MATCH]:{op:"MATCH"}}[i.op];if(!E){console.warn(`Cannot map constraint op ${i.op} back to AST operator for verification.`);continue}d={type:"binary",operator:E.op,left:p,right:c,loc:l}}if(d){e.compileExpression(d,s);let g=d.type==="unary"||d.type==="binary"?d.operator:`op${i.op}`;e.emit(f.IfFalse,s,n,0,null,0,`Verify constraint ${a} (${g})`)}}}}function rn(e,t,n,r){if(!t)return;let s=new Set;n.forEach(a=>{e.cursorPlanningInfo.get(a)?.handledWhereNodes.forEach(i=>{s.add(i)})});let o=a=>{if(!s.has(a))if(a.type==="binary")if(a.operator.toUpperCase()==="AND")o(a.left),o(a.right);else if(a.operator.toUpperCase()==="OR"){let i=e.allocateMemoryCells(1),u=e.allocateAddress();e.compileExpression(a.left,i),e.emit(f.IfTrue,i,u,0,null,0,"OR: check left"),e.compileExpression(a.right,i),e.emit(f.IfFalse,i,r,0,null,0,"OR: check right, jump if false"),e.resolveAddress(u)}else{let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(f.IfFalse,i,r,0,null,0,`Check unhandled: ${a.operator}`)}else if(a.type==="unary"){let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(f.IfFalse,i,r,0,null,0,`Check unhandled: ${a.operator}`)}else{let i=e.allocateMemoryCells(1);e.compileExpression(a,i),e.emit(f.IfFalse,i,r,0,null,0,`Check unhandled: ${a.type}`)}};o(t)}function Et(e,t,n){let r={isCorrelated:!1,correlatedColumns:[]},s=new Set,o=(a,i)=>{if(a){if(a.type==="select"){let u=a,c=new Map,d=new Set;u.from?.forEach(h=>{let p=g=>{if(g.type==="table"){let E=(g.alias||g.table.name).toLowerCase(),y=e.tableAliases.get(E);y!==void 0?(c.set(E,y),d.add(y)):console.warn(`Alias/Table ${E} not found in global map during correlation analysis. Scope issue?`)}else if(g.type==="join")p(g.left),p(g.right);else if(g.type==="functionSource"){let E=(g.alias||g.name.name).toLowerCase(),y=e.tableAliases.get(E);y!==void 0?(c.set(E,y),d.add(y)):console.warn(`Alias/TVF ${E} not found in global map during correlation analysis. Scope issue?`)}};p(h)});let l=new Set([...i,...d]);u.columns.forEach(h=>{h.type==="column"&&h.expr&&o(h.expr,l)}),o(u.where,l),u.groupBy?.forEach(h=>o(h,l)),o(u.having,l);return}if(a.type==="column"||a.type==="identifier"){let u,c;a.type==="column"?(u=a.name,c=a.table):(u=a.name,c=void 0);let d=-1,l=!1;if(c){let h=c.toLowerCase(),p=e.tableAliases.get(h);p!==void 0&&i.has(p)&&(d=p,l=!0)}else{let h=-1,p=!1;for(let g of i)e.tableSchemas.get(g)?.columnIndexMap.has(u.toLowerCase())&&(h!==-1&&(p=!0),h=g);if(p)throw new b(`Ambiguous column in subquery correlation check: ${u}`,w.ERROR,void 0,a.loc?.start.line,a.loc?.start.column);h!==-1&&(d=h,l=!0)}if(l&&n.has(d)){let h=d,g=e.tableSchemas.get(h)?.columnIndexMap.get(u.toLowerCase())??-1;if(g!==-1){r.isCorrelated=!0;let E=`${h}.${g}`;s.has(E)||(r.correlatedColumns.push({outerCursor:h,outerColumnIndex:g}),s.add(E))}else console.warn(`Outer column ${u} resolved to cursor ${h} but index not found in schema.`)}}else a.type==="binary"?(o(a.left,i),o(a.right,i)):a.type==="unary"?o(a.expr,i):a.type==="function"?a.args.forEach(u=>o(u,i)):a.type==="cast"?o(a.expr,i):a.type==="subquery"?o(a.query,i):a.type==="collate"&&o(a.expr,i)}};return o(t,n),r}function ir(e,t){return`${e.toLowerCase()}/${t}`}function lr(e){if(!e)return R.BLOB;let t=e.toUpperCase();return t.includes("INT")?R.INTEGER:t.includes("TEXT")||t.includes("CHAR")||t.includes("CLOB")?R.TEXT:t.includes("BLOB")?R.BLOB:t.includes("REAL")||t.includes("FLOA")||t.includes("DOUB")?R.REAL:R.NUMERIC}var Cn=class{name;tables=new Map;functions=new Map;views=new Map;constructor(t){this.name=t}addTable(t){if(t.schemaName!==this.name)throw new Error(`Table ${t.name} has wrong schema name ${t.schemaName}, expected ${this.name}`);if(this.views.has(t.name.toLowerCase()))throw new b(`Schema '${this.name}': Cannot add table '${t.name}', a view with the same name already exists.`);this.tables.set(t.name.toLowerCase(),t),console.log(`Schema '${this.name}': Added/Updated table '${t.name}'`)}getTable(t){return this.tables.get(t.toLowerCase())}getAllTables(){return this.tables.values()}removeTable(t){let n=t.toLowerCase(),r=this.tables.has(n);return r&&(console.log(`Schema '${this.name}': Removed table '${t}'`),this.tables.delete(n)),r}clearTables(){this.tables.clear()}addView(t){if(t.schemaName!==this.name)throw new Error(`View ${t.name} has wrong schema name ${t.schemaName}, expected ${this.name}`);if(this.tables.has(t.name.toLowerCase()))throw new b(`Schema '${this.name}': Cannot add view '${t.name}', a table with the same name already exists.`);this.views.set(t.name.toLowerCase(),t),console.log(`Schema '${this.name}': Added/Updated view '${t.name}'`)}getView(t){return this.views.get(t.toLowerCase())}getAllViews(){return this.views.values()}removeView(t){let n=t.toLowerCase(),r=this.views.has(n);return r&&(console.log(`Schema '${this.name}': Removed view '${t}'`),this.views.delete(n)),r}clearViews(){this.views.clear()}addFunction(t){let n=ir(t.name,t.numArgs),r=this.functions.get(n);if(r?.xDestroy&&r.userData!==t.userData)try{r.xDestroy(r.userData)}catch(s){console.error(`Destructor failed for function ${n}`,s)}this.functions.set(n,t),console.log(`Schema '${this.name}': Added/Updated function '${t.name}/${t.numArgs}'`)}getFunction(t,n){let r=ir(t,n),s=ir(t,-1);return this.functions.get(r)??this.functions.get(s)}_getAllFunctions(){return this.functions.values()}removeFunction(t,n){let r=ir(t,n),s=this.functions.get(r);if(s){if(s.xDestroy&&s.userData)try{s.xDestroy(s.userData)}catch(o){console.error(`Destructor failed for function ${r}`,o)}return console.log(`Schema '${this.name}': Removed function '${t}/${n}'`),this.functions.delete(r)}return!1}clearFunctions(){this.functions.forEach(t=>{if(t.xDestroy&&t.userData)try{t.xDestroy(t.userData)}catch(n){console.error(`Destructor failed for function ${t.name}/${t.numArgs}`,n)}}),this.functions.clear()}};function sn(e,t,n){switch(t.type){case"literal":let r=t.value;return r===null?R.NULL:typeof r=="number"?R.REAL:typeof r=="bigint"?R.INTEGER:typeof r=="string"?R.TEXT:r instanceof Uint8Array?R.BLOB:R.BLOB;case"column":return Kl(e,t,n)?.column?.affinity??R.BLOB;case"cast":return lr(t.targetType);case"function":return e.db._findFunction(t.name,t.args.length)?.affinity??R.BLOB;case"parameter":return R.BLOB;case"unary":switch(t.operator.toUpperCase()){case"-":case"+":return R.NUMERIC;case"~":return R.INTEGER;case"NOT":return R.INTEGER;default:return R.BLOB}case"binary":switch(t.operator.toUpperCase()){case"+":case"-":case"*":case"/":case"%":case"&":case"|":case"<<":case">>":return R.NUMERIC;case"||":return R.TEXT;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":case"IN":case"LIKE":case"GLOB":case"BETWEEN":return R.INTEGER;case"AND":case"OR":let o=sn(e,t.left,n),a=sn(e,t.right,n);return o===R.TEXT||a===R.TEXT?R.TEXT:o===R.BLOB||a===R.BLOB?R.BLOB:R.NUMERIC;default:return R.BLOB}case"subquery":return R.BLOB;case"identifier":return sn(e,{type:"column",name:t.name},n);case"collate":return sn(e,t.expr,n);default:return R.BLOB}}function Kl(e,t,n){let r=-1;if(t.table)r=e.tableAliases.get(t.table.toLowerCase())??-1;else for(let[i,u]of e.tableAliases.entries())if(e.tableSchemas.get(u)?.columnIndexMap.has(t.name.toLowerCase())){if(r!==-1)return null;r=u}if(r===-1)return null;let s=e.tableSchemas.get(r);if(!s)return null;let o=s.columnIndexMap.get(t.name.toLowerCase());if(o===void 0)return t.name.toLowerCase()==="rowid"&&s.primaryKeyDefinition?.length===0&&!s.isVirtual,null;let a=s.columns[o];return{table:s,column:a}}function Dt(e,t,n){switch(t.type){case"literal":return"BINARY";case"column":return Kl(e,t,n)?.column.collation||"BINARY";case"collate":return t.collation.toUpperCase();case"cast":return Dt(e,t.expr,n);case"function":return"BINARY";case"parameter":return"BINARY";case"unary":return Dt(e,t.expr,n);case"binary":switch(t.operator.toUpperCase()){case"||":case"+":case"-":case"*":case"/":case"%":case"&":case"|":case"<<":case">>":return"BINARY";case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":case"LIKE":case"GLOB":case"BETWEEN":case"IN":{let s=Dt(e,t.left,n),o=Dt(e,t.right,n);return s!=="BINARY"&&o==="BINARY"?s:o!=="BINARY"&&s==="BINARY"?o:"BINARY"}case"AND":case"OR":return"BINARY";default:return"BINARY"}case"subquery":return"BINARY";case"identifier":return Dt(e,{type:"column",name:t.name},n);default:return"BINARY"}}function Qr(e,t,n){let r=t.value;if(r===null)e.emit(f.Null,0,n,0,null,0,"NULL literal");else if(typeof r=="number")if(Number.isSafeInteger(r))e.emit(f.Integer,r,n,0,null,0,`Integer literal: ${r}`);else if(Number.isInteger(r)){let s=e.addConstant(BigInt(r));e.emit(f.Int64,0,n,0,s,0,`Large Integer literal: ${r}`)}else{let s=e.addConstant(r);e.emit(f.Real,0,n,0,s,0,`Float literal: ${r}`)}else if(typeof r=="string"){let s=e.addConstant(r);e.emit(f.String8,0,n,0,s,0,`String literal: '${r}'`)}else if(r instanceof Uint8Array){let s=e.addConstant(r);e.emit(f.Blob,r.length,n,0,s,0,"BLOB literal")}else if(typeof r=="bigint"){let s=e.addConstant(r);e.emit(f.Int64,0,n,0,s,0,`BigInt literal: ${r}`)}else throw new b(`Unsupported literal type: ${typeof r}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}function ur(e,t,n,r,s,o){if(e.subroutineDepth>0&&o){let c=r?.correlatedColumns.find(d=>{let l=e.tableSchemas.get(d.outerCursor),h=l?.columns[d.outerColumnIndex]?.name.toLowerCase();if(!h)return!1;if(t.table){let p=[...e.tableAliases.entries()].find(([y,I])=>I===d.outerCursor)?.[0],g=l?.name.toLowerCase(),E=t.table.toLowerCase();if(p?.toLowerCase()===E||g===E)return h===t.name.toLowerCase()}else return h===t.name.toLowerCase();return!1});if(c){let d=`${c.outerCursor}.${c.outerColumnIndex}`,l=o.get(d);if(l!==void 0){e.emit(f.SCopy,l,n,0,null,0,`Sub: Use outer arg ${t.name} from FP[${l}]`);return}else throw new b(`Internal error: Correlated column ${t.name} not found in argument map.`,w.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column)}}if(s){let c=t.name.toLowerCase(),d=s.finalColumnMap.find(l=>l.expr?.alias?.toLowerCase()===c||l.expr?.type==="column"&&!l.expr?.alias&&l.expr.name.toLowerCase()===c);if(d){e.emit(f.SCopy,d.targetReg,n,0,null,0,`HAVING: Use grouped/aggregated col '${t.name}' from reg ${d.targetReg}`);return}throw new b(`Column "${t.name}" must appear in the GROUP BY clause or be used in an aggregate function`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}let a=-1,i=-1,u;if(t.table){let c=t.table.toLowerCase(),d=e.tableAliases.get(c);if(d===void 0)throw new b(`Table or alias not found: ${t.table}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);if(a=d,u=e.tableSchemas.get(a),!u)throw new b(`Internal error: Schema not found for cursor ${a}`,w.INTERNAL);let l=u.columnIndexMap.get(t.name.toLowerCase());if(l===void 0)if(t.name.toLowerCase()==="rowid"&&u.isVirtual)i=-1;else throw new b(`Column not found in table ${t.table}: ${t.name}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);else i=l}else{let c=0,d=-1,l=-1,h;for(let[p,g]of e.tableAliases.entries()){let E=e.tableSchemas.get(g);if(E){let y=E.columnIndexMap.get(t.name.toLowerCase());if(y!==void 0){if(d!==-1)throw new b(`Ambiguous column name: ${t.name}. Qualify with table name or alias.`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);d=g,l=y,h=E,c++}else if(t.name.toLowerCase()==="rowid"&&E.isVirtual){if(d!==-1)throw new b(`Ambiguous column name: ${t.name} (rowid). Qualify with table name or alias.`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);d=g,l=-1,h=E,c++}}}if(d===-1)throw new b(`Column not found: ${t.name}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);a=d,i=l,u=h}if(!u)throw new Error("Internal: Schema resolution failed");if(u.isVirtual)e.emit(f.VColumn,a,i,n,0,0,`Get column: ${u.name}.${t.name} (idx ${i})`);else throw new b("Regular tables not implemented",w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}function es(e,t,n,r,s,o){if(t.right.type==="subquery"&&["=","==","!=","<>","<","<=",">",">=","IN"].includes(t.operator.toUpperCase())){let d=t.right.query;switch(t.operator.toUpperCase()){case"IN":e.compileInSubquery(t.left,d,n,!1);return;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":e.compileComparisonSubquery(t.left,t.operator,d,n);return;default:throw new b(`Operator '${t.operator}' cannot be used with a subquery on the right side.`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}if(t.left.type==="subquery"&&["=","==","!=","<>","<","<=",">",">="].includes(t.operator.toUpperCase())){let d=t.left.query;switch(t.operator.toUpperCase()){case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":e.compileComparisonSubquery(t.left,t.operator,d,n);return;default:throw new b(`Operator '${t.operator}' cannot be used with a subquery on the left side.`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}let a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1);e.compileExpression(t.left,a,r,s,o),e.compileExpression(t.right,i,r,s,o);let u,c=["=","==","!=","<>","<","<=",">",">=","IS","IS NOT","LIKE","GLOB"].includes(t.operator.toUpperCase());if(c)if(t.left.type==="collate")u=t.left.collation.toUpperCase();else if(t.right.type==="collate")u=t.right.collation.toUpperCase();else{let d=Dt(e,t.left,r),l=Dt(e,t.right,r);d!=="BINARY"&&l==="BINARY"?u=d:l!=="BINARY"&&d==="BINARY"?u=l:d!=="BINARY"&&l!=="BINARY"&&d!==l?u="BINARY":u=d}switch(t.operator.toUpperCase()){case"+":e.emit(f.Add,a,i,n,null,0,"Add");break;case"-":e.emit(f.Subtract,a,i,n,null,0,"Subtract");break;case"*":e.emit(f.Multiply,a,i,n,null,0,"Multiply");break;case"/":e.emit(f.Divide,a,i,n,null,0,"Divide");break;case"%":e.emit(f.Remainder,a,i,n,null,0,"Remainder");break;case"||":e.emit(f.Concat,a,i,n,null,0,"Concat");break;case"&":e.emit(f.BitAnd,a,i,n,null,0,"BitAnd");break;case"|":e.emit(f.BitOr,a,i,n,null,0,"BitOr");break;case"<<":e.emit(f.ShiftLeft,i,a,n,null,0,"ShiftLeft");break;case">>":e.emit(f.ShiftRight,i,a,n,null,0,"ShiftRight");break;case"=":case"==":case"!=":case"<>":case"<":case"<=":case">":case">=":case"IS":case"IS NOT":{let d,l=!0,h=null;switch(c&&u&&u!=="BINARY"&&(h={type:"coll",name:u}),t.operator.toUpperCase()){case"=":case"==":d=f.Eq,l=!0;break;case"IS":d=f.Eq,l=!1;break;case"!=":case"<>":d=f.Ne,l=!0;break;case"IS NOT":d=f.Ne,l=!1;break;case"<":d=f.Lt,l=!0;break;case"<=":d=f.Le,l=!0;break;case">":d=f.Gt,l=!0;break;case">=":d=f.Ge,l=!0;break;default:throw new Error("Impossible operator")}let p=sn(e,t.left,r),g=sn(e,t.right,r),E=[R.INTEGER,R.REAL,R.NUMERIC].includes(p),y=[R.INTEGER,R.REAL,R.NUMERIC].includes(g),I=[R.TEXT,R.BLOB].includes(p),N=[R.TEXT,R.BLOB].includes(g);E&&N?e.emit(f.Affinity,i,1,0,"NUMERIC",0,"Apply NUMERIC affinity to RHS"):y&&I&&e.emit(f.Affinity,a,1,0,"NUMERIC",0,"Apply NUMERIC affinity to LHS");let C=e.allocateAddress(),S=e.allocateAddress(),A=e.allocateAddress();l&&(e.emit(f.IfNull,a,S,0,null,0,"Compare: If left NULL"),e.emit(f.IfNull,i,S,0,null,0,"Compare: If right NULL")),e.emit(d,a,C,i,h,0,`Compare ${t.operator}${h?` (${h.name})`:""}`),e.emit(f.Integer,0,n,0,null,0,"Load 0 (false result)"),e.emit(f.Goto,0,A,0,null,0),e.resolveAddress(C),e.emit(f.Integer,1,n,0,null,0,"Load 1 (true result)"),e.emit(f.Goto,0,A,0,null,0),l&&(e.resolveAddress(S),e.emit(f.Null,0,n,0,null,0,"Null comparison result")),e.resolveAddress(A);break}case"LIKE":case"GLOB":throw new b(`Operator ${t.operator} not fully implemented yet with collation support.`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);case"AND":{let d=e.allocateAddress(),l=e.allocateAddress();e.emit(f.SCopy,a,n,0,null,0,"AND: Copy left initially"),e.emit(f.IfTrue,a,d,0,null,0,"AND: If left is true, evaluate right"),e.emit(f.Goto,0,l,0,null,0,"AND: Left is false/null, finish"),e.resolveAddress(d),e.emit(f.SCopy,i,n,0,null,0,"AND: Copy right as result"),e.resolveAddress(l);break}case"OR":{let d=e.allocateAddress(),l=e.allocateAddress();e.emit(f.SCopy,a,n,0,null,0,"OR: Copy left initially"),e.emit(f.IfTrue,a,l,0,null,0,"OR: If left is true, finish"),e.resolveAddress(d),e.emit(f.SCopy,i,n,0,null,0,"OR: Copy right as result"),e.resolveAddress(l);break}default:throw new b(`Unsupported binary operator: ${t.operator}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function ts(e,t,n,r,s,o){if(t.operator.toUpperCase()==="NOT"&&t.expr.type==="binary"&&t.expr.operator.toUpperCase()==="IN"&&t.expr.right.type==="subquery"){e.compileInSubquery(t.expr.left,t.expr.right.query,n,!0);return}if(t.operator.toUpperCase()==="NOT"&&t.expr.type==="subquery"){e.compileExistsSubquery(t.expr.query,n);let i=e.allocateAddress(),u=e.allocateAddress();e.emit(f.IfNull,n,u,0,null,0,"NOT EXISTS: Skip if NULL"),e.emit(f.Not,n,n,0,null,0,"NOT EXISTS: Invert boolean"),e.resolveAddress(u);return}if(t.operator.toUpperCase()==="EXISTS"&&t.expr.type==="subquery"){e.compileExistsSubquery(t.expr.query,n);return}if(t.operator.toUpperCase()==="IS NULL"){let i=e.allocateMemoryCells(1);e.compileExpression(t.expr,i,r,s,o),e.emit(f.IsNull,i,n,0,null,0,"Check IS NULL");return}if(t.operator.toUpperCase()==="IS NOT NULL"){let i=e.allocateMemoryCells(1);e.compileExpression(t.expr,i,r,s,o),e.emit(f.NotNull,i,n,0,null,0,"Check IS NOT NULL");return}let a=e.allocateMemoryCells(1);switch(e.compileExpression(t.expr,a,r,s,o),t.operator.toUpperCase()){case"-":e.emit(f.Negative,a,n,0,null,0,"Unary Minus");break;case"+":e.emit(f.SCopy,a,n,0,null,0,"Unary Plus (no-op)");break;case"~":e.emit(f.BitNot,a,n,0,null,0,"Bitwise NOT");break;case"NOT":let i=e.allocateAddress(),u=e.allocateAddress(),c=e.allocateAddress();e.emit(f.IfNull,a,i,0,null,0,"NOT: Check if operand is NULL"),e.emit(f.IfZero,a,u,0,null,0,"NOT: Check if operand is 0 (false)"),e.emit(f.Integer,0,n,0,null,0,"NOT: Set result 0 (operand was true)"),e.emit(f.Goto,0,c,0,null,0),e.resolveAddress(u),e.emit(f.Integer,1,n,0,null,0,"NOT: Set result 1 (operand was false)"),e.emit(f.Goto,0,c,0,null,0),e.resolveAddress(i),e.emit(f.Null,0,n,0,null,0,"NOT: Set result NULL (operand was NULL)"),e.resolveAddress(c);break;default:throw new b(`Unsupported unary operator: ${t.operator}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function ns(e,t,n,r,s,o){e.compileExpression(t.expr,n,r,s,o);let a=t.targetType.toUpperCase(),i=lr(a),u;switch(i){case R.INTEGER:u="INTEGER";break;case R.REAL:u="REAL";break;case R.TEXT:u="TEXT";break;case R.BLOB:u="BLOB";break;case R.NUMERIC:u="NUMERIC";break;default:u="BLOB"}e.emit(f.Affinity,n,1,0,u,0,`CAST to ${a}`)}function rs(e,t,n,r,s,o){if(s){let c=s.finalColumnMap.find(d=>d.expr?.type==="function"&&d.expr.name.toLowerCase()===t.name.toLowerCase()&&JSON.stringify(d.expr.args)===JSON.stringify(t.args));if(c){e.emit(f.SCopy,c.targetReg,n,0,null,0,`HAVING: Use aggregated func '${t.name}' from reg ${c.targetReg}`);return}}let a=e.allocateMemoryCells(t.args.length||1);for(let c=0;c<t.args.length;c++)e.compileExpression(t.args[c],a+c,r,s,o);let i=e.db._findFunction(t.name,t.args.length);if(!i)throw new b(`Function not found: ${t.name}/${t.args.length}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let u=!!(i.xStep&&i.xFinal);if(u&&!s)e.emit(f.Null,0,n,0,null,0,`Aggregate func ${t.name} in scalar context -> NULL`);else if(i.xFunc){let c={type:"funcdef",funcDef:i,nArgs:t.args.length};e.emit(f.Function,a,t.args.length,n,c,0,`Call func: ${t.name}`)}else throw u&&s&&!i.xFunc?new b(`Aggregate function ${i.name} used incorrectly in HAVING clause.`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column):u&&!s?new b(`Aggregate function ${i.name} used in a scalar context`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column):new b(`Invalid function call context for ${i.name}`,w.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column)}function ss(e,t,n){let r=t.name||t.index;e.parameters.set(r,{memIdx:n}),e.emit(f.Null,0,n,0,null,0,`Parameter placeholder: ${r} -> R[${n}]`)}function os(e,t,n,r,s,o){e.compileExpression(t.expr,n,r,s,o)}function Gl(e,t,n,r,s,o){switch(t.type){case"literal":Qr(e,t,n);break;case"identifier":ur(e,{type:"column",name:t.name,alias:t.name},n,r,s,o);break;case"column":ur(e,t,n,r,s,o);break;case"binary":es(e,t,n,r,s,o);break;case"unary":ts(e,t,n,r,s,o);break;case"cast":ns(e,t,n,r,s,o);break;case"function":rs(e,t,n,r,s,o);break;case"parameter":ss(e,t,n);break;case"subquery":e.compileSubquery(t,n);break;case"collate":os(e,t,n,r,s,o);break;default:throw new b(`Unsupported expression type: ${t.type}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}}function ql(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new b(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,w.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new b(`Table ${n.name} is not a virtual table supporting INSERT`,w.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=t.columns;if(!r)r=n.columns.filter(d=>!d.hidden).map(d=>d.name);else{let d=new Set(n.columns.map(l=>l.name.toLowerCase()));for(let l of r)if(!d.has(l.toLowerCase()))throw new b(`Column '${l}' not found in table '${n.name}'`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column)}let s=r.length,o=r.map(d=>n.columnIndexMap.get(d.toLowerCase())),a=e.allocateCursor(),i={type:"vtab",tableSchema:n};e.emit(f.OpenWrite,a,s,0,i,0,`OpenWrite ${n.name}`);let u=e.allocateMemoryCells(1),c=e.allocateMemoryCells(n.columns.length+1);if(t.values)for(let d of t.values){if(d.length!==s)throw new b(`Column count mismatch: table ${n.name} expected ${s} columns, but ${d.length} values were supplied`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);e.emit(f.Null,0,c,0,null,0,"Rowid=NULL for INSERT");for(let h=0;h<n.columns.length;h++)e.emit(f.Null,0,c+1+h);for(let h=0;h<s;h++){let p=o[h];e.compileExpression(d[h],c+1+p)}let l={onConflict:t.onConflict||W.ABORT,table:n};e.emit(f.VUpdate,n.columns.length+1,c,u,l,0,`VUpdate INSERT ${n.name}`)}else throw t.select?new b("INSERT ... SELECT compilation not implemented yet.",w.ERROR,void 0,t.select.loc?.start.line,t.select.loc?.start.column):new b("INSERT statement missing VALUES or SELECT clause.",w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);e.emit(f.Close,a,0,0,null,0,`Close ${n.name}`)}function jl(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new b(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,w.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new b(`Table ${n.name} is not a virtual table supporting UPDATE`,w.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=e.allocateCursor(),s={type:"vtab",tableSchema:n};e.emit(f.OpenRead,r,0,0,s,0,`OpenRead for UPDATE ${n.name}`),e.planTableAccess(r,n,t,new Set);let o=e.cursorPlanningInfo.get(r),a=e.allocateMemoryCells(1),i=e.allocateAddress(),u=e.allocateAddress(),c=e.allocateAddress(),d=0,l={idxNum:0,idxStr:null,nArgs:0};if(o&&o.idxNum!==0){let N=[];o.usage.forEach((S,A)=>{if(S.argvIndex>0){let L=o.constraintExpressions?.get(A);if(!L)throw new b(`Internal error: Missing expression for constraint ${A} used in UPDATE VFilter`,w.INTERNAL);for(;N.length<S.argvIndex;)N.push(null);N[S.argvIndex-1]={constraintIdx:A,expr:L}}});let C=N.filter(S=>S!==null);C.length>0&&(d=e.allocateMemoryCells(C.length),C.forEach((S,A)=>{e.compileExpression(S.expr,d+A)})),l={idxNum:o.idxNum,idxStr:o.idxStr,nArgs:C.length}}e.emit(f.VFilter,r,i,d,l,0,`Filter for UPDATE ${n.name} (Plan: ${o?.idxNum})`),e.resolveAddress(u),rn(e,t.where,[r],c);let h=new Map;n.columns.forEach((N,C)=>{h.set(N.name.toLowerCase(),C)});let p=new Map,g=new Set;for(let N of t.assignments){let C=N.column.toLowerCase(),S=h.get(C);if(S===void 0)throw new b(`Column '${N.column}' not found in table '${n.name}'`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);if(g.has(S))throw new b(`Column '${N.column}' specified more than once in SET clause`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let A=e.allocateMemoryCells(1);e.compileExpression(N.value,A),p.set(S,A),g.add(S)}e.emit(f.VRowid,r,a,0,null,0,"Get Rowid for UPDATE");let E=n.columns.length,y=e.allocateMemoryCells(E+1);e.emit(f.SCopy,a,y,0,null,0,"Copy Rowid for VUpdate");for(let N=0;N<E;N++){let C=y+1+N;if(g.has(N)){let S=p.get(N);e.emit(f.SCopy,S,C,0,null,0,`Copy NEW value for col ${N}`)}else e.emit(f.VColumn,r,N,C,0,0,`Get OLD value for col ${N}`)}let I={onConflict:t.onConflict||W.ABORT,table:n};e.emit(f.VUpdate,E+1,y,0,I,0,`VUpdate UPDATE ${n.name}`),e.resolveAddress(c),e.emit(f.VNext,r,i,0,null,0,"Advance to next row for UPDATE"),e.emit(f.Goto,0,u,0,null,0,"Loop back for next UPDATE"),e.resolveAddress(i),e.emit(f.Close,r,0,0,null,0,`Close ${n.name}`)}function Yl(e,t){let n=e.db._findTable(t.table.name,t.table.schema);if(!n)throw new b(`Table not found: ${t.table.schema||"main"}.${t.table.name}`,w.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);if(!n.isVirtual||!n.vtabInstance||!n.vtabModule?.xUpdate)throw new b(`Table ${n.name} is not a virtual table supporting DELETE`,w.ERROR,void 0,t.table.loc?.start.line,t.table.loc?.start.column);let r=e.allocateCursor(),s={type:"vtab",tableSchema:n};e.emit(f.OpenRead,r,0,0,s,0,`OpenRead for DELETE ${n.name}`),e.planTableAccess(r,n,t,new Set);let o=e.cursorPlanningInfo.get(r),a=e.allocateMemoryCells(1),i=e.allocateAddress(),u=e.allocateAddress(),c=e.allocateAddress(),d=0,l={idxNum:0,idxStr:null,nArgs:0};if(o&&o.idxNum!==0){let p=[];o.usage.forEach((E,y)=>{if(E.argvIndex>0){let I=o.constraintExpressions?.get(y);if(!I)throw new b(`Internal error: Missing expression for constraint ${y} used in DELETE VFilter`,w.INTERNAL);for(;p.length<E.argvIndex;)p.push(null);p[E.argvIndex-1]={constraintIdx:y,expr:I}}});let g=p.filter(E=>E!==null);g.length>0&&(d=e.allocateMemoryCells(g.length),g.forEach((E,y)=>{e.compileExpression(E.expr,d+y)})),l={idxNum:o.idxNum,idxStr:o.idxStr,nArgs:g.length}}e.emit(f.VFilter,r,i,d,l,0,`Filter for DELETE ${n.name} (Plan: ${o?.idxNum})`),e.resolveAddress(u),rn(e,t.where,[r],c),e.emit(f.VRowid,r,a,0,null,0,"Get Rowid for DELETE");let h={onConflict:W.ABORT,table:n};e.emit(f.VUpdate,1,a,0,h,0,`VUpdate DELETE ${n.name}`),e.resolveAddress(c),e.emit(f.VNext,r,i,0,null,0,"Advance to next row for DELETE"),e.emit(f.Goto,0,u,0,null,0,"Loop back for next DELETE"),e.resolveAddress(i),e.emit(f.Close,r,0,0,null,0,`Close ${n.name}`)}function Wl(e,t){if(t.savepoint){let n=e.addConstant(t.savepoint);e.emit(f.Savepoint,0,0,0,n,0,`ROLLBACK TO ${t.savepoint}`),e.emit(f.VRollbackTo,0,0,0,n,0,`VRollbackTo ${t.savepoint}`)}else e.emit(f.VRollback,0,0,0,null,0,"ROLLBACK")}function zl(e,t){let n=e.addConstant(t.name);e.emit(f.Savepoint,1,0,0,n,0,`SAVEPOINT ${t.name}`),e.emit(f.VSavepoint,0,0,0,n,0,`VSavepoint ${t.name}`)}function Zl(e,t){if(!t.savepoint)throw new b("RELEASE statement requires a savepoint name.",w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let n=e.addConstant(t.savepoint);e.emit(f.Savepoint,2,0,0,n,0,`RELEASE ${t.savepoint}`),e.emit(f.VRelease,0,0,0,n,0,`VRelease ${t.savepoint}`)}function tm(e){return e.type==="column"&&e.expr?.type==="function"&&e.expr.isAggregate===!0}function Xl(e,t){if(!t.from||t.from.length===0){nm(e,t);return}let n=!!t.groupBy&&t.groupBy.length>0,r=t.columns.filter(tm),s=r.length>0,o=s&&!n,a=s||n,i=0,u=[],c=0,d=e.resultColumns,l=e.columnAliases;e.resultColumns=[],e.columnAliases=[];let h=e.compileFromCore(t.from),p=[...h];p.forEach(D=>{let P=e.tableSchemas.get(D);P&&e.planTableAccess(D,P,t,new Set)});let g=!1,E=null;t.orderBy&&t.orderBy.length>0&&(p.every(P=>e.cursorPlanningInfo.get(P)?.orderByConsumed??!1)||(g=!0));let y=0,I=0,N=[],C=0,S=0,A=[],L=e.compileSelectCore(t,h);if(y=L.resultBaseReg,I=L.numCols,N=L.columnMap,a){let D=(t.groupBy?.length??0)+r.length;o&&!n&&(D=r.length),D===0&&n&&(D=t.groupBy.length),D===0&&(D=1),C=e.allocateMemoryCells(D)}else C=y,S=I,A=N;let v=-1,M;if(g){let D=t.orderBy,P=[],X=[];D.forEach(Q=>{let K=A.findIndex(te=>{let we=te.expr?.alias?.toLowerCase(),Ue=Q.expr?.alias?.toLowerCase();return Ue&&we===Ue?!0:Q.expr.type==="column"&&te.expr?.type==="column"&&!Ue&&!te.expr?.alias?Q.expr.name.toLowerCase()===te.expr.name.toLowerCase():JSON.stringify(Q.expr)===JSON.stringify(te.expr)});if(K===-1)throw new b(`ORDER BY term "${JSON.stringify(Q.expr)}" not found in result columns`);P.push(K),X.push(Q.direction==="desc")}),E={keyIndices:P,directions:X,type:"sortkey"},console.log(`Memory Sort: ${S} cols, keys: ${P.join(",")}, dirs: ${X.join(",")}`),v=e.allocateCursor(),M=e.createEphemeralSchema(v,S,E),e.emit(f.OpenEphemeral,v,S,0,M,0,"Open Ephemeral Sorter")}a&&e.emit(f.AggReset,0,0,0,null,0,"Reset Aggregation Context");let O=0,$=0;if(t.limit)O=e.allocateMemoryCells(1),e.compileExpression(t.limit,O),t.offset?($=e.allocateMemoryCells(1),e.compileExpression(t.offset,$)):($=e.allocateMemoryCells(1),e.emit(f.Integer,0,$,0,null,0,"Default OFFSET 0"));else if(t.offset)throw new b("OFFSET requires a LIMIT clause",w.ERROR);let z=[],ee=[],Z=[],ge=[],Oe=new Set,ie=0,ce=0;h.forEach((D,P)=>{if(!e.tableSchemas.get(D))throw new b(`Internal error: Schema not found for cursor ${D}`,w.INTERNAL);let Q=e.allocateAddress(),K=e.allocateAddress(),te=e.allocateAddress();z.push(Q),ee.push(K),Z.push(te);let we=Hl(t.from,P),Ue=we==="left"?e.allocateMemoryCells(1):0;ge.push(Ue),Ue>0&&e.emit(f.Integer,0,Ue,0,null,0,`Init LEFT JOIN Match Flag [${P}] = 0`);let Ie=e.cursorPlanningInfo.get(D),_={idxNum:0,idxStr:null,nArgs:0},ne=0;if(Ie&&Ie.idxNum!==0){let $e=[];Ie.usage.forEach((Mt,or)=>{if(Mt.argvIndex>0){let Wr=Ie.constraintExpressions?.get(or);if(!Wr)throw new b(`Internal error: Missing expression for constraint ${or} used in VFilter`,w.INTERNAL);for(;$e.length<Mt.argvIndex;)$e.push(null);$e[Mt.argvIndex-1]={constraintIdx:or,expr:Wr}}});let mt=$e.filter(Mt=>Mt!==null);mt.length>0&&(ne=e.allocateMemoryCells(mt.length),mt.forEach((Mt,or)=>{let Wr=Et(e,Mt.expr,Oe);e.compileExpression(Mt.expr,ne+or,Wr)})),_={idxNum:Ie.idxNum,idxStr:Ie.idxStr,nArgs:mt.length}}if(e.emit(f.VFilter,D,K,ne,_,0,`Filter/Scan Cursor ${P}`),e.resolveAddress(Q),e.verifyWhereConstraints(D,te),P>0){let $e=rm(t.from,P-1,P,e);$e&&we!=="cross"&&sm(e,$e,h.slice(0,P+1),te)}if(P>0){let $e=P-1,mt=ge[$e];mt>0&&e.emit(f.Integer,1,mt,0,null,0,`Set LEFT JOIN Match Flag [${$e}] = 1`)}Oe.add(D)}),ce=e.getCurrentAddress();let xt=e.allocateAddress();rn(e,t.where,h,xt);let{resultBaseReg:nn,numCols:Fh,columnMap:ly}=e.compileSelectCore(t,h);if(Fh!==I)throw new Error("Internal: Column count mismatch during loop recompilation");if(a){let D=0,P=0,X=0;n?(P=t.groupBy.length,D=e.allocateMemoryCells(P),t.groupBy.forEach((Q,K)=>{e.compileExpression(Q,D+K)}),X=e.allocateMemoryCells(1),e.emit(f.MakeRecord,D,P,X,null,0,"Make GROUP BY Key")):(X=e.allocateMemoryCells(1),e.emit(f.Integer,0,X,0,null,0,"Use constant key 0 for simple aggregate")),r.forEach(Q=>{let K=Q.expr,te=e.db._findFunction(K.name,K.args.length);if(!te)throw new Error("Aggregate function definition disappeared?");let we=e.allocateMemoryCells(K.args.length||1);K.args.forEach((Ie,_)=>{e.compileExpression(Ie,we+_)});let Ue={type:"funcdef",funcDef:te,nArgs:K.args.length};e.emit(f.AggStep,D,we,X,Ue,P,`AggStep for ${K.name}`)})}else{let D=e.allocateAddress();if(O>0){let P=e.allocateAddress();e.emit(f.IfZero,$,P,0,null,0,"Check Offset == 0"),e.emit(f.Subtract,1,$,$,null,0,"Decrement Offset"),e.emit(f.Goto,0,D,0,null,0,"Skip Row (Offset)"),e.resolveAddress(P)}if(g){let P=e.allocateMemoryCells(S+1);e.emit(f.Null,0,P,0,null,0,"Sort: NULL Rowid for Eph Insert"),e.emit(f.Move,nn,P+1,S,null,0,"Sort: Copy result to Eph Insert Data"),e.emit(f.VUpdate,S+1,P,v,{table:M},0,"Sort: Insert Row into Ephemeral")}else if(e.emit(f.ResultRow,nn,S,0,null,0,"Output result row"),O>0){let P=e.allocateAddress();e.emit(f.IfZero,O,P,0,null,0,"Skip Limit Check if already 0"),e.emit(f.Subtract,1,O,O,null,0,"Decrement Limit"),e.emit(f.IfZero,O,ee[0],0,null,0,"Check Limit Reached"),e.resolveAddress(P)}e.resolveAddress(D)}ie=e.getCurrentAddress()+2,e.emit(f.Goto,0,ie,0,null,0,"Goto Innermost VNext"),e.resolveAddress(xt),e.emit(f.Goto,0,ie,0,null,0,"WHERE Failed, Goto VNext");for(let D=h.length-1;D>=0;D--){let P=h[D],X=z[D],Q=ee[D],K=Z[D],te=ge[D];e.resolveAddress(K);let we=e.getCurrentAddress();if(D===h.length-1&&(e.resolveAddress(ie-2),e.resolveAddress(ie-1),ie=we),e.emit(f.VNext,P,Q,0,null,0,`VNext Cursor ${D}`),e.emit(f.Goto,0,X,0,null,0,`Goto LoopStart ${D}`),e.resolveAddress(Q),Hl(t.from,D)==="left"&&te>0){let Ie=e.allocateAddress();if(e.emit(f.IfTrue,te,Ie,0,null,0,`LEFT JOIN EOF: Skip NULL pad if match found [${D}]`),N.forEach(_=>{_.sourceCursor===P&&e.emit(f.Null,0,_.targetReg,0,null,0,`LEFT JOIN EOF: NULL Pad Col ${_.sourceColumnIndex} from Cursor ${P}`)}),D>0){let _=ge[D-1];_>0&&e.emit(f.Integer,1,_,0,null,0,`Set LEFT JOIN Match Flag [${D-1}] = 1 (due to NULL pad EOF)`)}e.emit(f.Goto,0,ce,0,null,0,`LEFT JOIN EOF: Process NULL-padded row [${D}]`),e.resolveAddress(Ie)}te>0&&e.emit(f.Integer,0,te,0,null,0,`Reset LEFT JOIN Match Flag [${D}] before outer VNext/EOF`),Oe.delete(P)}if(a){let D=e.allocateAddress(),P=e.allocateAddress(),X=e.allocateMemoryCells(1),Q=e.allocateMemoryCells(1),K=e.allocateMemoryCells(1);A=[];let te=C;n&&t.groupBy.forEach((_,ne)=>{A.push({targetReg:te++,sourceCursor:-1,sourceColumnIndex:-1,expr:_})}),r.forEach(_=>{A.push({targetReg:te++,sourceCursor:-1,sourceColumnIndex:-1,expr:_.expr})}),S=A.length,S===0&&!n&&(S=1),e.columnAliases=A.map((_,ne)=>_.expr?.alias??(_.expr?.type==="column"?_.expr.name:`col${ne}`)),e.emit(f.AggIterate,X,0,0,null,0,"Start Aggregate Result Iteration"),e.resolveAddress(D),e.emit(f.AggNext,X,P,0,null,0,"Next Aggregate Group"),e.emit(f.AggKey,X,Q,0,null,0,"Get Group Key"),e.emit(f.AggContext,X,K,0,null,0,"Get Aggregate Context");let we=0,Ue=0;A.forEach(_=>{if(_.expr?.type==="function"&&_.expr.isAggregate){let ne=_.expr,mt={type:"funcdef",funcDef:e.db._findFunction(ne.name,ne.args.length),nArgs:ne.args.length};e.emit(f.AggFinal,K,0,_.targetReg,mt,0,`AggFinal for ${ne.name}`),Ue++}else if(n)e.emit(f.AggGroupValue,X,we,_.targetReg,null,0,`Output Group Key ${we}`),we++;else throw new Error("Internal: Unexpected column type in aggregate output loop")});let Ie=e.allocateAddress();if(t.having){let _=e.allocateMemoryCells(1),ne={finalColumnMap:A};e.compileExpression(t.having,_,void 0,ne),e.emit(f.IfFalse,_,Ie,0,null,0,"Check HAVING Clause")}if(g){let _=e.allocateMemoryCells(S+1);e.emit(f.Null,0,_,0,null,0,"Agg Sort: NULL Rowid"),e.emit(f.Move,C,_+1,S,null,0,"Agg Sort: Copy group result"),e.emit(f.VUpdate,S+1,_,v,{table:M},0,"Agg Sort: Insert Group Row")}else{let _=e.allocateAddress();if(O>0){let ne=e.allocateAddress();e.emit(f.IfZero,$,ne,0,null,0,"Agg Check Offset == 0"),e.emit(f.Subtract,1,$,$,null,0,"Agg Decrement Offset"),e.emit(f.Goto,0,_,0,null,0,"Agg Skip Row (Offset)"),e.resolveAddress(ne)}if(e.emit(f.ResultRow,C,S,0,null,0,"Output Aggregate Group Row"),O>0){let ne=e.allocateAddress();e.emit(f.IfZero,O,ne,0,null,0,"Agg Skip Limit Check if 0"),e.emit(f.Subtract,1,O,O,null,0,"Agg Decrement Limit"),e.emit(f.IfZero,O,P,0,null,0,"Agg Check Limit Reached"),e.resolveAddress(ne)}e.resolveAddress(_)}e.resolveAddress(Ie),e.emit(f.Goto,0,D,0,null,0,"Loop Aggregate Results"),e.resolveAddress(P)}if(g){let D=e.allocateAddress(),P=e.allocateAddress(),X=e.allocateMemoryCells(S);e.emit(f.Rewind,v,P,0,null,0,"Rewind Sorter"),e.resolveAddress(D);let Q=e.allocateAddress();if(O>0){let K=e.allocateAddress();e.emit(f.IfZero,$,K,0,null,0,"Sort Check Offset == 0"),e.emit(f.Subtract,1,$,$,null,0,"Sort Decrement Offset"),e.emit(f.Goto,0,Q,0,null,0,"Sort Skip Row (Offset)"),e.resolveAddress(K)}for(let K=0;K<S;K++)e.emit(f.VColumn,v,K,X+K,0,0,`Read Sorted Col ${K}`);if(e.emit(f.ResultRow,X,S,0,null,0,"Output sorted row"),O>0){let K=e.allocateAddress();e.emit(f.IfZero,O,K,0,null,0,"Sort Skip Limit Check if already 0"),e.emit(f.Subtract,1,O,O,null,0,"Sort Decrement Limit"),e.emit(f.IfZero,O,P,0,null,0,"Sort Check Limit Reached"),e.resolveAddress(K)}e.resolveAddress(Q),e.emit(f.VNext,v,P,0,null,0,"VNext Sorter"),e.emit(f.Goto,0,D,0,null,0,"Loop Sorter Results"),e.resolveAddress(P),e.emit(f.Close,v,0,0,null,0,"Close Sorter")}g||e.closeCursorsUsedBySelect(h),e.resultColumns=d,e.columnAliases=l}function nm(e,t){let{resultBaseReg:n,numCols:r,columnMap:s}=e.compileSelectCore(t,[]);if(e.columnAliases=s.map((o,a)=>o.expr?.alias??(o.expr?.type==="column"?o.expr.name:`col${a}`)),t.where){let o=e.allocateMemoryCells(1),a=e.allocateAddress();e.compileExpression(t.where,o),e.emit(f.IfFalse,o,a,0,null,0,"Check WHERE for constant SELECT"),e.emit(f.ResultRow,n,r,0,null,0,"Output constant result row"),e.resolveAddress(a)}else e.emit(f.ResultRow,n,r,0,null,0,"Output constant result row")}function Jl(e,t,n,r,s){let o=e.resultColumns,a=e.columnAliases;e.resultColumns=[],e.columnAliases=[];let i=new Set;t.from?.forEach(E=>{let y=I=>{if(I.type==="table"){let N=(I.alias||I.table.name).toLowerCase(),C=e.tableAliases.get(N);C!==void 0&&i.add(C)}else I.type==="join"&&(y(I.left),y(I.right))};y(E)});let u=new Set([...n,...i]),c=0;t.columns.some(E=>E.type==="all")&&u.forEach(E=>{let y=e.tableSchemas.get(E),I=[...e.tableAliases.entries()].find(([,C])=>C===E)?.[0],N=t.columns.find(C=>C.type==="all"&&C.table&&(C.table.toLowerCase()===y?.name.toLowerCase()||C.table.toLowerCase()===I?.toLowerCase()));y&&(!N||N.table)&&(c+=y?.columns.filter(C=>!C.hidden).length||0)}),c+=t.columns.filter(E=>E.type==="column").length,c===0&&(c=1);let l=e.allocateMemoryCells(c),h=0,p=[],g=l;for(let E of t.columns)if(E.type==="all")u.forEach(y=>{let I=e.tableSchemas.get(y),N=[...e.tableAliases.entries()].find(([,C])=>C===y)?.[0];I&&(!E.table||E.table.toLowerCase()===N?.toLowerCase()||E.table.toLowerCase()===I.name.toLowerCase())&&I.columns.forEach(C=>{if(!C.hidden){let S=g++,A=I.columnIndexMap.get(C.name.toLowerCase());if(A===void 0&&C.name.toLowerCase()!=="rowid")e.emit(f.Null,0,S,0,null,0,`Expand *: Col ${C.name} Idx Error`),p.push({targetReg:S,sourceCursor:y,sourceColumnIndex:-1});else{e.emit(f.VColumn,y,A??-1,S,0,0,`Expand *: ${N||I.name}.${C.name}`);let v={type:"column",name:C.name,table:N||I.name};p.push({targetReg:S,sourceCursor:y,sourceColumnIndex:A??-1,expr:v})}let L=`${N||I.name}.${C.name}`;e.resultColumns.push({name:L}),e.columnAliases.push(L),h++}})});else if(E.expr){let y=g++;e.compileExpression(E.expr,y,r,void 0,s);let I=-1,N=-1;if(E.expr.type==="column"){let S=E.expr;if(S.table)I=e.tableAliases.get(S.table.toLowerCase())??-1;else for(let A of u)if(e.tableSchemas.get(A)?.columnIndexMap.has(S.name.toLowerCase())){if(I!==-1){I=-1,N=-1;break}I=A}I!==-1&&(N=e.tableSchemas.get(I)?.columnIndexMap.get(S.name.toLowerCase())??-1)}p.push({targetReg:y,sourceCursor:I,sourceColumnIndex:N,expr:E.expr});let C=E.alias||(E.expr.type==="column"?E.expr.name:`col${h+1}`);e.columnAliases.push(C),e.resultColumns.push({name:C,expr:E.expr}),h++}return e.resultColumns=o,e.columnAliases=a,{resultBaseReg:l,numCols:h,columnMap:p}}function rm(e,t,n,r){if(!e||e.length!==1||e[0].type!=="join")return;let s=(o,a)=>{if(o.type==="table")return{node:null,nextLevel:a+1};if(o.type==="join"){let i=s(o.left,a);if(i.node)return i;let u=s(o.right,i.nextLevel);return u.node?u:i.nextLevel-1===t&&u.nextLevel-1===n?{node:o,nextLevel:u.nextLevel}:{node:null,nextLevel:u.nextLevel}}else throw new Error("Invalid node type in FROM clause during join node search")};return s(e[0],0).node??void 0}function Hl(e,t){if(t===0||!e||e.length===0)return;let n=(s,o)=>{if(s.type==="table")return{joinNode:null,nextLevel:o+1};if(s.type==="join"){let a=n(s.left,o);if(a.joinNode)return a;let i=n(s.right,a.nextLevel);return i.joinNode?i:i.nextLevel-1===t?{joinNode:s,nextLevel:i.nextLevel}:{joinNode:null,nextLevel:i.nextLevel}}else throw new Error("Invalid node type in FROM clause during join type search")};return e.length>1?"cross":n(e[0],0).joinNode?.joinType}function sm(e,t,n,r){if(n.length<2)throw new Error("Internal: compileJoinCondition called with insufficient active cursors.");let s=n[n.length-2],o=n[n.length-1];if(t.condition){let a=e.allocateMemoryCells(1);e.compileExpression(t.condition,a),e.emit(f.IfFalse,a,r,0,null,0,"JOIN: Check ON Condition")}else if(t.columns){let a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1),u=e.allocateMemoryCells(1),c=e.tableSchemas.get(s),d=e.tableSchemas.get(o);if(!c||!d)throw new Error("Internal: Schema not found for USING clause cursors.");for(let l of t.columns){let h=c.columnIndexMap.get(l.toLowerCase()),p=d.columnIndexMap.get(l.toLowerCase());if(h===void 0||p===void 0)throw new b(`Column '${l}' specified in USING clause not found in both tables.`,w.ERROR);e.emit(f.VColumn,s,h,i,0,0,`USING(${l}) Left`),e.emit(f.VColumn,o,p,u,0,0,`USING(${l}) Right`);let g=e.allocateAddress(),E=e.allocateAddress(),y=e.allocateMemoryCells(1);e.emit(f.IfNull,i,E,0,null,0,"USING: Skip if left NULL"),e.emit(f.IfNull,u,E,0,null,0,"USING: Skip if right NULL"),e.emit(f.Eq,i,g,u,null,0,`USING Compare ${l}`),e.emit(f.Integer,0,y,0,null,0),e.emit(f.Goto,0,E,0,null,0),e.resolveAddress(g),e.emit(f.Integer,1,y,0,null,0),e.resolveAddress(E),e.emit(f.IfFalse,y,r,0,null,0,`USING: Jump if ${l} not equal`)}}}function Ql(e,t,n){console.warn("compileSubquery assuming scalar context. EXISTS/IN should be handled by parent expression compiler."),e.compileScalarSubquery(t.query,n)}function eu(e,t,n){let r=new Set(e.tableAliases.values()),s=Et(e,t,r);s.isCorrelated?tu(e,t,n,s):am(e,t,n)}function am(e,t,n){if(t.columns.length!==1||t.columns[0].type==="all")throw new b("Scalar subquery must return exactly one column (cannot be *)",w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let r=e.allocateMemoryCells(1),s=e.allocateAddress(),o=e.allocateAddress(),a=e.allocateAddress(),i=e.allocateAddress(),u=e.allocateAddress();e.emit(f.Integer,0,r,0,null,0,"Init Subquery: hasRow=0");let c=[],{resultBaseReg:d,numCols:l}=e.compileSelectCore(t,c);if(l!==1)throw new Error("Scalar Subquery core compile error: Expected 1 column");let h=c[0];h===void 0?(e.emit(f.Integer,1,r,0,null,0,"Subquery: Set hasRow=1 (literal)"),e.emit(f.SCopy,d,n,0,null,0,"Subquery: Copy literal result"),e.emit(f.Goto,0,i,0,null,0,"Subquery: Finish (literal)")):(e.emit(f.VFilter,h,o,0,{idxNum:0,idxStr:null,nArgs:0},0,"Subquery: Start scan"),e.resolveAddress(s),e.emit(f.IfTrue,r,a,0,null,0,"Subquery: Check if >1 row"),e.emit(f.Integer,1,r,0,null,0,"Subquery: Set hasRow=1"),e.emit(f.SCopy,d,n,0,null,0,"Subquery: Copy row result"),e.emit(f.VNext,h,o,0,null,0,"Subquery: VNext"),e.emit(f.Goto,0,s,0,null,0,"Subquery: Loop"),e.resolveAddress(o)),e.closeCursorsUsedBySelect(c),e.emit(f.IfFalse,r,u,0,null,0,"Subquery: Check if hasRow is false (0 rows)"),e.emit(f.Goto,0,i,0,null,0,"Subquery: Finish (1 row)"),e.resolveAddress(a),e.emit(f.Halt,w.ERROR,0,0,"Scalar subquery returned more than one row",0,"Error: Subquery >1 row"),e.resolveAddress(u),e.emit(f.Null,0,n,0,null,0,"Subquery: Set NULL Result (0 rows)"),e.resolveAddress(i)}function tu(e,t,n,r){let s=e.subroutineDefs?.get(t);if(!s){e.startSubroutineCompilation();let p=e.getCurrentAddress(),g=2,E=3,y=4,I=4,N=new Map;r.correlatedColumns.forEach((Z,ge)=>{let Oe=-(ge+1);N.set(`${Z.outerCursor}.${Z.outerColumnIndex}`,Oe)});let C=[],{resultBaseReg:S,numCols:A}=e.compileSelectCore(t,C,r,N);if(A!==1)throw new b("Correlated scalar subquery must return one column",w.INTERNAL,void 0,t.loc?.start.line,t.loc?.start.column);let L=e.allocateAddress(),v=e.allocateAddress(),M=e.allocateAddress(),O=e.allocateAddress(),$=e.allocateAddress(),z=C[0];e.emit(f.Integer,0,E,0,null,0,"Sub: Init hasRow=0"),e.emit(f.Integer,0,y,0,null,0,"Sub: Init error=0");let ee=e.allocateAddress();z!==void 0?(e.emit(f.VFilter,z,v,0,{idxNum:0,idxStr:null,nArgs:0},0,"Sub: Start scan"),e.resolveAddress(L),e.emit(f.IfTrue,y,ee,0,null,0,"Sub: Skip if error already set"),e.emit(f.IfTrue,E,M,0,null,0,"Sub: Check if >1 row"),e.emit(f.Integer,1,E,0,null,0,"Sub: Set hasRow=1"),e.emit(f.SCopy,S,g,0,null,0,"Sub: Copy first row result"),e.emit(f.Goto,0,ee,0,null,0),e.resolveAddress(M),e.emit(f.Integer,1,y,0,null,0,"Sub: Set error=1 (>1 row)"),e.emit(f.Null,0,g,0,null,0,"Sub: Set NULL on >1 row error"),e.resolveAddress(ee),e.emit(f.VNext,z,v,0,null,0,"Sub: VNext"),e.emit(f.Goto,0,L,0,null,0,"Sub: Loop")):(e.emit(f.Integer,1,E,0,null,0,"Sub: Set hasRow=1 (literal)"),e.emit(f.SCopy,S,g,0,null,0,"Sub: Copy literal result"),e.emit(f.Goto,0,O-1,0,null,0)),e.resolveAddress(v),e.closeCursorsUsedBySelect(C),e.resolveAddress(e.getCurrentAddress()),e.emit(f.IfTrue,y,O,0,null,0,"Sub: Jump if error flag set"),e.emit(f.IfFalse,E,$,0,null,0,"Sub: Check if hasRow is false (0 rows)"),e.emit(f.Goto,0,O,0,null,0,"Sub: Finish (1 row, no error)"),e.resolveAddress($),e.emit(f.Null,0,g,0,null,0,"Sub: Set NULL result (0 rows)"),e.resolveAddress(O),e.emit(f.SCopy,g,-1,0,null,0,"Sub: Store result in Arg FP[-1]"),e.emit(f.SCopy,y,-2,0,null,0,"Sub: Store error in Arg FP[-2]"),e.emit(f.FrameLeave,0,0,0,null,0,"Leave Subroutine Frame"),e.emit(f.Return,0,0,0,null,0,"Return from subquery"),s={startAddress:p,correlation:r},e.subroutineDefs?.set(t,s),e.endSubroutineCompilation()}let o=r.correlatedColumns.length,a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1);r.correlatedColumns.forEach(p=>{let g=e.allocateMemoryCells(1),E=[...e.tableAliases.entries()].find(([C,S])=>S===p.outerCursor)?.[0],y=e.tableSchemas.get(p.outerCursor);if(!y)throw new Error(`Internal: Schema for outer cursor ${p.outerCursor} not found`);let I=y.columns[p.outerColumnIndex]?.name;if(!I)throw new Error(`Internal: Column index ${p.outerColumnIndex} not found for outer cursor ${p.outerCursor}`);let N={type:"column",name:I,table:E};e.compileExpression(N,g),e.emit(f.Push,g,0,0,null,0,`Push outer val ${I}`)}),e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub Error Status"),e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub Result");let u=o+2;e.emit(f.Subroutine,u,s.startAddress,0,null,0,"Call correlated subquery");let c=e.stackPointer-1,d=e.stackPointer-2;e.emit(f.SCopy,c,a,0,null,0,`Copy sub result from stack[${c}]`),e.emit(f.SCopy,d,i,0,null,0,`Copy sub error from stack[${d}]`),e.emit(f.StackPop,u,0,0,null,0,"Pop subquery args/results");let l=e.allocateAddress(),h=e.allocateAddress();e.emit(f.IfZero,i,l,0,null,0,"Check subquery error flag"),e.emit(f.Halt,w.ERROR,0,0,"Correlated scalar subquery returned multiple rows",0,"Error: Subquery >1 row"),e.resolveAddress(l),e.emit(f.SCopy,a,n,0,null,0,"Copy final subquery result"),e.resolveAddress(h)}function nu(e,t,n,r,s){if(n.columns.length!==1||n.columns[0].type==="all")throw new b("Subquery for IN operator must return exactly one column (cannot be *)",w.ERROR,void 0,n.loc?.start.line,n.loc?.start.column);let o=Et(e,n,new Set(e.tableAliases.values()));o.isCorrelated?lm(e,t,n,r,s,o):im(e,t,n,r,s)}function im(e,t,n,r,s){let o=e.allocateMemoryCells(1),a=e.allocateMemoryCells(1),i=e.allocateMemoryCells(1),u=e.allocateMemoryCells(1),c=e.allocateCursor(),d=e.allocateAddress(),l=e.allocateAddress(),h=e.allocateAddress(),p=e.allocateAddress(),g=e.allocateAddress(),E=e.allocateAddress(),y=e.allocateAddress(),I=e.allocateAddress();e.emit(f.Integer,0,i,0,null,0,"IN: Init hasNull=0"),e.emit(f.Integer,0,u,0,null,0,"IN: Init matchFound=0"),e.compileExpression(t,o),e.emit(f.IfNull,o,E,0,null,0,"IN: Check if Left Expr is NULL (early exit)"),e.emit(f.OpenEphemeral,c,1,0,null,0,"IN: Open Ephemeral Table");let N=e.createEphemeralSchema(c,1),C=[],{resultBaseReg:S,numCols:A}=e.compileSelectCore(n,C);if(A!==1)throw new Error("IN Subquery core compile error");let L=C[0],v=e.allocateAddress(),M=e.allocateAddress(),O=e.allocateMemoryCells(2);L===void 0?(e.emit(f.IfNull,S,y,0,null,0,"IN: Check literal NULL"),e.emit(f.Null,0,O,0,null,0),e.emit(f.SCopy,S,O+1,0,null,0),e.emit(f.VUpdate,2,O,0,{table:N},0,"IN: Insert literal"),e.emit(f.Goto,0,I,0,null,0),e.resolveAddress(y),e.emit(f.Integer,1,i,0,null,0,"IN: Set hasNull=1 (literal)"),e.resolveAddress(I)):(e.emit(f.VFilter,L,M,0,{idxNum:0,idxStr:null,nArgs:0},0,"IN: Subquery Scan Start"),e.resolveAddress(v),e.emit(f.IfNull,S,y,0,null,0,"IN: Check subquery NULL"),e.emit(f.Null,0,O,0,null,0,"IN: Prep Insert Rowid"),e.emit(f.SCopy,S,O+1,0,null,0,"IN: Prep Insert Value"),e.emit(f.VUpdate,2,O,0,{table:N},0,"IN: Insert subquery result"),e.emit(f.Goto,0,I,0,null,0),e.resolveAddress(y),e.emit(f.Integer,1,i,0,null,0,"IN: Set hasNull=1"),e.resolveAddress(I),e.emit(f.VNext,L,M,0,null,0,"IN: Subquery VNext"),e.emit(f.Goto,0,v,0,null,0,"IN: Subquery Loop"),e.resolveAddress(M)),e.closeCursorsUsedBySelect(C),e.emit(f.Rewind,c,p,0,null,0,"IN: Rewind Ephemeral Table"),e.resolveAddress(d),e.emit(f.VColumn,c,0,a,0,0,"IN: Get value from Ephemeral"),e.emit(f.Eq,o,h,a,null,0,"IN: Compare values (jump if EQ)"),e.resolveAddress(l),e.emit(f.VNext,c,p,0,null,0,"IN: VNext Ephemeral"),e.emit(f.Goto,0,d,0,null,0,"IN: Loop Ephemeral Scan"),e.resolveAddress(h),e.emit(f.IfNull,o,E,0,null,0,"IN: If left was NULL, result is NULL"),e.emit(f.IfNull,a,E,0,null,0,"IN: If matching eph val was NULL, result is NULL"),e.emit(f.Integer,1,u,0,null,0,"IN: Set matchFound=1"),e.emit(f.Goto,0,p,0,null,0,"IN: Jump to end (match found)"),e.resolveAddress(p),e.closeCursorsUsedBySelect([c]);let $=s?0:1,z=s?1:0,ee=e.allocateAddress(),Z=e.allocateAddress();e.emit(f.IfTrue,u,Z,0,null,0),e.emit(f.IfTrue,i,E,0,null,0,"IN: Check if NULL present (no match)"),e.resolveAddress(ee),e.emit(f.Integer,z,r,0,null,0,`IN: Set Final Result (${z})`),e.emit(f.Goto,0,g,0,null,0,"IN: Jump to final"),e.resolveAddress(Z),e.emit(f.Integer,$,r,0,null,0,`IN: Set Final Result (${$})`),e.emit(f.Goto,0,g,0,null,0),e.resolveAddress(E),e.emit(f.Null,0,r,0,null,0,"IN: Set NULL Result"),e.resolveAddress(g)}function lm(e,t,n,r,s,o){let a=e.subroutineDefs?.get(n);if(!a){e.startSubroutineCompilation();let h=e.getCurrentAddress(),p=2,g=3,E=4,y=new Map;y.set("_caller_left_expr_",-1),o.correlatedColumns.forEach((ie,ce)=>{y.set(`${ie.outerCursor}.${ie.outerColumnIndex}`,-(ce+2))});let I=[],{resultBaseReg:N,numCols:C}=e.compileSelectCore(n,I,o,y);if(C!==1)throw new b("Correlated IN subquery requires 1 column",w.INTERNAL,void 0,n.loc?.start.line,n.loc?.start.column);let S=e.allocateAddress(),A=e.allocateAddress(),L=e.allocateAddress(),v=e.allocateAddress(),M=e.allocateAddress(),O=e.allocateAddress(),$=I[0];if(e.emit(f.Integer,0,p,0,null,0,"SubIN: Init match=0"),e.emit(f.Integer,0,g,0,null,0,"SubIN: Init hasNull=0"),$!==void 0)e.emit(f.VFilter,$,A,0,{idxNum:0,idxStr:null,nArgs:0},0,"SubIN: Start scan"),e.resolveAddress(S),e.emit(f.SCopy,N,E,0,null,0,"SubIN: Get subquery value"),e.emit(f.IfNull,E,v,0,null,0,"SubIN: Check if subquery value is NULL"),e.emit(f.Eq,-1,L,E,null,0,"SubIN: Compare with Arg (Jump if EQ)"),e.emit(f.Goto,0,M,0,null,0),e.resolveAddress(v),e.emit(f.Integer,1,g,0,null,0,"SubIN: Set hasNull=1"),e.emit(f.Goto,0,M,0,null,0),e.resolveAddress(L),e.emit(f.Integer,1,p,0,null,0,"SubIN: Set match=1"),e.resolveAddress(M),e.emit(f.VNext,$,A,0,null,0,"SubIN: VNext"),e.emit(f.Goto,0,S,0,null,0,"SubIN: Loop");else{e.emit(f.SCopy,N,E,0,null,0,"SubIN: Get literal subquery value");let ie=e.allocateAddress(),ce=e.allocateAddress();e.emit(f.IfNull,E,ie,0,null,0),e.emit(f.Eq,-1,ce,E,null,0),e.emit(f.Goto,0,A,0,null,0),e.resolveAddress(ce),e.emit(f.Integer,1,p,0,null,0),e.emit(f.Goto,0,A,0,null,0),e.resolveAddress(ie),e.emit(f.Integer,1,g,0,null,0)}e.resolveAddress(A),e.closeCursorsUsedBySelect(I);let z=s?0:1,ee=s?1:0,Z=e.allocateAddress(),ge=e.allocateAddress(),Oe=e.allocateAddress();e.emit(f.IfTrue,p,Oe,0,null,0),e.emit(f.IfTrue,g,ge,0,null,0),e.resolveAddress(Z),e.emit(f.Integer,ee,-1,0,null,0,"SubIN: Set Final False/True"),e.emit(f.Goto,0,ge+1,0,null,0),e.resolveAddress(Oe),e.emit(f.Integer,z,-1,0,null,0,"SubIN: Set Final True/False"),e.emit(f.Goto,0,ge,0,null,0),e.resolveAddress(ge),e.emit(f.Null,0,-1,0,null,0,"SubIN: Set Final NULL"),e.resolveAddress(e.getCurrentAddress()),e.emit(f.FrameLeave,0,0,0,null,0,"Leave SubIN Frame"),e.emit(f.Return,0,0,0,null,0,"Return from SubIN"),a={startAddress:h,correlation:o},e.subroutineDefs?.set(n,a),e.endSubroutineCompilation()}let i=e.allocateMemoryCells(1),u=e.allocateAddress(),c=e.allocateAddress();e.compileExpression(t,i),e.emit(f.IfNull,i,u,0,null,0,"IN: Check if Left Expr is NULL");let d=0;o.correlatedColumns.forEach((h,p)=>{let g=e.allocateMemoryCells(1),E=[...e.tableAliases.entries()].find(([N,C])=>C===h.outerCursor)?.[0],y=e.tableSchemas.get(h.outerCursor);if(!y)throw new Error(`Schema ${h.outerCursor} not found`);let I=y.columns[h.outerColumnIndex]?.name;if(!I)throw new Error(`Col ${h.outerColumnIndex} not found`);e.compileExpression({type:"column",name:I,table:E},g),e.emit(f.Push,g,0,0,null,0,`Push outer val ${I}`),d++}),e.emit(f.Push,i,0,0,null,0,"Push Left Value for SubIN"),d++,e.emit(f.Subroutine,d,a.startAddress,0,null,0,"Call SubIN");let l=e.stackPointer-1;e.emit(f.SCopy,l,r,0,null,0,"Copy SubIN result from stack"),e.emit(f.StackPop,d,0,0,null,0,"Pop SubIN args"),e.emit(f.Goto,0,c,0,null,0),e.resolveAddress(u),e.emit(f.Null,0,r,0,null,0,"IN: Set NULL Result"),e.resolveAddress(c)}function ru(e,t,n,r,s){let o=Et(e,r,new Set(e.tableAliases.values()));o.isCorrelated?cm(e,t,n,r,s,o):um(e,t,n,r,s)}function um(e,t,n,r,s){let o=e.allocateMemoryCells(1),a=e.allocateMemoryCells(1),i=e.allocateAddress(),u=e.allocateAddress(),c=e.allocateAddress(),d;switch(e.compileExpression(t,o),e.emit(f.IfNull,o,i,0,null,0,"Skip compare if left is NULL"),e.compileScalarSubquery(r,a),e.emit(f.IfNull,a,i,0,null,0,"Skip compare if subquery is NULL"),n.toUpperCase()){case"=":case"==":case"IS":d=f.Eq;break;case"!=":case"<>":case"IS NOT":d=f.Ne;break;case"<":d=f.Lt;break;case"<=":d=f.Le;break;case">":d=f.Gt;break;case">=":d=f.Ge;break;default:throw new b(`Unsupported comparison operator with subquery: ${n}`,w.ERROR,void 0,r.loc?.start.line,r.loc?.start.column)}e.emit(d,a,u,o,null,0,"Compare Subquery Result"),e.emit(f.Integer,0,s,0,null,0,"Set comparison FALSE"),e.emit(f.Goto,0,c,0,null,0),e.resolveAddress(u),e.emit(f.Integer,1,s,0,null,0,"Set comparison TRUE"),e.emit(f.Goto,0,c,0,null,0),e.resolveAddress(i),e.emit(f.Null,0,s,0,null,0,"Set comparison NULL"),e.resolveAddress(c)}function cm(e,t,n,r,s,o){let a=e.subroutineDefs?.get(r);if(!a){let I=e.allocateMemoryCells(1);if(tu(e,r,I,o),a=e.subroutineDefs?.get(r),!a)throw new Error("Internal: Failed to compile correlated scalar subquery subroutine.")}let i=e.allocateMemoryCells(1),u=e.allocateMemoryCells(1),c=e.allocateMemoryCells(1),d=e.allocateAddress(),l=e.allocateAddress(),h=e.allocateAddress();e.compileExpression(t,i),e.emit(f.IfNull,i,d,0,null,0,"Skip compare if left is NULL");let p=0;o.correlatedColumns.forEach(I=>{let N=e.allocateMemoryCells(1),C=[...e.tableAliases.entries()].find(([L,v])=>v===I.outerCursor)?.[0],S=e.tableSchemas.get(I.outerCursor);if(!S)throw new Error(`Schema ${I.outerCursor} not found`);let A=S.columns[I.outerColumnIndex]?.name;if(!A)throw new Error(`Col ${I.outerColumnIndex} not found`);e.compileExpression({type:"column",name:A,table:C},N),e.emit(f.Push,N,0,0,null,0,`Push outer val ${A}`),p++}),e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub Error Status"),p++,e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub Result"),p++,e.emit(f.Subroutine,p,a.startAddress,0,null,0,"Call correlated subquery for comparison");let g=e.stackPointer-1,E=e.stackPointer-2;e.emit(f.SCopy,g,u,0,null,0,`Copy sub result from stack[${g}]`),e.emit(f.SCopy,E,c,0,null,0,`Copy sub error from stack[${E}]`),e.emit(f.StackPop,p,0,0,null,0,"Pop subquery args/results"),e.emit(f.IfTrue,c,d,0,null,0,"Skip compare if subquery had error (>1 row)"),e.emit(f.IfNull,u,d,0,null,0,"Skip compare if subquery result is NULL (0 rows)");let y;switch(n.toUpperCase()){case"=":case"==":case"IS":y=f.Eq;break;case"!=":case"<>":case"IS NOT":y=f.Ne;break;case"<":y=f.Lt;break;case"<=":y=f.Le;break;case">":y=f.Gt;break;case">=":y=f.Ge;break;default:throw new b(`Unsupported comparison operator with subquery: ${n}`,w.ERROR,void 0,r.loc?.start.line,r.loc?.start.column)}e.emit(y,u,l,i,null,0,"Compare Left Expr with Sub Result"),e.emit(f.Integer,0,s,0,null,0,"Set comparison FALSE"),e.emit(f.Goto,0,h,0,null,0),e.resolveAddress(l),e.emit(f.Integer,1,s,0,null,0,"Set comparison TRUE"),e.emit(f.Goto,0,h,0,null,0),e.resolveAddress(d),e.emit(f.Null,0,s,0,null,0,"Set comparison NULL"),e.resolveAddress(h)}function su(e,t,n){let r=Et(e,t,new Set(e.tableAliases.values()));r.isCorrelated?dm(e,t,n,r):fm(e,t,n)}function fm(e,t,n){let r=e.allocateAddress(),s=e.allocateAddress(),o=e.allocateAddress(),a=e.allocateAddress(),i=e.allocateAddress(),u=e.compileFromCore(t.from),c=u[0];if(c===void 0){if(t.where){let d=e.allocateMemoryCells(1);e.compileExpression(t.where,d),e.emit(f.IfFalse,d,s,0,null,0,"EXISTS: Check constant WHERE")}e.emit(f.Integer,1,n,0,null,0,"EXISTS: Literal/No-FROM subquery is TRUE"),e.emit(f.Goto,0,o,0,null,0),e.resolveAddress(s),e.emit(f.Integer,0,n,0,null,0,"EXISTS: Set FALSE (constant WHERE failed)"),e.resolveAddress(o);return}if(e.emit(f.VFilter,c,s,0,{idxNum:0,idxStr:null,nArgs:0},0,"EXISTS: Start scan"),e.resolveAddress(a),t.where){let d=e.allocateMemoryCells(1);e.compileExpression(t.where,d),e.emit(f.IfFalse,d,i,0,null,0,"EXISTS: Check WHERE, jump to VNext if false")}e.emit(f.Integer,1,n,0,null,0,"EXISTS: Set TRUE (found row)"),e.emit(f.Goto,0,o,0,null,0,"EXISTS: Finish (found row)"),e.resolveAddress(i),e.emit(f.VNext,c,s,0,null,0,"EXISTS: VNext"),e.emit(f.Goto,0,a,0,null,0,"EXISTS: Loop back"),e.resolveAddress(s),e.emit(f.Integer,0,n,0,null,0,"EXISTS: Set FALSE (no rows found)"),e.resolveAddress(o),e.closeCursorsUsedBySelect(u)}function dm(e,t,n,r){let s=e.subroutineDefs?.get(t);if(!s){e.startSubroutineCompilation();let i=e.getCurrentAddress(),u=2,c=new Map;r.correlatedColumns.forEach((E,y)=>{c.set(`${E.outerCursor}.${E.outerColumnIndex}`,-(y+1))});let d=e.compileFromCore(t.from),l=d[0],h=e.allocateAddress(),p=e.allocateAddress(),g=e.allocateAddress();if(e.emit(f.Integer,0,u,0,null,0,"SubEXISTS: Init result=0"),l===void 0){if(t.where){let E=e.allocateMemoryCells(1);e.compileExpression(t.where,E,r,void 0,c),e.emit(f.IfFalse,E,p,0,null,0,"SubEXISTS: Check const WHERE")}e.emit(f.Integer,1,u,0,null,0,"SubEXISTS: Set result=1 (const)")}else{if(e.emit(f.VFilter,l,p,0,{idxNum:0,idxStr:null,nArgs:0},0,"SubEXISTS: Start scan"),e.resolveAddress(h),t.where){let E=e.allocateMemoryCells(1);e.compileExpression(t.where,E,r,void 0,c),e.emit(f.IfFalse,E,g,0,null,0,"SubEXISTS: Check WHERE")}e.emit(f.Integer,1,u,0,null,0,"SubEXISTS: Set result=1 (row found)"),e.emit(f.Goto,0,p,0,null,0,"SubEXISTS: Exit loop early"),e.resolveAddress(g),e.emit(f.VNext,l,p,0,null,0,"SubEXISTS: VNext"),e.emit(f.Goto,0,h,0,null,0,"SubEXISTS: Loop back")}e.resolveAddress(p),e.closeCursorsUsedBySelect(d),e.emit(f.SCopy,u,-1,0,null,0,"SubEXISTS: Store result in Arg FP[-1]"),e.emit(f.FrameLeave,0,0,0,null,0,"Leave SubEXISTS Frame"),e.emit(f.Return,0,0,0,null,0,"Return from SubEXISTS"),s={startAddress:i,correlation:r},e.subroutineDefs?.set(t,s),e.endSubroutineCompilation()}let o=0;r.correlatedColumns.forEach(i=>{let u=e.allocateMemoryCells(1),c=[...e.tableAliases.entries()].find(([h,p])=>p===i.outerCursor)?.[0],d=e.tableSchemas.get(i.outerCursor);if(!d)throw new Error(`Schema ${i.outerCursor} not found`);let l=d.columns[i.outerColumnIndex]?.name;if(!l)throw new Error(`Col ${i.outerColumnIndex} not found`);e.compileExpression({type:"column",name:l,table:c},u),e.emit(f.Push,u,0,0,null,0,`Push outer val ${l}`),o++}),e.emit(f.Push,0,0,0,null,0,"Push placeholder for Sub EXISTS Result (Arg 0)"),o++,e.emit(f.Subroutine,o,s.startAddress,0,null,0,"Call SubEXISTS");let a=e.stackPointer-1;e.emit(f.SCopy,a,n,0,null,0,"Copy SubEXISTS result from stack"),e.emit(f.StackPop,o,0,0,null,0,"Pop SubEXISTS args")}function au(e,t,n){let r=t.name.toLowerCase();if(console.log(`Compiling CTE: ${r}, Recursive Context: ${n}`),n&&ou(e,t,r)){console.log(`Compiling RECURSIVE CTE: ${r}`),pm(e,t);return}if(!n&&ou(e,t,r))throw new b(`Recursive CTE '${r}' used without 'RECURSIVE' keyword`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);console.log(`Compiling Non-Recursive CTE (Materializing): ${r}`),mm(e,t)}function mm(e,t){let n=t.name.toLowerCase(),r=as(e,["tableAliases","tableSchemas","ephemeralTables","cteMap","cursorPlanningInfo","resultColumns","columnAliases"]),s,o=-1,a;try{if(t.query.type==="select"){let i=Array.from(r.tableAliases?.values()??[]);a=e.compileSelectCore(t.query,i),o=e.allocateCursor();let u=a.columnMap.map((c,d)=>{let l=R.TEXT;c.expr?.type==="literal"&&(typeof c.expr.value=="number"&&(l=R.REAL),typeof c.expr.value=="bigint"&&(l=R.INTEGER),c.expr.value===null&&(l=R.NULL));let h=e.columnAliases[a.resultBaseReg+d]??`cte_col_${d}`;return{..._e(h),affinity:l}});s=e.createEphemeralSchema(o,a.numCols),s.columns=Object.freeze(u),s.columnIndexMap=Object.freeze(be(u)),console.log(`CTE '${n}': Inferred ${a.numCols} columns for ephemeral table ${o}`)}else throw new b(`CTE query type '${t.query.type}' not yet supported for materialization`,w.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column)}finally{is(e,r)}e.cteMap.set(n,{type:"materialized",cursorIdx:o,schema:s}),e.tableSchemas.set(o,s),e.ephemeralTables.set(o,s),e.emit(f.OpenWrite,o,s.columns.length,0,s,0,`OpenWrite Ephemeral CTE '${n}'`),Mo(e,t.query,o,s),console.log(`Finished compiling materialized CTE: ${n}`)}function pm(e,t){let n=t.name.toLowerCase();if(t.query.type!=="select"||!t.query.union&&!t.query.unionAll)throw new b(`Recursive CTE '${n}' must use UNION or UNION ALL`,w.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column);let r={...t.query,union:void 0,unionAll:void 0},s=t.query.union;if(!s)throw new b(`Recursive CTE '${n}' is missing the recursive part after UNION ALL`,w.ERROR,void 0,t.query.loc?.start.line,t.query.loc?.start.column);let o=t.query.unionAll??!1,a=e.allocateCursor(),i=e.allocateCursor(),u=as(e,["tableAliases","tableSchemas","ephemeralTables","cteMap","cursorPlanningInfo","resultColumns","columnAliases"]),c,d,l;try{l=e.compileSelectCore(r,Array.from(u.tableAliases?.values()??[]));let y=[],I;if(!o){for(let C=0;C<l.numCols;C++)y.push({index:C,desc:!1});I={type:"sortkey",keyIndices:y.map(C=>C.index),directions:y.map(C=>C.desc)},console.log(`Recursive CTE '${n}': Using UNION (distinct), creating PK on all columns for Result table ${a}`)}c=e.createEphemeralSchema(a,l.numCols,I),d=e.createEphemeralSchema(i,l.numCols);let N=l.columnMap.map((C,S)=>{let A=R.TEXT;C.expr?.type==="literal"&&(typeof C.expr.value=="number"&&(A=R.REAL),typeof C.expr.value=="bigint"&&(A=R.INTEGER),C.expr.value===null&&(A=R.NULL));let L=e.columnAliases[l.resultBaseReg+S]??`cte_col_${S}`;return{..._e(L),affinity:A}});c.columns=Object.freeze(N),c.columnIndexMap=Object.freeze(be(N)),d.columns=Object.freeze(N),d.columnIndexMap=Object.freeze(be(N))}finally{is(e,u)}e.cteMap.set(n,{type:"materialized",cursorIdx:a,schema:c}),e.tableSchemas.set(a,c),e.ephemeralTables.set(a,c),e.ephemeralTables.set(i,d),e.emit(f.OpenWrite,a,c.columns.length,0,c,0,`OpenWrite REC CTE Result '${n}'`),e.emit(f.OpenWrite,i,d.columns.length,0,d,0,`OpenWrite REC CTE Queue '${n}'`),console.log(`REC CTE '${n}': Compiling initial term...`),Mo(e,r,a,c,!0,i,d,!0),console.log(`REC CTE '${n}': Compiling recursive loop...`);let h=e.getCurrentAddress(),p=e.allocateAddress(),g=e.allocateAddress();e.emit(f.Rewind,i,g,0,null,0,"REC CTE: Rewind Queue"),e.resolveAddress(p),e.emit(f.VNext,i,g,0,null,0,"REC CTE: VNext Queue");let E=as(e,["tableAliases","tableSchemas","cteMap","ephemeralTables","cursorPlanningInfo"]);try{e.cteMap.set(n,{type:"materialized",cursorIdx:i,schema:d}),e.tableAliases.set(n,i),e.tableSchemas.set(i,d),console.log(`REC CTE '${n}': Mapping self-reference to QUEUE cursor ${i}`),Mo(e,s,a,c,!0,i,d,o)}finally{console.log(`REC CTE '${n}': Restoring state after recursive step compilation.`),is(e,E)}e.emit(f.Goto,0,p,0,null,0,"REC CTE: Loop back"),e.resolveAddress(g),e.emit(f.Close,i,0,0,null,0,`Close REC CTE Queue '${n}'`),e.ephemeralTables.delete(i),console.log(`Finished compiling recursive CTE: ${n}`)}function Mo(e,t,n,r,s=!1,o,a,i=!0){let u=as(e,["tableAliases","tableSchemas","ephemeralTables","cursorPlanningInfo"]),c=0,d=0,l=[];try{l=e.compileFromCore(t.from);let h=new Set(Array.from(e.tableAliases.values()));l.forEach(v=>{let M=e.tableSchemas.get(v);M&&e.planTableAccess(v,M,t,h)});let p=[],g=[],E=e.allocateAddress(),y=new Set;l.length===0?e.resolveAddress(E):l.forEach((v,M)=>{if(!e.tableSchemas.get(v))throw new Error(`Internal: Schema missing for query cursor ${v}`);let $=e.allocateAddress(),z=e.allocateAddress();p.push($),g.push(z);let ee=e.cursorPlanningInfo.get(v),Z={idxNum:0,idxStr:null,nArgs:0},ge=0;if(ee&&ee.idxNum!==0){let Oe=[];ee.usage.forEach((ce,xt)=>{if(ce.argvIndex>0){let nn=ee.constraintExpressions?.get(xt);if(!nn)throw new b(`Internal error: Missing expression for constraint ${xt} used in CTE pop VFilter`,w.INTERNAL);for(;Oe.length<ce.argvIndex;)Oe.push(null);Oe[ce.argvIndex-1]={constraintIdx:xt,expr:nn}}});let ie=Oe.filter(ce=>ce!==null);ie.length>0&&(ge=e.allocateMemoryCells(ie.length),ie.forEach((ce,xt)=>{let nn=Et(e,ce.expr,y);e.compileExpression(ce.expr,ge+xt,nn)})),Z={idxNum:ee.idxNum,idxStr:ee.idxStr,nArgs:ie.length}}e.emit(f.VFilter,v,z,ge,Z,0,`Populate Ephemeral: Scan Cursor ${M}`),e.resolveAddress($),e.verifyWhereConstraints(v,z),y.add(v),M===l.length-1&&e.resolveAddress(E)});let I=e.allocateAddress();rn(e,t.where,l,I);let N=e.compileSelectCore(t,Array.from(y));if(c=N.resultBaseReg,d=N.numCols,d!==r.columns.length)throw new b(`CTE column count mismatch during population: expected ${r.columns.length}, got ${d}`,w.ERROR,void 0,t.loc?.start.line,t.loc?.start.column);let C=e.allocateMemoryCells(d+1);e.emit(f.Null,0,C,0,null,0,"Populate Eph: Rowid=NULL"),e.emit(f.Move,c,C+1,d,null,0,"Populate Eph: Copy Result");let S=i?W.ABORT:W.IGNORE,A={table:r,onConflict:S},L=e.allocateMemoryCells(1);if(e.emit(f.Integer,-1,L,0,null,0,"Populate Eph: Init target rowid check"),e.emit(f.VUpdate,d+1,C,L,A,0,`Populate Eph: Insert Target ${n}`),s&&o!==void 0&&a){let v=e.allocateAddress();i||e.emit(f.IfNull,L,v,0,null,0,"Populate Eph: Skip queue if target insert ignored");let M={table:a,onConflict:W.ABORT};e.emit(f.VUpdate,d+1,C,0,M,0,`Populate Eph: Insert Queue ${o}`),e.resolveAddress(v)}if(e.resolveAddress(I),l.length>0)for(let v=l.length-1;v>=0;v--){let M=l[v],O=p[v],$=g[v];e.emit(f.Goto,0,O-1,0,null,0,`Populate Eph: Goto VNext ${v}`),e.resolveAddress($),y.delete(M)}}finally{e.closeCursorsUsedBySelect(l),is(e,u)}}function as(e,t){let n={};for(let r of t){let s=e[r];s instanceof Map?n[r]=new Map(s):Array.isArray(s)?n[r]=[...s]:n[r]=s}return n}function is(e,t){for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}function ou(e,t,n){if(t.query.type!=="select")return!1;let r=t.query;if(r.union){let s=o=>{if(!o)return!1;if(o.type==="table"){if(o.table.name.toLowerCase()===n.toLowerCase())return!0}else if(o.type==="join")return s(o.left)||s(o.right);return!1};return r.union.from?.some(s)??!1}return!1}var Sn=class{db;sql="";constants=[];instructions=[];numMemCells=0;currentFrameLocals=0;numCursors=0;parameters=new Map;columnAliases=[];cteMap=new Map;tableSchemas=new Map;tableAliases=new Map;ephemeralTables=new Map;resultColumns=[];cursorPlanningInfo=new Map;subroutineCode=[];subroutineDefs=new Map;subroutineDepth=0;currentFrameEnterInsn=null;maxLocalOffsetInCurrentFrame=0;stackPointer=0;framePointer=0;outerCursors=[];constructor(t){this.db=t}compile(t,n){try{this.sql=n,this.constants=[],this.instructions=[],this.numMemCells=0,this.numCursors=0,this.parameters=new Map,this.columnAliases=[],this.cteMap=new Map,this.tableSchemas=new Map,this.tableAliases=new Map,this.ephemeralTables=new Map,this.resultColumns=[],this.cursorPlanningInfo=new Map,this.subroutineCode=[],this.subroutineDefs=new Map,this.subroutineDepth=0,this.currentFrameLocals=0,this.currentFrameEnterInsn=null,this.maxLocalOffsetInCurrentFrame=0,this.stackPointer=0,this.framePointer=0,this.outerCursors=[],this.emit(f.Init,0,1,0,null,0,"Start of program");let r;switch("withClause"in t&&t.withClause!==void 0&&(r=t.withClause,this.compileWithClause(r)),t.type){case"select":this.compileSelect(t);break;case"insert":this.compileInsert(t);break;case"update":this.compileUpdate(t);break;case"delete":this.compileDelete(t);break;case"createTable":this.compileCreateTable(t);break;case"createIndex":this.compileCreateIndex(t);break;case"createView":this.compileCreateView(t);break;case"drop":this.compileDrop(t);break;case"alterTable":this.compileAlterTable(t);break;case"begin":this.compileBegin(t);break;case"commit":this.compileCommit(t);break;case"rollback":this.compileRollback(t);break;case"savepoint":this.compileSavepoint(t);break;case"release":this.compileRelease(t);break;case"pragma":this.compilePragma(t);break;default:throw new b(`Unsupported statement type: ${t.type}`,w.ERROR)}return this.subroutineCode.length>0&&(this.instructions.push(...this.subroutineCode),this.subroutineCode=[]),this.emit(f.Halt,w.OK,0,0,null,0,"End of program"),{instructions:this.instructions,constants:this.constants,numMemCells:this.numMemCells+1,numCursors:this.numCursors,parameters:this.parameters,columnNames:this.columnAliases,sql:this.sql}}catch(r){throw r instanceof Zr?new b(r.message,w.ERROR,r,r.line,r.column):r instanceof b?r:new b(`Unexpected compiler error: ${r instanceof Error?r.message:String(r)}`,w.INTERNAL,r instanceof Error?r:void 0)}}startSubroutineCompilation(){this.subroutineDepth++,this.maxLocalOffsetInCurrentFrame=0;let t=Nn(f.FrameEnter,0,0,0,null,0,`Enter Subroutine Frame Depth ${this.subroutineDepth}`);this.subroutineCode.push(t);let n=this.subroutineCode.length-1;return this.currentFrameEnterInsn=t,n}endSubroutineCompilation(){if(this.subroutineDepth>0){if(this.currentFrameEnterInsn){let t=this.maxLocalOffsetInCurrentFrame+1;this.currentFrameEnterInsn.p1=t,this.currentFrameEnterInsn=null}else console.error("Compiler Error: Mismatched start/endSubroutineCompilation or missing FrameEnter tracking.");this.subroutineDepth--}else console.warn("Attempted to end subroutine compilation at depth 0")}allocateMemoryCells(t){return bl(this,t)}allocateCursor(){return Nl(this)}addConstant(t){return Cl(this,t)}emit(t,n,r,s,o,a,i){return Sl(this,t,n,r,s,o,a,i)}allocateAddress(){return Rl(this)}resolveAddress(t){Al(this,t)}getCurrentAddress(){return Tl(this)}createEphemeralSchema(t,n,r){return Ll(this,t,n,r)}closeCursorsUsedBySelect(t){Ol(this,t)}compileFromCore(t){return Bl(this,t)}planTableAccess(t,n,r,s){_l(this,t,n,r,s)}verifyWhereConstraints(t,n){Vl(this,t,n)}compileExpression(t,n,r,s,o){Gl(this,t,n,r,s,o)}compileLiteral(t,n){Qr(this,t,n)}compileColumn(t,n,r,s,o){ur(this,t,n,r,s,o)}compileBinary(t,n,r,s,o){es(this,t,n,r,s,o)}compileUnary(t,n,r,s,o){ts(this,t,n,r,s,o)}compileCast(t,n,r,s,o){ns(this,t,n,r,s,o)}compileCollate(t,n,r,s,o){os(this,t,n,r,s,o)}compileFunction(t,n,r,s,o){rs(this,t,n,r,s,o)}compileParameter(t,n){ss(this,t,n)}compileSubquery(t,n){Ql(this,t,n)}compileScalarSubquery(t,n){eu(this,t,n)}compileInSubquery(t,n,r,s){nu(this,t,n,r,s)}compileComparisonSubquery(t,n,r,s){ru(this,t,n,r,s)}compileExistsSubquery(t,n){su(this,t,n)}compileSelect(t){Xl(this,t)}compileInsert(t){ql(this,t)}compileUpdate(t){jl(this,t)}compileDelete(t){Yl(this,t)}compileCreateTable(t){xl(this,t)}compileCreateIndex(t){Ml(this,t)}compileCreateView(t){Dl(this,t)}compileDrop(t){Pl(this,t)}compileAlterTable(t){kl(this,t)}compileBegin(t){Fl(this,t)}compileCommit(t){Ul(this,t)}compileRollback(t){Wl(this,t)}compileSavepoint(t){zl(this,t)}compileRelease(t){Zl(this,t)}compileSelectCore(t,n,r,s){return Jl(this,t,n,r,s)}compileWithClause(t){if(t){console.log(`Compiling WITH${t.recursive?" RECURSIVE":""} clause...`);for(let n of t.ctes){let r=n.name.toLowerCase();if(this.cteMap.has(r))throw new b(`Duplicate CTE name: '${n.name}'`,w.ERROR);au(this,n,t.recursive)}console.log("Finished compiling WITH clause.")}}compilePragma(t){$l(this,t)}};var ls=new Map,Do=(e,t)=>e<t?-1:e>t?1:0,lu=(e,t)=>{let n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:0},uu=(e,t)=>{let n=e.length,r=t.length;for(;n>0&&e[n-1]===" ";)n--;for(;r>0&&t[r-1]===" ";)r--;let s=Math.min(n,r);for(let o=0;o<s;o++)if(e[o]!==t[o])return e[o]<t[o]?-1:1;return n-r};function cr(e,t){let n=e.toUpperCase();ls.has(n)&&console.warn(`Overwriting existing collation: ${n}`),ls.set(n,t)}function cu(e){return ls.get(e.toUpperCase())}function Po(e){if(e==null)return!1;switch(typeof e){case"boolean":return e;case"number":return e!==0;case"bigint":return e!==0n;case"string":return e.length>0;case"object":return e instanceof Uint8Array,!1;default:return!1}}var Ne;(function(e){e[e.NULL=0]="NULL",e[e.NUMERIC=1]="NUMERIC",e[e.TEXT=2]="TEXT",e[e.BLOB=3]="BLOB",e[e.UNKNOWN=99]="UNKNOWN"})(Ne||(Ne={}));function iu(e){if(e==null)return Ne.NULL;let t=typeof e;return t==="number"||t==="bigint"||t==="boolean"?Ne.NUMERIC:t==="string"?Ne.TEXT:t==="object"&&e instanceof Uint8Array?Ne.BLOB:Ne.UNKNOWN}function fe(e,t,n="BINARY"){let r=iu(e),s=iu(t);if(r===Ne.NULL&&s===Ne.NULL)return 0;if(r===Ne.NULL)return-1;if(s===Ne.NULL)return 1;if(r!==s)return r-s;let o=typeof e=="boolean"?e?1:0:e,a=typeof t=="boolean"?t?1:0:t;switch(r){case Ne.NUMERIC:return o<a?-1:o>a?1:0;case Ne.TEXT:let i=ls.get(n.toUpperCase());return i?i(o,a):(console.warn(`Unknown collation requested: ${n}. Falling back to BINARY.`),Do(o,a));case Ne.BLOB:let u=o,c=a,d=Math.min(u.length,c.length);for(let l=0;l<d;l++)if(u[l]!==c[l])return u[l]<c[l]?-1:1;return u.length<c.length?-1:u.length>c.length?1:0;default:return 0}}function fu(e){if(e=e.trim(),!e)return null;let t=e.startsWith("-")?-1:(e.startsWith("+"),1);t!==1&&(e=e.substring(1));let n="";for(let r=0;r<e.length&&(e[r]>="0"&&e[r]<="9");r++)n+=e[r];if(!n)return null;try{let r=BigInt(n)*BigInt(t);return r>=Number.MIN_SAFE_INTEGER&&r<=Number.MAX_SAFE_INTEGER?Number(r):r}catch{return null}}function ko(e){if(e=e.trim(),!e)return null;let t=parseFloat(e);return isNaN(t)?null:t}function Fo(e){if(e===null||typeof e=="bigint")return e;if(typeof e=="number"){let t=Math.trunc(e);if(t>=Number.MIN_SAFE_INTEGER&&t<=Number.MAX_SAFE_INTEGER)return t;try{return BigInt(t)}catch{return e}}if(typeof e=="string"){let t=fu(e);if(t!==null)return t;let n=ko(e);return n!==null?Fo(n):null}return e instanceof Uint8Array?null:e}function du(e){return e===null?null:typeof e=="number"||typeof e=="bigint"?Number(e):typeof e=="string"?ko(e):e instanceof Uint8Array?null:e}function hu(e){if(e===null||typeof e=="number"||typeof e=="bigint")return e;if(typeof e=="string"){let t=fu(e);if(t!==null)return t;let n=ko(e);return n!==null?n:e}return e instanceof Uint8Array,e}function mu(e){return e===null||typeof e=="string"?e:typeof e=="number"||typeof e=="bigint"?String(e):e instanceof Uint8Array?e:String(e)}function pu(e){return e}var yt=class{_result=void 0;_result_set=!1;_error=null;_subtype=0;userData;db;auxData=new Map;_aggregateContext=void 0;constructor(t,n){this.db=t,this.userData=n}_getResult(){if(this._error)throw this._error;return this._result_set?this._result:null}_getError(){return this._error}_getSubtype(){return this._subtype}_clear(){this._result=void 0,this._result_set=!1,this._error=null,this._subtype=0}_setAggregateContextRef(t){this._aggregateContext=t}_getAggregateContextRef(){return this._aggregateContext}setResult(t){this._result_set||this._error||(this._result=t,this._result_set=!0)}resultBlob(t){this.setResult(t)}resultDouble(t){this.setResult(t)}resultError(t,n=w.ERROR){this._result_set||this._error||(this._error=new b(t,n))}resultInt(t){this.setResult(Math.trunc(t))}resultInt64(t){this.setResult(t)}resultNull(){this.setResult(null)}resultText(t){this.setResult(t)}resultValue(t){this.setResult(t)}resultZeroblob(t){this.setResult(new Uint8Array(t))}resultSubtype(t){this._subtype=t>>>0}getUserData(){return this.userData}getDbConnection(){return this.db}getAuxData(t){return this.auxData.get(t)?.data}setAuxData(t,n,r){if(this._error)return;let s=this.auxData.get(t);if(s?.destructor&&s.data!==n)try{s.destructor(s.data)}catch(o){console.error("Internal: AuxData destructor failed",o)}n===void 0&&r===void 0?this.auxData.delete(t):this.auxData.set(t,{data:n,destructor:r})}getAggregateContext(t=!1){return this._aggregateContext===void 0&&t?{}:this._aggregateContext}setAggregateContext(t){this._aggregateContext=t}_cleanupAuxData(){this.auxData.forEach(t=>{if(t.destructor)try{t.destructor(t.data)}catch(n){console.error("Internal: AuxData destructor failed",n)}}),this.auxData.clear()}};var Xe=class{module;db;tableName;schemaName;errorMessage;tableSchema;constructor(t,n,r,s){this.db=t,this.module=n,this.schemaName=r,this.tableName=s}setErrorMessage(t){this.errorMessage=t}};var Je=class{table;constructor(t){this.table=t}};var wt=class{static lockQueues=new Map;static async acquire(t){let n=this.lockQueues.get(t)??Promise.resolve(),r,s=new Promise(a=>{r=a});return this.lockQueues.set(t,s),await n,()=>{r(),this.lockQueues.get(t)===s&&this.lockQueues.delete(t)}}};var fr=Kh(_o(),1);var Yo=class extends Je{mergedResults=[];currentIndex=-1;isEof=!0;constructor(t){super(t)}reset(){this.mergedResults=[],this.currentIndex=-1,this.isEof=!0}getCurrentRow(){return this.isEof||this.currentIndex<0||this.currentIndex>=this.mergedResults.length?null:this.mergedResults[this.currentIndex]}getCurrentRowId(){return this.getCurrentRow()?._rowid_??null}setResults(t){this.mergedResults=t,this.currentIndex=-1,this.isEof=this.mergedResults.length===0,this.isEof||this.advance()}advance(){this.currentIndex>=this.mergedResults.length-1?(this.isEof=!0,this.currentIndex=this.mergedResults.length):(this.currentIndex++,this.isEof=!1)}eof(){return this.isEof}},dr=class extends Xe{columns=[];primaryKeyColumnIndices=[];keyFromEntry=t=>t._rowid_;compareKeys=fe;data=null;nextRowid=BigInt(1);readOnly;rowidToKeyMap=null;isSorter=!1;inTransaction=!1;pendingInserts=null;pendingUpdates=null;pendingDeletes=null;savepoints=[];constructor(t,n,r,s,o=!1){super(t,n,r,s),this.readOnly=o}setColumns(t,n){if(this.columns=[...t],n.length===0)console.log(`MemoryTable '${this.tableName}': Using rowid as BTree key.`),this.keyFromEntry=r=>r._rowid_,this.compareKeys=(r,s)=>fe(r,s),this.rowidToKeyMap=null;else if(n.length===1){let{index:r,desc:s}=n[0],o=this.columns[r]?.name,a=this.columns[r]?.collation||"BINARY";o?(console.log(`MemoryTable '${this.tableName}': Using PRIMARY KEY column '${o}' (index ${r}, ${s?"DESC":"ASC"}) as BTree key.`),this.primaryKeyColumnIndices=Object.freeze([r]),this.keyFromEntry=i=>i[o],this.compareKeys=(i,u)=>{let c=fe(i,u,a);return s?-c:c},this.rowidToKeyMap=new Map):(console.error(`MemoryTable '${this.tableName}': Invalid primary key index ${r}. Falling back to rowid key.`),this.keyFromEntry=i=>i._rowid_,this.compareKeys=(i,u)=>fe(i,u),this.rowidToKeyMap=null)}else{let r=n.map(s=>({name:this.columns[s.index]?.name,desc:s.desc,collation:this.columns[s.index]?.collation||"BINARY"}));if(r.some(s=>!s.name))console.error(`MemoryTable '${this.tableName}': Invalid composite primary key indices. Falling back to rowid key.`),this.keyFromEntry=s=>s._rowid_,this.compareKeys=(s,o)=>fe(s,o),this.rowidToKeyMap=null;else{let s=r.map(o=>o.name);console.log(`MemoryTable '${this.tableName}': Using Composite PRIMARY KEY (${r.map(o=>`${o.name} ${o.desc?"DESC":"ASC"}`).join(", ")}) as BTree key.`),this.keyFromEntry=o=>s.map(a=>o[a]),this.compareKeys=(o,a)=>this.compareCompositeKeysWithOrder(o,a,r.map(i=>i.desc),r.map(i=>i.collation)),this.rowidToKeyMap=new Map}}this.data=new fr.BTree(this.keyFromEntry,this.compareKeys)}compareCompositeKeysWithOrder(t,n,r,s=[]){let o=t,a=n,i=Math.min(o.length,a.length);for(let u=0;u<i;u++){let c=r[u]?-1:1,d=s[u]||"BINARY",l=fe(o[u],a[u],d)*c;if(l!==0)return l}return o.length-a.length}getRowByBTreeKey(t){if(!this.data)return null;let n=this.data.find(t);return n.on?this.data.at(n)??null:null}findPathByRowid(t){if(!this.data)return null;if(!this.rowidToKeyMap&&this.columns.length>0)return console.error(`MemoryTable ${this.tableName}: Attempt to find by rowid without rowidToKeyMap on a keyed table.`),null;if(this.rowidToKeyMap){let n=this.rowidToKeyMap.get(t);if(n===void 0)return null;let r=this.data.find(n);return r.on&&this.data.at(r)?._rowid_===t?r:null}else{let n=this.data.find(t);return n.on?n:null}}addRow(t){if(!this.data)throw new Error("MemoryTable BTree not initialized.");let n=this.nextRowid,r={...t,_rowid_:n},s=this.keyFromEntry(r),o=!1;if(this.data.get(s)!==void 0&&(o=!0),!o&&this.inTransaction){if(this.pendingInserts?.has(s))o=!0;else if(this.pendingUpdates){for(let a of this.pendingUpdates.values())if(this.compareKeys(a.newKey,s)===0){o=!0;break}}}if(o)return{};this.nextRowid++;try{if(this.inTransaction){if(this.pendingInserts||(this.pendingInserts=new Map),this.pendingDeletes){for(let[a,i]of this.pendingDeletes.entries())if(this.compareKeys(i.oldKey,s)===0){this.pendingDeletes.delete(a);break}}this.pendingInserts.set(s,r)}else this.data.insert(r),this.rowidToKeyMap&&this.rowidToKeyMap.set(n,s);return{rowid:n}}catch(a){throw this.nextRowid=n,new b(`Internal BTree error during insert: ${a.message}`,w.INTERNAL)}}updateRow(t,n){if(!this.data)throw new Error("MemoryTable BTree not initialized.");let r,s,o=null,a=!1;if(this.inTransaction){let d=this.pendingUpdates?.get(t);if(d)r=d.newRow,s=d.newKey;else for(let[l,h]of this.pendingInserts?.entries()??[])if(h._rowid_===t){r=h,s=l,a=!0;break}if(this.pendingDeletes?.has(t))return!1}if(!r){if(o=this.findPathByRowid(t),!o||(r=this.data.at(o),!r))return!1;s=this.keyFromEntry(r)}if(!s)throw new Error("Old key not found during update");let i={...r,...n,_rowid_:t},u=this.keyFromEntry(i),c=this.compareKeys(u,s)!==0;if(c){let d=!1;if(this.data.get(u)!==void 0&&(d=!0),!d&&this.inTransaction){if(this.pendingInserts?.has(u))d=!0;else if(this.pendingUpdates){for(let l of this.pendingUpdates.values())if(l.newRow._rowid_!==t&&this.compareKeys(l.newKey,u)===0){d=!0;break}}}if(d){let l=this.getPkColNames()??"rowid";throw new pt(`UNIQUE constraint failed: ${this.tableName}.${l}`)}}try{if(this.inTransaction){if(this.pendingUpdates||(this.pendingUpdates=new Map),a)this.pendingInserts?.set(u,i),c&&this.pendingInserts?.delete(s);else{let d=this.pendingUpdates.has(t)?this.pendingUpdates.get(t).oldRow:r;this.pendingUpdates.set(t,{oldRow:d,newRow:i,oldKey:s,newKey:u})}return!0}else if(c){if(o||(o=this.data.find(s)),!o||!o.on)throw new Error("Cannot find original row path for key change update");return this.data.deleteAt(o),this.rowidToKeyMap&&this.rowidToKeyMap.delete(t),this.data.insert(i),this.rowidToKeyMap&&this.rowidToKeyMap.set(t,u),!0}else{if(o||(o=this.data.find(s)),!o||!o.on)throw new Error("Cannot find original row path for same key update");return this.data.updateAt(o,i),!0}}catch(d){if(d instanceof pt)throw d;if(console.error("Failed to update row:",d),!this.inTransaction&&c)try{o&&this.data.deleteAt(o),this.data.insert(r),this.rowidToKeyMap&&this.rowidToKeyMap.set(t,s)}catch{}throw new b(`Internal BTree error during update: ${d instanceof Error?d.message:String(d)}`,w.INTERNAL)}}deleteRow(t){if(!this.data)throw new Error("MemoryTable BTree not initialized.");if(this.inTransaction){let n=!1;if(this.pendingInserts){for(let[i,u]of this.pendingInserts.entries())if(u._rowid_===t){this.pendingInserts.delete(i),n=!0;break}}if(n)return!0;let r=this.pendingUpdates?.get(t);if(r)return this.pendingDeletes||(this.pendingDeletes=new Map),this.pendingDeletes.set(t,{oldRow:r.oldRow,oldKey:r.oldKey}),this.pendingUpdates?.delete(t),!0;let s=this.findPathByRowid(t);if(!s)return!1;let o=this.data.at(s);if(!o)return!1;let a=this.keyFromEntry(o);return this.pendingDeletes||(this.pendingDeletes=new Map),this.pendingDeletes.set(t,{oldRow:o,oldKey:a}),!0}else{let n=this.findPathByRowid(t);if(!n)return!1;try{return this.data.deleteAt(n),this.rowidToKeyMap&&this.rowidToKeyMap.delete(t),!0}catch(r){return console.error("BTree deleteAt failed:",r),!1}}}clear(){this.data&&(this.data=new fr.BTree(this.keyFromEntry,this.compareKeys)),this.rowidToKeyMap&&this.rowidToKeyMap.clear(),this.nextRowid=BigInt(1)}get size(){return this.data?.getCount()??0}getRowIds(){if(!this.data)return[];let t=[];for(let n of this.data.ascending(this.data.first())){let r=this.data.at(n);r&&t.push(r._rowid_)}return t}getAllRows(){if(!this.data)return[];let t=[];for(let n of this.data.ascending(this.data.first())){let r=this.data.at(n);r&&t.push(r)}return t}isReadOnly(){return this.readOnly}getPkColNames(){return this.primaryKeyColumnIndices.length===0?null:this.primaryKeyColumnIndices.map(t=>this.columns[t]?.name??"?").join(", ")}createSavepoint(t){if(this.inTransaction){for(;this.savepoints.length<t;){console.warn(`MemoryTable ${this.tableName}: Filling missing savepoint index ${this.savepoints.length}`);let n=this.savepoints.length>0?this.savepoints[this.savepoints.length-1]:this.createBufferSnapshot();this.savepoints.push(n)}this.savepoints[t]=this.createBufferSnapshot(),console.log(`MemoryTable ${this.tableName}: Created savepoint at index ${t}`)}}releaseSavepoint(t){this.inTransaction&&t>=0&&t<this.savepoints.length&&(this.savepoints.length=t,console.log(`MemoryTable ${this.tableName}: Released savepoints from index ${t}`))}rollbackToSavepoint(t){if(!this.inTransaction)return;if(t<0||t>=this.savepoints.length){console.error(`MemoryTable ${this.tableName}: Invalid savepoint index ${t} for rollback.`);return}let n=this.savepoints[t];this.pendingInserts=new Map(n.inserts),this.pendingUpdates=new Map(n.updates),this.pendingDeletes=new Map(n.deletes),this.savepoints.length=t+1,console.log(`MemoryTable ${this.tableName}: Rolled back to savepoint index ${t}`)}createBufferSnapshot(){return{inserts:new Map(this.pendingInserts??[]),updates:new Map(this.pendingUpdates??[]),deletes:new Map(this.pendingDeletes??[])}}_configureAsSorter(t){if(this.isSorter){console.warn(`MemoryTable ${this.tableName}: Already configured as sorter.`);return}console.log(`MemoryTable ${this.tableName}: Configuring BTree for sorting with keys:`,t.keyIndices,"directions:",t.directions);let n=this.columns.map(o=>o.name),r=o=>{let a=t.keyIndices.map(i=>{let u=n[i];return u?o[u]:null});return a.push(o._rowid_),a},s=(o,a)=>{let i=o,u=a,c=Math.min(i.length,u.length)-1;for(let h=0;h<c;h++){let p=t.directions[h]?-1:1,g=t.collations?.[h]||"BINARY",E=fe(i[h],u[h],g)*p;if(E!==0)return E}let d=i[c],l=u[c];return fe(d,l)};this.keyFromEntry=r,this.compareKeys=s,this.isSorter=!0,this.data=new fr.BTree(r,s),this.rowidToKeyMap=null}},Pt=class{static SCHEMA_VERSION=1;tables=new Map;constructor(){}xCreate(t,n,r,s,o,a){let i=`${s.toLowerCase()}.${o.toLowerCase()}`;if(this.tables.has(i))throw new b(`Memory table '${o}' already exists in schema '${s}'`,w.ERROR);let u=new dr(t,this,s,o,!!a.readOnly);return this.tables.set(i,u),u.setColumns(a.columns,a.primaryKey??[]),console.log(`MemoryTable '${o}' created (Schema set directly from options)`),u}xConnect(t,n,r,s,o,a){let i=`${s.toLowerCase()}.${o.toLowerCase()}`,u=this.tables.get(i);return u?(console.log(`MemoryTable '${o}' connected (found existing instance)`),u):(console.log(`MemoryTable '${o}' not found, creating new instance via xConnect...`),this.xCreate(t,n,r,s,o,a))}async xDisconnect(t){console.log(`Memory table '${t.tableName}' disconnected`)}async xDestroy(t){t.clear();let n=`${t.schemaName.toLowerCase()}.${t.tableName.toLowerCase()}`;this.tables.delete(n),console.log(`Memory table '${t.tableName}' destroyed`)}async xOpen(t){return t.data||(t.data=new fr.BTree(t.keyFromEntry,t.compareKeys)),new Yo(t)}async xClose(t){t.reset()}xBestIndex(t,n){if(t.isSorter)return n.idxNum=0,n.estimatedCost=1,n.estimatedRows=BigInt(t.size||1),n.orderByConsumed=!0,n.idxFlags=0,n.aConstraintUsage=Array.from({length:n.nConstraint},()=>({argvIndex:0,omit:!1})),n.idxStr="sortplan",w.OK;let r=Array.from({length:n.nConstraint},()=>({argvIndex:0,omit:!1})),s=t.primaryKeyColumnIndices,o=s.length===0,a=1,i=t.size||1,u={FULL_ASC:0,KEY_EQ:1,KEY_RANGE_ASC:2,FULL_DESC:3,KEY_RANGE_DESC:4},c={idxNum:u.FULL_ASC,cost:i*10,rows:BigInt(i),usedConstraintIndices:new Set,boundConstraintIndices:{lower:-1,upper:-1},orderByConsumed:!1,isDesc:!1,lowerBoundOp:null,upperBoundOp:null},d=new Map,l=s.length>0;for(let N=0;N<n.nConstraint;N++){let C=n.aConstraint[N];if(C.op===F.EQ&&C.usable)if(o&&C.iColumn===-1){d.set(-1,N);break}else s.includes(C.iColumn)&&d.set(C.iColumn,N)}if(s.length>0){for(let N of s)if(!d.has(N)){l=!1;break}}else l=d.has(-1);if(l){let N=Math.log2(i+1)+1,C=BigInt(1);if(N<c.cost){let S=new Set(d.values());c={...c,idxNum:u.KEY_EQ,cost:N,rows:C,usedConstraintIndices:S,orderByConsumed:!0}}}let h=s[0]??-1,p=null,g=null;for(let N=0;N<n.nConstraint;N++){let C=n.aConstraint[N];C.iColumn===h&&C.usable&&(C.op===F.GT||C.op===F.GE?(!p||C.op>p.op)&&(p={index:N,op:C.op}):(C.op===F.LT||C.op===F.LE)&&(!g||C.op<g.op)&&(g={index:N,op:C.op}))}if(p||g){let N=BigInt(Math.max(1,Math.floor(i/4))),C=Math.log2(i+1)*2+Number(N);if(C<c.cost){let S=new Set;p&&S.add(p.index),g&&S.add(g.index),c={...c,idxNum:u.KEY_RANGE_ASC,cost:C,rows:N,usedConstraintIndices:S,boundConstraintIndices:{lower:p?.index??-1,upper:g?.index??-1},lowerBoundOp:p?.op??null,upperBoundOp:g?.op??null}}}let E=!1,y=!1;n.nOrderBy===s.length&&s.length>0?(E=s.every((N,C)=>n.aOrderBy[C].iColumn===N&&n.aOrderBy[C].desc===n.aOrderBy[0].desc),E&&(y=n.aOrderBy[0].desc)):n.nOrderBy===1&&o&&n.aOrderBy[0].iColumn===-1&&(E=!0,y=n.aOrderBy[0].desc),E&&(c.idxNum===u.FULL_ASC||c.idxNum===u.KEY_RANGE_ASC)&&(c.orderByConsumed=!0,c.isDesc=y,c.idxNum===u.FULL_ASC?(c.idxNum=y?u.FULL_DESC:u.FULL_ASC,c.cost*=.9):(c.idxNum=y?u.KEY_RANGE_DESC:u.KEY_RANGE_ASC,c.cost*=.9)),n.idxNum=c.idxNum,n.estimatedCost=c.cost,n.estimatedRows=c.rows,n.orderByConsumed=c.orderByConsumed,n.idxFlags=c.idxNum===u.KEY_EQ?1:0,a=1,c.usedConstraintIndices.forEach(N=>{r[N].argvIndex=a++,r[N].omit=!0}),n.aConstraintUsage=r;let I=[`plan=${c.idxNum}`];return c.orderByConsumed&&I.push(`order=${c.isDesc?"DESC":"ASC"}`),c.lowerBoundOp&&I.push(`lb_op=${c.lowerBoundOp}`),c.upperBoundOp&&I.push(`ub_op=${c.upperBoundOp}`),c.usedConstraintIndices.size>0&&I.push(`constraints=[${[...c.usedConstraintIndices].join(",")}]`),n.idxStr=I.join(","),w.OK}async xFilter(t,n,r,s){t.reset();let o=t.table,a=o.data,i=o.inTransaction,u=o.pendingInserts,c=o.pendingUpdates,d=o.pendingDeletes;if(!a)throw new b("MemoryTable BTree not initialized in xFilter.",w.INTERNAL);let l=null,h=0,p=!1,g=new Map;r?.split(",").forEach(y=>{let I=y.indexOf("=");I>0&&g.set(y.substring(0,I),y.substring(I+1))}),p=g.get("order")==="DESC";try{switch(n){case 1:case 2:case 4:l=p?a.descending(a.last()):a.ascending(a.first());break;case 3:l=a.descending(a.last());break;case 0:default:l=a.ascending(a.first());break}}catch(y){throw console.error(`Error preparing BTree iterator (idxNum=${n}):`,y),t.reset(),y}let E=[];if(i){let y=new Map,I=o.compareKeys,N=o.keyFromEntry;if(l)for(let S of l){let A=a.at(S);if(A&&!d?.has(A._rowid_)){let L=N(A);y.set(L,A)}}if(c)for(let[S,A]of c.entries())y.has(A.oldKey)&&(y.set(A.oldKey,A.newRow),I(A.oldKey,A.newKey)!==0&&(y.delete(A.oldKey),y.set(A.newKey,A.newRow)));let C=new Map(y);if(u)for(let[S,A]of u.entries())C.set(S,A);E.push(...C.values()),E.sort((S,A)=>{let L=N(S),v=N(A),M=I(L,v);return p?-M:M})}else if(l)for(let y of l){let I=a.at(y);I&&E.push(I)}t.setResults(E)}async xNext(t){t.advance()}async xEof(t){return t.eof()}xColumn(t,n,r){let s=t.getCurrentRow();if(!s)return n.resultNull(),w.OK;if(r===-1)return n.resultInt64(s._rowid_),w.OK;if(r<0||r>=t.table.columns.length)return n.resultError(`Invalid column index ${r}`,w.RANGE),w.RANGE;let o=t.table.columns[r].name,a=Object.prototype.hasOwnProperty.call(s,o)?s[o]:null;return n.resultValue(a??null),w.OK}async xRowid(t){let n=t.getCurrentRowId();if(n===null)throw new b("Cursor is not pointing to a valid row",w.MISUSE);return n}async xUpdate(t,n,r){if(t.isReadOnly())throw new b(`Table '${t.tableName}' is read-only`,w.READONLY);let s=await wt.acquire(`MemoryTable.xUpdate:${t.schemaName}.${t.tableName}`),o=n._onConflict||W.ABORT;try{if(n.length===1&&typeof n[0]=="bigint")return t.deleteRow(n[0]),{};if(n.length>1&&n[0]===null){let a=Object.fromEntries(t.columns.map((u,c)=>[u.name,n[c+1]])),i=t.addRow(a);if(i.rowid!==void 0)return{rowid:i.rowid};if(o===W.IGNORE)return{};{let u=t.getPkColNames()??"rowid";throw new pt(`UNIQUE constraint failed: ${t.tableName}.${u}`)}}else if(n.length>1&&typeof n[0]=="bigint"){let a=n[0],i=Object.fromEntries(t.columns.map((u,c)=>[u.name,n[c+1]]));try{if(!t.updateRow(a,i))throw new b(`Update failed for rowid ${a}`,w.NOTFOUND);return{}}catch(u){if(u instanceof pt&&o===W.IGNORE)return{};throw u}}else throw new b("Unsupported arguments for xUpdate",w.ERROR)}finally{s()}}async xBegin(t){let n=await wt.acquire(`MemoryTable.xBegin:${t.schemaName}.${t.tableName}`);try{t.inTransaction?console.warn(`MemoryTable ${t.tableName}: Nested transaction started without savepoint support.`):(t.inTransaction=!0,t.pendingInserts=new Map,t.pendingUpdates=new Map,t.pendingDeletes=new Map)}finally{n()}}async xCommit(t){let n=await wt.acquire(`MemoryTable.xCommit:${t.schemaName}.${t.tableName}`);try{if(!t.inTransaction)return;if(!t.data)throw new Error("BTree missing during commit");if(t.pendingDeletes)for(let[r,s]of t.pendingDeletes.entries()){let o=t.data.find(s.oldKey);if(o.on)try{t.data.deleteAt(o),t.rowidToKeyMap&&t.rowidToKeyMap.delete(r)}catch(a){console.error(`Commit: Failed to delete rowid ${r} with key ${s.oldKey}`,a)}}if(t.pendingUpdates)for(let[r,s]of t.pendingUpdates.entries())if(t.compareKeys(s.oldKey,s.newKey)!==0){if(!t.pendingDeletes?.has(r)){let a=t.data.find(s.oldKey);if(a.on)try{t.data.deleteAt(a)}catch(i){console.warn(`Commit Update: Failed to delete old key ${s.oldKey}`,i)}}t.rowidToKeyMap&&t.rowidToKeyMap.delete(r);try{t.data.insert(s.newRow),t.rowidToKeyMap&&t.rowidToKeyMap.set(r,s.newKey)}catch(a){console.error(`Commit: Failed to insert updated rowid ${r} with new key ${s.newKey}`,a)}}else{let a=t.data.find(s.oldKey);if(a.on)try{t.data.updateAt(a,s.newRow)}catch(i){console.error(`Commit: Failed to update in-place rowid ${r} with key ${s.oldKey}`,i)}else console.warn(`Commit Update: Rowid ${r} with key ${s.oldKey} not found for in-place update.`)}if(t.pendingInserts)for(let[r,s]of t.pendingInserts.entries())try{t.data.insert(s),t.rowidToKeyMap&&t.rowidToKeyMap.set(s._rowid_,r)}catch(o){console.error(`Commit: Failed to insert rowid ${s._rowid_} with key ${r}`,o)}t.pendingInserts=null,t.pendingUpdates=null,t.pendingDeletes=null,t.inTransaction=!1}finally{n()}}async xRollback(t){let n=await wt.acquire(`MemoryTable.xRollback:${t.schemaName}.${t.tableName}`);try{if(!t.inTransaction)return;t.pendingInserts=null,t.pendingUpdates=null,t.pendingDeletes=null,t.inTransaction=!1}finally{n()}}async xSync(t){}async xRename(t,n){let r=`${t.schemaName.toLowerCase()}.${t.tableName.toLowerCase()}`,s=`${t.schemaName.toLowerCase()}.${n.toLowerCase()}`;if(r!==s){if(this.tables.has(s))throw new b(`Cannot rename memory table: target name '${n}' already exists in schema '${t.schemaName}'`);this.tables.delete(r),t.tableName=n,this.tables.set(s,t),console.log(`Memory table renamed from '${r}' to '${n}'`)}}async xSavepoint(t,n){t.createSavepoint(n)}async xRelease(t,n){t.releaseSavepoint(n)}async xRollbackTo(t,n){t.rollbackToSavepoint(n)}};var vn=class e{db;program;stmt;programCounter=0;stack=[];framePointer=0;stackPointer=0;localsStartOffset=2;vdbeCursors;hasYielded=!1;done=!1;error=null;appliedBindings=!1;vtabContext;udfContext;ephemeralTables=new Map;static ephemeralModule=new Pt;aggregateContexts=new Map;aggregateIterator=null;currentAggregateEntry=null;savepoints=[];constructor(t,n){this.stmt=t,this.db=t.db,this.program=n;let r=Math.max(n.numMemCells+100,1e3);this.stack=new Array(r).fill(null).map(()=>({value:null})),this.stackPointer=0,this.framePointer=0,this.vdbeCursors=new Array(n.numCursors).fill(null).map(()=>({instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null})),this.vtabContext=new yt(this.db),this.udfContext=new yt(this.db)}applyBindings(t){this.appliedBindings||(console.log("VDBE applying bindings to stack..."),t.forEach((n,r)=>{let o=this.program.parameters.get(r)?.memIdx;o!==void 0&&o>=0?this._setStackValue(o,n):console.warn(`Could not map parameter ${r} to stack cell`)}),this.appliedBindings=!0)}clearAppliedBindings(){this.appliedBindings=!1}async reset(){this.programCounter=0,this.stackPointer=0,this.framePointer=0,this.appliedBindings=!1,this.hasYielded=!1,this.done=!1,this.error=null,this.udfContext._clear(),this.udfContext._cleanupAuxData(),this.aggregateContexts.clear(),this.aggregateIterator=null,this.currentAggregateEntry=null,this.savepoints=[];let t=[];for(let n=0;n<this.vdbeCursors.length;n++){let r=this.vdbeCursors[n];r.sortedResults&&(r.sortedResults=null),r.instance&&t.push(r.vtab.module.xClose(r.instance)),r.isEphemeral&&this.ephemeralTables.delete(n),this.vdbeCursors[n]={instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null}}this.ephemeralTables.clear(),await Promise.allSettled(t)}async run(){if(this.done||this.error)return this.error?this.error.code:w.MISUSE;this.hasYielded=!1;try{for(this.appliedBindings||this.applyBindings(new Map);!this.done&&!this.hasYielded&&!this.error;){let t=this.program.instructions[this.programCounter];if(!t){this.error=new b(`Invalid program counter: ${this.programCounter}`,w.INTERNAL);break}console.debug(`VDBE Exec: [${this.programCounter}] FP=${this.framePointer} SP=${this.stackPointer} ${f[t.opcode]} ${t.p1} ${t.p2} ${t.p3} ${t.p4!==null?`P4:${String(t.p4)}`:""} ${t.comment?`-- ${t.comment}`:""}`),await this.executeInstruction(t),!this.error&&!this.done&&!this.hasYielded&&this.programCounter<this.program.instructions.length&&this.program.instructions[this.programCounter]===t&&this.programCounter++}}catch(t){console.error("VDBE Execution Error:",t),t instanceof b?this.error=t:t instanceof Error?this.error=new b(`Runtime error: ${t.message}`,w.ERROR):this.error=new b("Unknown runtime error",w.INTERNAL),this.done=!0}return this.error?this.error.code:this.hasYielded?w.ROW:this.done?w.DONE:w.INTERNAL}_setStackValue(t,n){if(t<0)throw new b(`Invalid stack write index ${t}`,w.INTERNAL);for(;t>=this.stack.length;)this.stack.push({value:null});t>=this.stackPointer&&(this.stackPointer=t+1),this.stack[t]||(this.stack[t]={value:null}),this.stack[t].value=n instanceof Uint8Array?n.slice():n}_getStackValue(t){return t<0||t>=this.stackPointer?null:this.stack[t]?.value??null}_getMemValue(t){let n=this.framePointer+t;return this._getStackValue(n)}_setMem(t,n){if(t<this.localsStartOffset)throw new b(`Write attempt to control info/argument area via _setMem: Offset=${t}`,w.INTERNAL);let r=this.framePointer+t;this._setStackValue(r,n)}async executeInstruction(t){let n=t.p1,r=t.p2,s=t.p3,o=t.p4,a=t.p5,i=u=>{u?this.programCounter=r:this.programCounter++};switch(t.opcode){case f.Init:this.programCounter=r;return;case f.Goto:this.programCounter=r;return;case f.FrameEnter:{let l=n,h=this.stackPointer-1,p=h+l;for(;p>this.stack.length;)this.stack.push({value:null});this._setStackValue(h+1,this.framePointer);for(let g=this.localsStartOffset;g<l;g++)this._setStackValue(h+g,null);this.framePointer=h,this.stackPointer=p;break}case f.FrameLeave:{if(this.framePointer===0&&this._getStackValue(1)===null)console.warn("FrameLeave called on base frame? Potentially harmless if program ends.");else{let l=this._getStackValue(this.framePointer+1),h=typeof l=="number"?l:-1;if(isNaN(h)||h<0)throw new b(`Invalid old frame pointer ${l} at FP ${this.framePointer+1}`,w.INTERNAL);this.stackPointer=this.framePointer,this.framePointer=h}break}case f.Push:{let l=this._getMemValue(n);this._setStackValue(this.stackPointer,l);break}case f.Subroutine:{let l=n,h=r,p=this.programCounter+1;this._setStackValue(this.stackPointer,p),this.programCounter=h;return}case f.Return:{let l=this._getStackValue(this.stackPointer),h=typeof l=="number"?l:-1;if(!Number.isInteger(h)||h<0)throw new b(`Invalid return address ${l} at SP ${this.stackPointer} (expected after FrameLeave)`,w.INTERNAL);this.stackPointer++,this.programCounter=h;return}case f.Integer:this._setMem(r,n);break;case f.Int64:this._setMem(r,this.program.constants[o]);break;case f.String8:this._setMem(r,this.program.constants[o]);break;case f.Null:this._setMem(r,null);break;case f.Real:this._setMem(r,this.program.constants[o]);break;case f.Blob:this._setMem(r,this.program.constants[o]);break;case f.ZeroBlob:{let l=Number(this._getMemValue(n));this._setMem(r,new Uint8Array(l>=0?Math.trunc(l):0));break}case f.SCopy:this._setMem(r,this._getMemValue(n));break;case f.Clear:{let l=n,h=r;if(l<this.localsStartOffset)throw new b(`Clear opcode attempt to clear control/arg area: Offset=${l}`,w.INTERNAL);let p=this.framePointer+l,g=p+h;if(p<0||g>this.stackPointer)throw new b(`Clear opcode stack access out of bounds: FP=${this.framePointer} Offset=${l} Count=${h} SP=${this.stackPointer}`,w.INTERNAL);for(let E=p;E<g;E++)this._setStackValue(E,null);break}case f.IfTrue:i(Po(this._getMemValue(n)));return;case f.IfFalse:i(!Po(this._getMemValue(n)));return;case f.IfZero:{let l=this._getMemValue(n);i(l===0||l===0n||l===null);return}case f.IfNull:i(this._getMemValue(n)===null);return;case f.IfNotNull:i(this._getMemValue(n)!==null);return;case f.IsNull:this._setMem(r,this._getMemValue(n)===null);break;case f.NotNull:this._setMem(r,this._getMemValue(n)!==null);break;case f.Eq:case f.Ne:case f.Lt:case f.Le:case f.Gt:case f.Ge:{let l=this._getMemValue(n),h=this._getMemValue(s),p=r,g=o,E=g?.type==="coll"?g.name:"BINARY",y=fe(l,h,E),I=!1;switch(t.opcode){case f.Eq:I=y===0;break;case f.Ne:I=y!==0;break;case f.Lt:I=y<0;break;case f.Le:I=y<=0;break;case f.Gt:I=y>0;break;case f.Ge:I=y>=0;break}i(I);return}case f.Add:this._binaryArithOp(n,r,s,(l,h)=>Number(l)+Number(h));break;case f.Subtract:this._binaryArithOp(n,r,s,(l,h)=>Number(h)-Number(l));break;case f.Multiply:this._binaryArithOp(n,r,s,(l,h)=>Number(l)*Number(h));break;case f.Divide:{let l=this._getMemValue(n),h=this._getMemValue(r);this._setMem(s,l===0||l===0n||l===null||h===null||Number(l)===0?null:Number(h)/Number(l))}break;case f.Remainder:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null)if(typeof l=="bigint"||typeof h=="bigint"){let g=BigInt(l),E=BigInt(h);g!==0n&&(p=E%g)}else{let g=Number(l),E=Number(h);g!==0&&!isNaN(g)&&!isNaN(E)&&(p=E%g)}}catch{}this._setMem(s,p)}break;case f.Concat:{let l="";for(let h=n;h<=r;h++){let p=this._getMemValue(h);p!==null&&!(p instanceof Uint8Array)&&(l+=String(p))}this._setMem(s,l);break}case f.Negative:{let l=this._getMemValue(n),h=null;try{l!==null&&(h=typeof l=="bigint"?-l:-Number(l)),typeof h=="number"&&isNaN(h)&&(h=null)}catch{h=null}this._setMem(r,h)}break;case f.BitAnd:case f.BitOr:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null){let g=BigInt(l),E=BigInt(h);p=t.opcode===f.BitAnd?g&E:g|E}}catch{p=0n}this._setMem(s,p);break}case f.ShiftLeft:case f.ShiftRight:{let l=this._getMemValue(n),h=this._getMemValue(r),p=null;try{if(l!==null&&h!==null){let g=BigInt(l),E=BigInt(h);p=t.opcode===f.ShiftLeft?E<<g:E>>g}}catch{p=0n}this._setMem(s,p);break}case f.BitNot:{let l=this._getMemValue(n),h=null;try{l!==null&&(h=~BigInt(l))}catch{h=-1n}this._setMem(r,h);break}case f.Function:{let l=o;if(!l||l.type!=="funcdef")throw new b("Invalid P4 for Function",w.INTERNAL);let h=[];for(let p=0;p<l.nArgs;p++)h.push(this._getMemValue(r+p));this.udfContext=new yt(this.db,l.funcDef.userData),this.udfContext._clear();try{l.funcDef.xFunc(this.udfContext,Object.freeze(h));let p=this.udfContext._getError();if(p)throw p;this._setMem(s,this.udfContext._getResult())}catch(p){throw p instanceof Error?new b(`Func ${l.funcDef.name}: ${p.message}`,w.ERROR):p}break}case f.MakeRecord:{let l=[];for(let p=0;p<r;p++)l.push(this._getMemValue(n+p));let h=JSON.stringify(l,(p,g)=>typeof g=="bigint"?g.toString()+"n":g instanceof Uint8Array?`blob:${Buffer.from(g).toString("hex")}`:g);this._setMem(s,h);break}case f.AggStep:{let l=o;if(!l||l.type!=="funcdef")throw new b("Invalid P4 for AggStep",w.INTERNAL);let p=this._getMemValue(s),g=[];for(let y=0;y<l.nArgs;y++)g.push(this._getMemValue(r+y));let E=this.aggregateContexts.get(p);this.udfContext._clear(),this.udfContext._setAggregateContextRef(E?.accumulator);try{l.funcDef.xStep(this.udfContext,Object.freeze(g));let y=this.udfContext._getError();if(y)throw y;let I=this.udfContext._getAggregateContextRef();if(E===void 0&&I!==void 0){let N=[];for(let C=0;C<a;C++)N.push(this._getMemValue(n+C));this.aggregateContexts.set(p,{accumulator:I,keyValues:Object.freeze(N)})}else E!==void 0&&I!==void 0&&I!==E.accumulator&&(E.accumulator=I)}catch(y){console.error(`VDBE AggStep Error in function ${l.funcDef.name}:`,y),y instanceof b?this.error=y:y instanceof Error?this.error=new b(`Runtime error in aggregate ${l.funcDef.name} xStep: ${y.message}`,w.ERROR):this.error=new b(`Unknown runtime error in aggregate ${l.funcDef.name} xStep`,w.INTERNAL),this.done=!0;return}break}case f.AggFinal:{let l=o;if(!l||l.type!=="funcdef")throw new b("Invalid P4 for AggFinal",w.INTERNAL);let p=this._getMemValue(n),g=this.aggregateContexts.get(p);this.udfContext=new yt(this.db,l.funcDef.userData),this.udfContext._clear(),this.udfContext._setAggregateContextRef(g?.accumulator);try{l.funcDef.xFinal(this.udfContext);let E=this.udfContext._getError();if(E)throw E;this._setMem(s,this.udfContext._getResult())}catch{}break}case f.AggIterate:this.aggregateIterator=this.aggregateContexts.entries(),this.currentAggregateEntry=null;break;case f.AggNext:if(!this.aggregateIterator)throw new Error;let u=this.aggregateIterator.next();u.done?(this.currentAggregateEntry=null,this.programCounter=r):(this.currentAggregateEntry=u.value,this.programCounter++);return;case f.AggKey:if(!this.currentAggregateEntry)throw new Error;let c=this.currentAggregateEntry[0];this._setMem(r,c);break;case f.AggContext:if(!this.currentAggregateEntry)throw new Error;this._setMem(r,this.currentAggregateEntry[1]?.accumulator);break;case f.AggGroupValue:if(!this.currentAggregateEntry)throw new Error;this._setMem(s,this.currentAggregateEntry[1]?.keyValues[r]??null);break;case f.Affinity:{let l=n,h=r,p=o.toUpperCase(),g=this.framePointer+l,E=g+h;if(l<this.localsStartOffset)throw new b(`Affinity opcode attempt on control/arg area: Offset=${l}`,w.INTERNAL);if(g<0||E>this.stackPointer)throw new b(`Affinity opcode stack access out of bounds: FP=${this.framePointer} Offset=${l} Count=${h} SP=${this.stackPointer}`,w.INTERNAL);let y;switch(p){case"NUMERIC":y=hu;break;case"INTEGER":y=Fo;break;case"REAL":y=du;break;case"TEXT":y=mu;break;case"BLOB":y=pu;break;default:y=I=>I}for(let I=0;I<h;I++){let N=l+I,C=this._getMemValue(N),S=y(C);S!==C&&this._setMem(N,S)}break}case f.Move:{let l=n,h=r,p=s,g=this.framePointer+l,E=this.framePointer+h;if(g<0||E<0||g+p>this.stackPointer||E+p>this.stackPointer)throw new b(`Move opcode stack access out of bounds: FP=${this.framePointer} SrcOff=${l} DestOff=${h} Count=${p} SP=${this.stackPointer}`,w.INTERNAL);if(g===E)break;if(E>g&&E<g+p)for(let y=p-1;y>=0;y--)this._setStackValue(E+y,this._getStackValue(g+y));else for(let y=0;y<p;y++)this._setStackValue(E+y,this._getStackValue(g+y));break}case f.OpenRead:{let l=n,h=o;if(!h?.vtabInstance)throw new Error("Missing vtab instance");let p=h.vtabInstance,g=await p.module.xOpen(p);this.vdbeCursors[l]={instance:g,vtab:p,isValid:!1,isEof:!1,sortedResults:null};break}case f.OpenWrite:{let l=n,h=o;if(!h?.vtabInstance)throw new Error("Missing vtab instance");let p=h.vtabInstance,g=await p.module.xOpen(p);this.vdbeCursors[l]={instance:g,vtab:p,isValid:!1,isEof:!1,sortedResults:null};break}case f.Close:{let l=n,h=this.vdbeCursors[l];h&&(h.sortedResults&&(h.sortedResults=null),h.instance&&await h.vtab.module.xClose(h.instance),h.isEphemeral&&this.ephemeralTables.delete(l),this.vdbeCursors[l]={instance:null,vtab:null,isValid:!1,isEof:!1,sortedResults:null});break}case f.VFilter:{let l=n,h=r,p=s,g=o,E=this.vdbeCursors[l];if(!E?.vtab||!E.instance)throw new Error("VFilter on unopened cursor");let y=[];for(let N=0;N<g.nArgs;N++)y.push(this._getMemValue(p+N));await E.vtab.module.xFilter(E.instance,g.idxNum,g.idxStr,y);let I=await E.vtab.module.xEof(E.instance);E.isEof=I,E.isValid=!I,I?this.programCounter=h:this.programCounter++;return}case f.VNext:{let l=n,h=r,p=this.vdbeCursors[l];if(p?.sortedResults)return;if(!p?.instance)throw new Error("VNext on unopened cursor");await p.vtab.module.xNext(p.instance);let g=await p.vtab.module.xEof(p.instance);p.isEof=g,p.isValid=!g,g?this.programCounter=h:this.programCounter++;return}case f.Rewind:{let l=n,h=r,p=this.vdbeCursors[l];if(p?.sortedResults)return;if(!p?.instance)throw new Error("Rewind on unopened cursor");await p.vtab.module.xFilter(p.instance,0,null,[]);let g=await p.vtab.module.xEof(p.instance);p.isEof=g,p.isValid=!g,g?this.programCounter=h:this.programCounter++;return}case f.VColumn:{let l=n,h=r,p=s,g=this.vdbeCursors[l];if(g?.sortedResults){let y=g.sortedResults;if(y.index<0||y.index>=y.rows.length)throw new Error;let I=y.rows[y.index];if(h<0||h>=I.length)throw new Error;this._setMem(p,I[h].value);break}if(!g?.instance||!g.isValid)throw new Error("VColumn on invalid cursor");this.vtabContext._clear();let E=g.vtab.module.xColumn(g.instance,this.vtabContext,h);if(E!==w.OK)throw new b(`xColumn failed (col ${h}, cursor ${l})`,E);this._setMem(p,this.vtabContext._getResult());break}case f.VRowid:{let l=n,h=r,p=this.vdbeCursors[l];if(!p?.instance||!p.isValid)throw new Error("VRowid on invalid cursor");let g=await p.vtab.module.xRowid(p.instance);this._setMem(h,g);break}case f.VUpdate:{let l=r,h=s,p=n,g=o;if(!g?.table?.vtabInstance?.module?.xUpdate)throw new Error("VUpdate called on non-virtual table or module lacks xUpdate");let E=[];for(let I=0;I<p;I++)E.push(this._getMemValue(l+I)??null);E._onConflict=g.onConflict||W.ABORT;let y=E[0];try{let I=await g.table.vtabInstance.module.xUpdate(g.table.vtabInstance,E,y);h>0&&(E[0]===null?I&&I.rowid!==void 0?this._setMem(h,I.rowid):this._setMem(h,null):this._setMem(h,null))}catch(I){I instanceof b?this.error=I:I instanceof Error?this.error=new b(`Runtime error during VUpdate: ${I.message}`,w.ERROR):this.error=new b("Unknown error during VUpdate execution",w.ERROR),this.done=!0;return}}break;case f.VBegin:case f.VCommit:case f.VRollback:case f.VSync:case f.VSavepoint:case f.VRelease:case f.VRollbackTo:console.warn(`VTab transaction Opcode ${f[t.opcode]} not fully implemented`);break;case f.ResultRow:let d=this.framePointer+n;if(d<0||d+r>this.stackPointer)throw new b(`ResultRow stack access out of bounds: FP=${this.framePointer} Offset=${n} Count=${r} SP=${this.stackPointer}`,w.INTERNAL);this.stmt.setCurrentRow(this.stack.slice(d,d+r)),this.hasYielded=!0,this.programCounter++;return;case f.Sort:console.warn("Opcode.Sort execution logic needs review for stack frame compatibility.");break;case f.Halt:this.done=!0,n!==w.OK&&(this.error=new b(o??`Execution halted with code ${n}`,n));return;case f.Noop:break;case f.OpenEphemeral:{let l=n,h=r,p=o,g=new dr(this.db,e.ephemeralModule,"_temp_internal",`_eph_${l}`);if(this.ephemeralTables.set(l,{table:g,module:e.ephemeralModule}),p&&p.columns&&p.primaryKeyDefinition){console.log(`VDBE OpenEphemeral: Initializing cursor ${l} with provided schema (PK def length: ${p.primaryKeyDefinition.length})`);let y=p.columns.map(I=>({name:I.name,type:I.affinity}));g.setColumns(y,p.primaryKeyDefinition)}else{console.log(`VDBE OpenEphemeral: Initializing cursor ${l} with default schema (${h} cols)`);let y=Array.from({length:h},(I,N)=>({name:`eph_col${N}`,type:R.TEXT}));g.setColumns(y,[])}let E=await e.ephemeralModule.xOpen(g);this.vdbeCursors[l]={instance:E,vtab:g,isValid:!1,isEof:!1,isEphemeral:!0};break}case f.StackPop:{let l=n;if(l<0)throw new b("StackPop count cannot be negative",w.INTERNAL);if(this.stackPointer<l)throw new b(`Stack underflow during StackPop: SP=${this.stackPointer}, Count=${l}`,w.INTERNAL);this.stackPointer-=l;break}default:throw new b(`Unsupported opcode: ${f[t.opcode]} (${t.opcode})`,w.INTERNAL)}this.programCounter<this.program.instructions.length&&this.program.instructions[this.programCounter]===t&&this.programCounter++}_binaryArithOp(t,n,r,s){let o=this._getMemValue(t),a=this._getMemValue(n),i=null;if(o!==null&&a!==null)if(typeof o=="bigint"||typeof a=="bigint")try{i=s(BigInt(o),BigInt(a))}catch{i=null}else{let u=Number(o),c=Number(a);if(!isNaN(u)&&!isNaN(c))try{i=s(u,c)}catch{i=null}}this._setMem(r,i)}handleVdbeError(t,n,r){let s=`VDBE Error during ${n} at PC ${r}: ${t instanceof Error?t.message:String(t)}`,o=t instanceof b?t.code:w.INTERNAL;this.error=new b(s,o,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}handleVTabError(t,n,r,s){let o=`Error in VTab ${n}.${r} at PC ${s}: ${t instanceof Error?t.message:String(t)}`,a=t instanceof b?t.code:w.ERROR;this.error=new b(o,a,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}handleUdfError(t,n,r,s="xFunc"){let o=`Error in function ${n} (${s}) at PC ${r}: ${t instanceof Error?t.message:String(t)}`,a=t instanceof b?t.code:w.ERROR;this.error=new b(o,a,t instanceof Error?t:void 0),this.done=!0,console.error(this.error)}};var Ln=class{db;sql;finalized=!1;busy=!1;boundParameters=new Map;columnNames=[];currentRowInternal=null;vdbeProgram=null;vdbe=null;needsCompile=!0;constructor(t,n){this.db=t,this.sql=n}async compile(){if(this.vdbeProgram&&!this.needsCompile)return this.vdbeProgram;if(this.finalized)throw new x("Statement finalized");console.log("Compiling statement..."),this.vdbeProgram=null;try{let n=new Be().parse(this.sql),r=new Sn(this.db);this.vdbeProgram=r.compile(n,this.sql),this.needsCompile=!1,console.log("Compilation complete.")}catch(t){throw console.error("Compilation failed:",t),t instanceof b?t:t instanceof gt?new b(`Parse error: ${t.message}`,w.ERROR):t instanceof Error?new b(`Compilation error: ${t.message}`,w.INTERNAL):new b("Unknown compilation error",w.INTERNAL)}if(!this.vdbeProgram)throw new b("Compilation resulted in no program",w.INTERNAL);return this.vdbeProgram}bind(t,n){if(this.finalized)throw new x("Statement finalized");if(this.busy)throw new x("Statement busy");if(typeof t=="number"){if(t<1)throw new RangeError(`Parameter index ${t} out of range (must be >= 1)`);this.boundParameters.set(t,n)}else if(typeof t=="string")this.boundParameters.set(t,n);else throw new x("Invalid parameter key type");return this.vdbe&&(this.vdbe.clearAppliedBindings(),this.vdbe.applyBindings(this.boundParameters)),this}bindAll(t){if(this.finalized)throw new x("Statement finalized");if(this.busy)throw new x("Statement busy");if(Array.isArray(t))for(let n=0;n<t.length;n++)this.bind(n+1,t[n]);else if(typeof t=="object"&&t!==null)for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&this.bind(n,t[n]);else throw new x("Invalid parameters type for bindAll. Use array or object.");return this}async step(){if(this.finalized)throw new x("Statement finalized");if(await this.compile(),!this.vdbe&&this.vdbeProgram&&(this.vdbe=new vn(this,this.vdbeProgram),this.vdbe.applyBindings(this.boundParameters)),!this.vdbe)throw new b("VDBE not initialized after compile",w.INTERNAL);this.busy=!0,this.currentRowInternal=null;let t=await this.vdbe.run();if(t===w.ROW){if(!this.currentRowInternal)throw this.busy=!1,new b("VDBE returned ROW but setCurrentRow was not called",w.INTERNAL)}else this.busy=!1,this.currentRowInternal=null;if(t!==w.ROW&&t!==w.DONE&&t!==w.OK)throw new b(`VDBE execution failed with status: ${w[t]}`,t);return console.log(`Step result: ${w[t]}`),t}setCurrentRow(t){this.currentRowInternal=t}getArray(){if(this.finalized)throw new x("Statement finalized");if(!this.currentRowInternal)throw new x("No row available");return this.currentRowInternal.map(t=>t.value)}getAsObject(){if(this.finalized)throw new x("Statement finalized");if(!this.currentRowInternal)throw new x("No row available");let t=this.vdbeProgram?.columnNames||[];if(t.length===0&&this.currentRowInternal.length>0)return this.currentRowInternal.reduce((r,s,o)=>(r[`col_${o}`]=s.value,r),{});if(t.length!==this.currentRowInternal.length)throw new b(`Column name/value count mismatch (${t.length} vs ${this.currentRowInternal.length})`,w.INTERNAL);let n={};for(let r=0;r<t.length;r++){let s=t[r];s in n||(n[s]=this.currentRowInternal[r].value)}return n}getColumnNames(){if(this.finalized)throw new x("Statement finalized");return[...this.vdbeProgram?.columnNames||[]]}async reset(){if(this.finalized)throw new x("Statement finalized");this.vdbe&&await this.vdbe.reset(),this.currentRowInternal=null,this.busy=!1,this.needsCompile=!1}clearBindings(){if(this.finalized)throw new x("Statement finalized");if(this.busy)throw new x("Statement busy - reset first");return this.boundParameters.clear(),this.vdbe&&this.vdbe.clearAppliedBindings(),this}async finalize(){this.finalized||(this.finalized=!0,this.busy=!1,this.vdbe&&await this.vdbe.reset(),this.boundParameters.clear(),this.currentRowInternal=null,this.vdbeProgram=null,this.vdbe=null,this.db._statementFinalized(this))}async run(t){if(this.finalized)throw new x("Statement finalized");if(this.busy)throw new x("Statement busy - already running?");t&&this.bindAll(t);try{let n;do if(n=await this.step(),n===w.ROW)this.currentRowInternal=null;else if(n!==w.DONE&&n!==w.OK)throw new b("Execution failed during run()",n);while(n===w.ROW)}finally{await this.reset()}}async get(t){if(this.finalized)throw new x("Statement finalized");if(this.busy)throw new x("Statement busy - already running?");t&&this.bindAll(t);let n;try{let r=await this.step();if(r===w.ROW)n=this.getAsObject();else if(r!==w.DONE&&r!==w.OK)throw new b("Execution failed during get()",r);let s=r;for(;s===w.ROW;)if(s=await this.step(),s!==w.ROW&&s!==w.DONE&&s!==w.OK){console.warn(`Error consuming remaining rows after get(): ${w[s]}`);break}}finally{await this.reset()}return n}async all(t){if(this.finalized)throw new x("Statement finalized");if(this.busy)throw new x("Statement busy - already running?");t&&this.bindAll(t);let n=[];try{let r;do if(r=await this.step(),r===w.ROW)n.push(this.getAsObject());else if(r!==w.DONE&&r!==w.OK)throw new b("Execution failed during all()",r);while(r===w.ROW)}finally{await this.reset()}return n}getParameterCount(){if(this.finalized)throw new x("Statement finalized");return this.needsCompile&&!this.vdbeProgram?0:this.vdbeProgram?.parameters.size||0}getParameterName(t){if(this.finalized)throw new x("Statement finalized");if(t<1)throw new RangeError("Parameter index must be >= 1");if(this.needsCompile&&!this.vdbeProgram)return null;for(let[n,r]of this.vdbeProgram?.parameters||[])if(typeof n=="string"&&r.memIdx===t)return n;return null}getParameterIndex(t){if(this.finalized)throw new x("Statement finalized");if(!t)throw new x("Parameter name cannot be empty");if(this.needsCompile&&!this.vdbeProgram)return null;let n=this.vdbeProgram?.parameters.get(t);return n?n.memIdx:null}getColumnType(t){if(this.finalized)throw new x("Statement finalized");if(!this.currentRowInternal)throw new x("No row available");if(t<0||t>=this.currentRowInternal.length)throw new RangeError(`Column index ${t} out of range (0-${this.currentRowInternal.length-1})`);let n=this.currentRowInternal[t].value;return n===null?R.NULL:typeof n=="number"?R.REAL:typeof n=="bigint"?R.INTEGER:typeof n=="string"?R.TEXT:n instanceof Uint8Array?R.BLOB:typeof n=="boolean"?R.INTEGER:R.TEXT}getColumnName(t){if(this.finalized)throw new x("Statement finalized");let n=this.vdbeProgram?.columnNames||[];if(t<0||n.length>0&&t>=n.length)throw new RangeError(`Column index ${t} out of range (0-${n.length-1})`);return n[t]||`col_${t}`}getColumnBytes(t){if(this.finalized)throw new x("Statement finalized");if(!this.currentRowInternal)throw new x("No row available");if(t<0||t>=this.currentRowInternal.length)throw new RangeError(`Column index ${t} out of range (0-${this.currentRowInternal.length-1})`);let n=this.currentRowInternal[t].value;return n===null?0:n instanceof Uint8Array?n.byteLength:typeof n=="string"?new TextEncoder().encode(n).length:new TextEncoder().encode(String(n)).length}};var On=class{schemas=new Map;currentSchemaName="main";modules=new Map;defaultVTabModule=null;db;constructor(t){this.db=t,this.schemas.set("main",new Cn("main")),this.schemas.set("temp",new Cn("temp"))}setCurrentSchema(t){this.schemas.has(t.toLowerCase())?this.currentSchemaName=t.toLowerCase():console.warn(`Attempted to set current schema to non-existent schema: ${t}`)}getCurrentSchemaName(){return this.currentSchemaName}registerModule(t,n){let r=t.toLowerCase();this.modules.has(r)&&console.warn(`Replacing existing virtual table module: ${r}`),this.modules.set(r,n),console.log(`Registered VTab module: ${r}`)}getModule(t){return this.modules.get(t.toLowerCase())}setDefaultVTabModule(t){if(t===null){this.defaultVTabModule=null,console.log("Default VTab module cleared.");return}let n=t.toLowerCase();if(this.modules.has(n))this.defaultVTabModule=n,console.log(`Default VTab module set to: ${n}`);else throw new b(`Cannot set default VTab module: module '${n}' not registered.`)}getDefaultVTabModuleName(){return this.defaultVTabModule}getSchema(t){return this.schemas.get(t.toLowerCase())}getMainSchema(){return this.schemas.get("main")}getTempSchema(){return this.schemas.get("temp")}_getAllSchemas(){return this.schemas.values()}addSchema(t){let n=t.toLowerCase();if(this.schemas.has(n))throw new b(`Schema '${t}' already exists`,w.ERROR);let r=new Cn(t);return this.schemas.set(n,r),console.log(`SchemaManager: Added schema '${t}'`),r}removeSchema(t){let n=t.toLowerCase();if(n==="main"||n==="temp")throw new b(`Cannot detach schema '${t}'`,w.ERROR);let r=this.schemas.get(n);return r?(r.clearFunctions(),r.clearTables(),r.clearViews(),this.schemas.delete(n),console.log(`SchemaManager: Removed schema '${t}'`),!0):!1}findTable(t,n){return n?this.schemas.get(n.toLowerCase())?.getTable(t):this.getMainSchema().getTable(t)??this.getTempSchema().getTable(t)}findFunction(t,n){return this.getMainSchema().getFunction(t,n)}declareVtab(t,n,r,s){let o=this.schemas.get(t.toLowerCase());if(!o)throw new b(`Schema not found: ${t}`,w.ERROR);console.log(`SchemaManager: Declaring VTab in '${t}' using SQL: ${n}`);let a;try{let h=new Be().parse(n);if(h.type!=="createTable")throw new b(`Expected CREATE TABLE statement, got ${h.type}`,w.ERROR);a=h}catch(l){throw new b(`Failed to parse CREATE TABLE statement: ${l.message}`,w.ERROR)}let i=a.table.name,u=a.moduleArgs;if(o.getTable(i)){if(a.ifNotExists)return console.log(`SchemaManager: VTab ${i} already exists in schema ${t}, skipping creation (IF NOT EXISTS).`),o.getTable(i);throw new b(`Table ${i} already exists in schema ${t}`,w.ERROR)}console.warn(`SchemaManager.declareVtab: Using placeholder column definition for ${i}. VTab module should define actual columns.`);let c=[_e("column1"),_e("column2")],d={name:i,schemaName:o.name,columns:Object.freeze(c),columnIndexMap:Object.freeze(be(c)),primaryKeyDefinition:Object.freeze(vl(c)),isVirtual:!0,vtabModule:r.module,vtabInstance:r,vtabAuxData:s,vtabArgs:Object.freeze(u||[]),vtabModuleName:a.moduleName};return o.addTable(d),d}getView(t,n){let r=t??this.currentSchemaName;return this.schemas.get(r)?.getView(n)}getSchemaItem(t,n){let r=t??this.currentSchemaName,s=this.schemas.get(r);if(!s)return;let o=s.getView(n);return o||s.getTable(n)}dropTable(t,n){let r=this.schemas.get(t);if(!r)return!1;let s=r.getTable(n),o=null;s?.isVirtual&&s.vtabInstance&&s.vtabModule?.xDestroy&&(console.log(`Calling xDestroy for VTab ${t}.${n}`),o=s.vtabModule.xDestroy(s.vtabInstance).catch(i=>{console.error(`Error during VTab xDestroy for ${t}.${n}:`,i)}));let a=r.removeTable(n);return o&&o.then(()=>console.log(`xDestroy completed for VTab ${t}.${n}`)),a}dropView(t,n){let r=this.schemas.get(t);return r?r.removeView(n):!1}clearAll(){this.schemas.forEach(t=>{t.clearTables(),t.clearFunctions(),t.clearViews()}),console.log("SchemaManager: Cleared all schemas.")}getSchemaOrFail(t){let n=this.schemas.get(t.toLowerCase());if(!n)throw new b(`Schema not found: ${t}`);return n}getTable(t,n){let r=t??this.currentSchemaName;return this.schemas.get(r)?.getTable(n)}};function Iu(e,t){if(e===null||t===void 0||t==="any")return e;try{switch(t){case"string":return e instanceof Uint8Array?"":String(e);case"number":if(typeof e=="boolean")return e?1:0;let n=Number(e);return isNaN(n)?null:n;case"bigint":return BigInt(e);case"boolean":if(typeof e=="number")return e!==0;if(typeof e=="bigint")return e!==0n;if(typeof e=="string"){let r=e.trim().toLowerCase();if(r==="true")return!0;if(r==="false")return!1;let s=Number(e);return!isNaN(s)&&s!==0}return!!e;case"blob":return e instanceof Uint8Array?e:null}}catch(n){return console.warn(`Coercion failed for value ${e} to type ${t}:`,n),null}return e}function V(e,t){return{name:e.name,numArgs:e.numArgs,flags:e.flags??T.UTF8|T.DETERMINISTIC,xFunc:(r,s)=>{try{if(e.numArgs>=0&&s.length!==e.numArgs)throw new Error(`Function ${e.name} called with ${s.length} arguments, expected ${e.numArgs}`);let o=s.map((i,u)=>Iu(i,e.argTypes?.[u])),a=t(...o);a==null?r.resultNull():typeof a=="string"?r.resultText(a):typeof a=="number"?Number.isInteger(a)?r.resultInt64(BigInt(a)):r.resultDouble(a):typeof a=="bigint"?r.resultInt64(a):a instanceof Uint8Array?r.resultBlob(a):typeof a=="boolean"?r.resultInt(a?1:0):(console.warn(`Function ${e.name} returned unknown type: ${typeof a}. Coercing to NULL.`),r.resultNull())}catch(o){let a=o instanceof Error?o.message:String(o);r.resultError(`Error in function ${e.name}: ${a}`,w.ERROR)}}}}function Ce(e,t,n){return{name:e.name,numArgs:e.numArgs,flags:e.flags??T.UTF8,xStep:(s,o)=>{if(e.numArgs>=0&&o.length!==e.numArgs)throw new Error(`Aggregate ${e.name} step called with ${o.length} arguments, expected ${e.numArgs}`);let a=s.getAggregateContext();a===void 0&&(a=e.initialState??null);let i=o.map((c,d)=>Iu(c,e.argTypes?.[d])),u=t(a,...i);s.setAggregateContext(u)},xFinal:s=>{try{let o=s.getAggregateContext();o===void 0&&(o=e.initialState??null);let a=n(o);a==null?s.resultNull():typeof a=="string"?s.resultText(a):typeof a=="number"?Number.isInteger(a)?s.resultInt64(BigInt(a)):s.resultDouble(a):typeof a=="bigint"?s.resultInt64(a):a instanceof Uint8Array?s.resultBlob(a):typeof a=="boolean"?s.resultInt(a?1:0):(console.warn(`Aggregate ${e.name} xFinal returned unknown type: ${typeof a}. Coercing to NULL.`),s.resultNull())}catch(o){let a=o instanceof Error?o.message:String(o);s.resultError(`Error in aggregate function ${e.name} xFinal: ${a}`,w.ERROR)}}}}var Em=e=>typeof e=="string"?e.toLowerCase():null,bu=V({name:"lower",numArgs:1,flags:T.UTF8|T.DETERMINISTIC},Em),ym=e=>typeof e=="string"?e.toUpperCase():null,Nu=V({name:"upper",numArgs:1,flags:T.UTF8|T.DETERMINISTIC},ym),wm=e=>e===null?null:typeof e=="string"||e instanceof Uint8Array?e.length:null,Cu=V({name:"length",numArgs:1,flags:T.UTF8|T.DETERMINISTIC},wm),Su=(e,t,n)=>{if(e===null||t===null)return null;let r=String(e),s=Number(t),o=n===void 0?void 0:Number(n);if(isNaN(s)||o!==void 0&&isNaN(o))return null;s=Math.trunc(s),o=o===void 0?void 0:Math.trunc(o);let a=r.length,i;s>0?i=s-1:s<0?i=a+s:i=0,i=Math.max(0,i);let u;return o===void 0?u=a:o>=0?u=i+o:u=i,r.substring(i,u)},Ru=V({name:"substr",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},(e,t,n)=>Su(e,t,n)),Au=V({name:"substring",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},(e,t,n)=>Su(e,t,n)),Im=e=>{if(e===null)return null;if(typeof e=="bigint")return e<0n?-e:e;let t=Number(e);return isNaN(t)?null:Math.abs(t)},Tu=V({name:"abs",numArgs:1,flags:T.DETERMINISTIC},Im),bm=(e,t)=>{if(e===null)return null;let n=Number(e);if(isNaN(n))return null;let r=0;if(t!=null){let s=Number(t);if(isNaN(s))return null;r=Math.trunc(s)}try{let s=Math.pow(10,r);return Math.round(n*s)/s}catch{return null}},vu=V({name:"round",numArgs:-1,flags:T.DETERMINISTIC},(e,t)=>bm(e,t)),Nm=(...e)=>{for(let t of e)if(t!==null)return t;return null},Lu=V({name:"coalesce",numArgs:-1,flags:T.DETERMINISTIC},Nm),Cm=(e,t)=>fe(e,t)===0?null:e,Ou=V({name:"nullif",numArgs:2,flags:T.DETERMINISTIC},Cm);function Sm(e,t){let r=e.replace(/[.*+^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,".");try{return new RegExp(`^${r}$`).test(t)}catch(s){return console.error(`Invalid LIKE pattern converted to regex: ^${r}$`,s),!1}}var Rm=(e,t)=>e===null||t===null?null:Sm(String(t),String(e)),xu=V({name:"like",numArgs:2,flags:T.UTF8|T.DETERMINISTIC},Rm);function Am(e,t){let r=e.replace(/[.*+^${}()|[\]\\]/g,"\\$&").replace(/\\\*/g,".*").replace(/\\\?/g,".");try{return new RegExp(`^${r}$`).test(t)}catch(s){return console.error(`Invalid GLOB pattern converted to regex: ^${r}$`,s),!1}}var Tm=(e,t)=>t===null||e===null?null:Am(String(e),String(t)),Mu=V({name:"glob",numArgs:2,flags:T.UTF8|T.DETERMINISTIC},Tm);var vm=e=>(e??0)+1,Lm=e=>e??0,Du=Ce({name:"count",numArgs:0,flags:T.UTF8|T.DETERMINISTIC,initialState:0},vm,Lm),Om=(e,t)=>{if(t===null)return e;let n=e?.sum??0,r=t;try{if(typeof t!="bigint"&&(r=Number(t),isNaN(r)))return e;if(typeof n=="bigint"||typeof r=="bigint")return{sum:BigInt(n)+BigInt(r)};{let s=n+r;return s>Number.MAX_SAFE_INTEGER||s<Number.MIN_SAFE_INTEGER?{sum:BigInt(n)+BigInt(r)}:{sum:s}}}catch(s){return console.warn("Error during SUM step coercion:",s),e}},xm=e=>e?.sum??null,Pu=Ce({name:"sum",numArgs:1,flags:T.UTF8},Om,xm),Mm=(e,t)=>{if(t===null)return e;let n=e?.sum??0,r=e?.count??0,s=t;try{return typeof t!="bigint"&&(s=Number(t),isNaN(s))?e:{sum:Number(n)+Number(s),count:r+1}}catch(o){return console.warn("Error during AVG step coercion:",o),e}},Dm=e=>!e||e.count===0?null:Number(e.sum)/e.count,ku=Ce({name:"avg",numArgs:1,flags:T.UTF8},Mm,Dm),Pm=(e,t)=>t===null?e:e===null?{min:t}:fe(t,e.min)<0?{min:t}:e,km=e=>e?.min??null,Fu=Ce({name:"min",numArgs:1,flags:T.UTF8},Pm,km),Fm=(e,t)=>t===null?e:e===null?{max:t}:fe(t,e.max)>0?{max:t}:e,Um=e=>e?.max??null,Uu=Ce({name:"max",numArgs:1,flags:T.UTF8},Fm,Um),$m=(e,t)=>t===null?e??0:(e??0)+1,Bm=e=>e??0,$u=Ce({name:"count",numArgs:1,flags:T.UTF8|T.DETERMINISTIC},$m,Bm),_m=(e,t,n)=>{if(t===null)return e??{values:[]};let r=e?.values??[],s=String(t);return r.push(s),{values:r}},Vm=(e,t)=>{if(!e||e.values.length===0)return null;let n=t==null?",":String(t);return e.values.join(n)},mb=Ce({name:"group_concat",numArgs:-1,flags:T.UTF8},(e,...t)=>_m(e,t[0],t[1]),(e,...t)=>Vm(e,t[1])),Km=(e,t,n=",")=>{let r=e??{values:[],separator:String(n)},s=n==null?r.separator:String(n);if(t===null)return{...r,separator:s};let o=String(t);return r.values.push(o),{values:r.values,separator:s}},Gm=e=>!e||e.values.length===0?null:e.values.join(e.separator),Bu=Ce({name:"group_concat",numArgs:-1,flags:T.UTF8,initialState:{values:[],separator:","}},Km,Gm);function xe(e,t,n,r,s){return At(t,((o,a)=>{let i=o[a];if(i===void 0)throw new TypeError(wi(a));return i})(e,t),n,r,s)}function At(e,t,n,r,s,o){let a=gr(t,n,r);if(s&&t!==a)throw new RangeError(Nd(e,t,n,r,o));return a}function Ee(e){return e!==null&&/object|function/.test(typeof e)}function Pe(e,t=Map){let n=new t;return(r,...s)=>{if(n.has(r))return n.get(r);let o=e(r,...s);return n.set(r,o),o}}function kn(e){return cn({name:e},1)}function cn(e,t){return rt(n=>({value:n,configurable:1,writable:!t}),e)}function ec(e){return rt(t=>({get:t,configurable:1}),e)}function As(e){return{[Symbol.toStringTag]:{value:e,configurable:1}}}function Fn(e,t){let n={},r=e.length;for(let s of t)n[e[--r]]=s;return n}function rt(e,t,n){let r={};for(let s in t)r[s]=e(t[s],s,n);return r}function Sr(e,t,n){let r={};for(let s=0;s<t.length;s++){let o=t[s];r[o]=e(o,s,n)}return r}function tc(e,t,n){let r={};for(let s=0;s<e.length;s++)r[t[s]]=n[e[s]];return r}function Ge(e,t){let n=Object.create(null);for(let r of e)n[r]=t[r];return n}function _u(e,t){for(let n of t)if(n in e)return 1;return 0}function nc(e,t,n){for(let r of e)if(t[r]!==n[r])return 0;return 1}function rc(e,t,n){let r={...n};for(let s=0;s<t;s++)r[e[s]]=0;return r}function G(e,...t){return(...n)=>e(...t,...n)}function Vu(e){return e[0].toUpperCase()+e.substring(1)}function Rr(e){return e.slice().sort()}function ys(e,t){return String(t).padStart(e,"0")}function Ft(e,t){return Math.sign(e-t)}function gr(e,t,n){return Math.min(Math.max(e,t),n)}function Ct(e,t){return[Math.floor(e/t),mr(e,t)]}function mr(e,t){return(e%t+t)%t}function $t(e,t){return[Ts(e,t),oa(e,t)]}function Ts(e,t){return Math.trunc(e/t)||0}function oa(e,t){return e%t||0}function cs(e){return Math.abs(e%1)===.5}function sc(e,t,n){let r=0,s=0;for(let i=0;i<=t;i++){let u=e[n[i]],c=nt[i],d=H/c,[l,h]=$t(u,d);r+=h*c,s+=l}let[o,a]=$t(r,H);return[s+o,a]}function vs(e,t,n){let r={};for(let s=t;s>=0;s--){let o=nt[s];r[n[s]]=Ts(e,o),e=oa(e,o)}return r}function oc(e){if(e!==void 0)return pe(e)}function ac(e){if(e!==void 0)return st(e)}function aa(e){if(e!==void 0)return Ls(e)}function st(e){return lc(Ls(e))}function Ls(e){return la(kp(e))}function ic(e,t){if(t==null)throw new RangeError(wi(e));return t}function Ar(e){if(!Ee(e))throw new TypeError(cp);return e}function ia(e,t,n=e){if(typeof t!==e)throw new TypeError(Wt(n,t));return t}function la(e,t="number"){if(!Number.isInteger(e))throw new RangeError(sp(t,e));return e||0}function lc(e,t="number"){if(e<=0)throw new RangeError(op(t,e));return e}function ua(e){if(typeof e=="symbol")throw new TypeError(up);return String(e)}function ms(e,t){return Ee(e)?String(e):pe(e,t)}function ca(e){if(typeof e=="string")return BigInt(e);if(typeof e!="bigint")throw new TypeError(lp(e));return e}function uc(e,t="number"){if(typeof e=="bigint")throw new TypeError(ip(t));if(e=Number(e),!Number.isFinite(e))throw new RangeError(ap(t,e));return e}function Se(e,t){return Math.trunc(uc(e,t))||0}function fa(e,t){return la(uc(e,t),t)}function Ku(e,t){return lc(Se(e,t),t)}function da(e,t){let[n,r]=$t(t,H),s=e+n,o=Math.sign(s);return o&&o===-Math.sign(r)&&(s-=o,r+=o*H),[s,r]}function Mn(e,t,n=1){return da(e[0]+t[0]*n,e[1]+t[1]*n)}function an(e,t){return da(e[0],e[1]+t)}function et(e,t){return Mn(t,e,-1)}function Ve(e,t){return Ft(e[0],t[0])||Ft(e[1],t[1])}function cc(e,t,n){return Ve(e,t)===-1||Ve(e,n)===1}function ha(e,t=1){let n=BigInt(H/t);return[Number(e/n),Number(e%n)*t]}function Er(e,t=1){let n=H/t,[r,s]=$t(e,n);return[r,s*t]}function tt(e,t=1,n){let[r,s]=e,[o,a]=$t(s,t);return r*(H/t)+(o+(n?a/t:0))}function ma(e,t,n=Ct){let[r,s]=e,[o,a]=n(s,t);return[r*(H/t)+o,a]}function pa(e){return xe(e,"isoYear",Cr,Nr,1),e.isoYear===Cr?xe(e,"isoMonth",4,12,1):e.isoYear===Nr&&xe(e,"isoMonth",1,9,1),e}function ze(e){return ke({...e,...Ae,isoHour:12}),e}function ke(e){let t=xe(e,"isoYear",Cr,Nr,1),n=t===Cr?1:t===Nr?-1:0;return n&&ot(de({...e,isoDay:e.isoDay+n,isoNanosecond:e.isoNanosecond-n})),e}function ot(e){if(!e||cc(e,Kp,Vp))throw new RangeError(zt);return e}function Bt(e){return sc(e,5,Ye)[1]}function Os(e){let[t,n]=Ct(e,H);return[vs(n,5,Ye),t]}function Gu(e){return ma(e,Qe)}function Re(e){return Un(e.isoYear,e.isoMonth,e.isoDay,e.isoHour,e.isoMinute,e.isoSecond,e.isoMillisecond)}function de(e){let t=Re(e);if(t!==void 0){let[n,r]=$t(t,De);return[n,r*ut+(e.isoMicrosecond||0)*Dr+(e.isoNanosecond||0)]}}function ga(e,t){let[n,r]=Os(Bt(e)-t);return ot(de({...e,isoDay:e.isoDay+r,...n}))}function ws(...e){return Un(...e)/Md}function Un(...e){let[t,n]=fc(...e),r=t.valueOf();if(!isNaN(r))return r-n*De}function fc(e,t=1,n=1,r=0,s=0,o=0,a=0){let i=e===Cr?1:e===Nr?-1:0,u=new Date;return u.setUTCHours(r,s,o,a),u.setUTCFullYear(e,t-1,n+i),[u,i]}function $n(e,t){let[n,r]=an(e,t);r<0&&(r+=H,n-=1);let[s,o]=Ct(r,ut),[a,i]=Ct(o,Dr);return xs(n*De+s,a,i)}function xs(e,t=0,n=0){let r=Math.ceil(Math.max(0,Math.abs(e)-Di)/De)*Math.sign(e),s=new Date(e-r*De);return Fn(io,[s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate()+r,s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds(),s.getUTCMilliseconds(),t,n])}function Ea(e,t){if(t<-Di)throw new RangeError(zt);let n=e.formatToParts(t),r={};for(let s of n)r[s.type]=s.value;return r}function ya(e){return[e.isoYear,e.isoMonth,e.isoDay]}function dc(e,t){return[t,0]}function hc(){return kt}function mc(e,t){switch(t){case 2:return wa(e)?29:28;case 4:case 6:case 9:case 11:return 30}return 31}function pc(e){return wa(e)?366:365}function wa(e){return e%4==0&&(e%100!=0||e%400==0)}function gc(e){let[t,n]=fc(e.isoYear,e.isoMonth,e.isoDay);return mr(t.getUTCDay()-n,7)||7}function Ec(e){return this.id===zn?(({isoYear:t})=>t<1?["gregory-inverse",1-t]:["gregory",t])(e):this.id===Kt?jp(e):[]}function qm(e){let t=Re(e);if(t<qp){let{isoYear:o}=e;return o<1?["japanese-inverse",1-o]:["japanese",o]}let n=Ea($i(Kt),t),{era:r,eraYear:s}=Mf(n,Kt);return[r,s]}function Ms(e){return fn(e),Bn(e,1),e}function fn(e){return yc(e,1),e}function qu(e){return nc(Oi,e,yc(e))}function yc(e,t){let{isoYear:n}=e,r=xe(e,"isoMonth",1,hc(),t);return{isoYear:n,isoMonth:r,isoDay:xe(e,"isoDay",1,mc(n,r),t)}}function Bn(e,t){return Fn(Ye,[xe(e,"isoHour",0,23,t),xe(e,"isoMinute",0,59,t),xe(e,"isoSecond",0,59,t),xe(e,"isoMillisecond",0,999,t),xe(e,"isoMicrosecond",0,999,t),xe(e,"isoNanosecond",0,999,t)])}function j(e){return e===void 0?0:zd(Ar(e))}function Tr(e,t=0){e=at(e);let n=Zd(e),r=tg(e,t);return[zd(e),r,n]}function _n(e,t,n,r=9,s=0,o=4){t=at(t);let a=Wd(t,r,s),i=Na(t),u=Fr(t,o),c=kr(t,r,s,1);return a==null?a=Math.max(n,c):Cc(a,c),i=Ca(i,c,1),e&&(u=(d=>d<4?(d+2)%4:d)(u)),[a,c,i,u]}function Ds(e,t=6,n){let r=Na(e=Ps(e,Rs)),s=Fr(e,7),o=kr(e,t);return o=ic(Rs,o),r=Ca(r,o,void 0,n),[o,r,s]}function Ia(e){return Pi(at(e))}function wc(e,t){return ba(at(e),t)}function Ic(e){let t=Ps(e,Xo),n=Gt(Xo,Qp,t,0);if(!n)throw new RangeError(Wt(Xo,n));return n}function ba(e,t=4){let n=Nc(e);return[Fr(e,4),...bc(kr(e,t),n)]}function bc(e,t){return e!=null?[nt[e],e<4?9-3*e:-1]:[t===void 0?1:10**(9-t),t]}function Na(e){let t=e[pr];return t===void 0?1:Se(t,pr)}function Ca(e,t,n,r){let s=r?H:nt[t+1];if(s){let o=nt[t];if(s%((e=At(pr,e,1,s/o-(r?0:1),1))*o))throw new RangeError(Wt(pr,e))}else e=At(pr,e,1,n?10**9:1,1);return e}function Nc(e){let t=e[Ho];if(t!==void 0){if(typeof t!="number"){if(ua(t)==="auto")return;throw new RangeError(Wt(Ho,t))}t=At(Ho,Math.floor(t),0,9,1)}return t}function at(e){return e===void 0?{}:Ar(e)}function Ps(e,t){return typeof e=="string"?{[t]:e}:Ar(e)}function ks(e){return{overflow:Yp[e]}}function Sa(e,t,n=9,r=0,s){let o=t[e];if(o===void 0)return s?r:void 0;if(o=ua(o),o==="auto")return s?r:null;let a=Qo[o];if(a===void 0&&(a=$p[o]),a===void 0)throw new RangeError(Rd(e,o,Qo));return At(e,a,r,n,1,Ni),a}function Gt(e,t,n,r=0){let s=n[e];if(s===void 0)return r;let o=ua(s),a=t[o];if(a===void 0)throw new RangeError(Rd(e,o,t));return a}function Cc(e,t){if(t>e)throw new RangeError(Lp)}function it(e){return{branding:fo,epochNanoseconds:e}}function qe(e,t,n){return{branding:Ot,calendar:n,timeZone:t,epochNanoseconds:e}}function je(e,t=e.calendar){return{branding:En,calendar:t,...Ge(Bp,e)}}function lt(e,t=e.calendar){return{branding:Zn,calendar:t,...Ge(xi,e)}}function yr(e,t=e.calendar){return{branding:lo,calendar:t,...Ge(xi,e)}}function Is(e,t=e.calendar){return{branding:uo,calendar:t,...Ge(xi,e)}}function He(e){return{branding:co,...Ge(Gd,e)}}function ae(e){return{branding:ho,sign:qt(e),...Ge(Ti,e)}}function Fs(e){return ma(e.epochNanoseconds,ut)[0]}function Sc(e){return((t,n=1)=>{let[r,s]=t,o=Math.floor(s/n),a=H/n;return BigInt(r)*BigInt(a)+BigInt(o)})(e.epochNanoseconds)}function Rc(e){return e.epochNanoseconds}function Ac(e,t,n,r,s){let o=ln(r),[a,i]=((I,N)=>{let C=N((I=Ps(I,na))[jd]),S=eg(I);return S=ic(na,S),[S,C]})(s,e),u=Math.max(a,o);if(!i&&Ir(u,i))return ju(r,a);if(!i)throw new RangeError(ro);if(!r.sign)return 0;let[c,d,l]=Ks(t,n,i),h=Ya(l),p=Gs(l),g=Wa(l),E=p(d,c,r);Dn(i)||(ke(c),ke(E));let y=g(d,c,E,a);return Ir(a,i)?ju(y,a):((I,N,C,S,A,L,v)=>{let M=qt(I),[O,$]=Ra(S,Li(C,I),C,M,A,L,v),z=Aa(N,O,$);return I[Y[C]]+z*M})(y,h(E),a,d,c,h,p)}function ju(e,t){return tt(he(e),nt[t],1)}function Ra(e,t,n,r,s,o,a){let i=Y[n],u={...t,[i]:t[i]+r},c=a(e,s,t),d=a(e,s,u);return[o(c),o(d)]}function Aa(e,t,n){let r=tt(et(t,n));if(!r)throw new RangeError(Wn);return tt(et(t,e))/r}function Tc(e,t){let[n,r,s]=Ds(t,5,1);return it($s(e.epochNanoseconds,n,r,s,1))}function vc(e,t,n){let{epochNanoseconds:r,timeZone:s,calendar:o}=t,[a,i,u]=Ds(n);if(a===0&&i===1)return t;let c=e(s);if(a===6)r=((d,l,h,p)=>{let g=Fe(h,l),[E,y]=d(g),I=h.epochNanoseconds,N=Vt(l,E),C=Vt(l,y);if(cc(I,N,C))throw new RangeError(Wn);return Uc(Aa(I,N,C),p)?C:N})(kc,c,t,u);else{let d=c.R(r);r=Kn(c,Dc($n(r,d),a,i,u),d,2,0,1)}return qe(r,s,o)}function Lc(e,t){return je(Dc(e,...Ds(t)),e.calendar)}function Oc(e,t){let[n,r,s]=Ds(t,5);var o;return He((o=s,Ta(e,vr(n,r),o)[0]))}function xc(e,t){let n=e(t.timeZone),r=Fe(t,n),[s,o]=kc(r),a=tt(et(Vt(n,s),Vt(n,o)),ao,1);if(a<=0)throw new RangeError(Wn);return a}function Mc(e,t){let{timeZone:n,calendar:r}=t,s=((o,a,i)=>Vt(a,o(Fe(i,a))))(Fc,e(n),t);return qe(s,n,r)}function Dc(e,t,n,r){return Pc(e,vr(t,n),r)}function Pc(e,t,n){let[r,s]=Ta(e,t,n);return ke({...dn(e,s),...r})}function Ta(e,t,n){return Os(_t(Bt(e),t,n))}function bs(e){return _t(e,oo,7)}function vr(e,t){return nt[e]*t}function kc(e){let t=Fc(e);return[t,dn(t,1)]}function Fc(e){return _p(6,e)}function jm(e,t,n){let r=Math.min(ln(e),6);return Gn(Bs(he(e,r),t,n),r)}function Us(e,t,n,r,s,o,a,i,u,c){if(r===0&&s===1)return e;let d=Ir(r,i)?Dn(i)&&r<6&&n>=6?Wm:Ym:zm,[l,h,p]=d(e,t,n,r,s,o,a,i,u,c);return p&&r!==7&&(l=((g,E,y,I,N,C,S,A)=>{let L=qt(g);for(let v=I+1;v<=y;v++){if(v===7&&y!==7)continue;let M=Li(v,g);M[Y[v]]+=L;let O=tt(et(S(A(N,C,M)),E));if(O&&Math.sign(O)!==L)break;g=M}return g})(l,h,n,Math.max(6,r),a,i,u,c)),l}function $s(e,t,n,r,s){if(t===6){let o=(a=>a[0]+a[1]/H)(e);return[_t(o,n,r),0]}return Bs(e,vr(t,n),r,s)}function Bs(e,t,n,r){let[s,o]=e;r&&o<0&&(o+=H,s-=1);let[a,i]=Ct(_t(o,t,n),H);return da(s+a,i)}function _t(e,t,n){return Uc(e/t,n)*t}function Uc(e,t){return sg[t](e)}function Ym(e,t,n,r,s,o){let a=qt(e),i=he(e),u=$s(i,r,s,o),c=et(i,u),d=Math.sign(u[0]-i[0])===a,l=Gn(u,Math.min(n,6));return[{...e,...l},Mn(t,c),d]}function Wm(e,t,n,r,s,o,a,i,u,c){let d=qt(e)||1,l=tt(he(e,5)),h=vr(r,s),p=_t(l,h,o),[g,E]=Ra(a,{...e,...vi},6,d,i,u,c),y=p-tt(et(g,E)),I=0;y&&Math.sign(y)!==d?t=an(g,p):(I+=d,p=_t(y,h,o),t=an(E,p));let N=js(p);return[{...e,...N,days:e.days+I},t,!!I]}function zm(e,t,n,r,s,o,a,i,u,c){let d=qt(e),l=Y[r],h=Li(r,e);r===7&&(e={...e,weeks:e.weeks+Math.trunc(e.days/7)});let p=Ts(e[l],s)*s;h[l]=p;let[g,E]=Ra(a,h,r,s*d,i,u,c),y=p+Aa(t,g,E)*d*s,I=_t(y,s,o),N=Math.sign(I-y)===d;return h[l]=I,[h,N?E:g,N]}function va(e,t,n,r){let[s,o,a,i]=(c=>{let d=ba(c=at(c));return[c.timeZone,...d]})(r),u=s!==void 0;return((c,d,l,h,p,g)=>{l=Bs(l,p,h,1);let E=d.R(l);return ka($n(l,E),g)+(c?Vn(bs(E)):"Z")})(u,t(u?e(s):yn),n.epochNanoseconds,o,a,i)}function La(e,t,n){let[r,s,o,a,i,u]=(c=>{c=at(c);let d=Pi(c),l=Nc(c),h=rg(c),p=Fr(c,4),g=kr(c,4);return[d,ng(c),h,p,...bc(g,l)]})(n);return((c,d,l,h,p,g,E,y,I,N)=>{h=Bs(h,I,y,1);let C=c(l).R(h);return ka($n(h,C),N)+Vn(bs(C),E)+((S,A)=>A!==1?"["+(A===2?"!":"")+S+"]":"")(l,g)+Fa(d,p)})(e,t.calendar,t.timeZone,t.epochNanoseconds,r,s,o,a,i,u)}function Oa(e,t){let[n,r,s,o]=(c=>(c=at(c),[Pi(c),...ba(c)]))(t);return a=e.calendar,i=n,u=o,ka(Pc(e,s,r),u)+Fa(a,i);var a,i,u}function xa(e,t){return n=e.calendar,r=e,s=Ia(t),Ns(r)+Fa(n,s);var n,r,s}function Ma(e,t){return $c(e.calendar,Bc,e,Ia(t))}function Da(e,t){return $c(e.calendar,Zm,e,Ia(t))}function Pa(e,t){let[n,r,s]=wc(t);return o=s,_c(Ta(e,r,n)[0],o);var o}function _s(e,t){let[n,r,s]=wc(t,3);return r>1&&hn(e={...e,...jm(e,r,n)}),((o,a)=>{let{sign:i}=o,u=i===-1?Te(o):o,{hours:c,minutes:d}=u,[l,h]=ma(he(u,3),Qe,$t);Wc(l);let p=Ua(h,a),g=a>=0||!i||p;return(i<0?"-":"")+"P"+Yu({Y:on(u.years),M:on(u.months),W:on(u.weeks),D:on(u.days)})+(c||d||l||g?"T"+Yu({H:on(c),M:on(d),S:on(l,g)+p}):"")})(e,s)}function $c(e,t,n,r){let s=r>1||r===0&&e!==q;return r===1?e===q?t(n):Ns(n):s?Ns(n)+Vc(e,r===2):t(n)}function Yu(e){let t=[];for(let n in e){let r=e[n];r&&t.push(r,n)}return t.join("")}function ka(e,t){return Ns(e)+"T"+_c(e,t)}function Ns(e){return Bc(e)+"-"+Ze(e.isoDay)}function Bc(e){let{isoYear:t}=e;return(t<0||t>9999?Kc(t)+ys(6,Math.abs(t)):ys(4,t))+"-"+Ze(e.isoMonth)}function Zm(e){return Ze(e.isoMonth)+"-"+Ze(e.isoDay)}function _c(e,t){let n=[Ze(e.isoHour),Ze(e.isoMinute)];return t!==-1&&n.push(Ze(e.isoSecond)+((r,s,o,a)=>Ua(r*ut+s*Dr+o,a))(e.isoMillisecond,e.isoMicrosecond,e.isoNanosecond,t)),n.join(":")}function Vn(e,t=0){if(t===1)return"";let[n,r]=Ct(Math.abs(e),ao),[s,o]=Ct(r,oo),[a,i]=Ct(o,Qe);return Kc(e)+Ze(n)+":"+Ze(s)+(a||i?":"+Ze(a)+Ua(i):"")}function Fa(e,t){return t!==1&&(t>1||t===0&&e!==q)?Vc(e,t===2):""}function Vc(e,t){return"["+(t?"!":"")+"u-ca="+e+"]"}function Ua(e,t){let n=ys(9,e);return n=t===void 0?n.replace(ig,""):n.slice(0,t),n?"."+n:""}function Kc(e){return e<0?"-":"+"}function on(e,t){return e||t?e.toLocaleString("fullwide",{useGrouping:0}):""}function Hm(e,t){let{epochNanoseconds:n}=e,r=(t.R?t:t(e.timeZone)).R(n),s=$n(n,r);return{calendar:e.calendar,...s,offsetNanoseconds:r}}function Kn(e,t,n,r=0,s=0,o,a){if(n!==void 0&&r===1&&(r===1||a))return ga(t,n);let i=e.I(t);if(n!==void 0&&r!==3){let u=((c,d,l,h)=>{let p=de(d);h&&(l=bs(l));for(let g of c){let E=tt(et(g,p));if(h&&(E=bs(E)),E===l)return g}})(i,t,n,o);if(u!==void 0)return u;if(r===0)throw new RangeError(Cp)}return a?de(t):Lr(e,t,s,i)}function Lr(e,t,n=0,r=e.I(t)){if(r.length===1)return r[0];if(n===1)throw new RangeError(Sp);if(r.length)return r[n===3?1:0];let s=de(t),o=((i,u)=>{let c=i.R(an(u,-H));return(d=>{if(d>H)throw new RangeError(Np);return d})(i.R(an(u,H))-c)})(e,s),a=o*(n===2?-1:1);return(r=e.I($n(s,a)))[n===2?0:r.length-1]}function Vt(e,t){let n=e.I(t);if(n.length)return n[0];let r=an(de(t),-H);return e.O(r,1)}function $a(e,t,n){return it(ot(Mn(t.epochNanoseconds,(r=>{if(zc(r))throw new RangeError(Tp);return he(r,5)})(e?Te(n):n))))}function Ba(e,t,n,r,s,o=Object.create(null)){let a=t(r.timeZone),i=e(r.calendar);return{...r,...qa(a,i,r,n?Te(s):s,o)}}function _a(e,t,n,r,s=Object.create(null)){let{calendar:o}=n;return je(ja(e(o),n,t?Te(r):r,s),o)}function Va(e,t,n,r,s){let{calendar:o}=n;return lt(Vs(e(o),n,t?Te(r):r,s),o)}function Ka(e,t,n,r,s){let o=n.calendar,a=e(o),i=ze(wr(a,n));t&&(r=qs(r)),r.sign<0&&(i=a.P(i,{...me,months:1}),i=dn(i,-1));let u=a.P(i,r,s);return yr(wr(a,u),o)}function Ga(e,t,n){return He(Gc(t,e?Te(n):n)[0])}function qa(e,t,n,r,s){let o=he(r,5),a=n.epochNanoseconds;if(zc(r)){let i=Fe(n,e);a=Mn(Lr(e,{...Vs(t,i,{...r,...vi},s),...Ge(Ye,i)}),o)}else a=Mn(a,o),j(s);return{epochNanoseconds:ot(a)}}function ja(e,t,n,r){let[s,o]=Gc(t,n);return ke({...Vs(e,t,{...n,...vi,days:n.days+o},r),...s})}function Vs(e,t,n,r){if(n.years||n.months||n.weeks)return e.P(t,n,r);j(r);let s=n.days+he(n,5)[0];return s?ze(dn(t,s)):t}function wr(e,t,n=1){return dn(t,n-e.day(t))}function Gc(e,t){let[n,r]=he(t,5),[s,o]=Os(Bt(e)+r);return[s,n+o]}function dn(e,t){return t?{...e,...xs(Re(e)+t*De)}:e}function Ks(e,t,n){let r=e(n.calendar);return Dn(n)?[n,r,t(n.timeZone)]:[{...n,...Ae},r]}function Ya(e){return e?Rc:de}function Gs(e){return e?G(qa,e):ja}function Wa(e){return e?G(Jm,e):Qm}function Dn(e){return e&&e.epochNanoseconds}function Ir(e,t){return e<=6-(Dn(t)?1:0)}function za(e,t,n,r,s,o,a){let i=e(at(a).relativeTo),u=Math.max(ln(s),ln(o));if(Ir(u,i))return ae(hn(((E,y,I,N)=>{let C=Mn(he(E),he(y),N?-1:1);if(!Number.isFinite(C[0]))throw new RangeError(zt);return{...me,...Gn(C,I)}})(s,o,u,r)));if(!i)throw new RangeError(ro);r&&(o=Te(o));let[c,d,l]=Ks(t,n,i),h=Gs(l),p=Wa(l),g=h(d,c,s);return ae(p(d,c,h(d,g,o),u))}function qc(e,t,n,r,s){let o=ln(r),[a,i,u,c,d]=((L,v,M)=>{L=Ps(L,Rs);let O=Wd(L),$=M(L[jd]),z=Na(L),ee=Fr(L,7),Z=kr(L);if(O===void 0&&Z===void 0)throw new RangeError(vp);if(Z==null&&(Z=0),O==null&&(O=Math.max(Z,v)),Cc(O,Z),z=Ca(z,Z,1),z>1&&Z>5&&O!==Z)throw new RangeError("For calendar units with roundingIncrement > 1, use largestUnit = smallestUnit");return[O,Z,z,ee,$]})(s,o,e),l=Math.max(o,a);if(!d&&l<=6)return ae(hn(((L,v,M,O,$)=>{let z=$s(he(L),M,O,$);return{...me,...Gn(z,v)}})(r,a,i,u,c)));if(!Dn(d)&&!r.sign)return r;if(!d)throw new RangeError(ro);let[h,p,g]=Ks(t,n,d),E=Ya(g),y=Gs(g),I=Wa(g),N=y(p,h,r);Dn(d)||(ke(h),ke(N));let C=I(p,h,N,a),S=r.sign,A=qt(C);if(S&&A&&S!==A)throw new RangeError(Wn);return C=Us(C,E(N),a,i,u,c,p,h,E,y),ae(C)}function jc(e){return e.sign===-1?qs(e):e}function qs(e){return ae(Te(e))}function Te(e){let t={};for(let n of Y)t[n]=-1*e[n]||0;return t}function Yc(e){return!e.sign}function qt(e,t=Y){let n=0;for(let r of t){let s=Math.sign(e[r]);if(s){if(n&&n!==s)throw new RangeError(Ap);n=s}}return n}function hn(e){for(let t of Up)At(t,e[t],-Xu,Xu,1);return Wc(tt(he(e),Qe)),e}function Wc(e){if(!Number.isSafeInteger(e))throw new RangeError(Rp)}function he(e,t=6){return sc(e,t,Y)}function Gn(e,t=6){let[n,r]=e,s=vs(r,t,Y);if(s[Y[t]]+=n*(H/nt[t]),!Number.isFinite(s[Y[t]]))throw new RangeError(zt);return s}function js(e,t=5){return vs(e,t,Y)}function zc(e){return!!qt(e,Kd)}function ln(e){let t=9;for(;t>0&&!e[Y[t]];t--);return t}function Xm(e,t){return[e,t]}function Wu(e){let t=Math.floor(e/gs)*gs;return[t,t+gs]}function Zc(e){let t=jt(e=ms(e));if(!t)throw new RangeError(Me(e));let n;if(t.j)n=0;else{if(!t.offset)throw new RangeError(Me(e));n=mn(t.offset)}return t.timeZone&&Ja(t.timeZone,1),it(ga(Ms(t),n))}function Hc(e){let t=jt(pe(e));if(!t)throw new RangeError(Me(e));if(t.timeZone)return of(t,t.offset?mn(t.offset):void 0);if(t.j)throw new RangeError(Me(e));return lf(t)}function Xc(e,t){let n=jt(pe(e));if(!n||!n.timeZone)throw new RangeError(Me(e));let{offset:r}=n,s=r?mn(r):void 0,[,o,a]=Tr(t);return of(n,s,o,a)}function mn(e){let t=Ja(e);if(t===void 0)throw new RangeError(Me(e));return t}function Jc(e){let t=jt(pe(e));if(!t||t.j)throw new RangeError(Me(e));return je(af(t))}function Ys(e,t,n){let r=jt(pe(e));if(!r||r.j)throw new RangeError(Me(e));return t?r.calendar===q&&(r=r.isoYear===-271821&&r.isoMonth===4?{...r,isoDay:20,...Ae}:{...r,isoDay:1,...Ae}):n&&r.calendar===q&&(r={...r,isoYear:Rt}),lt(r.C?af(r):lf(r))}function Qc(e,t){let n=Ha(pe(t));if(n)return Za(n),yr(pa(fn(n)));let r=Ys(t,1);return yr(wr(e(r.calendar),r))}function Za(e){if(e.calendar!==q)throw new RangeError(St(e.calendar))}function ef(e,t){let n=Xa(pe(t));if(n)return Za(n),Is(fn(n));let r=Ys(t,0,1),{calendar:s}=r,o=e(s),[a,i,u]=o.v(r),[c,d]=o.q(a,i),[l,h]=o.G(c,d,u);return Is(ze(o.V(l,h,u)),s)}function tf(e){let t,n=(r=>{let s=dg.exec(r);return s?(Ws(s[10]),ff(s)):void 0})(pe(e));if(!n){if(n=jt(e),!n)throw new RangeError(Me(e));if(!n.C)throw new RangeError(Me(e));if(n.j)throw new RangeError(St("Z"));Za(n)}if((t=Ha(e))&&qu(t))throw new RangeError(Me(e));if((t=Xa(e))&&qu(t))throw new RangeError(Me(e));return He(Bn(n,1))}function nf(e){let t=(n=>{let r=pg.exec(n);return r?(s=>{function o(d,l,h){let p=0,g=0;if(h&&([p,u]=Ct(u,nt[h])),d!==void 0){if(i)throw new RangeError(St(d));g=(E=>{let y=parseInt(E);if(!Number.isFinite(y))throw new RangeError(St(E));return y})(d),a=1,l&&(u=Qa(l)*(nt[h]/Qe),i=1)}return p+g}let a=0,i=0,u=0,c={...Fn(Y,[o(s[2]),o(s[3]),o(s[4]),o(s[5]),o(s[6],s[7],5),o(s[8],s[9],4),o(s[10],s[11],3)]),...vs(u,2,Y)};if(!a)throw new RangeError(Cd(Y));return ei(s[1])<0&&(c=Te(c)),c})(r):void 0})(pe(e));if(!t)throw new RangeError(Me(e));return ae(hn(t))}function rf(e){let t=jt(e)||Ha(e)||Xa(e);return t?t.calendar:e}function sf(e){let t=jt(e);return t&&(t.timeZone||t.j&&yn||t.offset)||e}function of(e,t,n=0,r=0){let s=zs(e.timeZone),o=B(s),a;return Ms(e),a=e.C?Kn(o,e,t,n,r,!o.$,e.j):Vt(o,e),qe(a,s,xr(e.calendar))}function af(e){return uf(ke(Ms(e)))}function lf(e){return uf(ze(fn(e)))}function uf(e){return{...e,calendar:xr(e.calendar)}}function jt(e){let t=fg.exec(e);return t?(n=>{let r=n[10],s=(r||"").toUpperCase()==="Z";return{isoYear:cf(n),isoMonth:parseInt(n[4]),isoDay:parseInt(n[5]),...ff(n.slice(5)),...Ws(n[16]),C:!!n[6],j:s,offset:s?void 0:r}})(t):void 0}function Ha(e){let t=ug.exec(e);return t?(n=>({isoYear:cf(n),isoMonth:parseInt(n[4]),isoDay:1,...Ws(n[5])}))(t):void 0}function Xa(e){let t=cg.exec(e);return t?(n=>({isoYear:Rt,isoMonth:parseInt(n[1]),isoDay:parseInt(n[2]),...Ws(n[3])}))(t):void 0}function Ja(e,t){let n=hg.exec(e);return n?((r,s)=>{let o=r[4]||r[5];if(s&&o)throw new RangeError(St(o));return(a=>{if(Math.abs(a)>=H)throw new RangeError(bp);return a})((xn(r[2])*ao+xn(r[3])*oo+xn(r[4])*Qe+Qa(r[5]||""))*ei(r[1]))})(n,t):void 0}function cf(e){let t=ei(e[1]),n=parseInt(e[2]||e[3]);if(t<0&&!n)throw new RangeError(St(-0));return t*n}function ff(e){let t=xn(e[3]);return{...Os(Qa(e[4]||""))[0],isoHour:xn(e[1]),isoMinute:xn(e[2]),isoSecond:t===60?59:t}}function Ws(e){let t,n,r=[];if(e.replace(mg,(s,o,a)=>{let i=!!o,[u,c]=a.split("=").reverse();if(c){if(c==="u-ca")r.push(u),t||(t=i);else if(i||/[A-Z]/.test(c))throw new RangeError(St(s))}else{if(n)throw new RangeError(St(s));n=u}return""}),r.length>1&&t)throw new RangeError(St(e));return{timeZone:n,calendar:r[0]||q}}function Qa(e){return parseInt(e.padEnd(9,"0"))}function qn(e){return new RegExp(`^${e}$`,"i")}function ei(e){return e&&e!=="+"?-1:1}function xn(e){return e===void 0?0:parseInt(e)}function df(e){return zs(pe(e))}function zs(e){let t=ti(e);return typeof t=="number"?Vn(t):t?(n=>{if(yg.test(n))throw new RangeError(bi(n));if(Eg.test(n))throw new RangeError(Ip);return n.toLowerCase().split("/").map((r,s)=>(r.length<=3||/\d/.test(r))&&!/etc|yap/.test(r)?r.toUpperCase():r.replace(/baja|dumont|[a-z]+/g,(o,a)=>o.length<=2&&!s||o==="in"||o==="chat"?o.toUpperCase():o.length>2||!a?Vu(o).replace(/island|noronha|murdo|rivadavia|urville/,Vu):o)).join("/")})(e):yn}function zu(e){let t=ti(e);return typeof t=="number"?t:t?t.resolvedOptions().timeZone:yn}function ti(e){let t=Ja(e=e.toUpperCase(),1);return t!==void 0?t:e!==yn?gg(e):void 0}function ni(e,t){return Ve(e.epochNanoseconds,t.epochNanoseconds)}function ri(e,t){return Ve(e.epochNanoseconds,t.epochNanoseconds)}function hf(e,t,n,r,s,o){let a=e(at(o).relativeTo),i=Math.max(ln(r),ln(s));if(nc(Y,r,s))return 0;if(Ir(i,a))return Ve(he(r),he(s));if(!a)throw new RangeError(ro);let[u,c,d]=Ks(t,n,a),l=Ya(d),h=Gs(d);return Ve(l(h(c,u,r)),l(h(c,u,s)))}function si(e,t){return pn(e,t)||Zs(e,t)}function pn(e,t){return Ft(Re(e),Re(t))}function Zs(e,t){return Ft(Bt(e),Bt(t))}function mf(e,t){return!ni(e,t)}function pf(e,t){return!ri(e,t)&&!!bf(e.timeZone,t.timeZone)&&e.calendar===t.calendar}function gf(e,t){return!si(e,t)&&e.calendar===t.calendar}function Ef(e,t){return!pn(e,t)&&e.calendar===t.calendar}function yf(e,t){return!pn(e,t)&&e.calendar===t.calendar}function wf(e,t){return!pn(e,t)&&e.calendar===t.calendar}function If(e,t){return!Zs(e,t)}function bf(e,t){if(e===t)return 1;try{return zu(e)===zu(t)}catch{}}function oi(e,t,n,r){let s=_n(e,r,3,5),o=Hs(t.epochNanoseconds,n.epochNanoseconds,...s);return ae(e?Te(o):o)}function ai(e,t,n,r,s,o){let a=Js(r.calendar,s.calendar),[i,u,c,d]=_n(n,o,5),l=r.epochNanoseconds,h=s.epochNanoseconds,p=Ve(h,l),g;if(p)if(i<6)g=Hs(l,h,i,u,c,d);else{let E=t(((I,N)=>{if(!bf(I,N))throw new RangeError(Ld);return I})(r.timeZone,s.timeZone)),y=e(a);g=Cf(y,E,r,s,p,i,o),g=Us(g,h,i,u,c,d,y,r,Rc,G(qa,E))}else g=me;return ae(n?Te(g):g)}function ii(e,t,n,r,s){let o=Js(n.calendar,r.calendar),[a,i,u,c]=_n(t,s,6),d=de(n),l=de(r),h=Ve(l,d),p;if(h)if(a<=6)p=Hs(d,l,a,i,u,c);else{let g=e(o);p=Sf(g,n,r,h,a,s),p=Us(p,l,a,i,u,c,g,n,de,ja)}else p=me;return ae(t?Te(p):p)}function li(e,t,n,r,s){let o=Js(n.calendar,r.calendar);return Nf(t,()=>e(o),n,r,..._n(t,s,6,9,6))}function ui(e,t,n,r,s){let o=Js(n.calendar,r.calendar),a=_n(t,s,9,9,8),i=e(o),u=wr(i,n),c=wr(i,r);return u.isoYear===c.isoYear&&u.isoMonth===c.isoMonth&&u.isoDay===c.isoDay?ae(me):Nf(t,()=>i,ze(u),ze(c),...a,8)}function Nf(e,t,n,r,s,o,a,i,u=6){let c=de(n),d=de(r);if(c===void 0||d===void 0)throw new RangeError(zt);let l;if(Ve(d,c))if(s===6)l=Hs(c,d,s,o,a,i);else{let h=t();l=h.N(n,r,s),o===u&&a===1||(l=Us(l,d,s,o,a,i,h,n,de,Vs))}else l=me;return ae(e?Te(l):l)}function ci(e,t,n,r){let[s,o,a,i]=_n(e,r,5,5),u=_t(fi(t,n),vr(o,a),i),c={...me,...js(u,s)};return ae(e?Te(c):c)}function Jm(e,t,n,r,s,o){let a=Ve(r.epochNanoseconds,n.epochNanoseconds);return a?s<6?Rf(n.epochNanoseconds,r.epochNanoseconds,s):Cf(t,e,n,r,a,s,o):me}function Qm(e,t,n,r,s){let o=de(t),a=de(n),i=Ve(a,o);return i?r<=6?Rf(o,a,r):Sf(e,t,n,i,r,s):me}function Cf(e,t,n,r,s,o,a){let[i,u,c]=((h,p,g,E)=>{function y(){return v={...dn(C,A++*-E),...N},M=Lr(h,v),Ve(S,M)===-E}let I=Fe(p,h),N=Ge(Ye,I),C=Fe(g,h),S=g.epochNanoseconds,A=0,L=fi(I,C),v,M;if(Math.sign(L)===-E&&A++,y()&&(E===-1||y()))throw new RangeError(Wn);let O=tt(et(M,S));return[I,v,O]})(t,n,r,s);var d,l;return{...o===6?(d=i,l=u,{...me,days:Af(d,l)}):e.N(i,u,o,a),...js(c)}}function Sf(e,t,n,r,s,o){let[a,i,u]=((c,d,l)=>{let h=d,p=fi(c,d);return Math.sign(p)===-l&&(h=dn(d,-l),p+=H*l),[c,h,p]})(t,n,r);return{...e.N(a,i,s,o),...js(u)}}function Hs(e,t,n,r,s,o){return{...me,...Gn($s(et(e,t),r,s,o),n)}}function Rf(e,t,n){return{...me,...Gn(et(e,t),n)}}function Af(e,t){return Xs(Re(e),Re(t))}function Xs(e,t){return Math.trunc((t-e)/De)}function fi(e,t){return Bt(t)-Bt(e)}function Js(e,t){if(e!==t)throw new RangeError(vd);return e}function Tf(e){return this.m(e)[0]}function vf(e){return this.m(e)[1]}function di(e){let[t]=this.v(e);return Xs(this.p(t),Re(e))+1}function hi(e){let t=wg.exec(e);if(!t)throw new RangeError(yp(e));return[parseInt(t[1]),!!t[2]]}function Or(e,t){return"M"+Ze(e)+(t?"L":"")}function Cs(e,t,n){return e+(t||n&&e>=n?1:0)}function mi(e,t){return e-(t&&e>=t?1:0)}function Lf(e,t){return(t+e)*(Math.sign(t)||1)||0}function Jo(e){return Bd[xf(e)]}function Of(e){return Pp[xf(e)]}function xf(e){return un(e.id||q)}function ep(e){function t(s){return((o,a)=>({...Mf(o,a),o:o.month,day:parseInt(o.day)}))(Ea(n,s),r)}let n=$i(e),r=un(e);return{id:e,h:tp(t),l:np(t)}}function tp(e){return Pe(t=>{let n=Re(t);return e(n)},WeakMap)}function np(e){let t=e(0).year-Gp;return Pe(n=>{let r,s=Un(n-t),o=0,a=[],i=[];do s+=400*De;while((r=e(s)).year<=n);do if(s+=(1-r.day)*De,r.year===n&&(a.push(s),i.push(r.o)),s-=De,++o>100||s<-Di)throw new RangeError(Wn);while((r=e(s)).year>=n);return{i:a.reverse(),u:xd(i.reverse())}})}function Mf(e,t){let n,r,s=Df(e);if(e.era){let o=Bd[t],a=_d[t]||{};o!==void 0&&(n=t==="islamic"?"ah":e.era.normalize("NFD").toLowerCase().replace(/[^a-z0-9]/g,""),n==="bc"||n==="b"?n="bce":n==="ad"||n==="a"?n="ce":n==="beforeroc"&&(n="broc"),n=a[n]||n,r=s,s=Lf(r,o[n]||0))}return{era:n,eraYear:r,year:s}}function Df(e){return parseInt(e.relatedYear||e.year)}function Ss(e){let{year:t,o:n,day:r}=this.h(e),{u:s}=this.l(t);return[t,s[n]+1,r]}function br(e,t=1,n=1){return this.l(e).i[t-1]+(n-1)*De}function Pf(e,t){let n=ps.call(this,e);return[mi(t,n),n===t]}function ps(e){let t=Hu(this,e),n=Hu(this,e-1),r=t.length;if(r>n.length){let s=Of(this);if(s<0)return-s;for(let o=0;o<r;o++)if(t[o]!==n[o])return o+1}}function fs(e){return Xs(br.call(this,e),br.call(this,e+1))}function Zu(e,t){let{i:n}=this.l(e),r=t+1,s=n;return r>n.length&&(r=1,s=this.l(e+1).i),Xs(n[t-1],s[r-1])}function ds(e){return this.l(e).i.length}function kf(e){let t=this.h(e);return[t.era,t.eraYear]}function Hu(e,t){return Object.keys(e.l(t).u)}function jn(e){return xr(pe(e))}function xr(e){if((e=e.toLowerCase())!==q&&e!==zn){let t=$i(e).resolvedOptions().calendar;if(un(e)!==un(t))throw new RangeError(Ii(e));return t}return e}function un(e){return e==="islamicc"&&(e="islamic"),e.split("-")[0]}function Ff(e,t){return n=>n===q?e:n===zn||n===Kt?Object.assign(Object.create(e),{id:n}):Object.assign(Object.create(t),Ig(n))}function Uf(e,t,n,r){let s=Yt(n,r,vt,[],kd);if(s.timeZone!==void 0){let o=n.F(s),a=Mr(s),i=e(s.timeZone);return{epochNanoseconds:Kn(t(i),{...o,...a},s.offset!==void 0?mn(s.offset):void 0),timeZone:i}}return{...n.F(s),...Ae}}function $f(e,t,n,r,s,o){let a=Yt(n,s,vt,Dd,kd),i=e(a.timeZone),[u,c,d]=Tr(o),l=n.F(a,ks(u)),h=Mr(a,u);return qe(Kn(t(i),{...l,...h},a.offset!==void 0?mn(a.offset):void 0,c,d),i,r)}function Bf(e,t,n){let r=Yt(e,t,vt,[],ct),s=j(n);return je(ke({...e.F(r,ks(s)),...Mr(r,s)}))}function _f(e,t,n,r=[]){let s=Yt(e,t,vt,r);return e.F(s,n)}function Vf(e,t,n,r){let s=Yt(e,t,Ai,r);return e.K(s,n)}function Kf(e,t,n,r){let s=Yt(e,n,vt,Pr);return t&&s.month!==void 0&&s.monthCode===void 0&&s.year===void 0&&(s.year=Rt),e._(s,r)}function Gf(e,t){return He(Mr(Ke(e,ea,[],1),j(t)))}function qf(e){let t=Ke(e,Ti);return ae(hn({...me,...t}))}function Yt(e,t,n,r=[],s=[]){return Ke(t,[...e.fields(n),...s].sort(),r)}function Ke(e,t,n,r=!n){let s={},o,a=0;for(let i of t){if(i===o)throw new RangeError(dp(i));if(i==="constructor"||i==="__proto__")throw new RangeError(fp(i));let u=e[i];if(u!==void 0)a=1,Ju[i]&&(u=Ju[i](u,i)),s[i]=u;else if(n){if(n.includes(i))throw new TypeError(wi(i));s[i]=$d[i]}o=i}if(r&&!a)throw new TypeError(Cd(t));return s}function Mr(e,t){return Bn(Bi({...$d,...e}),t)}function jf(e,t,n,r,s){let{calendar:o,timeZone:a}=n,i=e(o),u=t(a),c=[...i.fields(vt),...Pd].sort(),d=(I=>{let N=Fe(I,B),C=Vn(N.offsetNanoseconds),S=po(I.calendar),[A,L,v]=S.v(N),[M,O]=S.q(A,L),$=Or(M,O);return{...vg(N),year:A,monthCode:$,day:v,offset:C}})(n),l=Ke(r,c),h=i.k(d,l),p={...d,...l},[g,E,y]=Tr(s,2);return qe(Kn(u,{...i.F(h,ks(g)),...Bn(Bi(p),g)},mn(p.offset),E,y),a,o)}function Yf(e,t,n,r){let s=e(t.calendar),o=[...s.fields(vt),...ct].sort(),a={...Qf(i=t),hour:i.isoHour,minute:i.isoMinute,second:i.isoSecond,millisecond:i.isoMillisecond,microsecond:i.isoMicrosecond,nanosecond:i.isoNanosecond};var i;let u=Ke(n,o),c=j(r),d=s.k(a,u),l={...a,...u};return je(ke({...s.F(d,ks(c)),...Bn(Bi(l),c)}))}function Wf(e,t,n,r){let s=e(t.calendar),o=s.fields(vt).sort(),a=Qf(t),i=Ke(n,o),u=s.k(a,i);return s.F(u,r)}function zf(e,t,n,r){let s=e(t.calendar),o=s.fields(Ai).sort(),a=(c=>{let d=po(c.calendar),[l,h]=d.v(c),[p,g]=d.q(l,h);return{year:l,monthCode:Or(p,g)}})(t),i=Ke(n,o),u=s.k(a,i);return s.K(u,r)}function Zf(e,t,n,r){let s=e(t.calendar),o=s.fields(vt).sort(),a=(c=>{let d=po(c.calendar),[l,h,p]=d.v(c),[g,E]=d.q(l,h);return{monthCode:Or(g,E),day:p}})(t),i=Ke(n,o),u=s.k(a,i);return s._(u,r)}function Hf(e,t,n){return He(((r,s,o)=>Mr({...Ge(ea,r),...Ke(s,ea)},j(o)))(e,t,n))}function Xf(e,t){return ae((n=e,r=t,hn({...n,...Ke(r,Ti)})));var n,r}function Jf(e,t,n,r,s){t=Ge(n=e.fields(n),t),r=Ke(r,s=e.fields(s),[]);let o=e.k(t,r);return o=Ke(o,[...n,...s].sort(),[]),e.F(o)}function Wo(e,t){let n=Jo(e),r=_d[e.id||""]||{},{era:s,eraYear:o,year:a}=t;if(s!==void 0||o!==void 0){if(s===void 0||o===void 0)throw new TypeError(mp);if(!n)throw new RangeError(hp);let i=n[r[s]||s];if(i===void 0)throw new RangeError(gp(s));let u=Lf(o,i);if(a!==void 0&&a!==u)throw new RangeError(pp);a=u}else if(a===void 0)throw new TypeError(Ep(n));return a}function hs(e,t,n,r){let{month:s,monthCode:o}=t;if(o!==void 0){let a=((i,u,c,d)=>{let l=i.L(c),[h,p]=hi(u),g=Cs(h,p,l);if(p){let E=Of(i);if(E===void 0)throw new RangeError(hr);if(E>0){if(g>E)throw new RangeError(hr);if(l===void 0){if(d===1)throw new RangeError(hr);g--}}else{if(g!==-E)throw new RangeError(hr);if(l===void 0&&d===1)throw new RangeError(hr)}}return g})(e,o,n,r);if(s!==void 0&&s!==a)throw new RangeError(wp);s=a,r=1}else if(s===void 0)throw new TypeError(Td);return At("month",s,1,e.B(n),r)}function zo(e,t,n,r,s){return xe(t,"day",1,e.U(r,n),s)}function Zo(e,t,n,r){let s=0,o=[];for(let a of n)t[a]!==void 0?s=1:o.push(a);if(Object.assign(e,t),s)for(let a of r||o)delete e[a]}function Qf(e){let t=po(e.calendar),[n,r,s]=t.v(e),[o,a]=t.q(n,r);return{year:n,monthCode:Or(o,a),day:s}}function ed(e){return it(ot(ha(ca(e))))}function td(e,t,n,r,s=q){return qe(ot(ha(ca(n))),t(r),e(s))}function nd(e,t,n,r,s=0,o=0,a=0,i=0,u=0,c=0,d=q){return je(ke(Ms(rt(Se,Fn(io,[t,n,r,s,o,a,i,u,c])))),e(d))}function rd(e,t,n,r,s=q){return lt(ze(fn(rt(Se,{isoYear:t,isoMonth:n,isoDay:r}))),e(s))}function sd(e,t,n,r=q,s=1){let o=Se(t),a=Se(n),i=e(r);return yr(pa(fn({isoYear:o,isoMonth:a,isoDay:Se(s)})),i)}function od(e,t,n,r=q,s=Rt){let o=Se(t),a=Se(n),i=e(r);return Is(ze(fn({isoYear:Se(s),isoMonth:o,isoDay:a})),i)}function ad(e=0,t=0,n=0,r=0,s=0,o=0){return He(Bn(rt(Se,Fn(Ye,[e,t,n,r,s,o])),1))}function id(e=0,t=0,n=0,r=0,s=0,o=0,a=0,i=0,u=0,c=0){return ae(hn(rt(fa,Fn(Y,[e,t,n,r,s,o,a,i,u,c]))))}function ld(e,t,n=q){return qe(e.epochNanoseconds,t,n)}function ud(e){return it(e.epochNanoseconds)}function pi(e,t){return je(Fe(t,e))}function gi(e,t){return lt(Fe(t,e))}function Ei(e,t){return He(Fe(t,e))}function cd(e,t,n,r){let s=((o,a,i,u)=>{let c=(d=>Zd(at(d)))(u);return Lr(o(a),i,c)})(e,n,t,r);return qe(ot(s),n,t.calendar)}function fd(e,t,n,r,s){let o=e(s.timeZone),a=s.plainTime,i=a!==void 0?t(a):void 0,u=n(o),c;return c=i?Lr(u,{...r,...i}):Vt(u,{...r,...Ae}),qe(c,o,r.calendar)}function dd(e,t=Ae){return je(ke({...e,...t}))}function hd(e,t,n){return((r,s)=>{let o=Yt(r,s,Fd);return r.K(o,void 0)})(e(t.calendar),n)}function md(e,t,n){return((r,s)=>{let o=Yt(r,s,Ud);return r._(o)})(e(t.calendar),n)}function pd(e,t,n,r){return((s,o,a)=>Jf(s,o,Fd,Ar(a),Pr))(e(t.calendar),n,r)}function gd(e,t,n,r){return((s,o,a)=>Jf(s,o,Ud,Ar(a),Ci))(e(t.calendar),n,r)}function Ed(e){return it(ot(Er(fa(e),ut)))}function yd(e){return it(ot(ha(ca(e))))}function gn(e,t,n){let r=new Set(n);return(s,o)=>{let a=n&&_u(s,n);if(!_u(s=((i,u)=>{let c={};for(let d in u)i.has(d)||(c[d]=u[d]);return c})(r,s),e)){if(o&&a)throw new TypeError("Invalid formatting options");s={...t,...s}}return n&&(s.timeZone=yn,["full","long"].includes(s.J)&&(s.J="medium")),s}}function Tt(e,t=yi,n=0){let[r,,,s]=e;return(o,a=Wg,...i)=>{let u=t(s&&s(...i),o,a,r,n),c=u.resolvedOptions();return[u,...rp(e,c,i)]}}function yi(e,t,n,r,s){if(n=r(n,s),e){if(n.timeZone!==void 0)throw new TypeError(Op);n.timeZone=e}return new Lt(t,n)}function rp(e,t,n){let[,r,s]=e;return n.map(o=>(o.calendar&&((a,i,u)=>{if((u||a!==q)&&a!==i)throw new RangeError(vd)})(o.calendar,t.calendar,s),r(o,t)))}function wd(e,t,n){let r=t.timeZone,s=e(r),o={...Fe(t,s),...n||Ae},a;return a=n?Kn(s,o,o.offsetNanoseconds,2):Vt(s,o),qe(a,r,t.calendar)}function Id(e,t=Ae){return je(ke({...e,...t}))}function Qs(e,t){return{...e,calendar:t}}function bd(e,t){return{...e,timeZone:t}}function eo(e){let t=to();return $n(t,e.R(t))}function to(){return Er(Date.now(),ut)}function Yn(){return Qu||(Qu=new Lt().resolvedOptions().timeZone)}var sp=(e,t)=>`Non-integer ${e}: ${t}`,op=(e,t)=>`Non-positive ${e}: ${t}`,ap=(e,t)=>`Non-finite ${e}: ${t}`,ip=e=>`Cannot convert bigint to ${e}`,lp=e=>`Invalid bigint: ${e}`,up="Cannot convert Symbol to string",cp="Invalid object",Nd=(e,t,n,r,s)=>s?Nd(e,s[t],s[n],s[r]):Wt(e,t)+`; must be between ${n}-${r}`,Wt=(e,t)=>`Invalid ${e}: ${t}`,wi=e=>`Missing ${e}`,fp=e=>`Invalid field ${e}`,dp=e=>`Duplicate field ${e}`,Cd=e=>"No valid fields: "+e.join(),Sd="Invalid bag",Rd=(e,t,n)=>Wt(e,t)+"; must be "+Object.keys(n).join(),Ad="Cannot use valueOf",no="Invalid calling context",hp="Forbidden era/eraYear",mp="Mismatching era/eraYear",pp="Mismatching year/eraYear",gp=e=>`Invalid era: ${e}`,Ep=e=>"Missing year"+(e?"/era/eraYear":""),yp=e=>`Invalid monthCode: ${e}`,wp="Mismatching month/monthCode",Td="Missing month/monthCode",hr="Invalid leap month",Wn="Invalid protocol results",Ii=e=>Wt("Calendar",e),vd="Mismatching Calendars",bi=e=>Wt("TimeZone",e),Ld="Mismatching TimeZones",Ip="Forbidden ICU TimeZone",bp="Out-of-bounds offset",Np="Out-of-bounds TimeZone gap",Cp="Invalid TimeZone offset",Sp="Ambiguous offset",zt="Out-of-bounds date",Rp="Out-of-bounds duration",Ap="Cannot mix duration signs",ro="Missing relativeTo",Tp="Cannot use large units",vp="Required smallestUnit or largestUnit",Lp="smallestUnit > largestUnit",Me=e=>`Cannot parse: ${e}`,St=e=>`Invalid substring: ${e}`,Od=e=>`Cannot format ${e}`,so="Mismatching types for formatting",Op="Cannot specify TimeZone",xd=G(Sr,(e,t)=>t),Pn=G(Sr,(e,t,n)=>n),Ze=G(ys,2),Qo={nanosecond:0,microsecond:1,millisecond:2,second:3,minute:4,hour:5,day:6,week:7,month:8,year:9},Ni=Object.keys(Qo),De=864e5,Md=1e3,Dr=1e3,ut=1e6,Qe=1e9,oo=6e10,ao=36e11,H=864e11,nt=[1,Dr,ut,Qe,oo,ao,H],ct=Ni.slice(0,6),ea=Rr(ct),xp=["offset"],Dd=["timeZone"],Pd=ct.concat(xp),kd=Pd.concat(Dd),ta=["era","eraYear"],Mp=ta.concat(["year"]),Ci=["year"],Si=["monthCode"],Ri=["month"].concat(Si),Pr=["day"],Ai=Ri.concat(Ci),Fd=Si.concat(Ci),vt=Pr.concat(Ai),Dp=Pr.concat(Ri),Ud=Pr.concat(Si),$d=Pn(ct,0),q="iso8601",zn="gregory",Kt="japanese",Bd={[zn]:{"gregory-inverse":-1,gregory:0},[Kt]:{"japanese-inverse":-1,japanese:0,meiji:1867,taisho:1911,showa:1925,heisei:1988,reiwa:2018},ethiopic:{ethioaa:0,ethiopic:5500},coptic:{"coptic-inverse":-1,coptic:0},roc:{"roc-inverse":-1,roc:0},buddhist:{be:0},islamic:{ah:0},indian:{saka:0},persian:{ap:0}},_d={[zn]:{bce:"gregory-inverse",ce:"gregory"},[Kt]:{bce:"japanese-inverse",ce:"japanese"},ethiopic:{era0:"ethioaa",era1:"ethiopic"},coptic:{era0:"coptic-inverse",era1:"coptic"},roc:{broc:"roc-inverse",minguo:"roc"}},Pp={chinese:13,dangi:13,hebrew:-6},pe=G(ia,"string"),Vd=G(ia,"boolean"),kp=G(ia,"number"),Y=Ni.map(e=>e+"s"),Ti=Rr(Y),Fp=Y.slice(0,6),Kd=Y.slice(6),Up=Kd.slice(1),$p=xd(Y),me=Pn(Y,0),vi=Pn(Fp,0),Li=G(rc,Y),Ye=["isoNanosecond","isoMicrosecond","isoMillisecond","isoSecond","isoMinute","isoHour"],Oi=["isoDay","isoMonth","isoYear"],io=Ye.concat(Oi),xi=Rr(Oi),Gd=Rr(Ye),Bp=Rr(io),Ae=Pn(Gd,0),_p=G(rc,io),Mi=1e8,Di=Mi*De,Vp=[Mi,0],Kp=[-Mi,0],Nr=275760,Cr=-271821,Lt=Intl.DateTimeFormat,qd="en-GB",Gp=1970,Rt=1972,kt=12,qp=Un(1868,9,8),jp=Pe(qm,WeakMap),Rs="smallestUnit",na="unit",pr="roundingIncrement",Ho="fractionalSecondDigits",jd="relativeTo",Xo="direction",Yd={constrain:0,reject:1},Yp=Object.keys(Yd),Wp={compatible:0,reject:1,earlier:2,later:3},zp={reject:0,use:1,prefer:2,ignore:3},Zp={auto:0,never:1,critical:2,always:3},Hp={auto:0,never:1,critical:2},Xp={auto:0,never:1},Jp={floor:0,halfFloor:1,ceil:2,halfCeil:3,trunc:4,halfTrunc:5,expand:6,halfExpand:7,halfEven:8},Qp={previous:-1,next:1},kr=G(Sa,Rs),Wd=G(Sa,"largestUnit"),eg=G(Sa,na),zd=G(Gt,"overflow",Yd),Zd=G(Gt,"disambiguation",Wp),tg=G(Gt,"offset",zp),Pi=G(Gt,"calendarName",Zp),ng=G(Gt,"timeZoneName",Hp),rg=G(Gt,"offset",Xp),Fr=G(Gt,"roundingMode",Jp),lo="PlainYearMonth",uo="PlainMonthDay",Zn="PlainDate",En="PlainDateTime",co="PlainTime",Ot="ZonedDateTime",fo="Instant",ho="Duration",sg=[Math.floor,e=>cs(e)?Math.floor(e):Math.round(e),Math.ceil,e=>cs(e)?Math.ceil(e):Math.round(e),Math.trunc,e=>cs(e)?Math.trunc(e)||0:Math.round(e),e=>e<0?Math.floor(e):Math.ceil(e),e=>Math.sign(e)*Math.round(Math.abs(e))||0,e=>cs(e)?(e=Math.trunc(e)||0)+e%2:Math.round(e)],yn="UTC",gs=5184e3,og=ws(1847),ag=ws(new Date().getUTCFullYear()+10),ig=/0+$/,Fe=Pe(Hm,WeakMap),Xu=2**32-1,B=Pe(e=>{let t=ti(e);return typeof t=="object"?new sa(t):new ra(t||0)}),ra=class{constructor(t){this.$=t}R(){return this.$}I(t){return(n=>{let r=de({...n,...Ae});if(!r||Math.abs(r[0])>1e8)throw new RangeError(zt)})(t),[ga(t,this.$)]}O(){}},sa=class{constructor(t){this.nn=(n=>{function r(c){let d=gr(c,i,u),[l,h]=Wu(d),p=o(l),g=o(h);return p===g?p:s(a(l,h),p,g,c)}function s(c,d,l,h){let p,g;for(;(h===void 0||(p=h<c[0]?d:h>=c[1]?l:void 0)===void 0)&&(g=c[1]-c[0]);){let E=c[0]+Math.floor(g/2);n(E)===l?c[1]=E:c[0]=E+1}return p}let o=Pe(n),a=Pe(Xm),i=og,u=ag;return{tn(c){let d=r(c-86400),l=r(c+86400),h=c-d,p=c-l;if(d===l)return[h];let g=r(h);return g===r(p)?[c-g]:d>l?[h,p]:[]},rn:r,O(c,d){let l=gr(c,i,u),[h,p]=Wu(l),g=gs*d,E=d<0?()=>p>i||(i=l,0):()=>h<u||(u=l,0);for(;E();){let y=o(h),I=o(p);if(y!==I){let N=a(h,p);s(N,y,I);let C=N[0];if((Ft(C,c)||1)===d)return C}h+=g,p+=g}}}})((n=>r=>{let s=Ea(n,r*Md);return ws(Df(s),parseInt(s.month),parseInt(s.day),parseInt(s.hour),parseInt(s.minute),parseInt(s.second))-r})(t))}R(t){return this.nn.rn((n=>Gu(n)[0])(t))*Qe}I(t){let[n,r]=[ws((s=t).isoYear,s.isoMonth,s.isoDay,s.isoHour,s.isoMinute,s.isoSecond),s.isoMillisecond*ut+s.isoMicrosecond*Dr+s.isoNanosecond];var s;return this.nn.tn(n).map(o=>ot(an(Er(o,Qe),r)))}O(t,n){let[r,s]=Gu(t),o=this.nn.O(r+(n>0||s?1:0),n);if(o!==void 0)return Er(o,Qe)}},ki="([+-])",Es="(?:[.,](\\d{1,9}))?",Hd=`(?:(?:${ki}(\\d{6}))|(\\d{4}))-?(\\d{2})`,Fi="(\\d{2})(?::?(\\d{2})(?::?(\\d{2})"+Es+")?)?",Ui=ki+Fi,lg=Hd+"-?(\\d{2})(?:[T ]"+Fi+"(Z|"+Ui+")?)?",Xd="\\[(!?)([^\\]]*)\\]",mo=`((?:${Xd}){0,9})`,ug=qn(Hd+mo),cg=qn("(?:--)?(\\d{2})-?(\\d{2})"+mo),fg=qn(lg+mo),dg=qn("T?"+Fi+"(?:"+Ui+")?"+mo),hg=qn(Ui),mg=new RegExp(Xd,"g"),pg=qn(`${ki}?P(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(?:T(?:(\\d+)${Es}H)?(?:(\\d+)${Es}M)?(?:(\\d+)${Es}S)?)?`),gg=Pe(e=>new Lt(qd,{timeZone:e,era:"short",year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"})),Eg=/^(AC|AE|AG|AR|AS|BE|BS|CA|CN|CS|CT|EA|EC|IE|IS|JS|MI|NE|NS|PL|PN|PR|PS|SS|VS)T$/,yg=/[^\w\/:+-]+/,wg=/^M(\d{2})(L?)$/,Ig=Pe(ep),$i=Pe(e=>new Lt(qd,{calendar:e,timeZone:yn,era:"short",year:"numeric",month:"short",day:"numeric"})),Jd={P(e,t,n){let r=j(n),s,{years:o,months:a,weeks:i,days:u}=t;if(u+=he(t,5)[0],o||a)s=((c,d,l,h,p)=>{let[g,E,y]=c.v(d);if(l){let[I,N]=c.q(g,E);g+=l,E=Cs(I,N,c.L(g)),E=At("month",E,1,c.B(g),p)}return h&&([g,E]=c.un(g,E,h)),y=At("day",y,1,c.U(g,E),p),c.p(g,E,y)})(this,e,o,a,r);else{if(!i&&!u)return e;s=Re(e)}if(s===void 0)throw new RangeError(zt);return s+=(7*i+u)*De,ze(xs(s))},N(e,t,n){if(n<=7){let u=0,c=Af({...e,...Ae},{...t,...Ae});return n===7&&([u,c]=$t(c,7)),{...me,weeks:u,days:c}}let r=this.v(e),s=this.v(t),[o,a,i]=((u,c,d,l,h,p,g)=>{let E=h-c,y=p-d,I=g-l;if(E||y){let N=Math.sign(E||y),C=u.U(h,p),S=0;if(Math.sign(I)===-N){let A=C;[h,p]=u.un(h,p,-N),E=h-c,y=p-d,C=u.U(h,p),S=N<0?-A:C}if(I=g-Math.min(l,C)+S,E){let[A,L]=u.q(c,d),[v,M]=u.q(h,p);if(y=v-A||Number(M)-Number(L),Math.sign(y)===-N){let O=N<0&&-u.B(h);E=(h-=N)-c,y=p-Cs(A,L,u.L(h))+(O||u.B(h))}}}return[E,y,I]})(this,...r,...s);return n===8&&(a+=this.cn(o,r[0]),o=0),{...me,years:o,months:a,days:i}},F(e,t){let n=j(t),r=Wo(this,e),s=hs(this,e,r,n),o=zo(this,e,s,r,n);return lt(ze(this.V(r,s,o)),this.id||q)},K(e,t){let n=j(t),r=Wo(this,e),s=hs(this,e,r,n);return yr(pa(this.V(r,s,1)),this.id||q)},_(e,t){let n=j(t),r,s,o,a=e.eraYear!==void 0||e.year!==void 0?Wo(this,e):void 0,i=!this.id;if(a===void 0&&i&&(a=Rt),a!==void 0){let l=hs(this,e,a,n);r=zo(this,e,l,a,n);let h=this.L(a);s=mi(l,h),o=l===h}else{if(e.monthCode===void 0)throw new TypeError(Td);if([s,o]=hi(e.monthCode),this.id&&this.id!==zn&&this.id!==Kt)if(this.id&&un(this.id)==="coptic"&&n===0){let l=o||s!==13?30:6;r=e.day,r=gr(r,1,l)}else if(this.id&&un(this.id)==="chinese"&&n===0){let l=!o||s!==1&&s!==9&&s!==10&&s!==11&&s!==12?30:29;r=e.day,r=gr(r,1,l)}else r=e.day;else r=zo(this,e,hs(this,e,Rt,n),Rt,n)}let u=this.G(s,o,r);if(!u)throw new RangeError("Cannot guess year");let[c,d]=u;return Is(ze(this.V(c,d,r)),this.id||q)},fields(e){return Jo(this)&&e.includes("year")?[...e,...ta]:e},k(e,t){let n=Object.assign(Object.create(null),e);return Zo(n,t,Ri),Jo(this)&&(Zo(n,t,Mp),this.id===Kt&&Zo(n,t,Dp,ta)),n},inLeapYear(e){let[t]=this.v(e);return this.sn(t)},monthsInYear(e){let[t]=this.v(e);return this.B(t)},daysInMonth(e){let[t,n]=this.v(e);return this.U(t,n)},daysInYear(e){let[t]=this.v(e);return this.fn(t)},dayOfYear:di,era(e){return this.hn(e)[0]},eraYear(e){return this.hn(e)[1]},monthCode(e){let[t,n]=this.v(e),[r,s]=this.q(t,n);return Or(r,s)},dayOfWeek:gc,daysInWeek(){return 7}},bg={v:ya,hn:Ec,q:dc},Ng={dayOfYear:di,v:ya,p:Un},Cg=Object.assign({},Ng,{weekOfYear:Tf,yearOfWeek:vf,m(e){function t(p){return(7-p<r?7:0)-p}function n(p){let g=pc(h+p),E=p||1,y=t(mr(u+g*E,7));return d=(g+(y-c)*E)/7}let r=this.id?1:4,s=gc(e),o=this.dayOfYear(e),a=mr(s-1,7),i=o-1,u=mr(a-i,7),c=t(u),d,l=Math.floor((i-c)/7)+1,h=e.isoYear;return l?l>n(0)&&(l=1,h++):(l=n(-1),h--),[l,h,d]}}),Sg=Object.assign({},Jd,Cg,{v:ya,hn:Ec,q:dc,G(e,t){if(!t)return[Rt,e]},sn:wa,L(){},B:hc,cn:e=>e*kt,U:mc,fn:pc,V:(e,t,n)=>({isoYear:e,isoMonth:t,isoDay:n}),p:Un,un:(e,t,n)=>(e+=Ts(n,kt),(t+=oa(n,kt))<1?(e--,t+=kt):t>kt&&(e++,t-=kt),[e,t]),year(e){return e.isoYear},month(e){return e.isoMonth},day:e=>e.isoDay}),Rg={v:Ss,hn:kf,q:Pf},Ag={dayOfYear:di,v:Ss,p:br,weekOfYear:Tf,yearOfWeek:vf,m(){return[]}},Tg=Object.assign({},Jd,Ag,{v:Ss,hn:kf,q:Pf,G(e,t,n){let r=this.id&&un(this.id)==="chinese"?((c,d,l)=>{if(d)switch(c){case 1:return 1651;case 2:return l<30?1947:1765;case 3:return l<30?1966:1955;case 4:return l<30?1963:1944;case 5:return l<30?1971:1952;case 6:return l<30?1960:1941;case 7:return l<30?1968:1938;case 8:return l<30?1957:1718;case 9:return 1832;case 10:return 1870;case 11:return 1814;case 12:return 1890}return 1972})(e,t,n):Rt,[s,o,a]=Ss.call(this,{isoYear:r,isoMonth:kt,isoDay:31}),i=ps.call(this,s),u=o===i;(Ft(e,mi(o,i))||Ft(Number(t),Number(u))||Ft(n,a))===1&&s--;for(let c=0;c<100;c++){let d=s-c,l=ps.call(this,d),h=Cs(e,t,l);if(t===(h===l)&&n<=Zu.call(this,d,h))return[d,h]}},sn(e){let t=fs.call(this,e);return t>fs.call(this,e-1)&&t>fs.call(this,e+1)},L:ps,B:ds,cn(e,t){let n=t+e,r=Math.sign(e),s=r<0?-1:0,o=0;for(let a=t;a!==n;a+=r)o+=ds.call(this,a+s);return o},U:Zu,fn:fs,V(e,t,n){return xs(br.call(this,e,t,n))},p:br,un(e,t,n){if(n){if(t+=n,!Number.isSafeInteger(t))throw new RangeError(zt);if(n<0)for(;t<1;)t+=ds.call(this,--e);else{let r;for(;t>(r=ds.call(this,e));)t-=r,e++}}return[e,t]},year(e){return this.h(e).year},month(e){let{year:t,o:n}=this.h(e),{u:r}=this.l(t);return r[n]+1},day(e){return this.h(e).day}}),po=Ff(bg,Rg),U=Ff(Sg,Tg),Ju={era:ms,eraYear:Se,year:Se,month:Ku,monthCode(e){let t=ms(e);return hi(t),t},day:Ku,...Pn(ct,Se),...Pn(Y,fa),offset(e){let t=ms(e);return mn(t),t}},Bi=G(tc,ct,Ye),vg=G(tc,Ye,ct),Ut="numeric",Ur=["timeZoneName"],Qd={month:Ut,day:Ut},_i={year:Ut,month:Ut},Vi=Object.assign({},_i,{day:Ut}),Ki={hour:Ut,minute:Ut,second:Ut},Gi=Object.assign({},Vi,Ki),Lg=Object.assign({},Gi,{timeZoneName:"short"}),Og=Object.keys(_i),xg=Object.keys(Qd),Mg=Object.keys(Vi),Dg=Object.keys(Ki),qi=["dateStyle"],Pg=Og.concat(qi),kg=xg.concat(qi),ji=Mg.concat(qi,["weekday"]),$r=Dg.concat(["dayPeriod","timeStyle","fractionalSecondDigits"]),Yi=ji.concat($r),Fg=Ur.concat($r),Ug=Ur.concat(ji),$g=Ur.concat(["day","weekday"],$r),Bg=Ur.concat(["year","weekday"],$r),_g=gn(Yi,Gi),Vg=gn(Yi,Lg),Kg=gn(Yi,Gi,Ur),Gg=gn(ji,Vi,Fg),qg=gn($r,Ki,Ug),jg=gn(Pg,_i,$g),Yg=gn(kg,Qd,Bg),Wg={},eh=new Lt(void 0,{calendar:q}).resolvedOptions().calendar===q,Wi=[_g,Fs],th=[Vg,Fs,0,(e,t)=>{let n=e.timeZone;if(t&&t.timeZone!==n)throw new RangeError(Ld);return n}],zi=[Kg,Re],Zi=[Gg,Re],Hi=[qg,e=>Bt(e)/ut],Xi=[jg,Re,eh],Ji=[Yg,Re,eh],Qu;function Jt(e,t,n,r,s){function o(...u){if(!(this instanceof o))throw new TypeError(no);sh(this,t(...u))}function a(u,c){return Object.defineProperties(function(...d){return u.call(this,i(this),...d)},kn(c))}function i(u){let c=Le(u);if(!c||c.branding!==e)throw new TypeError(no);return c}return Object.defineProperties(o.prototype,{...ec(rt(a,n)),...cn(rt(a,r)),...As("Temporal."+e)}),Object.defineProperties(o,{...cn(s),...kn(e)}),[o,u=>{let c=Object.create(o.prototype);return sh(c,u),c},i]}function tr(e){if(Le(e)||e.calendar!==void 0||e.timeZone!==void 0)throw new TypeError(Sd);return e}function Vr(e){return oh(e)||q}function oh(e){let{calendar:t}=e;if(t!==void 0)return yo(t)}function yo(e){if(Ee(e)){let{calendar:t}=Le(e)||{};if(!t)throw new TypeError(Ii(e));return t}return(t=>xr(rf(pe(t))))(e)}function tl(e){let t={};for(let n in e)t[n]=r=>{let{calendar:s}=r;return U(s)[n](r)};return t}function Qt(){throw new TypeError(Ad)}function We(e){if(Ee(e)){let{timeZone:t}=Le(e)||{};if(!t)throw new TypeError(bi(e));return t}return(t=>zs(sf(pe(t))))(e)}function le(e){if(Ee(e)){let t=Le(e);return t&&t.branding===ho?t:qf(e)}return nf(e)}function Br(e){if(e!==void 0){if(Ee(e)){let t=Le(e)||{};switch(t.branding){case Ot:case Zn:return t;case En:return lt(t)}let n=Vr(e);return{...Uf(We,B,U(n),e),calendar:n}}return Hc(e)}}function Zt(e,t){if(Ee(e)){let r=Le(e)||{};switch(r.branding){case co:return j(t),r;case En:return j(t),He(r);case Ot:return j(t),Ei(B,r)}return Gf(e,t)}let n=tf(e);return j(t),n}function nl(e){return e===void 0?void 0:Zt(e)}function Hn(e,t){if(Ee(e)){let r=Le(e)||{};switch(r.branding){case En:return j(t),r;case Zn:return j(t),je({...r,...Ae});case Ot:return j(t),pi(B,r)}return Bf(U(Vr(e)),e,t)}let n=Jc(e);return j(t),n}function nh(e,t){if(Ee(e)){let r=Le(e);if(r&&r.branding===uo)return j(t),r;let s=oh(e);return Kf(U(s||q),!s,e,t)}let n=ef(U,e);return j(t),n}function Xn(e,t){if(Ee(e)){let r=Le(e);return r&&r.branding===lo?(j(t),r):Vf(U(Vr(e)),e,t)}let n=Qc(U,e);return j(t),n}function Jn(e,t){if(Ee(e)){let r=Le(e)||{};switch(r.branding){case Zn:return j(t),r;case En:return j(t),lt(r);case Ot:return j(t),gi(B,r)}return _f(U(Vr(e)),e,t)}let n=Ys(e);return j(t),n}function Qn(e,t){if(Ee(e)){let n=Le(e);if(n&&n.branding===Ot)return Tr(t),n;let r=Vr(e);return $f(We,B,U(r),r,e,t)}return Xc(e,t)}function rh(e){return rt(t=>n=>t(Qi(n)),e)}function Qi(e){return Fe(e,B)}function er(e){if(Ee(e)){let t=Le(e);if(t)switch(t.branding){case fo:return t;case Ot:return it(t.epochNanoseconds)}}return Zc(e)}function zg(){function e(o,a){return new t(o,a)}function t(o,a=Object.create(null)){Eo.set(this,((i,u)=>{let c=new Lt(i,u),d=c.resolvedOptions(),l=d.locale,h=Ge(Object.keys(u),d),p=Pe(Xg),g=(E,...y)=>{if(E){if(y.length!==2)throw new TypeError(so);for(let S of y)if(S===void 0)throw new TypeError(so)}E||y[0]!==void 0||(y=[]);let I=y.map(S=>Le(S)||Number(S)),N,C=0;for(let S of I){let A=typeof S=="object"?S.branding:void 0;if(C++&&A!==N)throw new TypeError(so);N=A}return N?p(N)(l,h,...I):[c,...I]};return g.X=c,g})(o,a))}let n=Lt.prototype,r=Object.getOwnPropertyDescriptors(n),s=Object.getOwnPropertyDescriptors(Lt);for(let o in r){let a=r[o],i=o.startsWith("format")&&Zg(o);typeof a.value=="function"?a.value=o==="constructor"?e:i||Hg(o):i&&(a.get=function(){if(!Eo.has(this))throw new TypeError(no);return(...u)=>i.apply(this,u)},Object.defineProperties(a.get,kn(`get ${o}`)))}return s.prototype.value=t.prototype=Object.create({},r),Object.defineProperties(e,s),e}function Zg(e){return Object.defineProperties(function(...t){let n=Eo.get(this),[r,...s]=n(e.includes("Range"),...t);return r[e](...s)},kn(e))}function Hg(e){return Object.defineProperties(function(...t){return Eo.get(this).X[e](...t)},kn(e))}function Xg(e){let t=rE[e];if(!t)throw new TypeError(Od(e));return Tt(t,Pe(yi),1)}var go=new WeakMap,Le=go.get.bind(go),sh=go.set.bind(go),ah={era:oc,eraYear:aa,year:Ls,month:st,daysInMonth:st,daysInYear:st,inLeapYear:Vd,monthsInYear:st},rl={monthCode:pe},ih={day:st},Jg={dayOfWeek:st,dayOfYear:st,weekOfYear:ac,yearOfWeek:aa,daysInWeek:st},sl=tl(Object.assign({},ah,rl,ih,Jg)),Qg=tl({...ah,...rl}),eE=tl({...rl,...ih}),Kr={calendarId:e=>e.calendar},tE=Sr(e=>t=>t[e],Y.concat("sign")),ol=Sr((e,t)=>n=>n[Ye[t]],ct),lh={epochMilliseconds:Fs,epochNanoseconds:Sc},[nE,re,yb]=Jt(ho,id,{...tE,blank:Yc},{with:(e,t)=>re(Xf(e,t)),negated:e=>re(qs(e)),abs:e=>re(jc(e)),add:(e,t,n)=>re(za(Br,U,B,0,e,le(t),n)),subtract:(e,t,n)=>re(za(Br,U,B,1,e,le(t),n)),round:(e,t)=>re(qc(Br,U,B,e,t)),total:(e,t)=>Ac(Br,U,B,e,t),toLocaleString(e,t,n){return Intl.DurationFormat?new Intl.DurationFormat(t,n).format(this):_s(e)},toString:_s,toJSON:e=>_s(e),valueOf:Qt},{from:e=>re(le(e)),compare:(e,t,n)=>hf(Br,U,B,le(e),le(t),n)}),rE={Instant:Wi,PlainDateTime:zi,PlainDate:Zi,PlainTime:Hi,PlainYearMonth:Xi,PlainMonthDay:Ji},sE=Tt(Wi),oE=Tt(th),aE=Tt(zi),iE=Tt(Zi),lE=Tt(Hi),uE=Tt(Xi),cE=Tt(Ji),[fE,Xt]=Jt(co,ad,ol,{with(e,t,n){return Xt(Hf(this,tr(t),n))},add:(e,t)=>Xt(Ga(0,e,le(t))),subtract:(e,t)=>Xt(Ga(1,e,le(t))),until:(e,t,n)=>re(ci(0,e,Zt(t),n)),since:(e,t,n)=>re(ci(1,e,Zt(t),n)),round:(e,t)=>Xt(Oc(e,t)),equals:(e,t)=>If(e,Zt(t)),toLocaleString(e,t,n){let[r,s]=lE(t,n,e);return r.format(s)},toString:Pa,toJSON:e=>Pa(e),valueOf:Qt},{from:(e,t)=>Xt(Zt(e,t)),compare:(e,t)=>Zs(Zt(e),Zt(t))}),[dE,ft]=Jt(En,G(nd,jn),{...Kr,...sl,...ol},{with:(e,t,n)=>ft(Yf(U,e,tr(t),n)),withCalendar:(e,t)=>ft(Qs(e,yo(t))),withPlainTime:(e,t)=>ft(Id(e,nl(t))),add:(e,t,n)=>ft(_a(U,0,e,le(t),n)),subtract:(e,t,n)=>ft(_a(U,1,e,le(t),n)),until:(e,t,n)=>re(ii(U,0,e,Hn(t),n)),since:(e,t,n)=>re(ii(U,1,e,Hn(t),n)),round:(e,t)=>ft(Lc(e,t)),equals:(e,t)=>gf(e,Hn(t)),toZonedDateTime:(e,t,n)=>ve(cd(B,e,We(t),n)),toPlainDate:e=>dt(lt(e)),toPlainTime:e=>Xt(He(e)),toLocaleString(e,t,n){let[r,s]=aE(t,n,e);return r.format(s)},toString:Oa,toJSON:e=>Oa(e),valueOf:Qt},{from:(e,t)=>ft(Hn(e,t)),compare:(e,t)=>si(Hn(e),Hn(t))}),[hE,el,wb]=Jt(uo,G(od,jn),{...Kr,...eE},{with:(e,t,n)=>el(Zf(U,e,tr(t),n)),equals:(e,t)=>wf(e,nh(t)),toPlainDate(e,t){return dt(gd(U,e,this,t))},toLocaleString(e,t,n){let[r,s]=cE(t,n,e);return r.format(s)},toString:Da,toJSON:e=>Da(e),valueOf:Qt},{from:(e,t)=>el(nh(e,t))}),[mE,_r,Ib]=Jt(lo,G(sd,jn),{...Kr,...Qg},{with:(e,t,n)=>_r(zf(U,e,tr(t),n)),add:(e,t,n)=>_r(Ka(U,0,e,le(t),n)),subtract:(e,t,n)=>_r(Ka(U,1,e,le(t),n)),until:(e,t,n)=>re(ui(U,0,e,Xn(t),n)),since:(e,t,n)=>re(ui(U,1,e,Xn(t),n)),equals:(e,t)=>yf(e,Xn(t)),toPlainDate(e,t){return dt(pd(U,e,this,t))},toLocaleString(e,t,n){let[r,s]=uE(t,n,e);return r.format(s)},toString:Ma,toJSON:e=>Ma(e),valueOf:Qt},{from:(e,t)=>_r(Xn(e,t)),compare:(e,t)=>pn(Xn(e),Xn(t))}),[pE,dt,bb]=Jt(Zn,G(rd,jn),{...Kr,...sl},{with:(e,t,n)=>dt(Wf(U,e,tr(t),n)),withCalendar:(e,t)=>dt(Qs(e,yo(t))),add:(e,t,n)=>dt(Va(U,0,e,le(t),n)),subtract:(e,t,n)=>dt(Va(U,1,e,le(t),n)),until:(e,t,n)=>re(li(U,0,e,Jn(t),n)),since:(e,t,n)=>re(li(U,1,e,Jn(t),n)),equals:(e,t)=>Ef(e,Jn(t)),toZonedDateTime(e,t){let n=Ee(t)?t:{timeZone:t};return ve(fd(We,Zt,B,e,n))},toPlainDateTime:(e,t)=>ft(dd(e,nl(t))),toPlainYearMonth(e){return _r(hd(U,e,this))},toPlainMonthDay(e){return el(md(U,e,this))},toLocaleString(e,t,n){let[r,s]=iE(t,n,e);return r.format(s)},toString:xa,toJSON:e=>xa(e),valueOf:Qt},{from:(e,t)=>dt(Jn(e,t)),compare:(e,t)=>pn(Jn(e),Jn(t))}),[gE,ve]=Jt(Ot,G(td,jn,df),{...lh,...Kr,...rh(sl),...rh(ol),offset:e=>Vn(Qi(e).offsetNanoseconds),offsetNanoseconds:e=>Qi(e).offsetNanoseconds,timeZoneId:e=>e.timeZone,hoursInDay:e=>xc(B,e)},{with:(e,t,n)=>ve(jf(U,B,e,tr(t),n)),withCalendar:(e,t)=>ve(Qs(e,yo(t))),withTimeZone:(e,t)=>ve(bd(e,We(t))),withPlainTime:(e,t)=>ve(wd(B,e,nl(t))),add:(e,t,n)=>ve(Ba(U,B,0,e,le(t),n)),subtract:(e,t,n)=>ve(Ba(U,B,1,e,le(t),n)),until:(e,t,n)=>re(ae(ai(U,B,0,e,Qn(t),n))),since:(e,t,n)=>re(ae(ai(U,B,1,e,Qn(t),n))),round:(e,t)=>ve(vc(B,e,t)),startOfDay:e=>ve(Mc(B,e)),equals:(e,t)=>pf(e,Qn(t)),toInstant:e=>Ht(ud(e)),toPlainDateTime:e=>ft(pi(B,e)),toPlainDate:e=>dt(gi(B,e)),toPlainTime:e=>Xt(Ei(B,e)),toLocaleString(e,t,n={}){let[r,s]=oE(t,n,e);return r.format(s)},toString:(e,t)=>La(B,e,t),toJSON:e=>La(B,e),valueOf:Qt,getTimeZoneTransition(e,t){let{timeZone:n,epochNanoseconds:r}=e,s=Ic(t),o=B(n).O(r,s);return o?ve({...e,epochNanoseconds:o}):null}},{from:(e,t)=>ve(Qn(e,t)),compare:(e,t)=>ri(Qn(e),Qn(t))}),[EE,Ht,Nb]=Jt(fo,ed,lh,{add:(e,t)=>Ht($a(0,e,le(t))),subtract:(e,t)=>Ht($a(1,e,le(t))),until:(e,t,n)=>re(oi(0,e,er(t),n)),since:(e,t,n)=>re(oi(1,e,er(t),n)),round:(e,t)=>Ht(Tc(e,t)),equals:(e,t)=>mf(e,er(t)),toZonedDateTimeISO:(e,t)=>ve(ld(e,We(t))),toLocaleString(e,t,n){let[r,s]=sE(t,n,e);return r.format(s)},toString:(e,t)=>va(We,B,e,t),toJSON:e=>va(We,B,e),valueOf:Qt},{from:e=>Ht(er(e)),fromEpochMilliseconds:e=>Ht(Ed(e)),fromEpochNanoseconds:e=>Ht(yd(e)),compare:(e,t)=>ni(er(e),er(t))}),yE=Object.defineProperties({},{...As("Temporal.Now"),...cn({timeZoneId:()=>Yn(),instant:()=>Ht(it(to())),zonedDateTimeISO:(e=Yn())=>ve(qe(to(),We(e),q)),plainDateTimeISO:(e=Yn())=>ft(je(eo(B(We(e))),q)),plainDateISO:(e=Yn())=>dt(lt(eo(B(We(e))),q)),plainTimeISO:(e=Yn())=>Xt(He(eo(B(We(e)))))})}),se=Object.defineProperties({},{...As("Temporal"),...cn({PlainYearMonth:mE,PlainMonthDay:hE,PlainDate:pE,PlainTime:fE,PlainDateTime:dE,ZonedDateTime:gE,Instant:EE,Duration:nE,Now:yE})}),wE=zg(),Eo=new WeakMap,IE=Object.defineProperties(Object.create(Intl),cn({DateTimeFormat:wE}));var uh=864e5,ch=24405875e-1,wo={year:2e3,month:1,day:1};function bE(e,t=!1){if(e==null)return null;try{if(typeof e=="number"){if(t)return se.Instant.fromEpochMilliseconds(e*1e3).toZonedDateTimeISO("UTC");if(e>1e6&&e<4e6){let o=(e-ch)*uh;return se.Instant.fromEpochMilliseconds(o).toZonedDateTimeISO("UTC")}else{try{if(e>-2208988800&&e<3250368e4)return se.Instant.fromEpochMilliseconds(e*1e3).toZonedDateTimeISO("UTC")}catch{}try{if(e>-22089888e5&&e<3250368e7)return se.Instant.fromEpochMilliseconds(e).toZonedDateTimeISO("UTC")}catch{}return null}}if(typeof e!="string")return null;let n=e.trim();if(n.toLowerCase()==="now")return se.Now.zonedDateTimeISO();try{return/^\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}(:\d{2}(\.\d+)?)?$/.test(n)?se.Instant.from(n.replace(" ","T")+"Z").toZonedDateTimeISO("UTC"):se.ZonedDateTime.from(n)}catch{}try{return se.PlainDateTime.from(n.replace(" ","T")).toZonedDateTime("UTC")}catch{}try{return se.PlainDate.from(n).toZonedDateTime("UTC")}catch{}try{let o=se.PlainTime.from(n);return se.PlainDateTime.from({...wo,hour:o.hour,minute:o.minute,second:o.second,millisecond:o.millisecond,microsecond:o.microsecond,nanosecond:o.nanosecond}).toZonedDateTime("UTC")}catch{}let s=n.match(/^(\d{4})(\d{2})(\d{2})$/);if(s)return se.PlainDateTime.from({year:parseInt(s[1]),month:parseInt(s[2]),day:parseInt(s[3])}).toZonedDateTime("UTC");if(s=n.match(/^(\d{2}):(\d{2})$/),s){let o={hour:parseInt(s[1]),minute:parseInt(s[2])};return se.PlainDateTime.from({...wo,...o}).toZonedDateTime("UTC")}if(s=n.match(/^(\d{2}):(\d{2}):(\d{2})$/),s){let o={hour:parseInt(s[1]),minute:parseInt(s[2]),second:parseInt(s[3])};return se.PlainDateTime.from({...wo,...o}).toZonedDateTime("UTC")}if(s=n.match(/^(\d{2}):(\d{2}):(\d{2})\.(\d{1,9})$/),s){let o=parseInt(s[4].padEnd(9,"0").substring(0,9)),a={hour:parseInt(s[1]),minute:parseInt(s[2]),second:parseInt(s[3]),millisecond:Math.floor(o/1e6),microsecond:Math.floor(o%1e6/1e3),nanosecond:o%1e3};return se.PlainDateTime.from({...wo,...a}).toZonedDateTime("UTC")}return console.warn(`Failed to parse date/time string with Temporal: ${e}`),null}catch(n){return console.warn(`Error parsing date/time value "${e}":`,n),null}}var NE=/^\s*([+-]?\s*\d+(\.\d+)?)\s+(day|hour|minute|second|month|year)s?\s*$/i,CE=/^\s*weekday\s+([0-6])\s*$/i;function SE(e,t){let n=t.trim().toLowerCase(),r=n.match(NE);if(r){let o=r[1].replace(/\s/g,""),a=parseFloat(o),i=r[3];if(isNaN(a))throw new Error(`Invalid number in modifier: ${t}`);let u={};if(i==="year"||i==="month"||i==="day")u[`${i}s`]=Math.trunc(a);else if(i==="hour"||i==="minute"||i==="second")if(i==="second"){let d=Math.trunc(a),l=Math.round(a%1*1e9);u.seconds=d,l!==0&&(u.nanoseconds=l)}else u[`${i}s`]=a;else throw new Error(`Internal error: Unknown unit ${i}`);let c=se.Duration.from(u);return e.add(c)}switch(n){case"start of day":return e.startOfDay();case"start of month":return e.startOfDay().with({day:1});case"start of year":return e.startOfDay().with({month:1,day:1})}let s=n.match(CE);if(s){let o=parseInt(s[1],10),a=o===0?7:o,i=e.dayOfWeek,u=a-i;return u>0&&(u-=7),u!==0?e.add({days:u}):e}return console.warn(`Modifier not implemented or unrecognized: ${t}`),e}function Gr(e){if(e.length===0)return null;let t=e[0],n=1,r=!1,s=[],o=e.findIndex(c=>typeof c=="string"&&c.trim().toLowerCase()==="unixepoch");if(o!==-1)if(o===0){if(e.length<2)return null;t=e[1],r=!0,n=2,s=e.slice(n)}else{if(t=e[0],r=!0,typeof t!="number")return null;s=e.slice(1).filter((c,d)=>d!==o-1),n=1}else t=e[0],s=e.slice(1),n=1;let a="UTC",i=[];for(let c of s){if(typeof c!="string")continue;let d=c.trim().toLowerCase();d==="localtime"?a=se.Now.timeZoneId():d==="utc"?a="UTC":i.push(c)}let u=bE(t,r);if(!u)return null;if(a!==u.timeZoneId)try{u=u.toInstant().toZonedDateTimeISO(a)}catch(c){return console.warn(`Failed to convert to timezone "${a}":`,c),null}for(let c of i)if(typeof c=="string")try{u=SE(u,c)}catch(d){return console.warn(`Error applying modifier "${c}":`,d),null}return u}var RE=(...e)=>{let t=Gr(e);return t?t.toPlainDate().toString():null},fh=V({name:"date",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},RE),AE=(...e)=>{let t=Gr(e);return t?t.toPlainTime().toString({smallestUnit:"second"}):null},dh=V({name:"time",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},AE),TE=(...e)=>{let t=Gr(e);if(!t)return null;let n=t.toPlainDate().toString(),r=t.toPlainTime().toString({smallestUnit:"second"});return`${n} ${r}`},hh=V({name:"datetime",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},TE),vE=(...e)=>{let t=Gr(e);return t?t.toInstant().epochMilliseconds/uh+ch:null},mh=V({name:"julianday",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},vE),LE=(e,...t)=>{if(typeof e!="string")return null;let n=Gr(t);if(!n)return null;try{let r=e;return r=r.replace(/%./g,s=>{switch(s){case"%Y":return n.year.toString().padStart(4,"0");case"%m":return n.month.toString().padStart(2,"0");case"%d":return n.day.toString().padStart(2,"0");case"%j":return n.dayOfYear.toString().padStart(3,"0");case"%H":return n.hour.toString().padStart(2,"0");case"%M":return n.minute.toString().padStart(2,"0");case"%S":return n.second.toString().padStart(2,"0");case"%f":return`.${n.millisecond.toString().padStart(3,"0")}`;case"%s":return Math.floor(n.epochMilliseconds/1e3).toString();case"%w":return(n.dayOfWeek%7).toString();case"%W":return(n.weekOfYear??0).toString().padStart(2,"0");case"%%":return"%";default:return console.warn(`Unsupported strftime specifier: ${s}`),s}}),r}catch(r){return console.error("Error during strftime formatting:",r),null}},ph=V({name:"strftime",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},LE);function ye(e){if(typeof e!="string")return null;try{return JSON.parse(e)}catch{return null}}function en(e,t,n=!1){if(!t||typeof t!="string")return null;let r=e,s=null,o=null,a=t.startsWith("$")?t.substring(1):t;if(a==="")return{parent:null,key:"",value:e,exists:!0};for(;a.length>0;){if(s=r,o=null,r==null)return null;if(a.startsWith(".")){a=a.substring(1);let i;if(a.startsWith('"')){let u=a.indexOf('"',1);if(u===-1)return null;i=a.substring(1,u),a=a.substring(u+1)}else{let u=a.match(/^([^[.\\s]+)/);if(!u)return null;i=u[1],a=a.substring(i.length)}if(typeof r!="object"||Array.isArray(r)){if(!n||typeof s!="object"||s===null||Array.isArray(s)||typeof o!="string")return{parent:s,key:i,value:void 0,exists:!1};console.debug(`JSON Path: Creating intermediate object for key "${o}"`),s[o]={},r=s[o],s=r,o=i,r=r[i]}else o=i,r=r[i]}else if(a.startsWith("[")){let i=a.indexOf("]");if(i===-1)return null;let u=a.substring(1,i).trim(),c=parseInt(u,10);if(a=a.substring(i+1),!Number.isInteger(c)||c<0)return null;if(Array.isArray(r))o=c,r=c<r.length?r[c]:void 0;else{if(!n||s===null||typeof o===null)return{parent:s,key:c,value:void 0,exists:!1};let d=[];if(Array.isArray(s)&&typeof o=="number")console.debug(`JSON Path: Creating intermediate array for index ${o}`),s[o]=d;else if(typeof s=="object"&&!Array.isArray(s)&&typeof o=="string")console.debug(`JSON Path: Creating intermediate array for key "${o}"`),s[o]=d;else return{parent:s,key:c,value:void 0,exists:!1};r=d,s=r,o=c,r=c<r.length?r[c]:void 0}}else return null}return o===null?null:{parent:s,key:o,value:r,exists:r!==void 0}}function tn(e){if(typeof e=="bigint")return e>=Number.MIN_SAFE_INTEGER&&e<=Number.MAX_SAFE_INTEGER?Number(e):e.toString();if(e instanceof Uint8Array||typeof e=="number"&&!Number.isFinite(e))return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e}function wn(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(wn);let t={};for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=wn(e[n]));return t}function nr(e){if(e===null)return"null";switch(typeof e){case"boolean":return e?"true":"false";case"number":return Number.isInteger(e)?"integer":"real";case"string":return"text";case"object":return Array.isArray(e)?"array":"object";default:return"null"}}function Io(e,t){if(!t||t==="$")return e;let n=t.startsWith("$.")?t.substring(2).split("."):t.startsWith("$")?t.substring(1).split("."):t.split("."),r=e;for(let s of n){if(r==null)return;let o=s.match(/^\s*\[(\d+)\]\s*$/);if(o){let a=parseInt(o[1],10);if(Array.isArray(r)&&a>=0&&a<r.length)r=r[a];else return}else if(typeof r=="object"&&r!==null&&Object.prototype.hasOwnProperty.call(r,s))r=r[s];else return}return r}var al={};Oo(al,{JsonPatchError:()=>J,_areEquals:()=>Yr,applyOperation:()=>In,applyPatch:()=>sr,applyReducer:()=>PE,deepClone:()=>ME,getValueByPointer:()=>Ro,validate:()=>Eh,validator:()=>Ao});var OE=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,s){r.__proto__=s}||function(r,s){for(var o in s)s.hasOwnProperty(o)&&(r[o]=s[o])},e(t,n)};return function(t,n){e(t,n);function r(){this.constructor=t}t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),xE=Object.prototype.hasOwnProperty;function No(e,t){return xE.call(e,t)}function Co(e){if(Array.isArray(e)){for(var t=new Array(e.length),n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(e);var r=[];for(var s in e)No(e,s)&&r.push(s);return r}function ue(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function So(e){for(var t=0,n=e.length,r;t<n;){if(r=e.charCodeAt(t),r>=48&&r<=57){t++;continue}return!1}return!0}function ht(e){return e.indexOf("/")===-1&&e.indexOf("~")===-1?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function qr(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function bo(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(var t=0,n=e.length;t<n;t++)if(bo(e[t]))return!0}else if(typeof e=="object"){for(var r=Co(e),s=r.length,o=0;o<s;o++)if(bo(e[r[o]]))return!0}}return!1}function gh(e,t){var n=[e];for(var r in t){var s=typeof t[r]=="object"?JSON.stringify(t[r],null,2):t[r];typeof s<"u"&&n.push(r+": "+s)}return n.join(`
`)}var jr=function(e){OE(t,e);function t(n,r,s,o,a){var i=this.constructor,u=e.call(this,gh(n,{name:r,index:s,operation:o,tree:a}))||this;return u.name=r,u.index=s,u.operation=o,u.tree=a,Object.setPrototypeOf(u,i.prototype),u.message=gh(n,{name:r,index:s,operation:o,tree:a}),u}return t}(Error);var J=jr,ME=ue,rr={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){var r=Ro(n,this.path);r&&(r=ue(r));var s=In(n,{op:"remove",path:this.from}).removed;return In(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(e,t,n){var r=Ro(n,this.from);return In(n,{op:"add",path:this.path,value:ue(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:Yr(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}},DE={add:function(e,t,n){return So(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){var r=e.splice(t,1);return{newDocument:n,removed:r[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:rr.move,copy:rr.copy,test:rr.test,_get:rr._get};function Ro(e,t){if(t=="")return e;var n={op:"_get",path:t};return In(e,n),n.value}function In(e,t,n,r,s,o){if(n===void 0&&(n=!1),r===void 0&&(r=!0),s===void 0&&(s=!0),o===void 0&&(o=0),n&&(typeof n=="function"?n(t,0,e,t.path):Ao(t,0)),t.path===""){var a={newDocument:e};if(t.op==="add")return a.newDocument=t.value,a;if(t.op==="replace")return a.newDocument=t.value,a.removed=e,a;if(t.op==="move"||t.op==="copy")return a.newDocument=Ro(e,t.from),t.op==="move"&&(a.removed=e),a;if(t.op==="test"){if(a.test=Yr(e,t.value),a.test===!1)throw new J("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a.newDocument=e,a}else{if(t.op==="remove")return a.removed=e,a.newDocument=null,a;if(t.op==="_get")return t.value=e,a;if(n)throw new J("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",o,t,e);return a}}else{r||(e=ue(e));var i=t.path||"",u=i.split("/"),c=e,d=1,l=u.length,h=void 0,p=void 0,g=void 0;for(typeof n=="function"?g=n:g=Ao;;){if(p=u[d],p&&p.indexOf("~")!=-1&&(p=qr(p)),s&&(p=="__proto__"||p=="prototype"&&d>0&&u[d-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&h===void 0&&(c[p]===void 0?h=u.slice(0,d).join("/"):d==l-1&&(h=t.path),h!==void 0&&g(t,0,e,h)),d++,Array.isArray(c)){if(p==="-")p=c.length;else{if(n&&!So(p))throw new J("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",o,t,e);So(p)&&(p=~~p)}if(d>=l){if(n&&t.op==="add"&&p>c.length)throw new J("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",o,t,e);var a=DE[t.op].call(t,c,p,e);if(a.test===!1)throw new J("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a}}else if(d>=l){var a=rr[t.op].call(t,c,p,e);if(a.test===!1)throw new J("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a}if(c=c[p],n&&d<l&&(!c||typeof c!="object"))throw new J("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",o,t,e)}}}function sr(e,t,n,r,s){if(r===void 0&&(r=!0),s===void 0&&(s=!0),n&&!Array.isArray(t))throw new J("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=ue(e));for(var o=new Array(t.length),a=0,i=t.length;a<i;a++)o[a]=In(e,t[a],n,!0,s,a),e=o[a].newDocument;return o.newDocument=e,o}function PE(e,t,n){var r=In(e,t);if(r.test===!1)throw new J("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function Ao(e,t,n,r){if(typeof e!="object"||e===null||Array.isArray(e))throw new J("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(rr[e.op]){if(typeof e.path!="string")throw new J("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new J('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new J("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new J("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if((e.op==="add"||e.op==="replace"||e.op==="test")&&bo(e.value))throw new J("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n){if(e.op=="add"){var s=e.path.split("/").length,o=r.split("/").length;if(s!==o+1&&s!==o)throw new J("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==r)throw new J("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if(e.op==="move"||e.op==="copy"){var a={op:"_get",path:e.from,value:void 0},i=Eh([a],n);if(i&&i.name==="OPERATION_PATH_UNRESOLVABLE")throw new J("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}}else throw new J("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n)}function Eh(e,t,n){try{if(!Array.isArray(e))throw new J("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)sr(ue(t),ue(e),n||!0);else{n=n||Ao;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(s){if(s instanceof J)return s;throw s}}function Yr(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var n=Array.isArray(e),r=Array.isArray(t),s,o,a;if(n&&r){if(o=e.length,o!=t.length)return!1;for(s=o;s--!==0;)if(!Yr(e[s],t[s]))return!1;return!0}if(n!=r)return!1;var i=Object.keys(e);if(o=i.length,o!==Object.keys(t).length)return!1;for(s=o;s--!==0;)if(!t.hasOwnProperty(i[s]))return!1;for(s=o;s--!==0;)if(a=i[s],!Yr(e[a],t[a]))return!1;return!0}return e!==e&&t!==t}var cl={};Oo(cl,{compare:()=>KE,generate:()=>il,observe:()=>VE,unobserve:()=>_E});var ll=new WeakMap,kE=function(){function e(t){this.observers=new Map,this.obj=t}return e}(),FE=function(){function e(t,n){this.callback=t,this.observer=n}return e}();function UE(e){return ll.get(e)}function $E(e,t){return e.observers.get(t)}function BE(e,t){e.observers.delete(t.callback)}function _E(e,t){t.unobserve()}function VE(e,t){var n=[],r,s=UE(e);if(!s)s=new kE(e),ll.set(e,s);else{var o=$E(s,t);r=o&&o.observer}if(r)return r;if(r={},s.value=ue(e),t){r.callback=t,r.next=null;var a=function(){il(r)},i=function(){clearTimeout(r.next),r.next=setTimeout(a)};typeof window<"u"&&(window.addEventListener("mouseup",i),window.addEventListener("keyup",i),window.addEventListener("mousedown",i),window.addEventListener("keydown",i),window.addEventListener("change",i))}return r.patches=n,r.object=e,r.unobserve=function(){il(r),clearTimeout(r.next),BE(s,r),typeof window<"u"&&(window.removeEventListener("mouseup",i),window.removeEventListener("keyup",i),window.removeEventListener("mousedown",i),window.removeEventListener("keydown",i),window.removeEventListener("change",i))},s.observers.set(t,new FE(t,r)),r}function il(e,t){t===void 0&&(t=!1);var n=ll.get(e.object);ul(n.value,e.object,e.patches,"",t),e.patches.length&&sr(n.value,e.patches);var r=e.patches;return r.length>0&&(e.patches=[],e.callback&&e.callback(r)),r}function ul(e,t,n,r,s){if(t!==e){typeof t.toJSON=="function"&&(t=t.toJSON());for(var o=Co(t),a=Co(e),i=!1,u=!1,c=a.length-1;c>=0;c--){var d=a[c],l=e[d];if(No(t,d)&&!(t[d]===void 0&&l!==void 0&&Array.isArray(t)===!1)){var h=t[d];typeof l=="object"&&l!=null&&typeof h=="object"&&h!=null&&Array.isArray(l)===Array.isArray(h)?ul(l,h,n,r+"/"+ht(d),s):l!==h&&(i=!0,s&&n.push({op:"test",path:r+"/"+ht(d),value:ue(l)}),n.push({op:"replace",path:r+"/"+ht(d),value:ue(h)}))}else Array.isArray(e)===Array.isArray(t)?(s&&n.push({op:"test",path:r+"/"+ht(d),value:ue(l)}),n.push({op:"remove",path:r+"/"+ht(d)}),u=!0):(s&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}),i=!0)}if(!(!u&&o.length==a.length))for(var c=0;c<o.length;c++){var d=o[c];!No(e,d)&&t[d]!==void 0&&n.push({op:"add",path:r+"/"+ht(d),value:ue(t[d])})}}}function KE(e,t,n){n===void 0&&(n=!1);var r=[];return ul(e,t,r,"",n),r}var Bb=Object.assign({},al,cl,{JsonPatchError:jr,deepClone:ue,escapePathComponent:ht,unescapePathComponent:qr});var GE=e=>ye(e)!==null?1:0,yh=V({name:"json_valid",numArgs:1,flags:T.UTF8|T.DETERMINISTIC},GE),qE=(e,t)=>{let n=ye(e);if(n===null&&typeof e=="string")return null;let r=n;if(t!=null){if(typeof t!="string")return"null";let s=en(n,t);if(r=s?.exists?s.value:void 0,r===void 0)return null}return nr(r)},wh=V({name:"json_type",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},qE),jE=(e,...t)=>{let n=ye(e);if(n===null&&typeof e=="string"||t.length===0)return null;let r;for(let s of t)if(typeof s=="string"){let o=en(n,s);if(r=o?.exists?o.value:void 0,r!==void 0)break}else return null;if(r===void 0)return null;if(r===null)return null;if(typeof r=="boolean")return r?1:0;if(typeof r=="number")return r;if(typeof r=="string")return r;if(typeof r=="object")try{return JSON.stringify(r)}catch{return null}else return null},Ih=V({name:"json_extract",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},jE),YE=e=>{if(e===null)return"null";switch(typeof e){case"number":return Number.isFinite(e)?String(e):"null";case"boolean":return e?"true":"false";case"string":return JSON.stringify(e);case"bigint":case"object":default:return null}},bh=V({name:"json_quote",numArgs:1,flags:T.UTF8|T.DETERMINISTIC},YE),WE=(...e)=>{let t=e.map(n=>tn(n));try{return JSON.stringify(t)}catch{return null}},Nh=V({name:"json_array",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},WE),zE=(...e)=>{if(e.length%2!==0)return null;let t={};for(let n=0;n<e.length;n+=2){let r=e[n],s=e[n+1];if(typeof r!="string")return null;t[r]=tn(s)}try{return JSON.stringify(t)}catch{return null}},Ch=V({name:"json_object",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},zE),ZE=(e,t)=>{let n=ye(e);if(n===null&&typeof e=="string")return null;let r=n;if(t!=null){if(typeof t!="string")return 0;let s=en(n,t);r=s?.exists?s.value:void 0}return Array.isArray(r)?r.length:0},Sh=V({name:"json_array_length",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},ZE),HE=(e,t)=>{let n=ye(e),r=ye(t);if(n===null&&typeof e=="string"||!Array.isArray(r))return null;try{let s=sr(n,r,!0).newDocument;return JSON.stringify(s)}catch(s){return console.error(`json_patch failed: ${s?.message}`,s),null}},Rh=V({name:"json_patch",numArgs:2,flags:T.UTF8},HE),XE=(e,...t)=>{let n=ye(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=wn(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=tn(a),u=en(r,o);if(u===null)continue;let{parent:c,key:d,exists:l}=u;if(!l){if(c===null)continue;Array.isArray(c)&&typeof d=="number"?d===c.length?c.push(i):d<c.length&&c.splice(d,0,i):typeof c=="object"&&typeof d=="string"&&(c[d]=i)}}try{return JSON.stringify(r)}catch{return null}},Ah=V({name:"json_insert",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},XE),JE=(e,...t)=>{let n=ye(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=wn(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=tn(a),u=en(r,o);if(u===null)continue;let{parent:c,key:d,exists:l}=u;l&&(c===null&&d===""?r=i:(c!==null&&typeof d=="string"&&typeof c=="object"&&!Array.isArray(c)||c!==null&&typeof d=="number"&&Array.isArray(c)&&d>=0&&d<c.length)&&(c[d]=i))}try{return JSON.stringify(r)}catch{return null}},Th=V({name:"json_replace",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},JE),QE=(e,...t)=>{let n=ye(e);if(n===null&&typeof e=="string"||t.length===0||t.length%2!==0)return null;let r=wn(n);for(let s=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(typeof o!="string")return null;let i=tn(a),u=en(r,o,!0);if(u===null)continue;let{parent:c,key:d,exists:l}=u;if(c===null&&d==="")r=i;else if(c!==null){if(typeof c=="object"&&!Array.isArray(c)&&typeof d=="string")c[d]=i;else if(Array.isArray(c)&&typeof d=="number"){if(d>=0&&d<c.length)c[d]=i;else if(d===c.length)c.push(i);else if(d>c.length){for(;c.length<d;)c.push(null);c.push(i)}}}}try{return JSON.stringify(r)}catch{return null}},vh=V({name:"json_set",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},QE),ey=(e,...t)=>{let n=ye(e);if(n===null&&typeof e=="string")return null;if(t.length===0)return JSON.stringify(n);let r=wn(n);for(let s of t){if(typeof s!="string")return null;let o=en(r,s);if(o===null||!o.exists||o.parent===null)continue;let{parent:a,key:i}=o;Array.isArray(a)&&typeof i=="number"?i>=0&&i<a.length&&a.splice(i,1):typeof a=="object"&&typeof i=="string"&&Object.prototype.hasOwnProperty.call(a,i)&&delete a[i]}try{return JSON.stringify(r)}catch{return null}},Lh=V({name:"json_remove",numArgs:-1,flags:T.UTF8|T.DETERMINISTIC},ey),ty=(e,t)=>{let n=e??[],r=tn(t);return n.push(r),n},ny=e=>{try{return e&&e.length>0?JSON.stringify(e):null}catch{return null}},Oh=Ce({name:"json_group_array",numArgs:1,flags:T.UTF8,initialState:[]},ty,ny),ry=(e,t,n)=>{let r=e??{};if(typeof t!="string"||t===null)return r;let s=tn(n);return r[t]=s,r},sy=e=>{try{return e&&Object.keys(e).length>0?JSON.stringify(e):null}catch{return null}},xh=Ce({name:"json_group_object",numArgs:2,flags:T.UTF8,initialState:{}},ry,sy);var fl=[bu,Nu,Cu,Ru,Au,Tu,vu,Lu,Ou,xu,Mu,Du,Pu,ku,Fu,Uu,$u,Bu,fh,dh,hh,mh,ph,yh,wh,Ih,bh,Nh,Ch,Ah,Th,vh,Lh,Sh,Rh,Oh,xh];var oy=Object.freeze([{name:"key",affinity:R.INTEGER|R.TEXT},{name:"value",affinity:R.TEXT},{name:"type",affinity:R.TEXT},{name:"atom",affinity:R.TEXT},{name:"id",affinity:R.INTEGER},{name:"parent",affinity:R.INTEGER},{name:"fullkey",affinity:R.TEXT},{name:"path",affinity:R.TEXT}]),ml=Object.freeze(oy.map(e=>({..._e(e.name),affinity:e.affinity}))),Mh=Object.freeze(be(ml)),dl=class extends Xe{parsedJson;rootPath;tableSchema;constructor(t,n,r,s,o,a){if(super(t,n,r,s),this.parsedJson=ye(o),this.rootPath=typeof a=="string"&&a?a:null,this.parsedJson===null&&typeof o=="string")throw new b(`Invalid JSON provided to ${s}`,w.ERROR);this.tableSchema=Object.freeze({name:s,schemaName:r,columns:ml,columnIndexMap:Mh,primaryKeyDefinition:[],isVirtual:!0,vtabModule:n,vtabInstance:this,vtabModuleName:"json_each"})}},hl=class extends Je{stack=[];currentRow=null;isEof=!0;elementIdCounter=0;constructor(t){super(t)}reset(){this.stack=[],this.currentRow=null,this.isEof=!0,this.elementIdCounter=0}startIteration(t,n){this.reset();let r=n??"$";t!==void 0?(this.stack.push({value:t,parentPath:"",parentKey:null,parentId:0,currentIndex:-1}),this.isEof=!1,this.next()):this.isEof=!0}next(){if(this.stack.length===0){this.isEof=!0,this.currentRow=null;return}let t=this.stack[this.stack.length-1],n=t.value,r=t.parentKey,s=this.elementIdCounter++,o=t.parentPath,a=r!==null?`${o}${typeof r=="number"?`[${r}]`:`.${r}`}`:o,i=nr(n),u=i==="object"||i==="array"?null:n;if(this.currentRow={key:r,value:i==="object"||i==="array"?JSON.stringify(n):n,type:i,atom:u,id:s,parent:t.parentId,fullkey:a,path:o},this.stack.pop(),Array.isArray(n))for(let c=n.length-1;c>=0;c--)this.stack.push({value:n[c],parentPath:a,parentKey:c,parentId:s,currentIndex:-1});else if(typeof n=="object"&&n!==null){let c=Object.keys(n).sort().reverse();for(let d of c)this.stack.push({value:n[d],parentPath:a,parentKey:d,parentId:s,currentIndex:-1})}this.stack.length}eof(){return this.isEof}column(t){if(!this.currentRow)return null;let n=ml[t]?.name;if(n==="value"&&this.currentRow){let r=this.currentRow.type;if(r==="object"||r==="array"){let s=this.currentRow._originalValue;return s?JSON.stringify(s):null}else return this.currentRow[n]??null}else return this.currentRow[n]??null}},To=class{xConnect(t,n,r,s,o,a){return new dl(t,this,s,o,a.jsonSource,a.rootPath)}xCreate(t,n,r,s,o,a){return this.xConnect(t,n,r,s,o,a)}async xDisconnect(t){}async xDestroy(t){}async xOpen(t){return new hl(t)}async xClose(t){t.reset()}xBestIndex(t,n){return n.estimatedCost=1e5,n.idxNum=0,n.idxStr=null,n.orderByConsumed=!1,w.OK}async xFilter(t,n,r,s){let o=t.table.rootPath,a=t.table.parsedJson;o&&(a=Io(a,o)),t.startIteration(a,o)}async xNext(t){t.next()}async xEof(t){return t.eof()}xColumn(t,n,r){return n.resultValue(t.column(r)),w.OK}xRowid(t){let n=Mh.get("id"),r=t.column(n);return typeof r=="number"?Promise.resolve(BigInt(r)):Promise.reject(new b("Cannot get rowid for json_each cursor",w.ERROR))}async xUpdate(){throw new b("json_each table is read-only",w.READONLY)}async xBegin(){return Promise.resolve()}async xSync(){return Promise.resolve()}async xCommit(){return Promise.resolve()}async xRollback(){return Promise.resolve()}async xRename(){throw new b("Cannot rename json_each table",w.ERROR)}};var ay=Object.freeze([{name:"key",affinity:R.INTEGER|R.TEXT},{name:"value",affinity:R.TEXT},{name:"type",affinity:R.TEXT},{name:"atom",affinity:R.TEXT},{name:"id",affinity:R.INTEGER},{name:"parent",affinity:R.INTEGER},{name:"fullkey",affinity:R.TEXT},{name:"path",affinity:R.TEXT}]),El=Object.freeze(ay.map(e=>({..._e(e.name),affinity:e.affinity}))),Dh=Object.freeze(be(El)),pl=class extends Xe{parsedJson;rootPath;tableSchema;constructor(t,n,r,s,o,a){if(super(t,n,r,s),this.parsedJson=ye(o),this.rootPath=typeof a=="string"&&a?a:null,this.parsedJson===null&&typeof o=="string")throw new b(`Invalid JSON provided to ${s}`,w.ERROR);this.tableSchema=Object.freeze({name:s,schemaName:r,columns:El,columnIndexMap:Dh,primaryKeyDefinition:[],isVirtual:!0,vtabModule:n,vtabInstance:this,vtabModuleName:"json_tree"})}},gl=class extends Je{stack=[];currentRow=null;isEof=!0;elementIdCounter=0;constructor(t){super(t)}reset(){this.stack=[],this.currentRow=null,this.isEof=!0,this.elementIdCounter=0}startIteration(t,n){this.reset();let r=n??"$";t!==void 0?(this.stack.push({value:t,parentPath:"",parentKey:null,parentId:0,childrenPushed:!1}),this.isEof=!1,this.next()):this.isEof=!0}next(){if(this.stack.length===0){this.isEof=!0,this.currentRow=null;return}let t=this.stack[this.stack.length-1],n=t.value,r=typeof n=="object"&&n!==null;if(this.currentRow===null||!t.childrenPushed){let a=t.parentKey,i=++this.elementIdCounter,u=t.parentPath,c=a!==null?`${u}${typeof a=="number"?`[${a}]`:`.${a}`}`:u,d=nr(n),l=r?null:n;if(this.currentRow={key:a,value:r?JSON.stringify(n):n,type:d,atom:l,id:i,parent:t.parentId,fullkey:c,path:u,_originalValue:r?n:void 0},r){t.childrenPushed=!1;return}else{this.stack.pop(),this.next();return}}t.childrenPushed=!0;let s=this.currentRow.id,o=this.currentRow.fullkey;if(this.stack.pop(),Array.isArray(n))for(let a=n.length-1;a>=0;a--)this.stack.push({value:n[a],parentPath:o,parentKey:a,parentId:s,childrenPushed:!1});else if(typeof n=="object"&&n!==null){let a=Object.keys(n).sort().reverse();for(let i of a)this.stack.push({value:n[i],parentPath:o,parentKey:i,parentId:s,childrenPushed:!1})}this.currentRow=null,this.next()}eof(){return this.isEof}column(t){if(!this.currentRow)return null;let n=El[t]?.name;if(n==="value"&&this.currentRow){let r=this.currentRow.type;if(r==="object"||r==="array"){let s=this.currentRow._originalValue;return s!==void 0?JSON.stringify(s):null}else return this.currentRow[n]??null}else return this.currentRow[n]??null}},vo=class{xConnect(t,n,r,s,o,a){return new pl(t,this,s,o,a.jsonSource,a.rootPath)}xCreate(t,n,r,s,o,a){return this.xConnect(t,n,r,s,o,a)}async xDisconnect(t){}async xDestroy(t){}async xOpen(t){return new gl(t)}async xClose(t){t.reset()}xBestIndex(t,n){return n.estimatedCost=1e5,n.idxNum=0,n.idxStr=null,n.orderByConsumed=!1,w.OK}async xFilter(t,n,r,s){let o=t.table.rootPath,a=t.table.parsedJson;o&&(a=Io(a,o)),t.startIteration(a,o)}async xNext(t){t.next()}async xEof(t){return t.eof()}xColumn(t,n,r){return n.resultValue(t.column(r)),w.OK}xRowid(t){let n=Dh.get("id"),r=t.column(n);return typeof r=="number"?Promise.resolve(BigInt(r)):Promise.reject(new b("Cannot get rowid for json_tree cursor",w.ERROR))}async xUpdate(){throw new b("json_tree table is read-only",w.READONLY)}async xBegin(){return Promise.resolve()}async xSync(){return Promise.resolve()}async xCommit(){return Promise.resolve()}async xRollback(){return Promise.resolve()}async xRename(){throw new b("Cannot rename json_tree table",w.ERROR)}};function Ph(e){if(!e.isOpen)throw new x("Database is closed");let t=e.schemaManager,n={schemaVersion:1,schemas:{}};for(let r of t._getAllSchemas()){let s={tables:[],functions:[]};for(let o of r.getAllTables()){let a={name:o.name,columns:o.columns.map(i=>{let u=R[i.affinity],c=null;return typeof i.defaultValue=="string"||typeof i.defaultValue=="number"||i.defaultValue===null?c=i.defaultValue:typeof i.defaultValue=="bigint"?c=i.defaultValue.toString()+"n":i.defaultValue instanceof Uint8Array&&(c=`x'${Array.from(i.defaultValue).map(l=>l.toString(16).padStart(2,"0")).join("")}'`),{name:i.name,affinity:u,notNull:i.notNull,primaryKey:i.primaryKey,defaultValue:c,collation:i.collation,hidden:i.hidden,generated:i.generated}}),primaryKeyDefinition:[...o.primaryKeyDefinition],isVirtual:o.isVirtual,vtabModule:o.vtabModuleName,vtabArgs:o.vtabArgs?[...o.vtabArgs]:void 0};s.tables.push(a)}for(let o of r._getAllFunctions()){let a={name:o.name,numArgs:o.numArgs,flags:o.flags};s.functions.push(a)}n.schemas[r.name]=s}return JSON.stringify(n,null,2)}function kh(e,t){if(!e.isOpen)throw new x("Database is closed");let n=e.schemaManager;if(e.inTransaction)throw new x("Cannot import schema during a transaction");let s;try{s=JSON.parse(t)}catch(o){throw new Error(`Failed to parse JSON schema: ${o.message}`)}if(s.schemaVersion!==1)throw new Error(`Unsupported schema version: ${s.schemaVersion}. Expected version 1.`);n.clearAll();for(let o in s.schemas){if(!Object.prototype.hasOwnProperty.call(s.schemas,o))continue;let a=n.getSchema(o);if(a)a.clearTables(),a.clearFunctions();else{if(o==="main"||o==="temp")throw console.error(`Core schema ${o} missing during import!`),new b(`Internal error: Core schema ${o} is missing.`,w.INTERNAL);a=n.addSchema(o)}let i=s.schemas[o];for(let u of i.tables){let c=u.columns.map(l=>{let h=R[l.affinity];if(h===void 0)throw new Error(`Invalid affinity string "${l.affinity}" for column ${l.name}`);let p=null;if(typeof l.defaultValue=="string")if(l.defaultValue.endsWith("n"))try{p=BigInt(l.defaultValue.slice(0,-1))}catch{}else if(l.defaultValue.toLowerCase().startsWith("x'")&&l.defaultValue.endsWith("'")){let g=l.defaultValue.slice(2,-1);try{let E=new Uint8Array(g.length/2);for(let y=0;y<g.length;y+=2)E[y/2]=parseInt(g.substring(y,y+2),16);p=E}catch{}}else p=l.defaultValue;else(typeof l.defaultValue=="number"||l.defaultValue===null)&&(p=l.defaultValue);return{name:l.name,affinity:h,notNull:l.notNull,primaryKey:l.primaryKey,pkOrder:u.primaryKeyDefinition.find(g=>g.index===u.columns.indexOf(l))?u.primaryKeyDefinition.findIndex(g=>g.index===u.columns.indexOf(l))+1:0,defaultValue:p,collation:l.collation,hidden:l.hidden,generated:l.generated}}),d={name:u.name,schemaName:o,columns:Object.freeze(c),columnIndexMap:Object.freeze(be(c)),primaryKeyDefinition:Object.freeze(u.primaryKeyDefinition),isVirtual:u.isVirtual,vtabModuleName:u.vtabModule,vtabArgs:u.vtabArgs?Object.freeze(u.vtabArgs):void 0};a.addTable(d)}for(let u of i.functions){let c={name:u.name,numArgs:u.numArgs,flags:u.flags};a.addFunction(c)}}console.warn("Schema imported from JSON. Function implementations and VTab connections must be re-established manually.")}var Lo=class{schemaManager;isOpen=!0;statements=new Set;registeredVTabs=new Map;isAutocommit=!0;inTransaction=!1;defaultVtabModuleName="memory";defaultVtabModuleArgs=[];constructor(){this.schemaManager=new On(this),console.log("Database instance created."),this.registerBuiltinFunctions(),this.registerVtabModule("memory",new Pt),this.registerVtabModule("json_each",new To),this.registerVtabModule("json_tree",new vo),this.registerDefaultCollations()}registerBuiltinFunctions(){let t=this.schemaManager.getMainSchema();fl.forEach(n=>{try{t.addFunction(n)}catch(r){console.error(`Failed to register built-in function ${n.name}/${n.numArgs}:`,r)}}),console.log(`Registered ${fl.length} built-in functions.`)}registerDefaultCollations(){cr("BINARY",Do),cr("NOCASE",lu),cr("RTRIM",uu),console.log("Default collations registered (BINARY, NOCASE, RTRIM)")}async prepare(t){if(!this.isOpen)throw new x("Database is closed");console.log(`Preparing SQL: ${t}`);let n=new Ln(this,t);try{return this.statements.add(n),n}catch(r){throw this.statements.delete(n),r}}async exec(t,n,r){if(!this.isOpen)throw new x("Database is closed");typeof n=="function"&&r===void 0&&(r=n,n=void 0),console.log(`Executing SQL: ${t}`);let s=await this.prepare(t);try{n&&typeof n!="function"&&s.bindAll(n);let o=await s.step();for(;o===w.ROW;){if(r){let a=s.getAsObject(),i=s.getColumnNames();r(a,i)}o=await s.step()}if(o!==w.DONE&&o!==w.OK)throw new b("Execution failed",o)}finally{await s.finalize()}}registerVtabModule(t,n,r){if(!this.isOpen)throw new x("Database is closed");let s=t.toLowerCase();if(this.registeredVTabs.has(s))throw new b(`Virtual table module '${t}' already registered`,w.ERROR);console.log(`Registering VTab module: ${t}`),this.registeredVTabs.set(s,{module:n,auxData:r})}async beginTransaction(t="deferred"){if(!this.isOpen)throw new x("Database is closed");if(this.inTransaction)throw new b("Transaction already active",w.ERROR);await this.exec(`BEGIN ${t.toUpperCase()} TRANSACTION`),this.inTransaction=!0,this.isAutocommit=!1}async commit(){if(!this.isOpen)throw new x("Database is closed");if(!this.inTransaction)throw new b("No transaction active",w.ERROR);await this.exec("COMMIT"),this.inTransaction=!1,this.isAutocommit=!0}async rollback(){if(!this.isOpen)throw new x("Database is closed");if(!this.inTransaction)throw new b("No transaction active",w.ERROR);await this.exec("ROLLBACK"),this.inTransaction=!1,this.isAutocommit=!0}async close(){if(!this.isOpen)return;console.log("Closing database..."),this.isOpen=!1;let t=Array.from(this.statements).map(n=>n.finalize());await Promise.allSettled(t),this.statements.clear(),this.schemaManager.clearAll(),this.registeredVTabs.clear(),console.log("Database closed.")}_statementFinalized(t){this.statements.delete(t)}getAutocommit(){if(!this.isOpen)throw new x("Database is closed");return this.isAutocommit}defineVirtualTable(t){if(!this.isOpen)throw new x("Database is closed");if(!t.isVirtual||!t.vtabModule)throw new x("Definition must be for a virtual table with a module");if(t.schemaName!=="main")throw new x("Programmatic definition only supported for 'main' schema currently");this.schemaManager.getMainSchema().addTable(t)}_getVtabModule(t){return this.registeredVTabs.get(t.toLowerCase())}_findTable(t,n){return this.schemaManager.findTable(t,n)}_findFunction(t,n){return this.schemaManager.findFunction(t,n)}createScalarFunction(t,n,r){if(!this.isOpen)throw new x("Database is closed");let s=n.deterministic?T.DETERMINISTIC|T.UTF8:T.UTF8,o=n.flags??s,a=V({name:t,numArgs:n.numArgs,flags:o},r);try{this.schemaManager.getMainSchema().addFunction(a)}catch(i){throw console.error(`Failed to register scalar function ${t}/${n.numArgs}:`,i),i instanceof Error?i:new Error(String(i))}}createAggregateFunction(t,n,r,s){if(!this.isOpen)throw new x("Database is closed");let o=n.flags??T.UTF8,a=Ce({name:t,numArgs:n.numArgs,flags:o,initialState:n.initialState},r,s);try{this.schemaManager.getMainSchema().addFunction(a)}catch(i){throw console.error(`Failed to register aggregate function ${t}/${n.numArgs}:`,i),i instanceof Error?i:new Error(String(i))}}registerFunction(t){if(!this.isOpen)throw new x("Database is closed");try{this.schemaManager.getMainSchema().addFunction(t)}catch(n){throw console.error(`Failed to register function ${t.name}/${t.numArgs}:`,n),n instanceof Error?n:new Error(String(n))}}exportSchemaJson(){return Ph(this)}importSchemaJson(t){kh(this,t)}setDefaultVtabModule(t,n=[]){console.warn("Deprecated: Use `PRAGMA default_vtab_module` and `PRAGMA default_vtab_args` instead."),this.setDefaultVtabName(t),this.setDefaultVtabArgs(n)}setDefaultVtabName(t){this.registeredVTabs.has(t.toLowerCase())||console.warn(`Setting default VTab module to '${t}', which is not currently registered.`),this.defaultVtabModuleName=t}setDefaultVtabArgs(t){this.defaultVtabModuleArgs=[...t]}setDefaultVtabArgsFromJson(t){try{let n=JSON.parse(t);if(!Array.isArray(n)||!n.every(r=>typeof r=="string"))throw new Error("JSON value must be an array of strings.");this.setDefaultVtabArgs(n)}catch(n){let r=n instanceof Error?n.message:String(n);throw new b(`Invalid JSON for default_vtab_args: ${r}`,w.ERROR)}}getDefaultVtabModule(){return{name:this.defaultVtabModuleName,args:[...this.defaultVtabModuleArgs]}}registerCollation(t,n){if(!this.isOpen)throw new b("Database is closed",w.ERROR);cr(t,n),console.log(`Registered collation: ${t}`)}_getCollation(t){return cu(t)}async*eval(t,n){if(!this.isOpen)throw new x("Database is closed");let r=null;try{r=await this.prepare(t),n&&r.bindAll(n);let s;for(;(s=await r.step())===w.ROW;)yield r.getAsObject();if(s!==w.DONE&&s!==w.OK)throw new b(`Iteration failed for query: ${t}`,s)}finally{r&&await r.finalize()}}};return Gh(iy);})();
/*! Bundled license information:

fast-json-patch/module/helpers.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

fast-json-patch/module/duplex.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2021 Joachim Wester
   * MIT license
   *)
*/
return DigithoughtSqliter}));
